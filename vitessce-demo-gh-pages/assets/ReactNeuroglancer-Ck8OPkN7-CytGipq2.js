import{b0 as qb,b6 as ZM,L as Jb,z as Qe,b7 as QM,b8 as eA,b9 as tA,ba as Po,bb as ia,bc as ut,bd as nA,be as Hm,bf as Ot,bg as qm,bh as DT,bi as rA,bj as iA,bk as Gu,bl as sA,bm as sa,bn as aA,bo as oA,bp as Wu,bq as ju,br as Cs,bs as Ni,bt as PT,bu as RT,bv as Hu,bw as Jm,bx as MT,by as qu,bz as lA,bA as dA,bB as Ym,bC as Vi,bD as Xm,bE as Ro,bF as cA,bG as Km,bH as uA,bI as hA,bJ as pA,bK as fA,bL as gA,bM as mA,bN as vA,bO as yA,bP as bA}from"./index-D9chyKeb.js";var wA=Object.defineProperty,SA=(n,e,t)=>e in n?wA(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Er=(n,e,t)=>SA(n,typeof e!="symbol"?e+"":e,t),CA=QM();const j=Qe(CA);var Yb={},Rp,Xb;function AT(){if(Xb)return Rp;Xb=1;var n=Ot(),e=ut(),t=qm();return Rp=function(r,i){var s=(e.Object||{})[r]||Object[r],a={};a[r]=i(s),n(n.S+n.F*t(function(){s(1)}),"Object",a)},Rp}var Kb;function xA(){if(Kb)return Yb;Kb=1;var n=Jm(),e=MT();return AT()("keys",function(){return function(t){return e(n(t))}}),Yb}var Zb,Qb;function EA(){return Qb||(Qb=1,xA(),Zb=ut().Object.keys),Zb}var ew,tw;function TA(){return tw||(tw=1,ew={default:EA(),__esModule:!0}),ew}var kA=TA();const Qt=Qe(kA);var xc={},Mp,nw;function Ju(){if(nw)return Mp;nw=1;var n=Km(),e=Vi()("toStringTag"),t=n((function(){return arguments})())=="Arguments",r=function(i,s){try{return i[s]}catch{}};return Mp=function(i){var s,a,l;return i===void 0?"Undefined":i===null?"Null":typeof(a=r(s=Object(i),e))=="string"?a:t?n(s):(l=n(s))=="Object"&&typeof s.callee=="function"?"Arguments":l},Mp}var Ap,rw;function LA(){if(rw)return Ap;rw=1;var n=Ju(),e=Vi()("iterator"),t=Xm();return Ap=ut().isIterable=function(r){var i=Object(r);return i[e]!==void 0||"@@iterator"in i||t.hasOwnProperty(n(i))},Ap}var iw,sw;function IA(){return sw||(sw=1,ia(),Po(),iw=LA()),iw}var aw,ow;function DA(){return ow||(ow=1,aw={default:IA(),__esModule:!0}),aw}var Np,lw;function Zm(){if(lw)return Np;lw=1;var n=Ju(),e=Vi()("iterator"),t=Xm();return Np=ut().getIteratorMethod=function(r){if(r!=null)return r[e]||r["@@iterator"]||t[n(r)]},Np}var Vp,dw;function PA(){if(dw)return Vp;dw=1;var n=Ro(),e=Zm();return Vp=ut().getIterator=function(t){var r=e(t);if(typeof r!="function")throw TypeError(t+" is not iterable!");return n(r.call(t))},Vp}var cw,uw;function RA(){return uw||(uw=1,ia(),Po(),cw=PA()),cw}var hw,pw;function NT(){return pw||(pw=1,hw={default:RA(),__esModule:!0}),hw}var fw;function MA(){if(fw)return xc;fw=1,xc.__esModule=!0;var n=DA(),e=i(n),t=NT(),r=i(t);function i(s){return s&&s.__esModule?s:{default:s}}return xc.default=(function(){function s(a,l){var c=[],u=!0,h=!1,g=void 0;try{for(var v=(0,r.default)(a),y;!(u=(y=v.next()).done)&&(c.push(y.value),!(l&&c.length===l));u=!0);}catch(C){h=!0,g=C}finally{try{!u&&v.return&&v.return()}finally{if(h)throw g}}return c}return function(a,l){if(Array.isArray(a))return a;if((0,e.default)(Object(a)))return s(a,l);throw new TypeError("Invalid attempt to destructure non-iterable instance")}})(),xc}var AA=MA();const ae=Qe(AA);var Op,gw;function Yu(){if(gw)return Op;gw=1;var n=PT();return Op=function(e,t,r){for(var i in t)r&&e[i]?e[i]=t[i]:n(e,i,t[i]);return e},Op}var mw,vw;function Xu(){return vw||(vw=1,mw=function(n,e,t,r){if(!(n instanceof e)||r!==void 0&&r in n)throw TypeError(t+": incorrect invocation!");return n}),mw}var Bp={exports:{}},Fp,yw;function VT(){if(yw)return Fp;yw=1;var n=Ro();return Fp=function(e,t,r,i){try{return i?t(n(r)[0],r[1]):t(r)}catch(a){var s=e.return;throw s!==void 0&&n(s.call(e)),a}},Fp}var _p,bw;function OT(){if(bw)return _p;bw=1;var n=Xm(),e=Vi()("iterator"),t=Array.prototype;return _p=function(r){return r!==void 0&&(n.Array===r||t[e]===r)},_p}var ww;function Mo(){if(ww)return Bp.exports;ww=1;var n=sa(),e=VT(),t=OT(),r=Ro(),i=qu(),s=Zm(),a={},l={},c=Bp.exports=function(u,h,g,v,y){var C=y?function(){return u}:s(u),S=n(g,v,h?2:1),w=0,E,k,P,D;if(typeof C!="function")throw TypeError(u+" is not iterable!");if(t(C)){for(E=i(u.length);E>w;w++)if(D=h?S(r(k=u[w])[0],k[1]):S(u[w]),D===a||D===l)return D}else for(P=C.call(u);!(k=P.next()).done;)if(D=e(P,S,k.value,h),D===a||D===l)return D};return c.BREAK=a,c.RETURN=l,Bp.exports}var Up,Sw;function BT(){if(Sw)return Up;Sw=1;var n=Ni(),e=ut(),t=Gu(),r=Wu(),i=Vi()("species");return Up=function(s){var a=typeof e[s]=="function"?e[s]:n[s];r&&a&&!a[i]&&t.f(a,i,{configurable:!0,get:function(){return this}})},Up}var $p,Cw;function Ks(){if(Cw)return $p;Cw=1;var n=Cs();return $p=function(e,t){if(!n(e)||e._t!==t)throw TypeError("Incompatible receiver, "+t+" required!");return e},$p}var zp,xw;function FT(){if(xw)return zp;xw=1;var n=Gu().f,e=sA(),t=Yu(),r=sa(),i=Xu(),s=Mo(),a=aA(),l=oA(),c=BT(),u=Wu(),h=ju().fastKey,g=Ks(),v=u?"_s":"size",y=function(C,S){var w=h(S),E;if(w!=="F")return C._i[w];for(E=C._f;E;E=E.n)if(E.k==S)return E};return zp={getConstructor:function(C,S,w,E){var k=C(function(P,D){i(P,k,S,"_i"),P._t=S,P._i=e(null),P._f=void 0,P._l=void 0,P[v]=0,D!=null&&s(D,w,P[E],P)});return t(k.prototype,{clear:function(){for(var P=g(this,S),D=P._i,L=P._f;L;L=L.n)L.r=!0,L.p&&(L.p=L.p.n=void 0),delete D[L.i];P._f=P._l=void 0,P[v]=0},delete:function(P){var D=g(this,S),L=y(D,P);if(L){var R=L.n,M=L.p;delete D._i[L.i],L.r=!0,M&&(M.n=R),R&&(R.p=M),D._f==L&&(D._f=R),D._l==L&&(D._l=M),D[v]--}return!!L},forEach:function(P){g(this,S);for(var D=r(P,arguments.length>1?arguments[1]:void 0,3),L;L=L?L.n:this._f;)for(D(L.v,L.k,this);L&&L.r;)L=L.p},has:function(P){return!!y(g(this,S),P)}}),u&&n(k.prototype,"size",{get:function(){return g(this,S)[v]}}),k},def:function(C,S,w){var E=y(C,S),k,P;return E?E.v=w:(C._l=E={i:P=h(S,!0),k:S,v:w,p:k=C._l,n:void 0,r:!1},C._f||(C._f=E),k&&(k.n=E),C[v]++,P!=="F"&&(C._i[P]=E)),C},getEntry:y,setStrong:function(C,S,w){a(C,S,function(E,k){this._t=g(E,S),this._k=k,this._l=void 0},function(){for(var E=this,k=E._k,P=E._l;P&&P.r;)P=P.p;return!E._t||!(E._l=P=P?P.n:E._t._f)?(E._t=void 0,l(1)):k=="keys"?l(0,P.k):k=="values"?l(0,P.v):l(0,[P.k,P.v])},w?"entries":"values",!w,!0),c(S)}},zp}var Gp,Ew;function NA(){if(Ew)return Gp;Ew=1;var n=Cs(),e=gA(),t=Vi()("species");return Gp=function(r){var i;return e(r)&&(i=r.constructor,typeof i=="function"&&(i===Array||e(i.prototype))&&(i=void 0),n(i)&&(i=i[t],i===null&&(i=void 0))),i===void 0?Array:i},Gp}var Wp,Tw;function VA(){if(Tw)return Wp;Tw=1;var n=NA();return Wp=function(e,t){return new(n(e))(t)},Wp}var jp,kw;function Qm(){if(kw)return jp;kw=1;var n=sa(),e=cA(),t=Jm(),r=qu(),i=VA();return jp=function(s,a){var l=s==1,c=s==2,u=s==3,h=s==4,g=s==6,v=s==5||g,y=a||i;return function(C,S,w){for(var E=t(C),k=e(E),P=n(S,w,3),D=r(k.length),L=0,R=l?y(C,D):c?y(C,0):void 0,M,V;D>L;L++)if((v||L in k)&&(M=k[L],V=P(M,L,E),s)){if(l)R[L]=V;else if(V)switch(s){case 3:return!0;case 5:return M;case 6:return L;case 2:R.push(M)}else if(h)return!1}return g?-1:u||h?h:R}},jp}var Hp,Lw;function Ku(){if(Lw)return Hp;Lw=1;var n=Ni(),e=Ot(),t=ju(),r=qm(),i=PT(),s=Yu(),a=Mo(),l=Xu(),c=Cs(),u=RT(),h=Gu().f,g=Qm()(0),v=Wu();return Hp=function(y,C,S,w,E,k){var P=n[y],D=P,L=E?"set":"add",R=D&&D.prototype,M={};return!v||typeof D!="function"||!(k||R.forEach&&!r(function(){new D().entries().next()}))?(D=w.getConstructor(C,y,E,L),s(D.prototype,S),t.NEED=!0):(D=C(function(V,B){l(V,D,y,"_c"),V._c=new P,B!=null&&a(B,E,V[L],V)}),g("add,clear,delete,forEach,get,has,set,keys,values,entries,toJSON".split(","),function(V){var B=V=="add"||V=="set";V in R&&!(k&&V=="clear")&&i(D.prototype,V,function(_,H){if(l(this,D,V),!B&&k&&!c(_))return V=="get"?void 0:!1;var U=this._c[V](_===0?0:_,H);return B?this:U})}),k||h(D.prototype,"size",{get:function(){return this._c.size}})),u(D,y),M[y]=D,e(e.G+e.W+e.F,M),k||w.setStrong(D,y,E),D},Hp}var qp,Iw;function OA(){if(Iw)return qp;Iw=1;var n=FT(),e=Ks(),t="Map";return qp=Ku()(t,function(r){return function(){return r(this,arguments.length>0?arguments[0]:void 0)}},{get:function(r){var i=n.getEntry(e(this,t),r);return i&&i.v},set:function(r,i){return n.def(e(this,t),r===0?0:r,i)}},n,!0),qp}var Dw={},Jp,Pw;function BA(){if(Pw)return Jp;Pw=1;var n=Mo();return Jp=function(e,t){var r=[];return n(e,!1,r.push,r,t),r},Jp}var Yp,Rw;function _T(){if(Rw)return Yp;Rw=1;var n=Ju(),e=BA();return Yp=function(t){return function(){if(n(this)!=t)throw TypeError(t+"#toJSON isn't generic");return e(this)}},Yp}var Mw;function FA(){if(Mw)return Dw;Mw=1;var n=Ot();return n(n.P+n.R,"Map",{toJSON:_T()("Map")}),Dw}var _A={},Xp,Aw;function Zu(){if(Aw)return Xp;Aw=1;var n=Ot();return Xp=function(e){n(n.S,e,{of:function(){for(var t=arguments.length,r=new Array(t);t--;)r[t]=arguments[t];return new this(r)}})},Xp}var Nw;function UA(){return Nw||(Nw=1,Zu()("Map")),_A}var $A={},Kp,Vw;function Qu(){if(Vw)return Kp;Vw=1;var n=Ot(),e=Hu(),t=sa(),r=Mo();return Kp=function(i){n(n.S,i,{from:function(s){var a=arguments[1],l,c,u,h;return e(this),l=a!==void 0,l&&e(a),s==null?new this:(c=[],l?(u=0,h=t(a,arguments[2],2),r(s,!1,function(g){c.push(h(g,u++))})):r(s,!1,c.push,c),new this(c))}})},Kp}var Ow;function zA(){return Ow||(Ow=1,Qu()("Map")),$A}var Bw,Fw;function GA(){return Fw||(Fw=1,Po(),ia(),OA(),FA(),UA(),zA(),Bw=ut().Map),Bw}var _w,Uw;function WA(){return Uw||(Uw=1,_w={default:GA(),__esModule:!0}),_w}var jA=WA();const de=Qe(jA);var HA=eA();const An=Qe(HA);var $w={},Zp,zw;function qA(){if(zw)return Zp;zw=1;var n=Gu(),e=uA();return Zp=function(t,r,i){r in t?n.f(t,r,e(0,i)):t[r]=i},Zp}var Qp,Gw;function UT(){if(Gw)return Qp;Gw=1;var n=Vi()("iterator"),e=!1;try{var t=[7][n]();t.return=function(){e=!0},Array.from(t,function(){throw 2})}catch{}return Qp=function(r,i){if(!i&&!e)return!1;var s=!1;try{var a=[7],l=a[n]();l.next=function(){return{done:s=!0}},a[n]=function(){return l},r(a)}catch{}return s},Qp}var Ww;function JA(){if(Ww)return $w;Ww=1;var n=sa(),e=Ot(),t=Jm(),r=VT(),i=OT(),s=qu(),a=qA(),l=Zm();return e(e.S+e.F*!UT()(function(c){Array.from(c)}),"Array",{from:function(c){var u=t(c),h=typeof this=="function"?this:Array,g=arguments.length,v=g>1?arguments[1]:void 0,y=v!==void 0,C=0,S=l(u),w,E,k,P;if(y&&(v=n(v,g>2?arguments[2]:void 0,2)),S!=null&&!(h==Array&&i(S)))for(P=S.call(u),E=new h;!(k=P.next()).done;C++)a(E,C,y?r(P,v,[k.value,C],!0):k.value);else for(w=s(u.length),E=new h(w);w>C;C++)a(E,C,y?v(u[C],C):u[C]);return E.length=C,E}}),$w}var jw,Hw;function YA(){return Hw||(Hw=1,Po(),JA(),jw=ut().Array.from),jw}var qw,Jw;function $T(){return Jw||(Jw=1,qw={default:YA(),__esModule:!0}),qw}var XA=$T();const Te=Qe(XA);var ef,Yw;function KA(){if(Yw)return ef;Yw=1;var n=FT(),e=Ks(),t="Set";return ef=Ku()(t,function(r){return function(){return r(this,arguments.length>0?arguments[0]:void 0)}},{add:function(r){return n.def(e(this,t),r=r===0?0:r,r)}},n),ef}var Xw={},Kw;function ZA(){if(Kw)return Xw;Kw=1;var n=Ot();return n(n.P+n.R,"Set",{toJSON:_T()("Set")}),Xw}var QA={},Zw;function eN(){return Zw||(Zw=1,Zu()("Set")),QA}var tN={},Qw;function nN(){return Qw||(Qw=1,Qu()("Set")),tN}var eS,tS;function rN(){return tS||(tS=1,Po(),ia(),KA(),ZA(),eN(),nN(),eS=ut().Set),eS}var nS,rS;function iN(){return rS||(rS=1,nS={default:rN(),__esModule:!0}),nS}var sN=iN();const ze=Qe(sN);var tf,iS;function aN(){if(iS)return tf;iS=1;var n=ut(),e=n.JSON||(n.JSON={stringify:JSON.stringify});return tf=function(t){return e.stringify.apply(e,arguments)},tf}var sS,aS;function oN(){return aS||(aS=1,sS={default:aN(),__esModule:!0}),sS}var lN=oN();const ie=Qe(lN);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function zT(n,e){let t=n.length,r=0;for(let i=0;i<t;++i)e(n[i],i,n)&&(n[r]=n[i],++r);n.length=r}function dN(n,e){if(n.length===e)return n;let t=new n.constructor(e);return t.set(n),t}function og(n,e,t,r){const i=n.length/e,s=n.length*t*r,a=new n.constructor(s),l=n.length*r,c=e,u=e*r;for(let h=0;h<i;++h)for(let g=0;g<e;++g){const v=n[h*e+g],y=h*u+g;for(let C=0;C<t;++C)for(let S=0;S<r;++S)a[C*l+S*c+y]=v}return a}function cN(n,e,t,r=0,i=n.length){for(;r<i;){const s=r+i-1>>1,a=t(e,n[s]);if(a>0)r=s+1;else if(a<0)i=s;else return s}return~r}function uN(n,e,t){let r=e-n;for(;r>0;){let i=Math.floor(r/2),s=n+i;t(s)?r=i:(n=s+1,r-=i+1)}return n}function hN(n,e){const t=[];for(let r=0,i=n.length;r<i;++r)n[r]===e&&t.push(r);return t}function Oe(n,e){const t=n.length;if(e.length!==t)return!1;for(let r=0;r<t;++r)if(n[r]!==e[r])return!1;return!0}function lg(n,e,t=(r,i)=>r===i){const r=n.length;if(e.length!==r)return!1;for(let i=0;i<r;++i)if(!t(n[i],e[i]))return!1;return!0}function pN(n,e,t){const r=[];if(t===e){for(let i=0;i<n;++i)r[i]=i;return r}r[t]=e;for(let i=0,s=0;i<n;){if(i===e){++i;continue}s===t&&++s,r[s++]=i++}return r}function oS(n,e,t){for(let r=0,i=t.length;r<i;++r){const s=t[r];s!==-1&&(n[r]=e[s])}return n}function cd(n){const e=[];for(let t=0,r=n.length;t<r;++t){const i=n[t];for(let s=0,a=i.length;s<a;++s){let l=e[s];l===void 0&&(l=e[s]=[]),l.push(i[s])}}return e}function fN(n,e){const t=[];let r=0;for(let a=0,l=e.length;a<l;++a){var i=e[a];const c=i.retainCount,u=i.deleteCount,h=i.insertCount;c!==0&&(t.push(n.slice(r,r+c)),r+=c),r+=u,h!==0&&t.push(new Array(h))}const s=n.length;return r!==s&&t.push(n.slice(r)),new Array(0).concat(...t)}function gN(n,e,t){const r=[];let i=0,s=0,a=n.length,l=e.length;for(;i<a&&s<l;){let c,u=n[i],h=e[s];if(c=t(u,h),c===0){let g=1;for(++i,++s;i<a&&s<l&&(c=t(n[i],e[s]))===0;)++g,++i,++s;r.push({retainCount:g,deleteCount:0,insertCount:0});continue}if(c<0){let g=1;for(;++i<a&&(c=t(n[i],h))<0;)++g;r.push({retainCount:0,deleteCount:g,insertCount:0});continue}if(c>0){let g=1;for(;++s<l&&(c=t(u,e[s]))>0;)++g;r.push({retainCount:0,deleteCount:0,insertCount:g});continue}}return(i<a||s<l)&&r.push({retainCount:0,deleteCount:a-i,insertCount:l-s}),r}function mN(n,e,t,r,i,s){let a=0,l=0;if(n!==0&&e!==0)for(;;){const c=t(a,l);if(c<0){if(r(a),++a===n)break}else if(c>0){if(i(l),++l===e)break}else if(s(a,l),++a,++l,a===n||l===e)break}for(;a<n;)r(a),++a;for(;l<e;)i(l),++l}var vN=NT();const ev=Qe(vN);var nf,lS;function yN(){if(lS)return nf;lS=1;var n=nA(),e=function(){return n.Date.now()};return nf=e,nf}var rf,dS;function bN(){if(dS)return rf;dS=1;var n=/\s/;function e(t){for(var r=t.length;r--&&n.test(t.charAt(r)););return r}return rf=e,rf}var sf,cS;function wN(){if(cS)return sf;cS=1;var n=bN(),e=/^\s+/;function t(r){return r&&r.slice(0,n(r)+1).replace(e,"")}return sf=t,sf}var af,uS;function SN(){if(uS)return af;uS=1;var n=rA(),e=iA(),t="[object Symbol]";function r(i){return typeof i=="symbol"||e(i)&&n(i)==t}return af=r,af}var of,hS;function CN(){if(hS)return of;hS=1;var n=wN(),e=Hm(),t=SN(),r=NaN,i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,a=/^0o[0-7]+$/i,l=parseInt;function c(u){if(typeof u=="number")return u;if(t(u))return r;if(e(u)){var h=typeof u.valueOf=="function"?u.valueOf():u;u=e(h)?h+"":h}if(typeof u!="string")return u===0?u:+u;u=n(u);var g=s.test(u);return g||a.test(u)?l(u.slice(2),g?2:8):i.test(u)?r:+u}return of=c,of}var lf,pS;function GT(){if(pS)return lf;pS=1;var n=Hm(),e=yN(),t=CN(),r="Expected a function",i=Math.max,s=Math.min;function a(l,c,u){var h,g,v,y,C,S,w=0,E=!1,k=!1,P=!0;if(typeof l!="function")throw new TypeError(r);c=t(c)||0,n(u)&&(E=!!u.leading,k="maxWait"in u,v=k?i(t(u.maxWait)||0,c):v,P="trailing"in u?!!u.trailing:P);function D(O){var z=h,F=g;return h=g=void 0,w=O,y=l.apply(F,z),y}function L(O){return w=O,C=setTimeout(V,c),E?D(O):y}function R(O){var z=O-S,F=O-w,se=c-z;return k?s(se,v-F):se}function M(O){var z=O-S,F=O-w;return S===void 0||z>=c||z<0||k&&F>=v}function V(){var O=e();if(M(O))return B(O);C=setTimeout(V,R(O))}function B(O){return C=void 0,P&&h?D(O):(h=g=void 0,y)}function _(){C!==void 0&&clearTimeout(C),w=0,h=S=g=C=void 0}function H(){return C===void 0?y:B(e())}function U(){var O=e(),z=M(O);if(h=arguments,g=this,S=O,z){if(C===void 0)return L(S);if(k)return clearTimeout(C),C=setTimeout(V,c),D(S)}return C===void 0&&(C=setTimeout(V,c)),y}return U.cancel=_,U.flush=H,U}return lf=a,lf}var xN=GT();const rt=Qe(xN);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function WT(n){typeof n=="object"?n.dispose():n()}function so(n){for(let e=n.length;e>0;--e)WT(n[e-1])}function Lr(n,e,t,r){return n.addEventListener(e,t,r),()=>n.removeEventListener(e,t,r)}class K{constructor(){this.refCount=1}addRef(){return++this.refCount,this}dispose(){--this.refCount===0&&this.refCountReachedZero()}refCountReachedZero(){this.disposed();let e=this.disposers;e!==void 0&&(so(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let t=this.disposers;return t==null?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let t=this.disposers;if(t!=null){let r=t.indexOf(e);r!==-1&&t.splice(r,1)}return e}registerEventListener(e,t,r,i){this.registerDisposer(Lr(e,t,r,i))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}}class jT extends K{constructor(e){super(),this.value=e}}function HT(n){return()=>{if(n!==void 0){let e=n;n=void 0,WT(e)}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ze{constructor(){this.handlers=new ze,this.count=0;const e=this;this.dispatch=function(){++e.count,e.handlers.forEach(t=>{t.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}remove(e){return this.handlers.delete(e)}dispose(){this.handlers=void 0}}class we extends Ze{}const qT={count:0,add(n){return()=>{}},remove(n){return!1}};class dt{constructor(e){this.value_=e,this.changed=new we}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}}class Jt extends dt{constructor(e,t,r=e){super(e),this.validator=t,this.defaultValue=r}toJSON(){if(this.value_!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(e!==void 0){let t=this.validator;try{this.value=t(e);return}catch{}}this.value=this.defaultValue}}class JT extends K{constructor(e,t){super(),this.changed=new we,this.f=e,this.ws=t;for(const r of t)this.registerDisposer(r.changed.add(this.changed.dispatch))}get value(){return this.f(...this.ws.map(e=>e.value))}}function fS(n,...e){return new JT(n,e)}class EN extends K{constructor(e,t){super(),this.changed=new we,this.valueGeneration=-1,this.f=e,this.ws=t;for(const r of t)this.registerDisposer(r.changed.add(this.changed.dispatch))}get value(){const e=this.changed.count;return e!==this.valueGeneration&&(this.value_=this.f(...this.ws.map(t=>t.value)),this.valueGeneration=e),this.value_}}function Hr(n,...e){return new EN(n,e)}class YT extends K{constructor(e,t=(r,i)=>r===i){super(),this.changed=new Ze,this.value=e.value,this.registerDisposer(e.changed.add(()=>{const r=e.value;t(this.value,r)||(this.value=r,this.changed.dispatch())}))}}function dr(n,e,t){const r=new JT(n,e),i=new YT(r,t);return i.registerDisposer(r),i}class XT extends K{constructor(e){super(),this.changed=new we;const t=e(this),r=Qt(t),i=()=>{const s=Array.isArray(t)?[]:{};for(const a of r)s[a]=t[a].value;this.value=s,this.changed.dispatch()};i();for(const s of r){const a=t[s];this.registerDisposer(a.changed.add(()=>i()))}}}class TN{constructor(e){this.changed=new we,e===void 0?this.values=new ze:this.values=new ze(e)}add(e){const t=this.values;return t.has(e)||(t.add(e),this.changed.dispatch()),this}delete(e){return this.values.delete(e)?(this.changed.dispatch(),!0):!1}has(e){return this.values.has(e)}get size(){return this.values.size}[An](){return ev(this.values)}clear(){const e=this.values;e.size>0&&(e.clear(),this.changed.dispatch())}}function Di(n,...e){let t=e.map(c=>c.value);const r=e.length;let i=new K,s=n(i,...t);const a=rt(()=>{let c=!1;for(let u=0;u<r;++u){const h=e[u].value;t[u]!==h&&(t[u]=h,c=!0)}c&&(i.dispose(),i=new K,s=n(i,...t))},0),l=e.map(c=>c.changed.add(a));return{flush(){a.flush()},dispose(){a.cancel(),so(l),i.dispose()},get value(){return a.flush(),s}}}function ao(n,...e){let t=e.map(c=>c.value);const r=e.length;let i=new K,s=n(i,...t);const a=()=>{let c=!1;for(let u=0;u<r;++u){const h=e[u].value;t[u]!==h&&(t[u]=h,c=!0)}c&&(i.dispose(),i=new K,s=n(i,...t))},l=e.map(c=>c.changed.add(a));return{dispose(){so(l),i.dispose()},get value(){return s}}}function Zs(n){return{changed:qT,value:n}}function ki(n,e){return n(e.value),e.changed.add(()=>n(e.value))}class $c{constructor(e,t){this.outer=e,this.getInner=t,this.changed=new we,this.update=()=>{const r=this.disposer,i=this.outer;r!==void 0&&r();const s=this.inner=this.getInner(i.value);this.disposer=s.changed.add(this.changed.dispatch),this.changed.dispatch()},e.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(e){this.inner.value=e}}class df extends $c{reset(){this.inner.reset()}restoreState(e){this.inner.restoreState(e)}toJSON(){return this.inner.toJSON()}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ec=new Float32Array(1);function kN(n){Ec[0]=n,n=Ec[0];for(let e=1;e<21;++e){let t=n.toPrecision(e);if(Ec[0]=parseFloat(t),Ec[0]===n)return t}return n.toString()}var zc=1e-6,vn=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,e=arguments.length;e--;)n+=arguments[e]*arguments[e];return Math.sqrt(n)});function ud(){var n=new vn(9);return vn!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function LN(n,e){if(n===e){var t=e[1],r=e[2],i=e[5];n[1]=e[3],n[2]=e[6],n[3]=t,n[5]=e[7],n[6]=r,n[7]=i}else n[0]=e[0],n[1]=e[3],n[2]=e[6],n[3]=e[1],n[4]=e[4],n[5]=e[7],n[6]=e[2],n[7]=e[5],n[8]=e[8];return n}function IN(n,e){var t=e[0],r=e[1],i=e[2],s=e[3],a=e[4],l=e[5],c=e[6],u=e[7],h=e[8],g=h*a-l*u,v=-h*s+l*c,y=u*s-a*c,C=t*g+r*v+i*y;return C?(C=1/C,n[0]=g*C,n[1]=(-h*r+i*u)*C,n[2]=(l*r-i*a)*C,n[3]=v*C,n[4]=(h*t-i*c)*C,n[5]=(-l*t+i*s)*C,n[6]=y*C,n[7]=(-u*t+r*c)*C,n[8]=(a*t-r*s)*C,n):null}function tv(n){var e=n[0],t=n[1],r=n[2],i=n[3],s=n[4],a=n[5],l=n[6],c=n[7],u=n[8];return e*(u*s-a*c)+t*(-u*i+a*l)+r*(c*i-s*l)}function KT(n,e){var t=e[0],r=e[1],i=e[2],s=e[3],a=t+t,l=r+r,c=i+i,u=t*a,h=r*a,g=r*l,v=i*a,y=i*l,C=i*c,S=s*a,w=s*l,E=s*c;return n[0]=1-g-C,n[3]=h-E,n[6]=v+w,n[1]=h+E,n[4]=1-u-C,n[7]=y-S,n[2]=v-w,n[5]=y+S,n[8]=1-u-g,n}function Je(){var n=new vn(16);return vn!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function DN(n){var e=new vn(16);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15],e}function Qc(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function ZT(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function nv(n,e){if(n===e){var t=e[1],r=e[2],i=e[3],s=e[6],a=e[7],l=e[11];n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=t,n[6]=e[9],n[7]=e[13],n[8]=r,n[9]=s,n[11]=e[14],n[12]=i,n[13]=a,n[14]=l}else n[0]=e[0],n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=e[1],n[5]=e[5],n[6]=e[9],n[7]=e[13],n[8]=e[2],n[9]=e[6],n[10]=e[10],n[11]=e[14],n[12]=e[3],n[13]=e[7],n[14]=e[11],n[15]=e[15];return n}function fs(n,e){var t=e[0],r=e[1],i=e[2],s=e[3],a=e[4],l=e[5],c=e[6],u=e[7],h=e[8],g=e[9],v=e[10],y=e[11],C=e[12],S=e[13],w=e[14],E=e[15],k=t*l-r*a,P=t*c-i*a,D=t*u-s*a,L=r*c-i*l,R=r*u-s*l,M=i*u-s*c,V=h*S-g*C,B=h*w-v*C,_=h*E-y*C,H=g*w-v*S,U=g*E-y*S,O=v*E-y*w,z=k*O-P*U+D*H+L*_-R*B+M*V;return z?(z=1/z,n[0]=(l*O-c*U+u*H)*z,n[1]=(i*U-r*O-s*H)*z,n[2]=(S*M-w*R+E*L)*z,n[3]=(v*R-g*M-y*L)*z,n[4]=(c*_-a*O-u*B)*z,n[5]=(t*O-i*_+s*B)*z,n[6]=(w*D-C*M-E*P)*z,n[7]=(h*M-v*D+y*P)*z,n[8]=(a*U-l*_+u*V)*z,n[9]=(r*_-t*U-s*V)*z,n[10]=(C*R-S*D+E*k)*z,n[11]=(g*D-h*R-y*k)*z,n[12]=(l*B-a*H-c*V)*z,n[13]=(t*H-r*B+i*V)*z,n[14]=(S*P-C*L-w*k)*z,n[15]=(h*L-g*P+v*k)*z,n):null}function en(n,e,t){var r=e[0],i=e[1],s=e[2],a=e[3],l=e[4],c=e[5],u=e[6],h=e[7],g=e[8],v=e[9],y=e[10],C=e[11],S=e[12],w=e[13],E=e[14],k=e[15],P=t[0],D=t[1],L=t[2],R=t[3];return n[0]=P*r+D*l+L*g+R*S,n[1]=P*i+D*c+L*v+R*w,n[2]=P*s+D*u+L*y+R*E,n[3]=P*a+D*h+L*C+R*k,P=t[4],D=t[5],L=t[6],R=t[7],n[4]=P*r+D*l+L*g+R*S,n[5]=P*i+D*c+L*v+R*w,n[6]=P*s+D*u+L*y+R*E,n[7]=P*a+D*h+L*C+R*k,P=t[8],D=t[9],L=t[10],R=t[11],n[8]=P*r+D*l+L*g+R*S,n[9]=P*i+D*c+L*v+R*w,n[10]=P*s+D*u+L*y+R*E,n[11]=P*a+D*h+L*C+R*k,P=t[12],D=t[13],L=t[14],R=t[15],n[12]=P*r+D*l+L*g+R*S,n[13]=P*i+D*c+L*v+R*w,n[14]=P*s+D*u+L*y+R*E,n[15]=P*a+D*h+L*C+R*k,n}function PN(n,e,t){var r=t[0],i=t[1],s=t[2],a,l,c,u,h,g,v,y,C,S,w,E;return e===n?(n[12]=e[0]*r+e[4]*i+e[8]*s+e[12],n[13]=e[1]*r+e[5]*i+e[9]*s+e[13],n[14]=e[2]*r+e[6]*i+e[10]*s+e[14],n[15]=e[3]*r+e[7]*i+e[11]*s+e[15]):(a=e[0],l=e[1],c=e[2],u=e[3],h=e[4],g=e[5],v=e[6],y=e[7],C=e[8],S=e[9],w=e[10],E=e[11],n[0]=a,n[1]=l,n[2]=c,n[3]=u,n[4]=h,n[5]=g,n[6]=v,n[7]=y,n[8]=C,n[9]=S,n[10]=w,n[11]=E,n[12]=a*r+h*i+C*s+e[12],n[13]=l*r+g*i+S*s+e[13],n[14]=c*r+v*i+w*s+e[14],n[15]=u*r+y*i+E*s+e[15]),n}function RN(n,e,t){var r=t[0],i=t[1],s=t[2];return n[0]=e[0]*r,n[1]=e[1]*r,n[2]=e[2]*r,n[3]=e[3]*r,n[4]=e[4]*i,n[5]=e[5]*i,n[6]=e[6]*i,n[7]=e[7]*i,n[8]=e[8]*s,n[9]=e[9]*s,n[10]=e[10]*s,n[11]=e[11]*s,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function MN(n,e,t,r){var i=e[0],s=e[1],a=e[2],l=e[3],c=i+i,u=s+s,h=a+a,g=i*c,v=i*u,y=i*h,C=s*u,S=s*h,w=a*h,E=l*c,k=l*u,P=l*h,D=r[0],L=r[1],R=r[2];return n[0]=(1-(C+w))*D,n[1]=(v+P)*D,n[2]=(y-k)*D,n[3]=0,n[4]=(v-P)*L,n[5]=(1-(g+w))*L,n[6]=(S+E)*L,n[7]=0,n[8]=(y+k)*R,n[9]=(S-E)*R,n[10]=(1-(g+C))*R,n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n}function AN(n,e){var t=e[0],r=e[1],i=e[2],s=e[3],a=t+t,l=r+r,c=i+i,u=t*a,h=r*a,g=r*l,v=i*a,y=i*l,C=i*c,S=s*a,w=s*l,E=s*c;return n[0]=1-g-C,n[1]=h+E,n[2]=v-w,n[3]=0,n[4]=h-E,n[5]=1-u-C,n[6]=y+S,n[7]=0,n[8]=v+w,n[9]=y-S,n[10]=1-u-g,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function NN(n,e,t,r,i){var s=1/Math.tan(e/2),a;return n[0]=s/t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,i!=null&&i!==1/0?(a=1/(r-i),n[10]=(i+r)*a,n[14]=2*i*r*a):(n[10]=-1,n[14]=-2*r),n}function QT(n,e,t,r,i,s,a){var l=1/(e-t),c=1/(r-i),u=1/(s-a);return n[0]=-2*l,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*c,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*u,n[11]=0,n[12]=(e+t)*l,n[13]=(i+r)*c,n[14]=(a+s)*u,n[15]=1,n}function Ne(){var n=new vn(3);return vn!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function dg(n){var e=new vn(3);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e}function VN(n){var e=n[0],t=n[1],r=n[2];return Math.hypot(e,t,r)}function lt(n,e,t){var r=new vn(3);return r[0]=n,r[1]=e,r[2]=t,r}function ON(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n}function cg(n,e,t,r){return n[0]=e,n[1]=t,n[2]=r,n}function ek(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n}function tk(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n}function nk(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n}function ug(n,e,t){return n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n}function gS(n,e){return n[0]=Math.ceil(e[0]),n[1]=Math.ceil(e[1]),n[2]=Math.ceil(e[2]),n}function rv(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n}function eu(n,e){var t=e[0],r=e[1],i=e[2],s=t*t+r*r+i*i;return s>0&&(s=1/Math.sqrt(s)),n[0]=e[0]*s,n[1]=e[1]*s,n[2]=e[2]*s,n}function iv(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]}function cf(n,e,t){var r=e[0],i=e[1],s=e[2],a=t[0],l=t[1],c=t[2];return n[0]=i*c-s*l,n[1]=s*a-r*c,n[2]=r*l-i*a,n}function ar(n,e,t){var r=e[0],i=e[1],s=e[2],a=t[3]*r+t[7]*i+t[11]*s+t[15];return a=a||1,n[0]=(t[0]*r+t[4]*i+t[8]*s+t[12])/a,n[1]=(t[1]*r+t[5]*i+t[9]*s+t[13])/a,n[2]=(t[2]*r+t[6]*i+t[10]*s+t[14])/a,n}function Qa(n,e,t){var r=t[0],i=t[1],s=t[2],a=t[3],l=e[0],c=e[1],u=e[2],h=i*u-s*c,g=s*l-r*u,v=r*c-i*l,y=i*v-s*g,C=s*h-r*v,S=r*g-i*h,w=a*2;return h*=w,g*=w,v*=w,y*=2,C*=2,S*=2,n[0]=l+h+y,n[1]=c+g+C,n[2]=u+v+S,n}function hg(n,e){var t=n[0],r=n[1],i=n[2],s=e[0],a=e[1],l=e[2];return Math.abs(t-s)<=zc*Math.max(1,Math.abs(t),Math.abs(s))&&Math.abs(r-a)<=zc*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-l)<=zc*Math.max(1,Math.abs(i),Math.abs(l))}var BN=tk,FN=VN;(function(){var n=Ne();return function(e,t,r,i,s,a){var l,c;for(t||(t=3),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],s(n,n,a),e[l]=n[0],e[l+1]=n[1],e[l+2]=n[2];return e}})();function eh(){var n=new vn(4);return vn!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function hd(n,e,t,r){var i=new vn(4);return i[0]=n,i[1]=e,i[2]=t,i[3]=r,i}function _N(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n}function UN(n,e){var t=e[0],r=e[1],i=e[2],s=e[3],a=t*t+r*r+i*i+s*s;return a>0&&(a=1/Math.sqrt(a)),n[0]=t*a,n[1]=r*a,n[2]=i*a,n[3]=s*a,n}(function(){var n=eh();return function(e,t,r,i,s,a){var l,c;for(t||(t=4),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],n[3]=e[l+3],s(n,n,a),e[l]=n[0],e[l+1]=n[1],e[l+2]=n[2],e[l+3]=n[3];return e}})();function Pn(){var n=new vn(4);return vn!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function mS(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}function pg(n,e,t){t=t*.5;var r=Math.sin(t);return n[0]=r*e[0],n[1]=r*e[1],n[2]=r*e[2],n[3]=Math.cos(t),n}function cs(n,e,t){var r=e[0],i=e[1],s=e[2],a=e[3],l=t[0],c=t[1],u=t[2],h=t[3];return n[0]=r*h+a*l+i*u-s*c,n[1]=i*h+a*c+s*l-r*u,n[2]=s*h+a*u+r*c-i*l,n[3]=a*h-r*l-i*c-s*u,n}function $N(n,e,t){t*=.5;var r=e[0],i=e[1],s=e[2],a=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c+a*l,n[1]=i*c+s*l,n[2]=s*c-i*l,n[3]=a*c-r*l,n}function zN(n,e,t){t*=.5;var r=e[0],i=e[1],s=e[2],a=e[3],l=Math.sin(t),c=Math.cos(t);return n[0]=r*c-s*l,n[1]=i*c+a*l,n[2]=s*c+r*l,n[3]=a*c-i*l,n}function uf(n,e,t,r){var i=e[0],s=e[1],a=e[2],l=e[3],c=t[0],u=t[1],h=t[2],g=t[3],v,y,C,S,w;return y=i*c+s*u+a*h+l*g,y<0&&(y=-y,c=-c,u=-u,h=-h,g=-g),1-y>zc?(v=Math.acos(y),C=Math.sin(v),S=Math.sin((1-r)*v)/C,w=Math.sin(r*v)/C):(S=1-r,w=r),n[0]=S*i+w*c,n[1]=S*s+w*u,n[2]=S*a+w*h,n[3]=S*l+w*g,n}function tu(n,e){var t=e[0],r=e[1],i=e[2],s=e[3],a=t*t+r*r+i*i+s*s,l=a?1/a:0;return n[0]=-t*l,n[1]=-r*l,n[2]=-i*l,n[3]=s*l,n}function rk(n,e){var t=e[0]+e[4]+e[8],r;if(t>0)r=Math.sqrt(t+1),n[3]=.5*r,r=.5/r,n[0]=(e[5]-e[7])*r,n[1]=(e[6]-e[2])*r,n[2]=(e[1]-e[3])*r;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[i*3+i]&&(i=2);var s=(i+1)%3,a=(i+2)%3;r=Math.sqrt(e[i*3+i]-e[s*3+s]-e[a*3+a]+1),n[i]=.5*r,r=.5/r,n[3]=(e[s*3+a]-e[a*3+s])*r,n[s]=(e[s*3+i]+e[i*3+s])*r,n[a]=(e[a*3+i]+e[i*3+a])*r}return n}var GN=_N,Hl=UN;(function(){var n=Ne(),e=lt(1,0,0),t=lt(0,1,0);return function(r,i,s){var a=iv(i,s);return a<-.999999?(cf(n,e,i),FN(n)<1e-6&&cf(n,t,i),eu(n,n),pg(r,n,Math.PI),r):a>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(cf(n,i,s),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=1+a,Hl(r,r))}})();(function(){var n=Pn(),e=Pn();return function(t,r,i,s,a,l){return uf(n,r,a,l),uf(e,i,s,l),uf(t,n,e,2*l*(1-l)),t}})();(function(){var n=ud();return function(e,t,r,i){return n[0]=r[0],n[3]=r[1],n[6]=r[2],n[1]=i[0],n[4]=i[1],n[7]=i[2],n[2]=-t[0],n[5]=-t[1],n[8]=-t[2],Hl(e,rk(e,n))}})();function ik(){var n=new vn(2);return vn!=Float32Array&&(n[0]=0,n[1]=0),n}function WN(n,e,t){return n[0]=e,n[1]=t,n}function jN(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n}(function(){var n=ik();return function(e,t,r,i,s,a){var l,c;for(t||(t=2),r||(r=0),i?c=Math.min(i*t+r,e.length):c=e.length,l=r;l<c;l+=t)n[0]=e[l],n[1]=e[l+1],s(n,n,a),e[l]=n[0],e[l+1]=n[1];return e}})();/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const sk=Je(),HN=["x","y","z"],$r=[lt(1,0,0),lt(0,1,0),lt(0,0,1)];lt(0,0,0);const fg=hd(0,0,0,0),ak=lt(1,1,1);lt(1/0,1/0,1/0);Pn();function gg(n){return n[0]*n[1]*n[2]}function mg(n){return`${n[0]},${n[1]},${n[2]}`}function qN(n,e,t){let r=e[0],i=e[1],s=e[2];return n[0]=t[0]*r+t[4]*i+t[8]*s,n[1]=t[1]*r+t[5]*i+t[9]*s,n[2]=t[2]*r+t[6]*i+t[10]*s,n}function ok(n,e,t){let r=e[0],i=e[1],s=e[2];return n[0]=t[0]*r+t[1]*i+t[2]*s,n[1]=t[4]*r+t[5]*i+t[6]*s,n[2]=t[8]*r+t[9]*i+t[10]*s,n}function JN(n,e,t){const r=t.length;let i=0;for(let a=0;a<r;++a)i+=(n[a]-e[a])**2;let s=0;for(let a=0;a<r;++a){const l=n[a];s-=(l-t[a])*(e[a]-l)}return s/Math.max(i,1e-6)}function lk(n,e,t,r){const i=n.length;let s=JN(e,t,r);s=Math.max(0,Math.min(1,s));for(let a=0;a<i;++a){const l=e[a];n[a]=l+s*(t[a]-l)}return n}function th(n,e){const t=e[0],r=e[1],i=e[2],s=e[4],a=e[5],l=e[6],c=e[8],u=e[9],h=e[10];return n[0]=t,n[1]=r,n[2]=i,n[3]=s,n[4]=a,n[5]=l,n[6]=c,n[7]=u,n[8]=h,n}function nu(n,e){const t=e[0],r=e[1],i=e[2],s=e[3],a=e[4],l=e[5],c=e[6],u=e[7],h=e[8],g=e[9],v=e[10],y=e[11],C=e[12],S=e[13],w=e[14],E=e[15];n[0]=s+t,n[1]=u+a,n[2]=y+h,n[3]=E+C,n[4]=s-t,n[5]=u-a,n[6]=y-h,n[7]=E-C,n[8]=s+r,n[9]=u+l,n[10]=y+g,n[11]=E+S,n[12]=s-r,n[13]=u-l,n[14]=y-g,n[15]=E-S;const k=s+i,P=u+c,D=y+v,L=E+w,R=s-i,M=u-c,V=y-v,B=E-w,_=Math.sqrt(k**2+P**2+D**2);n[16]=k/_,n[17]=P/_,n[18]=D/_,n[19]=L/_;const H=Math.sqrt(R**2+M**2+V**2);return n[20]=R/H,n[21]=M/H,n[22]=V/H,n[23]=B/H,n}function dk(n,e,t,r,i,s,a){for(let l=0;l<6;++l){const c=a[l*4],u=a[l*4+1],h=a[l*4+2],g=a[l*4+3];if(Math.max(c*n,c*r)+Math.max(u*e,u*i)+Math.max(h*t,h*s)+g<0)return!1}return!0}function YN(n,e,t,r,i,s,a){for(let l=0;l<4;++l){const c=a[l*4],u=a[l*4+1],h=a[l*4+2],g=a[l*4+3];if(Math.max(c*n,c*r)+Math.max(u*e,u*i)+Math.max(h*t,h*s)+g<0)return!1}{const l=a[20],c=a[21],u=a[22],h=a[23],g=Math.max(l*n,l*r)+Math.max(c*e,c*i)+Math.max(u*t,u*s),v=Math.min(l*n,l*r)+Math.min(c*e,c*i)+Math.min(u*t,u*s),y=Math.abs(h)*1e-6;if(v>-h+y||g<-h-y)return!1}return!0}function nh(n,e,t,r=!1){const i=t.length,s=[],a=r?1:e+1,l=r?e+1:1;for(let c=0;c<i;++c){const u=t[c];for(let h=0;h<e;++h)n[h*a+u*l]!==0&&(s[h]=!0)}return hN(s,!0)}function ck(n,e,t){for(let r=0;r<3;++r){const i=t[r];for(let s=0;s<3;++s)n[r+s*3]=i*e[r+s*3]}return n}function XN(n){if(n[15]===1){const i=2/Math.abs(n[10]),s=2/Math.abs(n[0]),a=2/Math.abs(n[5]);return s*a*i}const e=n[10],t=2*n[14]/(2*e-2),r=(e-1)*t/(e+1);return 4/(n[0]*n[5])/3*(Math.abs(r)**3-Math.abs(t)**3)}function uk(n){if(n[15]===1)return 2/Math.abs(n[10]);const e=n[10],t=2*n[14]/(2*e-2),r=(e-1)*t/(e+1);return Math.abs(r-t)}function KN(n){return n[2]=0,n[6]=0,n[10]=0,n[14]=0,n}const Ua=Ne();function ZN(n,e){e[0]=e[1]=e[2]=Number.POSITIVE_INFINITY,e[3]=e[4]=e[5]=Number.NEGATIVE_INFINITY;for(let t=0;t<8;++t){Ua[0]=2*(t&1)-1,Ua[1]=2*(t>>>1&1)-1,Ua[2]=2*(t>>>2&1)-1,ar(Ua,Ua,n);for(let r=0;r<3;++r){const i=Ua[r];e[r]=Math.min(e[r],i),e[r+3]=Math.max(e[r+3],i)}}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function hk(n){return("0"+n.toString(16)).slice(-2)}function QN(n){return Array.prototype.map.call(n,hk).join("")}function eV(n){if(!/^(?:[0-9a-fA-F]{2})*$/.test(n))throw new Error("Invalid hex-encoded string");const e=n.length/2,t=new Uint8Array(e);for(let r=0;r<e;++r)t[r]=parseInt(n.substr(r*2,2),16);return t}function tV(n){const e=/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/;{const r=n.match(e);if(r!==null)return[parseInt(r[1],10),parseInt(r[2],10),parseInt(r[3],10),parseFloat(r[4])]}const t=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/;{const r=n.match(t);if(r!==null)return[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16),1]}throw new Error(`Invalid serialized color: ${ie(n)}.`)}function pk(n){try{if(typeof n!="string")throw new Error(`Expected string, but received ${ie(n)}.`);const e=document.createElement("canvas").getContext("2d");e.fillStyle=n;const t=tV(e.fillStyle);return hd(t[0]/255,t[1]/255,t[2]/255,t[3])}catch(e){throw new Error(`Failed to parse color specification: ${e.message}`)}}function Ao(n){return pk(n).subarray(0,3)}function vg(n){const e=n[3]===void 0?3:4;let t=0;for(let r=0;r<e;r++)t=(t<<8>>>0)+Math.min(255,Math.max(0,Math.round(n[e-1-r]*255)));return t}function eo(n){return lt((n>>>0&255)/255,(n>>>8&255)/255,(n>>>16&255)/255)}function sv(n){return hd((n>>>0&255)/255,(n>>>8&255)/255,(n>>>16&255)/255,(n>>>24&255)/255)}function Rn(n){if(n[3]===void 0||n[3]===1){let e="#";for(let t=0;t<3;++t)e+=hk(Math.min(255,Math.max(0,Math.round(n[t]*255))));return e}else{let e="rgba(";for(let t=0;t<3;++t)t!==0&&(e+=", "),e+=Math.min(255,Math.max(0,Math.round(n[t]*255)));return e+=`, ${kN(n[3])})`,e}}function hf(n){return n<=.03928?n/12.92:((n+.055)/1.055)**2.4}function nV(n){var e=ae(n,3);const t=e[0],r=e[1],i=e[2];return .2126*hf(t)+.7152*hf(r)+.0722*hf(i)}function yg(n){return nV(n)<=.179}class ru extends dt{constructor(e){super(dg(e)),this.defaultValue=e}toString(){return Rn(this.value)}toJSON(){if(!hg(this.value,this.defaultValue))return Rn(this.value)}reset(){this.value=dg(this.defaultValue)}restoreState(e){if(e===void 0){this.reset();return}const t=this.value,r=Ao(e);hg(t,r)||(this.value=r)}}class rV extends dt{constructor(){super(void 0)}toJSON(){const e=this.value;if(e!==void 0)return Rn(e)}reset(){this.value=void 0}restoreState(e){if(e===void 0){this.reset();return}const t=this.value,r=Ao(e);(t===void 0||!hg(t,r))&&(this.value=r)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var q;(function(n){n[n.UINT8=0]="UINT8",n[n.INT8=1]="INT8",n[n.UINT16=2]="UINT16",n[n.INT16=3]="INT16",n[n.UINT32=4]="UINT32",n[n.INT32=5]="INT32",n[n.UINT64=6]="UINT64",n[n.FLOAT32=7]="FLOAT32"})(q||(q={}));const fk={[q.UINT8]:!1,[q.INT8]:!0,[q.UINT16]:!1,[q.INT16]:!0,[q.UINT32]:!1,[q.INT32]:!0,[q.UINT64]:!1,[q.FLOAT32]:void 0},iV={[q.UINT8]:1,[q.INT8]:1,[q.UINT16]:2,[q.INT16]:2,[q.UINT32]:4,[q.INT32]:4,[q.UINT64]:8,[q.FLOAT32]:4},sV={[q.UINT8]:Uint8Array,[q.INT8]:Int8Array,[q.UINT16]:Uint16Array,[q.INT16]:Int16Array,[q.UINT32]:Uint32Array,[q.INT32]:Int32Array,[q.UINT64]:Uint32Array,[q.FLOAT32]:Float32Array};q.UINT8+"",q.INT8+"",q.UINT16+"",q.INT16+"",q.UINT32+"",q.INT32+"",q.UINT64+"",q.FLOAT32+"";/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Jn;(function(n){n[n.LITTLE=0]="LITTLE",n[n.BIG=1]="BIG"})(Jn||(Jn={}));function aV(){const n=Uint16Array.of(4386);return new Uint8Array(n.buffer)[0]===17?Jn.BIG:Jn.LITTLE}const pd=aV();var vS={},pf,yS;function oV(){if(yS)return pf;yS=1;var n=Cs(),e=Math.floor;return pf=function(t){return!n(t)&&isFinite(t)&&e(t)===t},pf}var bS;function lV(){if(bS)return vS;bS=1;var n=Ot();return n(n.S,"Number",{isInteger:oV()}),vS}var wS,SS;function dV(){return SS||(SS=1,lV(),wS=ut().Number.isInteger),wS}var CS,xS;function cV(){return xS||(xS=1,CS={default:dV(),__esModule:!0}),CS}var uV=cV();const Nn=Qe(uV);var ES={},TS;function hV(){if(TS)return ES;TS=1;var n=Ot(),e=Ni().isFinite;return n(n.S,"Number",{isFinite:function(t){return typeof t=="number"&&e(t)}}),ES}var kS,LS;function pV(){return LS||(LS=1,hV(),kS=ut().Number.isFinite),kS}var IS,DS;function fV(){return DS||(DS=1,IS={default:pV(),__esModule:!0}),IS}var gV=fV();const gt=Qe(gV);var PS={},RS;function mV(){if(RS)return PS;RS=1;var n=Ot();return n(n.S,"Number",{isNaN:function(e){return e!=e}}),PS}var MS,AS;function vV(){return AS||(AS=1,mV(),MS=ut().Number.isNaN),MS}var NS,VS;function yV(){return VS||(VS=1,NS={default:vV(),__esModule:!0}),NS}var bV=yV();const Wr=Qe(bV);function fd(n){let e=typeof n;if(e==="number"||e==="string"){let t=parseFloat(""+n);if(!Wr(t))return t}throw new Error(`Expected floating-point number, but received: ${ie(n)}.`)}function vt(n){let e=fd(n);if(gt(e))return e;throw new Error(`Expected finite floating-point number, but received: ${e}.`)}function gk(n){let e=fd(n);if(gt(e)&&e>=0)return e;throw new Error(`Expected finite non-negative floating-point number, but received: ${e}.`)}function yn(n){let e=vt(n);if(e>0)return e;throw new Error(`Expected positive finite floating-point number, but received: ${e}.`)}function iu(n,e,t=fd){ge(e),n[0]=n[1]=n[2]=0;for(const r of Qt(e))switch(r){case"x":n[0]=t(e[r]);break;case"y":n[1]=t(e[r]);break;case"z":n[2]=t(e[r]);break;default:throw new Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${ie(e)}.`)}return n}function Fl(n,e){let t=n.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes");for(let r=0;r<t;++r)if(!gt(parseFloat(e[r])))throw new Error("Non-finite value.");for(let r=0;r<t;++r)n[r]=parseFloat(e[r]);return n}function $a(n,e){let t=n.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes.");for(let r=0;r<t;++r){let i=parseInt(e[r],void 0);if(!Nn(i))throw new Error("Non-integer value.")}for(let r=0;r<t;++r)n[r]=parseInt(e[r],void 0);return n}function lr(n){if(typeof n=="object"){if(n===null)return"null";if(Array.isArray(n)){let s="[",a=n.length,l=0;if(l<a)for(s+=lr(n[l]);++l<a;)s+=",",s+=lr(n[l]);return s+="]",s}let e="{",t=Qt(n).sort(),r=0,i=t.length;if(r<i){let s=t[r];for(e+=ie(s),e+=":",e+=lr(n[s]);++r<i;)e+=",",s=t[r],e+=ie(s),e+=":",e+=lr(n[s])}return e+="}",e}return ie(n)}const wV=/('(?:[^'\\]|(?:\\.))*')/,SV=/("(?:[^"\\]|(?:\\.))*")/,CV=new RegExp(`${wV.source}|${SV.source}`),xV=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/;function EV(n,e,t,r){if(n.length>=2&&n.charAt(0)===e&&n.charAt(n.length-1)===e){let i=n.substr(1,n.length-2),s=t;for(;i.length>0;){let a=i.match(r);if(a===null){s+=i;break}s+=a[1],a[2]===t?(s+="\\",s+=t):s+=e,i=i.substr(a.index+a[0].length)}return s+=t,s}return n}function TV(n,e,t){const r=/[&_,]/g;let i,s,a;i="'",s=xV,a=CV;let l="";for(;n.length>0;){let c=n.match(a),u,h;if(c===null)u=n,n="",h="";else{u=n.substr(0,c.index),n=n.substr(c.index+c[0].length);let g=c[1];g!==void 0?h=EV(g,i,t,s):h=c[2]}l+=u.replace(r,e),l+=h}return l}function kV(n){return TV(n,",",'"')}function bg(n){return JSON.parse(kV(n))}function qr(n,e){if(!Array.isArray(n))throw new Error(`Expected array, but received: ${ie(n)}.`);if(e!==void 0&&n.length!==e)throw new Error(`Expected array of length ${e}, but received: ${ie(n)}.`);return n}function We(n,e){if(!Array.isArray(n))throw new Error(`Expected array, but received: ${ie(n)}.`);return n.map(e)}function it(n,e,t){const r=n.length;if(!Array.isArray(e)||e.length!==r)throw new Error(`Expected length ${r} array, but received: ${ie(e)}.`);for(let i=0;i<r;++i)n[i]=t(e[i],i);return n}function ge(n){if(typeof n!="object"||n==null||Array.isArray(n))throw new Error(`Expected JSON object, but received: ${ie(n)}.`);return n}function hn(n){let e=parseInt(n,10);if(!Nn(e))throw new Error(`Expected integer, but received: ${ie(n)}.`);return e}function on(n){let e=hn(n);if(e<=0)throw new Error(`Expected positive integer, but received: ${e}.`);return e}function LV(n){const e=hn(n);if(e<0)throw new Error(`Expected non-negative integer, but received: ${e}.`);return e}function mk(n,e){let t=e.get(n);if(t===void 0)throw new Error(`Expected one of ${ie(Te(e.keys()))}, but received: ${ie(n)}.`);return t}function ke(n){if(typeof n!="string")throw new Error(`Expected string, but received: ${ie(n)}.`);return n}function Ir(n){if(n!==void 0)return ke(n)}function X(n,e,t){let r=Object.prototype.hasOwnProperty.call(n,e)?n[e]:void 0;try{return t(r)}catch(i){throw new Error(`Error parsing ${ie(e)} property: ${i.message}`)}}function ye(n,e,t,r){return X(n,e,i=>i===void 0?r:t(i))}function av(n,e){ge(n);let t=new de;for(let r of Qt(n))try{t.set(r,e(n[r]))}catch(i){throw new Error(`Error parsing value associated with key ${ie(r)}: ${i.message}`)}return t}function vk(n){if(typeof n!="number"||!gt(n)||n<0||n>1)throw new Error(`Expected floating point number in [0,1], but received: ${ie(n)}.`);return n}function gd(n){if(n==="")return{};if(n.startsWith("{"))return bg(n);{let e={},t=n.split(/[&;]/);for(let r of t){let i=r.match(/^([^=&;]+)=([^&;]*)$/);if(i===null)throw new Error(`Invalid query string part: ${ie(r)}.`);e[i[1]]=decodeURIComponent(i[2])}return e}}function IV(n){if(n===void 0)return"";const e=Qt(n);return e.length===0?"":e.some(t=>typeof n[t]!="string")?ie(n):e.map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(n[t])}`).join("&")}function Mn(n,e){if(typeof n=="string"&&n.match(/^[a-zA-Z]/)!==null&&(n=n.toUpperCase(),e.hasOwnProperty(n)))return e[n];throw new Error(`Invalid enum value: ${ie(n)}.`)}function DV(n){return it(Ne(),n,vt)}function kr(n){if(!Array.isArray(n))throw new Error(`Expected array, received: ${ie(n)}.`);for(let e of n)if(typeof e!="string")throw new Error(`Expected string, received: ${ie(e)}.`);return n}function PV(n){if(!Array.isArray(n))throw new Error(`Expected array, received: ${ie(n)}.`);for(let e of n)if(!Nn(e))throw new Error(`Expected integer, received: ${ie(e)}.`);return n}function oo(n){if(typeof n!="boolean")throw new Error(`Expected boolean, received: ${ie(n)}`);return n}function No(n){for(const e in n)return n}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const RV=2**-1074,wg=new Float64Array(1),rs=new Uint32Array(wg.buffer);function MV(n,e){if(isNaN(n)||isNaN(e))return NaN;if(n===e)return e;if(n===0)return e<0?-5e-324:RV;wg[0]=n;const t=pd===Jn.LITTLE?0:1,r=1-t;return e>n==n>0?rs[t]===4294967295?(rs[t]=0,rs[r]+=1):rs[t]+=1:rs[t]===0?(rs[t]=4294967295,rs[r]-=1):rs[t]-=1,wg[0]}var OS={},BS;function AV(){if(BS)return OS;BS=1;var n=Ot(),e=Math.imul;return n(n.S+n.F*qm()(function(){return e(4294967295,5)!=-5||e.length!=2}),"Math",{imul:function(t,r){var i=65535,s=+t,a=+r,l=i&s,c=i&a;return 0|l*c+((i&s>>>16)*c+l*(i&a>>>16)<<16>>>0)}}),OS}var FS,_S;function NV(){return _S||(_S=1,AV(),FS=ut().Math.imul),FS}var US,$S;function VV(){return $S||($S=1,US={default:NV(),__esModule:!0}),US}var OV=VV();const jr=Qe(OV);var zS={},GS;function BV(){if(GS)return zS;GS=1;var n=Ot();return n(n.S,"Math",{log2:function(e){return Math.log(e)/Math.LN2}}),zS}var WS,jS;function FV(){return jS||(jS=1,BV(),WS=ut().Math.log2),WS}var HS,qS;function _V(){return qS||(qS=1,HS={default:FV(),__esModule:!0}),HS}var UV=_V();const Un=Qe(UV);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ff=new Uint32Array(2),kl=4294967296;let Sg=[];for(let n=2;n<=36;++n){let e=Math.floor(32/Un(n)),t=Math.pow(n,e),r=`^[0-${String.fromCharCode(48+Math.min(9,n-1))}`;n>10&&(r+=`a-${String.fromCharCode(97+n-11)}`,r+=`A-${String.fromCharCode(65+n-11)}`);let i=Math.ceil(64/Un(n));r+=`]{1,${i}}$`;let s=new RegExp(r);Sg[n]={lowDigits:e,lowBase:t,pattern:s}}function JS(n,e){n>>>=0,e>>>=0;const t=n&65535,r=n>>>16,i=e&65535,s=e>>>16;let a=(t*i>>>16)+r*i,l=a>>>16;a=(a&65535)+t*s,l+=a>>>16;let c=l>>>16;return l=(l&65535)+r*s,c+=l>>>16,((c&65535)<<16|l&65535)>>>0}class te{constructor(e=0,t=0){this.low=e,this.high=t}clone(){return new te(this.low,this.high)}assign(e){this.low=e.low,this.high=e.high}toString(e=10){let t=this.low,r=this.high;if(r===0)return t.toString(e);r*=kl;var i=Sg[e];let s=i.lowBase,a=i.lowDigits,l=r%s;r=Math.floor(r/s),t+=l,r+=Math.floor(t/s),t=t%s;let c=t.toString(e);return r.toString(e)+"0".repeat(a-c.length)+c}static less(e,t){return e.high<t.high||e.high===t.high&&e.low<t.low}static compare(e,t){return e.high-t.high||e.low-t.low}static equal(e,t){return e.low===t.low&&e.high===t.high}static min(e,t){return te.less(e,t)?e:t}static max(e,t){return te.less(e,t)?t:e}static random(){return crypto.getRandomValues(ff),new te(ff[0],ff[1])}tryParseString(e,t=10){var r=Sg[t];const i=r.lowDigits,s=r.lowBase;if(!r.pattern.test(e))return!1;if(e.length<=i)return this.low=parseInt(e,t),this.high=0,!0;const a=e.length-i,l=parseInt(e.substr(a),t),c=parseInt(e.substr(0,a),t);let u,h;if(s===kl)u=c,h=l;else{const g=jr(c,s)>>>0;u=JS(c,s)+(jr(Math.floor(c/kl),s)>>>0),h=l+g,h>=kl&&(++u,h-=kl)}return h>>>0!==h||u>>>0!==u?!1:(this.low=h,this.high=u,!0)}parseString(e,t=10){if(!this.tryParseString(e,t))throw new Error(`Failed to parse string as uint64 value: ${ie(e)}.`);return this}static parseString(e,t=10){return new te().parseString(e,t)}valid(){let e=this.low,t=this.high;return e>>>0===e&&t>>>0===t}toJSON(){return this.toString()}static lshift(e,t,r){const i=t.low,s=t.high;return r===0?(e.low=i,e.high=s):r<32?(e.low=i<<r,e.high=s<<r|i>>>32-r):(e.low=0,e.high=i<<r-32),e}static rshift(e,t,r){const i=t.low,s=t.high;return r===0?(e.low=i,e.high=s):r<32?(e.low=i>>>r|s<<32-r,e.high=s>>>r):(e.low=s>>>r-32,e.high=0),e}static or(e,t,r){return e.low=t.low|r.low,e.high=t.high|r.high,e}static xor(e,t,r){return e.low=t.low^r.low,e.high=t.high^r.high,e}static and(e,t,r){return e.low=t.low&r.low,e.high=t.high&r.high,e}static add(e,t,r){let i=t.low+r.low,s=t.high+r.high;const a=i>>>0;return a!==i&&(s+=1),e.low=a,e.high=s>>>0,e}static addUint32(e,t,r){let i=t.low+r,s=t.high;const a=i>>>0;return a!==i&&(s+=1),e.low=a,e.high=s>>>0,e}static decrement(e,t){let r=t.low,i=t.high;return r===0&&(i-=1),e.low=r-1>>>0,e.high=i>>>0,e}static increment(e,t){let r=t.low,i=t.high;return r===4294967295&&(i+=1),e.low=r+1>>>0,e.high=i>>>0,e}static subtract(e,t,r){let i=t.low-r.low,s=t.high-r.high;const a=i>>>0;return a!==i&&(s-=1),e.low=a,e.high=s>>>0,e}static absDifference(e,t,r){return te.less(t,r)?te.subtract(e,r,t):te.subtract(e,t,r)}static multiplyUint32(e,t,r){const i=t.low,s=t.high;return e.low=jr(i,r)>>>0,e.high=jr(s,r)+JS(i,r)>>>0,e}static lowMask(e,t){return t===0?e.high=e.low=0:t<=32?(e.high=0,e.low=4294967295>>>32-t):(e.high=4294967295>>>t-32,e.low=4294967295),e}toNumber(){return this.low+this.high*4294967296}setFromNumber(e){e=Math.round(e),e<0?this.low=this.high=0:e>=18446744073709552e3?this.low=this.high=4294967295:(this.low=e%4294967296,this.high=Math.floor(e/4294967296))}}te.ZERO=new te(0,0);te.ONE=new te(1,0);const md={[q.UINT8]:[0,255],[q.INT8]:[-128,127],[q.UINT16]:[0,65535],[q.INT16]:[-32768,32767],[q.UINT32]:[0,4294967295],[q.INT32]:[-2147483648,2147483647],[q.UINT64]:[te.ZERO,new te(4294967295,4294967295)],[q.FLOAT32]:[0,1]};function nr(n,e){if(typeof e=="number"){const t=n[0],r=n[1];return(e-t)/(r-t)}else{const t=n[0],r=n[1];let i;te.compare(e,t)<0?i=-te.subtract(qn,t,e).toNumber():i=te.subtract(qn,e,t).toNumber();let s=te.absDifference(qn,r,t).toNumber();return te.compare(t,r)>0&&(s*=-1),i/s}}function Ci(n,e,t){if(typeof n[0]=="number"){const i=n[0],s=n[1];let a=i*(1-t)+s*t;if(e!==q.FLOAT32){const l=md[e];a=Math.round(a),a=Math.max(l[0],a),a=Math.min(l[1],a)}return a}else{let i=n[0],s=n[1];if(te.compare(i,s)>0){var r=[s,i];i=r[0],s=r[1],t=1-t}const a=te.subtract(qn,s,i).toNumber(),l=new te;return t<=0?(qn.setFromNumber(a*-t),te.subtract(l,i,te.min(qn,i))):t>=1?(qn.setFromNumber(a*(t-1)),te.add(l,s,qn),te.less(l,s)&&(l.low=l.high=4294967295)):(qn.setFromNumber(a*t),te.add(l,i,qn),te.less(l,i)&&(l.low=l.high=4294967295)),l}}function ql(n,e){return typeof e=="number"?Math.min(Math.max(n[0],e),n[1]):te.min(te.max(n[0],e),n[1])}function _l(n,e){return[ql(n,e[0]),ql(n,e[1])]}function yk(n){if(cr(n[0],n[1])<=0)return n;throw new Error(`Invalid interval: [${n[0]}, ${n[1]}]`)}function $V(n){return cr(n[0],n[1])<=0?n:[n[1],n[0]]}function cr(n,e){return typeof n=="number"?n-e:te.compare(n,e)}const qn=new te,zV=new te;function GV(n,e){return typeof e=="number"?Math.abs(e-n[0])<Math.abs(e-n[1])?0:1:te.less(te.absDifference(qn,n[0],e),te.absDifference(zV,n[1],e))?0:1}function vd(n,e){let t;switch(typeof e!="string"?t=""+e:t=e,n){case q.UINT64:return te.parseString(t);case q.FLOAT32:{const r=parseFloat(t);if(!gt(r))throw new Error(`Invalid float32 value: ${ie(t)}`);return r}default:{const r=parseInt(t),i=md[n];if(!Nn(r)||r<i[0]||r>i[1])throw new Error(`Invalid ${q[n].toLowerCase()} value: ${ie(t)}`);return r}}}function su(n,e){return it(new Array(2),n,t=>vd(e,t))}function xi(n,e,t){return n===q.UINT64?te.equal(e[0],t[0])&&te.equal(e[1],t[1]):e[0]===t[0]&&e[1]===t[1]}function YS(n,e,t=md[e]){if(!xi(e,n,t))return e===q.UINT64?[n[0].toString(),n[1].toString()]:n}function au(n,e,t){switch(n){case q.FLOAT32:return MV(e,t*(1/0));case q.UINT64:const r=e;return t===-1?r.low===0&&r.high===0?r:te.decrement(new te,r):r.low===4294967295&&r.high===4294967295?r:te.increment(new te,r);default:{const i=md[n];return Math.max(i[0],Math.min(i[1],e+t))}}}function WV(n,e){switch(n){case q.FLOAT32:return 0;case q.UINT64:return .5/te.absDifference(qn,e[0],e[1]).toNumber();default:return .5/Math.abs(e[0]-e[1])}}function ou(n,e){switch(n){case q.FLOAT32:return 1;case q.UINT64:{const t=te.absDifference(qn,e[0],e[1]).toNumber();return t/(t+1)}default:{const t=Math.abs(e[0]-e[1]);return t/(t+1)}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function lu(n=128){const e=Math.ceil(n/32),t=new Uint32Array(e);crypto.getRandomValues(t);let r="";for(let i=0;i<e;++i)r+=("00000000"+t[i].toString(16)).slice(-8);return r}function jV(n){let e=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);const t=65536;for(let r=0,i=e.length;r<i;r+=t)crypto.getRandomValues(e.subarray(r,Math.min(i,r+t)));return n}function XS(){const n=new Uint32Array(1);return crypto.getRandomValues(n),n[0]}class Gc extends K{constructor(e){super(),this.id=e,this.changed=new we}addRef(){return super.addRef()}dispose(){super.dispose()}}var Pe;(function(n){n[n.POINT=0]="POINT",n[n.LINE=1]="LINE",n[n.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",n[n.ELLIPSOID=3]="ELLIPSOID",n[n.SPHERE=4]="SPHERE"})(Pe||(Pe={}));const Li=[Pe.POINT,Pe.LINE,Pe.AXIS_ALIGNED_BOUNDING_BOX,Pe.ELLIPSOID,Pe.SPHERE],gs={rgb:{serializedBytes(){return 3},alignment(){return 1},serializeCode(n,e){return`dv.setUint16(${e}, ${n}, true);dv.setUint8(${e} + 2, ${n} >>> 16);`},deserializeCode(n,e){return`${n} = dv.getUint16(${e}, true) | (dv.getUint8(${e} + 2) << 16);`},deserializeJson(n){return vg(Ao(n))},serializeJson(n){return Rn(eo(n))}},rgba:{serializedBytes(){return 4},alignment(){return 1},serializeCode(n,e){return`dv.setUint32(${e}, ${n}, true);`},deserializeCode(n,e){return`${n} = dv.getUint32(${e}, true);`},deserializeJson(n){return vg(pk(n))},serializeJson(n){return Rn(sv(n))}},float32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setFloat32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getFloat32(${e}, isLittleEndian);`},deserializeJson(n){return fd(n)},serializeJson(n){return n}},uint32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setUint32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getUint32(${e}, isLittleEndian);`},deserializeJson(n){return hn(n)},serializeJson(n){return n}},int32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(n,e){return`dv.setInt32(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getInt32(${e}, isLittleEndian);`},deserializeJson(n){return hn(n)},serializeJson(n){return n}},uint16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(n,e){return`dv.setUint16(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getUint16(${e}, isLittleEndian);`},deserializeJson(n){return hn(n)},serializeJson(n){return n}},int16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(n,e){return`dv.setInt16(${e}, ${n}, isLittleEndian);`},deserializeCode(n,e){return`${n} = dv.getInt16(${e}, isLittleEndian);`},deserializeJson(n){return hn(n)},serializeJson(n){return n}},uint8:{serializedBytes(){return 1},alignment(){return 1},serializeCode(n,e){return`dv.setUint8(${e}, ${n});`},deserializeCode(n,e){return`${n} = dv.getUint8(${e});`},deserializeJson(n){return hn(n)},serializeJson(n){return n}},int8:{serializedBytes(){return 2},alignment(){return 1},serializeCode(n,e){return`dv.setInt8(${e}, ${n});`},deserializeCode(n,e){return`${n} = dv.getInt8(${e});`},deserializeJson(n){return hn(n)},serializeJson(n){return n}}},HV=255;function bk(n,e,t){let r=0;const i=t.length,s=new Array(i),a=[];for(let v=0;v<i;++v)s[v]=v;const l=v=>gs[t[v].type].alignment(n);s.sort((v,y)=>l(y)-l(v));let c=0;const u=new Array(i);let h=e;const g=()=>{h+=(4-h%4)%4,r+=h,a[c]=h,h=0,++c};for(let v=0;v<i;++v){const y=s[v],C=t[y],S=gs[C.type],w=S.serializedBytes(n),E=S.alignment(n),k=(E-h%E)%E,P=h+k+w;P+(4-P%4)%4<=HV?h+=k:g(),u[y]={offset:h,group:c},h+=w}return g(),{serializedBytes:r,offsets:u,propertyGroupBytes:a}}class wk{constructor(e,t,r){if(this.rank=e,this.firstGroupInitialOffset=t,this.propertySpecs=r,r.length===0){this.serializedBytes=t,this.serialize=this.deserialize=()=>{},this.propertyGroupBytes=[t];return}var i=bk(e,t,r);const s=i.serializedBytes,a=i.offsets,l=i.propertyGroupBytes;this.propertyGroupBytes=l;let c="let groupOffset0 = offset;";for(let y=1;y<l.length;++y)c+=`let groupOffset${y} = groupOffset${y-1} + ${l[y-1]}*annotationCount;`;for(let y=0;y<l.length;++y)c+=`groupOffset${y} += ${l[y]}*annotationIndex;`;let u=c,h=c;const g=r.length;for(let y=0;y<g;++y){var v=a[y];const C=v.group,S=v.offset,w=r[y],E=gs[w.type],k=`properties[${y}]`,P=`groupOffset${C} + ${S}`;u+=E.serializeCode(k,P,e),h+=E.deserializeCode(k,P,e)}this.serializedBytes=s,this.serialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",u),this.deserialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",h)}}function ov(n,e){const t=[];for(const r of Li){const i=Dn[r];t[r]=new wk(n,i.serializedBytes(n),e)}return t}function Sk(n,e){const t=n.type==="float32"?e.toPrecision(6):e.toString(),r=n.enumValues,i=n.enumLabels;if(r!==void 0){const s=r.indexOf(e);if(s!==-1)return`${i[s]} (${t})`}return t}function qV(n,e){switch(n.type){case"rgb":return Rn(eo(e));case"rgba":return Rn(sv(e));default:return Sk(n,e)}}function JV(n){const e=ke(n);if(e.match(/^[a-z][a-zA-Z0-9_]*$/)===null)throw new Error(`Invalid property identifier: ${ie(n)}`);return e}function YV(n){if(ke(n),!Object.prototype.hasOwnProperty.call(gs,n))throw new Error("Unsupported property type: $JSON.stringify(obj)}");return n}function XV(n){const e=new ze;for(const t of n){if(e.has(t.identifier))throw new Error(`Duplicate property identifier: ${t.identifier}`);e.add(t.identifier)}}function KV(n){ge(n);const e=X(n,"id",JV),t=X(n,"type",YV),r=ye(n,"description",ke);let i=ye(n,"default",l=>gs[t].deserializeJson(l),0),s,a;switch(t){case"rgb":case"rgba":break;default:{const l=q[t.toUpperCase()];s=ye(n,"enum_values",c=>We(c,u=>vd(l,u))),s!==void 0&&(a=X(n,"enum_labels",c=>it(new Array(s.length),c,ke)))}}return{type:t,identifier:e,description:r,default:i,enumValues:s,enumLabels:a}}function ZV(n){const e=n.default;return{id:n.identifier,description:n.description,type:n.type,default:e===0?void 0:gs[n.type].serializeJson(e)}}function QV(n){if(!(n===void 0||n.length===0))return n.map(ZV)}function Ck(n){if(n===void 0)return[];const e=We(n,KV);return XV(e),e}function Cg(n,e,t,r,i){for(let s=0;s<r;++s)n.setFloat32(e,i[s],t),e+=4;return e}function Tc(n,e,t,r,i,s){return e=Cg(n,e,t,r,i),e=Cg(n,e,t,r,s),e}function xg(n,e,t,r,i){for(let s=0;s<r;++s)i[s]=n.getFloat32(e,t),e+=4;return e}function kc(n,e,t,r,i,s){return e=xg(n,e,t,r,i),e=xg(n,e,t,r,s),e}const Dn={[Pe.LINE]:{icon:"ꕹ",description:"Line",toJSON(n){return{pointA:Te(n.pointA),pointB:Te(n.pointB)}},restoreState(n,e,t){n.pointA=X(e,"pointA",r=>it(new Float32Array(t),r,vt)),n.pointB=X(e,"pointB",r=>it(new Float32Array(t),r,vt))},serializedBytes(n){return 8*n},serialize(n,e,t,r,i){Tc(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{const s=new Float32Array(r),a=new Float32Array(r);return kc(n,e,t,r,s,a),{type:Pe.LINE,pointA:s,pointB:a,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[Pe.SPHERE]:{icon:"⊖",description:"Sphere",toJSON(n){return{pointA:Te(n.pointA),pointB:Te(n.pointB)}},restoreState(n,e,t){n.pointA=X(e,"pointA",r=>it(new Float32Array(t),r,vt)),n.pointB=X(e,"pointB",r=>it(new Float32Array(t),r,vt))},serializedBytes(n){return 8*n},serialize(n,e,t,r,i){Tc(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{const s=new Float32Array(r),a=new Float32Array(r);return kc(n,e,t,r,s,a),{type:Pe.SPHERE,pointA:s,pointB:a,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[Pe.POINT]:{icon:"⚬",description:"Point",toJSON:n=>({point:Te(n.point)}),restoreState:(n,e,t)=>{n.point=X(e,"point",r=>it(new Float32Array(t),r,vt))},serializedBytes:n=>n*4,serialize:(n,e,t,r,i)=>{Cg(n,e,t,r,i.point)},deserialize:(n,e,t,r,i)=>{const s=new Float32Array(r);return xg(n,e,t,r,s),{type:Pe.POINT,point:s,id:i,properties:[]}},visitGeometry(n,e){e(n.point,!1)}},[Pe.AXIS_ALIGNED_BOUNDING_BOX]:{icon:"❑",description:"Bounding Box",toJSON:n=>({pointA:Te(n.pointA),pointB:Te(n.pointB)}),restoreState:(n,e,t)=>{n.pointA=X(e,"pointA",r=>it(new Float32Array(t),r,vt)),n.pointB=X(e,"pointB",r=>it(new Float32Array(t),r,vt))},serializedBytes:n=>8*n,serialize(n,e,t,r,i){Tc(n,e,t,r,i.pointA,i.pointB)},deserialize:(n,e,t,r,i)=>{const s=new Float32Array(r),a=new Float32Array(r);return kc(n,e,t,r,s,a),{type:Pe.AXIS_ALIGNED_BOUNDING_BOX,pointA:s,pointB:a,id:i,properties:[]}},visitGeometry(n,e){e(n.pointA,!1),e(n.pointB,!1)}},[Pe.ELLIPSOID]:{icon:"◎",description:"Ellipsoid",toJSON:n=>({center:Te(n.center),radii:Te(n.radii)}),restoreState:(n,e,t)=>{n.center=X(e,"center",r=>it(new Float32Array(t),r,vt)),n.radii=X(e,"radii",r=>it(new Float32Array(t),r,gk))},serializedBytes:n=>8*n,serialize(n,e,t,r,i){Tc(n,e,t,r,i.center,i.radii)},deserialize:(n,e,t,r,i)=>{const s=new Float32Array(r),a=new Float32Array(r);return kc(n,e,t,r,s,a),{type:Pe.ELLIPSOID,center:s,radii:a,id:i,properties:[]}},visitGeometry(n,e){e(n.center,!1),e(n.radii,!0)}}};function Eg(n,e){const t=Dn[n.type].toJSON(n,e.rank);t.type=Pe[n.type].toLowerCase(),t.id=n.id,t.description=n.description||void 0;const r=n.relatedSegments;if(r!==void 0&&r.some(i=>i.length!==0)&&(t.segments=r.map(i=>i.map(s=>s.toString()))),e.properties.length!==0){const i=e.properties;t.props=n.properties.map((s,a)=>gs[i[a].type].serializeJson(s))}return t}function e3(n,e,t=!1){ge(n);const r=X(n,"type",c=>Mn(c,Pe)),i=X(n,"id",t?Ir:ke)||lv(),s=X(n,"segments",c=>{if(c===void 0)return e.relationships.map(()=>[]);const u=qr(c);return u.length===0?e.relationships.map(()=>[]):e.relationships.length===1&&!Array.isArray(u[0])?[We(u,h=>te.parseString(h))]:We(qr(c,e.relationships.length),h=>We(h,g=>te.parseString(g)))}),a=X(n,"props",c=>{const u=e.properties;return c===void 0?u.map(h=>h.default):We(qr(c,e.properties.length),(h,g)=>gs[u[g].type].deserializeJson(h))}),l={id:i,description:X(n,"description",Ir),relatedSegments:s,properties:a,type:r};return Dn[r].restoreState(l,n,e.rank),l}class lo extends K{constructor(e,t=[],r=[]){super(),this.relationships=t,this.properties=r,this.annotationMap=new de,this.changed=new we,this.readonly=!1,this.childAdded=new Ze,this.childUpdated=new Ze,this.childDeleted=new Ze,this.childRefreshed=new we,this.pending=new ze,this.references=new de,this.rank_=e,this.annotationPropertySerializers=ov(e,r)}get rank(){return this.rank_}hasNonSerializedProperties(){return!0}add(e,t=!0){if(this.ensureUpdated(),!e.id)e.id=lv();else if(this.annotationMap.has(e.id))throw new Error(`Annotation id already exists: ${ie(e.id)}.`);return this.annotationMap.set(e.id,e),this.changed.dispatch(),this.childAdded.dispatch(e),t||this.pending.add(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();const t=e.id;this.pending.delete(t),this.changed.dispatch()}update(e,t){if(this.ensureUpdated(),e.value===null)throw new Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[An](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){e.value!==null&&(e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id))}getReference(e){let t=this.references.get(e);return t!==void 0?t.addRef():(t=new Gc(e),t.value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer(()=>{this.references.delete(e)}),t)}ensureUpdated(){}toJSON(){this.ensureUpdated();const e=[],t=this.pending;for(const r of this)t.has(r.id)||e.push(Eg(r,this));return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();const t=this.annotationMap;t.clear(),this.pending.clear(),e!==void 0&&We(e,r=>{const i=e3(r,this);t.set(i.id,i)});for(const r of this.references.values()){const i=r.id,s=t.get(i);r.value=s||null,r.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}}class t3 extends lo{constructor(e,t,r){super(e.value.sourceRank,r,t),this.watchableTransform=e,this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add(()=>this.ensureUpdated()))}get rank(){return this.ensureUpdated(),this.rank_}ensureUpdated(){const e=this.watchableTransform.value,t=this.curCoordinateTransform;if(e===t)return;this.curCoordinateTransform=e;const r=e.sourceRank,i=t.sourceRank;if(i===r&&(t.inputSpace===e.inputSpace||Oe(t.inputSpace.ids.slice(0,r),e.inputSpace.ids.slice(0,r))))return;const s=e.inputSpace.ids,a=t.inputSpace.ids,l=[];for(let u=0;u<r;++u){let h=a.indexOf(s[u]);h>=i&&(h=-1),l.push(h)}const c=u=>{const h=new Float32Array(r);for(let g=0;g<r;++g){const v=l[g];h[g]=v===-1?0:u[g]}return h};for(const u of this.annotationMap.values())switch(u.type){case Pe.POINT:u.point=c(u.point);break;case Pe.LINE:case Pe.SPHERE:case Pe.AXIS_ALIGNED_BOUNDING_BOX:u.pointA=c(u.pointA),u.pointB=c(u.pointB);break;case Pe.ELLIPSOID:u.center=c(u.center),u.radii=c(u.radii);break}this.rank_!==r&&(this.rank_=r,this.annotationPropertySerializers=ov(this.rank_,this.properties)),this.changed.dispatch()}}const n3="Data Bounds";function lv(){return lu(160)}function r3(n){return{type:Pe.AXIS_ALIGNED_BOUNDING_BOX,id:"data-bounds",description:n3,pointA:new Float32Array(n.lowerBounds),pointB:new Float32Array(n.upperBounds),properties:[]}}function yd(n){const e=new lo(n.lowerBounds.length);return e.readonly=!0,e.add(r3(n)),e}function i3(n,e){let t=0;const r=[];for(const u of Li){const h=e[u].serializedBytes;r[u]=t;const g=n[u].length;t+=h*g}const i=[],s=[],a=new ArrayBuffer(t),l=new DataView(a),c=pd===Jn.LITTLE;for(const u of Li){const h=e[u],g=h.rank,v=h.serialize,y=n[u];i[u]=y.map(E=>E.id),s[u]=new de(y.map((E,k)=>[E.id,k]));const C=Dn[u].serialize,S=r[u],w=h.propertyGroupBytes[0];for(let E=0,k=y.length;E<k;++E){const P=y[E];C(l,S+E*w,c,g,P),v(l,S,E,k,c,P.properties)}}return{data:new Uint8Array(a),typeToIds:i,typeToOffset:r,typeToIdMaps:s}}class s3{constructor(e){this.propertySerializers=e,this.annotations=[[],[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return i3(this.annotations,this.propertySerializers)}}function dv(n){if(n==null)return n;const e=n.relatedSegments;if(e!==void 0)for(let t=0,r=e.length;t<r;++t){const i=e[t];i!==void 0&&(e[t]=i.map(s=>new te(s.low,s.high)))}return n}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function rh(n,e,t,r,i,s,a,l,c){for(let u=0;u<a;++u)for(let h=0;h<c;++h){let g=0;for(let v=0;v<l;++v)g+=t[u+r*v]*i[v+s*h];n[u+e*h]=g}return n}function a3(n,e,t){for(let r=0;r<t;++r){const i=e*r;n.fill(0,i,i+t),n[i+r]=1}return n}function xs(n,e,t=e){return a3(new n(e*t),e,Math.min(e,t))}function KS(n,e,t=!0){const r=e.length,i=t?r+1:r,s=new n(i*(r+1));t&&(s[s.length-1]=1);for(let a=0;a<r;++a)s[(i+1)*a]=e[a];return s}function o3(n,e,t){for(let r=0;r<t;++r)for(let i=0;i<t;++i)if(n[r*e+i]!=(r===i?1:0))return!1;return!0}function cv(n,e,t,r,i,s){for(let a=0;a<s;++a){const l=a*r,c=a*e;for(let u=0;u<i;++u)n[c+u]=t[l+u]}return n}function uv(n,e,t,r){cv(n,e+1,t,r+1,r,r);for(let i=0;i<r;++i)n[(e+1)*e+i]=t[(r+1)*r+i];n[n.length-1]=1;for(let i=r;i<e;++i)n[(e+1)*i+i]=1;return n}let er;function l3(n,e,t){let r=1;(er===void 0||er.length<t)&&(er=new Uint32Array(t));for(let i=0;i<t;++i)er[i]=i;for(let i=0;i<t;++i){const s=e*i;let a=i;{let u=Math.abs(n[s+i]);for(let h=i+1;h<t;++h){const g=Math.abs(n[s+h]);g>u&&(u=g,a=h)}}if(i!==a){r*=-1;for(let u=0;u<t;++u){const h=e*u,g=n[h+i];n[h+i]=n[h+a],n[h+a]=g}{const u=er[i];er[i]=er[a],er[a]=u}}const l=n[s+i],c=1/l;r*=l;for(let u=0;u<t;++u)n[e*u+i]*=c;n[s+i]=c;for(let u=0;u<t;++u){if(u===i)continue;const h=-n[e*i+u];for(let g=0;g<t;++g){const v=e*g;n[v+u]+=h*n[v+i]}n[e*i+u]=h*c}}for(let i=0;i<t;++i){let s=er[i];for(;s!==i;){const a=e*i,l=e*s;for(let u=0;u<t;++u){const h=a+u,g=l+u,v=n[h];n[h]=n[g],n[g]=v}const c=er[i]=er[s];er[s]=s,s=c}}return r}function hv(n,e,t,r,i){return cv(n,e,t,r,i,i),l3(n,e,i)}function d3(n,e,t,r,i,s){for(let a=0;a<s;++a){const l=e*a,c=r*a;for(let u=0;u<i;++u)if(n[l+u]!==t[c+u])return!1}return!0}function Ti(n,e,t,r,i){for(let s=0;s<i;++s){let a=e[t*i+s];for(let l=0;l<i;++l)a+=e[t*l+s]*r[l];n[s]=a}return n}function xk(n,e,t,r,i){for(let s=0;s<i;++s){let a=0;for(let l=0;l<i;++l)a+=e[t*l+s]*r[l];n[s]=a}return n}var ZS={},QS;function c3(){if(QS)return ZS;QS=1;var n=Ot();return n(n.S,"Math",{log10:function(e){return Math.log(e)*Math.LOG10E}}),ZS}var eC,tC;function u3(){return tC||(tC=1,c3(),eC=ut().Math.log10),eC}var nC,rC;function h3(){return rC||(rC=1,nC={default:u3(),__esModule:!0}),nC}var p3=h3();const Ek=Qe(p3),Wc=[{prefix:"Y",exponent:24},{prefix:"Z",exponent:21},{prefix:"E",exponent:18},{prefix:"P",exponent:15},{prefix:"T",exponent:12},{prefix:"G",exponent:9},{prefix:"M",exponent:6},{prefix:"k",exponent:3},{prefix:"",exponent:0},{prefix:"m",exponent:-3},{prefix:"µ",exponent:-6},{prefix:"n",exponent:-9},{prefix:"p",exponent:-12},{prefix:"f",exponent:-15},{prefix:"a",exponent:-18},{prefix:"z",exponent:-21},{prefix:"y",exponent:-24}],f3=[{prefix:"c",exponent:-2},{prefix:"u",exponent:-6},...Wc],bd=new de;bd.set("",{unit:"",exponent:0});const g3=new de;for(const n of f3){const e=n.prefix,t=n.exponent;g3.set(t,e);for(const r of["m","s","Hz","rad/s"])bd.set(`${e}${r}`,{unit:r,exponent:t})}function Tk(n){const e=Ek(n),t=Wc.length,r=uN(0,t,i=>Wc[i].exponent<=e);return Wc[Math.min(r,t-1)]}function kk(n,e,t={}){var r=t.precision;const i=r===void 0?6:r;var s=t.elide1;const a=s===void 0?!0:s;let l=n,c="";if(e!==""){const h=Tk(n);c=h.prefix,l=pv(n,-h.exponent)}if(a&&l===1)return{scale:"",unit:e,prefix:c};let u;if(i!=0){l<1||l>=1e3?u=l.toPrecision(i):u=l.toFixed(i);const h=u.indexOf("e");let g,v;h!==-1?(g=u.substring(0,h),v=u.substring(h)):(g=u,v="");const y=g.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);y!==null&&(g=g.substring(0,g.length-y[1].length),g.endsWith(".")&&(g=g.substring(0,g.length-1)),u=g+v)}else u=l.toString();return{scale:u,unit:e,prefix:c}}function Qs(n,e,t){var r=kk(n,e,t);const i=r.scale,s=r.unit,a=r.prefix;return`${i}${a}${s}`}function Jl(n){if(n==="")return{scale:1,unit:""};const e=n.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([µa-zA-Z]+)?$/);if(e===null)return;const t=e[1];let r=t===void 0?1:Number(t);if(Wr(r))return;let i="";if(e[2]!==void 0){const s=bd.get(e[2]);if(s===void 0)return;i=s.unit,s.exponent>0?r*=10**s.exponent:r/=10**-s.exponent}if(!(r<=0||!gt(r)))return{scale:r,unit:i}}function iC(n){const e=bd.get(n);if(e===void 0)throw new Error(`Invalid unit: ${ie(n)}`);return e}function pv(n,e){return e>=0?n*10**e:n/10**-e}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Lk(n,e,t){const r=n.length;for(let i=0;i<r;++i)n[i]=e[i]+t[i];return n}function Tg(n,e,t){const r=n.length;for(let i=0;i<r;++i)n[i]=e[i]-t[i];return n}function m3(n,e,t,r){const i=n.length;for(let s=0;s<i;++s)n[s]=e[s]+t[s]*r;return n}function v3(n,e,t){const r=n.length;for(let i=0;i<r;++i)n[i]=e[i]*t;return n}function fv(n){let e=1;for(let t=0,r=n.length;t<r;++t)e*=n[t];return e}function y3(n,e,t){const r=n.length;for(let i=0;i<r;++i)n[i]=Math.min(e[i],t[i]);return n}const co=new Float32Array(0),Ik=new Float64Array(0);let b3=0;function Ya(){return++b3}function w3(n,e){return Oe(n.lowerBounds,e.lowerBounds)&&Oe(n.upperBounds,e.upperBounds)}function S3(n,e){return n===void 0?e===void 0:e===void 0?!1:n.explicit===e.explicit&&Oe(n.coordinates,e.coordinates)&&Oe(n.labels,e.labels)}function C3(n,e){const t=new de;for(let r=0,i=n.length;r<i;++r)t.set(n[r],e[r]);return n=Te(t.keys()),n.sort((r,i)=>r-i),e=Te(n,r=>t.get(r)),{coordinates:n,labels:e}}function Dk(n){if(n.length===1)return n[0];const e=new de;let t=!1;for(const s of n){s.explicit&&(t=!0);const a=s.coordinates,l=s.labels;for(let c=0,u=a.length;c<u;++c)e.set(a[c],l[c])}const r=Te(e.keys());r.sort((s,a)=>s-a);const i=Te(r,s=>e.get(s));return{explicit:t,coordinates:r,labels:i}}function sC(n){if(n=n.filter(e=>e!==void 0),n.length!==0)return Dk(n)}function x3(n,e){return Oe(n.transform,e.transform)&&w3(n.box,e.box)}function du(n,e){return n.valid===e.valid&&n.rank===e.rank&&Oe(n.names,e.names)&&Oe(n.ids,e.ids)&&Oe(n.timestamps,e.timestamps)&&Oe(n.units,e.units)&&Oe(n.scales,e.scales)&&lg(n.boundingBoxes,e.boundingBoxes,x3)&&lg(n.coordinateArrays,e.coordinateArrays,S3)}function st(n){const e=n.names,t=n.units,r=n.scales;var i=n.valid;const s=i===void 0?!0:i;var a=n.rank;const l=a===void 0?e.length:a;var c=n.timestamps;const u=c===void 0?e.map(()=>Number.NEGATIVE_INFINITY):c;var h=n.ids;const g=h===void 0?e.map((k,P)=>-P):h;var v=n.boundingBoxes;const y=v===void 0?[]:v;var C=n.coordinateArrays;const S=C===void 0?new Array(l):C;var w=n.bounds;const E=w===void 0?k3(y,l):w;return{valid:s,rank:l,names:e,timestamps:u,ids:g,units:t,scales:r,boundingBoxes:y,bounds:E,coordinateArrays:S}}const Pi=st({valid:!1,names:[],units:[],scales:Ik,boundingBoxes:[]}),uo=st({valid:!0,names:[],units:[],scales:Ik,boundingBoxes:[]});function E3(n){var e=qr(n,2),t=ae(e,2);const r=t[0],i=t[1],s=yn(r),a=ke(i),l=bd.get(a);if(l===void 0)throw new Error(`Invalid unit: ${ie(a)}`);return{unit:l.unit,scale:pv(s,l.exponent)}}function cu(n,e=!1){if(n===void 0)return Pi;ge(n);const t=yv(Qt(n),e),r=t.length,i=new Array(r),s=new Float64Array(r),a=new Array(r);for(let l=0;l<r;++l)X(n,t[l],c=>{if(Array.isArray(c)){var u=E3(c);const h=u.unit,g=u.scale;i[l]=h,s[l]=g}else{ge(c);let h=X(c,"coordinates",PV),g=X(c,"labels",kr),v=h.length;if(v!==g.length)throw new Error(`Length of coordinates array (${v}) does not match length of labels array (${g.length})`);i[l]="",s[l]=1,a[l]=j({explicit:!0},C3(h,g))}});return st({valid:!1,names:t,units:i,scales:s,coordinateArrays:a})}function kg(n){const e=n.rank;if(e===0)return;const t=n.names,r=n.units,i=n.scales,s=n.coordinateArrays,a={};for(let l=0;l<e;++l){const c=t[l],u=s[l];u?.explicit?a[c]={coordinates:Te(u.coordinates),labels:u.labels}:a[c]=[i[l],r[l]]}return a}class gv extends dt{constructor(){super(Pi)}toJSON(){return kg(this.value)}reset(){this.value=Pi}restoreState(e){this.value=cu(e)}}function Pk(n,e){let t=(n+e)/2;return gt(t)||(t=Math.min(Math.max(0,n),e)),t}function T3(n,e){const t=e.lowerBounds,r=e.upperBounds,i=n.length;for(let s=0;s<i;++s)n[s]=Pk(t[s],r[s]);return n}function aa(n){const e=n.lowerBounds.length;return{box:n,transform:xs(Float64Array,e,e+1)}}function Rk(n,e,t){var r=n.box;const i=r.lowerBounds,s=r.upperBounds,a=n.transform,l=i.length,c=t,u=a[c*l+e];let h=u,g=u,v=!1;for(let y=0;y<l;++y){let C=a[c*y+e];if(C===0)continue;const S=C*i[y],w=C*s[y];h+=Math.min(S,w),g+=Math.max(S,w),v=!0}if(v)return{lower:h,upper:g}}function k3(n,e){const t=new Float64Array(e),r=new Float64Array(e);t.fill(Number.NEGATIVE_INFINITY),r.fill(Number.POSITIVE_INFINITY);for(const i of n)for(let s=0;s<e;++s){const a=Rk(i,s,e);if(a===void 0)continue;const l=a.lower,c=a.upper;t[s]=t[s]===Number.NEGATIVE_INFINITY?l:Math.min(t[s],l),r[s]=r[s]===Number.POSITIVE_INFINITY?c:Math.max(r[s],c)}return{lowerBounds:t,upperBounds:r}}function L3(n,e,t){const r=n.transform,i=n.box,s=t.length,a=i.lowerBounds.length,l=new Float64Array((a+1)*e);for(let c=0;c<s;++c){const u=t[c];if(u!==-1)for(let h=0;h<=a;++h)l[h*e+u]=r[h*s+c]}return{transform:l,box:i}}function Mk(n,e){const t={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},r=new Float64Array(2*n);return r[e]=1,{transform:r,box:t}}function Ak(n,e,t){if(e===t)return n;const r=n.box,i=r.lowerBounds.length,s=new Float64Array((i+1)*t);return cv(s,t,n.transform,e,e,i+1),{box:r,transform:s}}function I3(n,e){const t=n.rank,r=n.sourceRank;if(t!==e.rank||r!==e.sourceRank)return!1;const i=n.inputSpace,s=e.inputSpace;return!Oe(s.scales,i.scales)||!Oe(s.units,i.units)||!Oe(e.outputSpace.names,n.outputSpace.names)?!1:Ok(n.transform,t,n.outputSpace.scales,e.transform,t,e.outputSpace.scales)}function zn(n){return{rank:n.rank,sourceRank:n.rank,inputSpace:n,outputSpace:n,transform:xs(Float64Array,n.rank+1)}}function D3(n,e,t,r){let i=n.transform,s=n.box;const a=n.box.lowerBounds.length,l=r.length,c=new Float64Array((a+1)*l);for(let u=0;u<l;++u){const h=r[u];for(let v=0;v<a;++v){let y=0;for(let C=0;C<l;++C){const S=t[C];y+=e[(l+1)*C+u]*i[l*v+C]*(S/h)}c[l*v+u]=y}let g=e[(l+1)*l+u];for(let v=0;v<l;++v){const y=t[v];g+=e[(l+1)*v+u]*i[l*a+v]*(y/h)}c[a*l+u]=g}return{transform:c,box:s}}function Nk(n,e,t){return n.boundingBoxes.map(r=>D3(r,e,n.scales,t))}function Lg(n,e,t){const r=st({valid:n.valid,rank:t.rank,ids:t.ids,names:t.names,timestamps:t.timestamps,scales:t.scales,units:t.units,boundingBoxes:Nk(n,e,t.scales),coordinateArrays:t.coordinateArrays});return du(r,t)?t:r}function mv(n,e=!1){if(e){const t=Number(n);if(Nn(t)&&t>=0)return!0}return n.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)!==null}function ih(n,e=!1){const t=new ze;for(const r of n){if(!mv(r,e)||t.has(r))return!1;t.add(r)}return!0}function vv(n){const e=n.length,t=new Array(e);t.fill(!0);for(let r=0;r<e;++r){const i=n[r];if(!mv(i)){t[r]=!1;continue}const s=n.indexOf(i,r+1);s!==-1&&(t[r]=!1,t[s]=!1)}return t}function Ul(n){return n.endsWith("'")}function Vk(n){return n.endsWith("'")||n.endsWith("^")}function P3(n){return n.endsWith("^")}function R3(n){return!Vk(n)}function M3(n,e,t){const r=new Float64Array(n),i=e.length,s=(i+1)*i;for(let a=0;a<i;++a)r[s+a]*=e[a]/t[a];return r}function Ok(n,e,t,r,i,s){if(!d3(n,e+1,r,i+1,e,e))return!1;for(let a=0;a<e;++a){const l=n[(e+1)*e+a],c=r[(i+1)*i+a];if(l*(t[a]/s[a])!==c)return!1}for(let a=e;a<i;++a)if(r[(i+1)*i+a]!==0)return!1;for(let a=e;a<i;++a){for(let l=0;l<e;++l)if(r[(i+1)*l+a]!==0)return!1;for(let l=0;l<i;++l){const c=r[(i+1)*a+l];if(a===l){if(c!==1)return!1}else if(c!==0)return!1}}return!0}function A3(n,e){if(!e.includes(n))return n;var t=n.match(/^([^']*)('?)$/),r=ae(t,3);const i=r[1],s=r[2];for(let a=0;;++a){const l=`${i}${a}${s}`;if(!e.includes(l))return l}}function N3(n,e){const t=n.inputSpace,r=n.transform,i=t.ids,s=t.rank,a=e.rank,l=e.names,c=e.units,u=e.scales,h=new Array(s);h.fill(!0);const g=[],v=e.ids.map((z,F)=>{const se=i.indexOf(z);return se!==-1?h[se]=!1:g.push(F),se}),y=n.outputSpace,C=y.names,S=y.units,w=y.scales,E=y.ids,k=y.timestamps,P=y.coordinateArrays,D=h,L=[],R=[],M=new Float64Array(a),V=[],B=[],_=new Array(a);let H=0;const U=new Float64Array((a+1)**2);U[U.length-1]=1;for(let z=0;z<s;++z)if(!D[z]){L[H]=C[z],V[H]=E[z],R[H]=S[z],M[H]=w[z],B[H]=k[z],_[H]=P[z];for(let F=0;F<a;++F){const se=v[F];se!==-1&&(U[F*(a+1)+H]=r[se*(s+1)+z])}U[a*(a+1)+H]=r[s*(s+1)+z],++H}for(const z of g)V[H]=Ya(),L[H]=A3(l[z],L),M[H]=u[z],R[H]=c[z],U[z*(a+1)+H]=1,++H;const O=st({valid:e.valid,rank:a,names:L,ids:V,timestamps:B,units:R,scales:M,boundingBoxes:Nk(e,U,M),coordinateArrays:_});return{rank:a,sourceRank:n.sourceRank,inputSpace:e,outputSpace:O,transform:U}}function aC(n){const e=Lg(n.inputSpace,n.transform,n.outputSpace);return e===n.outputSpace?n:{rank:n.rank,sourceRank:n.sourceRank,inputSpace:n.inputSpace,transform:n.transform,outputSpace:e}}class oC{constructor(e,t=!1){this.mutableSourceRank=t,this.value_=void 0,this.changed=new we,this.inputSpaceChanged=new we,this.defaultTransform=aC(e);const r=this;this.outputSpace={changed:r.changed,get value(){return r.value.outputSpace},set value(i){const s=r.value;if(du(s.outputSpace,i)||s.rank!==i.rank)return;const a=M3(s.transform,s.outputSpace.scales,i.scales);r.value_={sourceRank:s.sourceRank,rank:s.rank,inputSpace:s.inputSpace,outputSpace:Lg(s.inputSpace,a,i),transform:a},r.changed.dispatch()}},this.inputSpace={changed:r.inputSpaceChanged,get value(){return r.value.inputSpace},set value(i){const s=r.value;du(s.inputSpace,i)||(r.value_=N3(s,i),r.inputSpaceChanged.dispatch(),r.changed.dispatch())}}}set value(e){const t=this.value;e!==t&&(this.value_=aC(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let e=this.value_;return e===void 0&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){const e=this.value,t=e.rank,r=e.transform,i=e.inputSpace,s=e.outputSpace,a=e.sourceRank,l=this.defaultTransform,c=this.mutableSourceRank,u=l.inputSpace,h=l.rank,g=l.transform,v=l.outputSpace,y=i.units,C=i.scales,S=a===t&&Oe(C,c?s.scales:u.scales)&&Oe(y,c?s.units:u.units),w=Ok(g,h,v.scales,r,t,s.scales),E=Oe(v.names,s.names);if(!(w&&E&&S))return{sourceRank:a,transform:w?void 0:r,outputSpace:e.outputSpace,inputSpace:S?void 0:i}}set transform(e){const t=this.value,r=t.inputSpace;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:r,transform:e,outputSpace:Lg(r,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(e===void 0){this.reset();return}if(this.mutableSourceRank){const U=e.inputSpace||e.outputSpace,O=U.rank,z=st({rank:O,names:U.names.map((F,se)=>`${se}`),units:U.units,scales:U.scales,coordinateArrays:U.coordinateArrays});this.value={rank:O,transform:e.transform||xs(Float64Array,O+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:z};return}var t=this.defaultTransform;const r=t.inputSpace,i=t.sourceRank,s=t.outputSpace,a=t.transform,l=t.rank,c=e.inputSpace,u=e.sourceRank,h=e.outputSpace,g=e.transform,v=e.outputSpace.rank,y=r.names,C=c!==void 0?c.names:y,S=new Array(i);for(let U=0;U<i;++U){let O=C.indexOf(y[U]);O>=u&&(O=-1),S[U]=O}const w=v-u+i;for(let U=u;U<v;++U)S[i+U-u]=U;const E=new Float64Array(w),k=new Array(w),P=[];for(let U=0;U<i;++U){const O=S[U];O===-1||c===void 0?(E[U]=r.scales[U],P[U]=r.units[U],k[U]=r.coordinateArrays[U]):(E[U]=c.scales[O],P[U]=c.units[O],k[U]=sC([r.coordinateArrays[U],c.coordinateArrays[O]]))}const D=c||h,L=y.slice(0,i),R=s.names.slice(0,i),M=s.coordinateArrays.slice(0,i),V=new Float64Array(w),B=[];for(let U=0;U<w;++U){const O=S[U];O===-1?(V[U]=s.scales[U],B[U]=s.units[U],M[U]=s.coordinateArrays[U]):(R[U]=h.names[O],B[U]=h.units[O],V[U]=h.scales[O],M[U]=h.coordinateArrays[O])}if(!ih(R)){this.reset();return}for(let U=i;U<w;++U){const O=U-i+u;E[U]=D.scales[O],P[U]=D.units[O],L[U]=`${U}`}const _=new Float64Array((w+1)**2);_[_.length-1]=1;for(let U=0;U<w;++U){const O=S[U];let z;O===-1||g===void 0?U>=i?z=0:z=a[l*(l+1)+U]*(s.scales[U]/V[U]):z=g[v*(v+1)+O],_[w*(w+1)+U]=z;for(let F=0;F<w;++F){const se=S[F];let oe;O===-1!=(se===-1)?oe=0:O===-1||g===void 0?O>=i||se>=i?oe=O===se?1:0:oe=a[F*(l+1)+U]:oe=g[se*(v+1)+O],_[F*(w+1)+U]=oe}}const H=r.boundingBoxes.map(U=>Ak(U,l,w));for(let U=i;U<w;++U)H.push(Mk(w,U));for(let U=0;U<w;++U){if(_[w*(w+1)+U]!==0)continue;let O;for(let F=0;F<w;++F){const se=_[F*(w+1)+U];if(se!==0)if(se===1)if(O===void 0)O=F;else{O=null;break}else{O=null;break}}if(O==null)continue;let z=k[O];z!==void 0&&(z.explicit&&(z=j(j({},z),{explicit:!1})),M[U]=sC([z,M[U]]))}this.value={rank:w,transform:_,sourceRank:i,outputSpace:st({rank:w,names:R,scales:V,units:B,coordinateArrays:M}),inputSpace:st({rank:w,names:L,scales:E,units:P,coordinateArrays:k,boundingBoxes:H})}}toJSON(){return _k(this.spec)}restoreState(e){this.spec=Fk(e)}}function V3(n,e=!1){const t=ke(n);if(!mv(t,e))throw new Error(`Invalid dimension name: ${ie(t)}`);return t}function yv(n,e=!1){const t=We(n,r=>V3(r,e));if(!ih(t,e))throw new Error(`Invalid dimensions: ${ie(t)}`);return t}class bv{constructor(e,t){this.combined=e,this.bindings=new ze,this.retainCount=0,this.prevCombined=this.combined.value,this.dimensionRefCounts=new de,this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()},this.includeDimensionPredicate_=t}getRenameValidity(e){const t=this.combined.value.names,r=vv(e),i=e.length;for(let s=0;s<i;++s){if(!r[s])continue;const a=e[s];if(t.includes(a))continue;let l=!0;for(const c of this.bindings)if(c.space.value.names.includes(a)){l=!1;break}r[s]=l}return r}get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}update(){const e=this.combined,t=this.bindings,r=this.retainCount>0?1:0;if(t.size===0&&!r){e.value=Pi;return}const i=this.includeDimensionPredicate_,s=e.value;let a=Te(s.names),l=Te(s.units),c=Te(s.scales),u=Te(s.ids),h=Te(s.timestamps),g=s.names.map(()=>r?1:0);const v=[];let y=!1;for(const L of t){const R=L.space.value,M=L.prevValue,V=L.mappedDimensionIds;y=y||R.valid;const B=R.names,_=R.units,H=R.scales,U=R.ids,O=R.timestamps,z=[],F=[];v.push(F),L.mappedDimensionIds=z,L.prevValue=R;const se=B.length;for(let oe=0;oe<se;++oe){const Re=B[oe];if(!i(Re))continue;if(M!==void 0){const ne=U[oe],he=M.ids.indexOf(ne);if(he!==-1){const Le=V[he];if(Le!==void 0){const _e=u.indexOf(Le);if(_e!==-1){z[oe]=Le,++g[_e],F[oe]=_e;const Ge=O[oe];Ge!==void 0&&!(Ge<=h[_e])&&(a[_e]=Re,c[_e]=H[oe],l[_e]=_[oe],h[_e]=Ge);continue}}}}let le=a.indexOf(Re);if(le!==-1){z[oe]=u[le],++g[le],F[oe]=le;continue}le=a.length,F[oe]=le,g[le]=1+r,a[le]=Re,l[le]=_[oe],c[le]=H[oe],h[le]=O[oe];const Se=Ya();u[le]=Se,z[oe]=Se}}const C=this.dimensionRefCounts;C.clear();let S=0,w=a.length;for(const L of t){const R=L.space.value,M=v[S++],V=R.rank,B=Te(R.names),_=Te(R.timestamps),H=Float64Array.from(R.scales),U=Te(R.units);for(let O=0;O<V;++O){const z=M[O];z!==void 0&&(U[O]=l[z],H[O]=c[z],_[O]=h[z],B[O]=a[z])}for(const O of B){let z=C.get(O);z===void 0?z=1:++z,C.set(O,z)}if(!Oe(U,R.units)||!Oe(H,R.scales)||!Oe(B,R.names)||!Oe(_,R.timestamps)){const O=st({valid:R.valid,ids:R.ids,scales:H,units:U,names:B,timestamps:_,boundingBoxes:R.boundingBoxes,coordinateArrays:R.coordinateArrays});L.prevValue=O,L.space.value=O}}{for(let R=0;R<w;++R)i(a[R])||(g[R]=0);const L=(R,M)=>g[M]!==0;a=a.filter(L),l=l.filter(L),c=c.filter(L),u=u.filter(L),h=h.filter(L),g=g.filter(L),w=a.length}const E=[],k=new Array(w);for(let L=0,R=s.rank;L<R;++L){const M=s.coordinateArrays[L];if(!M?.explicit)continue;const V=u.indexOf(s.ids[L]);V!==-1&&(k[V]=[M])}for(const L of t){const R=L.space.value,M=R.rank,V=R.boundingBoxes,B=R.coordinateArrays,_=R.names.map(H=>a.indexOf(H));for(const H of V)E.push(L3(H,w,_));for(let H=0;H<M;++H){const U=B[H];if(U===void 0)continue;const O=_[H],z=k[O];z===void 0?k[O]=[U]:z.push(U)}}const P=new Array(w);for(let L=0;L<w;++L){const R=k[L];R!==void 0&&(P[L]=Dk(R))}const D=st({valid:y,ids:u,names:a,units:l,scales:new Float64Array(c),boundingBoxes:E,coordinateArrays:P});if(r)for(let L=0;L<w;++L)--g[L];du(s,D)||(this.prevCombined=D,e.value=D)}retain(){return++this.retainCount,()=>{--this.retainCount===0&&this.update()}}bind(e){const t={space:e,mappedDimensionIds:[],prevValue:void 0},r=this.bindings;r.size===0&&this.combined.changed.add(this.handleCombinedChanged),r.add(t);const i=e.changed.add(()=>{e.value!==t.prevValue&&this.update()}),s=()=>{i();const a=this.bindings;a.delete(t),a.size===0&&this.combined.changed.remove(this.handleCombinedChanged),this.update()};return this.update(),s}}function Bk(n,e,t,r,i){const s=i.length,a=new n((s+1)**2);a[a.length-1]=1;for(let l=0;l<s;++l){const c=r[l];a[(s+1)*s+l]=e[(t+1)*t+c];for(let u=0;u<s;++u){const h=i[u];a[(s+1)*u+l]=e[(t+1)*h+c]}}return a}function O3(n){if(n===void 0)return;const e=new Float64Array(16);if(Array.isArray(n))if(n.length===16)for(let t=0;t<4;++t)for(let r=0;r<4;++r)e[t*4+r]=vt(n[r*4+t]);else{qr(n,4);for(let t=0;t<4;++t){const r=qr(n[t],4);for(let i=0;i<4;++i)e[i*4+t]=vt(r[i])}}else{ge(n);const t=Pn(),r=Ne(),i=lt(1,1,1);ye(n,"rotation",a=>{Fl(t,a),Hl(t,t)}),ye(n,"translation",a=>{Fl(r,a)}),ye(n,"scale",a=>{Fl(i,a)});const s=Je();MN(s,t,r,i),e.set(s)}return{sourceRank:3,transform:e,outputSpace:st({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function Fk(n){if(n===void 0)return;const e=ge(n),t=X(e,"outputDimensions",cu),r=t.rank,i=X(e,"sourceRank",a=>{if(a===void 0)return r;if(!Nn(a)||a<0||a>r)throw new Error(`Expected integer in range [0, ${r}] but received: ${ie(a)}`);return a}),s=ye(e,"inputDimensions",a=>{const l=cu(a,!0);if(l.rank!==r)throw new Error(`Expected rank of ${r}, but received rank of: ${l.rank}`);return l});return{transform:ye(e,"matrix",a=>{const l=new Float64Array((r+1)**2),c=qr(a,r);l[l.length-1]=1;for(let u=0;u<r;++u)try{const h=qr(c[u],r+1);for(let g=0;g<=r;++g)l[(r+1)*g+u]=vt(h[g])}catch(h){throw new Error(`Error in row ${u}: ${h.message}`)}return l}),outputSpace:t,inputSpace:s,sourceRank:i}}function _k(n){if(n===void 0)return;const e=n.transform,t=n.outputSpace,r=n.inputSpace,i=n.sourceRank;let s;const a=t.rank;if(e!==void 0){s=[];for(let l=0;l<a;++l){const c=[];s[l]=c;for(let u=0;u<=a;++u)c[u]=e[(a+1)*u+l]}}return{sourceRank:i===a?void 0:i,matrix:s,outputDimensions:kg(t),inputDimensions:r===void 0?void 0:kg(r)}}function B3(n,e,t){const r=n.box,i=n.transform,s=n.box.lowerBounds.length,a=e.length,l=new Float64Array((s+1)*a);for(let c=0;c<a;++c)for(let u=0;u<=s;++u){const h=e[c];l[c+u*a]=i[h+u*t]}if(!l.every(c=>c===0))return{transform:l,box:r}}function Ig(n,e){const t=n.ids,r=n.names,i=n.scales,s=n.units,a=n.timestamps,l=n.coordinateArrays;return st({rank:e.length,valid:n.valid,ids:e.map(c=>t[c]),names:e.map(c=>r[c]),timestamps:e.map(c=>a[c]),scales:Float64Array.from(e,c=>i[c]),units:e.map(c=>s[c]),coordinateArrays:e.map(c=>l[c]),boundingBoxes:n.boundingBoxes.map(c=>B3(c,e,n.rank)).filter(c=>c!==void 0)})}function Uk(n,e,t){return e===t?n:Ig(n,pN(n.rank,t,e))}function lC(n,e){const t=n.transform,r=n.rank,i=nh(t,r,[e]);if(i.length!==1)return;var s=ae(i,1);const a=s[0],l=Math.abs(t[(r+1)*a+e]),c=n.inputSpace;return{scale:c.scales[a]*l,unit:c.units[a]}}function dC(n,e){var t=n.defaultInputSpace;const r=t.scales,i=t.units;return e<r.length?{scale:r[e],unit:i[e]}:void 0}function F3(n){const e=n.rank;var t=n.bounds;const r=t.lowerBounds,i=t.upperBounds;if(r.some(c=>c!==0))throw new Error("Lower bounds of channel coordinate space must all be 0");if(i.some(c=>!Nn(c)||c<=0||c>=2**32))throw new Error("Upper bounds of channel coordinate space must all be positive integers");const s=new Uint32Array(i),a=fv(s),l=new Uint32Array(a*e);for(let c=0;c<a;++c){let u=c;for(let h=0;h<e;++h){const g=u%s[h];u=(u-g)/s[h],l[c*e+h]=g}}return{channelCoordinateSpace:n,shape:s,numChannels:a,coordinates:l}}function gf(n,e,t,r,i,s){const a=t.scales,l=i.scales,c=i.rank,u=e+1;for(let h=0;h<c;++h){const g=s[h];if(g===-1)continue;const v=l[h];for(let y=0;y<e;++y){const C=r[y],S=a[C];n[u*y+g]*=S/v}}}function _3(n,e,t,r,i=uo){const s=t.inputSpace,a=t.rank,l=t.sourceRank,c=t.outputSpace,u=t.transform,h=s.names,g=c.names;let v;if(r!==void 0)v=Te(r.modelSubspaceDimensionIndices);else{v=[];for(let _=0;_<l;++_)v[_]=_}const y=v.length;for(let _=l;_<a;++_)v.push(_);const C=nh(t.transform,a,v,!0),S=v.length,w=v.map(_=>h[_]||`${_}`),E=C.map(_=>g[_]);if(S!==C.length)return{error:"Rank mismatch between model subspace dimensions ("+w.join(", ")+") and corresponding layer/global dimensions ("+E.join(", ")+")"};let k=Bk(Float32Array,u,a,C,v);const P=C.map(_=>g[_]),D=e.names.map(_=>P.indexOf(_)),L=n.names.map(_=>P.indexOf(_));gf(k,S,s,v,n,L),gf(k,S,s,v,e,D);const R=i.names.map(_=>P.indexOf(_));gf(k,S,s,v,i,R);const M=[],V=i.rank;if(r!==void 0){let _=r.subsourceToModelSubspaceTransform;y!==S&&(_=uv(new Float32Array((S+1)**2),S,_,y)),k=rh(new Float32Array((S+1)**2),S+1,k,S+1,_,S+1,S+1,S+1,S+1)}const B=new Uint32Array(V);for(let _=0;_<V;++_){const H=i.bounds.lowerBounds[_],U=i.bounds.upperBounds[_];if(H!==0||!Nn(U)||U<=0||U>=2**32)return{error:`Channel dimension ${i.names[_]} must have lower bound of 0 and positive integer upper bound`};B[_]=U;const O=R[_];let z=-1;if(O!==-1)for(let F=0;F<S;++F){const se=k[O+F*(S+1)];if(se!==0){if(se!==1||z!==-1)return{error:`Channel dimension ${E[O]} must map to a single source dimension`};z=F}}M[_]=z}return{rank:S,unpaddedRank:y,modelDimensionNames:w,layerDimensionNames:E,localToRenderLayerDimensions:D,globalToRenderLayerDimensions:L,channelToRenderLayerDimensions:R,modelToRenderLayerTransform:k,channelToModelDimensions:M,channelSpaceShape:B}}function U3(n,e){return n===e?!0:n.error!==void 0||e.error!==void 0?!1:Oe(n.modelDimensionNames,e.modelDimensionNames)&&Oe(n.layerDimensionNames,e.layerDimensionNames)&&Oe(n.globalToRenderLayerDimensions,e.globalToRenderLayerDimensions)&&Oe(n.localToRenderLayerDimensions,e.localToRenderLayerDimensions)&&Oe(n.channelToRenderLayerDimensions,e.channelToRenderLayerDimensions)&&Oe(n.modelToRenderLayerTransform,e.modelToRenderLayerTransform)&&Oe(n.channelSpaceShape,e.channelSpaceShape)}function $k(n,e,t,r,i){return dr((s,a,l,c)=>_3(s,a,l,r,c),[n,e,t,i===void 0?Zs(void 0):i],U3)}function $3(n,e,t,r){const i=t.globalToRenderLayerDimensions;for(let s=0;s<3;++s){let a=0;const l=r[s];if(l!==-1){const c=i[l];c!==-1&&(a=e[c])}n[s]=a}}function z3(n,e,t,r){const i=t.globalToRenderLayerDimensions;for(let s=0;s<3;++s){const a=r[s];if(a!==-1){const l=i[a];l!==-1&&(n[l]=e[s])}}}function zk(n,e){const t=n.rank,r=n.unpaddedRank;let i;r!==t&&e!==void 0&&(e=uv(new Float32Array((t+1)**2),t,e,r)),e!==void 0?(i=new Float32Array((t+1)*(t+1)),rh(i,t+1,n.modelToRenderLayerTransform,t+1,e,t+1,t+1,t+1,t+1)):i=n.modelToRenderLayerTransform;const s=new Float32Array((t+1)*(t+1)),a=hv(s,t+1,i,t+1,t+1);if(a===0)throw new Error("Transform is singular");const l=n.globalToRenderLayerDimensions,c=n.localToRenderLayerDimensions,u=n.channelToRenderLayerDimensions,h=l.length,g=c.length,v=h+g,y=new Float32Array((v+1)*t);for(let L=0;L<t;++L){for(let R=0;R<h;++R){const M=l[R];M!==-1&&(y[L+R*t]=s[L+M*(t+1)])}for(let R=0;R<g;++R){const M=c[R];M!==-1&&(y[L+(h+R)*t]=s[L+M*(t+1)])}y[L+v*t]=s[L+t*(t+1)]}const C=u.length;let S=new Array(C);const w=[];for(let L=0;L<C;++L){const R=u[L];let M=-1;if(R!==-1){for(let V=0;V<t;++V){const B=i[R+V*(t+1)];if(B!==0){if(B!==1||M!==-1)throw new Error(`Channel dimension ${n.layerDimensionNames[R]} must map with stride 1 to a single data chunk dimensions`);M=V}}if(M!==-1){if(i[R+t*(t+1)]!==0)throw new Error(`Channel dimension ${n.layerDimensionNames[R]} must have an offset of 0 in the chunk coordinate space`);w.push(M)}}S[L]=M}const E=n.channelSpaceShape,k=fv(E),P=w.length,D=new Uint32Array(k*P);for(let L=0;L<k;++L){let R=L,M=0;for(let V=0;V<C;++V){const B=R%E[V];R=(R-B)/E[V],S[V]!==-1&&(D[L*P+M]=B,++M)}}return{layerRank:t,modelTransform:n,chunkToLayerTransform:i,layerToChunkTransform:s,chunkToLayerTransformDet:a,combinedGlobalLocalRank:v,combinedGlobalLocalToChunkTransform:y,channelToChunkDimensionIndices:S,chunkChannelDimensionIndices:w,numChannels:k,chunkChannelCoordinates:D,channelSpaceShape:E}}function Gk(n,e){const t=n.globalToRenderLayerDimensions,r=[],i=[];for(let s=0;s<3;++s){const a=e[s];if(a==-1)continue;const l=t[a];i.push(l),l!==-1&&r.push(l)}for(let s=i.length;s<3;++s)i[s]=-1;return{layerDisplayDimensionIndices:r,displayToLayerDimensionIndices:i}}function Wk(n,e){const t=n.chunkToLayerTransform,r=n.modelTransform,i=r.rank,s=e.layerDisplayDimensionIndices,a=e.displayToLayerDimensionIndices,l=s.length,c=nh(t,i,s);if(c.length!==l){const g=r.modelDimensionNames,v=r.layerDimensionNames;throw new Error(`Rank mismatch between displayed layer dimensions (${Te(s,y=>v[y]).join(", ")}) and corresponding chunk dimensions (${Te(c,y=>g[y]).join(", ")})`)}const u=Je();for(let g=0;g<3;++g){const v=a[g];if(v!==-1){for(let y=0;y<l;++y){const C=c[y];u[y*4+g]=t[C*(i+1)+v]}u[12+g]=t[i*(i+1)+v]}}const h=Je();fs(h,u);for(let g=c.length;g<3;++g)c[g]=-1;return{modelTransform:n.modelTransform,chunkTransform:n,displaySubspaceModelMatrix:u,displaySubspaceInvModelMatrix:h,chunkDisplayDimensionIndices:c,numChunkDisplayDims:l}}function Yl(n,e,t,r,i){const s=e.length,a=t.length,l=n.length;let c=!0;for(let u=0;u<r;++u){let h=u,g=0;for(let v=0;v<s;++v)g+=i[h+v*r]*e[v];h+=s*r;for(let v=0;v<a;++v)g+=i[h+v*r]*t[v];g+=i[h+a*r],u<l?n[u]=g:(g<0||g>=1)&&(c=!1)}return c}function G3(n,e,t){n.fill(0),n[15]=1;let r=!0;const i=e.displayDimensionIndices,s=t.globalToRenderLayerDimensions,a=t.modelToRenderLayerTransform,l=t.rank;for(let c=0;c<3;++c){const u=i[c];if(u===-1){r=!1;continue}const h=s[u];if(h===-1){r=!1;continue}n[c+12]=a[h+l*(l+1)];for(let g=0;g<3;++g)n[c+4*g]=a[h+(l+1)*g]}if(!r){const c=e.globalDimensionNames,u=Te(i.filter(h=>h!==-1),h=>c[h]).join(", ");throw new Error(`Transform from model dimensions (${t.modelDimensionNames.join(", ")}) to display dimensions (${u}) does not have full rank`)}}var cC,uC;function W3(){return uC||(uC=1,DT(),cC=ut().Object.getOwnPropertySymbols),cC}var hC,pC;function j3(){return pC||(pC=1,hC={default:W3(),__esModule:!0}),hC}var H3=j3();const fC=Qe(H3);var q3=yA();const Mr=Qe(q3);var gC={},mC;function J3(){if(mC)return gC;mC=1;var n=Ym(),e=bA().f;return AT()("getOwnPropertyDescriptor",function(){return function(t,r){return e(n(t),r)}}),gC}var mf,vC;function Y3(){if(vC)return mf;vC=1,J3();var n=ut().Object;return mf=function(e,t){return n.getOwnPropertyDescriptor(e,t)},mf}var yC,bC;function X3(){return bC||(bC=1,yC={default:Y3(),__esModule:!0}),yC}var K3=X3();const Ar=Qe(K3);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var pt;(function(n){n[n.GPU_MEMORY=0]="GPU_MEMORY",n[n.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",n[n.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",n[n.DOWNLOADING=3]="DOWNLOADING",n[n.QUEUED=4]="QUEUED",n[n.NEW=5]="NEW",n[n.FAILED=6]="FAILED",n[n.EXPIRED=7]="EXPIRED"})(pt||(pt={}));const jk=8;var mi;(function(n){n[n.FIRST_TIER=0]="FIRST_TIER",n[n.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",n[n.VISIBLE=0]="VISIBLE",n[n.PREFETCH=1]="PREFETCH",n[n.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",n[n.RECENT=2]="RECENT",n[n.LAST_TIER=2]="LAST_TIER"})(mi||(mi={}));const Hk=3;var uu;(function(n){n[n.totalTime=0]="totalTime",n[n.totalChunks=1]="totalChunks"})(uu||(uu={}));var vi;(function(n){n[n.numChunks=0]="numChunks",n[n.systemMemoryBytes=1]="systemMemoryBytes",n[n.gpuMemoryBytes=2]="gpuMemoryBytes"})(vi||(vi={}));const as=3;function $s(n,e){return n*Hk+e}function wC(n){return jk*Hk*as+n}const Z3="ChunkQueueManager",Q3="ChunkManager",eO="ChunkSource.invalidate",tO="ChunkQueueManager.requestChunkStatistics",nO="ChunkManager.chunkLayerStatistics";class wv{constructor(){this.numVisibleChunksNeeded=0,this.numVisibleChunksAvailable=0,this.numPrefetchChunksNeeded=0,this.numPrefetchChunksAvailable=0}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ct(n){let e=-1;return j(()=>{e===-1&&(e=requestAnimationFrame(()=>{e=-1,n()}))},{flush:()=>{e!==-1&&(e=-1,n())},cancel:()=>{e!==-1&&(cancelAnimationFrame(e),e=-1)}})}class qk{constructor(){this.map=new de}get(e,t){let r=this.map,i=r.get(e);return i===void 0?(i=t(),i.registerDisposer(()=>{r.delete(e)}),r.set(e,i)):i.addRef(),i}}class Jk extends qk{get(e,t){return typeof e!="string"&&(e=lr(e)),super.get(e,t)}getUncounted(e,t){return this.get(e,()=>new jT(t())).value}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function rO(n){let e={antialias:!1,stencil:!0},t=n.getContext("webgl2",e);if(t==null)throw new Error("WebGL not supported.");t.memoize=new qk,t.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),t.max3dTextureSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.maxTextureImageUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.tempTextureUnit=t.maxTextureImageUnits-1;for(const r of["EXT_color_buffer_float"])if(!t.getExtension(r))throw new Error(`${r} extension not available`);for(const r of["EXT_float_blend"])t.getExtension(r);return t}class Sv{constructor(){this.width=0,this.height=0,this.logicalWidth=0,this.logicalHeight=0,this.visibleLeftFraction=0,this.visibleTopFraction=0,this.visibleWidthFraction=0,this.visibleHeightFraction=0}}function Yk(n,e){const t=1/n.visibleWidthFraction,r=1/n.visibleHeightFraction,i=-1-(-1+2*n.visibleLeftFraction)*t;let s=-1-(-1+2*n.visibleTopFraction)*r;s=-s,e[0]=e[0]*t+e[3]*i,e[4]=e[4]*t+e[7]*i,e[8]=e[8]*t+e[11]*i,e[12]=e[12]*t+e[15]*i,e[1]=e[1]*r+e[3]*s,e[5]=e[5]*r+e[7]*s,e[9]=e[9]*r+e[11]*s,e[13]=e[13]*r+e[15]*s}function Xk(n,e){return n.width===e.width&&n.height===e.height&&n.logicalWidth===e.logicalWidth&&n.logicalHeight===e.logicalHeight&&n.visibleLeftFraction===e.visibleLeftFraction&&n.visibleTopFraction===e.visibleTopFraction}class Kk extends K{constructor(e,t,r){super(),this.context=e,this.element=t,this.visibility=r,this.boundsGeneration=-1,this.canvasRelativeClippedLeft=0,this.canvasRelativeClippedTop=0,this.canvasRelativeLogicalLeft=0,this.canvasRelativeLogicalTop=0,this.renderViewport=new Sv,this.boundsObserversRegistered=!1,this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){const e=this.context;e.ensureBoundsUpdated();const t=e.boundsGeneration;if(t===this.boundsGeneration)return;this.boundsGeneration=t;const r=this.element;!this.boundsObserversRegistered&&e.monitorPanel(r)&&(this.boundsObserversRegistered=!0);const i=r.getBoundingClientRect(),s=e.container,a=e.canvasRect,l=e.canvas,c=l.width,u=l.height,h=c/a.width,g=u/a.height,v=a.left,y=a.top;let C=this.canvasRelativeLogicalLeft=Math.round((i.left-v)*h+r.clientLeft),S=this.canvasRelativeLogicalTop=Math.round((i.top-y)*g+r.clientTop),w=r.clientWidth,E=r.clientHeight,k=C+w,P=S+E,D=S,L=C,R=k,M=P;for(let H=r.parentElement;H!==null&&H!==s;H=H.parentElement){const U=H.getBoundingClientRect();U.x===0&&U.y===0&&U.width===0&&U.height===0||(L=Math.max(L,(U.left-v)*h),D=Math.max(D,(U.top-y)*g),R=Math.min(R,(U.right-v)*h),M=Math.min(M,(U.bottom-y)*g))}D=this.canvasRelativeClippedTop=Math.round(Math.max(D,0)),L=this.canvasRelativeClippedLeft=Math.round(Math.max(L,0)),R=Math.round(Math.min(R,c)),M=Math.round(Math.min(M,u));const V=this.renderViewport,B=V.width=Math.max(0,R-L),_=V.height=Math.max(0,M-D);V.logicalWidth=w,V.logicalHeight=E,V.visibleLeftFraction=(L-C)/w,V.visibleTopFraction=(D-S)/E,V.visibleWidthFraction=B/w,V.visibleHeightFraction=_/E}setGLClippedViewport(){const e=this.gl,t=this.canvasRelativeClippedTop,r=this.canvasRelativeClippedLeft;var i=this.renderViewport;const s=i.width,a=i.height,l=t+a;e.enable(WebGL2RenderingContext.SCISSOR_TEST);let c=this.context.canvas.height-l;e.viewport(r,c,s,a),e.scissor(r,c,s,a)}setGLLogicalViewport(){const e=this.gl;var t=this.renderViewport;const r=t.width,i=t.height,s=t.logicalWidth,a=t.logicalHeight,l=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,l-(this.canvasRelativeLogicalTop+a),s,a),e.scissor(this.canvasRelativeClippedLeft,l-(this.canvasRelativeClippedTop+i),r,i)}disposed(){this.boundsObserversRegistered&&this.context.unmonitorPanel(this.element),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;const e=this.element;return!(e.clientWidth===0||e.clientHeight===0||e.offsetWidth===0||e.offsetHeight===0)}get drawOrder(){return 0}}class Zk extends Kk{constructor(e,t,r){super(e,t,r),this.canvas=document.createElement("canvas"),this.canvasRenderingContext=this.canvas.getContext("2d");const i=this.canvas;t.appendChild(i),t.style.position="relative",i.style.position="absolute",i.style.left="0",i.style.right="0",i.style.top="0",i.style.bottom="0"}draw(){this.drawIndirect();const e=this.renderViewport,t=this.canvas,r=e.logicalWidth,i=e.logicalHeight;t.width=r,t.height=i,this.canvasRenderingContext?.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,r,i,0,0,r,i)}}class iO extends Jt{constructor(){super(Float64Array.of(0,0,1,1),e=>it(new Float64Array(4),e,vk))}toJSON(){const e=this.value;var t=ae(e,4);const r=t[0],i=t[1],s=t[2],a=t[3];if(!(r===0&&i==0&&s===1&&a===1))return Te(e)}}class sO extends K{constructor(e){super(),this.container=e,this.canvas=document.createElement("canvas"),this.updateStarted=new we,this.updateFinished=new we,this.changed=this.updateFinished,this.panels=new ze,this.resizeGeneration=0,this.boundsGeneration=-1,this.orderedPanels=[],this.frameNumber=0,this.panelAncestors=new de,this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()},this.resizeObserver=new ResizeObserver(this.resizeCallback),this.scheduleRedraw=this.registerCancellable(ct(()=>this.draw()));const t=this.canvas,r=this.resizeObserver;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",r.observe(t),e.appendChild(t),this.registerEventListener(t,"webglcontextlost",i=>{console.log(`Lost WebGL context: ${i.statusMessage}`),i.preventDefault()}),this.registerEventListener(t,"webglcontextrestored",()=>{console.log("WebGL context restored"),window.location.reload()}),this.gl=rO(t)}monitorPanel(e){const t=this.panelAncestors,r=this.container;if(!r.contains(e))return!1;for(;e!==r;){let i=t.get(e);if(i!==void 0){++i.count;break}const s=e.parentElement;i={parent:s,count:1},t.set(e,i),e.addEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.observe(e),e=s}return!0}unmonitorPanel(e){const t=this.panelAncestors,r=this.container;for(;e!==r;){const i=t.get(e);if(i.count!==1){--i.count;break}e.removeEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.unobserve(e),t.delete(e),e=i.parent}}applyWindowedViewportToElement(e,t){var r=ae(t,4);const i=r[0],s=r[1],a=r[2],l=r[3],c=1/a,u=1/l;e.style.position="absolute",e.style.top=`${-u*s*100}%`,e.style.left=`${-c*i*100}%`,e.style.width=`${c*100}%`,e.style.height=`${u*100}%`,++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(const e of this.panels)if(e.visible&&!e.isReady())return!1;return!0}makeCanvasOverlayElement(){const e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}ensureBoundsUpdated(){const e=this.resizeGeneration;if(this.boundsGeneration===e)return;const t=this.canvas;t.width=t.offsetWidth,t.height=t.offsetHeight,this.canvasRect=t.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();let e=this.gl;this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const t=this.orderedPanels,r=this.panels;t.length!==r.size&&(t.push(...r),t.sort((i,s)=>i.drawOrder-s.drawOrder));for(const i of t){if(!i.shouldDraw)continue;i.ensureBoundsUpdated();const s=i.renderViewport;s.width===0||s.height===0||i.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch()}getDepthArray(){var e=this.canvas;const t=e.width,r=e.height,i=new Float32Array(t*r);for(const a of this.panels){if(!a.shouldDraw)continue;const l=a.getDepthArray();if(l===void 0)continue;const c=a.canvasRelativeClippedTop,u=a.canvasRelativeClippedLeft;var s=a.renderViewport;const h=s.width,g=s.height;for(let v=0;v<g;++v){const y=(g-1-v)*h;i.set(l.subarray(y,y+h),(c+v)*h+u)}}return i}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Qk extends Sv{constructor(){super(...arguments),this.globalPosition=co,this.projectionMat=Je(),this.viewMatrix=Je(),this.invViewMatrix=Je(),this.viewProjectionMat=Je(),this.invViewProjectionMat=Je()}}function aO(n,e){return n.displayDimensionRenderInfo===e.displayDimensionRenderInfo&&Xk(n,e)&&Oe(n.globalPosition,e.globalPosition)&&Oe(n.projectionMat,e.projectionMat)&&Oe(n.viewMatrix,e.viewMatrix)}function eL(n){const e=n.viewMatrix,t=n.viewProjectionMat;fs(e,n.invViewMatrix),en(t,n.projectionMat,e),fs(n.invViewProjectionMat,t)}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const oO="rendered_view.addLayer",lO="rendered_view.removeLayer",dO="SharedProjectionParameters",cO="SharedProjectionParameters.changed";var Kr;(function(n){n[n.info=0]="info",n[n.warning=1]="warning",n[n.error=2]="error"})(Kr||(Kr={}));class Vo{constructor(){this.changed=new we,this.messages=[],this.children=[]}addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){const e=this.messages;e.length!==0&&(e.length=0,this.changed.dispatch())}isEmpty(){return this.messages.length===0&&!this.children.some(e=>!e.isEmpty())}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),e.isEmpty()||this.changed.dispatch(),()=>{const t=this.children;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),e.isEmpty()||this.changed.dispatch()}}*[An](){yield*this.messages;for(const e of this.children)yield*e}}var SC={},vf,CC;function tL(){if(CC)return vf;CC=1;var n=Ro(),e=Hu(),t=Vi()("species");return vf=function(r,i){var s=n(r).constructor,a;return s===void 0||(a=n(s)[t])==null?i:e(a)},vf}var xC,EC;function uO(){return EC||(EC=1,xC=function(n,e,t){var r=t===void 0;switch(e.length){case 0:return r?n():n.call(t);case 1:return r?n(e[0]):n.call(t,e[0]);case 2:return r?n(e[0],e[1]):n.call(t,e[0],e[1]);case 3:return r?n(e[0],e[1],e[2]):n.call(t,e[0],e[1],e[2]);case 4:return r?n(e[0],e[1],e[2],e[3]):n.call(t,e[0],e[1],e[2],e[3])}return n.apply(t,e)}),xC}var yf,TC;function nL(){if(TC)return yf;TC=1;var n=sa(),e=uO(),t=mA(),r=vA(),i=Ni(),s=i.process,a=i.setImmediate,l=i.clearImmediate,c=i.MessageChannel,u=i.Dispatch,h=0,g={},v="onreadystatechange",y,C,S,w=function(){var k=+this;if(g.hasOwnProperty(k)){var P=g[k];delete g[k],P()}},E=function(k){w.call(k.data)};return(!a||!l)&&(a=function(k){for(var P=[],D=1;arguments.length>D;)P.push(arguments[D++]);return g[++h]=function(){e(typeof k=="function"?k:Function(k),P)},y(h),h},l=function(k){delete g[k]},Km()(s)=="process"?y=function(k){s.nextTick(n(w,k,1))}:u&&u.now?y=function(k){u.now(n(w,k,1))}:c?(C=new c,S=C.port2,C.port1.onmessage=E,y=n(S.postMessage,S,1)):i.addEventListener&&typeof postMessage=="function"&&!i.importScripts?(y=function(k){i.postMessage(k+"","*")},i.addEventListener("message",E,!1)):v in r("script")?y=function(k){t.appendChild(r("script"))[v]=function(){t.removeChild(this),w.call(k)}}:y=function(k){setTimeout(n(w,k,1),0)}),yf={set:a,clear:l},yf}var bf,kC;function hO(){if(kC)return bf;kC=1;var n=Ni(),e=nL().set,t=n.MutationObserver||n.WebKitMutationObserver,r=n.process,i=n.Promise,s=Km()(r)=="process";return bf=function(){var a,l,c,u=function(){var y,C;for(s&&(y=r.domain)&&y.exit();a;){C=a.fn,a=a.next;try{C()}catch(S){throw a?c():l=void 0,S}}l=void 0,y&&y.enter()};if(s)c=function(){r.nextTick(u)};else if(t&&!(n.navigator&&n.navigator.standalone)){var h=!0,g=document.createTextNode("");new t(u).observe(g,{characterData:!0}),c=function(){g.data=h=!h}}else if(i&&i.resolve){var v=i.resolve(void 0);c=function(){v.then(u)}}else c=function(){e.call(n,u)};return function(y){var C={fn:y,next:void 0};l&&(l.next=C),a||(a=C,c()),l=C}},bf}var wf={},LC;function Cv(){if(LC)return wf;LC=1;var n=Hu();function e(t){var r,i;this.promise=new t(function(s,a){if(r!==void 0||i!==void 0)throw TypeError("Bad Promise constructor");r=s,i=a}),this.resolve=n(r),this.reject=n(i)}return wf.f=function(t){return new e(t)},wf}var IC,DC;function rL(){return DC||(DC=1,IC=function(n){try{return{e:!1,v:n()}}catch(e){return{e:!0,v:e}}}),IC}var Sf,PC;function pO(){if(PC)return Sf;PC=1;var n=Ni(),e=n.navigator;return Sf=e&&e.userAgent||"",Sf}var Cf,RC;function iL(){if(RC)return Cf;RC=1;var n=Ro(),e=Cs(),t=Cv();return Cf=function(r,i){if(n(r),e(i)&&i.constructor===r)return i;var s=t.f(r),a=s.resolve;return a(i),s.promise},Cf}var MC;function fO(){if(MC)return SC;MC=1;var n=fA(),e=Ni(),t=sa(),r=Ju(),i=Ot(),s=Cs(),a=Hu(),l=Xu(),c=Mo(),u=tL(),h=nL().set,g=hO()(),v=Cv(),y=rL(),C=pO(),S=iL(),w="Promise",E=e.TypeError,k=e.process,P=k&&k.versions,D=P&&P.v8||"",L=e[w],R=r(k)=="process",M=function(){},V,B,_,H,U=B=v.f,O=!!(function(){try{var ne=L.resolve(1),he=(ne.constructor={})[Vi()("species")]=function(Le){Le(M,M)};return(R||typeof PromiseRejectionEvent=="function")&&ne.then(M)instanceof he&&D.indexOf("6.6")!==0&&C.indexOf("Chrome/66")===-1}catch{}})(),z=function(ne){var he;return s(ne)&&typeof(he=ne.then)=="function"?he:!1},F=function(ne,he){if(!ne._n){ne._n=!0;var Le=ne._c;g(function(){for(var _e=ne._v,Ge=ne._s==1,De=0,Ee=function(Me){var Fe=Ge?Me.ok:Me.fail,Ue=Me.resolve,Ce=Me.reject,Ye=Me.domain,_t,Yt,bn;try{Fe?(Ge||(ne._h==2&&Re(ne),ne._h=1),Fe===!0?_t=_e:(Ye&&Ye.enter(),_t=Fe(_e),Ye&&(Ye.exit(),bn=!0)),_t===Me.promise?Ce(E("Promise-chain cycle")):(Yt=z(_t))?Yt.call(_t,Ue,Ce):Ue(_t)):Ce(_e)}catch(Xt){Ye&&!bn&&Ye.exit(),Ce(Xt)}};Le.length>De;)Ee(Le[De++]);ne._c=[],ne._n=!1,he&&!ne._h&&se(ne)})}},se=function(ne){h.call(e,function(){var he=ne._v,Le=oe(ne),_e,Ge,De;if(Le&&(_e=y(function(){R?k.emit("unhandledRejection",he,ne):(Ge=e.onunhandledrejection)?Ge({promise:ne,reason:he}):(De=e.console)&&De.error&&De.error("Unhandled promise rejection",he)}),ne._h=R||oe(ne)?2:1),ne._a=void 0,Le&&_e.e)throw _e.v})},oe=function(ne){return ne._h!==1&&(ne._a||ne._c).length===0},Re=function(ne){h.call(e,function(){var he;R?k.emit("rejectionHandled",ne):(he=e.onrejectionhandled)&&he({promise:ne,reason:ne._v})})},le=function(ne){var he=this;he._d||(he._d=!0,he=he._w||he,he._v=ne,he._s=2,he._a||(he._a=he._c.slice()),F(he,!0))},Se=function(ne){var he=this,Le;if(!he._d){he._d=!0,he=he._w||he;try{if(he===ne)throw E("Promise can't be resolved itself");(Le=z(ne))?g(function(){var _e={_w:he,_d:!1};try{Le.call(ne,t(Se,_e,1),t(le,_e,1))}catch(Ge){le.call(_e,Ge)}}):(he._v=ne,he._s=1,F(he,!1))}catch(_e){le.call({_w:he,_d:!1},_e)}}};return O||(L=function(ne){l(this,L,w,"_h"),a(ne),V.call(this);try{ne(t(Se,this,1),t(le,this,1))}catch(he){le.call(this,he)}},V=function(ne){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},V.prototype=Yu()(L.prototype,{then:function(ne,he){var Le=U(u(this,L));return Le.ok=typeof ne=="function"?ne:!0,Le.fail=typeof he=="function"&&he,Le.domain=R?k.domain:void 0,this._c.push(Le),this._a&&this._a.push(Le),this._s&&F(this,!1),Le.promise},catch:function(ne){return this.then(void 0,ne)}}),_=function(){var ne=new V;this.promise=ne,this.resolve=t(Se,ne,1),this.reject=t(le,ne,1)},v.f=U=function(ne){return ne===L||ne===H?new _(ne):B(ne)}),i(i.G+i.W+i.F*!O,{Promise:L}),RT()(L,w),BT()(w),H=ut()[w],i(i.S+i.F*!O,w,{reject:function(ne){var he=U(this),Le=he.reject;return Le(ne),he.promise}}),i(i.S+i.F*(n||!O),w,{resolve:function(ne){return S(n&&this===H?L:this,ne)}}),i(i.S+i.F*!(O&&UT()(function(ne){L.all(ne).catch(M)})),w,{all:function(ne){var he=this,Le=U(he),_e=Le.resolve,Ge=Le.reject,De=y(function(){var Ee=[],Me=0,Fe=1;c(ne,!1,function(Ue){var Ce=Me++,Ye=!1;Ee.push(void 0),Fe++,he.resolve(Ue).then(function(_t){Ye||(Ye=!0,Ee[Ce]=_t,--Fe||_e(Ee))},Ge)}),--Fe||_e(Ee)});return De.e&&Ge(De.v),Le.promise},race:function(ne){var he=this,Le=U(he),_e=Le.reject,Ge=y(function(){c(ne,!1,function(De){he.resolve(De).then(Le.resolve,_e)})});return Ge.e&&_e(Ge.v),Le.promise}}),SC}var AC={},NC;function gO(){if(NC)return AC;NC=1;var n=Ot(),e=ut(),t=Ni(),r=tL(),i=iL();return n(n.P+n.R,"Promise",{finally:function(s){var a=r(this,e.Promise||t.Promise),l=typeof s=="function";return this.then(l?function(c){return i(a,s()).then(function(){return c})}:s,l?function(c){return i(a,s()).then(function(){throw c})}:s)}}),AC}var VC={},OC;function mO(){if(OC)return VC;OC=1;var n=Ot(),e=Cv(),t=rL();return n(n.S,"Promise",{try:function(r){var i=e.f(this),s=t(r);return(s.e?i.reject:i.resolve)(s.v),i.promise}}),VC}var BC,FC;function vO(){return FC||(FC=1,Po(),ia(),fO(),gO(),mO(),BC=ut().Promise),BC}var _C,UC;function yO(){return UC||(UC=1,_C={default:vO(),__esModule:!0}),_C}var bO=yO();const xt=Qe(bO);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wO{constructor(){this.name="CancellationError",this.message="CANCELED"}toString(){return"CANCELED"}}const ms=new wO;function SO(n){if(n.isCanceled===!0)throw ms}const Dg=()=>{},Vt={isCanceled:!1,add:()=>Dg,remove:Dg};class Es{cancel(){const e=this.handlers;if(e!==null&&(this.handlers=null,e!==void 0))for(let t of e)t()}get isCanceled(){return this.handlers===null}add(e){let t=this.handlers;return t===null?(e(),Dg):(t===void 0&&(t=this.handlers=new ze),t.add(e),()=>{this.remove(e)})}remove(e){this.handlers?.delete(e)}}class CO extends Es{constructor(){super(...arguments),this.consumers=new ze}addConsumer(e=Vt){const t=this.consumers;t.has(e)||e.isCanceled||(t.add(e),e.add(()=>{t.delete(e),t.size===0&&this.cancel()}))}}function xO(n,e){return new xt((t,r)=>{if(n===Vt){e(t,r,Vt);return}const i=new Es,s=n.add(()=>{i.cancel()});e(a=>{s(),t(a)},a=>{s(),r(a)},i)})}const sL=!(typeof Window<"u"&&self instanceof Window),Pg="rpc.promise.response",aL="rpc.promise.cancel";var oL=new de;function Tt(n,e){oL.set(n,e)}class EO extends Error{constructor(e,t){super(t),this.name=e,this.message=t}}function lL(n,e){Tt(n,function(t){let r=t.id;const i=new Es;let s=e.call(this,t,i);this.set(r,{promise:s,cancellationToken:i}),s.then(({value:a,transfers:l})=>{this.delete(r),this.invoke(Pg,{id:r,value:a},l)},a=>{this.delete(r),this.invoke(Pg,{id:r,error:a.message,errorName:a.name})})})}Tt(aL,function(n){let e=n.id;const t=this.get(e);t!==void 0&&t.cancellationToken.cancel()});Tt(Pg,function(n){let e=n.id;var t=this.get(e);let r=t.resolve,i=t.reject;this.delete(e),n.hasOwnProperty("value")?r(n.value):n.errorName===ms.name?i(ms):i(new EO(n.errorName,n.error))});const TO=sL?-1:0;class kO{constructor(e){this.target=e,this.objects=new de,this.nextId=TO,e.onmessage=t=>{let r=t.data;oL.get(r.functionName).call(this,r)}}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}getOptionalRef(e){if(e===void 0)return;let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}invoke(e,t,r){t.functionName=e,this.target.postMessage(t,r)}promiseInvoke(e,t,r=Vt,i){return xO(r,(s,a,l)=>{const c=t.id=this.newId();this.set(c,{resolve:s,reject:a}),this.invoke(e,t,i),l.add(()=>{this.invoke(aL,{id:c})})})}newId(){return sL?this.nextId--:this.nextId++}}class ei extends K{constructor(){super(...arguments),this.rpc=null,this.rpcId=null}initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){this.isOwner===!0?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():this.isOwner===!1?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){let e=this.rpc,t=this.rpcId;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,this.refCount===0&&e===this.referencedGeneration&&this.ownerDispose()}}function LO(n,e,t={}){e!=null&&n.initializeSharedObject(e,t.id)}class sh extends ei{constructor(e,t={}){super(),LO(this,e,t)}}Tt("SharedObject.dispose",function(n){let e=this.get(n.id);if(e.refCount!==0)throw new Error("Attempted to dispose object with non-zero reference count.");e.disposed(),this.delete(e.rpcId),e.rpcId=null,e.rpc=null});const IO="Worker";Tt(IO,function(n){const e=n.port,t=n.path;new Worker(t).postMessage({port:e},[e])});Tt("SharedObject.refCountReachedZero",function(n){let e=this.get(n.id),t=n.gen;e.counterpartRefCountReachedZero(t)});const dL=new de;function hr(n){return e=>{e.prototype.RPC_TYPE_ID=n}}function ah(n){return e=>{if(n!==void 0)e.prototype.RPC_TYPE_ID=n;else if(n=e.prototype.RPC_TYPE_ID,n===void 0)throw new Error("RPC_TYPE_ID should have already been defined");dL.set(n,e)}}Tt("SharedObject.new",function(n){let e=this,t=n.type,r=dL.get(t),i=new r(e,n);--i.refCount});/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var DO=function(n,e,t,r){var i=arguments.length,s=i<3?e:r===null?r=Ar(e,t):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,r);else for(var l=n.length-1;l>=0;l--)(a=n[l])&&(s=(i<3?a(s):i>3?a(e,t,s):a(e,t))||s);return i>3&&s&&Mr(e,t,s),s},jc;const cL="SharedWatchableValue.changed";let mn=jc=class extends sh{constructor(n,e={}){super(n,e),this.updatingValue_=!1,n!==void 0&&(this.base=new dt(e.value),this.setupChangedHandler())}initializeCounterpart(n,e={}){e.value=this.value,super.initializeCounterpart(n,e)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{const n=this.rpc;n!==null&&n.invoke(cL,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(n,e){let t=new jc;return t.base=e,t.setupChangedHandler(),t.initializeCounterpart(n),t}static make(n,e){return jc.makeFromExisting(n,new dt(e))}get value(){return this.base.value}set value(n){this.base.value=n}get changed(){return this.base.changed}};mn=jc=DO([ah("SharedWatchableValue")],mn);Tt(cL,function(n){const e=this.get(n.id);e.updatingValue_=!0,e.base.value=n.value,e.updatingValue_=!1});class Nt extends dt{constructor(e=Number.NEGATIVE_INFINITY){super(e)}get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}}Nt.VISIBLE=Number.POSITIVE_INFINITY;Nt.IGNORED=Number.NEGATIVE_INFINITY;class Xl extends Nt{constructor(){super(...arguments),this.contributors=new de}add(e){const t=this.contributors,r=e.changed.add(()=>{this.update()}),i=()=>{t.delete(i),r(),this.update()};return t.set(i,e),this.update(),i}update(){let e=Number.NEGATIVE_INFINITY;for(const t of this.contributors.values())e=Math.max(e,t.value);this.value=e}}function oh(n){return class extends n{constructor(){super(...arguments),this.visibility=new Xl}initializeCounterpart(e,t={}){t.visibility=this.registerDisposer(mn.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var PO=function(n,e,t,r){var i=arguments.length,s=i<3?e:r===null?r=Ar(e,t):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,r);else for(var l=n.length-1;l>=0;l--)(a=n[l])&&(s=(i<3?a(s):i>3?a(e,t,s):a(e,t))||s);return i>3&&s&&Mr(e,t,s),s},RO=function(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof fC=="function")for(var i=0,r=fC(n);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(n,r[i])&&(t[r[i]]=n[r[i]]);return t},ur;(function(n){n[n.DATA=0]="DATA",n[n.ANNOTATION=1]="ANNOTATION",n[n.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION"})(ur||(ur={}));function MO(){return new TN([ur.DATA,ur.ANNOTATION,ur.DEFAULT_ANNOTATION])}class uL extends K{constructor(){super(...arguments),this.role=ur.DATA,this.messages=new Vo,this.layerChanged=new we,this.redrawNeeded=new we,this.layerChunkProgressInfo=new wv}handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,r,i){}}class hL extends uL{constructor(){super(...arguments),this.visibility=new Xl}attach(e){}}function hu(n,e,t){let r=t.state;if(r===void 0||r.transform!==n||r.displayDimensionRenderInfo!==e){if(t.messages.clearMessages(),r=t.state={transform:n,displayDimensionRenderInfo:e,modelTransform:void 0},n.error!==void 0){t.messages.addMessage({severity:Kr.error,message:n.error});return}try{const i=Je();G3(i,e,n),r.modelTransform=i}catch(i){t.messages.addMessage({severity:Kr.error,message:i.message})}}return r.modelTransform}class pL extends K{constructor(e){super(),this.renderViewport=new Sv,this.changed=new Ze;var t=e.parametersConstructor;const r=t===void 0?Qk:t,i=e.navigationState,s=e.update;var a=e.isEqual;const l=a===void 0?aO:a;this.oldValue_=new r,this.value_=new r;const c=()=>{const h=this.oldValue_,g=this.value_;h.displayDimensionRenderInfo=i.displayDimensionRenderInfo.value,j(h,this.renderViewport);let v=h.globalPosition;const y=i.position.value,C=y.length;v.length!==C&&(h.globalPosition=v=new Float32Array(C)),v.set(y),s(h,i),!l(h,g)&&(this.value_=h,this.oldValue_=g,this.changed.dispatch(g,h))},u=this.update=this.registerCancellable(rt(c,0));this.registerDisposer(i.changed.add(u)),c()}setViewport(e){Xk(e,this.renderViewport)||(j(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}}let pu=class extends ei{constructor(n,e,t=10){super(),this.base=e,this.updateInterval=t,this.prevDisplayDimensionRenderInfo=void 0,this.update=this.registerCancellable(rt((r,i)=>{let s;i.displayDimensionRenderInfo!==this.prevDisplayDimensionRenderInfo?(s=i,this.prevDisplayDimensionRenderInfo=i.displayDimensionRenderInfo):(i.displayDimensionRenderInfo,s=RO(i,["displayDimensionRenderInfo"])),this.rpc.invoke(cO,{id:this.rpcId,value:s})},this.updateInterval)),this.initializeCounterpart(n,{value:e.value}),this.registerDisposer(e.changed.add(this.update))}flush(){this.update.flush()}};pu=PO([hr(dO)],pu);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ft{constructor(e,t=e){this.value_=e,this.defaultValue=t,this.changed=new we}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}toJSON(){if(this.value_!==this.defaultValue)return this.value_}restoreState(e){if(e===!0||e===!1){this.value=e;return}this.value=this.defaultValue}reset(){this.value=this.defaultValue}}class Ts extends K{constructor(e,t={}){super(),this.model=e,this.element=document.createElement("input");let r=this.element;r.type="checkbox";const i=()=>{var s;const a=this.model.value;this.element.checked=a,(t.enableTitle!==void 0||t.disableTitle!==void 0)&&(this.element.title=(s=a?t.enableTitle:t.disableTitle)!==null&&s!==void 0?s:"")};this.registerDisposer(e.changed.add(i)),i(),this.registerEventListener(r,"change",function(s){e.value=this.checked}),r.addEventListener("mousedown",s=>{s.preventDefault()})}disposed(){let e=this.element,t=e.parentElement;t&&t.removeChild(e),super.disposed()}}class tr extends K{constructor(e,t){super(),this.model=e,this.element=t,this.initialDisplay=this.element.style.display,this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable(rt(()=>this.updateVisibility(),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function fL(n){try{return n()}catch(e){return{error:e.message}}}function AO(n){if(n.error!==void 0)throw new Error(n.error);return n}class xv extends K{constructor(e,t){if(super(),this.register=e,this.changed=new we,this.disposerMap=new de,t===void 0)this.map=new de;else{const i=this.map=new de(t),s=this.disposerMap;for(const a of i){var r=ae(a,2);const l=r[0],c=r[1],u=new K;s.set(l,u),e(u,c,l)}}}get value(){return this.map}set(e,t){const r=this.map,i=this.disposerMap;let s=i.get(e);return s!==void 0&&s.dispose(),s=new K,i.set(e,s),r.set(e,t),this.register(s,t,e),this.changed.dispatch(),this}delete(e){const t=this.map,r=this.disposerMap,i=r.get(e);return i!==void 0?(i.dispose(),r.delete(e),t.delete(e),this.changed.dispatch(),!0):!1}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[An](){return ev(this.map)}clear(){const e=this.map,t=this.disposerMap;if(e.size>0){for(const r of t.values())r.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){const e=this.map,t=this.disposerMap;for(const r of t.values())r.dispose();e.clear(),t.clear(),super.disposed()}}var NO=tA();const Xn=Qe(NO);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $C=Xn("objectId");let VO=0;function ln(n){if(n instanceof Object){let e=n[$C];return e===void 0&&(e=n[$C]=VO++),`o${e}`}else return""+ie(n)}var Rg;(function(n){n[n.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",n[n.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT"})(Rg||(Rg={}));function OO(n){n=n.replace("\0","");let e=[];for(let t of n.split(`
`)){let r=t.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);r!==null?e.push({message:r[3].trim(),file:parseInt(r[1],10),line:parseInt(r[2],10)}):(r=t.match(/^ERROR:\s*(.+)$/),r!==null?e.push({message:r[1]}):(t=t.trim(),t&&e.push({message:t})))}return e}class BO extends Error{constructor(e,t,r,i){const s=`Error compiling ${Rg[e].toLowerCase()} shader: ${r}`;super(s),this.name="ShaderCompilationError",this.log=r,this.message=s,this.shaderType=e,this.source=t,this.errorMessages=i}}class FO extends Error{constructor(e,t,r){const i=`Error linking shader: ${r}`;super(i),this.name="ShaderLinkError",this.log=r,this.message=i,this.vertexSource=e,this.fragmentSource=t}}function zC(n,e,t){var r=n.createShader(t);if(n.shaderSource(r,e),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){let i=n.getShaderInfoLog(r)||"";throw new BO(t,e,i,OO(i))}return r}class _O extends K{constructor(e,t,r,i,s,a){super(),this.gl=e,this.vertexSource=t,this.fragmentSource=r,this.attributes=new de,this.uniforms=new de,this.vertexShaderInputBinders={};let l=this.vertexShader=zC(e,t,e.VERTEX_SHADER),c=this.fragmentShader=zC(e,r,e.FRAGMENT_SHADER),u=e.createProgram();if(e.attachShader(u,l),e.attachShader(u,c),e.linkProgram(u),!e.getProgramParameter(u,e.LINK_STATUS)){let v=e.getProgramInfoLog(u)||"";throw new FO(t,r,v)}this.program=u;let h=this.uniforms,g=this.attributes;if(i)for(let v of i)h.set(v,e.getUniformLocation(u,v));if(s)for(let v of s)g.set(v,e.getAttribLocation(u,v))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){this.gl.useProgram(this.program)}disposed(){let e=this.gl;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0}}function UO(n,e,t,r,i){n.drawArraysInstanced(e,t,r,i)}class GC{constructor(){this.code="",this.parts=new ze}add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(Array.isArray(e))for(let t of e)this.add(t);else throw console.log("Invalid code type",e),new Error("Invalid code type")}}toString(){return this.code}}const Mg={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D};class ea{constructor(e){this.gl=e,this.nextSymbolID=0,this.nextTextureUnit=0,this.uniformsCode="",this.attributesCode="",this.varyingsCodeVS="",this.varyingsCodeFS="",this.fragmentExtensionsSet=new ze,this.fragmentExtensions="",this.vertexCode=new GC,this.vertexMain="",this.fragmentCode=new GC,this.outputBufferCode="",this.fragmentMain="",this.required=new ze,this.uniforms=new Array,this.attributes=new Array,this.initializers=[],this.textureUnits=new de,this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e,t=1){if(this.textureUnits.has(e))throw new Error("Duplicate texture unit symbol: "+e.toString());let r=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,r),r}addTextureSampler(e,t,r,i){let s=this.allocateTextureUnit(r,i);return this.addUniform(`highp ${e}`,t,i),this.addInitializer(a=>{if(i){let l=new Int32Array(i);for(let c=0;c<i;++c)l[c]=c+s;a.gl.uniform1iv(a.uniform(t),l)}else a.gl.uniform1i(a.uniform(t),s)}),s}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,r){return this.attributes.push(t),r!==void 0&&(this.attributesCode+=`layout(location = ${r})`),this.attributesCode+=`in ${e} ${t};
`,t}addVarying(e,t,r=""){this.varyingsCodeVS+=`${r} out ${e} ${t};
`,this.varyingsCodeFS+=`${r} in ${e} ${t};
`}addOutputBuffer(e,t,r){r!==null&&(this.outputBufferCode+=`layout(location = ${r}) `),this.outputBufferCode+=`out ${e} ${t};
`}addUniform(e,t,r){return this.uniforms.push(t),r!=null?this.uniformsCode+=`uniform ${e} ${t}[${r}];
`:this.uniformsCode+=`uniform ${e} ${t};
`,t}addFragmentExtension(e){this.fragmentExtensionsSet.has(e)||(this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require
`)}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {
${e}
}
`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){this.required.has(e)||(this.required.add(e),e(this))}build(){let e=`#version 300 es
precision highp float;
precision highp int;
${this.uniformsCode}
${this.attributesCode}
${this.varyingsCodeVS}
${this.vertexCode}
void main() {
${this.vertexMain}
}
`,t=`#version 300 es
${this.fragmentExtensions}
precision highp float;
precision highp int;
${this.uniformsCode}
${this.varyingsCodeFS}
${this.outputBufferCode}
${this.fragmentCode}
${this.fragmentMain}
`,r=new _O(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);r.textureUnits=this.textureUnits;let i=this.initializers;if(i.length>0){r.bind();for(let s of i)s(r)}return r}}function lh(){return new dt(void 0)}function Ev(n){return new Jt(n,ke)}function Tv(n,e,t){const r=new de,i=t.parameters,s=t.fallbackParameters,a=t.shaderError;var l=t.encodeParameters;const c=l===void 0?D=>D:l;var u=t.extraParameters;const h=u===void 0?Zs(void 0):u;var g=t.encodeExtraParameters;const v=g===void 0?D=>D:g,y=t.getContextKey,C=t.defineShader;a!==void 0&&(a.value=void 0);var S=t.encodeContext;const w=S===void 0?y:S,E=lr(t.memoizeKey);function k(D,L,R){const M=ie({id:E,context:w(D),parameters:c(L),extraParameters:v(R)});return e.memoize.get(M,()=>{const V=new ea(e);return C(V,D,L,R),V.build()})}function P(D){const L=y(D);let R=r.get(L);R===void 0&&(R={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:i.value,extraParameters:h.value},r.set(L,R));const M=i.changed.count,V=h.changed.count;if(M===R.parametersGeneration&&V===R.extraParametersGeneration)return R;const B=R.parameters=i.value,_=R.extraParameters=h.value,H=R.shader;R.parametersGeneration=M,R.extraParametersGeneration=V;let U=null;try{U=k(D,B,_),R.fallback=!1,s!==void 0&&(s.value=B),a!==void 0&&(a.value=null)}catch(O){if(a!==void 0&&(a.value=O),s!==void 0)try{const z=s.value;U=k(D,z,_),R.parameters=z,R.fallback=!0}catch{}}return H!==null&&H.dispose(),R.shader=U,R}return n.registerDisposer(()=>{for(const D of r.values()){const L=D.shader;L!==null&&L.dispose()}}),P}function ho(n,e,t){return Tv(n,e,j(j({},t),{getContextKey:r=>r,encodeContext:r=>ln(r),defineShader:(r,i,s,a)=>(r.require(i),t.defineShader(r,s,a))}))}function Kl(n,e=1,t=0){return`
#line ${t} ${e}
`+n}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $n{constructor(e,t=WebGL2RenderingContext.ARRAY_BUFFER){this.gl=e,this.bufferType=t,this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t,r=WebGL2RenderingContext.FLOAT,i=!1,s=0,a=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,r,i,s,a)}bindToVertexAttribI(e,t,r=WebGL2RenderingContext.UNSIGNED_INT,i=0,s=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,r,i,s)}setData(e,t=WebGL2RenderingContext.STATIC_DRAW){let r=this.gl;this.bind(),r.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,r,i){let s=new $n(e,r);return s.setData(t,i),s}}function Zl(n,e,t,...r){return n.memoize.get(lr({id:"getMemoizedBuffer",getter:ln(t),args:r}),()=>{const i=new jT($n.fromData(n,t(...r),e,WebGL2RenderingContext.STATIC_DRAW));return i.registerDisposer(i.value),i})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function $O(n=-1,e=-1,t=1,r=1,i=1,s=1){return og(new Float32Array([n,e,n,r,t,r,t,e]),2,i,s)}function Ql(n,e=-1,t=-1,r=1,i=1,s=1,a=1){return Zl(n,WebGL2RenderingContext.ARRAY_BUFFER,$O,e,t,r,i,s,a).value}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function po(n){n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function zO(n){n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE)}function GO(n,e,t,r,i=WebGL2RenderingContext.RGBA8,s=WebGL2RenderingContext.RGBA,a=WebGL2RenderingContext.UNSIGNED_BYTE){n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),po(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,i,t,r,0,s,a,null),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function WO(n,e,t){n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),n.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),n.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,t),n.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function gL(n){n.addOutputBuffer("vec4","v4f_fragColor",null),n.setFragmentMain("v4f_fragColor = getValue0();")}function jO(n,e=gL,t=1){return n.memoize.get(`elementWiseTextureShader:${t}:${ln(e)}`,()=>{let r=new ea(n);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler",t),r.addInitializer(i=>{let s=[];for(let a=0;a<t;++a)s[a]=a;n.uniform1iv(i.uniform("uSampler"),s)});for(let i=0;i<t;++i)r.addFragmentCode(`
vec4 getValue${i}() {
  return texture(uSampler[${i}], vTexCoord);
}
`);return r.addUniform("mat4","uProjectionMatrix"),r.require(e),r.addAttribute("vec4","aVertexPosition"),r.addAttribute("vec2","aTexCoord"),r.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),r.build()})}function HO(n){return n.memoize.get("trivialColorShader",()=>{let e=new ea(n);return e.addVarying("vec4","vColor"),e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = vColor;"),e.addAttribute("vec4","aVertexPosition"),e.addAttribute("vec4","aColor"),e.addUniform("mat4","uProjectionMatrix"),e.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),e.build()})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mL extends K{constructor(){super(...arguments),this.width=Number.NaN,this.height=Number.NaN}hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){this.hasSize(e,t)||(this.width=e,this.height=t,this.performResize())}}class qO extends mL{constructor(e,t){super(),this.gl=e,this.internalformat=t,this.renderbuffer=null,this.renderbuffer=e.createRenderbuffer()}performResize(){let e=this.gl;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){let t=this.gl;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}}class JO extends qO{constructor(e,t=!1){super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16),this.gl=e,this.includeStencilBuffer=t}attachToFramebuffer(){let e=this.gl;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}}class YO extends JO{constructor(e){super(e,!0)}}class XO extends K{constructor(e){super(),this.gl=e,this.framebuffer=this.gl.createFramebuffer()}disposed(){this.gl.deleteFramebuffer(this.framebuffer)}bind(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}}class Ys extends mL{constructor(e,t,r,i){super(),this.gl=e,this.internalFormat=t,this.format=r,this.dataType=i,this.texture=e.createTexture()}performResize(){GO(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){let t=this.gl;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}}class KO extends Ys{constructor(e,t=WebGL2RenderingContext.DEPTH_COMPONENT16,r=WebGL2RenderingContext.DEPTH_COMPONENT,i=WebGL2RenderingContext.UNSIGNED_SHORT){super(e,t,r,i)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}}function fu(n,e,t=WebGL2RenderingContext.RGBA8,r=WebGL2RenderingContext.RGBA,i=WebGL2RenderingContext.UNSIGNED_BYTE){let s=new Array;for(let a=0;a<e;++a)s[a]=new Ys(n,t,r,i);return s}class fo extends K{constructor(e,t){super(),this.gl=e,this.width=Number.NaN,this.height=Number.NaN,this.fullAttachmentList=new Array,this.attachmentVerified=!1,this.singleAttachmentList=[this.gl.COLOR_ATTACHMENT0];var r=t.framebuffer;let i=r===void 0?new XO(e):r,s=t.colorBuffers,a=t.depthBuffer;this.framebuffer=this.registerDisposer(i),this.colorBuffers=s,this.depthBuffer=a,a!==void 0&&this.registerDisposer(a);let l=this.fullAttachmentList;s.forEach((c,u)=>{this.registerDisposer(c),l[u]=e.COLOR_ATTACHMENT0+u})}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();let r=this.gl,i=this.depthBuffer;i!==void 0?(i.resize(e,t),i.attachToFramebuffer()):r.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach((s,a)=>{s.resize(e,t),s.attachToFramebuffer(r.COLOR_ATTACHMENT0+a)}),r.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),r.viewport(0,0,e,t)}bindSingle(e){let t=this.gl;this.framebuffer.bind(),e!==0&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,r,i,s=1,a=1){let l=this.gl;try{this.bindSingle(e),l.readPixels(t,r,s,a,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,i)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;let e=this.gl,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}}class go extends K{constructor(e,t){super(),this.gl=e,this.shader=t,this.copyVertexPositionsBuffer=Ql(this.gl),this.copyTexCoordsBuffer=Ql(this.gl,0,0,1,1),this.registerDisposer(t)}draw(...e){let t=this.gl,r=this.shader;r.bind();let i=e.length;for(let l=0;l<i;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,e[l]);t.uniformMatrix4fv(r.uniform("uProjectionMatrix"),!1,sk);let s=r.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(s,2);let a=r.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(a,2),t.drawArrays(t.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(s),t.disableVertexAttribArray(a);for(let l=0;l<i;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,null)}static get(e,t=gL,r=1){return e.memoize.get(`OffscreenCopyHelper:${r}:${ln(t)}`,()=>new go(e,jO(e,t,r)))}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ZO=`
float mixLinear(float x, float y, float a) { return mix(x, y, a); }
`;var QO=`
vec3 hueToRgb(float hue) {
  float hue6 = hue * 6.0;
  float r = abs(hue6 - 3.0) - 1.0;
  float g = 2.0 - abs(hue6 - 2.0);
  float b = 2.0 - abs(hue6 - 4.0);
  return clamp(vec3(r, g, b), 0.0, 1.0);
}
vec3 hsvToRgb(vec3 c) {
  vec3 hueRgb = hueToRgb(c.x);
  return c.z * ((hueRgb - 1.0) * c.y + 1.0);
}
`;const It=`
struct uint64_t {
  highp uvec2 value;
};
struct uint64x2_t {
  highp uvec4 value;
};
uint64_t mixLinear(uint64_t x, uint64_t y, float a) {
  return x;
}
uint64_t toUint64(uint64_t x) { return x; }
`,eB=[It,`
uint64_t unpackUint64leFromUint32(highp uvec2 x) {
  uint64_t result;
  result.value = x;
  return result;
}
uint64x2_t unpackUint64leFromUint32(highp uvec4 x) {
  uint64x2_t result;
  result.value = x;
  return result;
}
`],vL=[It,`
bool equals(uint64_t a, uint64_t b) {
  return a.value == b.value;
}
`],dh=[It,`
bool compareLessThan(uint64_t a, uint64_t b) {
  return (a.value[1] < b.value[1])||
         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);
}
`],yL=[It,`
uint64_t subtract(uint64_t a, uint64_t b) {
  if (a.value[0] < b.value[0]) {
    --a.value[1];
  }
  a.value -= b.value;
  return a;
}
`],tB=[It,`
uint64_t add(uint64_t a, uint64_t b) {
  a.value[0] += b.value[0];
  if (a.value[0] < b.value[0]) {
    ++a.value[1];
  }
  a.value[1] += b.value[1];
  return a;
}
`],nB=[tB,dh,`
uint64_t addSaturate(uint64_t a, uint64_t b) {
  a = add(a, b);
  if (compareLessThan(a, b)) {
    a.value = uvec2(0xffffffffu, 0xffffffffu);
  }
  return a;
}
`],rB=[yL,dh,`
uint64_t subtractSaturate(uint64_t a, uint64_t b) {
  b = subtract(a, b);
  if (compareLessThan(a, b)) {
    b.value = uvec2(0u, 0u);
  }
  return b;
}
`],bL=[It,`
uint64_t shiftRight(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));
  }
}
`],iB=[It,`
uint64_t shiftLeft(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));
  }
}
`],wL=[It,`
struct uint8_t {
  highp uint value;
};
struct uint8x2_t {
  highp uvec2 value;
};
struct uint8x3_t {
  highp uvec3 value;
};
struct uint8x4_t {
  highp uvec4 value;
};
uint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {
  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint8_t x) { return x.value; }
highp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }
highp uvec2 toRaw(uint8x2_t x) { return x.value; }
highp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }
highp uvec3 toRaw(uint8x3_t x) { return x.value; }
vec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }
highp uvec4 toRaw(uint8x4_t x) { return x.value; }
vec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }
uint64_t toUint64(uint8_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint8_t uint8FromFloat(highp float x) {
  return uint8_t(uint(clamp(x, 0.0, 255.0)));
}
`],SL=[It,`
struct int8_t {
  highp int value;
};
struct int8x2_t {
  highp ivec2 value;
};
struct int8x3_t {
  highp ivec3 value;
};
struct int8x4_t {
  highp ivec4 value;
};
int8_t mixLinear(int8_t x, int8_t y, highp float a) {
  return int8_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int8_t x) { return x.value; }
highp ivec2 toRaw(int8x2_t x) { return x.value; }
highp ivec3 toRaw(int8x3_t x) { return x.value; }
highp ivec4 toRaw(int8x4_t x) { return x.value; }
uint64_t toUint64(int8_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int8_t int8FromFloat(highp float x) {
  return int8_t(int(clamp(x, -128.0, 127.0)));
}
`],kv=`
highp float toRaw(highp float x) { return x; }
highp float toNormalized(highp float x) { return x; }
vec2 toRaw(vec2 x) { return x; }
vec2 toNormalized(vec2 x) { return x; }
vec3 toRaw(vec3 x) { return x; }
vec3 toNormalized(vec3 x) { return x; }
vec4 toRaw(vec4 x) { return x; }
vec4 toNormalized(vec4 x) { return x; }
`,CL=[It,`
struct uint16_t {
  highp uint value;
};
struct uint16x2_t {
  highp uvec2 value;
};
uint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {
  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint16_t x) { return x.value; }
highp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }
highp uvec2 toRaw(uint16x2_t x) { return x.value; }
highp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }
uint64_t toUint64(uint16_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint16_t uint16FromFloat(highp float x) {
  return uint16_t(uint(clamp(x, 0.0, 65535.0)));
}
`],xL=[It,`
struct int16_t {
  highp int value;
};
struct int16x2_t {
  highp ivec2 value;
};
int16_t mixLinear(int16_t x, int16_t y, highp float a) {
  return int16_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int16_t x) { return x.value; }
highp ivec2 toRaw(int16x2_t x) { return x.value; }
uint64_t toUint64(int16_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int16_t int16FromFloat(highp float x) {
  return int16_t(int(clamp(x, -32768.0, 32767.0)));
}
`],Lv=[It,`
struct uint32_t {
  highp uint value;
};
uint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {
  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }
highp uint toRaw(uint32_t x) { return x.value; }
uint64_t toUint64(uint32_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint32_t uint32FromFloat(highp float x) {
  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));
}
`],EL=[It,`
struct int32_t {
  highp int value;
};
int32_t mixLinear(int32_t x, int32_t y, highp float a) {
  return int32_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int32_t x) { return x.value; }
uint64_t toUint64(int32_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int32_t int32FromFloat(highp float x) {
  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));
}
`];var sB=`
highp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {
  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);
}
`;const aB=`
highp uint log2Exact(highp uint i) {
  highp uint r;
  r = uint((i & 0xAAAAAAAAu) != 0u);
  r |= uint((i & 0xFFFF0000u) != 0u) << 4;
  r |= uint((i & 0xFF00FF00u) != 0u) << 3;
  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;
  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;
  return r;
}
`,oB=`
bool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {
  highp float tmin = 0.0, tmax = 1.0;
  highp float k1 = b.w - a.w + a.z - b.z;
  highp float k2 = a.w - b.w + a.z - b.z;
  highp float q1 = (a.z - a.w) / k1;
  highp float q2 = (a.z + a.w) / k2;
  if (k1 > 0.0) tmin = max(tmin, q1);
  else if (k1 < 0.0) tmax = min(tmax, q1);
  if (k2 > 0.0) tmax = min(tmax, q2);
  else if (k2 < 0.0) tmin = max(tmin, q2);
  if (tmin <= tmax) {
    highp vec4 tempA = a;
    highp vec4 tempB = b;
    a = mix(tempA, tempB, tmin);
    b = mix(tempA, tempB, tmax);
    return true;
  }
  return false;
}
`,lB=`
highp float simpleFloatHash(highp vec2 co) {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}
`,dB=`
highp uint shiftLeftSaturate(highp uint x, int shiftAmount) {
  highp uint result = x << shiftAmount;
  if ((result >> shiftAmount) != x) return 0xffffffffu;
  return result;
}
`,Iv=`
highp uint addSaturate(highp uint x, highp uint y) {
  highp uint result = x + y;
  if (result < x) return 0xffffffffu;
  return result;
}
`,cB=`
highp uint subtractSaturate(highp uint x, highp uint y) {
  highp uint result = x - y;
  if (result > x) return 0u;
  return result;
}
`,uB=[Iv,`
highp int addSaturate(highp int x, highp uint y) {
  if (x >= 0) {
    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));
  } else if (y >= uint(-x)) {
    return int(min(y - uint(-x), 0x7fffffffu));
  } else {
    return -int(min(uint(-x) - y, 0x80000000u));
  }
}
`],hB=[Iv,`
highp int subtractSaturate(highp int x, highp uint y) {
  if (x < 0) {
    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));
  } else if (uint(x) >= y) {
    return x - int(y);
  } else {
    return -int(min(y - uint(x), 0x80000000u));
  }
}
`];function an(n,e=1){switch(n){case q.FLOAT32:if(e===1)return"float";if(e>1&&e<=4)return`vec${e}`;break;case q.UINT8:case q.INT8:case q.UINT16:case q.INT16:case q.UINT32:case q.INT32:case q.UINT64:{const t=fk[n]?"":"u",r=iV[n]*8;if(e===1)return`${t}int${r}_t`;if(e>1&&e*r<=32)return`${t}int${r}x${e}_t`;break}}throw new Error(`No shader type for ${q[n]}[${e}].`)}const Oo={[q.UINT8]:wL,[q.INT8]:SL,[q.UINT16]:CL,[q.INT16]:xL,[q.UINT32]:Lv,[q.INT32]:EL,[q.UINT64]:It,[q.FLOAT32]:kv};function pB(n,e){return e===1?n:`vec${e}`}const fB={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function wd(n,e,t,r,i,s,a=1){let l=0,c=s*a;for(;c>0;){const g=Math.min(4,c),v=pB(e,g);c-=g,n.addAttribute("highp "+v,`a${i}${l}`),++l}c=s*a;let u="";for(let g=0;g<a;++g){u+=`highp ${e}[${s}] get${i}${g}() {
  highp ${e}[${s}] result;
`;for(let v=0;v<s;++v){const y=g*s+v,C=Math.floor(y/4),S=y%4;u+=`  result[${v}] = a${i}${C}`,(S!==0||y!==c-1)&&(u+=`[${S}]`),u+=`;
`}u+=`  return result;
`,u+=`}
`}n.addVertexCode(u);const h=fB[t];n.addInitializer(g=>{const v=[];for(let y=0;y<l;++y)v[y]=g.attribute(`a${i}${y}`);g.vertexShaderInputBinders[i]={enable(y){const C=g.gl;for(let S=0;S<l;++S){const w=v[S];C.enableVertexAttribArray(w),C.vertexAttribDivisor(w,y)}},disable(){const y=g.gl;for(let C=0;C<l;++C){const S=v[C];y.vertexAttribDivisor(S,0),y.disableVertexAttribArray(S)}},bind(y,C){const S=g.gl;for(let w=0;w<l;++w){const E=v[w],k=Math.min(4,c-4*w);S.vertexAttribPointer(E,k,t,r,y,C),C+=h*k}}}})}class TL extends K{constructor(e,t,r=new Xl){super(),this.channels=e,this.bounds=t,this.visibility=r,this.framebuffers=[],this.producerVisibility=new Xl,this.frameNumber=-1}getFramebuffers(e){const t=this.framebuffers;for(;t.length<this.channels.value.length;){const r=new fo(e,{colorBuffers:fu(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(r)}return t}disposed(){for(const e of this.framebuffers)e.dispose();this.framebuffers.length=0}}const WC=Xn("histogramDataSamplerTextureUnit"),jC=Xn("histogramDepthTextureUnit"),xf=4096,gB=2**14;class Dv extends K{constructor(e){super(),this.gl=e,this.shader=this.registerDisposer((()=>{const t=new ea(this.gl);return t.addOutputBuffer("vec4","outputValue",0),t.addAttribute("float","aInput1"),t.addTextureSampler("sampler2D","uDataSampler",WC),t.addTextureSampler("sampler2D","uDepthSampler",jC),t.addVertexCode(lB),t.setVertexMain(`
float uRandomSeed = 0.0;
vec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),
              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));
float dataValue = texture(uDataSampler, p).x;
float stencilValue = texture(uDepthSampler, p).x;
if (stencilValue == 1.0) {
  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
} else {
  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
}
gl_PointSize = 1.0;
`),t.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
`),t.build()})()),this.inputIndexBuffer=this.registerDisposer(Zl(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(xf)))}static get(e){return e.memoize.get("textureHistogramGeneration",()=>new Dv(e))}compute(e,t,r,i,s){const a=this.gl,l=this.shader,c=i.getFramebuffers(a);l.bind(),a.enable(WebGL2RenderingContext.BLEND),a.disable(WebGL2RenderingContext.SCISSOR_TEST),a.disable(WebGL2RenderingContext.DEPTH_TEST),a.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(l.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);const u=l.textureUnit(WC),h=l.textureUnit(jC);a.activeTexture(WebGL2RenderingContext.TEXTURE0+h),a.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),po(a),a.activeTexture(WebGL2RenderingContext.TEXTURE0+u);const g=i.frameNumber;i.frameNumber=s;for(let v=0;v<e;++v)a.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r[v].texture),po(a),c[v].bind(256,1),s!==g&&(a.clearColor(0,0,0,0),a.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),a.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,xf,gB/xf);a.disable(WebGL2RenderingContext.BLEND)}}const Pv={[q.UINT8]:"vec2",[q.INT8]:"vec2",[q.UINT16]:"vec2",[q.INT16]:"vec2",[q.FLOAT32]:"vec2",[q.UINT32]:"Uint32LerpParameters",[q.INT32]:"Int32LerpParameters",[q.UINT64]:"Uint64LerpParameters"},Sd={[q.UINT8]:"",[q.INT8]:"",[q.UINT16]:"",[q.INT16]:"",[q.FLOAT32]:"",[q.UINT32]:`
struct Uint32LerpParameters {
  uint offset;
  int shift;
  float multiplier;
};
`,[q.INT32]:`
struct Int32LerpParameters {
  int offset;
  int shift;
  float multiplier;
};
`,[q.UINT64]:[It,`
struct Uint64LerpParameters {
  uint64_t offset;
  int shift;
  float multiplier;
};
`]};function Ll(n){let e=`
float computeInvlerp(${an(n)} inputValue, vec2 p) {
  float outputValue = float(toRaw(inputValue));
  outputValue = (outputValue - p[0]) * p[1];
  return outputValue;
}
`;return[Oo[n],e]}function HC(n){const e=an(n);let t=n===q.INT32?"int":"uint",r=Pv[n];return[Oo[n],Sd[n],`
float computeInvlerp(${e} inputValue, ${r} p) {
  ${t} v = toRaw(inputValue);
  uint x;
  if (v >= p.offset) {
    x = uint(v - p.offset);
  } else {
    x = uint(p.offset - v);
    p.multiplier = -p.multiplier;
  }
  x >>= p.shift;
  return float(x) * p.multiplier;
}
`]}const mB={[q.UINT8]:Ll(q.UINT8),[q.INT8]:Ll(q.INT8),[q.UINT16]:Ll(q.UINT16),[q.INT16]:Ll(q.INT16),[q.FLOAT32]:Ll(q.FLOAT32),[q.UINT32]:HC(q.UINT32),[q.INT32]:HC(q.INT32),[q.UINT64]:[It,dh,yL,bL,Sd[q.UINT64],`
float computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {
  if (compareLessThan(inputValue, p.offset)) {
    inputValue = subtract(p.offset, inputValue);
    p.multiplier = -p.multiplier;
  } else {
    inputValue = subtract(inputValue, p.offset);
  }
  uint shifted = shiftRight(inputValue, p.shift).value[0];
  return float(shifted) * p.multiplier;
}
`]};function Il(n){let e=`
${an(n)} computeLerp(float inputValue, vec2 p) {
  inputValue = inputValue / p[1] + p[0];
`;return n===q.FLOAT32?e+=`return inputValue;
`:e+=`return ${q[n].toLowerCase()}FromFloat(round(inputValue));
`,e+=`
}
`,[Oo[n],e]}function qC(n){const e=an(n);let t=Pv[n];return[Oo[n],Sd[n],dB,n===q.UINT32?Iv:uB,n===q.UINT32?cB:hB,`
${e} computeLerp(float inputValue, ${t} p) {
  inputValue = inputValue / p.multiplier;
  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));
  uint xShifted = shiftLeftSaturate(x, p.shift);
  if (inputValue >= 0.0) {
    return ${e}(addSaturate(p.offset, xShifted));
  } else {
    return ${e}(subtractSaturate(p.offset, xShifted));
  }
}
`]}const vB={[q.UINT8]:Il(q.UINT8),[q.INT8]:Il(q.INT8),[q.UINT16]:Il(q.UINT16),[q.INT16]:Il(q.INT16),[q.FLOAT32]:Il(q.FLOAT32),[q.UINT32]:qC(q.UINT32),[q.INT32]:qC(q.INT32),[q.UINT64]:[It,dh,vL,nB,rB,bL,iB,Sd[q.UINT64],`
uint64_t computeLerp(float inputValue, Uint64LerpParameters p) {
  inputValue = inputValue / p.multiplier;
  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));
  uint64_t shifted = shiftLeft(x, p.shift);
  if (!equals(shiftRight(shifted, p.shift), x)) {
    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));
  }
  if (inputValue >= 0.0) {
    return addSaturate(p.offset, shifted);
  } else {
    return subtractSaturate(p.offset, shifted);
  }
}
`]};function kL(n,e,t){const r=`uLerpParams_${e}`,i=`uLerpBounds_${e}`,s=`uLerpScalar_${e}`;let a="";switch(t){case q.INT8:case q.UINT8:case q.INT16:case q.UINT16:case q.FLOAT32:n.addUniform("vec2",r);break;case q.INT32:case q.UINT32:{const l=Pv[t];n.addUniform(`${t===q.INT32?"i":"u"}vec2`,i),n.addUniform("float",s),a+=`
#define ${r} ${l}(${i}[0], int(${i}[1]), ${s})
`;break}case q.UINT64:{n.addUniform("uvec3",i),n.addUniform("float",s),a+=`
#define ${r} Uint64LerpParameters(uint64_t(${i}.xy), int(${i}[2]), ${s})
`;break}}return[Sd[t],a]}function LL(n,e,t,r=!1){return[Oo[t],kL(n,e,t),mB[t],`
float ${e}(${an(t)} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${e});
  ${r?"v = clamp(v, 0.0, 1.0);":""}
  return v;
}
`]}function yB(n,e,t){return[Oo[t],kL(n,e,t),vB[t],`
${an(t)} ${e}(float inputValue) {
  return computeLerp(inputValue, uLerpParams_${e});
}
`]}const zs=new te;function Rv(n,e,t,r){const i=n.gl;switch(t){case q.INT8:case q.UINT8:case q.INT16:case q.UINT16:case q.FLOAT32:i.uniform2f(n.uniform(`uLerpParams_${e}`),r[0],1/(r[1]-r[0]));break;case q.INT32:case q.UINT32:{const s=r[0],a=r[1]-s,l=Math.max(0,Math.ceil(Un(Math.abs(a)))-24),c=Math.pow(2,l)/a,u=n.uniform(`uLerpBounds_${e}`);t===q.UINT32?i.uniform2ui(u,s,l):i.uniform2i(u,s,l),i.uniform1f(n.uniform(`uLerpScalar_${e}`),c);break}case q.UINT64:{const s=r[0],a=r[1];te.absDifference(zs,a,s);const l=zs.high>0?32+Math.ceil(Un(zs.high)):Math.ceil(Un(zs.low)),c=Math.max(0,l-24);te.rshift(zs,zs,c);let u=1/zs.low;te.compare(s,a)>0&&(u*=-1);const h=n.uniform(`uLerpBounds_${e}`);i.uniform3ui(h,s.low,s.high,c),i.uniform1f(n.uniform(`uLerpScalar_${e}`),u)}}}function bB(n){const e=/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/mg;return n.replace(e,t=>t.startsWith("/")?t.replace(/[^\s]/g," "):t)}function wB(n){const e=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/;let t=0,r=n;e:for(;n.length;){const i=n.match(e);if(i===null)break;const s=i[0];switch(s.charAt(0)){case"[":case"{":++t;break;case"]":case"}":if(--t<0)return-1;break;case",":if(t===0)break e;break;default:if(t===0){n=n.substring(s.length);break e}break}n=n.substring(s.length)}return t!==0?-1:r.length-n.length}function SB(n){let e=[],t=new de;if(n===void 0)return{errors:e,parameters:t};const r=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;n=n.trim(),n.length!=0;){const i=n.match(r);if(i===null){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}const s=i[1];n=n.substring(i[0].length);let a=wB(n);if(a<=0){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let l;try{l=JSON.parse(n.substring(0,a))}catch{e.push(`Invalid #uicontrol parameter value for ${s}: ${l}`);break}t.has(s)?e.push(`Duplicate #uicontrol parameter: ${s}`):t.set(s,l),n=n.substring(a),n=n.trim(),n.length>0&&!n.startsWith(",")&&e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),n=n.substring(1)}return{parameters:t,errors:e}}function CB(n,e){let t,r,i,s,a=[];n!=="float"&&n!=="uint"&&n!=="int"&&a.push("type must be float, int, or uint");for(const c of e){var l=ae(c,2);const u=l[0],h=l[1],g=()=>{if(typeof h!="number"){a.push(`Expected ${u} argument to be a number`);return}return(n==="int"||n==="uint")&&(Nn(h)||a.push(`Expected ${u} argument to be an integer`),n==="uint"&&h<0&&a.push(`Expected ${u} argument to be an unsigned integer`)),h};u==="min"?t=g():u==="max"?r=g():u==="default"?s=g():u==="step"?i=g():a.push(`Invalid parameter: ${u}`)}return t===void 0&&a.push("min must be specified"),r===void 0&&a.push("max must be specified"),t!==void 0&&r!==void 0&&(t>r&&a.push("min must be less than max"),i===void 0&&(n==="float"?i=(r-t)/100:i=1),s!==void 0?(s<t||s>r)&&a.push("default must be within valid range"):n==="float"?s=(t+r)/2:s=t),a.length>0?{errors:a}:{control:{type:"slider",valueType:n,min:t,max:r,step:i,default:s},errors:void 0}}function xB(n,e){let t=!1,r=[];n!=="bool"&&r.push("type must be bool");for(const s of e){var i=ae(s,2);const a=i[0],l=i[1];if(a==="default"){if(typeof l!="boolean"){r.push(`Expected ${a} argument to be a boolean`);continue}t=l}else r.push(`Invalid parameter: ${a}`)}return r.length>0?{errors:r}:{control:{type:"checkbox",valueType:n,default:t},errors:void 0}}function EB(n,e){let t="white",r=[];n!=="vec3"&&r.push("type must be vec3");for(const s of e){var i=ae(s,2);const a=i[0],l=i[1];a==="default"?typeof l!="string"?r.push("Expected default argument to be a string"):t=l:r.push(`Invalid parameter: ${a}`)}return r.length>0?{errors:r}:{control:{type:"color",valueType:n,defaultString:t,default:Ao(t)},errors:void 0}}function IL(n,e){typeof n=="number"&&(n=[n]);const t=new Array(e);return it(t,n,r=>{if(!Nn(r)||r<0)throw new Error(`Expected non-negative integer, but received: ${ie(r)}`);return r}),t}function TB(n,e,t){let r=[];const i=t.imageData;if(i===void 0)return r.push("invlerp control not supported"),{errors:r};n!=="invlerp"&&r.push("type must be invlerp");let s=new Array(i.channelRank).fill(0);const a=i.dataType;let l=!0,c=md[a],u;for(let g of e){var h=ae(g,2);let v=h[0],y=h[1];try{switch(v){case"range":{c=su(y,a);break}case"window":{u=yk(su(y,a));break}case"clamp":{typeof y!="boolean"?r.push(`Invalid clamp value: ${ie(y)}`):l=y;break}case"channel":{s=IL(y,s.length);break}default:r.push(`Invalid parameter: ${v}`);break}}catch(C){r.push(`Invalid ${v} value: ${C.message}`)}}return r.length>0?{errors:r}:{control:{type:"invlerp",dataType:a,clamp:l,default:{range:c,window:u??$V(c),channel:s}},errors:void 0}}const kB=new de([["slider",CB],["color",EB],["invlerp",TB],["checkbox",xB]]);function ch(n,e={}){n=bB(n);const t=/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/mg,r=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/;let i=[];const s=new de,a=n.replace(t,(l,c,u)=>{var h;const g=c.match(r),v=()=>Math.max(0,n.substring(0,u).split(`
`).length-1);if(g===null)return i.push({line:v(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";const y=g[1],C=g[2],S=(h=g[3])!==null&&h!==void 0?h:y,w=g[4];var E=SB(w);const k=E.parameters,P=E.errors;for(const R of P)i.push({line:v(),message:R});if(s.has(C)&&i.push({line:v(),message:`Duplicate definition for control ${C}`}),P.length>0)return"";const D=kB.get(S);if(D===void 0)return i.push({line:v(),message:`Invalid control type ${S}`}),"";const L=D(y,k,e);if(L.errors!==void 0){for(const R of L.errors)i.push({line:v(),message:R});return""}return s.set(C,L.control),""});return{source:n,code:a,errors:i,controls:s}}function DL(n){return`u_shaderControl_${n}`}function ed(n,e){const t=n.builderValues;for(const i of n.parseResult.controls){var r=ae(i,2);const s=r[0],a=r[1],l=DL(s),c=t[s];switch(a.type){case"invlerp":{const u=[LL(e,l,a.dataType,a.clamp),`
float ${l}() {
  return ${l}(getDataValue(${c.channel.join(",")}));
}
`];e.addFragmentCode(u),e.addFragmentCode(`#define ${s} ${l}
`);break}case"checkbox":{const u=`#define ${s} ${c.value}
`;e.addFragmentCode(u),e.addVertexCode(u);break}default:{e.addUniform(`highp ${a.valueType}`,l),e.addVertexCode(`#define ${s} ${l}
`),e.addFragmentCode(`#define ${s} ${l}
`);break}}}}function LB(n){const e={};for(const r of n){var t=ae(r,2);const i=t[0],s=t[1];e[i]=s}return e}function JC(n){if(n!==void 0)return ie(LB(n))}class IB{constructor(){this.changed=new we,this.controls=void 0}get value(){return this.controls}set value(e){JC(e)!==JC(this.controls)&&(this.controls=e,this.changed.dispatch())}}function DB(n,e,t){return n===void 0?t:(ge(n),{range:ye(n,"range",r=>su(r,e),t.range),window:ye(n,"window",r=>yk(su(r,e)),t.window),channel:ye(n,"channel",r=>IL(r,t.channel.length),t.channel)})}class PB extends Jt{constructor(e,t){super(t,r=>DB(r,e,t)),this.dataType=e,this.defaultValue=t}toJSON(){var e=this.value;const t=e.range,r=e.window,i=e.channel,s=this.dataType,a=this.defaultValue,l=YS(t,s,a.range),c=YS(r,s,a.window),u=Oe(a.channel,i)?void 0:i;if(!(l===void 0&&c===void 0&&u===void 0))return{range:l,window:c,channel:u}}}function PL(n){switch(n.type){case"slider":return{trackable:new Jt(n.default,e=>{let t;if(n.valueType==="float"?t=vt(e):t=hn(e),t<n.min||t>n.max)throw new Error(`${ie(e)} is outside valid range [${n.min}, ${n.max}]`);return t}),getBuilderValue:()=>null};case"color":return{trackable:new ru(n.default),getBuilderValue:()=>null};case"invlerp":return{trackable:new PB(n.dataType,n.default),getBuilderValue:e=>({channel:e.channel,dataType:n.dataType})};case"checkbox":return{trackable:new Ft(n.default),getBuilderValue:e=>({value:e})}}}function RL(n,e){return ie(n)+"\0"+e.source}function Mv(n){const e={};for(const i of n.controls){var t=ae(i,2);const s=t[0],a=t[1];var r=PL(a);const l=r.trackable,c=r.getBuilderValue;e[s]=c(l.value)}return{builderValues:e,parseResult:n,key:RL(e,n)}}class Av extends K{constructor(e,t=Zs({}),r){super(),this.fragmentMain=e,this.dataContext=t,this.channelCoordinateSpaceCombiner=r,this.changed=new we,this.controls=new IB,this.fragmentMainGeneration=-1,this.dataContextGeneration=-1,this.parseErrors_=[],this.processedFragmentMain_="",this.controlsGeneration=-1,this.parseResultChanged=new we,this.state_=new de,this.unparsedJson=void 0,this.registerDisposer(e.changed.add(()=>this.handleFragmentMainChanged())),this.registerDisposer(this.controls.changed.add(()=>this.handleControlsChanged())),this.registerDisposer(this.dataContext.changed.add(()=>this.handleFragmentMainChanged())),this.handleFragmentMainChanged();const i=this;this.parseErrors={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return i.parseResult_}},this.builderState=dr((l,c)=>{const u={};for(const v of c){var h=ae(v,2);const y=h[0];var g=h[1];const C=g.trackable,S=g.getBuilderValue,w=S(C.value);u[y]=w}return{key:RL(u,l),parseResult:l,builderValues:u}},[this.parseResult,this],(l,c)=>l.key===c.key);const s=dr(l=>{const c=[];for(const u of l.values()){const h=u.control,g=u.trackable;h.type==="invlerp"&&c.push({channel:g.value.channel})}return c},[this],(l,c)=>lg(l,c,(u,h)=>Oe(u.channel,h.channel))),a=Hr(l=>{const c=[];for(const u of l.values()){const h=u.control,g=u.trackable;h.type==="invlerp"&&c.push(g.value.window)}return c},this);this.histogramSpecifications=this.registerDisposer(new TL(s,a))}handleFragmentMainChanged(){const e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;const r=this.dataContext.value;if(r===null)this.parseResult_={source:"",code:"",controls:new de,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{const i=this.parseResult_=ch(this.fragmentMain.value,r);this.parseErrors_=i.errors,this.processedFragmentMain_=i.code,i.errors.length===0&&(this.controls.value=i.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){const e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;const t=this.controls.value;if(t===void 0)return;let r=!1;const i=this.state_,s=this.unparsedJson;for(const u of i){var a=ae(u,2);const h=a[0],g=a[1];if(t.get(h)===void 0){g.trackable.changed.remove(this.changed.dispatch),i.delete(h),r=!0;continue}}for(const u of t){var l=ae(u,2);const h=l[0],g=l[1];let v=i.get(h);if(v!==void 0&&ie(v.control)!==ie(g)&&(v.trackable.changed.remove(this.changed.dispatch),v=void 0),v===void 0){var c=PL(g);const y=c.trackable,C=c.getBuilderValue;v={control:g,trackable:y,getBuilderValue:C},v.trackable.changed.add(this.changed.dispatch),i.set(h,v),r=!0}if(s!==void 0&&s.hasOwnProperty(h)){r=!0;try{v.trackable.restoreState(s[h])}catch{}}}s!==void 0&&(r=!0),this.unparsedJson=void 0,r&&this.changed.dispatch()}get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}restoreState(e){if(e===void 0)return;const t=this.state;if(ge(e),this.controls.value===void 0){this.unparsedJson=e,this.changed.dispatch();return}for(const i of t){var r=ae(i,2);const s=r[0],a=r[1].trackable;if(a.reset(),e.hasOwnProperty(s))try{a.restoreState(e[s])}catch{}}this.unparsedJson=void 0}reset(){for(const e of this.state.values())e.trackable.reset();this.unparsedJson!==void 0&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){const e=this.state,t=this.unparsedJson;if(t!==void 0)return t;const r={};let i=!0;for(const a of e){var s=ae(a,2);const l=s[0],c=s[1].trackable.toJSON();c!==void 0&&(r[l]=c,i=!1)}if(!i)return r}}function YC(n,e,t,r,i){const s=DL(t),a=e.uniform(s);switch(r.type){case"slider":switch(r.valueType){case"int":case"uint":n.uniform1i(a,i);break;case"float":n.uniform1f(a,i)}break;case"color":n.uniform3fv(a,i);break;case"invlerp":Rv(e,s,r.dataType,i.range);break}}function mo(n,e,t,r){const i=t.state;if(t.controls.value===r)for(const l of i){var s=ae(l,2);const c=s[0],u=s[1];YC(n,e,c,u.control,u.trackable.value)}else for(const l of r){var a=ae(l,2);const c=a[0],u=a[1],h=i.get(c),g=h!==void 0&&ie(h.control)===ie(u)?h.trackable.value:u.default;YC(n,e,c,u,g)}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class RB extends dt{}class MB extends xv{constructor(){super((e,{showMatches:t,segmentationState:r})=>{e.registerDisposer(t.changed.add(this.changed.dispatch)),e.registerDisposer(r.changed.add(this.changed.dispatch)),e.registerDisposer(Di((i,s)=>{if(s==null)return;const a=s.segmentationGroupState;i.registerDisposer(a.changed.add(this.changed.dispatch)),i.registerDisposer(Di((l,c)=>{const u=c.visibleSegments;let h=u.size===0;l.registerDisposer(u.changed.add(()=>{const g=u.size===0;g!==h&&(h=g,this.changed.dispatch())}))},a))},r))})}get(e){let t=super.get(e);return t===void 0&&(t={segmentationState:new dt(void 0),showMatches:new Ft(!1)},super.set(e,t)),t}}const XC=`
void main() {
  setColor(defaultColor());
}
`;class AB extends K{constructor(){super(...arguments),this.shader=Ev(XC),this.shaderControls=new Av(this.shader),this.fallbackShaderControls=new dt(Mv(ch(XC))),this.shaderError=lh(),this.color=new ru(lt(1,1,0)),this.relationshipStates=this.registerDisposer(new MB),this.ignoreNullSegmentFilter=new Ft(!0),this.displayUnfiltered=Hr((e,t)=>{for(const r of e.values())if(r.showMatches.value){if(!t)return!1;const i=r.segmentationState.value;if(i!=null&&i.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0},this.relationshipStates,this.ignoreNullSegmentFilter),this.hoverState=new RB(void 0)}}class Ag extends K{constructor(e){super();const t=e.transform,r=e.localPosition,i=e.source;var s=e.role;const a=s===void 0?ur.ANNOTATION:s;this.transform=t,this.localPosition=r,this.source=this.registerDisposer(i),this.role=a,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer(Hr(l=>fL(()=>zk(AO(l))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex}get sourceIndex(){const e=this.dataSource;return e.layer.dataSources.indexOf(e)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class uh{constructor(e,t,r){this.size=dg(e),this.transform=DN(t),this.finiteRank=r;const i=Je(),s=hv(i,4,t,4,4);if(s===0)throw new Error("Transform is singular");this.invTransform=i,this.detTransform=s}toObject(){return{size:this.size,transform:this.transform,finiteRank:this.finiteRank}}static fromObject(e){return new uh(e.size,e.transform,e.finiteRank)}globalToLocalSpatial(e,t){return ar(e,t,this.invTransform)}localSpatialVectorToGlobal(e,t){return qN(e,t,this.transform)}globalToLocalNormal(e,t){return ok(e,t,this.transform)}}const NB=Je();function VB(n,e){let t=0,r=Math.abs(n.detTransform);const i=n.transform,s=n.size;for(let a=0;a<3;++a){let l=0;for(let u=0;u<3;++u)l+=e[u*4+2]*i[4*a+u];const c=s[a];t+=Math.abs(l)*c,r*=c}return r/t}function ML(n,e,t){const r=n.curPositionInChunks,i=n.fixedPositionWithinChunk,s=n.nonDisplayLowerClipBound,a=n.nonDisplayUpperClipBound;var l=n.source.spec;const c=l.rank,u=l.chunkDataSize;if(!Yl(r,e,t,n.layerRank,n.fixedLayerToChunkTransform))return!1;for(let h=0;h<c;++h){const g=r[h];if(g<s[h]||g>=a[h])return!1;const v=u[h],y=r[h]=Math.floor(g/v);i[h]=g-y*v}return!0}function OB(n,e){let t=e.length,r=0;if(t>1){let i=0;for(let s=0;s<t;++s){const a=e[s].chunkLayout;let l=VB(a,n);l>i&&(i=l,r=s)}}return r}const za=new uh(Ne(),Je(),0);class BB extends Qk{constructor(){super(...arguments),this.viewportNormalInGlobalCoordinates=Ne(),this.viewportNormalInCanonicalCoordinates=Ne(),this.centerDataPosition=Ne(),this.pixelSize=0}}function FB(n,e){if(n.displayDimensionRenderInfo!==e.displayDimensionRenderInfo||n.pixelSize!==e.pixelSize)return!0;const t=n.viewMatrix,r=e.viewMatrix;for(let i=0;i<12;++i)if(t[i]!==r[i])return!0;return!1}class _B extends ei{constructor(e){super(),this.projectionParameters=e,this.visibleLayers=new de,this.visibleSourcesStale=!0,this.registerDisposer(e.changed.add((t,r)=>{FB(t,r)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;const e=this.projectionParameters.value.displayDimensionRenderInfo,t=this.visibleLayers;for(const s of t){var r=ae(s,2);const a=r[0];var i=r[1];const l=i.allSources,c=i.visibleSources,u=i.displayDimensionRenderInfo;if(c.length=0,u!==e||l.length===0)continue;const h=OB(this.projectionParameters.value.viewMatrix,l.map(v=>v[0])),g=l[h];for(const v of a.filterVisibleSources(this,g))c.push(v);c.reverse()}}}const UB=18;function gu(n){let e=n.rank,t=n.upperVoxelBound;var r=n.maxVoxelsPerChunkLog2;let i=r===void 0?UB:r,s=n.chunkToViewTransform,a=n.displayRank,l=n.minBlockSize,c=n.maxBlockSize;var u=n.lowerVoxelBound;const h=u===void 0?new Uint32Array(e):u,g=new Float32Array(e);for(let S=0;S<e;++S){let w=0;for(let E=0;E<a;++E){const k=s[S*a+E];w+=k*k}g[S]=Math.sqrt(w)}const v=new Uint32Array(e);l!==void 0?v.set(l):v.fill(1);const y=new Array(e);for(let S=0;S<e;++S){let w=Number.POSITIVE_INFINITY;g[S]===0?w=v[S]:(t!==void 0&&(w=Math.pow(2,Math.floor(Un(t[S]-h[S])))),c!==void 0&&(w=Math.min(w,c[S]))),y[S]=w}function C(){let S=1/0,w=-1;for(let E=0;E<e;++E){if(v[E]>=y[E])continue;let k=v[E]*g[E];k<S&&(S=k,w=E)}return w}i-=Un(fv(v));for(let S=0;S<i;++S){let w=C();if(w===-1)break;v[w]*=2}return v}function $B(n){const e=[],t=n.displayRank,r=n.chunkToViewTransform,i=n.rank;if(t>3)throw new Error("Unsupported view transform");if(t<3)return[gu(n)];for(let s=0;s<3;++s){const a=(s+2)%3,l=new Float32Array(r);for(let c=0;c<i;++c)l[c*t+a]=0;e[s]=gu(j(j({},n),{chunkToViewTransform:l}))}return e}var to;(function(n){n[n.ISOTROPIC=0]="ISOTROPIC",n[n.FLAT=1]="FLAT"})(to||(to={}));function zB(n){if(n.chunkDataSizes!==void 0)return n.chunkDataSizes;var e=n.chunkLayoutPreference;switch(e===void 0?to.ISOTROPIC:e){case to.ISOTROPIC:return[gu(n)];case to.FLAT:return $B(n)}}function Cd(n){const e=n.rank,t=n.chunkDataSize,r=n.upperVoxelBound;var i=n.lowerVoxelBound;const s=i===void 0?new Float32Array(e):i,a=new Float32Array(e),l=new Float32Array(e);for(let c=0;c<e;++c)a[c]=Math.floor(s[c]/t[c]),l[c]=Math.floor((r[c]-1)/t[c]+1);return{rank:e,chunkDataSize:t,lowerChunkBound:a,upperChunkBound:l,lowerVoxelBound:s,upperVoxelBound:r}}function*GB(n,e,t){const r=n.projectionParameters.value.pixelSize*1.1,i=t[0].effectiveVoxelSize,s=e.renderScaleTarget.value,a=h=>{const g=r*s;for(let v=0;v<3;++v){const y=h[v];if(y>g&&y>1.01*i[v])return!0}return!1},l=(h,g)=>{const v=r*s;for(let y=0;y<3;++y){const C=h[y],S=g[y];if(Math.abs(v-C)<Math.abs(v-S)&&C<1.01*S)return!0}return!1};let c=t.length-1,u;for(;;){const h=t[c];if(u!==void 0&&!l(h.effectiveVoxelSize,u)||(yield h,c===0||!a(h.effectiveVoxelSize)))break;u=h.effectiveVoxelSize,--c}}const WB="SliceView",jB="sliceview/RenderLayer",HB="SliceView.addVisibleLayer",qB="SliceView.removeVisibleLayer",Nv=new Float32Array(3),Vv=new Float32Array(3),AL=Je(),NL=new Float32Array(24);function VL(n,e,t,r){const i=Nv,s=Vv,a=e.lowerChunkDisplayBound,l=e.upperChunkDisplayBound;for(let g=0;g<3;++g)i[g]=Math.max(i[g],a[g]),s[g]=Math.min(s[g],l[g]);const c=e.curPositionInChunks,u=e.chunkDisplayDimensionIndices;function h(){if(!r(i[0],i[1],i[2],s[0],s[1],s[2],n))return;let g=0,v=Math.max(0,s[0]-i[0]),y=v;for(let E=1;E<3;++E){const k=Math.max(0,s[E]-i[E]);y*=k,k>v&&(v=k,g=E)}if(y===0)return;if(y===1){c[u[0]]=i[0],c[u[1]]=i[1],c[u[2]]=i[2],t(i,n);return}const C=i[g],S=s[g],w=Math.floor(.5*(C+S));s[g]=w,h(),s[g]=S,i[g]=w,h(),i[g]=C}h()}function OL(n,e,t,r){if(!ML(t,n.globalPosition,e))return;const i=t.chunkLayout.size,s=en(AL,n.viewProjectionMat,t.chunkLayout.transform);for(let u=0;u<3;++u){const h=i[u];for(let g=0;g<4;++g)s[4*u+g]*=h}const a=NL;nu(a,s);const l=Nv,c=Vv;l.fill(Number.NEGATIVE_INFINITY),c.fill(Number.POSITIVE_INFINITY),VL(a,t,r,dk)}function JB(n,e,t,r,i){if(!ML(t,n.globalPosition,e))return;const s=r.size,a=en(AL,n.viewProjectionMat,r.transform);for(let v=0;v<3;++v){const y=s[v];for(let C=0;C<4;++C)a[4*v+C]*=y}const l=NB;fs(l,a);const c=Nv,u=Vv,h=.001;for(let v=0;v<3;++v){const y=l[12+v]+h/s[v],C=Math.abs(l[v]),S=Math.abs(l[4+v]);c[v]=Math.floor(y-C-S),u[v]=Math.floor(y+C+S+1)}const g=NL;for(let v=0;v<3;++v){const y=a[4*v],C=a[4*v+1],S=a[4*v+2];g[v]=y,g[4+v]=-y,g[8+v]=+C,g[12+v]=-C,g[16+v]=+S,g[20+v]=-S}{const v=a[12],y=a[13],C=a[14];g[3]=1+v,g[7]=1-v,g[11]=1+y,g[15]=1-y,g[19]=C,g[23]=-C}VL(g,t,i,YN)}function Ov(n,e){const t=e.finiteRank;if(t===3)return e;za.finiteRank=t,ON(za.size,e.size);const r=Qc(za.transform,e.transform),i=Qc(za.invTransform,e.invTransform);za.detTransform=e.detTransform;const s=n.invViewMatrix,a=n.width,l=n.height,c=uk(n.projectionMat);for(let u=t;u<3;++u){const h=s[12+u];let g=h,v=h;const y=Math.abs(s[u]*a);g-=y,v+=y;const C=Math.abs(s[u+4]*l);g-=C,v+=C;const S=Math.abs(s[u+8]*c);g-=S,v+=S;const w=Math.max(1,v-g);r[12+u]=g,r[5*u]=w}return fs(i,r),za}const YB="annotation.MetadataChunkSource",XB="annotation.GeometryChunkSource",KB="annotation.SubsetGeometryChunkSource",ZB="annotation.reference.add",QB="annotation.reference.delete",eF="annotation.commit",tF="annotation.commit",nF="annotation/SpatiallyIndexedRenderLayer",rF="annotation/PerspectiveRenderLayer:updateSources",iF="annotation/RenderLayer",sF="annotation/RenderLayer.updateSegmentation",aF=ud();function oF(n,e,t,r,i,s){const a=n.displayDimensionRenderInfo,l=n.viewMatrix,c=n.projectionMat,u=n.width,h=n.height,g=a.voxelPhysicalScales,v=Math.abs(tv(th(aF,l))),y=gg(g),C=XN(c)/v*y;if(r.length===0)return;const S=r[0];let w=Math.abs(S.chunkLayout.detTransform)*y;const E=S.lowerClipDisplayBound,k=S.upperClipDisplayBound;for(let M=0;M<3;++M)w*=k[M]-E[M];const P=Math.min(w,C),D=u*h,L=D/t**2/P;let R=0;for(let M=r.length-1;M>=0&&R<L;--M){const V=r[M],B=V.source.spec,_=V.chunkLayout,H=gg(_.size)*Math.abs(_.detTransform)*y,U=B.limit,O=B.rank,z=V.nonDisplayLowerClipBound,F=V.nonDisplayUpperClipBound;let se=1;for(let Le=0;Le<O;++Le){const _e=F[Le]-z[Le];gt(_e)&&(se/=_e)}const oe=U*se/H,Re=R+oe,le=Math.pow(1/Re,1/3),Se=Math.sqrt(D/(Re*P)),ne=(L-R)*H/se,he=Math.min(1,ne/B.limit);OL(n,e,V,()=>{s(V,M,he,le,Se)}),R=Re}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const td=`vec3 colormapJet(float x) {
  vec3 result;
  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);
  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);
  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);
  return clamp(result, 0.0, 1.0);
}
vec3 colormapCubehelix(float x) {
  float xclamp = clamp(x, 0.0, 1.0);
  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);
  float amp = xclamp * (1.0 - xclamp) / 2.0;
  vec3 result;
  float cosangle = cos(angle);
  float sinangle = sin(angle);
  result.r = -0.14861 * cosangle + 1.78277 * sinangle;
  result.g = -0.29227 * cosangle + -0.90649 * sinangle;
  result.b = 1.97294 * cosangle;
  result = clamp(xclamp + amp * result, 0.0, 1.0);
  return result;
}
`;function BL(n,e){return{defineShader(t,r){const i=`prop_${r}`,s=`a_${i}`;t.addAttribute(`${n}`,s),t.addVertexCode(`${n} ${i}() { return ${s}; }`),t.addInitializer(a=>{const l=a.attribute(s),c=a.gl;a.vertexShaderInputBinders[i]=l===-1?{enable(){},disable(){},bind(){}}:{enable(u){c.enableVertexAttribArray(l),c.vertexAttribDivisor(l,u)},disable(){c.vertexAttribDivisor(l,0),c.disableVertexAttribArray(l)},bind(u,h){e(c,l,u,h)}}})}}}function Ef(n,e,t,r){return BL(n,(i,s,a,l)=>{i.vertexAttribPointer(s,e,t,r,a,l)})}function Ga(n,e,t){return BL(n,(r,i,s,a)=>{r.vertexAttribIPointer(i,e,t,s,a)})}const lF={rgb:Ef("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:Ef("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:Ef("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:Ga("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:Ga("highp int",1,WebGL2RenderingContext.INT),uint16:Ga("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:Ga("highp int",1,WebGL2RenderingContext.SHORT),uint8:Ga("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:Ga("highp int",1,WebGL2RenderingContext.BYTE)};class xd extends K{constructor(e,t,r,i,s,a,l){super(),this.gl=e,this.annotationType=t,this.rank=r,this.properties=i,this.shaderControlState=s,this.fallbackShaderParameters=a,this.shaderError=l;const c=this.serializedGeometryBytesPerAnnotation=Dn[t].serializedBytes(r);var u=bk(r,c,i);const h=u.offsets,g=u.serializedBytes,v=u.propertyGroupBytes;this.serializedBytesPerAnnotation=g,this.propertyOffsets=h,this.propertyGroupBytes=v,this.geometryDataStride=v[0]}getDependentShader(e,t){return ho(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(r,i)=>{const s=this.rank,a=this.properties,l=[],c=i.parseResult.code;for(let C=0,S=a.length;C<S;++C){const w=a[C],E=`prop_${w.identifier}`;c.match(new RegExp(`\\b${E}\\b`))&&(l.push(C),lF[w.type].defineShader(r,w.identifier,s))}const u=this.propertyOffsets,h=this.propertyGroupBytes,g=new Array(h.length);g[0]=0;for(let C=1;C<h.length;++C)g[C]=g[C-1]+h[C-1];r.addInitializer(C=>{const S=l.map(E=>C.vertexShaderInputBinders[`prop_${a[E].identifier}`]),w=S.length;C.vertexShaderInputBinders.properties={enable(E){for(let k=0;k<w;++k)S[k].enable(E)},bind(E,k){for(let D=0;D<w;++D){var P=u[l[D]];let L=P.group,R=P.offset;S[D].bind(h[L],k+R+g[L]*E)}},disable(){for(let E=0;E<w;++E)S[E].disable()}}}),r.addUniform("highp vec3","uColor"),r.addUniform("highp uint","uSelectedIndex"),r.addVarying("highp vec4","vColor"),r.addUniform("highp vec3","uSubspaceMatrix",s),r.addUniform("highp mat4","uModelViewProjection"),r.addUniform("highp float","uModelClipBounds",s*2),r.addUniform("highp uint","uPickID"),r.addVarying("highp uint","vPickID","flat"),r.addVertexCode(td),r.addVertexCode(`
vec3 defaultColor() { return uColor; }
highp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }
`),r.addFragmentCode(`
void emitAnnotation(vec4 color) {
  emit(color, vPickID);
}
`);const v=`
float getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${s}; ++i) {
    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${s} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}
`;r.addVertexCode(v),r.addFragmentCode(v),r.addVertexCode(`
vec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {
  vec3 result = vec3(0.0, 0.0, 0.0);
  for (int i = 0; i < ${s}; ++i) {
    result += uSubspaceMatrix[i] * modelPoint[i];
  }
  return result;
}

float getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${s}; ++i) {
    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${s} + i];
    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${s} + i];
    coefficient *= max(0.0, 1.0 - min(dA, dB));
  }
  return coefficient;
}

float getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${s}; ++i) {
    float a = modelPointA[i];
    float b = modelPointB[i];
    float c = uModelClipBounds[i];
    float x = clamp(c, min(a, b), max(a, b));
    float d = abs(x - c) * uModelClipBounds[${s} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}

`),ed(i,r),r.addVertexCode(`
const bool PROJECTION_VIEW = ${!this.targetIsSliceView};
bool ng_discardValue;
#define discard ng_discard()
void ng_discard() {
  ng_discardValue = true;
}
void setLineColor(vec4 startColor, vec4 endColor);
void setLineWidth(float width);

void setAxisColor(vec4 startColor, vec4 endColor);
void setAxisWidth(float width);
void setSphereColor(vec4 color);

void setEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerSize(float startSize, float endSize);
void setEndpointMarkerBorderWidth(float startSize, float endSize);

void setPointMarkerColor(vec4 color);
void setPointMarkerBorderColor(vec4 color);
void setPointMarkerSize(float size);
void setPointMarkerBorderWidth(float size);
void setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }

void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setAxisEndpointMarkerSize(float startSize, float endSize);
void setAxisEndpointMarkerBorderWidth(float startSize, float endSize);

void setAxisPointMarkerColor(vec4 color);
void setAxisPointMarkerBorderColor(vec4 color);
void setAxisPointMarkerSize(float size);
void setAxisPointMarkerBorderWidth(float size);

void setEllipsoidFillColor(vec4 color);

void setBoundingBoxBorderColor(vec4 color);
void setBoundingBoxBorderWidth(float size);
void setBoundingBoxFillColor(vec4 color);

void setEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }
void setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }
void setLineColor(vec4 color) { setLineColor(color, color); }
void setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }
void setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setAxisColor(vec4 color) { setAxisColor(color, color); }
void setAxisColor(vec3 color) { setAxisColor(vec4(color, 1.0)); }
void setAxisColor(vec3 startColor, vec3 endColor) { setAxisColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setAxisEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setAxisEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setAxisEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setAxisEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setAxisEndpointMarkerColor(vec3 color) { setAxisEndpointMarkerColor(color, color); }
void setAxisEndpointMarkerColor(vec4 color) { setAxisEndpointMarkerColor(color, color); }
void setAxisEndpointMarkerBorderColor(vec3 color) { setAxisEndpointMarkerBorderColor(color, color); }
void setAxisEndpointMarkerBorderColor(vec4 color) { setAxisEndpointMarkerBorderColor(color, color); }
void setAxisEndpointMarkerSize(float size) { setAxisEndpointMarkerSize(size, size); }
void setAxisEndpointMarkerBorderWidth(float size) { setAxisEndpointMarkerBorderWidth(size, size); }
void setColor(vec4 color) {
  setPointMarkerColor(color);
  setLineColor(color);
  setEndpointMarkerColor(color);
  setBoundingBoxBorderColor(color);
  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));
  setAxisColor(color);
  setAxisEndpointMarkerColor(color);
  setSphereColor(color);
}
void setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }

void setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }
void setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }

void setColor(vec3 color) { setColor(vec4(color, 1.0)); }
void userMain();
`);for(const C of Bv){var y=ae(C,2);const S=y[0],w=y[1];S!==this.annotationType&&w.defineShaderNoOpSetters(r)}t(r),r.addVertexCode(`
#define main userMain
`+Kl(i.parseResult.code)+`
#undef main
`)}})}setPartIndex(e,...t){let r=`
void setPartIndex(${t.map((i,s)=>`highp uint partIndex${s}`).join()}) {
  highp uint pickID = uPickID;
  highp uint pickBaseOffset = getPickBaseOffset();
${t.map((i,s)=>`highp uint pickOffset${s} = pickBaseOffset + partIndex${s};`).join(`
`)}
`;return t.length===0&&(r+=`
  highp uint pickOffset0 = pickBaseOffset;
`),r+=`
  vPickID = pickID + pickOffset0;
  highp uint selectedIndex = uSelectedIndex;
if (selectedIndex == pickBaseOffset${t.map((i,s)=>` || selectedIndex == pickOffset${s}`).join("")}) {
    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);
  }
}
`,e.addVertexCode(r),`setPartIndex(${t.join()})`}get invokeUserMain(){return`
ng_discardValue = false;
userMain();
if (ng_discardValue) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
`}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,r){var i=e(t.renderContext.emitter);const s=i.shader,a=i.parameters;if(s===null)return;s.bind();const l=this.gl,c=t.renderContext,u=t.annotationLayer;if(mo(l,s,this.shaderControlState,a.parseResult.controls),l.uniform3fv(s.uniform("uSubspaceMatrix"),t.subspaceMatrix),l.uniform1fv(s.uniform("uModelClipBounds"),t.modelClipBounds),l.uniformMatrix4fv(s.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),c.emitPickID&&l.uniform1ui(s.uniform("uPickID"),t.basePickId),c.emitColor){const g=u.state.displayState.color.value;l.uniform3f(s.uniform("uColor"),g[0],g[1],g[2]),l.uniform1ui(s.uniform("uSelectedIndex"),t.selectedIndex)}const h=s.vertexShaderInputBinders.properties;h.enable(1),l.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),h.bind(t.count,t.bufferOffset),r(s),h.disable()}}const Bv=new de;function Ed(n,e){Bv.set(n,e)}function $l(n){return Bv.get(n)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Fv=function(n,e,t,r){var i=arguments.length,s=i<3?e:r===null?r=Ar(e,t):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,r);else for(var l=n.length-1;l>=0;l--)(a=n[l])&&(s=(i<3?a(s):i>3?a(e,t,s):a(e,t))||s);return i>3&&s&&Mr(e,t,s),s};class ks{constructor(e){this.source=e,this.state=pt.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=pt.GPU_MEMORY}freeGPUMemory(e){this.state=pt.SYSTEM_MEMORY}}function KC(n){if(typeof n!="number"||n<0)throw new Error(`Expected non-negative number as limit, but received: ${ie(n)}`);return n}class Lc{constructor({defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}={}){this.sizeLimit=new Jt(t,KC),this.itemLimit=new Jt(e,KC)}}let Ng=class extends ei{constructor(n,e,t,r){super(),this.gl=e,this.frameNumberCounter=t,this.capacities=r,this.visibleChunksChanged=new we,this.pendingChunkUpdates=null,this.pendingChunkUpdatesTail=null,this.chunkUpdateDeadline=null,this.chunkUpdateDelay=30,this.enablePrefetch=new Ft(!0,!0);const i=s=>({itemLimit:this.registerDisposer(mn.makeFromExisting(n,s.itemLimit)).rpcId,sizeLimit:this.registerDisposer(mn.makeFromExisting(n,s.sizeLimit)).rpcId});this.initializeCounterpart(n,{gpuMemoryCapacity:i(r.gpuMemory),systemMemoryCapacity:i(r.systemMemory),downloadCapacity:i(r.download),computeCapacity:i(r.compute),enablePrefetch:this.registerDisposer(mn.makeFromExisting(n,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){let n=this.chunkUpdateDeadline,e;n===null||Date.now()<n?e=0:e=this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),e)}processPendingChunkUpdates(n=!1){let e=this.chunkUpdateDeadline;!n&&e===null&&(e=Date.now()+30);let t=!1,r=0;for(;;){if(!n&&Date.now()>e){this.chunkUpdateDeadline=null,setTimeout(()=>this.processPendingChunkUpdates(),this.chunkUpdateDelay);break}let i=this.pendingChunkUpdates;if(i==null)break;if(this.applyChunkUpdate(i)&&(t=!0),++r,(this.pendingChunkUpdates=i.nextUpdate)==null){this.pendingChunkUpdatesTail=null;break}}return t&&this.visibleChunksChanged.dispatch(),r}handleFetch_(n,e){var t=e.promise;const r=t.resolve,i=t.reject;if(t.cancellationToken.isCanceled){i(ms);return}const s=e.key,a=n.chunks.get(s);if(!a){i(new Error(`No chunk found at ${s} for source ${n.constructor.name}`));return}const l=a.data;if(!l){i(new Error(`At ${s} for source ${n.constructor.name}: chunk has no data`));return}r({value:l})}applyChunkUpdate(n){let e=!1;const t=this.rpc.get(n.source);if(n.promise!==void 0)this.handleFetch_(t,n);else if(n.id===void 0){for(const r of t.chunks.keys())t.deleteChunk(r);e=!0}else{let r=n.state;if(r===pt.EXPIRED)t.deleteChunk(n.id);else{let i,s=n.id;n.new?(i=t.getChunk(n),t.addChunk(s,i)):i=t.chunks.get(s);let a=i.state;if(r!==a)switch(r){case pt.GPU_MEMORY:i.copyToGPU(this.gl),e=!0;break;case pt.SYSTEM_MEMORY:i.freeGPUMemory(this.gl);break;default:throw new Error(`INTERNAL ERROR: Invalid chunk state: ${pt[r]}`)}}}return e}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){const n=this.rpc,e=await n.promiseInvoke(tO,{queue:this.rpcId}),t=new de;for(const i of e){var r=ae(i,2);const s=r[0],a=r[1],l=n.get(s);l!==void 0&&t.set(l,a)}return t}};Ng=Fv([hr(Z3)],Ng);function FL(n,e){let t=n.get(e.source),r=t.chunkManager.chunkQueueManager;if(t.immediateChunkUpdates){r.applyChunkUpdate(e)&&r.visibleChunksChanged.dispatch();return}let i=r.pendingChunkUpdatesTail;i==null?(r.pendingChunkUpdates=e,r.pendingChunkUpdatesTail=e,r.scheduleChunkUpdate()):(i.nextUpdate=e,r.pendingChunkUpdatesTail=e)}Tt("Chunk.update",function(n){FL(this,n)});lL("Chunk.retrieve",function(n,e){return new xt((t,r)=>{n.promise={resolve:t,reject:r,cancellationToken:e},FL(this,n)})});Tt(nO,function(n){const e=this.get(n.id);for(const t of e.prevStatisticsLayers)t.numVisibleChunksNeeded=0,t.numVisibleChunksAvailable=0,t.numPrefetchChunksNeeded=0,t.numPrefetchChunksAvailable=0;e.prevStatisticsLayers.length=0;for(const t of n.layers){const r=this.get(t.id);if(r===void 0)continue;const i=r.layerChunkProgressInfo;i.numVisibleChunksAvailable=t.numVisibleChunksAvailable,i.numVisibleChunksNeeded=t.numVisibleChunksNeeded,i.numPrefetchChunksAvailable=t.numPrefetchChunksAvailable,i.numPrefetchChunksNeeded=t.numPrefetchChunksNeeded,e.prevStatisticsLayers.push(i)}e.layerChunkStatisticsUpdated.dispatch()});let Vg=class extends ei{constructor(n){super(),this.chunkQueueManager=n,this.memoize=new Jk,this.prevStatisticsLayers=[],this.layerChunkStatisticsUpdated=new we,this.registerDisposer(n.addRef()),this.initializeCounterpart(n.rpc,{chunkQueueManager:n.rpcId})}get gl(){return this.chunkQueueManager.gl}getChunkSource(n,e){const t=n.encodeOptions(e);t.constructorId=ln(n);const r=lr(t);return this.memoize.get(r,()=>{const i=new n(this,e);return i.initializeCounterpart(this.rpc,{}),i.key=t,i})}};Vg=Fv([hr(Q3)],Vg);class Oi extends ei{constructor(e,t={}){super(),this.chunkManager=e,this.chunks=new de,this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){const t=this.chunks.get(e);t.state===pt.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw new Error("Not implemented.")}invalidateCache(){this.rpc.invoke(eO,{id:this.rpcId})}static encodeOptions(e){return{}}}function Dt(n,e){let t=class extends n{constructor(...r){super(...r);const i=r[1];this.parameters=i.parameters}initializeCounterpart(r,i){i.parameters=this.parameters,super.initializeCounterpart(r,i)}static encodeOptions(r){return j({parameters:r.parameters},super.encodeOptions(r))}};return t=Fv([hr(e.RPC_ID)],t),t}class Td extends ei{constructor(e){super(),this.layerChunkProgressInfo=e}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Dr;(function(n){n[n.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",n[n.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",n[n.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",n[n.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED"})(Dr||(Dr={}));class dF{}class cF extends K{constructor(e,t,r){super(),this.graph=e,this.segmentsState=t,this.transform=r}createRenderLayers(e,t,r){return[]}}function uF(n){return!(n.high>>>31)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const hF=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function pF(n,e,t){n.registerDisposer(e.visibleSegments.changed.add(t)),n.registerDisposer(e.segmentEquivalences.changed.add(t))}function fF(n,e,t){n.registerDisposer(e.temporaryVisibleSegments.changed.add(t)),n.registerDisposer(e.temporarySegmentEquivalences.changed.add(t)),n.registerDisposer(e.useTemporaryVisibleSegments.changed.add(t)),n.registerDisposer(e.useTemporarySegmentEquivalences.changed.add(t))}function Jr(n){return`${n.low},${n.high}`}function gF(n){return!!(n.high>>>31)}function _L(n){return n.useTemporaryVisibleSegments.value?n.temporaryVisibleSegments:n.visibleSegments}function mF(n){return n.useTemporarySegmentEquivalences.value?n.temporarySegmentEquivalences:n.segmentEquivalences}function Bo(n,e){const t=_L(n),r=mF(n);if(r.disjointSets){const i=r.disjointSets.visibleSegmentEquivalencePolicy.value;for(let s of t.unsafeKeys())if(i&Dr.NONREPRESENTATIVE_EXCLUDED){const a=r.get(s);e(s,a)}else{if(r.disjointSets===void 0||!r.disjointSets.isMinElement(s))continue;for(let a of r.setElements(s))i&Dr.REPRESENTATIVE_EXCLUDED&&i&Dr.MAX_REPRESENTATIVE&&gF(a)||e(a,s)}}}const Ht=40,UL=.5,$L=-4;function Hc(n){return(Un(n)-$L)/UL}function vF(n){return 2**(n*UL+$L)}function ta(n){return new Jt(n,yn)}class vo{constructor(){this.visibility=new Xl,this.changed=new we,this.frameNumber=-1,this.spatialScales=new de,this.numHistogramRows=1,this.value=new Uint32Array(Ht*this.numHistogramRows*2)}begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.changed.dispatch())}add(e,t,r,i){let s=this.spatialScales,a=this.numHistogramRows,l=this.value,c=s.get(e);if(c===void 0&&(c=s.size,s.set(e,c)),c>=a){this.numHistogramRows=a*=2;const h=new Uint32Array(a*Ht*2);h.set(l),this.value=l=h}const u=c*Ht*2+Math.min(Math.max(0,Math.round(Hc(t))),Ht-1);l[u]+=r,l[u+Ht]+=i}}class _v extends uL{constructor(e,t,r){var i;super(),this.chunkManager=e,this.multiscaleSource=t,this.rpcId=null,this.rpcTransfer={},this.visibleSources=new de,this.visibleSourcesList_=[];var s=r.renderScaleTarget;const a=s===void 0?ta(1):s;this.renderScaleTarget=a,this.renderScaleHistogram=r.renderScaleHistogram,this.transform=r.transform,this.localPosition=r.localPosition,this.rpcTransfer=r.rpcTransfer||{},this.dataHistogramSpecifications=this.registerDisposer((i=r.dataHistogramSpecifications)!==null&&i!==void 0?i:new TL(Zs([]),Zs([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}getDataHistogramCount(){const e=this.dataHistogramSpecifications;return e.visibility.visible?e.bounds.value.length:0}getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){const r=this.visibleSources,i=r.get(e);i!==void 0?(++i.refCount,i.chunkTransform=t):(r.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){const t=this.visibleSources,r=t.get(e);r.refCount!==1?--r.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){const e=this.visibleSources,t=this.visibleSourcesList_;if(t.length===0&&e.size!==0){for(const r of e.values())t.push(r);t.sort((r,i)=>r.chunkTransform.chunkToLayerTransformDet-i.chunkTransform.chunkToLayerTransformDet)}return t}initializeCounterpart(){const e=this.registerDisposer(new Td(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,j({localPosition:this.registerDisposer(mn.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(mn.makeFromExisting(t,this.renderScaleTarget)).rpcId},this.rpcTransfer)),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return GB(e,this,t)}}_v.prototype.RPC_TYPE_ID=jB;class yo extends hL{draw(e,t){}isReady(e,t){return!0}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var yF=function(n,e,t,r){var i=arguments.length,s=i<3?e:r===null?r=Ar(e,t):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,r);else for(var l=n.length-1;l>=0;l--)(a=n[l])&&(s=(i<3?a(s):i>3?a(e,t,s):a(e,t))||s);return i>3&&s&&Mr(e,t,s),s};class bF extends _B{}const wF=oh(bF);function SF(n){return{source:n.source.addCounterpartRef(),effectiveVoxelSize:n.effectiveVoxelSize,layerRank:n.layerRank,nonDisplayLowerClipBound:n.nonDisplayLowerClipBound,nonDisplayUpperClipBound:n.nonDisplayUpperClipBound,lowerClipBound:n.lowerClipBound,upperClipBound:n.upperClipBound,lowerClipDisplayBound:n.lowerClipDisplayBound,upperClipDisplayBound:n.upperClipDisplayBound,chunkDisplayDimensionIndices:n.chunkDisplayDimensionIndices,lowerChunkDisplayBound:n.lowerChunkDisplayBound,upperChunkDisplayBound:n.upperChunkDisplayBound,fixedLayerToChunkTransform:n.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:n.combinedGlobalLocalToChunkTransform,chunkLayout:n.chunkLayout.toObject()}}function Uv(n){return n.map(e=>e.map(SF))}function Tf(n,e){for(const t of e)for(const r of t){const i=r.source;n.removeSource(i),i.dispose()}}let mu=class extends wF{constructor(n,e,t,r){super(new pL({parametersConstructor:BB,navigationState:t,update:(a,l)=>{const c=a.invViewMatrix,u=a.centerDataPosition;l.toMat4(c);var h=a.displayDimensionRenderInfo;const g=h.canonicalVoxelFactors,v=h.voxelPhysicalScales;for(let L=0;L<3;++L)u[L]=c[12+L];const y=a.logicalWidth,C=a.logicalHeight,S=a.projectionMat,w=a.viewportNormalInGlobalCoordinates,E=a.viewportNormalInCanonicalCoordinates,k=l.relativeDepthRange;QT(S,-y/2,y/2,C/2,-C/2,-k,k),Yk(a,S),eL(a);const P=a.viewMatrix;for(let L=0;L<3;++L){const R=w[L]=P[L*4+2];E[L]=R/g[L]}eu(w,w),eu(E,E);let D=0;for(let L=0;L<3;++L){const R=v[L],M=c[L];D+=(R*M)**2}D=Math.sqrt(D),a.pixelSize=D}})),this.chunkManager=n,this.layerManager=e,this.navigationState=t,this.wireFrame=r,this.gl=this.chunkManager.gl,this.viewChanged=new we,this.renderingStale=!0,this.visibleChunksStale=!0,this.visibleLayerList=new Array,this.offscreenFramebuffer=this.registerDisposer(new fo(this.gl,{colorBuffers:fu(this.gl,1),depthBuffer:new KO(this.gl)})),this.histogramInputTextures=[],this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer],this.histogramGenerator=Dv.get(this.gl),this.updateVisibleLayers=this.registerCancellable(rt(()=>{this.updateVisibleLayersNow()},0)),this.registerDisposer(t),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add((a,l)=>{a.displayDimensionRenderInfo!==l.displayDimensionRenderInfo&&this.updateVisibleLayers()}));const i=this.chunkManager.rpc,s=this.sharedProjectionParameters=this.registerDisposer(new pu(i,this.projectionParameters));this.initializeCounterpart(i,{chunkManager:n.rpcId,projectionParameters:s.rpcId}),this.registerDisposer(e.layersChanged.add(()=>{this.updateVisibleLayers()})),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add(()=>{this.renderingStale=!0}),this.registerDisposer(n.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}computeHistograms(n,e){this.histogramGenerator.compute(n,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,e,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}forEachVisibleChunk(n,e,t){JB(this.projectionParameters.value,n.renderLayer.localPosition.value,n,e,()=>{t(n.curPositionInChunks.join())})}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let n=0,e=0;for(const t of this.visibleLayers.values()){const r=t.visibleSources;for(const i of r){const s=Ov(this.projectionParameters.value,i.chunkLayout),a=i.source.chunks;this.forEachVisibleChunk(i,s,l=>{const c=a.get(l);++e,c&&c.state===pt.GPU_MEMORY&&++n})}}return n===e}invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(n,e){e.push(n.localPosition.changed.add(()=>this.invalidateVisibleChunks())),e.push(n.redrawNeeded.add(this.viewChanged.dispatch)),e.push(n.transform.changed.add(this.updateVisibleLayers)),e.push(n.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()));const t=n.renderScaleHistogram;t!==void 0&&e.push(t.visibility.add(this.visibility)),e.push(n.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;const n=Date.now(),e=this.visibleLayers,t=this.visibleLayerList,r=this.projectionParameters.value.displayDimensionRenderInfo;let i=this.rpc,s={id:this.rpcId},a=!1;t.length=0;for(let c of this.layerManager.readyRenderLayers())if(c instanceof _v){t.push(c);let u=e.get(c);if(u===void 0){const h=[],g=new Vo;u={messages:g,allSources:this.getTransformedSources(c,g),transformGeneration:c.transform.changed.count,visibleSources:[],disposers:h,lastSeenGeneration:n,displayDimensionRenderInfo:r},h.push(c.messages.addChild(u.messages)),e.set(c.addRef(),u),this.bindVisibleRenderLayer(c,h)}else{u.lastSeenGeneration=n;const h=c.transform.changed.count;if(u.transformGeneration===h&&u.displayDimensionRenderInfo===r)continue;const g=u.allSources;u.allSources=this.getTransformedSources(c,u.messages),Tf(c,g),u.visibleSources.length=0,u.displayDimensionRenderInfo=r,u.transformGeneration=h}s.layerId=c.rpcId,s.sources=Uv(u.allSources),this.flushBackendProjectionParameters(),i.invoke(HB,s),a=!0}for(const c of e){var l=ae(c,2);const u=l[0],h=l[1];h.lastSeenGeneration!==n&&(s.layerId=u.rpcId,i.invoke(qB,s),e.delete(u),Tf(u,h.allSources),so(h.disposers),u.dispose(),a=!0)}return a&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),a}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(n){const e=this.offscreenFramebuffersWithHistograms;let t=e[n];if(t===void 0){const r=this.gl,i=this.histogramInputTextures,s=this.offscreenFramebuffer;i.length<n&&i.push(...fu(r,n-i.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));let a=[s.colorBuffers[0].addRef()];for(let l=0;l<n;++l)a.push(i[l].addRef());t=this.registerDisposer(new fo(r,{colorBuffers:a,depthBuffer:s.depthBuffer.addRef()})),e[n]=t}return t}updateRendering(){const n=this.projectionParameters.value,e=n.width,t=n.height;if(!this.renderingStale||!this.valid||e===0||t===0)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();let r=this.gl,i=this.offscreenFramebuffer;i.bind(e,t),r.disable(r.SCISSOR_TEST),r.clearColor(0,0,0,0),r.colorMask(!0,!0,!0,!0),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let s=0;const a=this.wireFrame.value,l={sliceView:this,projectionParameters:n,wireFrame:a};for(let c of this.visibleLayerList){const u=a?0:c.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(u).bind(e,t);for(let h=0;h<u;++h)r.clearBufferfv(WebGL2RenderingContext.COLOR,1+h,fg);r.enable(WebGL2RenderingContext.DEPTH_TEST),r.depthFunc(WebGL2RenderingContext.LESS),r.clearDepth(1),r.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),c.setGLBlendMode(r,s),c.draw(l),++s}r.disable(WebGL2RenderingContext.BLEND),r.disable(WebGL2RenderingContext.DEPTH_TEST),i.unbind()}disposed(){for(const e of this.visibleLayers){var n=ae(e,2);const t=n[0],r=n[1];Tf(t,r.allSources),so(r.disposers),t.dispose()}this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(n,e){const t=$v(this.projectionParameters.value.displayDimensionRenderInfo,n.transform.value,r=>n.getSources(r),e,n);for(const r of t)for(const i of r)n.addSource(i.source,i.chunkTransform);return t}};mu=yF([hr(WB)],mu);class zL extends Oi{constructor(e,t){super(e,t),this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:Te(e.chunkDataSize),lowerVoxelBound:Te(e.lowerVoxelBound),upperVoxelBound:Te(e.upperVoxelBound)}}static encodeOptions(e){const t=super.encodeOptions(e);return t.spec=this.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}}class GL extends ks{constructor(e,t){super(e),this.chunkGridPosition=t.chunkGridPosition,this.state=pt.SYSTEM_MEMORY}}let WL=class jL extends K{constructor(e,t){super(),this.gl=e,this.copyVertexPositionsBuffer=Ql(this.gl),this.textureCoordinateAdjustment=new Float32Array(4);let r=new ea(e);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler"),r.addInitializer(i=>{e.uniform1i(i.uniform("uSampler"),0)}),r.addUniform("vec4","uColorFactor"),r.addUniform("vec4","uBackgroundColor"),r.addUniform("mat4","uProjectionMatrix"),r.addUniform("vec4","uTextureCoordinateAdjustment"),r.require(t),r.setFragmentMain(`
vec4 sampledColor = texture(uSampler, vTexCoord);
if (sampledColor.a == 0.0) {
  sampledColor = uBackgroundColor;
}
emit(sampledColor * uColorFactor, 0u);
`),r.addAttribute("vec4","aVertexPosition"),r.setVertexMain(`
vTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;
gl_Position = uProjectionMatrix * aVertexPosition;
`),this.shader=this.registerDisposer(r.build())}draw(e,t,r,i,s,a,l,c){let u=this.gl,h=this.shader,g=this.textureCoordinateAdjustment;g[0]=s,g[1]=a,g[2]=l-s,g[3]=c-a,h.bind(),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,e),u.disable(WebGL2RenderingContext.BLEND),u.uniformMatrix4fv(h.uniform("uProjectionMatrix"),!1,t),u.uniform4fv(h.uniform("uColorFactor"),r),u.uniform4fv(h.uniform("uBackgroundColor"),i),u.uniform4fv(h.uniform("uTextureCoordinateAdjustment"),g);let v=h.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(v,2),u.drawArrays(u.TRIANGLE_FAN,0,4),u.disableVertexAttribArray(v),u.bindTexture(u.TEXTURE_2D,null)}static get(e,t){return e.memoize.get(`sliceview/SliceViewRenderHelper:${ln(t)}`,()=>new jL(e,t))}};class CF{constructor(e){this.chunkManager=e}}function $v(n,e,t,r,i){r.clearMessages();const s=E=>(r.addMessage({severity:Kr.error,message:E}),[]);if(e.error!==void 0)return s(e.error);const a=e.rank,l=e.unpaddedRank,c=n.displayDimensionIndices,u=n.displayRank,h=n.canonicalVoxelFactors,g=Gk(e,c),v=g.displayToLayerDimensionIndices,y=new Float32Array(u*l),C=e.modelToRenderLayerTransform;for(let E=0;E<u;++E){const k=v[E];if(k===-1)continue;const P=h[E];for(let D=0;D<l;++D)y[u*D+E]=C[(a+1)*D+k]*P}const S=t({displayRank:u,multiscaleToViewTransform:y,modelChannelDimensionIndices:e.channelToRenderLayerDimensions}),w=n.voxelPhysicalScales;try{const E=k=>{const P=k.chunkSource,D=P.spec;var L=k.lowerClipBound;const R=L===void 0?D.lowerVoxelBound:L;var M=k.upperClipBound;const V=M===void 0?D.upperVoxelBound:M,B=zk(e,k.chunkToMultiscaleTransform),_=D.chunkDataSize,H=B.channelToChunkDimensionIndices,U=new Float32Array(l),O=new Float32Array(l);U.set(R),O.set(V);const z=H.length,F=e.channelSpaceShape;for(let Ue=0;Ue<z;++Ue){const Ce=H[Ue];if(Ce===-1)continue;const Ye=F[Ue];if(_[Ce]!==Ye)throw new Error("Channel dimension "+e.layerDimensionNames[e.channelToRenderLayerDimensions[Ue]]+` has extent ${Ye} but corresponding chunk dimension has extent ${_[Ce]}`);U[Ce]=Number.NEGATIVE_INFINITY,O[Ce]=Number.POSITIVE_INFINITY}const se=Wk(B,g),oe=Ne(),Re=Ne(),le=Ne(),Se=Ne(),ne=Ne(),he=se.numChunkDisplayDims,Le=se.chunkDisplayDimensionIndices,_e=B.combinedGlobalLocalToChunkTransform,Ge=B.layerRank,De=B.combinedGlobalLocalRank,Ee=new Float32Array(_e);for(let Ue=0;Ue<he;++Ue){const Ce=Le[Ue];for(let Ye=0;Ye<=De;++Ye)Ee[Ce+Ye*Ge]=0;Ce<l?(ne[Ue]=D.chunkDataSize[Ce],oe[Ue]=D.lowerChunkBound[Ce],Re[Ue]=D.upperChunkBound[Ce],le[Ue]=R[Ce],Se[Ue]=V[Ce],U[Ce]=Number.NEGATIVE_INFINITY,O[Ce]=Number.POSITIVE_INFINITY):(ne[Ue]=1,oe[Ue]=0,Re[Ue]=1,le[Ue]=0,Se[Ue]=1)}ne.fill(1,he),oe.fill(0,he),Re.fill(1,he),le.fill(0,he),Se.fill(1,he);const Me=new uh(ne,se.displaySubspaceModelMatrix,he),Fe=Me.localSpatialVectorToGlobal(Ne(),ak);for(let Ue=0;Ue<u;++Ue)Fe[Ue]=Math.abs(Fe[Ue]*w[Ue]);return Fe.fill(1,u),{layerRank:Ge,lowerClipBound:R,upperClipBound:V,nonDisplayLowerClipBound:U,nonDisplayUpperClipBound:O,renderLayer:i,source:P,lowerChunkDisplayBound:oe,upperChunkDisplayBound:Re,lowerClipDisplayBound:le,upperClipDisplayBound:Se,effectiveVoxelSize:Fe,chunkLayout:Me,chunkDisplayDimensionIndices:Le,fixedLayerToChunkTransform:Ee,curPositionInChunks:new Float32Array(l),combinedGlobalLocalToChunkTransform:B.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(l),chunkTransform:B,chunkDisplayTransform:se}};return S.map(k=>k.map(P=>E(P)))}catch(E){for(const D of S)for(const L of D)L.chunkSource.dispose();const k=n.globalDimensionNames,P=`Cannot render (${Te(n.displayDimensionIndices.filter(D=>D!==-1),D=>k[D]).join(", ")}) cross section: ${E.message}`;return s(P)}}let Gs=null;/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var xF=200;class Ke{constructor(e=!1){if(Gs===null){Gs=document.createElement("ul"),Gs.id="statusContainer";const r=document.getElementById("neuroglancer-container");r?r.appendChild(Gs):document.body.appendChild(Gs)}let t=document.createElement("li");this.element=t,e===!0&&(e=xF),e!==!1?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null,Gs.appendChild(t)}dispose(){Gs.removeChild(this.element),this.element=void 0,this.timer!==null&&clearTimeout(this.timer)}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setVisible(e){this.timer!==null&&(clearTimeout(this.timer),this.timer=null),this.element.style.display=e?"block":"none"}static forPromise(e,t){let r=new Ke(t.delay);r.setText(t.initialMessage);let i=r.dispose.bind(r);return e.then(i,s=>{let a;s instanceof Error?a=s.message:a=""+s;var l=t.errorPrefix;let c=l===void 0?"":l;r.setErrorMessage(c+a),r.setVisible(!0)}),e}setErrorMessage(e){this.element.textContent=e+" ";let t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",()=>{this.dispose()}),this.element.appendChild(t)}static showMessage(e){const t=new Ke;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e,t=2e3){const r=this.showMessage(e);return window.setTimeout(()=>r.dispose(),t),r}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var zv=function(n,e,t,r){var i=arguments.length,s=i<3?e:r===null?r=Ar(e,t):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,r);else for(var l=n.length-1;l>=0;l--)(a=n[l])&&(s=(i<3?a(s):i>3?a(e,t,s):a(e,t))||s);return i>3&&s&&Mr(e,t,s),s};function HL(n){let e=0;const t=n.typeToIds;for(const r of Li)e+=$l(r).pickIdsPerInstance*t[r].length;return e}class qL{constructor(e){this.bufferValid=!1,this.numPickIds=0,this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){const t=this.buffer;t!==void 0&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}}class EF extends ks{constructor(e,t){super(e),t.data!==void 0&&(this.data=new qL(t))}freeGPUMemory(e){super.freeGPUMemory(e);const t=this.data;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}class JL extends GL{constructor(e,t){super(e,t),t.data!==void 0&&(this.data=new qL(t))}freeGPUMemory(e){super.freeGPUMemory(e);const t=this.data;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}let bo=class extends zL{constructor(n,e){super(n,e),this.immediateChunkUpdates=!0,(this.parent=e.parent).spatiallyIndexedSources.add(this);var t=this.spec;const r=t.rank,i=t.chunkDataSize,s=this.multiscaleToChunkTransform=new Float32Array((r+1)**2);hv(s,r+1,this.spec.chunkToMultiscaleTransform,r+1,r+1);for(let a=0;a<r;++a)for(let l=0;l<r+1;++l)s[(r+1)*l+a]/=i[a]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(n,e){e.parent=this.parent.rpcId,super.initializeCounterpart(n,e)}addChunk(n,e){super.addChunk(n,e)}getChunk(n){return new JL(this,n)}};bo=zv([hr(XB)],bo);let Og=class extends Oi{constructor(n,e,t){super(n,{}),this.parent=e,this.relationshipIndex=t,this.immediateChunkUpdates=!0}addChunk(n,e){super.addChunk(n,e)}getChunk(n){return new EF(this,n)}};Og=zv([hr(KB)],Og);class TF extends ks{constructor(e,t){super(e),this.annotation=dv(t.annotation)}}let Bg=class extends Oi{constructor(n,e){super(n),this.parent=e}getChunk(n){return new TF(this,n)}addChunk(n,e){super.addChunk(n,e);const t=this.parent.references.get(n);t!==void 0&&(t.value=e.annotation,t.changed.dispatch())}deleteChunk(n){const e=this.parent.references.get(n);e!==void 0&&(e.value=void 0,e.changed.dispatch())}};Bg=zv([hr(YB)],Bg);function YL(n,e,t,r){const i=new Uint8Array(n.data.length+r);for(const s of Li){if(s===t)continue;let a=n.typeToOffset[s],l=a;s>t&&(l+=r,n.typeToOffset[s]=l),i.set(n.data.subarray(a,a+n.typeToIds[s].length*e[s].serializedBytes),l)}return i}function Fg(n,e,t,r,i,s,a,l){const c=n.typeToOffset[t];let u=c,h=c;const g=e[t].propertyGroupBytes,v=g.length,y=n.typeToIds[t].length;for(let C=0;C<v;++C){const S=g[C];r.set(n.data.subarray(u+i*S,u+s*S),h+a*S),u+=S*y,h+=S*l}}function Ic(n,e,t){const r=e.type,i=t[r].rank,s=n.serializedAnnotations,a=s.typeToIds[r],l=s.typeToIdMaps[r],c=Dn[r],u=t[r].serializedBytes;let h=l.get(e.id);if(h===void 0){h=l.size,l.set(e.id,h);const S=YL(s,t,r,u);Fg(s,t,r,S,0,h,0,h+1),a.push(e.id),s.data=S}const g=s.typeToOffset[r],v=new DataView(s.data.buffer,s.data.byteOffset,s.data.byteLength),y=pd===Jn.LITTLE,C=t[r];c.serialize(v,g+C.propertyGroupBytes[0]*h,y,i,e),C.serialize(v,g,h,a.length,y,e.properties),n.bufferValid=!1}function Dc(n,e,t,r){const i=n.serializedAnnotations,s=i.typeToIdMaps[e],a=s.get(t);if(a===void 0)return!1;const l=i.typeToIds[e],c=r[e].serializedBytes,u=YL(i,r,e,-c);Fg(i,r,e,u,0,a,0,l.length-1),Fg(i,r,e,u,a+1,l.length,a,l.length-1),l.splice(a,1),s.delete(t);for(let h=a,g=l.length;h<g;++h)s.set(l[h],h);return i.data=u,n.bufferValid=!1,!0}function kF(){const n=[],e=[],t=[];for(const r of Li)n[r]=[],e[r]=0,t[r]=new de;return new JL(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:e,typeToIds:n,typeToIdMaps:t})}class Pr extends ei{constructor(e,t){super(),this.chunkManager=e,this.metadataChunkSource=this.registerDisposer(new Bg(this.chunkManager,this)),this.spatiallyIndexedSources=new ze,this.temporary=kF(),this.references=new de,this.localUpdates=new de,this.numCommitsInProgress=0,this.changed=new we,this.referencesChanged=new Ze,this.readonly=!1,this.childRefreshed=new we,this.rank=t.rank,this.properties=t.properties,this.annotationPropertySerializers=ov(this.rank,this.properties);const r=this.segmentFilteredSources=[],i=t.relationships;this.relationships=i;for(let s=0,a=i.length;s<a;++s)r.push(this.registerDisposer(new Og(e,this,s)))}hasNonSerializedProperties(){return this.relationships.length>0}getSources(e){throw new Error("not implemented")}initializeCounterpart(e,t){this.metadataChunkSource.initializeCounterpart(e,{});for(const r of this.segmentFilteredSources)r.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map(r=>r.addCounterpartRef()),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e,t=!0){e.id=lv();const r=new Gc(e.id);return r.value=e,this.references.set(r.id,r),this.referencesChanged.dispatch({action:"adding",id:r.id}),r.registerDisposer(()=>{this.references.delete(r.id),this.referencesChanged.dispatch({action:"deref",id:r.id})}),this.applyLocalUpdate(r,!1,t,e),r}applyLocalUpdate(e,t,r,i){const s=this.localUpdates,a=e.id;let l=this.localUpdates.get(a);const c=e.value;if(c==null)throw new Error("Cannot create local update from null annotation");if(l===void 0?(l={type:c.type,reference:e.addRef(),existingAnnotation:t?c:void 0,pendingCommit:void 0,commitInProgress:void 0},s.set(a,l),this.forEachPossibleChunk(c,u=>{const h=u.data;if(h===void 0)return;const g=c.type;Dc(h,g,a,this.annotationPropertySerializers)}),i!==null&&Ic(this.temporary.data,i,this.annotationPropertySerializers)):(i===null?Dc(this.temporary.data,c.type,c.id,this.annotationPropertySerializers):Ic(this.temporary.data,i,this.annotationPropertySerializers),e.value=i),r)if(l.commitInProgress!==void 0)l.pendingCommit=i;else{if(i===null&&l.existingAnnotation===void 0){s.delete(a),l.reference.dispose();return}this.sendCommitRequest(l,i)}this.notifyChanged(e.id,i||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke(eF,{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){const r=this.references.get(e),i=this.metadataChunkSource.chunks.get(e);i!==void 0&&(i.annotation=t||null),r!==void 0&&(r.value=t||null,r.changed.dispatch(),this.referencesChanged.dispatch({action:"changed",id:e})),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}updateReference(e){let t=this.references.get(e.id);if(t!==void 0)t.value=e;else{let r=new Gc(e.id);this.references.set(e.id,r),r.value=e,this.referencesChanged.dispatch({action:"update",id:r.id}),r.registerDisposer(()=>{this.references.delete(r.id),this.referencesChanged.dispatch({action:"deref",id:r.id})})}}hasReference(e){return this.references.has(e)}getReference(e){let t=this.references.get(e);if(t!==void 0)return t.addRef();t=new Gc(e),this.references.set(e,t),this.referencesChanged.dispatch({action:"get",id:e}),this.rpc.invoke(ZB,{id:this.rpcId,annotation:e}),t.registerDisposer(()=>{this.references.delete(e),this.referencesChanged.dispatch({action:"deref",id:e}),this.rpc.invoke(QB,{id:this.rpcId,annotation:e})});const r=this.metadataChunkSource.chunks.get(e);return r!==void 0&&r.annotation!==null&&(t.value=r.annotation),t}forEachPossibleChunk(e,t){const r=e.relatedSegments;if(r!==void 0){const c=r.length,u=this.segmentFilteredSources;for(let h=0;h<c;++h){const g=r[h];if(g===void 0)return;const v=u[h];for(const y of g){const C=v.chunks.get(Jr(y));C!==void 0&&t(C)}}}const i=this.rank,s=new Float32Array(i),a=new Float32Array(i),l=new Float32Array(i);for(const c of this.spatiallyIndexedSources){switch(e.type){case Pe.POINT:Ti(s,c.multiscaleToChunkTransform,i+1,e.point,i),a.set(s);break;case Pe.LINE:case Pe.SPHERE:case Pe.AXIS_ALIGNED_BOUNDING_BOX:Ti(s,c.multiscaleToChunkTransform,i+1,e.pointA,i),Ti(a,c.multiscaleToChunkTransform,i+1,e.pointB,i);break;case Pe.ELLIPSOID:Ti(s,c.multiscaleToChunkTransform,i+1,e.center,i),xk(a,c.multiscaleToChunkTransform,i+1,e.radii,i);for(let g=0;g<i;++g){const v=s[g],y=a[g];s[g]=v-y,a[g]=v+y}break}let u=1;for(let g=0;g<i;++g){const v=s[g],y=a[g],C=Math.min(v,y),S=Math.max(v,y);s[g]=Math.ceil(C-1),a[g]=Math.floor(S+1),u*=a[g]-s[g]}const h=c.chunks;for(let g=0;g<u;++g){let v=g;for(let C=0;C<i;++C){const S=s[C],w=a[C]-S,E=l[C]=v%w;v=(v-E)/w}const y=h.get(l.join());y!==void 0&&t(y)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){const r=this.localUpdates.get(e);if(r===void 0||r.commitInProgress===void 0)throw new Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),t!==null&&r.reference.id!==t.id){if(r.commitInProgress===null)throw new Error("Received invalid successful update notification");r.reference.id=t.id,this.references.delete(e),this.references.set(t.id,r.reference.addRef()),this.localUpdates.delete(e),this.localUpdates.set(t.id,r),r.reference.value!==null&&(r.reference.value.id=t.id,Dc(this.temporary.data,r.type,e,this.annotationPropertySerializers),Ic(this.temporary.data,r.reference.value,this.annotationPropertySerializers)),r.reference.changed.dispatch()}let i=r.existingAnnotation===void 0;r.existingAnnotation=t||void 0,r.commitInProgress=void 0;let s=r.pendingCommit;r.pendingCommit=void 0,t===null&&(s=void 0),s!==void 0?(s!==null&&(s.id=t.id),this.sendCommitRequest(r,s)):(this.revertLocalUpdate(r),i?(this.childAdded.dispatch(t),this.referencesChanged.dispatch({action:"added",id:t.id})):t===null?(this.references.get(e).dispose(),this.childDeleted.dispatch(e),this.referencesChanged.dispatch({action:"deleted",id:e})):(this.childUpdated.dispatch(t),this.referencesChanged.dispatch({action:"updated",id:t.id})))}disposed(){const e=this.commitStatus;e!==void 0&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,this.numCommitsInProgress===0?this.commitStatus!==void 0&&(this.commitStatus.dispose(),this.commitStatus=void 0):this.commitStatus===void 0&&(this.commitStatus=new Ke(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){const r=this.localUpdates.get(e);if(r===void 0||r.commitInProgress===void 0)throw new Error("Received invalid update notification");new Ke().setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(r),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){Dc(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializers);const t=e.existingAnnotation;t!==void 0&&this.forEachPossibleChunk(t,s=>{const a=s.data;a!==void 0&&Ic(a,t,this.annotationPropertySerializers)});const r=e.reference,i=r.id;r.value=t||null,r.changed.dispatch(),r.dispose(),this.localUpdates.delete(i)}*[An](){}}Tt(tF,function(n){const e=this.get(n.id),t=n.annotationId,r=n.error;if(r!==void 0)e.handleFailedUpdate(t,r);else{const i=dv(n.newAnnotation);e.handleSuccessfulUpdate(t,i)}});/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function kd(n,e){return n<e?-1:n>e?1:0}const XL={offset:0,completions:[]};function Fo(n,e){return e.offset+=n,e}function kf(n,e){let t=[];for(let r of e)r.startsWith(n)&&t.push({value:r});return t.sort((r,i)=>kd(r.value,i.value)),t}function _o(n,e,t,r){let i=[];for(let s of e){let a=t(s);a.startsWith(n)&&i.push({value:a,description:r(s)})}return i.sort((s,a)=>kd(s.value,a.value)),i}async function LF(n,e,t){if(n.startsWith("{"))return XL;const r=n.match(/^(?:(.*)[&;])?([^&;]*)$/)[2];let i=n.length-r.length;const s=r.indexOf("=");if(s===-1){const a=await e(r);return{offset:a.offset+i,completions:a.completions.map(l=>j(j({},l),{value:`${l.value}=`}))}}return Fo(i+s+1,await t(r.substring(0,s),r.substring(s+1)))}async function KL(n,e){return LF(n,async t=>{const r=[];for(const i of e){const s=i.key;s.value.startsWith(t)&&r.push(s)}return{offset:0,completions:r}},async(t,r)=>{for(const i of e)if(i.key.value===t)return{offset:0,completions:i.values.filter(s=>s.value.startsWith(r))};return XL})}class ZL extends Error{constructor(e){super(`Redirected to: ${e}`),this.redirectTarget=e}}function QL(n,e){e===void 0&&(n.indexOf("/")===-1?e=":":e="/");let t=n.lastIndexOf(e);return t===-1?0:t+1}function IF(n,e){let t=QL(n,e);return n.substring(t)}var Ri;(function(n){n[n.annotations=0]="annotations",n[n.equivalences=1]="equivalences"})(Ri||(Ri={}));function e2(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new de}}class oa extends K{normalizeUrl(e){return e.url}convertLegacyUrl(e){return e.url}async completeUrl(e){throw null}}const t2="local://annotations",_g="local://equivalences";class DF extends oa{get description(){return"Local in-memory"}async get(e){switch(e.url){case t2:{const t=e.transform;let r;if(t===void 0){const i=e.globalCoordinateSpace.value,s=i.rank,a=i.names,l=i.scales,c=i.units,u=st({rank:s,scales:l,units:c,names:a.map((g,v)=>`${v}`)}),h=st({rank:s,scales:l,units:c,names:a});r={rank:s,sourceRank:s,inputSpace:u,outputSpace:h,transform:xs(Float64Array,s+1)}}else r=zn(uo);return{modelTransform:r,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:Ri.annotations}}]}}case _g:return{modelTransform:zn(uo),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:Ri.equivalences}}]}}throw new Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:_o(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],t=>t.value,t=>t.description)}}}const ZC=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/;class PF extends K{constructor(e){super(),this.credentialsManager=e,this.dataSources=new de([["local",new DF]])}register(e,t){this.dataSources.set(e,this.registerDisposer(t))}getProvider(e){const t=e.match(ZC);if(t===null||t[1]===void 0)throw new Error('Data source URL must have the form "<protocol>://<path>".');var r=ae(t,3);const i=r[1],s=r[2],a=this.dataSources.get(i);if(a===void 0)throw new Error(`Unsupported data source: ${ie(i)}.`);return[a,s,i]}async get(e){const t=new ze;var r=e.cancellationToken;const i=r===void 0?Vt:r;let s=e.url;for(;;){var a=this.getProvider(e.url),l=ae(a,3);const c=l[0],u=l[1],h=l[2];t.add(e.url);try{return c.get(j(j({},e),{url:s,providerProtocol:h,providerUrl:u,registry:this,cancellationToken:i,credentialsManager:this.credentialsManager}))}catch(g){if(g instanceof ZL){const v=g.redirectTarget;if(t.has(v))throw Error(`Layer source redirection contains loop: ${ie(Te(t))}`);if(t.size>=10)throw Error(`Too many layer source redirections: ${ie(Te(t))}`);s=v;continue}throw g}}}convertLegacyUrl(e){try{var t=this.getProvider(e.url),r=ae(t,3);const i=r[0],s=r[1],a=r[2];return i.convertLegacyUrl(j(j({},e),{providerUrl:s,providerProtocol:a,registry:this}))}catch{return e.url}}normalizeUrl(e){try{var t=this.getProvider(e.url),r=ae(t,3);const i=r[0],s=r[1],a=r[2];return i.normalizeUrl(j(j({},e),{providerUrl:s,providerProtocol:a,registry:this}))}catch{return e.url}}async completeUrl(e){const t=e.url;var r=e.cancellationToken;const i=r===void 0?Vt:r;let s=t.match(ZC),a=s[1];if(a===void 0)return xt.resolve({offset:0,completions:_o(t,this.dataSources,([l])=>`${l}://`,([,l])=>l.description)});{const l=this.dataSources.get(a);if(l!==void 0){const c=await l.completeUrl({registry:this,url:t,providerUrl:s[2],chunkManager:e.chunkManager,cancellationToken:i,credentialsManager:this.credentialsManager});return Fo(a.length+3,c)}throw null}}suggestLayerName(e){var t=this.getProvider(e),r=ae(t,2);let i=r[0],s=r[1];s.endsWith("/")&&(s=s.substring(0,s.length-1));let a=i.suggestLayerName;return a!==void 0?a(s):IF(s)}findSourceGroup(e){var t=this.getProvider(e),r=ae(t,3);let i=r[0],s=r[1],a=r[2];return(i.findSourceGroup||QL)(s)+a.length+3}}var QC={},Lf,ex;function n2(){if(ex)return Lf;ex=1;var n=Wu(),e=MT(),t=Ym(),r=pA().f;return Lf=function(i){return function(s){for(var a=t(s),l=e(a),c=l.length,u=0,h=[],g;c>u;)g=l[u++],(!n||r.call(a,g))&&h.push(i?[g,a[g]]:a[g]);return h}},Lf}var tx;function RF(){if(tx)return QC;tx=1;var n=Ot(),e=n2()(!0);return n(n.S,"Object",{entries:function(t){return e(t)}}),QC}var nx,rx;function MF(){return rx||(rx=1,RF(),nx=ut().Object.entries),nx}var ix,sx;function AF(){return sx||(sx=1,ix={default:MF(),__esModule:!0}),ix}var NF=AF();const Ld=Qe(NF);var ax={},If,ox;function r2(){if(ox)return If;ox=1;var n=Yu(),e=ju().getWeak,t=Ro(),r=Cs(),i=Xu(),s=Mo(),a=Qm(),l=hA(),c=Ks(),u=a(5),h=a(6),g=0,v=function(S){return S._l||(S._l=new y)},y=function(){this.a=[]},C=function(S,w){return u(S.a,function(E){return E[0]===w})};return y.prototype={get:function(S){var w=C(this,S);if(w)return w[1]},has:function(S){return!!C(this,S)},set:function(S,w){var E=C(this,S);E?E[1]=w:this.a.push([S,w])},delete:function(S){var w=h(this.a,function(E){return E[0]===S});return~w&&this.a.splice(w,1),!!~w}},If={getConstructor:function(S,w,E,k){var P=S(function(D,L){i(D,P,w,"_i"),D._t=w,D._i=g++,D._l=void 0,L!=null&&s(L,E,D[k],D)});return n(P.prototype,{delete:function(D){if(!r(D))return!1;var L=e(D);return L===!0?v(c(this,w)).delete(D):L&&l(L,this._i)&&delete L[this._i]},has:function(D){if(!r(D))return!1;var L=e(D);return L===!0?v(c(this,w)).has(D):L&&l(L,this._i)}}),P},def:function(S,w,E){var k=e(t(w),!0);return k===!0?v(S).set(w,E):k[S._i]=E,S},ufstore:v},If}var lx;function VF(){if(lx)return ax;lx=1;var n=r2(),e=Ks(),t="WeakSet";return Ku()(t,function(r){return function(){return r(this,arguments.length>0?arguments[0]:void 0)}},{add:function(r){return n.def(e(this,t),r,!0)}},n,!1,!0),ax}var OF={},dx;function BF(){return dx||(dx=1,Zu()("WeakSet")),OF}var FF={},cx;function _F(){return cx||(cx=1,Qu()("WeakSet")),FF}var ux,hx;function UF(){return hx||(hx=1,ia(),VF(),BF(),_F(),ux=ut().WeakSet),ux}var px,fx;function $F(){return fx||(fx=1,px={default:UF(),__esModule:!0}),px}var zF=$F();const GF=Qe(zF);var Df,gx;function WF(){if(gx)return Df;gx=1;var n=GT(),e=Hm(),t="Expected a function";function r(i,s,a){var l=!0,c=!0;if(typeof i!="function")throw new TypeError(t);return e(a)&&(l="leading"in a?!!a.leading:l,c="trailing"in a?!!a.trailing:c),n(i,s,{leading:l,maxWait:s,trailing:c})}return Df=r,Df}var jF=WF();const hh=Qe(jF);function HF(n){return typeof n=="boolean"?{enabled:n}:(ge(n),{enabled:ye(n,"enabled",oo)})}function zl(n,e=void 0){return typeof n=="string"?{url:n,transform:e,enableDefaultSubsources:!0,subsources:new de}:(ge(n),{url:X(n,"url",ke),transform:X(n,"transform",Fk)||e,enableDefaultSubsources:ye(n,"enableDefaultSubsources",oo,!0),subsources:ye(n,"subsources",t=>av(t,HF),new de)})}function qF(n){return n.enabled}function mx(n){const e=_k(n.transform),t={};let r=!0;for(const s of n.subsources){var i=ae(s,2);const a=i[0],l=i[1],c=qF(l);c!==void 0&&(t[a]=c,r=!1)}return e===void 0&&r&&n.enableDefaultSubsources===!0?n.url:{url:n.url,transform:e,subsources:r?void 0:t,enableDefaultSubsources:n.enableDefaultSubsources===!0?void 0:!1}}class JF{constructor(e,t,r,i,s){this.loadedDataSource=e,this.subsourceEntry=t,this.subsourceSpec=r,this.subsourceIndex=i,this.activated=void 0,this.guardValues=[],this.messages=new Vo,this.isActiveChanged=new we;let a;r===void 0||r.enabled===void 0?a=t.default&&s:a=r.enabled;const l=e.dataSource.modelTransform.sourceRank;let c=t.modelSubspaceDimensionIndices;if(c===void 0){c=new Array(l);for(let g=0;g<l;++g)c[g]=g}var u=t.subsourceToModelSubspaceTransform;const h=u===void 0?xs(Float32Array,c.length+1):u;this.enabled=a,this.subsourceToModelSubspaceTransform=h,this.modelSubspaceDimensionIndices=c,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e,...t){if(this.messages.clearMessages(),this.activated!==void 0){if(Oe(t,this.guardValues))return;this.activated.dispose()}this.guardValues=t;const r=this.activated=new K;e(r),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:Kr.error,message:e});const t=this.activated;t!==void 0&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){const t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){const t=this.activated;var r=this.loadedDataSource;const i=r.layer,s=r.transform;return t.registerDisposer($k(i.manager.root.coordinateSpace,i.localPosition.coordinateSpace,s,this,e))}}class Gv extends K{constructor(e,t,r){super(),this.layerDataSource=e,this.dataSource=t,this.error=void 0,this.enabledSubsourcesChanged=new we,this.activatedSubsourcesChanged=new we,this.messages=new Vo,t.canChangeModelSpaceRank?(this.transform=new oC(zn(st({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new oC(t.modelTransform),r.transform!==void 0&&(this.transform.spec=r.transform);const i=r.subsources;this.enableDefaultSubsources=r.enableDefaultSubsources,this.subsources=t.subsources.map((s,a)=>new JF(this,s,i.get(s.id),a,this.enableDefaultSubsources))}get enabledSubsources(){return this.subsources.filter(e=>e.enabled)}get layer(){return this.layerDataSource.layer}disposed(){for(const e of this.subsources){const t=e.activated;t!==void 0&&(e.activated=void 0,t.dispose())}}}class YF extends K{constructor(e,t=void 0){super(),this.layer=e,this.changed=new we,this.messages=new Vo,this.loadState_=void 0,this.specGeneration=-1,this.refCounted_=void 0,this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),t===void 0?this.spec_=e2():this.spec=t}get spec(){const e=this.loadState;if(e!==void 0&&e.error===void 0){const t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new de(Te(e.subsources,r=>{const i=e.enableDefaultSubsources&&r.subsourceEntry.default;return[r.subsourceEntry.id,{enabled:r.enabled!==i?r.enabled:void 0}]}))})}return this.spec_}get loadState(){return this.loadState_}set spec(e){const t=this.layer;if(this.messages.clearMessages(),e.url.length===0){if(t.dataSources.length!==1){const c=t.dataSources.indexOf(this);if(c!==-1){t.dataSources.splice(c,1),t.dataSourcesChanged.dispatch(),this.dispose();return}}this.spec_=e,this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch());return}const r=new K,i=r.registerDisposer(HT(t.markLoading()));this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=r,this.spec_=e;const s=t.manager.chunkManager,a=t.manager.dataSourceProviderRegistry,l=new Es;this.messages.addMessage({severity:Kr.info,message:"Loading data source"}),a.get({chunkManager:s,url:e.url,cancellationToken:l,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform}).then(c=>{if(r.wasDisposed)return;this.messages.clearMessages();const u=r.registerDisposer(new Gv(this,c,e));u.registerDisposer(t.addCoordinateSpace(u.transform.outputSpace)),u.registerDisposer(u.transform.changed.add(this.changed.dispatch)),this.loadState_=u,u.registerDisposer(u.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),i()}).catch(c=>{this.wasDisposed||(this.loadState_={error:c},this.messages.clearMessages(),this.messages.addMessage({severity:Kr.error,message:c.message}),this.changed.dispatch())}),r.registerDisposer(()=>{l.cancel()}),this.changed.dispatch()}disposed(){const e=this.refCounted_;e!==void 0&&e.dispose()}toJSON(){const e=this.loadState;return e===void 0||e.error!==void 0?mx(this.spec):mx({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new de(Te(e.subsources,t=>{const r=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==r?t.enabled:void 0}]}))})}}var vx={},yx,bx;function XF(){return bx||(bx=1,yx=Object.is||function(n,e){return n===e?n!==0||1/n===1/e:n!=n&&e!=e}),yx}var wx;function KF(){if(wx)return vx;wx=1;var n=Ot();return n(n.S,"Object",{is:XF()}),vx}var Sx,Cx;function ZF(){return Cx||(Cx=1,KF(),Sx=ut().Object.is),Sx}var xx,Ex;function QF(){return Ex||(Ex=1,xx={default:ZF(),__esModule:!0}),xx}var e_=QF();const Tx=Qe(e_);var kx={},Lx,Ix;function t_(){return Ix||(Ix=1,Lx=Math.sign||function(n){return(n=+n)==0||n!=n?n:n<0?-1:1}),Lx}var Dx;function n_(){if(Dx)return kx;Dx=1;var n=Ot();return n(n.S,"Math",{sign:t_()}),kx}var Px,Rx;function r_(){return Rx||(Rx=1,n_(),Px=ut().Math.sign),Px}var Mx,Ax;function i_(){return Ax||(Ax=1,Mx={default:r_(),__esModule:!0}),Mx}var s_=i_();const nd=Qe(s_);var Pf={exports:{}},Nx;function a_(){if(Nx)return Pf.exports;Nx=1;var n=Ni(),e=Qm()(0),t=lA(),r=ju(),i=dA(),s=r2(),a=Cs(),l=Ks(),c=Ks(),u=!n.ActiveXObject&&"ActiveXObject"in n,h="WeakMap",g=r.getWeak,v=Object.isExtensible,y=s.ufstore,C,S=function(k){return function(){return k(this,arguments.length>0?arguments[0]:void 0)}},w={get:function(k){if(a(k)){var P=g(k);return P===!0?y(l(this,h)).get(k):P?P[this._i]:void 0}},set:function(k,P){return s.def(l(this,h),k,P)}},E=Pf.exports=Ku()(h,S,w,s,!0,!0);return c&&u&&(C=s.getConstructor(S,h),i(C.prototype,w),r.NEED=!0,e(["delete","has","get","set"],function(k){var P=E.prototype,D=P[k];t(P,k,function(L,R){if(a(L)&&!v(L)){this._f||(this._f=new C);var M=this._f[k](L,R);return k=="set"?this:M}return D.call(this,L,R)})})),Pf.exports}var o_={},Vx;function l_(){return Vx||(Vx=1,Zu()("WeakMap")),o_}var d_={},Ox;function c_(){return Ox||(Ox=1,Qu()("WeakMap")),d_}var Bx,Fx;function u_(){return Fx||(Fx=1,ia(),a_(),l_(),c_(),Bx=ut().WeakMap),Bx}var _x,Ux;function h_(){return Ux||(Ux=1,_x={default:u_(),__esModule:!0}),_x}var p_=h_();const i2=Qe(p_);function pn(n,e,t){ye(n,e,r=>t.restoreState(r))}class ph extends K{constructor(){super(...arguments),this.children=new de,this.changed=new we}add(e,t){if(this.children.has(e))throw new Error(`Key ${ie(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){const t=this.children;if(t.has(e))throw new Error(`Key ${ie(e)} not registered.`);const r=t.get(e);this.children.delete(e),r.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){const e=this.changed;for(let t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){const e=this.baseJSON();for(let r of this.children){var t=ae(r,2);let i=t[0],s=t[1];e[i]=s.toJSON()}return e}baseJSON(){return{}}reset(){for(let e of this.children.values())e.reset()}restoreState(e){ge(e);for(let r of this.children){var t=ae(r,2);let i=t[0],s=t[1];try{if(e.hasOwnProperty(i)){const a=e[i];if(a===void 0)continue;s.restoreState(a)}}catch(a){throw new Error(`Error restoring property ${ie(i)}: ${a.message}`)}}}}const $x=new i2;function Wv(n){let e=$x.get(n);const t=n.changed.count;if(e!==void 0&&e.generation===t)return e;let r;if(n instanceof ph){r=n.baseJSON();for(let s of n.children){var i=ae(s,2);let a=i[0],l=i[1];r[a]=Wv(l).value}}else r=n.toJSON();return e===void 0?(e={generation:t,value:r},$x.set(n,e)):(e.generation=t,e.value=r),e}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fh{constructor(e,t,r=t){this.enumType=e,this.value_=t,this.defaultValue=r,this.changed=new we}set value(e){this.value_!==e&&(this.value_=e,this.changed.dispatch())}get value(){return this.value_}reset(){this.value=this.defaultValue}restoreState(e){this.value=Mn(e,this.enumType)}toJSON(){if(this.value_!==this.defaultValue)return this.enumType[this.value_].toLowerCase()}}var Lt;(function(n){n[n.LINKED=0]="LINKED",n[n.RELATIVE=1]="RELATIVE",n[n.UNLINKED=2]="UNLINKED"})(Lt||(Lt={}));var vu;(function(n){n[n.LINKED=0]="LINKED",n[n.UNLINKED=2]="UNLINKED"})(vu||(vu={}));class f_ extends fh{constructor(e=Lt.LINKED){super(Lt,e)}}class g_ extends fh{constructor(e=vu.LINKED){super(vu,e)}}const Pc=Ne(),s2=Pn();function Id(n,e,t,r){let i=!1,s;n.registerDisposer(e);const a=()=>{switch(i=!0,t.value){case Lt.UNLINKED:if(r.isValid(n))break;case Lt.LINKED:r.assign(n,e);break;case Lt.RELATIVE:r.add(n,e,s);break}i=!1},l=()=>{if(!i)switch(t.value){case Lt.UNLINKED:break;case Lt.LINKED:r.assign(e,n);break;case Lt.RELATIVE:r.subtract(e,n,s);break}};let c=Lt.UNLINKED;const u=()=>{const h=t.value;if(h!==c)switch(h){case Lt.UNLINKED:s=void 0;break;case Lt.LINKED:s=void 0,r.assign(n,e);break;case Lt.RELATIVE:s=r.difference(n,e);break}c=h,n.changed.dispatch()};return n.registerDisposer(n.changed.add(l)),n.registerDisposer(e.changed.add(a)),n.registerDisposer(t.changed.add(u)),u(),n}function a2(n,e,t,r){return Id(n,e,t,r)}class Hs extends K{constructor(e){super(),this.coordinateSpace=e,this.coordinates_=co,this.changed=new we,this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=co,this.changed.dispatch()}set value(e){const t=this.curCoordinateSpace;t===void 0||!t.valid||t.rank!==e.length||(this.coordinates_.set(e),this.changed.dispatch())}handleCoordinateSpaceChanged(){const e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;const r=e.rank;if(!e.valid)return;if(t===void 0||!t.valid){let h=this.coordinates_;if(!(h!==void 0&&h.length===r)){h=this.coordinates_=new Float32Array(r),T3(h,e.bounds);for(let g=0;g<r;++g)h[g]=Math.floor(h[g])+.5}this.changed.dispatch();return}const i=new Float32Array(r),s=this.coordinates_,a=e.ids,l=e.scales,c=t.ids,u=t.scales;for(let h=0;h<r;++h){const g=a[h],v=c.indexOf(g);v===-1?i[h]=Pk(e.bounds.lowerBounds[h],e.bounds.upperBounds[h]):i[h]=s[v]*(u[v]/l[h])}this.coordinates_=i,this.changed.dispatch()}toJSON(){if(!this.valid&&this.coordinates_.length===0)return;this.handleCoordinateSpaceChanged();const e=this.value;if(e.length!==0)return Te(e)}restoreState(e){if(e===void 0){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from(We(e,vt)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();const e=this.coordinates_,t=e.length;for(let r=0;r<t;++r)e[r]=Math.floor(e[r])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();const t=e.curCoordinateSpace,r=e.coordinates_;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(r),this.changed.dispatch()}static getOffset(e,t){const r=e.coordinates_,i=t.coordinates_;if(r.length===i.length)return Tg(new Float32Array(r.length),r,i)}static addOffset(e,t,r,i=1){e.handleCoordinateSpaceChanged();const s=t.value;r!==void 0&&s.length===r.length&&(m3(e.value,s,r,i),e.changed.dispatch())}get legacyJsonView(){const e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){e.reset()},restoreState(t){if(t===void 0||Array.isArray(t)){e.restoreState(t);return}ge(t),pn(t,"voxelCoordinates",e)}}}}function o2(n,e,t){if(t===void 0||Qt(t).length===0){n.value=Lt.LINKED;return}ge(t),n.value=Lt.UNLINKED,X(t,"value",r=>{r!==void 0&&e.restoreState(r)}),X(t,"link",r=>n.restoreState(r))}class Dd{constructor(e,t=new f_){this.peer=e,this.link=t}get changed(){return this.value.changed}toJSON(){const e=this.link;if(e.value!==Lt.LINKED)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=Lt.LINKED}restoreState(e){o2(this.link,this.value,e)}copyToPeer(){this.link.value!==Lt.LINKED&&(this.link.value=Lt.UNLINKED,this.peer.assign(this.value),this.link.value=Lt.LINKED)}}class l2 extends Dd{constructor(e,t=new g_){super(e,t)}}class d2 extends Dd{constructor(){super(...arguments),this.value=Id(new Hs(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:Hs.getOffset,add:Hs.addOffset,subtract:(e,t,r)=>{Hs.addOffset(e,t,r,-1)}})}}function m_(n){return n[0]===0&&n[1]===0&&n[2]===0&&n[3]===1}class wo extends K{constructor(e){super(),this.changed=new we,e==null&&(e=Pn()),this.orientation=e}toJSON(){let e=this.orientation;if(Hl(this.orientation,this.orientation),!m_(e))return Array.prototype.slice.call(this.orientation)}restoreState(e){try{Fl(this.orientation,e),Hl(this.orientation,this.orientation)}catch{mS(this.orientation)}this.changed.dispatch()}reset(){mS(this.orientation),this.changed.dispatch()}snap(){let e=ud();KT(e,this.orientation);let t=[!1,!1,!1];for(let r=0;r<3;++r){let i=0,s=0;for(let a=0;a<3;++a){let l=e[r*3+a];e[r*3+a]=0,!t[a]&&Math.abs(l)>Math.abs(i)&&(i=l,s=a)}e[r*3+s]=nd(i),t[s]=!0}rk(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let r=new wo(cs(Pn(),e.orientation,t)),i=!1;r.registerDisposer(e.changed.add(()=>{i||(s=!0,cs(r.orientation,e.orientation,t),r.changed.dispatch(),s=!1)}));let s=!1;const a=tu(Pn(),t);return r.registerDisposer(r.changed.add(()=>{s||(i=!0,cs(e.orientation,r.orientation,a),e.changed.dispatch(),i=!1)})),r}assign(e){GN(this.orientation,e.orientation),this.changed.dispatch()}}class Ug extends Dd{constructor(){super(...arguments),this.value=Id(new wo,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{const r=Pn();return cs(r,tu(r,t.orientation),e.orientation)},add:(e,t,r)=>{cs(e.orientation,t.orientation,r),e.changed.dispatch()},subtract:(e,t,r)=>{cs(e.orientation,t.orientation,tu(s2,r)),e.changed.dispatch()}})}}class c2 extends K{constructor(e){super(),this.coordinateSpace=e,this.changed=new we,this.curCoordinateSpace=Pi,this.value_={factors:new Float64Array(0)},this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=Pi,this.changed.dispatch()}toJSON(){const e={};let t=!1;const r=this.value.factors;var i=this.curCoordinateSpace;const s=i.names,a=i.rank;for(let l=0;l<a;++l){const c=r[l];c!==1&&(e[s[l]]=c,t=!0)}if(t)return e}restoreState(e){const t=this.coordinateSpace.value,r=t.names,i=t.rank,s=new Float64Array(i);if(s.fill(-1),e!==void 0){const a=ge(e);for(let l=0;l<i;++l)s[l]=X(a,r[l],c=>c===void 0?1:yn(c))}this.value_={factors:s},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){const t=this.coordinateSpace.value;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){const e=this.coordinateSpace.value;let t=this.value_;const r=this.curCoordinateSpace;if(r===e)return t;const i=r.ids,s=e.ids,a=e.rank,l=t.factors,c=new Float64Array(a);c.fill(1);for(let u=0;u<a;++u){const h=s[u],g=i.indexOf(h);g!==-1&&(c[u]=l[g])}return Oe(c,l)||(t=this.value_={factors:c},this.curCoordinateSpace=e,this.changed.dispatch()),t}assign(e){this.setFactors(e.value.factors)}}function zx(n,e,t,r,i){if(t===r)return e;const s=t.ids,a=r.rank,l=r.ids,c=new n(a);for(let u=0;u<a;++u){const h=l[u],g=s.indexOf(h);c[u]=g===-1?i(u):e[g]}return c}class v_ extends Dd{constructor(){super(...arguments),this.value=Id(new c2(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{const r=e.value.factors,i=e.coordinateSpace.value,s=t.value.factors;return{coordinateSpace:i,offsets:Tg(new Float64Array(r.length),r,s)}},add:(e,t,r)=>{const i=zx(Float64Array,r.offsets,r.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(Lk(new Float64Array(i.length),i,t.value.factors))},subtract:(e,t,r)=>{const i=zx(Float64Array,r.offsets,r.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(Tg(new Float64Array(i.length),t.value.factors,i))},isValid:()=>!0})}}function Gx(n,e,t){const r=n.rank,i=n.names,s=n.units,a=e.displayRank,l=e.displayDimensionIndices,c=new Float64Array(3);let u=new Float64Array(3),h;const g=t.factors,v=new Array(3),y=new Float64Array(3);if(c.fill(1),u.fill(1),y.fill(1),v.fill(""),a===0)h=1;else{h=Number.POSITIVE_INFINITY;const C=n.scales;for(let S=0;S<a;++S){const w=l[S],E=u[S]=g[w]*C[w];h=Math.min(h,E),v[S]=s[w],y[S]=C[w]}for(let S=0;S<a;++S)c[S]=u[S]/h}return{globalRank:r,globalDimensionNames:i,displayRank:a,displayDimensionIndices:l,displayDimensionUnits:v,displayDimensionScales:y,canonicalVoxelFactors:c,voxelPhysicalScales:u,canonicalVoxelPhysicalSize:h}}function y_(n,e){return Oe(n.globalDimensionNames,e.globalDimensionNames)&&Oe(n.displayDimensionIndices,e.displayDimensionIndices)&&Oe(n.canonicalVoxelFactors,e.canonicalVoxelFactors)&&Oe(n.voxelPhysicalScales,e.voxelPhysicalScales)&&n.canonicalVoxelPhysicalSize===e.canonicalVoxelPhysicalSize&&Oe(n.displayDimensionUnits,e.displayDimensionUnits)&&Oe(n.displayDimensionScales,e.displayDimensionScales)}class u2 extends K{constructor(e,t){super(),this.relativeDisplayScales=e,this.displayDimensions=t,this.changed=new we,this.curRelativeDisplayScales=this.relativeDisplayScales.value,this.curDisplayDimensions=this.displayDimensions.value,this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value,this.value_=Gx(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales),this.registerDisposer(e),this.registerDisposer(t);const r=()=>{this.value};this.registerDisposer(e.changed.add(r)),this.registerDisposer(t.changed.add(r))}get value(){var e=this.relativeDisplayScales;const t=e.value,r=e.coordinateSpace.value,i=this.displayDimensions.value,s=this.curRelativeDisplayScales,a=this.curDisplayDimensions,l=this.curCoordinateSpace;let c=this.value_;if(s!==t||a!==i||l!==r){this.curRelativeDisplayScales=t,this.curDisplayDimensions=i,this.curCoordinateSpace=r;const u=Gx(r,i,t);y_(c,u)||(this.value_=c=u,this.changed.dispatch())}return c}}class h2 extends K{constructor(e){super(),this.coordinateSpace=e,this.changed=new we,this.default_=!0,this.value_=void 0,this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){const e=this.coordinateSpace.value,t=this.value_;if(t!==void 0&&t.coordinateSpace===e)return;if(t===void 0||this.default_){this.setToDefault(e);return}const r=new Int32Array(3),i=t.coordinateSpace.ids,s=e.ids,a=t.displayDimensionIndices,l=t.displayRank;let c=0;for(let u=0;u<l;++u){const h=s.indexOf(i[a[u]]);h!==-1&&(r[c]=h,++c)}if(r.fill(-1,c),c===0){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,c,r),this.changed.dispatch()}setToDefault(e){const t=Math.min(e.rank,3),r=new Int32Array(3);r.fill(-1);for(let i=0;i<t;++i)r[i]=i;this.assignValue(e,t,r)}assignValue(e,t,r){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:r},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(e===void 0){this.reset();return}const t=yv(e);if(t.length>3)throw new Error("Number of spatial dimensions must be <= 3");const r=this.coordinateSpace.value,i=new Int32Array(3);i.fill(-1);const s=r.names;let a=0;for(const l of t){const c=s.indexOf(l);c!==-1&&(i[a++]=c)}if(a===0){this.reset();return}this.default_=!1,this.assignValue(r,a,i)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;const e=this.value,t=[],r=e.displayRank,i=e.displayDimensionIndices,s=e.coordinateSpace.names;if(r!==0){for(let a=0;a<r;++a)t[a]=s[i[a]];return t}}assign(e){if(e.default)this.default=!0;else{var t=e.value;const r=t.displayRank,i=t.displayDimensionIndices;this.setDimensionIndices(r,i)}}}class b_ extends l2{constructor(e){super(e),this.value=a2(new h2(this.peer.coordinateSpace),this.peer,this.link,{assign:(t,r)=>t.assign(r),isValid:()=>!0})}}class So extends K{constructor(e,t,r){super(),this.position=e,this.displayDimensionRenderInfo=t,this.orientation=r,this.changed=new we,this.registerDisposer(e),this.registerDisposer(r),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(r.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e,t=Pc){var r=this.position;const i=r.coordinateSpace.value,s=r.value;var a=this.displayDimensions.value;const l=a.displayDimensionIndices,c=a.displayRank;if(i===void 0)return!1;t.fill(0);for(let u=0;u<c;++u){const h=l[u];t[u]=s[h]}if(e(t)!==!1){for(let u=0;u<c;++u){const h=l[u];s[h]=t[u]}return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){AN(e,this.orientation.orientation);const r=this.position.value;var i=this.displayDimensionRenderInfo.value;const s=i.canonicalVoxelFactors,a=i.displayDimensionIndices;for(let l=0;l<3;++l){const c=a[l],u=t/s[l];e[l]*=u,e[4+l]*=u,e[8+l]*=u,e[12+l]=r[c]||0}}toMat3(e,t){KT(e,this.orientation.orientation);var r=this.displayDimensionRenderInfo.value;const i=r.canonicalVoxelFactors,s=r.displayRank;for(let a=0;a<s;++a){const l=t/i[a];e[a]*=l,e[3+a]*=l,e[6+a]*=l}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;const r=this.position,i=r.value;var s=r.coordinateSpace.value.bounds;const a=s.lowerBounds,l=s.upperBounds;let c=i[e]+t;if(t>0){const u=l[e];gt(u)&&(c=Math.min(c,Math.ceil(u-1)))}else{const u=a[e];gt(u)&&(c=Math.max(c,Math.floor(u)))}i[e]=c,r.changed.dispatch()}translateVoxelsRelative(e,t=!1){if(!this.valid)return;const r=Qa(Pc,e,this.orientation.orientation),i=this.position,s=i.value;var a=this.displayDimensions.value;const l=a.displayDimensionIndices,c=a.displayRank;var u=i.coordinateSpace.value.bounds;const h=u.lowerBounds,g=u.upperBounds;for(let v=0;v<c;++v){const y=l[v],C=r[v];if(C===0)continue;let S=s[y]+C;if(C>0){const w=g[y];gt(w)&&(S=Math.min(S,Math.ceil(w-1)))}else{const w=h[y];gt(w)&&(S=Math.max(S,Math.floor(w)))}t&&(S=Math.floor(S)+.5),s[y]=S}this.position.changed.dispatch()}rotateRelative(e,t){var r=Pn();pg(r,e,t);var i=this.orientation.orientation;cs(i,i,r),this.orientation.changed.dispatch()}rotateAbsolute(e,t,r){var i=this.position;const s=i.coordinateSpace.value,a=i.value;if(s===void 0)return;const l=this.relativeDisplayScales.value.factors;var c=this.displayDimensions.value;const u=c.displayDimensionIndices,h=c.displayRank,g=s.scales,v=Pn();pg(v,e,t);const y=this.orientation.orientation,C=Pc;Pc.fill(0);for(let w=0;w<h;++w){const E=u[w],k=r[E]-a[E];C[w]=k*g[E]*l[E]}const S=tu(s2,y);Qa(C,C,S),cs(y,v,y),Qa(C,C,y);for(let w=0;w<h;++w){const E=u[w];a[E]=r[E]-C[w]/(g[E]*l[E])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;const r=this.displayDimensions.value.displayDimensionIndices,i=this.position.coordinateSpace.value.rank;for(let s=0;s<i;++s)if(r.indexOf(s)===-1&&e--===0){this.translateDimensionRelative(s,t);return}}}class $g extends Dd{constructor(e,t){super(e),this.value=(()=>{const r=new e.constructor(t),i=(u,h)=>{u.assign(h)},s=(u,h)=>u.value/h.value*(u.canonicalVoxelPhysicalSize/h.canonicalVoxelPhysicalSize),a=(u,h,g)=>{u.setPhysicalScale(h.value*g,h.canonicalVoxelPhysicalSize)},l=(u,h,g)=>{u.setPhysicalScale(h.value/g,h.canonicalVoxelPhysicalSize)},c=u=>u.coordinateSpaceValue.valid&&u.canonicalVoxelPhysicalSize!==0;return Id(r,this.peer,this.link,{assign:i,isValid:c,difference:s,add:a,subtract:l}),r})()}}function rd(n){return{changed:n.changed,toJSON(){return n.toJSON()},restoreState(e){o2(n.link,n.value.legacyJsonView,e)},reset(){n.reset()}}}class p2 extends K{constructor(e){super(),this.displayDimensionRenderInfo=e,this.changed=new we,this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.registerDisposer(e),this.registerDisposer(e.changed.add(()=>this.handleCoordinateSpaceChanged())),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add(()=>this.handleCoordinateSpaceChanged())),this.handleCoordinateSpaceChanged()}get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){const t=this.canonicalVoxelPhysicalSize;Tx(e,this.value_)&&t===this.curCanonicalVoxelPhysicalSize||(this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch())}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){Tx(e,this.legacyValue_)||(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}handleCoordinateSpaceChanged(){const e=this.value_;var t=this.displayDimensionRenderInfo;const r=t.value.canonicalVoxelPhysicalSize,i=t.relativeDisplayScales.coordinateSpace.value,s=this.curCanonicalVoxelPhysicalSize;if(!(!Wr(e)&&r===s)){if(!Wr(e)){s!==0&&(this.value_=e*(s/r),this.curCanonicalVoxelPhysicalSize=r,this.changed.dispatch());return}!i.valid||r===0||(this.curCanonicalVoxelPhysicalSize=r,this.value_=this.getDefaultValue(),this.changed.dispatch())}}toJSON(){const e=this.value;return Wr(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,e===void 0?this.value_=Number.NaN:this.value_=yn(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){const e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){return e.reset()},restoreState(t){e.legacyValue=yn(t)}}}setPhysicalScale(e,t){const r=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=e*(t/r)}assign(e){const t=e.legacyValue;Wr(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}}class w_ extends p2{getDefaultValue(){const e=this.legacyValue_;if(Wr(e))return 1;const t=this.canonicalVoxelPhysicalSize;return this.legacyValue_*1e-9/t}}class S_ extends p2{getDefaultValue(){const e=this.legacyValue_;if(!Wr(e)){this.legacyValue_=Number.NaN;const u=this.canonicalVoxelPhysicalSize;return 200*Math.tan(Math.PI/8)*1e-9*e/u}var t=this.coordinateSpaceValue.bounds;const r=t.lowerBounds,i=t.upperBounds;var s=this.displayDimensionRenderInfo.value;const a=s.canonicalVoxelFactors,l=s.displayDimensionIndices;let c=a.reduce((u,h,g)=>{const v=l[g],y=(i[v]-r[v])*h;return Math.max(u,y)},0);return gt(c)?c=2**Math.ceil(Un(c)):c=1024,c}}class zg extends K{constructor(e,t){super(),this.defaultValue=e,this.displayDimensionRenderInfo=t,this.changed=new we,this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add(()=>{this.value}))}get value(){let e=this.value_;if(e>0){const t=this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize,r=this.canonicalVoxelPhysicalSize;t!==r&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=r/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;const t=this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){const e=this.value;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){typeof e!="number"||!gt(e)||e===0?this.value=this.defaultValue:this.value=e}setValueAbsolute(e,t){if(e>0){const r=this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize;e=e*(t/r)}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}}class Wx extends l2{constructor(e,t){super(e),this.value=a2(new zg(e.defaultValue,t),this.peer,this.link,{assign:(r,i)=>r.assign(i),isValid:()=>!0})}}class Co extends K{constructor(e,t,r){super(),this.pose=e,this.zoomFactor=t,this.depthRange=r,this.changed=new we,this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(r),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!Wr(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const C_="mesh/MeshLayer",x_="mesh/MultiscaleMeshLayer",E_="mesh/FragmentSource",T_="mesh/MultiscaleFragmentSource";var Ii;(function(n){n[n.float32=0]="float32",n[n.uint10=1]="uint10",n[n.uint16=2]="uint16"})(Ii||(Ii={}));/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function k_(n,e,t){return n&1|e<<1&2|t<<2&4}function L_(n,e,t,r,i,s,a){const l=n.octree,c=n.lodScales,u=n.chunkGridSpatialOrigin,h=n.chunkShape,g=c.length-1,v=e[0],y=e[4],C=e[8],S=e[1],w=e[5],E=e[9],k=e[3],P=e[7],D=e[11],L=e[15],R=k>0?0:1,M=P>0?0:1,V=D>0?0:1,B=t[16],_=t[17],H=t[18],U=t[19];function O(Ee,Me,Fe){return k*Ee+P*Me+D*Fe+L}function z(Ee,Me,Fe,Ue,Ce,Ye){return O(Ee+R*(Ue-Ee),Me+M*(Ce-Me),Fe+V*(Ye-Fe))}const F=O(-U*B,-U*_,-U*H),se=n.clipLowerBound[0],oe=n.clipLowerBound[1],Re=n.clipLowerBound[2],le=n.clipUpperBound[0],Se=n.clipUpperBound[1],ne=n.clipUpperBound[2],he=Math.sqrt((v*i)**2+(S*s)**2),Le=Math.sqrt((y*i)**2+(w*s)**2),_e=Math.sqrt((C*i)**2+(E*s)**2),Ge=Math.max(he,Le,_e);function De(Ee,Me,Fe){const Ue=1<<Ee,Ce=Me*5,Ye=l[Ce],_t=l[Ce+1],Yt=l[Ce+2],bn=l[Ce+3],Xt=l[Ce+4];let dn=Ye*Ue*h[0]+u[0],wn=_t*Ue*h[1]+u[1],pr=Yt*Ue*h[2]+u[2],He=dn+Ue*h[0],Kn=wn+Ue*h[1],_i=pr+Ue*h[2];if(dn=Math.max(dn,se),wn=Math.max(wn,oe),pr=Math.max(pr,Re),He=Math.min(He,le),Kn=Math.min(Kn,Se),_i=Math.min(_i,ne),dk(dn,wn,pr,He,Kn,_i,t)){const Ui=Math.max(F,z(dn,wn,pr,He,Kn,_i))/Ge;if(Fe===0||Ui*r<Fe){const fr=c[Ee];if(fr!==0&&a(Ee,Me,fr/Ui,Xt>>>31),Ee>0&&(fr===0||Ui*r<fr)){const Jo=fr===0?Fe:fr,Ds=(Xt&2147483647)>>>0;for(let Gn=bn;Gn<Ds;++Gn)De(Ee-1,Gn,Jo)}}}}De(g,l.length/5-1,0)}function jx(n,e,t,r,i,s,a,l){const c=n.lodScales;let u=0;for(;u+1<c.length&&c[u+1]!==0;)++u;const h=3,g=[];let v=0,y=0;function C(E,k){for(;;){if(v===0)return;const P=v-1,D=u-P,L=g[P*h],R=D===0?1:8,M=g[P*h+1],V=g[P*h+2];if(E===v){const B=k&R-1;y!==B&&L!==-1&&l(D,L,y,B,V),y=B+1;return}y!==R&&L!==-1&&l(D,L,y,R,V),y=M+1,--v}}let S=0;const w=n.octree;L_(n,e,t,r,i,s,(E,k,P,D)=>{if(!D&&!a(E,k,P)){S=Math.max(E,S);return}if(E<S)return;S=0;const L=k*5,R=w[L],M=w[L+1],V=w[L+2],B=k_(R,M,V),_=u-E;C(_,B);const H=_*h;g[H]=D?-1:k,g[H+1]=B,g[H+2]=P,y=0,v=_+1}),C(0,0)}function f2(n,e,t){return`${n}/${e}:${t}`}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Uo extends hL{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const I_=3432918353,D_=461845907;function yu(n,e){return e>>>=0,n>>>=0,e=jr(e,I_)>>>0,e=(e<<15|e>>>17)>>>0,e=jr(e,D_)>>>0,n=(n^e)>>>0,n=(n<<13|n>>>19)>>>0,n=n*5+3864292196>>>0,n}var Hx,qx;function P_(){return qx||(qx=1,DT(),Hx=ut().Symbol.for),Hx}var Jx,Yx;function R_(){return Yx||(Yx=1,Jx={default:P_(),__esModule:!0}),Jx}var M_=R_();const A_=Qe(M_),Gg=3,N_=.8;let yi=0,bi=0,Xx=0,Kx=0;class id{constructor(e=id.generateHashSeeds(Gg)){this.hashSeeds=e,this.loadFactor=N_,this.size=0,this.emptyLow=4294967295,this.emptyHigh=4294967295,this.maxRehashAttempts=5,this.maxAttempts=5,this.generation=0,this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=id.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){const t=this.hashSeeds.length,r=new Array(t);for(let c=0;c<t;++c)r[c]=this.getHash(c,this.emptyLow,this.emptyHigh);let i=this.mungedEmptyKey;if(i===-1)e:for(;;){i=Math.random()*16777216>>>0;for(let c=0;c<t;++c){let u=this.getHash(c,i,i);for(let h=0;h<t;++h)if(r[h]===u)continue e}this.mungedEmptyKey=i;break}let s=this.table,a=this.emptyLow,l=this.emptyHigh;for(let c=0;c<t;++c){let u=r[c];s[u]===a&&s[u+1]===l&&(s[u]=i,s[u+1]=i)}try{e(s)}finally{for(let c=0;c<t;++c){let u=r[c];s[u]===i&&s[u+1]===i&&(s[u]=a,s[u+1]=l)}}}static generateHashSeeds(e=Gg){return jV(new Uint32Array(e))}getHash(e,t,r){let i=this.hashSeeds[e];return i=yu(i,t),i=yu(i,r),this.entryStride*(i&this.tableSize-1)}*keys(){let e=this.emptyLow,t=this.emptyHigh,r=this.entryStride,i=this.table;for(let s=0,a=i.length;s<a;s+=r){let l=i[s],c=i[s+1];(l!==e||c!==t)&&(yield new te(l,c))}}*unsafeKeys(e=new te){let t=this.emptyLow,r=this.emptyHigh,i=this.entryStride,s=this.table;for(let a=0,l=s.length;a<l;a+=i){let c=s[a],u=s[a+1];(c!==t||u!==r)&&(e.low=c,e.high=u,yield e)}}indexOfPair(e,t){let r=this.table,i=this.emptyLow,s=this.emptyHigh;if(e===i&&t===s)return-1;for(let a=0,l=this.hashSeeds.length;a<l;++a){let c=this.getHash(a,e,t);if(r[c]===e&&r[c+1]===t)return c}return-1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){let e=this.emptyLow,t=this.emptyHigh,r=this.table,i=this.entryStride,s,a;for(;s=Math.random()*4294967296>>>0,a=Math.random()*4294967296>>>0,!(!(s===e&&a===t)&&!this.hasPair(s,a)););this.emptyLow=s,this.emptyHigh=a;for(let l=0,c=r.length;l<c;l+=i)r[l]===e&&r[l+1]===t&&(r[l]=s,r[l+1]=a)}has(e){return this.indexOf(e)!==-1}hasPair(e,t){return this.indexOfPair(e,t)!==-1}delete(e){let t=this.indexOf(e);if(t!==-1){let r=this.table;return r[t]=this.emptyLow,r[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){let e=this.table,t=this.entryStride,r=this.emptyLow,i=this.emptyHigh,s=e.length;for(let a=0;a<s;a+=t)e[a]=r,e[a+1]=i}clear(){return this.size===0?!1:(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return e>this.capacity?(this.backupPending(),this.grow(e),this.restorePending(),!0):!1}swapPending(e,t){let r=yi,i=bi;this.storePending(e,t),e[t]=r,e[t+1]=i}storePending(e,t){yi=e[t],bi=e[t+1]}backupPending(){Xx=yi,Kx=bi}restorePending(){yi=Xx,bi=Kx}tryToInsert(){let e=0,t=this.emptyLow,r=this.emptyHigh,i=this.maxAttempts,s=this.table,a=this.hashSeeds.length,l=Math.floor(Math.random()*a);for(;;){let c=this.getHash(l,yi,bi);if(this.swapPending(s,c),yi===t&&bi===r)return!0;if(++e===i)break;l=(l+Math.floor(Math.random()*(a-1))+1)%a}return!1}allocate(e){this.tableSize=e;let t=this.entryStride;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let r=this.emptyLow,i=this.emptyHigh,s=this.entryStride;for(let a=0,l=e.length;a<l;a+=s){let c=e[a],u=e[a+1];if((c!==r||u!==i)&&(this.storePending(e,a),!this.tryToInsert()))return!1}return!0}grow(e){let t=this.table,r=this.tableSize;for(;r<e;)r*=2;for(;;){for(let i=0;i<this.maxRehashAttempts;++i)if(this.rehash(t,r))return;r*=2}}insertInternal(){for(++this.generation,yi===this.emptyLow&&bi===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(this.tableSize*2),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}}class g2 extends id{add(e){let t=e.low,r=e.high;return this.hasPair(t,r)?!1:(yi=t,bi=r,this.insertInternal(),!0)}[An](){return this.unsafeKeys()}}g2.prototype.entryStride=2;let Dl=0,Pl=0,Zx=0,Qx=0;class jv extends id{set(e,t){let r=e.low,i=e.high;return this.hasPair(r,i)?!1:(yi=r,bi=i,Dl=t.low,Pl=t.high,this.insertInternal(),!0)}get(e,t){let r=this.indexOf(e);if(r===-1)return!1;let i=this.table;return t.low=i[r+2],t.high=i[r+3],!0}swapPending(e,t){let r=Dl,i=Pl;super.swapPending(e,t),e[t+2]=r,e[t+3]=i}storePending(e,t){super.storePending(e,t),Dl=e[t+2],Pl=e[t+3]}backupPending(){super.backupPending(),Zx=Dl,Qx=Pl}restorePending(){super.restorePending(),Dl=Zx,Pl=Qx}[An](){return this.unsafeEntries()}*entries(){let e=this.emptyLow,t=this.emptyHigh,r=this.entryStride,i=this.table;for(let s=0,a=i.length;s<a;s+=r){let l=i[s],c=i[s+1];if(l!==e||c!==t){let u=new te(l,c),h=new te(i[s+2],i[s+3]);yield[u,h]}}}*unsafeEntries(e=[new te,new te]){let t=this.emptyLow,r=this.emptyHigh,i=this.entryStride,s=this.table;var a=ae(e,2);let l=a[0],c=a[1];for(let u=0,h=s.length;u<h;u+=i){let g=s[u],v=s[u+1];(g!==t||v!==r)&&(l.low=g,l.high=v,c.low=s[u+2],c.high=s[u+3],yield e)}}}jv.prototype.entryStride=4;class gh{}const Ws=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],V_=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],Rc=["","r","rg","rgb","rgba"],O_=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],B_=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],F_=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],__=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],e1=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],U_=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],$_=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function Hv(n){return n===q.FLOAT32?"":fk[n]?"i":"u"}function Pd(n,e,t=1){switch(e){case q.UINT8:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=O_[t],n.textureFormat=Ws[t],n.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,n.arrayElementsPerTexel=t,n.arrayConstructor=Uint8Array,n.samplerPrefix="u",n;case q.INT8:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=B_[t],n.textureFormat=Ws[t],n.texelType=WebGL2RenderingContext.BYTE,n.arrayElementsPerTexel=t,n.arrayConstructor=Int8Array,n.samplerPrefix="i",n;case q.UINT16:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=F_[t],n.textureFormat=Ws[t],n.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,n.arrayElementsPerTexel=t,n.arrayConstructor=Uint16Array,n.samplerPrefix="u",n;case q.INT16:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=__[t],n.textureFormat=Ws[t],n.texelType=WebGL2RenderingContext.SHORT,n.arrayElementsPerTexel=t,n.arrayConstructor=Int16Array,n.samplerPrefix="i",n;case q.UINT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=e1[t],n.textureFormat=Ws[t],n.texelType=WebGL2RenderingContext.UNSIGNED_INT,n.arrayElementsPerTexel=1,n.arrayConstructor=Uint32Array,n.samplerPrefix="u",n;case q.INT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=U_[t],n.textureFormat=Ws[t],n.texelType=WebGL2RenderingContext.INT,n.arrayElementsPerTexel=1,n.arrayConstructor=Int32Array,n.samplerPrefix="i",n;case q.UINT64:if(t<1||t>2)break;return n.texelsPerElement=1,n.textureInternalFormat=e1[t*2],n.textureFormat=Ws[t*2],n.texelType=WebGL2RenderingContext.UNSIGNED_INT,n.arrayElementsPerTexel=2*t,n.arrayConstructor=Uint32Array,n.samplerPrefix="u",n;case q.FLOAT32:if(t<1||t>4)break;return n.texelsPerElement=1,n.textureInternalFormat=$_[t],n.textureFormat=V_[t],n.texelType=WebGL2RenderingContext.FLOAT,n.arrayElementsPerTexel=t,n.arrayConstructor=Float32Array,n.samplerPrefix="",n}throw new Error(`No supported texture format for ${q[e]}[${t}].`)}function qv(n,e,t){const r=e.arrayConstructor,i=e.arrayElementsPerTexel,s=e.textureInternalFormat,a=e.textureFormat,l=e.texelsPerElement,c=n.maxTextureSize,u=t.length/i;if(u*l>c*c)throw new Error("Number of elements exceeds maximum texture size: "+l+" * "+u);const h=Math.ceil(u/c),g=Math.ceil(Un(h)),v=(1<<g)*l,y=Math.ceil(u/(1<<g)),C=v*y*i;t.constructor!==r&&(t=new r(t.buffer,t.byteOffset,t.byteLength/r.BYTES_PER_ELEMENT));let S=dN(t,C);n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),po(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,s,v,y,0,a,e.texelType,S)}function z_(n,e,t,r,i){const s=e.arrayConstructor,a=e.textureInternalFormat,l=e.textureFormat,c=e.texelsPerElement;t.constructor!==s&&(t=new s(t.buffer,t.byteOffset,t.byteLength/s.BYTES_PER_ELEMENT)),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),po(n),n.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,a,r*c,i,0,l,e.texelType,t)}function G_(n,e,t,r,i,s){const a=e.arrayConstructor,l=e.textureInternalFormat,c=e.textureFormat,u=e.texelsPerElement;t.constructor!==a&&(t=new a(t.buffer,t.byteOffset,t.byteLength/a.BYTES_PER_ELEMENT)),n.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),zO(n),n.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,l,r*u,i,s,0,c,e.texelType,t)}function W_(n){switch(n){case q.UINT8:return wL;case q.INT8:return SL;case q.UINT16:return CL;case q.INT16:return xL;case q.UINT32:return Lv;case q.INT32:return EL;case q.UINT64:return It;case q.FLOAT32:return kv}}function m2(n,e,t,r,i,s){const a=an(i,s);let l=[W_(i)],c=`
${a} ${n}(${r} index) {
`;switch(i){case q.UINT8:case q.UINT16:case q.UINT32:c+=`
  ${a} result;
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${Rc[s]};
  return result;
`;break;case q.INT8:case q.INT16:case q.INT32:c+=`
  ${a} result;
  highp ivec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${Rc[s]};
  return result;
`;break;case q.UINT64:l.push(eB),c+=`
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  return unpackUint64leFromUint32(temp.${Rc[s*2]});
`;break;case q.FLOAT32:l.push(kv),c+=`
  highp vec4 temp;
  ${e}(${t}, index, temp);
  return temp.${Rc[s]};
`;break}return c+=`
}
`,l.push(c),l}class Jv{constructor(e){this.key=e,this.readTextureValue=`readTextureValue_${this.key}`}defineShader(e){}getReadTextureValueCode(e,t){let r=`
void ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let i=0;i<e;++i)r+=`, out ${t}vec4 output${i}`;r+=`) {
  highp int width = textureSize(sampler, 0).x / ${e};
  highp uint log2width = log2Exact(uint(width));
  highp int y = int(index >> log2width);
  highp int x = int((index - (uint(y) << log2width)) * ${e}u);
`;for(let i=0;i<e;++i)r+=`
  output${i} = texelFetch(sampler, ivec2(x + ${i}, y), 0);
`;return r+=`
}
`,[aB,r]}getAccessor(e,t,r,i=1){const s=Hv(r);return[this.getReadTextureValueCode(1,s),...m2(e,this.readTextureValue,t,"highp uint",r,i)]}}class j_{constructor(e,t){this.key=e,this.textureDims=t,this.readTextureValue=`readTextureValue_${this.key}`}getReadTextureValueCode(e,t){const r=this.textureDims;let i=`
void ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${r} p`;for(let s=0;s<e;++s)i+=`, out ${t}vec4 output${s}`;i+=`) {
`;for(let s=0;s<e;++s)i+=`
  output${s} = texelFetch(sampler, ivec${r}(p.x * ${e} + ${s}, p.y
                                         ${r===3?", p.z":""}), 0);
`;return i+=`
}
`,i}getAccessor(e,t,r,i=1){const s=Hv(r);return[this.getReadTextureValueCode(1,s),...m2(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,r,i)]}}const v2=[It,`
highp uint hashCombine(highp uint state, highp uint value) {
  value *= 0xcc9e2d51u;
  value = (value << 15u) | (value >> 17u);
  value *= 0x1b873593u;
  state ^= value;
  state = (state << 13u) | (state >> 19u);
  state = (state * 5u) + 0xe6546b64u;
  return state;
}
highp uint hashCombine(highp uint state, uint64_t x) {
  state = hashCombine(state, x.value[0]);
  return hashCombine(state, x.value[1]);
}
`],H_=Pd(new gh,q.UINT64,1);class Rl extends K{constructor(e,t){super(),this.gl=e,this.hashTable=t,this.generation=-1,this.texture=null,this.texture=e.createTexture()}copyToGPU(){let e=this.hashTable,t=e.generation;if(this.generation===t)return;const r=this.gl,i=this.texture;this.generation=t,r.activeTexture(WebGL2RenderingContext.TEXTURE0+r.tempTextureUnit),r.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i),e.tableWithMungedEmptyKey(s=>{qv(this.gl,H_,s)}),r.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,()=>new this(e,t))}}class y2{constructor(e,t=Gg){this.prefix=e,this.numAlternatives=t,this.textureUnitSymbol=A_(`gpuhashtable:${this.prefix}`),this.accessHelper=new Jv(`gpuhashtable_${this.prefix}`),this.samplerName=this.prefix+"_sampler",this.hashSeedsName=this.prefix+"_seeds",this.hashKeyMask=this.prefix+"_keyMask",this.readTable=this.prefix+"_readTable"}defineShader(e){let t=this.hashSeedsName,r=this.samplerName,i=this.numAlternatives,s=this.hashKeyMask;e.addUniform("highp uint",t,i),e.addUniform("highp uint",s),e.addTextureSampler("usampler2D",r,this.textureUnitSymbol),e.addFragmentCode(v2),e.addFragmentCode(It),e.addFragmentCode(vL),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,q.UINT64,1));let a="";a+=`
bool ${this.hasFunctionName}(uint64_t x) {
`;for(let l=0;l<i;++l)a+=`
  {
    uint h = hashCombine(${t}[${l}], x) & ${s};
    uint64_t key = ${this.readTable}(h);
    if (equals(key, x)) {
      return true;
    }
  }
`;a+=`
  return false;
}
`,e.addFragmentCode(a)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,r){r.copyToGPU();const i=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+i),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r.texture),e.uniform1ui(t.uniform(this.hashKeyMask),r.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),r.hashTable.hashSeeds)}disable(e,t){const r=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}}class b2 extends y2{defineShader(e){super.defineShader(e);let t=this.numAlternatives,r=this.hashSeedsName,i=this.hashKeyMask,s=`
bool ${this.getFunctionName}(uint64_t x, out uint64_t value) {
`;for(let a=0;a<t;++a)s+=`
  {
    uint h = hashCombine(${r}[${a}], x) & ${i};
    uint64_t key = ${this.readTable}(h * 2u);
    if (equals(key, x)) {
      value = ${this.readTable}(h * 2u + 1u);
      return true;
    }
  }
`;s+=`
  return false;
}
`,e.addFragmentCode(s)}get getFunctionName(){return`${this.prefix}_get`}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function bu(n,e,t,r){e*=6;let i=Math.floor(e),s=e-i,a=r*(1-t),l=r*(1-t*s),c=r*(1-t*(1-s));switch(i%6){case 0:n[0]=r,n[1]=c,n[2]=a;break;case 1:n[0]=l,n[1]=r,n[2]=a;break;case 2:n[0]=a,n[1]=r,n[2]=c;break;case 3:n[0]=a,n[1]=l,n[2]=r;break;case 4:n[0]=c,n[1]=a,n[2]=r;break;case 5:n[0]=r,n[1]=a,n[2]=l;break}return n}function q_(n,e,t,r){const i=Math.max(Math.max(e,t),r),s=Math.min(Math.min(e,t),r);if(n[2]=i,s===i)n[0]=0,n[1]=0;else{const a=i-s;n[1]=a/i,e===i?n[0]=(t-r)/a:t===i?n[0]=2+(r-e)/a:n[0]=4+(e-t)/a,n[0]/=6,n[0]<0&&(n[0]+=1),n[0]>1&&(n[0]-=1)}return n}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const t1=2;class J_{constructor(e){this.prefix=e,this.seedName=this.prefix+"_seed"}defineShader(e){const t=this.seedName;e.addUniform("highp uint",t),e.addFragmentCode(It),e.addFragmentCode(v2),e.addFragmentCode(QO);let r=`
vec3 ${this.prefix}(uint64_t x) {
  uint h = hashCombine(${t}, x);
  vec${t1} v;
`;for(let i=0;i<t1;++i)r+=`
  v[${i}] = float(h & 0xFFu) / 255.0;
  h >>= 8u;
`;r+=`
  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);
  return hsvToRgb(hsv);
}
`,e.addFragmentCode(r)}enable(e,t,r){e.uniform1ui(t.uniform(this.seedName),r)}}let n1=new Float32Array(3);function w2(n){return`rgb(${n[0]*100}%,${n[1]*100}%,${n[2]*100}%)`}class Yv{constructor(e=XS()){this.hashSeed=e,this.changed=new we}static getDefault(){return new Yv(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let r=yu(this.hashSeed,t.low);r=yu(r,t.high);const i=(r&255)/255,s=(r>>8&255)/255;return bu(e,i,.5+.5*s,1),e}computeCssColor(e){return this.compute(n1,e),w2(n1)}randomize(){this.hashSeed=XS(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return this.hashSeed===0?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){const t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}}class Y_{constructor(e){this.prefix=e,this.hashMapShaderManager=new b2("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);let t=`
bool ${this.getFunctionName}(uint64_t x, out vec3 value) {
  uint64_t uint64Value;
  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {
    uint uintValue = uint64Value.value[0];
    value.r = float((uintValue & 0x0000ffu))       / 255.0;
    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;
    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;
    return true;
  }
  return false;
}
`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,r){this.hashMapShaderManager.enable(e,t,r)}disable(e,t){this.hashMapShaderManager.disable(e,t)}}const S2="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='arrowLeftIconTitle'%3e%3ctitle%20id='arrowLeftIconTitle'%3eArrow%20Left%3c/title%3e%3cpath%20d='M9%206l-6%206%206%206'/%3e%3cpath%20d='M21%2012H4'/%3e%3cpath%20stroke-linecap='round'%20d='M3%2012h1'/%3e%3c/svg%3e",C2="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='arrowRightIconTitle'%3e%3ctitle%20id='arrowRightIconTitle'%3eArrow%20Right%3c/title%3e%3cpath%20d='M15%2018l6-6-6-6'/%3e%3cpath%20d='M3%2012h17'/%3e%3cpath%20stroke-linecap='round'%20d='M21%2012h-1'/%3e%3c/svg%3e";/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class X_{constructor(e){if(this.parents=new Array,this.parentPriorities=new Array,this.bindings=new de,e!==void 0){this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities);for(const r of e.bindings){var t=ae(r,2);const i=t[0],s=t[1];this.bindings.set(i,s)}}}addParent(e,t){const r=this.parents,i=this.parentPriorities;let s=0;const a=r.length;for(;s<a&&t<i[s];)++s;return r.splice(s,0,e),i.splice(s,0,t),()=>{this.removeParent(e)}}removeParent(e){const t=this.parents.indexOf(e);if(t===-1)throw new Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){const t=this.parents,r=this.parentPriorities,i=r.length;let s=0,a;for(;s<i&&r[s]>0;++s)if(a=t[s].get(e),a!==void 0)return a;if(a=this.bindings.get(e),a!==void 0)return a;for(;s<i;++s)if(a=t[s].get(e),a!==void 0)return a}*getAll(e){const t=this.parents,r=this.parentPriorities,i=r.length;let s=0,a;for(;s<i&&r[s]>0;)a=t[s].get(e),a!==void 0&&(yield a);for(a=this.bindings.get(e),a!==void 0&&(yield a);s<i;)a=t[s].get(e),a!==void 0&&(yield a)}*entries(){const e=this.parents,t=this.parentPriorities,r=t.length;let i=0;for(;i<r&&t[i]>0;++i)yield*e[i].entries();for(yield*this.bindings.entries();i<r;++i)yield*e[i].entries()}}var r1;(function(n){n[n.CONTROL=1]="CONTROL",n[n.ALT=2]="ALT",n[n.META=4]="META",n[n.SHIFT=8]="SHIFT"})(r1||(r1={}));function Xv(n){return(n.ctrlKey?1:0)|(n.altKey?2:0)|(n.metaKey?4:0)|(n.shiftKey?8:0)}function Wg(n,e){let t="";return e&1&&(t+="control+"),e&2&&(t+="alt+"),e&4&&(t+="meta+"),e&8&&(t+="shift+"),t+=n,t}function K_(n,e,t){let r="";return e&1&&(r+="control+"),t&1&&(r+="control?+"),e&2&&(r+="alt+"),t&2&&(r+="alt?+"),e&4&&(r+="meta+"),t&4&&(r+="meta?+"),e&8&&(r+="shift+"),t&8&&(r+="shift?+"),r+=n,r}function i1(n){const e=n.indexOf(":");let t;if(e!==-1&&(t=n.substring(0,e),t!=="at"&&t!=="bubble"))throw new Error(`Invalid event phase: ${ie(t)}`);const r=n.substring(e+1).split("+");let i,s=0,a=0;e:for(let l of r)switch(l){case"control":s|=1;break;case"control?":a|=1;break;case"alt":s|=2;break;case"alt?":a|=2;break;case"meta":s|=4;break;case"meta?":a|=4;break;case"shift":s|=8;break;case"shift?":a|=8;break;default:if(i===void 0)i=l;else{i=void 0;break e}}if(i===void 0||s&a)throw new Error(`Invalid event identifier: ${ie(n)}`);return{phase:t,keyName:i,modifiers:s,optionalModifiers:a}}function*Z_(n,e,t){t===0&&(yield Wg(n,e));for(let r=0;r<16;++r)(r&(e|t))===r&&(r&e)===e&&(yield Wg(n,r))}function*s1(n){const e=n.phase,t=Z_(n.keyName,n.modifiers,n.optionalModifiers);if(e===void 0)for(const r of t)yield`at:${r}`,yield`bubble:${r}`;else for(const r of t)yield`${e}:${r}`}function Q_(n,e){const t=K_(n.keyName,n.modifiers,n.optionalModifiers);return typeof e=="string"?{action:e,originalEventIdentifier:t}:j(j({},e),{originalEventIdentifier:t})}class at extends X_{static fromObject(e,t={}){const r=new at;if(r.label=t.label,t.parents!==void 0)for(const s of t.parents){var i=ae(s,2);const a=i[0],l=i[1];r.addParent(a,l)}for(const s of Qt(e))r.set(s,e[s]);return r}setFromObject(e){for(const t of Qt(e))this.set(t,e[t])}set(e,t){const r=i1(e),i=Q_(r,t);for(const s of s1(r))super.set(s,i)}delete(e){for(const t of s1(i1(e)))super.delete(t)}describe(){const e=[],t=new de;for(const s of this.entries()){var r=ae(s,2);const a=r[1];t.set(a.originalEventIdentifier,a.action)}for(const s of t){var i=ae(s,2);const a=i[0],l=i[1];e.push(`${a}→${l}`)}return e.join(", ")}}function x2(n,e,t){if(t===void 0)return;t.stopPropagation!==!1&&n.stopPropagation();const r=new CustomEvent("action:"+t.action,{bubbles:!0,detail:e,cancelable:!0}),i=!n.target.dispatchEvent(r);(t.preventDefault!==!1||i)&&n.preventDefault()}const mh=[];mh[Event.AT_TARGET]="at";mh[Event.CAPTURING_PHASE]="capture";mh[Event.BUBBLING_PHASE]="bubble";function E2(n,e,t,r,i){const s=mh[t]+":"+n,a=i.get(s);x2(e,r,a)}function T2(n,e,t,r){E2(Wg(n,Xv(e)),e,e.eventPhase,t,r)}function ve(n,e,t,r){return Lr(n,`action:${e}`,t,r)}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Rf;function eU(){if(Rf===void 0){const n=new at;n.set("keyl","recolor"),n.set("keyx","clear-segments"),n.set("keys","toggle-show-slices"),n.set("keyb","toggle-scale-bar"),n.set("keyv","toggle-default-annotations"),n.set("keya","toggle-axis-lines"),n.set("keyo","toggle-orthographic-projection");for(let e=1;e<=9;++e)n.set("digit"+e,"toggle-layer-"+e),n.set("control+digit"+e,"select-layer-"+e),n.set("alt+digit"+e,"toggle-pick-layer-"+e);for(let e=0;e<26;++e){const t=String.fromCharCode(97+e),r=String.fromCharCode(65+e);n.set(`alt?+control?+shift+key${t}`,`tool-${r}`)}n.set("keyn","add-layer"),n.set("keyh","help"),n.set("space","toggle-layout"),n.set("shift+space","toggle-layout-alternative"),n.set("backslash","toggle-show-statistics"),Rf=n}return Rf}let Mf;function vh(){return Mf===void 0&&(Mf=at.fromObject({"control+mousedown2":"select-position"})),Mf}let Af;function tU(){return Af===void 0&&(Af=at.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[vh(),0]]})),Af}let Nf;function k2(){return Nf===void 0&&(Nf=at.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:alt+mousedown2":"copy-segment-id","at:alt+shift+mousedown2":"add-copy-segment-id","at:dblclick0":"select","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[vh(),0]]})),Nf}let Vf;function nU(){return Vf===void 0&&(Vf=at.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[k2(),Number.NEGATIVE_INFINITY]]})),Vf}let Of;function rU(){return Of===void 0&&(Of=at.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[k2(),Number.NEGATIVE_INFINITY]]})),Of}function iU(n){n.global.addParent(eU(),Number.NEGATIVE_INFINITY),n.sliceView.addParent(rU(),Number.NEGATIVE_INFINITY),n.perspectiveView.addParent(nU(),Number.NEGATIVE_INFINITY)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Xe(n){for(;;){let e=n.firstChild;if(!e)break;n.removeChild(e)}}function Et(n){let e=n.parentElement;return e?(e.removeChild(n),!0):!1}function _n(n,e=Math.max(1,n.value.length)){const t=`${e}ch`;n.style.width!==t&&(n.style.width="0px",n.offsetWidth,n.style.width=t)}function Yr(n,e){let t=n.firstElementChild;for(const r of e)r!==t&&n.insertBefore(r,t),t=r.nextElementSibling;for(;t!==null;){let r=t.nextElementSibling;n.removeChild(t),t=r}}function Kv(n){return n instanceof HTMLElement?!!(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement||n.isContentEditable):!1}function sU(n){const e=n.cloneNode(!0);return e.style.position="absolute",document.body.appendChild(e),e.getBoundingClientRect()}let no,Gl=[];function aU(){if(no===void 0){const n=no=document.createElement("div");n.classList.add("neuroglancer-drag-status"),document.body.appendChild(n)}return no}function oU(){no!==void 0&&(Xe(no),no.style.display="none")}function L2(n){const e=aU();Xe(e),typeof n=="string"?e.appendChild(document.createTextNode(n)):e.appendChild(n()),e.style.display=""}function I2(n,e){zT(Gl,t=>!(t.target===n&&t.operation===e))}function Xr(n,e,t){I2(n,e),Gl.push({target:n,operation:e,status:t}),L2(t)}function fn(n,e){I2(n,e);const t=Gl.length===0?void 0:Gl[Gl.length-1];t===void 0?oU():L2(t.status)}const lU=300,dU=100,la={side:"right",col:0,row:1/0,flex:1,size:lU,minSize:dU,visible:!1};class Ls{constructor(e=la,t=e){this.defaultValue=e,this.value=t,this.changed=new Ze,this.locationChanged=new Ze,this.locationChanged.add(this.changed.dispatch);const r=this;this.watchableVisible={get value(){return r.visible},set value(i){r.visible=i},changed:r.locationChanged}}toJSON(e=this.defaultValue){const t={},r=this.value;for(const i in r)r[i]!==e[i]&&(t[i]=r[i]);return t}get visible(){return this.value.visible}set visible(e){const t=this.value;t.visible!==e&&(this.value=j(j({},t),{visible:e}),this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e,t=this.defaultValue){if(e===void 0)return;ge(e);const r={side:ye(e,"side",i=>{if(i!=="left"&&i!=="right"&&i!=="top"&&i!=="bottom")throw new Error(`Expected "left", "right", "top", or "bottom", but received: ${ie(i)}`);return i},t.side),col:ye(e,"col",vt,t.col),row:ye(e,"row",vt,t.row),flex:ye(e,"flex",vt,t.flex),size:ye(e,"size",on,t.size),visible:ye(e,"visible",oo,t.visible),minSize:t.minSize};this.value=r,this.locationChanged.dispatch()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Rr(n,e,t){const r=n.view.document;let i=n.clientX,s=n.clientY;const a=h=>{const g=h.clientX-i,v=h.clientY-s;i=h.clientX,s=h.clientY,e(h,g,v)},l=n.button,c=h=>{r.removeEventListener("pointermove",a,!0),r.removeEventListener("pointerup",u,!1),t!==void 0&&t(h,h.clientX-i,h.clientY-s)},u=h=>{h.button===l&&c(h)};r.addEventListener("pointermove",a,!0),r.addEventListener("pointerup",u,!1),r.addEventListener("pointercancel",c,!1)}const cU="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='closeIconTitle'%3e%3ctitle%20id='closeIconTitle'%3eClose%3c/title%3e%3cpath%20d='M6.34314575%206.34314575L17.6568542%2017.6568542M6.34314575%2017.6568542L17.6568542%206.34314575'/%3e%3c/svg%3e",uU="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='refreshIconTitle'%3e%3ctitle%20id='refreshIconTitle'%3eRefresh%3c/title%3e%3cpolyline%20points='22%2012%2019%2015%2016%2012'/%3e%3cpath%20d='M11,20%20C6.581722,20%203,16.418278%203,12%20C3,7.581722%206.581722,4%2011,4%20C15.418278,4%2019,7.581722%2019,12%20L19,14'/%3e%3c/svg%3e";function ft(n){const e=n.title,t=n.onClick,r=n.href;let i;r!==void 0?(i=document.createElement("a"),i.href=r,i.target="_blank"):i=document.createElement("div"),e!==void 0&&(i.title=e),t!==void 0&&i.addEventListener("click",t);const s=n.svg;return i.className="neuroglancer-icon",s!==void 0&&(i.innerHTML=s),n.text!==void 0&&i.appendChild(document.createTextNode(n.text)),i}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Zv(n={}){return ft(j({svg:cU},n))}function hU(n={}){return ft(j({svg:uU},n))}const ro="neuroglancer-drag-over",a1={row:"row",column:"col"},pU={left:"right",right:"left",top:"bottom",bottom:"top"},is={left:"column",right:"column",top:"row",bottom:"row"},Mc={left:"row",right:"row",top:"column",bottom:"column"},Wa={row:"width",column:"height"},o1={row:"left",column:"top"},fU={row:"right",column:"bottom"},l1={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},Ac={left:-1,right:1,top:-1,bottom:1};class da extends K{constructor(e,t=new Ls){super(),this.sidePanelManager=e,this.location=t,this.element=document.createElement("div"),this.visibility=new Nt(Nt.VISIBLE);const r=this.element;r.classList.add("neuroglancer-side-panel"),r.draggable=!0,r.addEventListener("dragstart",i=>{this.sidePanelManager.startDrag(this.makeDragSource(),i),r.style.backgroundColor="black",setTimeout(()=>{r.style.backgroundColor=""},0),Xr(r,"drag",()=>document.createTextNode("Drag side panel to move it to the left/right/top/bottom of another panel"))}),r.addEventListener("dragend",i=>{this.sidePanelManager.endDrag(),fn(r,"drag")})}makeDragSource(){return{dropAsNewPanel:e=>{const t=this.location.value;this.location.value=j(j({},t),e),this.location.locationChanged.dispatch()}}}close(){this.location.visible=!1}addTitleBar(e){const t=document.createElement("div");t.classList.add("neuroglancer-side-panel-titlebar");const r=e.title;let i;r!==void 0&&(i=document.createElement("div"),i.classList.add("neuroglancer-side-panel-title"),i.textContent=r,t.appendChild(i));const s=Zv({title:"Close panel",onClick:()=>{this.close()}});return s.style.order="100",t.appendChild(s),this.element.appendChild(t),{titleBar:t,titleElement:i,closeButton:s}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",t=>{t.preventDefault(),t.stopPropagation()}),this.element.appendChild(e)}}class gU extends K{constructor(e,t,r=new Nt(Nt.VISIBLE)){super(),this.display=e,this.center=t,this.visibility=r,this.element=document.createElement("div"),this.centerColumn=document.createElement("div"),this.beforeRender=new Ze,this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")},this.registeredPanels=new ze,this.layoutNeedsUpdate=!1,this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};const i=this.element,s=this.centerColumn;i.style.display="flex",i.style.flex="1",i.style.flexDirection="row",s.style.display="flex",s.style.flex="1",s.style.flexDirection="column",s.style.flexBasis="0px",s.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add(()=>{this.beforeRender.dispatch(),this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)})),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}get visible(){return this.visibility.visible}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,Ac[e]*(1/0),0,e,!1)}}hasDroppablePanel(){return this.dragSource!==void 0}startDrag(e,t){setTimeout(()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")},0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,r,i,s=!1){const a=document.createElement("div");a.className="neuroglancer-side-panel-drop-zone";const l=10,c=is[i],u=Mc[i];return a.style[Wa[u]]=`${l}px`,a.style[Wa[c]]="100%",s?(a.style.position="absolute",a.style[i]="50%",a.style[l1[i]]="-${size/2}px"):(a.style.position="relative",a.style[l1[pU[i]]]=`-${l}px`),a.addEventListener("dragenter",h=>{this.hasDroppablePanel()&&(a.classList.add(ro),h.preventDefault(),Xr(a,"drop",()=>document.createTextNode(`Drop side panel as new ${c}`)))}),a.addEventListener("dragleave",()=>{fn(a,"drop"),a.classList.remove(ro)}),a.addEventListener("dragover",h=>{this.hasDroppablePanel()&&h.preventDefault()}),a.addEventListener("drop",h=>{const g=this.dragSource;if(g===void 0)return;fn(a,"drop"),a.classList.remove(ro);const v=is[e];g.dropAsNewPanel({side:e,row:v==="column"?r:t,col:v==="row"?r:t}),this.dragSource=void 0,h.preventDefault(),h.stopPropagation()}),a}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){var t;this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),(t=e.panel)===null||t===void 0||t.dispose(),this.invalidateLayout()}disposed(){for(const e of this.registeredPanels)e.panel?.dispose();super.disposed()}render(){this.layoutNeedsUpdate=!1;const e={left:[],right:[],top:[],bottom:[]};for(const a of this.registeredPanels)e[a.location.value.side].push(a);const t=a=>this.renderSide(a,this.sides[a].flexGroups,e[a]),r=this;function*i(){yield r.sides.left.outerDropZoneElement,yield*t("left"),yield r.centerColumn,yield*t("right"),yield r.sides.right.outerDropZoneElement}Yr(this.element,i());function*s(){yield r.sides.top.outerDropZoneElement,yield*t("top"),yield r.center,yield*t("bottom"),yield r.sides.bottom.outerDropZoneElement}Yr(this.centerColumn,s())}makeCrossGutter(e,t){const r=document.createElement("div");r.style.position="relative";const i=Mc[e];r.className=`neuroglancer-resize-gutter-${i==="row"?"horizontal":"vertical"}`,r.addEventListener("pointerdown",a=>{if("button"in a&&a.button!==0)return;a.preventDefault();const l=this.sides[e].flexGroups[t];if(l===void 0||!l.visible)return;let c=l.element.getBoundingClientRect()[Wa[i]];const u=l.minSize,h=()=>{Xr(r,"drag",`Drag to resize, current ${Wa[i]} is ${l.crossSize}px`)};h(),Rr(a,(g,v,y)=>{const C=i==="row"?v:y;c-=Ac[e]*C,l.crossSize=Math.max(u,Math.round(c)),h(),this.invalidateLayout()},()=>{fn(r,"drag")})});const s=this.makeDropZone(e,t-Ac[e]*.5,0,e,!0);return r.appendChild(s),r}makeFlexGutter(e,t,r){const i=document.createElement("div");i.style.position="relative";const s=is[e];i.className=`neuroglancer-resize-gutter-${s==="row"?"horizontal":"vertical"}`,i.addEventListener("pointerdown",l=>{if("button"in l&&l.button!==0)return;l.preventDefault();const c=this.sides[e].flexGroups[t];if(c===void 0||!c.visible)return;const u=c.cells,h=u[r];if(h===void 0||!h.registeredPanel.location.visible)return;let g=r+1;for(;g<u.length&&!u[g].registeredPanel.location.visible;)++g;if(g===u.length)return;const v=u[g],y=()=>{Xr(i,"drag",`Drag to resize, current ${Wa[s]} ratio is ${h.registeredPanel.location.value.flex} : ${v.registeredPanel.location.value.flex}`)};y(),Rr(l,C=>{const S=h.registeredPanel.panel,w=v.registeredPanel.panel;if(S===void 0||w===void 0)return;const E=S.element.getBoundingClientRect(),k=w.element.getBoundingClientRect(),P=Math.max(.1,Math.min(.9,s==="column"?(C.clientY-E.top)/(k.bottom-E.top):(C.clientX-E.left)/(k.right-E.left))),D=h.registeredPanel.location.value,L=v.registeredPanel.location.value,R=D.flex+L.flex;h.registeredPanel.location.value=j(j({},D),{flex:Math.round(P*R*100)/100}),v.registeredPanel.location.value=j(j({},L),{flex:Math.round((1-P)*R*100)/100}),y(),h.registeredPanel.location.locationChanged.dispatch(),v.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()},()=>{fn(i,"drag")})});const a=this.makeDropZone(e,t,r+.5,o1[is[e]],!0);return i.appendChild(a),i}renderSide(e,t,r){const i=a1[Mc[e]],s=a1[is[e]];r.sort((c,u)=>{const h=c.location.value,g=u.location.value,v=h[s]-g[s];return v!==0?v:h[i]-g[i]});const a=this;function*l(){let c=0,u=r.length,h=0;for(;c<u;){const g=r[c].location.value[s];let v=c,y=0,C=0;do{const k=r[v].location.value;if(k[s]!==g)break;k.visible&&(++y,C=Math.max(C,k.minSize)),++v}while(v<u);const S=y>0;let w=t[h];if(w===void 0){const k=a.makeCrossGutter(e,h),P=document.createElement("div");P.className=`neuroglancer-side-panel-${is[e]}`,w=t[h]={element:P,gutterElement:k,cells:[],crossSize:-1,minSize:C,visible:S,beginDropZone:a.makeDropZone(e,h,-1/0,o1[is[e]]),endDropZone:a.makeDropZone(e,h,1/0,fU[is[e]])}}else w.visible=S,w.minSize=C,w.crossSize=Math.max(w.crossSize,C);function*E(){yield w.beginDropZone;let k=0;for(let P=c,D=0;P<v;++P,++D){const L=r[P];let R=w.cells[D];R===void 0?R=w.cells[D]={registeredPanel:L,gutterElement:void 0}:R.registeredPanel=L;const M=R.registeredPanel.location.value;w.crossSize==-1&&(w.crossSize=Math.max(C,M.size)),(M[s]!==h||M[i]!==D||M.visible&&M.size!==w.crossSize)&&(R.registeredPanel.location.value=j(j({},M),{[s]:h,[i]:D,size:M.visible?w.crossSize:M.size}),R.registeredPanel.location.changed.dispatch());const V=M.visible&&a.visibility.visible;let B=L.panel;if(!V){B!==void 0&&(B.dispose(),L.panel=void 0);continue}++k,B===void 0&&(B=L.panel=L.makePanel()),B.element.style.flex=y>1?`${M.flex}`:"1",yield B.element,k===y?R.gutterElement=void 0:(R.gutterElement===void 0&&(R.gutterElement=a.makeFlexGutter(e,h,D)),yield R.gutterElement)}yield w.endDropZone}Yr(w.element,E()),w.cells.length=v-c,S&&(w.element.style[Wa[Mc[e]]]=`${w.crossSize}px`,Ac[e]>0?(yield w.gutterElement,yield w.element):(yield w.element,yield w.gutterElement)),c=v,++h}t.length=h}return l()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Yn(n,e="text/plain"){let t=!1;const r=Lr(document,"copy",i=>{const s=i.clipboardData;s!==null&&(s.setData(e,n),t=!0),i.stopPropagation(),i.preventDefault()},!0);try{document.execCommand("copy")}finally{r()}return t}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Bi extends K{constructor(e,t,r){super(),this.target=e,this.eventMap=t,this.registerEventListener(e,"wheel",i=>{r!==void 0&&r(i),this.dispatch("wheel",i)}),this.registerEventListener(e,"click",i=>{r!==void 0&&r(i),this.dispatch(`click${i.button}`,i)}),this.registerEventListener(e,"dblclick",i=>{r!==void 0&&r(i),this.dispatch(`dblclick${i.button}`,i)}),this.registerEventListener(e,"mousedown",i=>{r!==void 0&&r(i);let s=i.button;s===2&&(i.buttons&3)===1&&(s=0),this.dispatch(`mousedown${s}`,i)}),this.registerEventListener(e,"mouseup",i=>{r!==void 0&&r(i),this.dispatch(`mouseup${i.button}`,i)})}dispatch(e,t){T2(e,t,t,this.eventMap)}}class Gr extends K{constructor(e,t){super(),this.element=ft(j(j({},t),{onClick:()=>{e.value=!e.value}})),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add(t.backgroundScheme==="dark"?"dark-background":"light-background");const r=()=>{const i=e.value;this.element.dataset.checked=i?"true":"false",this.element.title=(i?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(r)),r()}}const mU="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='copyIconTitle'%3e%3ctitle%20id='copyIconTitle'%3eCopy%3c/title%3e%3crect%20width='12'%20height='14'%20x='8'%20y='7'/%3e%3cpolyline%20points='16%203%204%203%204%2017'/%3e%3c/svg%3e";function Zr(n={}){return ft(j({svg:mU},n))}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class vU extends K{constructor(e){super(),this.redraw=e}}class Qr extends K{constructor(e,t,r=new Nt(Nt.VISIBLE)){super(),this.model=e,this.render=t,this.visibility=r,this.element=document.createElement("div"),this.generation=-1,this.currentViewDisposer=void 0,this.debouncedUpdateView=this.registerCancellable(ct(()=>this.updateView())),this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(r.changed.add(()=>{this.visible&&this.debouncedUpdateView()})),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;const e=this.model;if(e.changed.count===this.generation)return;this.disposeCurrentView();const t=this.currentViewDisposer=new vU(this.debouncedUpdateView);this.render(e.value,this.element,t)}disposeCurrentView(){let e=this.currentViewDisposer;e!==void 0&&e.dispose(),Xe(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}}function D2(n={}){return ft(j({text:"↗"},n))}function d1(n){return n.closest(".neuroglancer-selection-details")}class c1 extends da{constructor(e,t,r,i){super(e,t.location),this.sidePanelManager=e,this.state=t,this.manager=r,this.selectedLayer=i,this.body=document.createElement("div");const s=this.element,a=this.body;s.classList.add("neuroglancer-selection-details"),this.registerDisposer(new Bi(this.element,vh()));var l=this.addTitleBar({title:"Selection"});const c=l.titleBar,u=ft({svg:S2,title:"Previous selection",onClick:()=>{this.state.goBack()}}),h=ft({svg:C2,title:"Next selection",onClick:()=>{this.state.goForward()}});c.appendChild(u),c.appendChild(h),c.appendChild(this.registerDisposer(new Gr(t.pin,{text:"📌︎",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),a.classList.add("neuroglancer-selection-details-body"),this.addBody(a),a.appendChild(this.registerDisposer(new Qr(t,(g,v,y)=>{if(!(!t.location.visible||(u.style.visibility=t.canGoBack()?"visible":"hidden",h.style.visibility=t.canGoForward()?"visible":"hidden",g===void 0))){if(g.position!==void 0){const S=document.createElement("div");S.classList.add("neuroglancer-selection-details-position");const w=Zr({title:"Copy position",onClick:()=>{Yn(P.map(L=>Math.floor(L)).join(", "))}});S.appendChild(w);var C=g.coordinateSpace;const E=C.rank,k=C.names,P=g.position;for(let L=0;L<E;++L){const R=document.createElement("span");R.classList.add("neuroglancer-selection-details-position-dimension");const M=document.createElement("span");M.classList.add("neuroglancer-selection-details-position-dimension-name"),M.textContent=k[L];const V=document.createElement("span");V.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),V.textContent=Math.floor(P[L]).toString(),R.appendChild(M),R.appendChild(V),S.appendChild(R)}const D=D2({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=P}});S.appendChild(D),v.appendChild(S)}for(const S of g.layers){const w=S.layer;v.appendChild(y.registerDisposer(new Qr({value:void 0,changed:w.managedLayer.layerChanged},(E,k,P)=>{if(w.wasDisposed||!w.isReady)return;const D=document.createElement("div");if(D.classList.add("neuroglancer-selection-details-layer-body"),!w.displaySelectionState(S.state,D,P))return;const L=document.createElement("div");k.appendChild(L),L.classList.add("neuroglancer-selection-details-layer");const R=document.createElement("div");R.classList.add("neuroglancer-selection-details-layer-title"),R.textContent=w.managedLayer.name,R.addEventListener("click",()=>{this.selectedLayer.layer=w.managedLayer,this.selectedLayer.visible=!0}),R.title="Click to show layer side panel",L.appendChild(R),L.appendChild(D)})).element)}}})).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}}const yU="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='filterIconTitle'%3e%3ctitle%20id='filterIconTitle'%3eFilter%3c/title%3e%3cpath%20d='M10%2012.261L4.028%203.972h16L14%2012.329V17l-4%203z'/%3e%3c/svg%3e";function bU(n={}){return ft(j({svg:yU},n))}class vs{constructor(e,t,r){this.key=e,this.value=t,this.label=r}toString(){const e=this.key,t=this.value,r=this.label;let i;return t===void 0?i=`${e}`:i=`${e}→${t}`,r===void 0?i:`${i} ${r}`}}class wU extends K{constructor(){super(...arguments),this.selectedSegment=new te,this.baseSelectedSegment=new te,this.hasSelectedSegment=!1,this.changed=new we}get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e,t=!1){const r=this.selectedSegment,i=this.baseSelectedSegment;let s=0,a=0,l=0,c=0,u;if(e==null)u=!1;else if(typeof e=="number")s=l=e>>>0,a=c=e<0?4294967295:0,u=!0;else if(e instanceof vs){const h=e.value||e.key;s=h.low,a=h.high,l=e.key.low,c=e.key.high,u=!0}else e instanceof te?(s=l=e.low,a=c=e.high,u=!0):u=!1;t&&s===0&&a===0&&(u=!1),u?u&&(!this.hasSelectedSegment||r.low!==s||r.high!==a||i.low!==l||i.high!==c)&&(r.low=s,r.high=a,i.low=l,i.high=c,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&te.equal(e,this.selectedSegment)}bindTo(e,t){this.registerDisposer(e.changed.add(()=>{const r=e.get(t);let i;r!==void 0&&(i=r.value),this.set(i,t.displayState.segmentationGroupState.value.hideSegmentZero.value)}))}}function wu(n){n.useTemporarySegmentEquivalences.value=!1,n.useTemporaryVisibleSegments.value=!1,n.temporaryVisibleSegments.clear(),n.temporarySegmentEquivalences.clear()}function P2(n,e,t=!1){let r,i,s,a;if(typeof e=="number"?r=new te(e>>>0,e<0?4294967295:0):typeof e=="string"?r=te.parseString(e):r=t?e.clone():e,n==null)return r;var l=n.segmentationGroupState.value;const c=l.segmentEquivalences,u=l.segmentPropertyMap.value;return c.size!==0?(i=c.get(r),te.equal(i,r)?s=void 0:s=i):i=r,a=u?.getSegmentLabel(i),a===void 0&&s==null?r:new vs(r,s,a)}function xo(n,e){if(e instanceof vs)return e;let t=P2(n,e);return t instanceof te?new vs(t):t}function u1(n,e){const t=e.length;n.value<t&&(n.value=t)}function sd(n,e){return ki(t=>e.style.setProperty("--neuroglancer-segment-list-width",`${t}ch`),n.segmentationGroupState.value.maxIdLength)}const Qv=(()=>{const n=document.createElement("div");n.classList.add("neuroglancer-segment-list-entry");const e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-sticky"),n.appendChild(e);const t=Zr({title:"Copy segment ID"});t.classList.add("neuroglancer-segment-list-entry-copy");const r=document.createElement("div");r.classList.add("neuroglancer-segment-list-entry-copy-container");const i=r.childElementCount;r.appendChild(t);const s=e.childElementCount;e.appendChild(r);const a=e.childElementCount,l=document.createElement("input");l.type="checkbox",l.title="Toggle segment visibility",l.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.appendChild(l);const c=document.createElement("div");c.classList.add("neuroglancer-segment-list-entry-id-container");const u=e.childElementCount;e.appendChild(c);const h=document.createElement("div");h.classList.add("neuroglancer-segment-list-entry-id");const g=c.childElementCount;c.appendChild(h);const v=document.createElement("span");v.classList.add("neuroglancer-segment-list-entry-name");const y=n.childElementCount;n.appendChild(v);const C=bU({title:"Filter by label"});C.classList.add("neuroglancer-segment-list-entry-filter");const S=n.childElementCount;return n.appendChild(C),{template:n,copyContainerIndex:s,copyIndex:i,visibleIndex:a,idContainerIndex:u,idIndex:g,labelIndex:y,filterIndex:S,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),SU=(()=>{const n=Qv,e=n.template.cloneNode(!0),t=e.children[0],r=t.children[n.idContainerIndex],i=r.childElementCount,s=r.children[n.idIndex].cloneNode(!0);s.classList.add("neuroglancer-segment-list-entry-unmapped-id"),r.appendChild(s);const a=t.children[n.copyContainerIndex],l=a.childElementCount;return a.appendChild(a.children[n.copyIndex].cloneNode(!0)),j(j({},n),{template:e,unmappedIdIndex:i,unmappedCopyIndex:l})})();function CU(n){let e=Qv;const t=e.template.cloneNode(!0),r=[];for(let i=0;i<n;++i){r.push(t.childElementCount);const s=document.createElement("div");s.classList.add("neuroglancer-segment-list-entry-extra-property"),s.style.width=`max(var(--neuroglancer-column-${i}-width), var(--neuroglancer-column-${i}-label-width))`,t.appendChild(s)}return j(j({},e),{template:t,numericalPropertyIndices:r})}const h1=new i2;function xU(n){const e=h=>{const g=h.currentTarget,v=g.dataset.id,y=Tr;y.tryParseString(v),n.segmentSelectionState.set(y),d1(g)||n.selectSegment(y,!1)},t=h=>{const g=h.currentTarget,v=g.dataset.id,y=Tr;y.tryParseString(v),n.selectSegment(y,d1(g)?"toggle":!0)},r=()=>{n.segmentSelectionState.set(null)},i=h=>h.currentTarget.closest(".neuroglancer-segment-list-entry"),s=h=>{const g=i(h);Yn(g.dataset.id),h.stopPropagation()},a=h=>{const g=i(h);Yn(g.dataset.unmappedId),h.stopPropagation()},l=h=>{const g=i(h).dataset.id,v=Tr;v.tryParseString(g);const y=n.segmentationGroupState.value.visibleSegments;y.set(v,!y.has(v)),h.stopPropagation()},c=h=>{const g=i(h).dataset.id,v=Tr;v.tryParseString(g),n.filterBySegmentLabel(v),h.stopPropagation()},u=h=>{if(h.button!==2||h.ctrlKey||h.altKey||h.metaKey||h.shiftKey)return;const g=h.currentTarget.dataset.id,v=Tr;v.tryParseString(g),n.moveToSegment(v)};return(h,g)=>{const v=h.children,y=v[0].children;h.addEventListener("mousedown",u);const C=y[g.copyContainerIndex];g.unmappedCopyIndex!==-1&&C.children[g.unmappedCopyIndex].addEventListener("click",a),C.children[g.copyIndex].addEventListener("click",s),h.addEventListener("mouseenter",e),h.addEventListener("mouseleave",r),y[g.visibleIndex].addEventListener("click",l),v[g.filterIndex].addEventListener("click",c),h.addEventListener("action:select-position",t)}}class Rd{constructor(e,t){if(this.displayState=e,this.template=t,e!==void 0){let r=h1.get(e);r===void 0&&(r=xU(e),h1.set(e,r)),this.registerEventHandlers=r}}static make(e,t){return new Rd(e,t?SU:Qv)}get(e){const t=this.displayState;return this.getWithNormalizedId(xo(t,e))}getWithNormalizedId(e){var t,r;const i=this.displayState,s=this.template,a=s.template.cloneNode(!0),l=e.key,c=(t=e.value)!==null&&t!==void 0?t:l,u=c.toString();a.dataset.id=u;const h=a.children,g=h[0].children,v=g[s.idContainerIndex];v.children[s.idIndex].textContent=u;const y=s.unmappedIdIndex;if(i!==void 0?this.registerEventHandlers(a,s):g[s.visibleIndex].style.display="none",y!==-1){const C=v.children[y];if(te.equal(l,c)){C.style.display="none";const S=g[s.copyContainerIndex];S.children[s.unmappedCopyIndex].style.display="none"}else{const S=l.toString();a.dataset.unmappedId=S,C.textContent=S,i!==void 0&&u1(i.segmentationGroupState.value.maxIdLength,S)}}return h[s.labelIndex].textContent=(r=e.label)!==null&&r!==void 0?r:"",i!==void 0&&(this.updateWithId(a,c),u1(i.segmentationGroupState.value.maxIdLength,u)),a}update(e){const t=Tr,r=e.dataset.id;r!==void 0&&(t.parseString(r),this.updateWithId(e,t))}updateWithId(e,t){const r=e.children[0].children,i=this.template,s=this.displayState,a=s.segmentSelectionState,l=s.segmentationGroupState.value.visibleSegments;r[i.visibleIndex].checked=l.has(t),e.dataset.selected=(a.hasSelectedSegment&&te.equal(a.selectedSegment,t)).toString();const c=r[i.idContainerIndex];p1(c.children[i.idIndex],jg(this.displayState,t));const u=i.unmappedIdIndex;if(u!==-1){let h,g;if(s.baseSegmentColoring.value&&(h=e.dataset.unmappedId)!==void 0){const v=Tr;v.parseString(h),g=jg(this.displayState,v)}else g=ak;p1(c.children[u],g)}}}function p1(n,e){n.style.backgroundColor=w2(e),n.style.color=yg(e)?"white":"black"}class EU extends Rd{constructor(e,t,r){var i;const s=e.segmentationGroupState.value.segmentPropertyMap.value,a=((i=s?.numericalProperties)!==null&&i!==void 0?i:[]).filter(r),l=CU(a.length);super(e,l),this.parentElement=t,this.segmentPropertyMap=s,this.numericalProperties=a,(this.numericalPropertyWidths=new Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){var t,r,i;const s=super.getWithNormalizedId(e),a=this.numericalProperties,l=this.template.numericalPropertyIndices;if(l.length>0){const c=(i=(t=this.segmentPropertyMap)===null||t===void 0?void 0:t.getSegmentInlineIndex((r=e.value)!==null&&r!==void 0?r:e.key))!==null&&i!==void 0?i:-1;if(c!==-1){const u=this.numericalPropertyWidths;for(let h=0,g=l.length;h<g;++h){const v=a[h].values[c];if(!isNaN(v)){const y=v.toString(),C=y.length;C>u[h]&&(u[h]=C,this.parentElement.style.setProperty(`--neuroglancer-column-${h}-width`,`${C}ch`)),s.children[l[h]].textContent=y}}}}return s}makeHeaderLabel(e,t,r){const i=document.createElement("span");i.textContent=e,i.classList.add("neuroglancer-segment-list-header-label"),i.classList.add("neuroglancer-segment-list-header-label"),e==="label"&&(r.style.textAlign="left");const s=document.createElement("span");s.classList.add("neuroglancer-segment-list-header-label-sort"),i.appendChild(s),s.textContent="▲";const a=sU(i).width;return this.parentElement.style.setProperty(t,`${a}px`),r.appendChild(i),{id:e,label:i,sortIcon:s}}getHeader(){const e=this.template,t=e.template.cloneNode(!0),r=t.children,i=r[0].children,s=i[e.copyContainerIndex];s.style.visibility="hidden",i[e.visibleIndex].style.visibility="hidden",r[e.filterIndex].style.visibility="hidden";const a=i[e.idContainerIndex],l=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",a.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",r[e.labelIndex])],c=this.numericalProperties,u=this.template.numericalPropertyIndices;for(let h=0,g=u.length;h<g;++h){const v=c[h],y=this.makeHeaderLabel(v.id,`--neuroglancer-column-${h}-label-width`,t.children[u[h]]),C=v.description;C&&(y.label.title=C),l.push(y)}return{container:t,propertyLabels:l}}}function ey(n,e){return Rd.make(n??void 0,!0).getWithNormalizedId(e)}function Md(n,e,t){e.registerDisposer(ao((r,i)=>{pF(r,i,t)},n.segmentationGroupState)),e.registerDisposer(ao((r,i)=>{r.registerDisposer(i.segmentColorHash.changed.add(t)),r.registerDisposer(i.segmentDefaultColor.changed.add(t))},n.segmentationColorGroupState)),e.registerDisposer(n.saturation.changed.add(t)),e.registerDisposer(n.segmentSelectionState.changed.add(t)),e.registerDisposer(n.baseSegmentColoring.changed.add(t))}function R2(n,e){const t=e.redrawNeeded.dispatch;Md(n,e,t),e.registerDisposer(ao((r,i)=>{fF(r,i,t)},n.segmentationGroupState))}function TU(n,e){R2(n,e),e.registerDisposer(n.objectAlpha.changed.add(e.redrawNeeded.dispatch))}function ty(n,e){TU(n,e),e.registerDisposer(n.transform.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(n.renderScaleTarget.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(n.transparentPickEnabled.changed.add(e.redrawNeeded.dispatch))}const M2=eh(),Tr=new te;function jg(n,e,t=M2){if(n==null)return t.fill(1),t;const r=n.segmentationColorGroupState.value;if(r.segmentStatedColors.size!==0&&r.segmentStatedColors.get(e,Tr))return t[0]=(Tr.low&255)/255,t[1]=((Tr.low&65280)>>>8)/255,t[2]=((Tr.low&16711680)>>>16)/255,t;const i=r.segmentDefaultColor.value;return i!==void 0?(t[0]=i[0],t[1]=i[1],t[2]=i[2],t):(r.segmentColorHash.compute(t,e),t)}function A2(n,e,t=1){const r=M2;r[3]=t,jg(n,e,r);let i=n.saturation.value;n.segmentSelectionState.isSelected(e)&&(i>.5?i=i-=.5:i+=.5);for(let s=0;s<3;++s)r[s]=r[s]*i+(1-i);return r[0]*=t,r[1]*=t,r[2]*=t,r}function N2(n,e={}){for(const t of hF)e[t]=n[t].rpcId;return e}const kU=oh(Td);class ny extends kU{constructor(e,t,r){super(r),this.chunkManager=e,this.displayState=t}initializeCounterpartWithChunkManager(e){let t=this.displayState;e.chunkManager=this.chunkManager.rpcId,N2(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(mn.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(mn.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}}function ry(n,e,t,r,i){const s=Math.min(1,n.objectAlpha.value),a=n.baseSegmentColoring.value;Bo(n.segmentationGroupState.value,(l,c)=>{let u=r?.registerUint64(e,l),h=t?A2(n,a?l:c,s):void 0;i(l,h,u,c)})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var V2=function(n,e,t,r){var i=arguments.length,s=i<3?e:r===null?r=Ar(e,t):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,r);else for(var l=n.length-1;l>=0;l--)(a=n[l])&&(s=(i<3?a(s):i>3?a(e,t,s):a(e,t))||s);return i>3&&s&&Mr(e,t,s),s};const LU=Je(),rr=ud();function O2(n,e){e.vertexBuffer=$n.fromData(n,e.meshData.vertexPositions,n.ARRAY_BUFFER,n.STATIC_DRAW),e.indexBuffer=$n.fromData(n,e.meshData.indices,n.ELEMENT_ARRAY_BUFFER,n.STATIC_DRAW),e.normalBuffer=$n.fromData(n,e.meshData.vertexNormals,n.ARRAY_BUFFER,n.STATIC_DRAW)}function B2(n){n.vertexBuffer.dispose(),n.indexBuffer.dispose(),n.normalBuffer.dispose()}const IU=`
highp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {
  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));
  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);
  return normalize(v);
}
`;function f1(n){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(e,t,r){r.vertexBuffer.bindToVertexAttrib(t.attribute("aVertexPosition"),3,n,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}const DU={[Ii.float32]:f1(WebGL2RenderingContext.FLOAT),[Ii.uint16]:f1(WebGL2RenderingContext.UNSIGNED_SHORT),[Ii.uint10]:{defineShader:n=>{n.addAttribute("highp uint","aVertexPosition"),n.addVertexCode(`
highp vec3 getVertexPosition() {
  return vec3(float(aVertexPosition & 1023u),
              float((aVertexPosition >> 10) & 1023u),
              float((aVertexPosition >> 20) & 1023u)) / 1023.0;
}
`)},bind(n,e,t){t.vertexBuffer.bindToVertexAttribI(e.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(n,e)=>{n.disableVertexAttribArray(e.attribute("aVertexPosition"))}}};class F2{constructor(e,t){this.fragmentRelativeVertices=e,this.vertexPositionFormat=t,this.tempLightVec=new Float32Array(4),this.vertexPositionHandler=DU[this.vertexPositionFormat]}beginLayer(e,t,r,i){let s=r.lightDirection,a=r.ambientLighting,l=r.directionalLighting,c=this.tempLightVec;rv(c,s,l),c[3]=a,e.uniform4fv(t.uniform("uLightDirection"),c);const u=i.silhouetteRendering.value;u>0&&e.uniform1f(t.uniform("uSilhouettePower"),u)}setColor(e,t,r){e.uniform4fv(t.uniform("uColor"),r)}setPickID(e,t,r){e.uniform1ui(t.uniform("uPickID"),r)}beginModel(e,t,r,i){const s=r.projectionParameters;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,en(LU,s.viewProjectionMat,i)),th(rr,i),ck(rr,rr,s.displayDimensionRenderInfo.canonicalVoxelFactors),IN(rr,rr),LN(rr,rr),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,rr)}drawFragmentHelper(e,t,r,i,s){this.vertexPositionHandler.bind(e,t,r);const a=r.meshData;r.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),r.indexBuffer.bind();const l=a.indices;e.drawElements(a.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,s-i,l.BYTES_PER_ELEMENT===2?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,i*l.BYTES_PER_ELEMENT)}drawFragment(e,t,r){const i=r.meshData.indices;this.drawFragmentHelper(e,t,r,0,i.length)}drawMultiscaleFragment(e,t,r,i,s){const a=r.meshData.subChunkOffsets[i],l=r.meshData.subChunkOffsets[s];this.drawFragmentHelper(e,t,r,a,l)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){const t=e.registerDisposer(dr(r=>r>0,[e.displayState.silhouetteRendering]));return ho(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(r,i)=>{this.vertexPositionHandler.defineShader(r),r.addAttribute("highp vec2","aVertexNormal"),r.addVarying("highp vec4","vColor"),r.addUniform("highp vec4","uLightDirection"),r.addUniform("highp vec4","uColor"),r.addUniform("highp mat3","uNormalMatrix"),r.addUniform("highp mat4","uModelViewProjection"),r.addUniform("highp uint","uPickID"),i&&r.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(r.addUniform("highp vec3","uFragmentOrigin"),r.addUniform("highp vec3","uFragmentShape")),r.addVertexCode(IU);let s="";this.fragmentRelativeVertices?s+=`
highp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();
highp vec3 normalMultiplier = 1.0 / uFragmentShape;
`:s+=`
highp vec3 vertexPosition = getVertexPosition();
highp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);
`,s+=`
gl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);
vec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);
vec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));
float absCosAngle = abs(dot(normal, uLightDirection.xyz));
float lightingFactor = absCosAngle + uLightDirection.w;
vColor = vec4(lightingFactor * uColor.rgb, uColor.a);
`,i&&(s+=`
vColor *= pow(1.0 - absCosAngle, uSilhouettePower);
`),r.setVertexMain(s),r.setFragmentMain("emit(vColor, uPickID);")}})}}class g1 extends Uo{constructor(e,t,r){super(),this.chunkManager=e,this.source=t,this.displayState=r,this.meshShaderManager=new F2(!1,Ii.float32),this.getShader=this.meshShaderManager.makeGetter(this),ty(r,this),this.registerDisposer(r.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new ny(e,r,this.layerChunkProgressInfo));i.RPC_TYPE_ID=C_,i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(r.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){const e=this.displayState;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const r=this.gl,i=this.displayState,s=this.meshShaderManager;if(i.objectAlpha.value<=0)return;const a=hu(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(a===void 0)return;var l=this.getShader(e.emitter);const c=l.shader;if(c===null)return;c.bind(),s.beginLayer(r,c,e,this.displayState),s.beginModel(r,c,e,a);const u=this.source.chunks;let h=0,g=0;const v=this.displayState.renderScaleHistogram,y=this.source.fragmentSource.chunks;ry(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(C,S,w)=>{const E=Jr(C),k=u.get(E);if(++h,k!==void 0){++g,e.emitColor&&s.setColor(r,c,S),e.emitPickID&&s.setPickID(r,c,w),h+=k.fragmentIds.length;for(const D of k.fragmentIds){var P=this.source.getFragmentKey(E,D);const L=P.key,R=y.get(L);R!==void 0&&R.state===pt.GPU_MEMORY&&(s.drawFragment(r,c,R),++g)}}}),e.emitColor&&(v.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),v.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,g,h-g)),s.endLayer(r,c)}isReady(){const e=this.displayState,t=this.source;let r=!0;const i=t.fragmentSource.chunks;return Bo(e.segmentationGroupState.value,s=>{const a=Jr(s),l=t.chunks.get(a);if(l===void 0){r=!1;return}for(const u of l.fragmentIds){var c=this.source.getFragmentKey(a,u);const h=c.key,g=i.get(h);if(g===void 0||g.state!==pt.GPU_MEMORY){r=!1;return}}}),r}}class PU extends ks{constructor(e,t){super(e),this.fragmentIds=t.fragmentIds}}class RU extends ks{constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),O2(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),B2(this)}}class Ad extends Oi{constructor(e,t){super(e,t),this.fragmentSource=this.registerDisposer(new Hg(this.chunkManager,this))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new PU(this,e)}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}}let Hg=class extends Oi{constructor(n,e){super(n),this.meshSource=e}get key(){return this.meshSource.key}getChunk(n){return new RU(this,n)}};Hg=V2([hr(E_)],Hg);function m1(n,e,t,r){const i=n.get(f2(e,t,r));return i!==void 0&&i.state===pt.GPU_MEMORY}class Bf extends Uo{constructor(e,t,r){super(),this.chunkManager=e,this.source=t,this.displayState=r,this.meshShaderManager=new F2(this.source.format.fragmentRelativeVertices,this.source.format.vertexPositionFormat),this.getShader=this.meshShaderManager.makeGetter(this),ty(r,this),this.registerDisposer(r.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new ny(e,r,this.layerChunkProgressInfo));i.RPC_TYPE_ID=x_,i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(r.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){const e=this.displayState;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const r=this.gl,i=this.displayState,s=this.meshShaderManager;if(i.objectAlpha.value<=0)return;const a=hu(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(a===void 0)return;var l=this.getShader(e.emitter);const c=l.shader;if(c===null)return;c.bind(),s.beginLayer(r,c,e,this.displayState);const u=this.displayState.renderScaleHistogram;e.emitColor&&u.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),th(rr,a),ck(rr,rr,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);const h=Math.pow(Math.abs(tv(rr)),1/3),g=this.source.chunks,v=this.source.fragmentSource.chunks,y=e.projectionParameters,C=en(Je(),y.viewProjectionMat,a),S=nu(new Float32Array(24),C),w=this.displayState.renderScaleTarget.value,E=this.source.format.fragmentRelativeVertices;s.beginModel(r,c,e,a);let k=0,P=0;ry(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(D,L,R)=>{const M=Jr(D),V=g.get(M);if(++k,V===void 0)return;++P;const B=V.manifest,_=B.octree,H=B.chunkShape,U=B.chunkGridSpatialOrigin,O=B.vertexOffsets;e.emitColor&&s.setColor(r,c,L),e.emitPickID&&s.setPickID(r,c,R),jx(B,C,S,w,y.width,y.height,(z,F,se)=>{const oe=m1(v,M,z,F);return e.emitColor&&u.add(B.lodScales[z]*h,se,oe?1:0,oe?0:1),oe},(z,F,se,oe)=>{const Re=f2(M,z,F),le=v.get(Re),Se=_[5*F],ne=_[5*F+1],he=_[5*F+2],Le=1<<z;E&&(r.uniform3f(c.uniform("uFragmentOrigin"),U[0]+Se*H[0]*Le+O[z*3+0],U[1]+ne*H[1]*Le+O[z*3+1],U[2]+he*H[2]*Le+O[z*3+2]),r.uniform3f(c.uniform("uFragmentShape"),H[0]*Le,H[1]*Le,H[2]*Le)),s.drawMultiscaleFragment(r,c,le,se,oe)})}),u.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,P,k-P),s.endLayer(r,c)}isReady(e,t){let r=this.displayState;if(r.objectAlpha.value<=0)return!0;const i=hu(r.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(i===void 0)return!1;const s=this.source.chunks,a=this.source.fragmentSource.chunks,l=e.projectionParameters,c=en(Je(),l.viewProjectionMat,i),u=nu(new Float32Array(24),c),h=this.displayState.renderScaleTarget.value;let g=!0;return Bo(r.segmentationGroupState.value,v=>{if(!g)return;const y=Jr(v),C=s.get(y);if(C===void 0){g=!1;return}const S=C.manifest;jx(S,c,u,h,l.width,l.height,(w,E)=>(g=g&&m1(a,y,w,E),g),()=>{})}),g}getObjectPosition(e){const t=this.displayState.transform.value;if(t.error!==void 0)return;const r=this.source.chunks.get(Jr(e));if(r===void 0)return;const i=r.manifest,s=i.clipLowerBound,a=i.clipUpperBound,l=t.rank,c=new Float32Array(l);for(let h=0;h<3;++h)c[h]=(s[h]+a[h])/2;const u=new Float32Array(l);return Ti(u,t.modelToRenderLayerTransform,l+1,c,l),u}}class MU extends ks{constructor(e,t){super(e),this.manifest=t.manifest}}class AU extends ks{constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),O2(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),B2(this)}}class yh extends Oi{constructor(e,t){super(e,t),this.fragmentSource=this.registerDisposer(new qg(this.chunkManager,this)),this.format=t.format}static encodeOptions(e){return j({format:e.format},super.encodeOptions(e))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new MU(this,e)}}let qg=class extends Oi{constructor(n,e){super(n),this.meshSource=e}get key(){return this.meshSource.key}getChunk(n){return new AU(this,n)}};qg=V2([hr(T_)],qg);var v1={},y1;function NU(){if(y1)return v1;y1=1;var n=Ot(),e=n2()(!1);return n(n.S,"Object",{values:function(t){return e(t)}}),v1}var b1,w1;function VU(){return w1||(w1=1,NU(),b1=ut().Object.values),b1}var S1,C1;function OU(){return C1||(C1=1,S1={default:VU(),__esModule:!0}),S1}var BU=OU();const Jg=Qe(BU);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const FU="skeleton/SkeletonLayer";/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const iy=6,sy=`
vec2 getQuadVertexPosition(vec2 lower, vec2 upper) {
  const vec2 coeffs[] = vec2[](
    vec2(0.0, 0.0),
    vec2(0.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 0.0),
    vec2(0.0, 0.0)
  );
  int v = gl_VertexID % 6;
  return mix(lower, upper, coeffs[v]);
}
`;function ay(n,e,t){n.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,iy*e,t)}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function _U(n,e){const t=new Float32Array((n+1)*(e+1)*3);let r=0;for(let i=0;i<=n;++i){const s=i*Math.PI/n,a=Math.sin(s),l=Math.cos(s);for(let c=0;c<=e;++c){const u=c*2*Math.PI/e,h=Math.sin(u),g=Math.cos(u);t[r++]=g*a,t[r++]=l,t[r++]=h*a}}return t}function UU(n,e){const t=new Uint16Array(n*e*6);let r=0;for(let i=0;i<n;i++)for(let s=0;s<e;s++){const a=i*(e+1)+s,l=a+e+1;t[r++]=a,t[r++]=l,t[r++]=a+1,t[r++]=l,t[r++]=l+1,t[r++]=a+1}return t}class _2 extends K{constructor(e,t,r){super(),this.vertexBuffer=this.registerDisposer(Zl(e,WebGL2RenderingContext.ARRAY_BUFFER,_U,t,r)).value,this.indexBuffer=this.registerDisposer(Zl(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,UU,t,r)).value,this.numIndices=t*r*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode(`
void emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {
  vec3 vertexPosition = aSphereVertex * radii + centerPosition;
  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);
  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);
  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
}
`)}draw(e,t){const r=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(r)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const oy=iy;function Nd(n,e){n.addVertexCode(sy),n.addUniform("highp vec3","uCircleParams"),n.addVarying("highp vec4","vCircleCoord"),n.addVertexCode(`
void emitCircle(vec4 position, float diameter, float borderWidth) {
  gl_Position = position;
  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);
  if (diameter == 0.0) totalDiameter = 0.0;
  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;
  vCircleCoord.xy = circleCornerOffset;
  if (borderWidth == 0.0) {
    vCircleCoord.z = totalDiameter;
    vCircleCoord.w = 1e-6;
  } else {
    vCircleCoord.z = diameter / totalDiameter;
    vCircleCoord.w = uCircleParams.z / totalDiameter;
  }
}
`),e?n.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);
}
`):n.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0;
}
`),n.addFragmentCode(`
vec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {
  float radius = length(vCircleCoord.xy);
  if (radius > 1.0) {
    discard;
  }

  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);

  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());
}
`)}function Vd(n,e,t){n.gl.uniform3f(n.uniform("uCircleParams"),1/e.width,1/e.height,Math.max(1e-6,t.featherWidthInPixels))}function Od(n,e,t){ay(n,e,t)}class $U extends K{constructor(e){super(),this.lightDirection=new Float32Array([1,0,0,0]),this.sphereHelper=this.registerDisposer(new _2(e,20,20))}defineShader(e){e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVertexCode(`
float getRadiusAdjustment(vec3 vertex, float r) {
  float radiusAdjustment = 1.0;
  for (int i = 0; i < 3; ++i) {
    if (r != 0.0) {
      float d = vertex[i] - uModelClipBounds[i];
      radiusAdjustment -= d * d / (r * r);
    }
  }

  return sqrt(max(0.1, radiusAdjustment));
}
    `),this.sphereHelper.defineShader(e)}draw(e,t,r){const i=e.gl;i.uniformMatrix4fv(e.uniform("uNormalTransform"),!1,nv(Je(),t.renderSubspaceInvModelMatrix)),i.uniform4f(e.uniform("uLightDirection"),this.lightDirection[0],this.lightDirection[1],this.lightDirection[2],this.lightDirection[3]),this.sphereHelper.draw(e,r)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const us=iy;function ti(n,e=!1){n.addVertexCode(sy),n.addUniform("highp vec3","uLineParams"),n.addVarying("highp float","vLineCoord"),n.addVarying("highp float","vLineFeatherFraction"),e&&(n.addVarying("highp float","vEndpointFraction"),n.addVarying("highp float","vLineCoordT"),n.addVarying("highp float","vLineBorderStartFraction")),n.addVertexCode(oB),n.addVertexCode(`
vec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }
float getLineEndpointCoefficient() { return getLineOffset().x; }
uint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }
void emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
    return;
  }
  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;
  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;

  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;
  vec2 lineDirection;
  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);

  if (linePixelLength < 1e-3) {
    lineDirection = vec2(1.0, 0.0);
    vertexADevice.z = vertexBDevice.z = 0.0;
  } else {
    lineDirection = normalize(lineDirectionUnnormalized);
  }
  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);

  vec2 lineOffset = getLineOffset();
  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);
  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${e?" + 2.0 * borderWidth":""};
  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;
  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;
  gl_Position.xy += (lineOffset.y * lineNormal
                     ${e?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})
                  * totalLineWidth * uLineParams.xy;
  vLineCoord = lineOffset.y;
  ${e?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}
  ${e?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}
}
void emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),
           lineWidthInPixels
           ${e?", borderWidth":""});
}
`),e&&n.addFragmentCode(`
vec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {
  float radius;
  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {
    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,
                         vLineCoord));
    if (radius > 1.0) {
      discard;
    }
  } else {
    radius = abs(vLineCoord);
  }
  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);
  return vec4(color.rgb, color.a * feather);
}
`),n.addFragmentCode(`
float getLineAlpha() {
  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);
}
`)}function ni(n,e,t){ay(n,e,t)}function ri(n,e,t){n.gl.uniform3f(n.uniform("uLineParams"),1/e.width,1/e.height,t)}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Mi(n){n.addAttribute("int","aDummyVertexId",0),n.addVertexCode(`
int getVertexId () {
  return aDummyVertexId + gl_VertexID;
}
#define gl_VertexID (getVertexId())
`)}class ii extends K{constructor(e){super(),this.buffer=new $n(e),this.size=0}disposed(){this.buffer.dispose()}enable(e=256){const t=this.buffer,r=t.gl;t.bind(),e>this.size&&(this.size=e,r.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),r.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),r.vertexAttribDivisor(0,0),r.enableVertexAttribArray(0)}disable(){this.buffer.gl.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",()=>new ii(e))}}const zU=Je(),U2=`void main() {
  emitDefault();
}
`,Ml=[],GU=Pd(new gh,q.FLOAT32,3);let $2=class extends K{constructor(n,e){super(),this.base=n,this.targetIsSliceView=e,this.textureAccessHelper=new Jv("vertexData"),this.vertexIdHelper=this.registerDisposer(ii.get(this.gl)),this.edgeShaderGetter=ho(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(t,r)=>{if(r.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(t),this.defineAttributeAccess(t),ti(t),t.addAttribute("highp uvec2","aVertexIndex"),t.addUniform("highp float","uLineWidth");let i=`
highp vec3 vertexA = readAttribute0(aVertexIndex.x);
highp vec3 vertexB = readAttribute0(aVertexIndex.y);
emitLine(uProjection, vertexA, vertexB, uLineWidth);
highp uint lineEndpointIndex = getLineEndpointIndex();
highp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);
`;t.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGB(vec3 color) {
  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
void emitDefault() {
  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
`),t.addFragmentCode(td);const s=this.vertexAttributes,a=s.length;for(let l=1;l<a;++l){const c=s[l];t.addVarying(`highp ${c.glslDataType}`,`vCustom${l}`),i+=`vCustom${l} = readAttribute${l}(vertexIndex);
`,t.addFragmentCode(`#define ${c.name} vCustom${l}
`)}t.setVertexMain(i),ed(r,t),t.setFragmentMainFunction(Kl(r.parseResult.code))}}),this.nodeShaderGetter=ho(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(t,r)=>{if(r.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(t),this.defineAttributeAccess(t),Nd(t,this.targetIsSliceView),t.addUniform("highp float","uNodeDiameter");let i=`
highp uint vertexIndex = uint(gl_InstanceID);
highp vec3 vertexPosition = readAttribute0(vertexIndex);
emitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);
`;t.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGBA(vec4 color) {
  vec4 borderColor = color;
  emit(getCircleColor(color, borderColor), uPickID);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitDefault() {
  emitRGBA(uColor);
}
`),t.addFragmentCode(td);const s=this.vertexAttributes,a=s.length;for(let l=1;l<a;++l){const c=s[l];t.addVarying(`highp ${c.glslDataType}`,`vCustom${l}`),i+=`vCustom${l} = readAttribute${l}(vertexIndex);
`,t.addFragmentCode(`#define ${c.name} vCustom${l}
`)}t.setVertexMain(i),ed(r,t),t.setFragmentMainFunction(Kl(r.parseResult.code))}})}get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(n){Mi(n),n.addUniform("highp vec4","uColor"),n.addUniform("highp mat4","uProjection"),n.addUniform("highp uint","uPickID")}get gl(){return this.base.gl}defineAttributeAccess(n){const e=this.textureAccessHelper;e.defineShader(n);const t=this.vertexAttributes.length;for(let r=Ml.length;r<t;++r)Ml[r]=Xn(`SkeletonShader.vertexAttributeTextureUnit${r}`);this.vertexAttributes.forEach((r,i)=>{n.addTextureSampler(`${Hv(r.dataType)}sampler2D`,`uVertexAttributeSampler${i}`,Ml[i]),n.addVertexCode(e.getAccessor(`readAttribute${i}`,`uVertexAttributeSampler${i}`,r.dataType,r.numComponents))})}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(n,e,t,r){const i=t.projectionParameters.viewProjectionMat;let s=en(zU,i,r);n.uniformMatrix4fv(e.uniform("uProjection"),!1,s),this.vertexIdHelper.enable()}setColor(n,e,t){n.uniform4fv(e.uniform("uColor"),t)}setPickID(n,e,t){n.uniform1ui(e.uniform("uPickID"),t)}drawSkeleton(n,e,t,r,i){const s=this.vertexAttributes.length,a=r.vertexAttributeTextures;for(let l=0;l<s;++l){const c=WebGL2RenderingContext.TEXTURE0+e.textureUnit(Ml[l]);n.activeTexture(c),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,a[l])}{e.bind();const l=e.attribute("aVertexIndex");r.indexBuffer.bindToVertexAttribI(l,2,WebGL2RenderingContext.UNSIGNED_INT),n.vertexAttribDivisor(l,1),ri(e,i,this.targetIsSliceView?1:0),ni(n,1,r.numIndices/2),n.vertexAttribDivisor(l,0),n.disableVertexAttribArray(l)}t!==null&&(t.bind(),Vd(t,i,{featherWidthInPixels:this.targetIsSliceView?1:0}),Od(t.gl,2,r.numVertices))}endLayer(n,e){const t=this.vertexAttributes.length;for(let r=0;r<t;++r){let i=e.textureUnit(Ml[r])+WebGL2RenderingContext.TEXTURE0;n.activeTexture(i),n.bindTexture(n.TEXTURE_2D,null)}this.vertexIdHelper.disable()}};var Eo;(function(n){n[n.LINES=0]="LINES",n[n.LINES_AND_POINTS=1]="LINES_AND_POINTS"})(Eo||(Eo={}));class x1 extends fh{constructor(e,t=e){super(Eo,e,t)}}class E1 extends Jt{constructor(e,t=e){super(e,yn,t)}}class WU{constructor(){this.compound=new ph,this.shader=Ev(U2),this.shaderControlState=new Av(this.shader),this.params2d={mode:new x1(Eo.LINES_AND_POINTS),lineWidth:new E1(2)},this.params3d={mode:new x1(Eo.LINES),lineWidth:new E1(1)};const e=this.compound;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}get changed(){return this.compound.changed}reset(){this.compound.reset()}restoreState(e){e!==void 0&&this.compound.restoreState(e)}toJSON(){const e=this.compound.toJSON();for(const t of Jg(e))if(t!==void 0)return e}}class jU extends K{constructor(e,t,r){super(),this.chunkManager=e,this.source=t,this.displayState=r,this.layerChunkProgressInfo=new wv,this.redrawNeeded=new we,this.fallbackShaderParameters=new dt(Mv(ch(U2))),ty(r,this),this.displayState.shaderError.value=void 0;const i=r.skeletonRenderingOptions;this.registerDisposer(i.shader.changed.add(()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()}));let s=this.sharedObject=this.registerDisposer(new ny(e,r,this.layerChunkProgressInfo));s.RPC_TYPE_ID=FU,s.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});const a=this.vertexAttributes=[qU];for(let c of t.vertexAttributes){var l=ae(c,2);let u=l[0],h=l[1];a.push({name:u,dataType:h.dataType,numComponents:h.numComponents,webglDataType:HU(h.dataType),glslDataType:h.numComponents>1?`vec${h.numComponents}`:"float"})}}get visibility(){return this.sharedObject.visibility}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,r,i,s){let a=i.lineWidth.value;const l=this.gl,c=this.source,u=this.displayState;if(u.objectAlpha.value<=0)return;const h=hu(u.transform.value,e.projectionParameters.displayDimensionRenderInfo,s);if(h===void 0)return;let g;i.mode.value===Eo.LINES_AND_POINTS?g=Math.max(5,a*2):g=a;const v=r.edgeShaderGetter(e.emitter),y=r.nodeShaderGetter(e.emitter),C=v.shader,S=v.parameters,w=y.shader,E=y.parameters;if(C===null||w===null)return;const k=this.displayState.skeletonRenderingOptions.shaderControlState;C.bind(),r.beginLayer(l,C,e,h),mo(l,C,k,S.parseResult.controls),l.uniform1f(C.uniform("uLineWidth"),a),w.bind(),r.beginLayer(l,w,e,h),l.uniform1f(w.uniform("uNodeDiameter"),g),mo(l,w,k,E.parseResult.controls);const P=c.chunks;ry(u,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,(D,L,R)=>{const M=Jr(D),V=P.get(M);V===void 0||V.state!==pt.GPU_MEMORY||(L!==void 0&&(C.bind(),r.setColor(l,C,L),w.bind(),r.setColor(l,w,L)),R!==void 0&&(C.bind(),r.setPickID(l,C,R),w.bind(),r.setPickID(l,w,R)),r.drawSkeleton(l,C,w,V,e.projectionParameters))}),r.endLayer(l,C)}isReady(){const e=this.source,t=this.displayState;if(t.objectAlpha.value<=0)return!0;const r=e.chunks;let i=!0;return Bo(t.segmentationGroupState.value,s=>{const a=Jr(s),l=r.get(a);if(l===void 0||l.state!==pt.GPU_MEMORY){i=!1;return}}),i}}class Ff extends Uo{constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new $2(this.base,!1)),this.renderOptions=this.base.displayState.skeletonRenderingOptions.params3d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));const t=this.renderOptions;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){!e.emitColor&&e.alreadyEmittedPickID||this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}class T1 extends yo{constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new $2(this.base,!0)),this.renderOptions=this.base.displayState.skeletonRenderingOptions.params2d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);const t=this.renderOptions;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}function HU(n){switch(n){case q.FLOAT32:return WebGL2RenderingContext.FLOAT;default:throw new Error(`Data type not supported by WebGL: ${q[n]}`)}}const qU={dataType:q.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"};class JU extends ks{constructor(e,t){super(e),this.vertexAttributes=t.vertexAttributes;let r=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=r.length}copyToGPU(e){super.copyToGPU(e);const t=this.source.attributeTextureFormats,r=this.vertexAttributes,i=this.vertexAttributeOffsets,s=this.vertexAttributeTextures=[];for(let a=0,l=i.length;a<l;++a){const c=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c),qv(e,t[a],r.subarray(i[a],a+1!==l?i[a+1]:r.length)),s[a]=c}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=$n.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);const t=this.vertexAttributeTextures;for(const r of t)e.deleteTexture(r);t.length=0,this.indexBuffer.dispose()}}const YU=new de;function XU(n){const e=[GU];for(const t of n.values())e.push(Pd(new gh,t.dataType,t.numComponents));return e}class bh extends Oi{constructor(e,t){super(e,t)}get attributeTextureFormats(){let e=this.attributeTextureFormats_;return e===void 0&&(e=this.attributeTextureFormats_=XU(this.vertexAttributes)),e}getChunk(e){return new JU(this,e)}get vertexAttributes(){return YU}}function z2(n,e,t,r){const i=e.dataType;e.defineShader(n,t);let s="",a="";if(t===0)s+="highp int ignoredChannelIndex";else for(let c=0;c<t;++c)c!==0&&(s+=", "),s+=`highp int channelIndex${c}`,a+=`, channelIndex${c}`;n.addFragmentCode(ZO);let l=`
${an(i)} getDataValue(${s}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${r}), uChunkDataSize - 1.0)));
  return getDataValueAt(p${a});
}
${an(i)} getInterpolatedDataValue(${s}) {
  highp vec3 positionWithinChunk = ${r};
  highp ivec3[2] points;
  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);
  ${an(i)} xvalues[2];
  for (int ix = 0; ix < 2; ++ix) {
    ${an(i)} yvalues[2];
    for (int iy = 0; iy < 2; ++iy) {
      ${an(i)} zvalues[2];
      for (int iz = 0; iz < 2; ++iz) {
        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)
                                     ${a});
      }
      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);
    }
    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);
  }
  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);
}
`;n.addFragmentCode(l),t<=1&&n.addFragmentCode(`
${an(i)} getDataValue() { return getDataValue(0); }
${an(i)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }
`)}var G2=new Array;function W2(n){G2.push(n)}function KU(n,e){for(let t of G2){let r=t(n,e);if(r!=null)return r}throw new Error("No chunk format handler found.")}class Bd extends zL{constructor(e,t){super(e,t),this.chunkFormatHandler=this.registerDisposer(KU(e.chunkQueueManager.gl,this.spec));const r=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(r),this.tempPositionWithinChunk=new Uint32Array(r)}static encodeSpec(e){const t=e;return j(j({},super.encodeSpec(e)),{dataType:t.dataType,compressedSegmentationBlockSize:t.compressedSegmentationBlockSize&&Te(t.compressedSegmentationBlockSize),baseVoxelOffset:Te(t.baseVoxelOffset)})}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){const r=this.spec.rank,i=this.tempChunkGridPosition,s=this.tempPositionWithinChunk,a=this.spec;{const S=a.chunkDataSize;for(let w=0;w<r;++w){const E=e[w],k=S[w],P=Math.floor(E/k);i[w]=P,s[w]=Math.floor(E-k*P)}}const l=this.chunks.get(i.join());if(l===void 0)return null;const c=l.chunkDataSize;for(let S=0;S<3;++S)if(s[S]>=c[S])return;if(t.channelSpaceShape.length===0)return l.getValueAt(s);const u=t.numChannels,h=t.chunkChannelCoordinates,g=t.chunkChannelDimensionIndices,v=g.length;let y=0;const C=new Array(u);for(let S=0;S<u;++S){for(let w=0;w<v;++w)s[g[w]]=h[y++];C[S]=l.getValueAt(s)}return C}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}}class ZU extends GL{constructor(e,t){super(e,t),this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}get chunkFormat(){return this.source.chunkFormat}}let Is=class extends CF{};const Su="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='plusIconTitle'%3e%3ctitle%20id='plusIconTitle'%3ePlus%3c/title%3e%3cpath%20d='M20%2012L4%2012M12%204L12%2020'/%3e%3c/svg%3e";function j2(n={}){return ft(j({svg:Su},n))}const QU="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='arrowUpIconTitle'%3e%3ctitle%20id='arrowUpIconTitle'%3eArrow%20Up%3c/title%3e%3cpath%20d='M18%209l-6-6-6%206'/%3e%3cpath%20d='M12%2021V4'/%3e%3cpath%20stroke-linecap='round'%20d='M12%203v1'/%3e%3c/svg%3e",Cu=new dt(0);window.addEventListener("keydown",n=>{Cu.value=Xv(n)});window.addEventListener("keyup",n=>{Cu.value=Xv(n)});const e4=new ze(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),t4=new ze(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]);class Nr extends K{constructor(e,t){super(),this.target=e,this.eventMap=t,this.modifierShortcutsAreGlobal=!0,this.allShortcutsAreGlobal=!1,this.allowSpaceKeyOnButtons=!1,this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){var r=t.target;let i=r.tagName;if(r===this.target)return!1;var s=i==="TEXTAREA"||i==="INPUT"||i==="BUTTON"||i==="SELECT",a=!s&&(r.isContentEditable||r.ownerDocument&&r.ownerDocument.designMode==="on");return!s&&!a||this.allShortcutsAreGlobal||e4.has(e)?!1:a||this.modifierShortcutsAreGlobal&&(t.altKey||t.ctrlKey||t.metaKey)?!0:i==="INPUT"&&t4.has(r.type)?e!=="enter":i==="INPUT"||i==="BUTTON"?this.allowSpaceKeyOnButtons?!1:e==="space":!0}handleKeyDown(e){const t=n4(e);this.shouldIgnoreEvent(t,e)||T2(t,e,e,this.eventMap)}}function n4(n){return n.code.toLowerCase()}function Al(n,e=n.value){n.style.minWidth=e.length+1+"ch"}const k1="neuroglancer-coordinate-space-transform-singleton";function L1(n,e){let t;n===Number.NEGATIVE_INFINITY?t="(-∞,":t=`[${Math.floor(n)},`;let r;return e===Number.POSITIVE_INFINITY?r="+∞)":r=`${Math.floor(e)})`,{lower:t,upper:r}}const I1=at.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function D1(){const n=document.createElement("div"),e=document.createElement("input");n.classList.add("neuroglancer-coordinate-space-transform-scale-container"),e.spellcheck=!1,e.autocomplete="off",e.size=1,e.classList.add("neuroglancer-coordinate-space-transform-scale"),n.appendChild(e);const t=document.createElement("div"),r=document.createElement("span");r.innerHTML=QU,t.appendChild(r);const i=document.createTextNode("");return t.appendChild(i),t.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),n.appendChild(t),{cellElement:n,inputElement:e,suggestionElement:t}}function P1(n,e,t,r,i){if(e===void 0||e.scale===t&&e.unit===r)n.style.display="none";else{n.style.display="";const s=Qs(e.scale,e.unit,{elide1:!1});n.lastChild.textContent=s,n.title=`${i}${s}`}}function R1(){const n=document.createElement("input");return n.spellcheck=!1,n.autocomplete="off",n.size=1,n.placeholder=" ",n.classList.add("neuroglancer-coordinate-space-transform-output-name"),n}function M1(n,e,t){const r=n.map(v=>Jl(v.value));if(r.includes(void 0))return!1;const i=Float64Array.from(r,v=>v.scale),s=Te(r,v=>v.unit),a=t.value,l=a.scales,c=a.units,u=a.rank;for(let v=0;v<u;++v)e[v]||(i[v]=l[v],s[v]=c[v]);if(Oe(l,i)&&Oe(c,s))return!1;const h=a.timestamps.map((v,y)=>i[y]===l[y]&&s[y]===c[y]?v:Date.now()),g=st({valid:a.valid,rank:a.rank,scales:i,units:s,timestamps:h,ids:a.ids,names:a.names,boundingBoxes:a.boundingBoxes,coordinateArrays:a.coordinateArrays});return t.value=g,!0}function A1(n,e,t,r){const i=new Float64Array(n.scales),s=Te(n.units);if(i[e]===t&&s[e]===r)return n;const a=Te(n.timestamps);return i[e]=t,s[e]=r,a[e]=Date.now(),j(j({},n),{scales:i,units:s,timestamps:a})}class r4 extends K{constructor(e,t,r){super(),this.transform=e,this.localCombiner=t,this.globalCombiner=r,this.element=document.createElement("div"),this.coefficientContainer=document.createElement("div"),this.translationContainer=document.createElement("div"),this.outputNameContainer=document.createElement("div"),this.outputScaleContainer=document.createElement("div"),this.inputNameContainer=document.createElement("div"),this.inputScaleContainer=document.createElement("div"),this.inputLowerBoundsContainer=document.createElement("div"),this.inputUpperBoundsContainer=document.createElement("div"),this.coefficientElements=[],this.inputNameElements=[],this.outputNameElements=[],this.outputScaleElements=[],this.outputScaleSuggestionElements=[],this.inputScaleSuggestionElements=[],this.inputScaleElements=[],this.inputBoundsElements=[],this.outputBoundsElements=[],this.addSourceDimensionIcon=ft({svg:Su,text:"S"}),this.addOutputDimensionIcon=ft({svg:Su,text:"V"}),this.addOutputDimensionCell=document.createElement("div"),this.addOutputDimensionInput=R1(),this.inputScaleModified=[],this.outputScaleModified=[],this.curSourceRank=-1,this.curRank=-1,this.curTransform=void 0,this.addingSourceDimension=!1,this.resetToIdentityButton=ft({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{const _=this.transform,H=_.value.rank;_.transform=xs(Float64Array,H+1)}}),this.resetToDefaultButton=ft({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{const _=this.transform;if(_.mutableSourceRank)return;const H=_.defaultTransform;let U=H.outputSpace;const O=U.ids.map(()=>Ya());_.value=j(j({},H),{outputSpace:j(j({},U),{ids:O})})}});const i=this.element,s=this.registerDisposer(new Nr(i,I1));s.allShortcutsAreGlobal=!0,i.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new Bi(i,I1));const a=ct(()=>this.updateView());this.registerDisposer(e.changed.add(a));const l=this.coefficientContainer,c=this.translationContainer,u=this.outputNameContainer,h=this.inputNameContainer,g=this.inputScaleContainer,v=this.inputLowerBoundsContainer,y=this.inputUpperBoundsContainer,C=this.outputScaleContainer,S=this.addOutputDimensionCell,w=this.addOutputDimensionIcon,E=this.addSourceDimensionIcon,k=this.resetToIdentityButton,P=this.resetToDefaultButton;l.style.display="contents",c.style.display="contents",u.style.display="contents",h.style.display="contents",g.style.display="contents",C.style.display="contents",v.style.display="contents",y.style.display="contents";const D=document.createElement("div");D.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),k.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),P.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),D.appendChild(k),D.appendChild(P),i.appendChild(D);for(const _ of[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]]){var L=ae(_,2);const H=L[0],U=L[1],O=document.createElement("div");O.classList.add(`neuroglancer-coordinate-space-transform-${H}-label`),O.classList.add("neuroglancer-coordinate-space-transform-label"),O.textContent=U,i.appendChild(O)}e.mutableSourceRank&&S.appendChild(E),S.appendChild(w),S.classList.add("neuroglancer-coordinate-space-transform-output-extend");const R="Embed in additional output dimension",M="Extend to additional source dimension";w.title=R,E.title=M,S.appendChild(this.addOutputDimensionInput),S.dataset.isActive="false",w.addEventListener("click",()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=R,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),E.addEventListener("click",()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=M,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),this.addOutputDimensionInput.addEventListener("blur",()=>{this.updateAddOutputDimensionCellStyle()}),i.appendChild(l),i.appendChild(u),i.appendChild(h),i.appendChild(g),i.appendChild(C),i.appendChild(v),i.appendChild(y),l.appendChild(c),i.addEventListener("input",_=>{const H=_.target;if(H instanceof HTMLInputElement){Al(H);let U=this.inputScaleElements.indexOf(H);if(U!==-1){this.inputScaleModified[U]=!0,this.updateScaleValidity(H);return}if(U=this.outputScaleElements.indexOf(H),U!==-1){this.outputScaleModified[U]=!0,this.updateScaleValidity(H);return}if(U=this.outputNameElements.indexOf(H),U!==-1){this.updateOutputNameValidity();return}if(this.coefficientContainer.contains(H)){this.updateCoefficientValidity(H);return}}});const V=(_,H,U)=>{ve(i,_,O=>{O.stopPropagation();const z=O.target;if(!(z instanceof HTMLInputElement)||U!==0&&(z.selectionStart!==z.selectionEnd||z.selectionStart!==(U===1?z.value.length:0)))return;const F=this.getElementGridPosition(z);if(F===void 0)return;const se=this.getElementByGridPosition(F.row+H,F.col+U);se!==null&&(se.focus(),O.preventDefault())})};V("move-up",-1,0),V("move-down",1,0),V("move-left",0,-1),V("move-right",0,1);const B=(_,H)=>{_.addEventListener("focusout",U=>{const O=U.relatedTarget;O instanceof Node&&_.contains(O)||H(U)})};B(l,()=>{this.updateModelTransform()||this.updateViewTransformCoefficients()}),B(u,()=>{this.updateModelOutputNames()||this.updateViewOutputNames()}),B(g,()=>{this.updateModelInputScales()||this.updateViewInputScales()}),B(C,()=>{this.updateModelOutputScales()||this.updateViewOutputScales()}),ve(i,"cancel",_=>{this.curTransform=void 0,this.updateView(),_.target.blur()}),ve(l,"commit",()=>{this.updateModelTransform()}),ve(u,"commit",()=>{this.updateModelOutputNames()}),ve(g,"commit",()=>{this.updateModelInputScales()}),ve(C,"commit",()=>{this.updateModelOutputScales()}),i.addEventListener("focusin",_=>{const H=_.target;H instanceof HTMLInputElement&&H.select()}),this.updateView()}updateWillBeDeletedAttributes(e){const t=this.transform.value.rank;e===void 0&&(e=new Array(t),e.fill(!1));const r=this.coefficientElements,i=this.inputBoundsElements,s=this.inputScaleElements;for(let l=0;l<t;++l){const c=e[l];for(let g=0;g<=t;++g){const v=r[t*g+l],y=g<t&&e[g];v.dataset.willBeDeleted=(c||y).toString()}s[l].dataset.willBeDeleted=c.toString();var a=i[l];const u=a.lower,h=a.upper;u.dataset.willBeDeleted=c.toString(),h.dataset.willBeDeleted=c.toString()}}updateAddOutputDimensionCellStyle(){const e=this.addOutputDimensionInput;this.addOutputDimensionCell.dataset.isActive=(e.value.length!==0||document.activeElement===e).toString()}updateOutputNameValidity(){const e=this.outputNameElements,t=e.map(h=>h.value);var r=this.transform,i=r.value;const s=i.sourceRank,a=i.rank,l=r.mutableSourceRank;if(e.length!==a+1)return;const c=vv(t);let u=new Array(a);u.fill(!1);for(let h=0;h<=a;++h){let g=c[h];t[h].length===0&&(l||h>=s)&&(g=!0,u[h]=!0),e[h].dataset.isValid=g.toString()}this.updateWillBeDeletedAttributes(u),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){const t=Jl(e.value)!==void 0;e.dataset.isValid=t.toString()}updateCoefficientValidity(e){const t=gt(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{const t=this.outputNameElements.indexOf(e);if(t!==-1)return{row:t,col:-2}}{const t=this.inputScaleElements.indexOf(e);if(t!==-1)return{row:-1,col:t}}{const t=this.coefficientElements.indexOf(e),r=this.transform.value.rank;if(t!==-1)return{row:t%r,col:Math.floor(t/r)}}{const t=this.outputScaleElements.indexOf(e);if(t!==-1)return{row:t,col:-1}}}getElementByGridPosition(e,t){const r=this.transform.value.rank;return e===-1?t<0||t>=r?null:this.inputScaleElements[t]:t===-2?e<0||e>r?null:this.outputNameElements[e]:t===-1?e<0||e>=r?null:this.outputScaleElements[e]:e<0||e>=r||t<0||t>r?null:this.coefficientElements[t*r+e]}dimensionRefCount(e){return(Ul(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return M1(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return M1(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){const e=this.outputNameElements.map(P=>P.value);var t=this.transform;const r=t.value,i=t.mutableSourceRank,s=r.outputSpace,a=r.rank,l=r.sourceRank;if(e.length!==a+1)return;const c=[],u=[],h=e[a].length!==0;let g=l;for(let P=0;P<=a;++P){const D=e[P];if(D.length===0){if(P<l){if(!i)return!1;--g}continue}u.push(D),c.push(P)}if(!ih(u))return!1;const v=s.names;if(!h&&Oe(v,u))return!0;let y=r.inputSpace,C=r.outputSpace,S=r.transform;if(h){this.addingSourceDimension&&++g;const P=e[a],D=(Ul(P)?this.localCombiner:this.globalCombiner).combined.value,L=D.names.indexOf(P);let R,M;L!==-1?(R=D.units[L],M=D.scales[L]):(R="",M=1);const V=y.boundingBoxes.map(B=>Ak(B,a,a+1));this.addingSourceDimension||V.push(Mk(a+1,a)),y=st({valid:y.valid,rank:a+1,names:[...y.names,""],ids:[...y.ids,Ya()],timestamps:[...y.timestamps,Date.now()],scales:Float64Array.from([...y.scales,M]),units:[...y.units,R],boundingBoxes:V,coordinateArrays:[...y.coordinateArrays,void 0]}),C=st({valid:s.valid,rank:a+1,names:[...s.names,P],ids:[...s.ids,Ya()],timestamps:[...s.timestamps,Date.now()],scales:Float64Array.from([...s.scales,M]),units:[...s.units,R],coordinateArrays:[...s.coordinateArrays,void 0]}),S=uv(new Float64Array((a+2)**2),a+1,S,a)}S=Bk(Float64Array,S,y.rank,c,c),y=Ig(y,c),C=Ig(C,c);const w=C.ids.map((P,D)=>{const L=c[D];if(L===a)return P;const R=u[D],M=v[L];return R===M||this.dimensionRefCount(M)===1&&this.dimensionRefCount(R)===(v.includes(R)?1:0)?P:Ya()}),E=C.timestamps.map((P,D)=>{const L=c[D];return L===a||u[D]===v[L]?P:Date.now()});C=j(j({},C),{names:u,ids:w,timestamps:E});let k={rank:C.rank,sourceRank:g,outputSpace:C,inputSpace:y,transform:S};return this.transform.value=k,!0}updateModelTransform(){const e=this.coefficientElements,t=this.transform.value.rank,r=new Float64Array((t+1)**2);r[r.length-1]=1;for(let i=0;i<t;++i)for(let s=0;s<=t;++s){const a=e[s*t+i],l=parseFloat(a.value);if(!gt(l))return!1;r[s*(t+1)+i]=l}return this.transform.transform=r,!0}updateViewOutputNames(){var e=this.transform.value;const t=e.outputSpace,r=e.rank;if(r!==this.curRank)return;const i=this.outputNameElements,s=t.names;for(let a=0;a<r;++a){const l=i[a];l.value=s[a],l.dataset.isValid="true",Al(l)}i[r].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){var e=this.transform.value;const t=e.transform,r=e.rank,i=this.coefficientElements;for(let s=0;s<r;++s)for(let a=0;a<=r;++a){const l=i[a*r+s];l.value=t[a*(r+1)+s].toString(),l.dataset.isValid="true",Al(l)}}ensureViewRankUpdated(){const e=this.transform.value,t=e.rank,r=e.sourceRank;if(this.curSourceRank===r&&this.curRank===t)return;const i=this.inputBoundsElements,s=this.inputNameElements,a=this.inputScaleElements,l=this.element,c=this.coefficientElements,u=this.outputNameElements,h=this.outputScaleElements,g=this.outputScaleSuggestionElements,v=this.inputScaleSuggestionElements,y=this.outputBoundsElements,C=this.coefficientContainer,S=this.translationContainer,w=this.outputNameContainer,E=this.inputNameContainer,k=this.inputScaleContainer,P=this.inputLowerBoundsContainer,D=this.inputUpperBoundsContainer,L=this.outputScaleContainer;l.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,l.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,Xe(C),Xe(S),C.appendChild(S),Xe(w),Xe(E),Xe(k),Xe(P),Xe(D),Xe(L),s.length=0,a.length=0,i.length=0,h.length=0,g.length=0,v.length=0,c.length=0,u.length=0,y.length=0;for(let V=0;V<t;++V){const B=_=>{_.classList.add("neuroglancer-coordinate-space-transform-input"),V>=r&&_.classList.add(k1)};{const _=document.createElement("div");_.classList.add("neuroglancer-coordinate-space-transform-input-name"),B(_),_.style.gridRowStart="sourceNames",_.style.gridColumnStart=`sourceDim ${V+1}`,E.appendChild(_),s.push(_)}{var R=D1();const _=R.cellElement,H=R.inputElement,U=R.suggestionElement;_.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),B(_),_.style.gridRowStart="sourceScales",_.style.gridColumnStart=`sourceDim ${V+1}`,k.appendChild(_),a.push(H),v.push(U);const O=V;U.addEventListener("click",()=>{const z=dC(this.transform,O);z!==void 0&&(this.transform.inputSpace.value=A1(this.transform.inputSpace.value,O,z.scale,z.unit))})}{const _=document.createElement("div");B(_),_.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),_.style.gridRowStart="sourceLower",_.style.gridColumnStart=`sourceDim ${V+1}`,P.appendChild(_);const H=document.createElement("div");B(H),H.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),H.style.gridRowStart="sourceUpper",H.style.gridColumnStart=`sourceDim ${V+1}`,D.appendChild(H),i.push({lower:_,upper:H})}}for(let V=0;V<t;++V){for(let B=0;B<=t;++B){const _=document.createElement("input");_.classList.add("neuroglancer-coordinate-space-transform-coeff"),_.spellcheck=!1,_.autocomplete="off",_.size=1,_.style.gridRowStart=`outputDim ${V+1}`,_.placeholder=" ",_.style.gridColumnStart=`sourceDim ${B+1}`,c[B*t+V]=_,B===t?_.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):B==r&&_.classList.add(k1),(B===t?S:C).appendChild(_)}{var M=D1();const B=M.cellElement,_=M.suggestionElement,H=M.inputElement;B.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),B.style.gridRowStart=`outputDim ${V+1}`,B.style.gridColumnStart="outputScales";const U=V;_.addEventListener("click",()=>{const O=this.transform.value,z=lC(O,U);z!==void 0&&(this.transform.outputSpace.value=A1(O.outputSpace,U,z.scale,z.unit))}),g.push(_),L.appendChild(B),h.push(H)}{const B=document.createElement("div");B.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),B.style.gridRowStart=`outputDim ${V+1}`,B.style.gridColumnStart="outputNames";const _=R1();_.title="Rebind to a different dimension",V>=r?_.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(_.title+=", or delete to remove source dimension"),_.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",u.push(_),w.appendChild(B),B.appendChild(_);const H=document.createElement("div");H.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),B.appendChild(H);const U=document.createElement("div");U.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),B.appendChild(U),y.push({lower:H,upper:U}),B.addEventListener("mousedown",O=>{O.target!==_&&(_.focus(),O.preventDefault())})}}u.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",w.appendChild(this.addOutputDimensionCell),this.curSourceRank=r,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;var e=this.transform.value;const t=e.inputSpace,r=e.rank,i=e.sourceRank,s=this.inputBoundsElements,a=this.inputNameElements,l=this.inputScaleElements,c=this.inputScaleSuggestionElements,u=t.names,h=t.scales,g=t.units;var v=t.bounds;const y=v.lowerBounds,C=v.upperBounds;for(let w=0;w<r;++w){const E=l[w],k=h[w],P=g[w];E.value=Qs(k,P,{elide1:!1}),E.dataset.isValid="true",Al(E);let D;if(w<i){let V=u[w];V||(V=`${w}`),a[w].textContent=V,D=`source dimension ${V}`,E.title=`Override scale of ${D}`}else D="singleton dimension",E.title=`Set extent of ${D}`;var S=L1(y[w],C[w]);const L=S.lower,R=S.upper,M=s[w];M.lower.textContent=L,M.lower.title=`Lower bound of ${D}`,M.upper.title=`Upper bound of ${D}`,M.upper.textContent=R,P1(c[w],dC(this.transform,w),k,P,`Revert scale of ${D} to `)}}updateViewOutputScales(){const e=this.transform.value;var t=e.outputSpace;const r=t.rank,i=t.names,s=t.units,a=t.scales;var l=t.bounds;const c=l.lowerBounds,u=l.upperBounds,h=this.outputScaleElements,g=this.outputBoundsElements,v=this.outputScaleSuggestionElements;for(let C=0;C<r;++C){const S=h[C],w=a[C],E=s[C];S.value=Qs(w,E,{elide1:!1}),Al(S);const k=i[C];S.dataset.isValid="true";const P=`Change coordinates of ${Ul(k)?"local":"global"} dimension ${k}`;S.title=`${P} (does not rescale the source)`;var y=L1(c[C],u[C]);const D=y.lower,L=y.upper,R=g[C];R.lower.textContent=D,R.upper.textContent=L,P1(v[C],lC(e,C),w,E,`${P} to inferred scale of `)}}updateResetButtonVisibility(e=!1,t=!1){var r=this.transform;const i=r.value,s=r.mutableSourceRank,a=r.defaultTransform,l=i.rank;this.resetToIdentityButton.style.visibility=e||!o3(i.transform,l+1,l+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=!s&&(e||t||!I3(a,i))?"visible":"hidden"}updateView(){const e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){Et(this.element),super.disposed()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function i4(n,e,{horizontal:t=!1,vertical:r=!0,topMargin:i=6,bottomMargin:s=6,leftMargin:a=6,rightMargin:l=6,maxHeight:c=!0,maxWidth:u=!0}={}){const h=e.getBoundingClientRect();if(t){const g=n.ownerDocument.documentElement.clientWidth;let v=h.right,y=g-h.left;v>y?(n.style.left="",n.style.right=`${g-h.right}px`,u&&(n.style.maxWidth=v-a+"px")):(n.style.right="",n.style.left=`${h.left}px`,u&&(n.style.maxWidth=y-l+"px"))}if(r){const g=n.ownerDocument.documentElement.clientHeight;let v=h.top-i,y=g-h.bottom-s;n.style.left=`${h.left}px`,n.style.width=`${h.width}px`,v>y*3?(n.style.top="",n.style.bottom=`${g-h.top}px`,c&&(n.style.maxHeight=v+"px")):(n.style.top=`${h.bottom}px`,n.style.bottom="",c&&(n.style.maxHeight=y+"px"))}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function s4(n){let e=ev(n);var t=e.next();let r=t.value;if(t.done)return"";let i=r.length;for(;i>0;){var s=e.next();let a=s.value;if(s.done)break;let l=0;for(;l<i&&r.charCodeAt(l)===a.charCodeAt(l);++l);i=l}return r.substring(0,i)}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const N1=10,Nc=.5;class a4{constructor(){this.anchorIndex=0,this.anchorClientOffset=0}splice(e){let t=this.anchorIndex,r=0;for(const i of e){if(r+=i.retainCount,t<r)break;const s=i.deleteCount;if(t<r+s){t=r;break}const a=i.insertCount;t=t-s+a,r+=a-a}this.anchorIndex=t}}class V1{constructor(){this.startIndex=0,this.endIndex=0,this.anchorIndex=0,this.anchorOffset=0,this.scrollOffset=0}}class o4{constructor(){this.itemSize=[],this.totalKnownSize=0,this.numItemsInTotalKnownSize=0}get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){var t;return(t=this.itemSize[e])!==null&&t!==void 0?t:this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e,t=0,r=0){for(;t<e;++t)r+=this.getEstimatedSize(t);for(;t>e;--t)r-=this.getEstimatedSize(t-1);return r}getRangeSize(e,t){var r;let i=0;const s=this.itemSize,a=this.averageSize;for(let l=e;l<t;++l)i+=(r=s[l])!==null&&r!==void 0?r:a;return i}splice(e){let t=this.itemSize;t=this.itemSize=fN(t,e),this.totalKnownSize=t.reduce((r,i)=>r+i,0),this.numItemsInTotalKnownSize=t.reduce(r=>r+1,0)}}function l4(n,e,t,r,i,s){let a=s.anchorIndex,l=s.anchorClientOffset,c=i.getEstimatedOffset(a),u,h,g,v,y;if(r===0||i.totalKnownSize===0)u=Math.max(0,a-N1/2),h=Math.min(t,u+N1),y=a,g=0,v=l;else{const C=i.getEstimatedTotalSize(),S=Math.max(0,C-r);v=c-l,v=Math.max(0,Math.min(S,v));const w=v-2*Nc*r,E=v-Nc*r,k=v+r+Nc*r,P=c-l+r+2*Nc*r;u=Math.min(t,e.startIndex);let D=i.getEstimatedOffset(u,a,c);if(D<w)for(;u+1<t;++u){const R=i.getEstimatedSize(u);if(D+R>=E)break;D+=R}if(D>=E)for(;D>w&&u>0;--u){const R=i.getEstimatedSize(u-1);D-=R}h=Math.min(t,e.endIndex);let L=i.getEstimatedOffset(h,a,c);if(L<k)for(;L<=P&&h+1<=t;++h){const R=i.getEstimatedSize(h);L+=R}else if(L>=P)for(;h>u;--h){const R=i.getEstimatedSize(h-1);if(L-R<k)break;L-=R}for(y=a,g=c;y<u;++y){const R=i.getEstimatedSize(y);g+=R}for(;y>h;--y){const R=i.getEstimatedSize(y-1);g-=R}}n.startIndex=u,n.endIndex=h,n.anchorIndex=y,n.anchorOffset=g,n.scrollOffset=v}function d4(n,e){const t=e.getEstimatedOffset(n.anchorIndex),r=n.anchorOffset;n.anchorOffset=t,n.scrollOffset+=t-r}function c4(n,e){return n.startIndex<e.startIndex||n.endIndex>e.endIndex}class ly extends K{constructor(e){super(),this.element=document.createElement("div"),this.scrollContent=document.createElement("div"),this.header=document.createElement("div"),this.body=document.createElement("div"),this.topItems=document.createElement("div"),this.bottomItems=document.createElement("div"),this.renderedItems=[],this.renderGeneration=-1,this.listGeneration=-1,this.newRenderedItems=[],this.state=new a4,this.renderParams=new V1,this.newRenderParams=new V1,this.sizes=new o4,this.debouncedUpdateView=this.registerCancellable(ct(()=>this.updateView())),this.resizeObserver=new ResizeObserver(()=>this.updateView());const t=e.selectedIndex;t!==void 0&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);const r=this.source=e.source;this.sizes.itemSize.length=r.length;const i=this.element,s=this.header,a=this.body,l=this.scrollContent,c=this.topItems,u=this.bottomItems;this.resizeObserver.observe(i),this.registerDisposer(()=>this.resizeObserver.disconnect()),i.appendChild(l),i.style.overflowAnchor="none",l.appendChild(s),l.appendChild(a),s.style.position="sticky",s.style.zIndex="1",s.style.top="0",e.horizontalScroll?(l.style.width="min-content",l.style.minWidth="100%",s.style.width="min-content",s.style.minWidth="100%",u.style.width="min-content",u.style.minWidth="100%"):(l.style.width="100%",s.style.width="100%",u.style.width="100%"),a.appendChild(c),a.appendChild(u),c.style.width="min-content",c.style.position="relative",c.style.height="0",c.style.minWidth="100%",u.style.height="0",u.style.position="relative",i.addEventListener("scroll",()=>{const h=i.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-h,this.renderParams.scrollOffset=h,this.debouncedUpdateView()}),r.changed!==void 0&&this.registerDisposer(r.changed.add(h=>{this.sizes.splice(h),this.state.splice(h),this.renderedItems.length=0,this.debouncedUpdateView()})),r.renderChanged!==void 0&&this.registerDisposer(r.renderChanged.add(this.debouncedUpdateView))}updateView(){const e=this.element;if(e.offsetHeight===0)return;const t=e.clientHeight-this.header.offsetHeight,r=this.source,i=this.state,s=this.sizes,a=r.length,l=this.body,c=this.topItems,u=this.bottomItems,h=r.changed,g=r.renderChanged;let v;for(;;){v=this.newRenderParams;const w=this.renderParams;l4(v,w,a,t,s,i);let E;if(g!==void 0&&g.count!==this.renderGeneration||h!==void 0&&h.count!==this.listGeneration?(this.renderGeneration=g===void 0?-1:g.count,this.listGeneration=h===void 0?-1:h.count,E=!0,this.renderedItems.length=0):E=!1,!E&&!c4(v,w)){w.scrollOffset=v.scrollOffset,v=w;break}this.renderParams=v,this.newRenderParams=w;const k=this.renderedItems,P=this.newRenderedItems;P.length=0,this.renderedItems=P,this.newRenderedItems=k;const D=this.source,L=D.render;var y=v;const R=y.startIndex,M=y.endIndex,V=y.anchorIndex;function*B(_,H){for(let U=_;U<H;++U){let O=k[U];O===void 0&&(O=L.call(D,U)),P[U]=O,yield O}}Yr(c,B(R,V)),Yr(u,B(V,M));for(let _=R;_<M;++_){const H=P[_].getBoundingClientRect().height,U=s.itemSize[_];U!==void 0&&(s.totalKnownSize-=U,--s.numItemsInTotalKnownSize),s.itemSize[_]=H,s.totalKnownSize+=H,++s.numItemsInTotalKnownSize}}d4(v,s),i.anchorIndex=v.anchorIndex,i.anchorClientOffset=v.anchorOffset-v.scrollOffset;const C=s.getRangeSize(v.startIndex,v.anchorIndex),S=s.getEstimatedTotalSize();l.style.height=`${S}px`,c.style.top=`${v.anchorOffset-C}px`,u.style.top=`${v.anchorOffset}px`,e.scrollTop=v.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){var t=this.renderParams;const r=t.startIndex,i=t.endIndex,s=this.renderedItems;for(let a=r;a<i;++a){const l=s[a];l!==void 0&&e(l,a)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){const t=this.sizes.getEstimatedOffset(e),r=t+this.sizes.getEstimatedSize(e),i=this.element.scrollTop;if(t<i)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else if(t>i&&r>i+this.element.offsetHeight)this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight;else return;this.debouncedUpdateView()}disposed(){Et(this.element)}}const _f="neuroglancer-multiline-autocomplete-completion-active";function u4(n){let e=document.createElement("div");return e.textContent=n.value,e}function*O1(n){for(;n.length>0;){const e=n.match(/[:/_]+/);if(e===null){yield n;return}const t=e.index+e[0].length;yield n.substring(0,t),n=n.substring(t)}}function h4(n){let e=document.createElement("div");e.className="neuroglancer-multiline-autocomplete-completion-with-description",e.textContent=n.value;let t=document.createElement("div");return t.className="neuroglancer-multiline-autocomplete-completion-description",t.textContent=n.description||"",e.appendChild(t),e}const p4=at.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}}),f4=200;class g4 extends K{constructor(e){super(),this.element=document.createElement("div"),this.inputElement=document.createElement("span"),this.hintElement=document.createElement("span"),this.completionsVirtualList=void 0,this.onCommit=new Ze,this.onInput=new Ze,this.prevInputValue="",this.completionsVisible=!1,this.activeCompletionPromise=null,this.activeCompletionCancellationToken=void 0,this.hasFocus=!1,this.completionResult=null,this.dropdownContentsStale=!0,this.hasResultForDropdown=!1,this.commonPrefix="",this.completionDisabled=-1,this.activeIndex=-1,this.dropdownStyleStale=!0,this.resizeHandler=()=>{this.completionsVisible&&this.updateDropdownStyle()},this.resizeObserver=new ResizeObserver(this.resizeHandler),this.debouncedUpdateHintState=this.registerCancellable(rt(()=>this.updateHintState(),0)),this.completer=e.completer;var t=e.delay;const r=t===void 0?f4:t;let i=this.scheduleUpdateCompletions=rt(()=>{const u=this.activeCompletionCancellationToken=new Es;let h=this.activeCompletionPromise=this.completer(this.value,u);h!==null&&h.then(g=>{this.activeCompletionPromise===h&&(this.setCompletions(g),this.activeCompletionPromise=null)})},r);this.registerDisposer(()=>{i.cancel()});const s=this.element,a=this.inputElement,l=this.hintElement;s.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(s),this.registerDisposer(()=>this.resizeObserver.unobserve(a)),a.contentEditable="true",a.spellcheck=!1,s.appendChild(document.createTextNode("​")),s.appendChild(a),s.appendChild(l),a.classList.add("neuroglancer-multiline-autocomplete-input"),l.classList.add("neuroglancer-multiline-autocomplete-hint"),a.addEventListener("input",()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()}),a.addEventListener("copy",u=>{const h=u.clipboardData;if(h!==null){const g=window.getSelection();g!==null&&!g.isCollapsed&&g.containsNode(a,!0)&&h.setData("text/plain",g.toString())}u.preventDefault(),u.stopPropagation()}),this.registerEventListener(document,"selectionchange",()=>{const u=this.getSelectionRange(),h=this.completionDisabled;u!==void 0&&u.begin===h&&u.end===h||(this.completionDisabled=-1,this.debouncedUpdateHintState())}),this.setValueAndSelection(""),this.updateHintState(),s.addEventListener("pointerdown",u=>{const h=u.target;if(h instanceof Node){if(a.contains(h))return;const g=this.completionsVirtualList;if(g!==void 0&&g.element.contains(h))return}a===document.activeElement&&(this.moveCaretToEndOfInput(),u.stopPropagation(),u.preventDefault())}),s.addEventListener("click",()=>{a.focus()}),this.registerEventListener(this.inputElement,"focus",()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();const u=document.createRange(),h=a.childNodes;u.setStart(a,0),h.length===0?u.setEnd(a,0):u.setEndAfter(h[h.length-1]);const g=window.getSelection();g!==null&&(g.removeAllRanges(),g.addRange(u)),this.debouncedUpdateHintState()}}),this.registerEventListener(this.inputElement,"blur",()=>{this.hasFocus&&(this.hasFocus=!1,this.updateDropdown()),this.debouncedUpdateHintState();const u=window.getSelection();u!==null&&u.containsNode(this.inputElement,!0)&&u.removeAllRanges(),this.onCommit.dispatch(this.value,!1)}),this.registerEventListener(window,"resize",()=>{this.dropdownStyleStale=!0}),this.registerEventListener(window,"scroll",()=>{this.dropdownStyleStale=!0});const c=this.registerDisposer(new Nr(a,p4));c.allShortcutsAreGlobal=!0,ve(a,"cycle-next-active-completion",()=>{this.cycleActiveCompletion(1)}),ve(a,"cycle-prev-active-completion",()=>{this.cycleActiveCompletion(-1)}),ve(a,"home",()=>{this.moveCaretToBeginningOfInput()}),ve(a,"end",()=>{this.moveCaretToEndOfInput()}),ve(a,"choose-active-completion-or-prefix",u=>{this.selectActiveCompletion(!0)&&u.preventDefault()}),ve(a,"commit",u=>{if(this.selectActiveCompletion(!1))u.stopPropagation();else{let h=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,h)}}),ve(a,"cancel",u=>{u.stopPropagation(),this.cancel()&&(u.detail.preventDefault(),u.detail.stopPropagation())})}disableCompletion(){const e=this.getSelectionRange();this.completionDisabled=e!==void 0&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){const e=window.getSelection();if(e===null||e.rangeCount===0)return;const t=e.getRangeAt(0),r=this.inputElement,i=document.createRange();i.setStart(r,0),i.setEnd(t.startContainer,t.startOffset);const s=i.toString().length,a=e.toString().length;return{begin:s,end:s+a}}setValueAndSelection(e,t=void 0){const r=this.completionDisabled!==-1;this.onInput.dispatch(e);const i=this.inputElement;Xe(i);let s=0;const a=t!==void 0?document.createRange():void 0;let l=!0;for(const c of O1(e)){l||i.appendChild(document.createElement("wbr")),l=!1;const u=s+c.length,h=document.createTextNode(c);if(i.appendChild(h),a!==void 0){const g=t.begin,v=t.end;g>=s&&g<=u&&a.setStart(h,g-s),v>=s&&v<=u&&a.setEnd(h,v-s)}s=u}if(a!==void 0){l&&(a.setStart(i,0),a.setEnd(i,0));const c=window.getSelection();c!==null&&(c.removeAllRanges(),c.addRange(a))}this.completionDisabled=r&&t!==void 0&&t.end===t.begin?t.end:-1}shouldAttemptCompletion(){const e=this.inputElement;if(document.activeElement!==e)return!1;const t=this.getSelectionRange();return t!==void 0&&t.end===t.begin&&t.end!=this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}updateHintState(){if(this.debouncedUpdateHintState.cancel(),this.shouldAttemptCompletion()){const e=this.value;if(e===this.prevInputValue)return;this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions()}else{this.hideCompletions();return}}handleDropdownClick(e){let t=this.completionsVirtualList;if(t===void 0)return;const r=t.element;for(let i=e.target;i instanceof HTMLElement&&i!==r;i=i.parentElement){const s=i.dataset.completionIndex;if(s!==void 0){this.selectCompletion(Number(s));break}}}cycleActiveCompletion(e){if(this.completionResult===null)return;let t=this.activeIndex,r=this.completionResult.completions.length;t===-1?e>0?t=0:t=r-1:t=(t+e+r)%r,this.setActiveIndex(t)}shouldShowDropdown(){return this.completionResult===null||!this.hasFocus?!1:this.hasResultForDropdown}updateDropdownStyle(){const e=this.completionsVirtualList,t=this.element;e!==void 0&&i4(e.element,t,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let e=this.completionsVirtualList;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){e!==void 0&&e.dispose();const i=this.completionResult;var t=i.makeElement;const s=t===void 0?u4:t;e=this.completionsVirtualList=new ly({source:{length:i.completions.length,render:a=>{const l=i.completions[a],c=s.call(i,l);return c.classList.add("neuroglancer-multiline-autocomplete-completion"),c.dataset.completionIndex=`${a}`,this.activeIndex===a&&c.classList.add(_f),c}},selectedIndex:this.activeIndex===-1?void 0:this.activeIndex}),e.element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",a=>{this.inputElement.focus(),a.preventDefault()}),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),this.completionsVisible||(this.completionsVisible=!0);const r=this.activeIndex;r!==-1&&this.completionsVirtualList.scrollItemIntoView(r)}else this.completionsVisible&&(e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();let t=e.completions;if(t.length===0)return;const r=this.prevInputValue;if(r!==void 0){if(this.completionResult=e,t.length===1){let i=t[0];e.showSingleResult?this.hasResultForDropdown=!0:i.value.startsWith(r)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;let i=s4((function*(){for(let a of e.completions)yield a.value})()),s=this.getCompletedValue(i);s.startsWith(r)&&(this.commonPrefix=s,this.setHintValue(s))}this.updateDropdown()}}setHintValue(e){const t=this.prevInputValue;if(t===void 0)return;(e===t||!e.startsWith(t))&&(e=""),e=e.substring(t.length);const r=this.hintElement;Xe(r);let i=!0;for(const s of O1(e)){i||r.appendChild(document.createElement("wbr")),i=!1;const a=document.createTextNode(s);r.appendChild(a)}}setActiveIndex(e){if(!this.dropdownContentsStale){let t=this.activeIndex;const r=this.completionsVirtualList;if(r!==void 0){if(t!==-1){const i=r.getItemElement(t);i!==void 0&&i.classList.remove(_f)}if(e!==-1){let i=r.getItemElement(e);i!==void 0&&i.classList.add(_f),r.scrollItemIntoView(e)}}}e!==-1&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){let t=this.completionResult,r=this.prevInputValue;return r===void 0?"":r.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){const e=document.createRange(),t=this.inputElement;e.setStart(t,0),e.setEnd(t,0);const r=window.getSelection();r!==null&&(r.removeAllRanges(),r.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){const e=document.createRange(),t=this.inputElement,r=t.childNodes,i=r[r.length-1];i===void 0?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(i),e.setEndAfter(i));const s=window.getSelection();s!==null&&(s.removeAllRanges(),s.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let t=this.activeIndex;if(t===-1){if(!e)return!1;let i=this.completionResult;if(i!==null&&i.completions.length===1)t=0;else{let s=this.commonPrefix;return s.length>this.value.length?(this.value=s,this.moveCaretToEndOfInput(),!0):!1}}let r=this.getCompletedValueByIndex(t);return this.value===r?!1:(this.value=r,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0;const e=this.activeCompletionCancellationToken;e!==void 0&&e.cancel(),this.activeCompletionCancellationToken=void 0,this.activeCompletionPromise=null}clearCompletions(){if(this.completionResult!==null){this.activeIndex=-1,this.completionResult=null,this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,this.commonPrefix="";const e=this.completionsVirtualList;e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){const e=this.completionsVirtualList;e!==void 0&&e.dispose(),Et(this.element),this.cancelActiveCompletion(),super.disposed()}}class Fi extends K{constructor(e=new Nt(Nt.VISIBLE)){super(),this.visibility=e,this.element=document.createElement("div"),this.element.classList.add("neuroglancer-tab-content")}get visible(){return this.visibility.visible}disposed(){Et(this.element),super.disposed()}}class m4 extends K{constructor(){super(...arguments),this.changed=new we,this.options=new de,this.optionsChanged=new we,this.selectedValue=void 0,this.defaultValue=void 0,this.ready_=!0}get value(){const e=this.selectedValue;return e!==void 0?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){e!==void 0&&this.ready_&&!this.options.has(e)&&(e=void 0),this.selectedValue!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){const e=this.selectedValue;return e===void 0||!this.options.has(e)?this.defaultValue:e}add(e,t){const r=this.options;if(r.has(e))throw new Error(`Option already defined: ${ie(e)}.`);r.set(e,t),this.optionsChanged.dispatch(),this.defaultValue===void 0&&(this.default=e)}toJSON(){const e=this.value,t=this.defaultValue;if(e!==t)return e}reset(){this.value=void 0}get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){typeof e!="string"&&(e=void 0),this.value=e}}class v4 extends K{constructor(e,t,r=new Nt(Nt.VISIBLE),i=!1){super(),this.getter=e,this.selected=t,this.visibility=r,this.invalidateByDefault=i,this.element=document.createElement("div"),this.tabs=new de,this.tabVisibilityChanged=new Ze,this.debouncedUpdateSelectedTab=this.registerCancellable(ct(()=>this.updateSelectedTab()));const s=this.element;s.className="neuroglancer-stack-view",this.registerDisposer(r.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}get visible(){return this.visibility.visible}flush(){this.debouncedUpdateSelectedTab.flush()}invalidate(e){const t=this.tabs,r=t.get(e);r!==void 0&&(r.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab()))}hideTab(e){const t=this.tabs.get(e);t!==void 0&&(t.visibility.value=Nt.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){const t=this.tabs;let r=t.get(e);r===void 0&&(r=this.getter(e),this.element.appendChild(r.element),t.set(e,r)),r.element.style.display="",r.visibility.value=Nt.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){const e=this.displayedTab,t=this.visible?this.selected.value:void 0;t===e&&(t===void 0||this.tabs.has(t))||(e!==void 0&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,t!==void 0&&this.showTab(t))}invalidateAll(e=void 0){const t=this.tabs;for(const i of t){var r=ae(i,2);const s=r[0],a=r[1];e!==void 0&&e(s)||(t.delete(s),a.dispose())}this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),Et(this.element),super.disposed()}}class y4 extends m4{}function b4(n,e){const t="neuroglancer-selected-tab-label";e?n.classList.add(t):n.classList.remove(t)}class w4 extends K{constructor(e,t=new Nt(Nt.VISIBLE)){super(),this.visibility=t,this.element=document.createElement("div"),this.tabBar=document.createElement("div"),this.tabLabels=new de,this.tabsGeneration=-1,this.debouncedUpdateView=this.registerCancellable(ct(()=>this.updateTabs())),this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;const r=this.element,i=this.tabBar;r.className="neuroglancer-tab-view",i.className="neuroglancer-tab-view-bar",r.appendChild(i),this.registerDisposer(t.changed.add(this.debouncedUpdateView));const s=this.stack=this.registerDisposer(new v4(e.makeTab,e.selectedTab,this.visibility));r.appendChild(s.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView)),this.registerDisposer(e.selectedTab.changed.add(()=>this.updateTabLabelStyles())),this.updateTabs()}get visible(){return this.visibility.visible}updateTabLabelStyles(){const e=this.selectedTab.value;for(const r of this.tabLabels){var t=ae(r,2);const i=t[0],s=t[1];b4(s,i===e)}}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(this.tabsGeneration!==-1){if(this.tabLabels.clear(),!this.visible)this.stack.invalidateAll();else{const e=this.tabs.value;this.stack.invalidateAll(t=>e.find(({id:r})=>r===t)!==void 0)}Xe(this.tabBar),this.tabsGeneration=-1}}makeTabs(){const e=this.tabBar,t=this.tabLabels,r=this.handleTabElement;for(const i of this.tabs.value){const s=i.id,a=i.label,l=document.createElement("div");l.classList.add("neuroglancer-tab-label"),l.textContent=a,l.addEventListener("click",()=>{this.selectedTab.value=s}),r!==void 0&&r(s,l),t.set(s,l),e.appendChild(l)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){Xe(this.tabBar),this.tabLabels.clear(),Et(this.element),super.disposed()}}class S4 extends g4{constructor(e){const t=e.source.layer.manager,r=(s,a)=>t.dataSourceProviderRegistry.completeUrl({url:s,chunkManager:t.chunkManager,cancellationToken:a}).then(l=>({completions:l.completions,makeElement:h4,offset:l.offset,showSingleResult:!0}));super({completer:r,delay:0}),this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new dt(!1);const i=s=>{s!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};i(""),this.onInput.add(i)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}}class H2 extends K{constructor(e){super(),this.model=e,this.element=document.createElement("ul"),this.generation=-1,this.element.classList.add("neuroglancer-layer-data-sources-source-messages");const t=this.registerCancellable(ct(()=>this.updateView()));this.registerDisposer(e.changed.add(t)),this.registerDisposer(()=>Et(this.element)),this.updateView()}updateView(){const e=this.model,t=e.changed.count;if(t===this.generation)return;this.generation=t;const r=this.element;Xe(r);const i=new ze;for(const s of e){const a=`${s.severity} ${s.message}`;if(i.has(a))continue;i.add(a);const l=document.createElement("li");r.appendChild(l),l.classList.add("neuroglancer-message"),l.classList.add(`neuroglancer-message-${Kr[s.severity]}`),l.textContent=s.message}}}class C4 extends K{constructor(e,t){super(),this.loadedSubsource=t,this.element=document.createElement("div");const r=this.element;r.classList.add("neuroglancer-layer-data-source-subsource");const i=document.createElement("label"),s=document.createElement("span"),a=()=>{i.dataset.isActive=(t.activated!==void 0||!t.enabled).toString()};a(),this.registerDisposer(t.isActiveChanged.add(a)),this.registerDisposer(e.enabledSubsourcesChanged.add(a));const l=this.registerDisposer(new Ts({get value(){return t.enabled},set value(C){t.enabled=C,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));i.classList.add("neuroglancer-layer-data-sources-info-line"),i.appendChild(l.element);const c=document.createElement("span");c.classList.add("neuroglancer-layer-data-sources-source-id");const u=t.subsourceEntry.id;u!=="default"&&(c.textContent=u),i.appendChild(c),s.classList.add("neuroglancer-layer-data-sources-source-type");const h=this.registerDisposer(new H2(this.loadedSubsource.messages));r.appendChild(i),i.appendChild(s),r.appendChild(h.element);let g="";const v=t.subsourceEntry.subsource,y=v.volume;if(y instanceof Is)g=`${q[y.dataType].toLowerCase()} volume`;else if(v.mesh instanceof Ad)g="meshes (single-res.)";else if(v.mesh instanceof yh)g="meshes (multi-res.)";else if(v.mesh instanceof bh)g="skeletons";else if(v.segmentPropertyMap!==void 0)g="segment property map";else if(v.local!==void 0)switch(v.local){case Ri.annotations:g="Local annotations";break;case Ri.equivalences:g="local segmentation graph";break}else v.staticAnnotations!==void 0?g="default annotations":v.annotation!==void 0?g="annotations":v.singleMesh!==void 0?g="single mesh":v.segmentationGraph!==void 0&&(g="segmentation graph");s.textContent=g}}class x4 extends K{constructor(e){super(),this.source=e,this.element=document.createElement("div");const t=this.element,r=document.createElement("label");r.classList.add("neuroglancer-layer-data-sources-source-default"),r.appendChild(this.registerDisposer(new Ts({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(s){if(e.enableDefaultSubsources!==s){if(e.enableDefaultSubsources=s,s)for(const a of e.subsources)a.enabled=a.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}}})).element),r.appendChild(document.createTextNode("Enable default subsource set")),r.title="Enable the default set of subsources for this data source.",t.appendChild(r);for(const s of e.subsources)t.appendChild(this.registerDisposer(new C4(e,s)).element);const i=e.transform;if(i.mutableSourceRank||i.value.sourceRank!==0){const s=this.registerDisposer(new r4(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(s.element)}this.registerDisposer(()=>Et(this.element))}}class E4 extends K{constructor(e,t){super(),this.tab=e,this.source=t,this.element=document.createElement("div"),this.seenGeneration=0,this.generation=-1;const r=this.urlInput=this.registerDisposer(new S4(this)),i=(a,l)=>{const c=this.source,u=c.spec,h=this.source.layer;if(a=h.manager.dataSourceProviderRegistry.normalizeUrl({url:a}),a!==r.value&&(r.disableCompletion(),r.setValueAndSelection(a,{begin:a.length,end:a.length})),r.dirty.value=!1,a&&a===u.url){l&&e.detectedLayerConstructor!==void 0&&q2(c.layer);return}if(h instanceof Ai)try{const g=h.manager.dataSourceProviderRegistry.suggestLayerName(a);WI(h.managedLayer,g)}catch{}c.spec=j(j({},u),{url:a})};r.onCommit.add(i);const s=this.element;s.classList.add("neuroglancer-layer-data-source"),s.appendChild(r.element),s.appendChild(this.registerDisposer(new H2(t.messages)).element),this.updateView()}updateView(){const e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;const t=this.source.loadState;let r=this.loadedView;if(r!==void 0){if(r.source===t)return;r.dispose(),r=this.loadedView=void 0}t instanceof Gv&&(r=this.loadedView=new x4(t),this.element.appendChild(r.element))}disposed(){const e=this.loadedView;e!==void 0&&e.dispose(),Et(this.element),super.disposed()}}function q2(n){if(n instanceof Ai){const e=n.detectedLayerConstructor;if(e!==void 0)return wy(n.managedLayer,e),!0}return!1}class T4 extends Fi{constructor(e){super(),this.layer=e,this.generation=-1,this.sourceViews=new de,this.addDataSourceIcon=j2({title:"Add additional data source"}),this.layerTypeDetection=document.createElement("div"),this.layerTypeElement=document.createElement("span"),this.dataSourcesContainer=document.createElement("div"),this.detectedLayerConstructor=void 0;const t=this.element,r=this.dataSourcesContainer;t.classList.add("neuroglancer-layer-data-sources-tab"),r.classList.add("neuroglancer-layer-data-sources-container");const i=this.addDataSourceIcon;if(i.style.alignSelf="start",i.addEventListener("click",()=>{const a=this.layer.addDataSource(void 0);this.updateView();const l=this.sourceViews.get(a);l!==void 0&&l.urlInput.inputElement.focus()}),t.appendChild(this.dataSourcesContainer),e instanceof Ai){const a=this.layerTypeDetection,l=this.layerTypeElement;a.style.display="none",l.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),a.appendChild(document.createTextNode("Create as ")),a.appendChild(l),a.appendChild(document.createTextNode(" layer")),t.appendChild(a),a.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),a.addEventListener("click",()=>{q2(e)})}const s=this.reRender=ct(()=>this.updateView());this.registerDisposer(e.dataSourcesChanged.add(s)),this.registerDisposer(this.visibility.changed.add(s)),this.updateView()}updateLayerTypeDetection(){const e=(()=>{const r=this.layer;if(!(r instanceof Ai))return;const i=r.detectedLayerConstructor;if(i!==void 0){for(const s of this.sourceViews.values())if(s.urlInput.dirty.value)return;return i}})();if(e===this.detectedLayerConstructor)return;const t=this.layerTypeDetection;if(this.detectedLayerConstructor=e,e!==void 0){const r=this.layerTypeElement;r.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){const e=this.sourceViews;for(const t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;const e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;const r=Date.now(),i=this.sourceViews,s=this.layer;function*a(){let l=!0;const c=s.dataSources;for(const u of c){let h=i.get(u);h===void 0&&(h=new E4(this,u),h.registerDisposer(h.urlInput.dirty.changed.add(this.reRender)),i.set(u,h)),h.seenGeneration=r,h.updateView();const g=u.spec.url;c.length===1&&g===""&&setTimeout(()=>{h.urlInput.inputElement.focus()},0),l=u.spec.url.length===0,yield h.element}l||(yield this.addDataSourceIcon)}Yr(this.dataSourcesContainer,a.call(this));for(const l of i){var t=ae(l,2);const c=t[0],u=t[1];u.seenGeneration!==r&&(u.dispose(),i.delete(c))}}this.updateLayerTypeDetection()}}const Vc="tab",B1="tabs",F1="panels",k4=j(j({},la),{row:0}),J2=j(j({},la),{visible:!0,row:0});class ad extends K{constructor(e){super(),this.panels=e,this.layer=this.panels.layer,this.location=new Ls(J2),this.tabsChanged=new Ze,this.selectedTab=new dt(void 0),this.tabs=[]}initialize(){const e=this.panels;this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add(()=>{var t;e.specificationChanged.dispatch();const r=this.layer,i=r.manager.root.selectedLayer;if(((t=i.layer)===null||t===void 0?void 0:t.layer)!==r||this!==r.panels.panels[0])return;const s=this.location.value;i.location.value!==s&&(i.location.value=s,i.location.locationChanged.dispatch())}),this.location.locationChanged.add(()=>{this.location.visible||this!==this.panels.panels[0]&&this.panels.removePanel(this)})}normalizeTabs(){const e=this.tabs;if(e.length===0){this.selectedTab.value=void 0;return}const t=this.layer.tabs.options,r=a=>{var l;return(l=t.get(a).order)!==null&&l!==void 0?l:0};e.sort((a,l)=>r(a)-r(l));const i=this.selectedTab,s=i.value;(s===void 0||!e.includes(s))&&(i.value=e[0])}pin(){var e;const t=this.layer,r=t.manager.root.selectedLayer;if(((e=r.layer)===null||e===void 0?void 0:e.layer)!==t||this!==t.panels.panels[0]||this.tabs.length===0)return;const i=this.panels,s=t.registerDisposer(new ad(i));i.panels.splice(0,1,s),i.panels.push(this),i.updateTabs(),s.initialize(),r.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){var e;const t=this.panels,r=t.panels.indexOf(this);if(r===-1||r===0)return;const i=this.layer,s=i.manager.root.selectedLayer,a=(e=s.layer)===null||e===void 0?void 0:e.layer;s.visible&&a!=null&&a!=i&&a.panels.panels[0].pin(),t.panels.splice(r,1);var l=t.panels.splice(0,1,this),c=ae(l,1);const u=c[0];if(this.explicitTabs===void 0)i.unregisterDisposer(u);else{t.panels.push(u);for(let h=1,g=t.panels.length;h<g;++h){const v=t.panels[h];v.explicitTabs===void 0&&(v.explicitTabs=new ze(v.tabs))}}this.explicitTabs=void 0,t.updateTabs(),s.layer=i.managedLayer,s.location.value=this.location.value,s.location.locationChanged.dispatch(),s.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;const r=this.panels;{const a=this.explicitTabs;a!==void 0&&a.delete(e)}const i=this.layer,s=i.registerDisposer(new ad(r));s.location.value=t,s.explicitTabs=new ze([e]),r.panels.splice(1,0,s),r.updateTabs(),s.initialize(),i.manager.root.layerManager.layersChanged.dispatch(),r.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{const i=this.explicitTabs;i!==void 0&&i.delete(e)}{const i=t.explicitTabs;i!==void 0&&i.add(e)}const r=this.panels;r.updateTabs(),t.selectedTab.value=e,r.specificationChanged.dispatch()}mergeInto(e){const t=e.explicitTabs;if(t!==void 0)for(const r of this.tabs)t.add(r);this.panels.removePanel(this)}}class L4{constructor(e){this.layer=e,this.specificationChanged=new Ze,this.updating=!1,this.panels=[e.registerDisposer(new ad(this))]}restoreState(e){const t=this.panels;t[0].selectedTab.value=ye(e,Vc,ke);const r=this.layer,i=r.tabs,s=new ze(i.options.keys());ye(e,F1,a=>We(a,l=>{ge(l);const c=new ad(this);c.location.restoreState(l),c.location.visible&&(c.selectedTab.value=ye(l,Vc,ke),c.explicitTabs=ye(l,B1,u=>{const h=new ze;for(const g of kr(u))s.has(g)&&(s.delete(g),h.add(g));return h}),c.explicitTabs===void 0?(c.tabs=Te(s),s.clear()):c.tabs=Te(c.explicitTabs),c.tabs.length!==0&&(c.normalizeTabs(),r.registerDisposer(c),c.initialize(),t.push(c)))})),t[0].tabs=Te(s),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;const t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){var e;const t=this.layer,r=t.tabs,i=new ze(r.options.keys()),s=this.panels;this.updating=!0;const a=l=>{const c=l.tabs;if(l.explicitTabs===void 0)l.tabs=Te(i),i.clear();else{l.tabs=Te(l.explicitTabs);for(const u of l.tabs)i.delete(u)}Oe(c,l.tabs)||(l.normalizeTabs(),l.tabsChanged.dispatch())};for(let l=1;l<s.length;){const c=s[l];if(c.location.visible&&(a(c),c.tabs.length!==0)){++l;continue}s.splice(l,1),t.unregisterDisposer(c)}if(a(s[0]),s[0].tabs.length===0){const l=this.layer.manager.root.selectedLayer;((e=l.layer)===null||e===void 0?void 0:e.layer)===this.layer&&(l.location.visible=!1)}this.updating=!1}toJSON(){var e;const t=this.panels,r={};if(r[Vc]=t[0].selectedTab.value,t.length>1){const i=[];for(let s=1,a=t.length;s<a;++s){const l=t[s],c=(e=l.location.toJSON())!==null&&e!==void 0?e:{};c[Vc]=l.selectedTab.value;const u=l.explicitTabs;u!==void 0&&(c[B1]=Te(u)),i.push(c)}r[F1]=i}return r}}const I4=/^[A-Z]$/;class _1 extends K{constructor(e,t){super(),this.tool=e,this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(ve(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}cancel(){this==this.tool.layer.manager.root.toolBinder.activeTool_&&this.tool.layer.manager.root.toolBinder.deactivate_()}}class To extends K{constructor(e,t=!1){super(),this.layer=e,this.toggle=t,this.changed=new Ze,this.keyBinding=void 0}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}unbind(){const e=this.layer,t=this.keyBinding;t!==void 0&&e.toolBinder.set(t,void 0)}}class Y2 extends K{constructor(e){super(),this.layer=e,this.changed=new Ze}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){const e=this.layer;e.tool.value===this&&(e.tool.value=void 0)}}function U1(n,e){var t;if(e===void 0)return;typeof e=="string"&&(e={type:e}),ge(e);const r=X(e,"type",ke);let i=(t=Yg.get(n.constructor))===null||t===void 0?void 0:t.get(r);if(i===void 0&&(i=P4.get(r)),i===void 0)throw new Error(`Invalid tool type: ${ie(e)}.`);return i(n,e)}function D4(n,e){if(e===void 0)return;typeof e=="string"&&(e={type:e}),ge(e);const t=X(e,"type",ke),r=X2.get(t);if(r===void 0)throw new Error(`Invalid tool type: ${ie(e)}.`);return r(n,e)}const X2=new de,P4=new de,Yg=new de;function Fd(n,e){X2.set(n,e)}function od(n,e,t){let r=Yg.get(n);r===void 0&&(r=new de,Yg.set(n,r)),r.set(e,t)}class R4 extends K{constructor(e){super(),this.layer=e,this.changed=new Ze}get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),e!==void 0&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){const e=this.value_;e!==void 0&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=D4(this.layer,e)}reset(){this.value=void 0}toJSON(){const e=this.value_;if(e!==void 0)return e.toJSON()}}class M4 extends K{constructor(e){super(),this.inputEventMapBinder=e,this.bindings=new de,this.changed=new Ze,this.debounceDeactivate=this.registerCancellable(rt(()=>this.deactivate_(),100)),this.debounceReactivate=this.registerCancellable(rt(()=>this.reactivateQueuedTool(),100))}get(e){return this.bindings.get(e)}set(e,t){const r=this.bindings,i=r.get(e);if(i!==void 0){i.keyBinding=void 0,r.delete(e);const s=i.layer.toolBinder;s.bindings.delete(e),s.jsonToKey.delete(ie(i.toJSON())),this.destroyTool(i),s.changed.dispatch()}if(t!==void 0){const s=t.layer.toolBinder,a=ie(t.toJSON()),l=s.jsonToKey.get(a);if(l!==void 0){const c=s.bindings.get(l);c.keyBinding=void 0,r.delete(l),s.bindings.delete(l),s.jsonToKey.delete(a),this.destroyTool(c)}s.bindings.set(e,t),t.keyBinding=e,s.jsonToKey.set(a,e),r.set(e,t),s.changed.dispatch()}this.changed.dispatch()}activate(e){const t=this.get(e);if(t===void 0){this.deactivate_();return}this.debounceDeactivate.cancel(),this.debounceReactivate.cancel();const r=this.activeTool_;if(t===r?.tool){t.toggle&&this.deactivate_();return}else r!==void 0&&(r.tool.toggle&&!t.toggle&&(this.queuedTool=r.tool),this.deactivate_());const i=new _1(t,this.inputEventMapBinder);if(this.activeTool_=i,!t.toggle){const s=`Key${e}`;i.registerEventListener(window,"keyup",a=>{a.code===s&&(this.debounceDeactivate(),this.debounceReactivate())}),i.registerEventListener(window,"blur",()=>{this.debounceDeactivate(),this.debounceReactivate()})}return t.activate(i),t}reactivateQueuedTool(){if(this.queuedTool){const e=new _1(this.queuedTool,this.inputEventMapBinder);this.activeTool_=e,this.queuedTool.activate(e),this.queuedTool=void 0}}destroyTool(e){var t;this.queuedTool===e&&(this.queuedTool=void 0),((t=this.activeTool_)===null||t===void 0?void 0:t.tool)===e&&this.deactivate_(),e.dispose()}disposed(){this.deactivate_(),super.disposed()}deactivate_(){this.debounceDeactivate.cancel();const e=this.activeTool_;e!==void 0&&(this.activeTool_=void 0,e.dispose())}}class A4{constructor(e){this.layer=e,this.bindings=new de,this.jsonToKey=new de,this.changed=new Ze,e.registerDisposer(()=>this.clear())}get globalBinder(){return this.layer.manager.root.toolBinder}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){const r=U1(this.layer,t);r!==void 0&&this.set(e,r)}removeJsonString(e){const t=this.jsonToKey.get(e);t!==void 0&&this.set(t,void 0)}toJSON(){const e=this.bindings;if(e.size===0)return;const t={};for(const i of e){var r=ae(i,2);const s=r[0],a=r[1];t[s]=a.toJSON()}return t}clear(){const e=this.globalBinder,t=this.bindings;if(t.size!==0){for(const i of t){var r=ae(i,2);const s=r[0],a=r[1];a.keyBinding=void 0,e.bindings.delete(s),e.destroyTool(a)}t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(e!==void 0){ge(e);for(const r of Ld(e)){var t=ae(r,2);const i=t[0],s=t[1];if(!i.match(I4))throw new Error(`Invalid tool key: ${ie(i)}`);const a=U1(this.layer,s);if(a===void 0)return;this.set(i,a)}}}}class K2 extends K{constructor(e,t){super(),this.layer=e,this.toolJson=t,this.element=document.createElement("div"),this.toolJsonString=ie(this.toolJson);const r=this.element;r.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.toolBinder.changed.add(this.registerCancellable(ct(()=>this.updateView())))),this.updateView(),r.title="click → bind key, dbclick → unbind",r.addEventListener("dblclick",()=>{this.layer.toolBinder.removeJsonString(this.toolJsonString)}),Z2(this,r,i=>this.layer.toolBinder.setJson(i,this.toolJson))}updateView(){const e=this.layer.toolBinder.jsonToKey.get(this.toolJsonString);this.element.textContent=e??" "}}function Z2(n,e,t){let r;e.addEventListener("mousedown",i=>{i.button!==0||r!==void 0||(i.preventDefault(),i.stopPropagation(),r=new K,n.registerDisposer(r),r.registerDisposer(new Ke(!1)).setText("Press A-Z to bind key"),r.registerEventListener(window,"keydown",s=>{const a=s.code.match(/^Key([A-Z])$/);if(a===null)return;s.stopPropagation(),s.preventDefault();const l=a[1];t(l)},{capture:!0}),r.registerEventListener(window,"mouseup",s=>{s.button!==0||r===void 0||(s.preventDefault(),s.stopPropagation(),n.unregisterDisposer(r),r.dispose(),r=void 0)}))}),e.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation()})}function Uf(n,e,t){const r=document.createElement("div");r.classList.add("neuroglancer-tool-button"),r.appendChild(n.registerDisposer(new K2(e,t.toolJson)).element);const i=document.createElement("div");return i.classList.add("neuroglancer-tool-button-label"),i.textContent=t.label,t.title&&(i.title=t.title),r.appendChild(i),r}function N4(n){const e=n.registerDisposer(new Ke(!1));e.element.classList.add("neuroglancer-tool-status");const t=document.createElement("div");t.classList.add("neuroglancer-tool-status-content"),e.element.appendChild(t);const r=n.inputEventMapBinder;return n.inputEventMapBinder=(i,s)=>{const a=document.createElement("div");a.textContent=i.describe(),a.classList.add("neuroglancer-tool-status-bindings"),e.element.appendChild(a),r(i,s)},{message:e,content:t}}function wh(n){var e=N4(n);const t=e.message,r=e.content,i=document.createElement("div");i.classList.add("neuroglancer-tool-status-header");const s=document.createElement("div");s.classList.add("neuroglancer-tool-status-header-container"),s.appendChild(i),r.appendChild(s);const a=document.createElement("div");return a.classList.add("neuroglancer-tool-status-body"),r.appendChild(a),{message:t,body:a,header:i}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function V4(n,e){n.remove(e)}function O4(n,e){n.add(e)}const Q2="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%20aria-labelledby='controlsAltIconTitle'%3e%3ctitle%20id='controlsAltIconTitle'%3eControls%3c/title%3e%3ccircle%20cx='9'%20cy='6'%20r='2'/%3e%3cpath%20d='M4%206H7'/%3e%3cpath%20d='M11%206H20'/%3e%3ccircle%20cx='9'%20cy='18'%20r='2'/%3e%3cpath%20d='M4%2018H7'/%3e%3cpath%20d='M11%2018H20'/%3e%3ccircle%20cx='15'%20cy='12'%20r='2'/%3e%3cpath%20d='M4%2012H13'/%3e%3cpath%20d='M17%2012L20%2012'/%3e%3c/svg%3e",B4="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%20aria-labelledby='layersIconTitle'%3e%3ctitle%20id='layersIconTitle'%3eLayers%3c/title%3e%3cpath%20d='M12%204L20%208.00004L12%2012L4%208.00004L12%204Z'/%3e%3cpath%20d='M20%2012L12%2016L4%2012'/%3e%3cpath%20d='M20%2016L12%2020L4%2016'/%3e%3c/svg%3e",F4="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='listIconTitle'%3e%3ctitle%20id='listIconTitle'/%3e%3cpath%20d='M10%207L18%207M10%2012L18%2012M10%2017L18%2017'/%3e%3cline%20x1='7'%20y1='7'%20x2='7'%20y2='7'/%3e%3cline%20x1='7'%20y1='12'%20x2='7'%20y2='12'/%3e%3cline%20x1='7'%20y1='17'%20x2='7'%20y2='17'/%3e%3c/svg%3e",_4="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='settingsIconTitle'%3e%3ctitle%20id='settingsIconTitle'%3eSettings%3c/title%3e%3cpath%20d='M5.03506429,12.7050339%20C5.01187484,12.4731696%205,12.2379716%205,12%20C5,11.7620284%205.01187484,11.5268304%205.03506429,11.2949661%20L3.20577137,9.23205081%20L5.20577137,5.76794919%20L7.9069713,6.32070904%20C8.28729123,6.0461342%208.69629298,5.80882212%209.12862533,5.61412402%20L10,3%20L14,3%20L14.8713747,5.61412402%20C15.303707,5.80882212%2015.7127088,6.0461342%2016.0930287,6.32070904%20L18.7942286,5.76794919%20L20.7942286,9.23205081%20L18.9649357,11.2949661%20C18.9881252,11.5268304%2019,11.7620284%2019,12%20C19,12.2379716%2018.9881252,12.4731696%2018.9649357,12.7050339%20L20.7942286,14.7679492%20L18.7942286,18.2320508%20L16.0930287,17.679291%20C15.7127088,17.9538658%2015.303707,18.1911779%2014.8713747,18.385876%20L14,21%20L10,21%20L9.12862533,18.385876%20C8.69629298,18.1911779%208.28729123,17.9538658%207.9069713,17.679291%20L5.20577137,18.2320508%20L3.20577137,14.7679492%20L5.03506429,12.7050339%20Z'/%3e%3ccircle%20cx='12'%20cy='12'%20r='1'/%3e%3c/svg%3e";class _d extends K{}function eI(n){let e,t,r;return(i,s)=>t!==void 0&&(e===void 0||i===void 0||e.generation!==i.generation)?(e===void 0&&r.addConsumer(s),t):(e=void 0,r=new CO,t=n(i,r).then(a=>(e=a,r=void 0,a),a=>{throw r.isCanceled&&(r=void 0,t=void 0),a}),t)}function Sh(n){let e=0;return eI((t,r)=>n(r).then(i=>({generation:++e,credentials:i})))}class U4{constructor(){this.providers=new de,this.topLevelManager=this}register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){const r=this.providers.get(e);if(r===void 0)throw new Error(`No registered credentials provider: ${ie(e)}`);return r(t,this.topLevelManager)}}class $4 extends K{constructor(e){super(),this.base=e,this.memoize=new Jk}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}}class tI extends $4{constructor(){super(new U4),this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}}class z4 extends _d{constructor(e,t){super(),this.baseProvider=e,this.anonymousCredentials=t,this.anonymous=!0,this.get=eI(r=>this.anonymous&&r===void 0?xt.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(r)))}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $o=new tI;/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ir(n,e){return t=>{t.style.flex=n,e(t)}}function qs(n,e){return t=>{t.style.display="flex",t.style.flexDirection=n;for(let r of e){let i=t.ownerDocument.createElement("div");t.appendChild(i),r(i)}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const G4=Je();function nI(n,e){const t=ZT(G4),r=n.globalPosition;var i=n.displayDimensionRenderInfo;const s=i.canonicalVoxelFactors,a=i.displayDimensionIndices;for(let l=0;l<3;++l){const c=a[l];t[12+l]=c===-1?0:r[c],t[5*l]=e/s[l]}return en(t,n.viewProjectionMat,t),t}class Ch extends K{constructor(e){super(),this.gl=e,this.vertexBuffer=this.registerDisposer($n.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW));let t=.5;this.colorBuffer=this.registerDisposer($n.fromData(e,new Float32Array([1,0,0,t,1,0,0,t,0,1,0,t,0,1,0,t,0,0,1,t,0,0,1,t]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer(HO(e))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",()=>new Ch(e))}draw(e,t=!0){let r=this.trivialColorShader,i=this.gl;r.bind(),i.uniformMatrix4fv(r.uniform("uProjectionMatrix"),!1,e);let s=r.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(s,4);let a=r.attribute("aColor");this.colorBuffer.bindToVertexAttrib(a,4),t&&(i.colorMask(!1,!1,!1,!0),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),i.colorMask(!0,!0,!0,!0),i.enable(i.BLEND),i.blendFunc(i.ONE_MINUS_DST_ALPHA,i.DST_ALPHA)),i.lineWidth(1),i.drawArrays(i.LINES,0,6),t&&i.disable(i.BLEND),i.disableVertexAttribArray(s),i.disableVertexAttribArray(a)}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const W4="perspective_view/PerspectiveView";/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rI{constructor(){this.renderLayers=[null],this.pickData=[null],this.values=[0,0,0],this.nextPickID=1}clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t,r=1,i=null){return this.register(e,r,t.low,t.high,i)}register(e,t=1,r=0,i=0,s=null){let a=this.renderLayers,l=this.values,c=this.nextPickID;this.nextPickID+=t;let u=a.length;a[u]=e;let h=u*3;return l[h]=c,l[h+1]=r,l[h+2]=i,this.pickData[u]=s,c}setMouseState(e,t){const r=this.renderLayers,i=this.values;let s=0,a=r.length-1;for(;s<a;){const v=Math.ceil(s+(a-s)/2);i[v*3]>t?a=v-1:s=v}const l=e.pickedRenderLayer=r[s],c=s*3,u=e.pickedOffset=t-i[c];let h=e.pickedValue;h.low=i[c+1],h.high=i[c+2],e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferBaseOffset=void 0,e.pickedAnnotationIndex=void 0,e.pickedAnnotationCount=void 0,e.pickedAnnotationType=void 0;const g=this.pickData[s];l!==null&&l.updateMouseState(e,h,u,g)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xa{static insertAfter(e,t){let r=e.next0;t.next0=r,t.prev0=e,e.next0=t,r.prev0=t}static insertBefore(e,t){let r=e.prev0;t.prev0=r,t.next0=e,e.prev0=t,r.next0=t}static front(e){let t=e.next0;return t===e?null:t}static back(e){let t=e.prev0;return t===e?null:t}static pop(e){let t=e.next0,r=e.prev0;return t.prev0=r,r.next0=t,e.next0=null,e.prev0=null,e}static*iterator(e){for(let t=e.next0;t!==e;t=t.next0)yield t}static*reverseIterator(e){for(let t=e.prev0;t!==e;t=t.prev0)yield t}static initializeHead(e){e.next0=e.prev0=e}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class j4{constructor(){Xa.initializeHead(this)}}const Xg=new j4,H4=window.top===window,dy=rt(()=>{if(!H4)return;var n=document;const e=n.activeElement;if(e===null||e===document.body){const t=Xa.front(Xg);t!==null&&t.element.focus({preventScroll:!0})}});window.addEventListener("focus",()=>{dy()},!0);window.addEventListener("blur",()=>{dy()},!0);class xh extends K{constructor(e){super(),this.element=e,this.prev0=null,this.next0=null,this.lastFocusedElement=null,this.scheduleUpdateFocus=this.registerCancellable(rt(()=>{var t=document;const r=t.activeElement,i=this.element;i.contains(r)||Kv(r)||(r!=null&&(r===this.lastFocusedElement||r.contains(i))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null)},0)),e.tabIndex=-1,this.registerEventListener(e,"pointerdown",t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))}),this.registerEventListener(e,"mouseenter",()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()}),this.registerEventListener(e,"mouseleave",()=>{this.scheduleUpdateFocus.cancel()}),Xa.insertBefore(Xg,this),this.registerEventListener(e,"focus",()=>{Xa.pop(this),Xa.insertAfter(Xg,this)}),dy()}disposed(){Xa.pop(this),super.disposed()}}const $1=10,q4=1e3,J4=400,Y4=500,X4=Math.PI/20,K4=20,Z4=10;function iI(n,e){return Math.sqrt(n*n+e*e)}function z1(n){var e=ae(n,2);let t=e[0],r=e[1];if(t.identifier>r.identifier){var i=[t,r];r=i[0],t=i[1]}const s=t.clientX-r.clientX,a=t.clientY-r.clientY,l=iI(s,a),c=Math.atan2(s,a);return{distance:l,angle:c}}function Q4(n,e){const t=Math.PI*2,r=Math.abs(n-e)%t;return Math.min(r,t-r)}class e$ extends K{constructor(e,t){super(),this.target=e,this.eventMap=t,this.prevTouches=new de,this.moved=!1,this.prevAngle=0,this.rotated=!1,this.prevDistance=0,this.pinched=!1,this.prevCenterX=0,this.prevCenterY=0,this.translated=!1,this.startHold=this.registerCancellable(hh((r,i,s,a)=>{const l={event:r,centerX:s,centerY:a};this.dispatch(`touchhold${r.targetTouches.length}`,r,l,i)},q4,{leading:!1,trailing:!0})),this.numPriorTaps=0,this.priorTapNumTouches=0,this.tapStartTime=0,this.tapEndTime=0,this.curTapNumTouches=0,this.registerEventListener(e,"touchstart",r=>{this.handleTouchEvent(r)}),this.registerEventListener(e,"touchmove",r=>{this.handleTouchEvent(r)}),this.registerEventListener(e,"touchend",r=>{this.handleTouchEvent(r)})}dispatch(e,t,r,i=t.eventPhase){E2(e,t,i,r,this.eventMap)}handleTouchEvent(e){if(e.target===this.target)e.preventDefault();else return;const t=new de,r=this.prevTouches,i=this.prevEvent;let s=0,a=0;for(const S of e.targetTouches)t.set(S.identifier,S),s+=S.clientX,a+=S.clientY;s/=t.size,a/=t.size;for(const S of r.entries()){var l=ae(S,2);const w=l[0],E=l[1],k=t.get(w);if(k===void 0)r.delete(w);else{const P=k.clientX-E.clientX,D=k.clientY-E.clientY;(Math.abs(P)>=$1||Math.abs(D)>=$1)&&(this.moved=!0)}}if(i===void 0||i.targetTouches.length!==t.size||t.size==0){if(this.moved=!1,e.type==="touchstart")this.startHold(e,e.eventPhase,s,a),(i===void 0||i.targetTouches.length===0)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if(e.type=="touchend"){const S=Date.now();if(e.targetTouches.length===0&&S-this.tapStartTime<J4){(this.curTapNumTouches!==this.priorTapNumTouches||S-this.tapEndTime>=Y4)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=S,this.priorTapNumTouches=this.curTapNumTouches;const w={event:e,centerX:s,centerY:a};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,w)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=s,this.prevCenterY=a,this.translated=!1,t.size===2){var c=z1(t.values());const S=c.distance,w=c.angle;this.prevDistance=S,this.prevAngle=w,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let u=this.prevCenterX,h=this.prevCenterY,g=this.translated;const v=s-u,y=a-h;if(g===!1&&iI(v,y)>=Z4&&(g=this.translated=!0),g===!0&&(v!==0||y!==0)){this.prevCenterX=s,this.prevCenterY=a;const S={event:e,deltaX:v,deltaY:y,centerX:s,centerY:a};this.dispatch(`touchtranslate${t.size}`,e,S)}if(t.size===2){var C=z1(t.values());const S=C.distance,w=C.angle;let E=this.pinched,k=this.rotated,P=this.prevDistance,D=this.prevAngle;E===!1&&Math.abs(S-P)>=K4&&(this.pinched=E=!0);const L=Q4(w,D);if(k===!1&&L>=X4&&(this.rotated=k=!0),E===!0&&S!=P){this.prevDistance=S;const R={event:e,distance:S,prevDistance:P,centerX:s,centerY:a};this.dispatch("touchpinch",e,R)}k===!0&&w!==D&&(this.prevAngle=w,this.dispatch("touchrotate",e,{event:e,centerX:s,centerY:a,angle:w,prevAngle:D}))}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const t$=0,n$=1,r$=2;function xu(n){let e=0;switch(n.deltaMode){case t$:e=1/200;break;case n$:e=1/10;break;case r$:e=2;break}return Math.exp(n.deltaY*e)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $f=Ne();class G1{constructor(){this.pickIDs=new rI,this.viewportWidth=0,this.viewportHeight=0,this.invTransform=Je(),this.frameNumber=-1}}class W1{constructor(){this.buffer=null,this.glWindowX=0,this.glWindowY=0}}const i$=30,Zt=5,nt=1+Zt*2,Eu=(()=>{const n=Zt**2,e=(i,s)=>(i-Zt)**2+(s-Zt)**2;let t=new Uint32Array(nt*nt),r=0;for(let i=0;i<nt;++i)for(let s=0;s<nt;++s)e(i,s)>n||(t[r++]=s*nt+i);return t=t.subarray(0,r),t.sort((i,s)=>{const a=i%nt,l=(i-a)/nt,c=s%nt,u=(s-c)/nt;return e(a,l)-e(c,u)}),t})();function sI(n,e,t,r,i,s,a){const l=r-Zt,c=i-Zt;if(!(l>=0&&c>=0&&l+nt<=s&&c+nt<=a))for(let u=0;u<nt;++u)for(let h=0;h<nt;++h){const g=l+h,v=c+u;(g<0||v<0||g>=s||v>=a)&&(n[e+(v*nt+g)*t]=0)}}class aI extends Kk{constructor(e,t,r){super(e,t,r.visibility),this.viewer=r,this.mouseX=-1,this.mouseY=-1,this.pickRequestPending=!1,this.mouseStateForcer=()=>this.blockOnPickRequest(),this.pickingData=[new G1,new G1],this.pickRequests=[new W1,new W1],this.pickBufferContents=new Float32Array(8*nt*nt),this.pickTimerId=-1,this.nextPickRequestTime=0,this.pendingPickRequestTimerId=-1,this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,this.pickRequestPending&&this.attemptToIssuePickRequest()},this.inputEventMap=r.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP<"u"&&NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP===!0&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new xh(t)),this.registerDisposer(new Nr(t,this.inputEventMap)),this.registerDisposer(new Bi(t,this.inputEventMap,i=>{this.onMousemove(i)})),this.registerDisposer(new e$(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",()=>this.onMouseout()),this.registerEventListener(t,"mouseover",i=>{i.target!==t&&this.onMouseout()},!0),ve(t,"select-position",()=>{this.viewer.selectionDetailsState.select(!1)}),ve(t,"snap",()=>{this.navigationState.pose.snap()}),ve(t,"zoom-in",()=>{this.navigationState.zoomBy(.5)}),ve(t,"zoom-out",()=>{this.navigationState.zoomBy(2)}),ve(t,"depth-range-decrease",()=>{this.navigationState.depthRange.value*=.5}),ve(t,"depth-range-increase",()=>{this.navigationState.depthRange.value*=2});for(let i=0;i<3;++i){let s=HN[i];for(let a of[-1,1]){let l=a<0?"-":"+";ve(t,`rotate-relative-${s}${l}`,()=>{this.navigationState.pose.rotateRelative($r[i],a*.1)});let c=Ne();ve(t,`${s}${l}`,()=>{let u=this.navigationState,h=c;h[0]=0,h[1]=0,h[2]=0,h[i]=a,u.pose.translateVoxelsRelative(h,!0)})}}ve(t,"zoom-via-wheel",i=>{const s=i.detail;this.onMousemove(s,!1),this.zoomByMouse(xu(s))}),ve(t,"adjust-depth-range-via-wheel",i=>{const s=i.detail;this.navigationState.depthRange.value*=xu(s)}),ve(t,"translate-via-mouse-drag",i=>{Rr(i.detail,(s,a,l)=>{this.translateByViewportPixels(a,l)})}),ve(t,"translate-in-plane-via-touchtranslate",i=>{const s=i.detail;this.translateByViewportPixels(s.deltaX,s.deltaY)}),ve(t,"translate-z-via-touchtranslate",i=>{const s=i.detail;let a=this.navigationState,l=$f;l[0]=0,l[1]=0,l[2]=s.deltaY+s.deltaX,a.pose.translateVoxelsRelative(l,!0)});for(const i of[1,10])ve(t,`z+${i}-via-wheel`,s=>{const a=s.detail;let l=this.navigationState,c=$f,u=a.deltaY!==0?a.deltaY:a.deltaX;c[0]=0,c[1]=0,c[2]=(u>0?-1:1)*i,l.pose.translateVoxelsRelative(c,!0)});ve(t,"move-to-mouse-position",()=>{const i=this.viewer.mouseState;i.updateUnconditionally()&&(this.navigationState.position.value=i.position)}),ve(t,"snap",()=>this.navigationState.pose.snap()),ve(t,"move-annotation",i=>{const s=this.viewer.mouseState,a=s.pickedAnnotationId,l=s.pickedAnnotationLayer;if(l!==void 0&&a!==void 0){i.stopPropagation();let c=l.source.getReference(a),u=c.value;const h=$l(u.type),g=s.pickedOffset,v=l.chunkTransform.value;if(v.error!==void 0)return;const y=v.layerRank,C=new Float32Array(y);h.getRepresentativePoint(C,u,s.pickedOffset);let S=WN(ik(),0,0);s.updateUnconditionally()&&Rr(i.detail,(w,E,k)=>{jN(S,S,[E,k]);const P=new Float32Array(y);Ti(P,v.chunkToLayerTransform,y+1,C,y);const D=$f,L=this.navigationState.pose.displayDimensions.value.displayDimensionIndices;$3(D,P,v.modelTransform,L),this.translateDataPointByViewportPixels(D,D,S[0],S[1]),z3(P,D,v.modelTransform,L);const R=new Float32Array(y);Ti(R,v.layerToChunkTransform,y+1,P,y);let M=h.updateViaRepresentativePoint(u,R,g);l.source.update(c,M)},w=>{l.source.commit(c),c.dispose()})}}),ve(t,"delete-annotation",()=>{const i=this.viewer.mouseState,s=i.pickedAnnotationId,a=i.pickedAnnotationLayer;if(a!==void 0&&!a.source.readonly&&s!==void 0){const l=a.source.getReference(s);try{a.source.delete(l)}finally{l.dispose()}}}),ve(t,"zoom-via-touchpinch",i=>{const s=i.detail;this.handleMouseMove(s.centerX,s.centerY);const a=s.prevDistance/s.distance;a>.1&&a<10&&this.zoomByMouse(a)})}cancelPickRequests(){const e=this.gl;for(const t of this.pickRequests){const r=t.sync;r!==null&&e.deleteSync(r),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){const t=this.gl;let r=e.buffer;r===null?(r=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,r),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,32*nt*nt,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,r);const i=this.renderViewport;let s=this.mouseX-i.visibleLeftFraction*i.logicalWidth,a=i.height-(this.mouseY-i.visibleTopFraction*i.logicalHeight);this.issuePickRequest(s,a),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=s,e.glWindowY=a,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),this.pickTimerId===-1&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;const l=this.pickRequests;e!==l[0]&&(l[1]=l[0],l[0]=e),this.nextPickRequestTime=Date.now()+i$}completePickInternal(e){const t=this.gl,r=this.pickBufferContents;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,r),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);const i=this.pickingData,s=e.frameNumber;this.completePickRequest(e.glWindowX,e.glWindowY,r,i[0].frameNumber===s?i[0]:i[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout(()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()},0)}checkForPickRequestCompletion(e=!1,t=!1){let r=this.context.frameNumber,i=-1;e&&(--r,i=r-1);const s=this.pickRequests,a=this.gl;let l=!1,c=!1,u;for(const g of s){const v=g.sync;if(v===null)continue;const y=g.frameNumber;if(!c&&y>=r-1){if(t||a.getSyncParameter(v,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(g),c=!0;else if(y!==i){l=!0;continue}}a.deleteSync(v),g.sync=null,u=g}const h=this.pickTimerId;l&&h===-1?this.scheduleCheckForPickRequestCompletion():!l&&h!==-1&&(window.clearTimeout(h),this.pickTimerId=-1),!e&&u!==void 0&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(u)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){var e=this.renderViewport;const t=e.width,r=e.height;this.checkForPickRequestCompletion(!0);const i=this.pickingData;i[0]=i[1];const s=this.context.frameNumber,a=i[1];if(a.frameNumber=s,a.viewportWidth=t,a.viewportHeight=r,a.pickIDs.clear(),!this.drawWithPicking(a)){a.frameNumber=-1;return}this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()}canIssuePickRequest(){const e=Date.now(),t=this.nextPickRequestTime,r=this.pendingPickRequestTimerId;return e<t?(r==-1&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1):!0}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;const e=this.context.frameNumber,t=this.gl,r=this.pickRequests;for(const i of r){let s=i.sync;if(s!==null)if(i.frameNumber<e-1)t.deleteSync(s);else continue;this.issuePickRequestInternal(i);return}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0){this.pickRequestPending=!1,this.cancelPickRequests();return}const r=this.context.frameNumber,i=this.pickingData[1];i.frameNumber!==r||this.renderViewport.width!==i.viewportWidth||this.renderViewport.height!==i.viewportHeight||(this.pickRequestPending=!0,this.attemptToIssuePickRequest())}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){const r=this.element,i=r.getBoundingClientRect(),s=e-(i.left+r.clientLeft),a=t-(i.top+r.clientTop),l=this.viewer.mouseState;l.pageX=e+window.scrollX,l.pageY=t+window.scrollY,l.setForcer(this.mouseStateForcer),this.updateMousePosition(s,a)}onMousemove(e,t=!0){const r=this.element;t&&e.target!==r||this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){let t=this.element;if(e.target!==t||e.targetTouches.length!==1)return;var r=e.targetTouches[0];const i=r.clientX,s=r.clientY;this.handleMouseMove(i,s)}disposed(){this.viewer.mouseState.removeForcer(this.mouseStateForcer);const e=this.gl;this.cancelPickRequests();const t=this.pendingPickRequestTimerId;t!==-1&&window.clearTimeout(t);for(const r of this.pickRequests)e.deleteBuffer(r.buffer);super.disposed()}}const s$=[1.5,2,3,5,7.5,10];class a${constructor(){this.allowedSignificands=s$,this.targetLengthInPixels=0,this.physicalSizePerPixel=0,this.prevPhysicalSizePerPixel=0,this.prevTargetLengthInPixels=0,this.prevPhysicalUnit="\0"}update(){let e=this.physicalSizePerPixel,t=this.targetLengthInPixels;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;const r=t*e,i=Math.floor(Ek(r)),s=10**i,a=r/s;let l=1;for(let h of this.allowedSignificands)if(Math.abs(h-a)<Math.abs(l-a))l=h;else break;const c=l*s,u=Tk(c);return this.lengthInPixels=Math.round(c/e),this.physicalUnit=`${u.prefix}${this.physicalBaseUnit}`,this.physicalLength=l*10**(i-u.exponent),!0}}function o$(n,e,t,r,i){const s=document.createElement("canvas"),a=s.getContext("2d"),l=i.textHeightInPixels*i.scaleFactor,c=`bold ${l}px ${i.fontName}`;a.font=c,a.fillStyle="white";const u=`${r}${n.physicalLength} ${n.physicalUnit}`,h=a.measureText(u),g=Math.max(n.lengthInPixels,h.width),v=i.barHeightInPixels*i.scaleFactor,y=i.barTopMarginInPixels*i.scaleFactor,C=v+y+l,S=i.paddingInPixels*i.scaleFactor,w=C+2*S,E=g+2*S;return s.width=E,s.height=w,a.font=c,a.textAlign="center",a.fillStyle="rgba(0, 0, 0, 0.3)",a.fillRect(0,0,E,w),a.fillStyle="white",a.fillText(u,E/2,w-S-v-y),a.fillRect(S,w-S-v,n.lengthInPixels,v),WO(e,t,s),{width:E,height:w}}class l$ extends K{constructor(e,t=new a$){super(),this.gl=e,this.dimensions=t,this.texture=null,this.width=0,this.height=0,this.label="",this.factor=1,this.priorOptions=void 0,this.prevLabel=""}update(e){const t=this.dimensions,r=this.label;let i=this.texture;if(!t.update()&&i!==null&&e===this.priorOptions&&r==this.prevLabel)return;i===null&&(i=this.texture=this.gl.createTexture());var s=o$(t,this.gl,i,r,e);const a=s.width,l=s.height;this.priorOptions=e,this.prevLabel=r,this.width=a,this.height=l}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}}class oI extends K{constructor(e){super(),this.gl=e,this.scaleBarCopyHelper=this.registerDisposer(go.get(this.gl)),this.scaleBars=[];for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new l$(e)))}draw(e,t,r,i,s){const a=this.scaleBars,l=t.displayRank,c=t.displayDimensionIndices,u=t.canonicalVoxelFactors,h=t.globalDimensionNames,g=t.displayDimensionUnits,v=t.displayDimensionScales,y=r.factors,C=Math.min(s.maxWidthFraction*e.logicalWidth,s.maxWidthInPixels*s.scaleFactor);let S=0;for(let P=0;P<l;++P){const D=c[P],L=g[P],R=y[D];let M,V,B;for(M=0;M<S&&(V=a[M],B=V.dimensions,!(B.physicalBaseUnit===L&&V.factor===R));++M);M===S&&(++S,V=a[M],V.label="",B=V.dimensions,V.factor=R,B.physicalBaseUnit=L,B.targetLengthInPixels=C,B.physicalSizePerPixel=v[P]*i/u[P]),V.label+=`${h[D]} `}const w=this.gl,E=this.scaleBarCopyHelper;let k=s.bottomPixelOffset*s.scaleFactor;for(let P=S-1;P>=0;--P){const D=a[P];S===1?D.label="":D.label+=": ",D.update(s),w.viewport(s.leftPixelOffset*s.scaleFactor-e.visibleLeftFraction*e.logicalWidth,k-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,D.width,D.height),E.draw(D.texture),k+=D.height+s.marginPixelsBetweenScaleBars*s.scaleFactor}}}const d$={scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2},lI=j(j({},d$),{maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5});function c$(n){const e=j({},lI);for(const t of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])X(n,t,r=>{r!==void 0&&(e[t]=fd(r))});return X(n,"fontName",t=>{t!==void 0&&(e.fontName=ke(t))}),e}class u$ extends Jt{constructor(){super(lI,c$)}}var Hn;(function(n){n[n.COLOR=0]="COLOR",n[n.Z=1]="Z",n[n.PICK=2]="PICK",n[n.NUM_TEXTURES=3]="NUM_TEXTURES"})(Hn||(Hn={}));const h$=`
void emit(vec4 color, highp uint pickId) {
  out_color = color;
  float zValue = 1.0 - gl_FragCoord.z;
  out_z = vec4(zValue, zValue, zValue, 1.0);
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`,p$=`
float computeOITWeight(float alpha) {
  float a = min(1.0, alpha) * 8.0 + 0.01;
  float b = -gl_FragCoord.z * 0.95 + 1.0;
  return a * a * a * b * b * b;
}
`,f$=[p$,`
void emit(vec4 color, highp uint pickId) {
  float weight = computeOITWeight(color.a);
  vec4 accum = color * weight;
  v4f_fragData0 = vec4(accum.rgb, color.a);
  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);
}
`];function zf(n){n.addOutputBuffer("vec4","out_color",Hn.COLOR),n.addOutputBuffer("highp vec4","out_z",Hn.Z),n.addOutputBuffer("highp vec4","out_pickId",Hn.PICK),n.addFragmentCode(h$)}function g$(n){n.addOutputBuffer("vec4","v4f_fragData0",0),n.addOutputBuffer("vec4","v4f_fragData1",1),n.addFragmentCode(f$)}const gi=Ne(),j1=eh(),m$=Je();function v$(n){n.addOutputBuffer("vec4","v4f_fragColor",null),n.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

v4f_fragColor = vec4(accum.rgb / accum.a, revealage);
`)}const y$=oh(ei);class b$ extends y${constructor(e){super(),this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new pu(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}}class cy extends aI{constructor(e,t,r){super(e,t,r),this.sliceViews=this.registerDisposer(new xv((s,a,l)=>{s.registerDisposer(l),s.registerDisposer(l.visibility.add(this.visibility))})),this.axesLineHelper=this.registerDisposer(Ch.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(WL.get(this.gl,zf)),this.offscreenFramebuffer=this.registerDisposer(new fo(this.gl,{colorBuffers:[new Ys(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new Ys(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new Ys(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new YO(this.gl)})),this.offscreenCopyHelper=this.registerDisposer(go.get(this.gl)),this.transparencyCopyHelper=this.registerDisposer(go.get(this.gl,v$,2)),this.scaleBars=this.registerDisposer(new oI(this.gl)),this.projectionParameters=this.registerDisposer(new pL({navigationState:this.navigationState,update:(s,a)=>{const l=s.invViewMatrix,c=s.projectionMat,u=s.logicalWidth,h=s.logicalHeight,g=u/h,v=Math.PI/4;let y=a.relativeDepthRange,C=a.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){const S=Math.max(.1,1-y),w=1+y;QT(c,-g,g,-1,1,S,w)}else{const S=1/Math.tan(v/2);y/=S;const w=Math.max(.1,1-y),E=1+y;C*=S,NN(c,v,g,w,E)}Yk(s,c),a.pose.toMat4(l,C),RN(l,l,cg(gi,1,-1,-1)),PN(l,l,$r[2]),eL(s)}})),this.projectionParameters.changed.add(()=>this.context.scheduleRedraw());const i=this.sharedObject=this.registerDisposer(new b$(this));if(i.RPC_TYPE_ID=W4,i.initializeCounterpart(r.rpc,{}),i.visibility.add(this.visibility),this.visibleLayerTracker=VI(this.viewer.layerManager,Uo,this.viewer.visibleLayerRoles,this),ve(t,"rotate-via-mouse-drag",s=>{Rr(s.detail,(a,l,c)=>{this.navigationState.pose.rotateRelative($r[1],l/4*Math.PI/180),this.navigationState.pose.rotateRelative($r[0],-c/4*Math.PI/180)})}),ve(t,"rotate-in-plane-via-touchrotate",s=>{const a=s.detail;this.navigationState.pose.rotateRelative($r[2],a.angle-a.prevAngle)}),ve(t,"rotate-out-of-plane-via-touchtranslate",s=>{const a=s.detail;this.navigationState.pose.rotateRelative($r[1],a.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative($r[0],-a.deltaY/4*Math.PI/180)}),r.showSliceViewsCheckbox){let s=this.registerDisposer(new Ts(r.showSliceViews));s.element.className="perspective-panel-show-slice-views neuroglancer-noselect";let a=document.createElement("label");a.className="perspective-panel-show-slice-views neuroglancer-noselect",a.appendChild(document.createTextNode("Sections")),a.appendChild(s.element),this.element.appendChild(a)}this.registerDisposer(r.orthographicProjection.changed.add(()=>{this.projectionParameters.update(),this.scheduleRedraw()})),this.registerDisposer(r.showScaleBar.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.scaleBarOptions.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.showSliceViews.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.showAxisLines.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.perspectiveViewBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.wireFrame.changed.add(()=>this.scheduleRedraw())),this.sliceViews.changed.add(()=>this.scheduleRedraw())}get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}translateByViewportPixels(e,t){const r=gi;var i=this.projectionParameters.value;const s=i.viewProjectionMat,a=i.invViewProjectionMat,l=i.logicalWidth,c=i.logicalHeight;this.viewer.navigationState.pose.updateDisplayPosition(u=>{ar(r,u,s),r[0]+=-2*e/l,r[1]+=2*t/c,ar(u,r,a)})}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(const c of this.sliceViews){var e=ae(c,2);const u=e[0];if((e[1]||this.viewer.showSliceViews.value)&&!u.isReady())return!1}this.ensureBoundsUpdated();var t=this.renderViewport;const r=t.width,i=t.height;if(r===0||i===0)return!0;const s={projectionParameters:this.projectionParameters.value},a=this.visibleLayerTracker.visibleLayers;for(const c of a){var l=ae(c,2);const u=l[0],h=l[1];if(!u.isReady(s,h))return!1}return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;const e=this.offscreenFramebuffer;var t=this.renderViewport;const r=t.width,i=t.height,s=r*i,a=new Float32Array(s*4);try{e.bindSingle(Hn.Z),this.gl.readPixels(0,0,r,i,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,a)}finally{e.framebuffer.unbind()}const l=new Float32Array(s);for(let c=0;c<s;++c)l[c]=a[c*4];return l}issuePickRequest(e,t){const r=this.offscreenFramebuffer;r.readPixelFloat32IntoBuffer(Hn.Z,e-Zt,t-Zt,0,nt,nt),r.readPixelFloat32IntoBuffer(Hn.PICK,e-Zt,t-Zt,16*nt*nt,nt,nt)}completePickRequest(e,t,r,i){const s=this.viewer.mouseState;s.pickedRenderLayer=null,sI(r,0,4,e,t,i.viewportWidth,i.viewportHeight);const a=Eu.length;for(let l=0;l<a;++l){const c=Eu[l];let u=r[4*c];if(u===0)continue;const h=c%nt,g=(c-h)/nt;let v=1-u;gi[0]=2*(e+h-Zt)/i.viewportWidth-1,gi[1]=2*(t+g-Zt)/i.viewportHeight-1,gi[2]=2*v-1,ar(gi,gi,i.invTransform);let y=s.position,C=s.unsnappedPosition;const S=this.navigationState.position.value,w=S.length;y.length!==w&&(y=s.position=new Float32Array(w)),C.length!==w&&(C=s.unsnappedPosition=new Float32Array(w)),y.set(S),s.coordinateSpace=this.navigationState.coordinateSpace.value;const E=this.navigationState.pose.displayDimensions.value,k=E.displayDimensionIndices;for(let D=0,L=k.length;D<L;++D)y[k[D]]=gi[D];C.set(y);const P=r[4*nt*nt+4*c];i.pickIDs.setMouseState(s,P),s.displayDimensions=E,s.setActive(!0);return}s.setActive(!1)}translateDataPointByViewportPixels(e,t,r,i){const s=gi;var a=this.projectionParameters.value;const l=a.viewProjectionMat,c=a.invViewProjectionMat,u=a.width,h=a.height;return ar(s,t,l),s[0]+=2*r/u,s[1]+=-2*i/h,ar(e,s,c)}get transparentConfiguration(){let e=this.transparentConfiguration_;return e===void 0&&(e=this.transparentConfiguration_=this.registerDisposer(new fo(this.gl,{colorBuffers:fu(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;var t=this.renderViewport;const r=t.width,i=t.height,s=this.viewer.showSliceViews.value;for(const R of this.sliceViews){var a=ae(R,2);const M=a[0];(a[1]||s)&&M.updateRendering()}let l=this.gl;this.offscreenFramebuffer.bind(r,i),l.disable(l.SCISSOR_TEST),l.enable(WebGL2RenderingContext.STENCIL_TEST),l.stencilMask(4294967295),l.clearStencil(0),l.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),l.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),l.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);const c=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(c[0],c[1],c[2],0),l.clear(l.DEPTH_BUFFER_BIT),l.clearBufferfv(WebGL2RenderingContext.COLOR,Hn.COLOR,[c[0],c[1],c[2],0]),l.clearBufferfv(WebGL2RenderingContext.COLOR,Hn.Z,fg),l.clearBufferfv(WebGL2RenderingContext.COLOR,Hn.PICK,fg),l.enable(l.DEPTH_TEST);const u=this.projectionParameters.value;let h=Ne();Qa(h,$r[2],this.navigationState.pose.orientation.orientation),rv(h,h,-1);let g=.2,v=1-g;const y={wireFrame:this.viewer.wireFrame.value,projectionParameters:u,lightDirection:h,ambientLighting:g,directionalLighting:v,pickIDs:e.pickIDs,emitter:zf,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1};Qc(e.invTransform,u.invViewProjectionMat);const C=this.visibleLayerTracker.visibleLayers;let S=!1,w=!1;for(const R of C){var E=ae(R,2);const M=E[0],V=E[1];M.isTransparent?S=!0:M.isAnnotation?w=!0:M.draw(y,V)}if(this.drawSliceViews(y),w){l.enable(WebGL2RenderingContext.BLEND),l.depthFunc(WebGL2RenderingContext.LEQUAL),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(const R of C){var k=ae(R,2);const M=k[0],V=k[1];M.isAnnotation&&M.draw(y,V)}l.depthFunc(WebGL2RenderingContext.LESS),l.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),l.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),S){l.depthMask(!1),l.enable(WebGL2RenderingContext.BLEND);const R=this.transparentConfiguration;R.bind(r,i),this.gl.clearColor(0,0,0,1),l.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),y.emitter=g$,l.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),y.emitPickID=!1;for(const M of C){var P=ae(M,2);const V=P[0],B=P[1];V.isTransparent&&V.draw(y,B)}l.disable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bindSingle(Hn.COLOR),l.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.transparencyCopyHelper.draw(R.colorBuffers[0].texture,R.colorBuffers[1].texture),l.depthMask(!0),l.disable(WebGL2RenderingContext.BLEND),l.enable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bind(r,i),l.enable(WebGL2RenderingContext.STENCIL_TEST),l.drawBuffers([l.NONE,l.COLOR_ATTACHMENT1,l.COLOR_ATTACHMENT2]),y.emitter=zf,y.emitPickID=!0,y.emitColor=!1,l.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),l.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),l.stencilMask(2);for(const M of C){var D=ae(M,2);const V=D[0],B=D[1];!V.isTransparent||!V.transparentPickEnabled||V.draw(y,B)}l.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),l.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),l.stencilMask(0);for(const M of C){var L=ae(M,2);const V=L[0],B=L[1];!V.isTransparent||V.transparentPickEnabled||V.draw(y,B)}}if(l.stencilMask(4294967295),l.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){l.drawBuffers([l.COLOR_ATTACHMENT0]),l.disable(WebGL2RenderingContext.DEPTH_TEST),l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);const R=this.scaleBars,M=this.viewer.scaleBarOptions.value;R.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,M),l.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[Hn.COLOR].texture),!0}drawSliceViews(e){let t=this.sliceViewRenderHelper,r=e.lightDirection,i=e.ambientLighting,s=e.directionalLighting,a=e.projectionParameters.viewProjectionMat;const l=this.viewer.showSliceViews.value;for(const h of this.sliceViews){var c=ae(h,2);const g=c[0];if(!c[1]&&!l)continue;var u=g.projectionParameters.value;const v=u.width,y=u.height,C=u.invViewMatrix,S=u.viewportNormalInCanonicalCoordinates;if(v===0||y===0||!g.valid)continue;let w=Math.abs(iv(r,S)),E=i+w*s,k=m$;ZT(k),k[0]=v/2,k[5]=-y/2,en(k,C,k),en(k,a,k);const P=j1,D=this.viewer.crossSectionBackgroundColor.value;P[0]=D[0],P[1]=D[1],P[2]=D[2],P[3]=1,t.draw(g.offscreenFramebuffer.colorBuffers[0].texture,k,hd(E,E,E,1),j1,0,0,1,1)}}drawAxisLines(){const e=this.viewer.navigationState.zoomFactor.value,t=this.projectionParameters.value,r=Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4,i=e*r,s=this.gl;s.drawBuffers([s.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(nI(t,i),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}}var Ka;(function(n){n[n.COLOR=0]="COLOR",n[n.PICK=1]="PICK",n[n.NUM_TEXTURES=2]="NUM_TEXTURES"})(Ka||(Ka={}));function w$(n){n.addOutputBuffer("vec4","out_fragColor",0),n.addOutputBuffer("highp vec4","out_pickId",1),n.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`)}function S$(n){n.addOutputBuffer("vec4","out_fragColor",null),n.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
}
`)}const js=Ne(),C$=Ne(),x$=eh();class Eh extends aI{constructor(e,t,r,i){super(e,t,i),this.sliceView=r,this.axesLineHelper=this.registerDisposer(Ch.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(WL.get(this.gl,S$)),this.colorFactor=hd(1,1,1,1),this.pickIDs=new rI,this.offscreenFramebuffer=this.registerDisposer(new fo(this.gl,{colorBuffers:[new Ys(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new Ys(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]})),this.offscreenCopyHelper=this.registerDisposer(go.get(this.gl)),this.scaleBars=this.registerDisposer(new oI(this.gl)),i.wireFrame.changed.add(()=>this.scheduleRedraw()),ve(t,"rotate-via-mouse-drag",s=>{const a=this.viewer.mouseState;if(a.updateUnconditionally()){const l=Float32Array.from(a.position);Rr(s.detail,(c,u,h)=>{const g=this.navigationState.pose,v=Qa(js,$r[0],g.orientation.orientation),y=Qa(C$,$r[1],g.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(y,-u/4*Math.PI/180,l),this.viewer.navigationState.pose.rotateAbsolute(v,-h/4*Math.PI/180,l)})}}),ve(t,"rotate-in-plane-via-touchrotate",s=>{const a=s.detail,l=this.viewer.mouseState;this.handleMouseMove(a.centerX,a.centerY),l.updateUnconditionally()&&this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,a.angle-a.prevAngle,l.position)}),this.registerDisposer(r),this.visibleLayerTracker=VI(this.viewer.layerManager,yo,this.viewer.visibleLayerRoles,this),this.registerDisposer(i.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(r.visibility.add(this.visibility)),this.registerDisposer(r.viewChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.registerDisposer(i.showAxisLines.changed.add(()=>{this.visible&&this.scheduleRedraw()})),this.registerDisposer(i.showScaleBar.changed.add(()=>{this.visible&&this.context.scheduleRedraw()})),this.registerDisposer(i.scaleBarOptions.changed.add(()=>{this.visible&&this.context.scheduleRedraw()}))}flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}get navigationState(){return this.sliceView.navigationState}translateByViewportPixels(e,t){this.viewer.navigationState.pose.updateDisplayPosition(r=>{cg(r,-e,-t,0),ar(r,r,this.sliceView.projectionParameters.value.invViewMatrix)})}translateDataPointByViewportPixels(e,t,r,i){const s=this.sliceView.projectionParameters.value;return ar(e,t,s.viewMatrix),cg(e,e[0]+r,e[1]+i,e[2]),ar(e,e,s.invViewMatrix),e}isReady(){if(!this.visible)return!1;const e=this.sliceView;if(this.ensureBoundsUpdated(),!e.isReady())return!1;const t={projectionParameters:e.projectionParameters.value,sliceView:e};for(const i of this.visibleLayerTracker.visibleLayers){var r=ae(i,2);const s=r[0],a=r[1];if(!s.isReady(t,a))return!1}return!0}drawWithPicking(e){const t=this.sliceView;if(!t.valid)return!1;t.updateRendering();const r=t.projectionParameters.value,i=r.width,s=r.height,a=r.invViewProjectionMat;Qc(e.invTransform,a);const l=this.gl;this.offscreenFramebuffer.bind(i,s),l.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),l.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);const c=x$,u=this.viewer.crossSectionBackgroundColor.value;c[0]=u[0],c[1]=u[1],c[2]=u[2],c[3]=1,this.offscreenFramebuffer.bindSingle(Ka.COLOR),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,sk,this.colorFactor,c,0,0,1,1);const h=this.visibleLayerTracker.visibleLayers;let g=this.pickIDs;g.clear();const v={wireFrame:this.viewer.wireFrame.value,projectionParameters:r,pickIDs:g,emitter:w$,emitColor:!0,emitPickID:!0,sliceView:t};this.offscreenFramebuffer.bind(i,s),l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(const C of h){var y=ae(C,2);const S=y[0],w=y[1];S.draw(v,w)}if(l.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(Ka.COLOR),this.viewer.showAxisLines.value){const C=Math.min(r.logicalWidth,r.logicalHeight)/4*1.5,S=this.viewer.navigationState.zoomFactor.value;this.axesLineHelper.draw(KN(nI(r,C*S)))}this.viewer.showScaleBar.value&&(l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(r,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),l.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[Ka.COLOR].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){this.offscreenFramebuffer.readPixelFloat32IntoBuffer(Ka.PICK,e-Zt,t-Zt,0,nt,nt)}completePickRequest(e,t,r,i){const s=this.viewer.mouseState;s.pickedRenderLayer=null,sI(r,0,4,e,t,i.viewportWidth,i.viewportHeight);const a=i.viewportWidth,l=i.viewportHeight,c=Eu.length,u=this.navigationState.position.value,h=u.length,g=this.navigationState.pose.displayDimensions.value,v=g.displayRank,y=g.displayDimensionIndices,C=(E,k,P)=>{const D=e+E,L=t+k;js[0]=2*D/a-1,js[1]=2*L/l-1,js[2]=0,ar(js,js,i.invTransform),P.set(u);for(let R=0;R<v;++R)P[y[R]]=js[R]};let S=s.unsnappedPosition;S.length!==h&&(S=s.unsnappedPosition=new Float32Array(h)),s.coordinateSpace=this.navigationState.coordinateSpace.value,s.displayDimensions=g,C(0,0,S);const w=(E,k,P)=>{let D=s.position;D.length!==h&&(D=s.position=new Float32Array(h)),C(E-Zt,k-Zt,D),this.pickIDs.setMouseState(s,P),s.setActive(!0)};for(let E=0;E<c;++E){const k=Eu[E],P=r[4*E];if(P===0)continue;const D=k%nt,L=(k-D)/nt;w(D,L,P);return}w(Zt,Zt,0)}zoomByMouse(e){const t=this.navigationState;if(!t.valid)return;var r=this.sliceView.projectionParameters.value;const i=r.width,s=r.height,a=r.invViewMatrix;var l=r.displayDimensionRenderInfo;const c=l.displayDimensionIndices,u=l.displayRank;let h=this.mouseX,g=this.mouseY;h-=i/2,g-=s/2;const v=this.navigationState.position.value;for(let y=0;y<u;++y){const C=c[y],S=a[y]*h+a[4+y]*g;v[C]+=S*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function dI(n,e){let t="";for(let r=0;r<=e&&(t=n.toFixed(r),parseFloat(t)!==n);++r);return t}const E$=["#f00","#0f0","#00f"],H1=at.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}});function T$(n){if(n<1||n>1024){const e=Un(n)|0,t=n/2**e;return`${dI(t,1)}p${e}`}return n.toString()}const k$=[n=>n.name,n=>n.scaleFactor],L$=2e3;class I$ extends K{constructor(e,t,r,i="px"){super(),this.displayDimensionRenderInfo=e,this.zoom=t,this.depthRange=r,this.displayUnit=i,this.element=document.createElement("div"),this.dimensionGridContainer=document.createElement("div"),this.depthGridContainer=document.createElement("div"),this.defaultCheckbox=document.createElement("input"),this.dimensionElements=Te(Array(3),(S,w)=>{const E=document.createElement("div");E.classList.add("neuroglancer-display-dimensions-widget-dimension"),E.style.display="contents",ve(E,"adjust-via-wheel",M=>{const V=M.detail.deltaY;V!==0&&this.zoomDimension(w,nd(V))});const k=document.createElement("input");k.classList.add("neuroglancer-display-dimensions-widget-name"),k.title="Change display dimensions",k.spellcheck=!1,k.autocomplete="off",k.style.color=E$[w],k.style.gridColumn="1",k.style.gridRow=`${w+1}`,k.addEventListener("focus",()=>{k.select()}),E.appendChild(k);const P=document.createElement("span");P.classList.add("neuroglancer-display-dimensions-widget-scale-factor");const D=document.createElement("input");D.spellcheck=!1,D.title="Change relative scale at which dimension is displayed",D.autocomplete="off",P.style.gridColumn="2",P.style.gridRow=`${w+1}`,D.addEventListener("focus",()=>{D.select()}),P.appendChild(D),E.appendChild(P);const L=document.createElement("span");L.classList.add("neuroglancer-display-dimensions-widget-scale"),L.style.gridColumn="3",L.style.gridRow=`${w+1}`,E.appendChild(L),this.dimensionGridContainer.appendChild(E);const R={name:k,container:E,scaleFactor:D,scale:L,scaleFactorModified:!1};k.addEventListener("input",()=>{_n(k),this.updateNameValidity()}),ve(k,"commit",()=>{this.updateNames()}),k.addEventListener("blur",M=>{const V=M.relatedTarget;this.dimensionElements.some(B=>B.name===V)||this.updateNames()||this.updateView()}),P.addEventListener("click",M=>{M.target!==D&&(D.focus(),M.preventDefault())}),D.addEventListener("input",()=>{_n(D),R.scaleFactorModified=!0}),ve(D,"commit",()=>{this.updateScaleFactors()}),D.addEventListener("blur",()=>{this.updateScaleFactors()||this.updateView()});for(const M of k$)ve(M(R),"move-up",()=>{w!==0&&M(this.dimensionElements[w-1]).focus()}),ve(M(R),"move-down",()=>{w!==2&&M(this.dimensionElements[w+1]).focus()});return R}),this.scheduleUpdateView=ct(()=>this.updateView());const s=this.element,a=this.dimensionGridContainer,l=this.defaultCheckbox,c=document.createElement("label"),u=this.registerCancellable(rt(()=>{s.dataset.active="false"},L$)),h=()=>{s.dataset.active="true",u()};this.registerDisposer(t.changed.add(h)),this.registerDisposer(e.relativeDisplayScales.changed.add(h)),this.registerDisposer(r.changed.add(h)),s.classList.add("neuroglancer-display-dimensions-widget"),s.appendChild(a),a.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),s.addEventListener("pointerleave",()=>{const S=document.activeElement;S instanceof HTMLElement&&s.contains(S)&&S.blur()}),l.type="checkbox",c.appendChild(l),c.appendChild(document.createTextNode("Default")),c.title="Display first 3 dimensions",c.classList.add("neuroglancer-display-dimensions-widget-default"),l.addEventListener("change",()=>{this.updateDefault()}),a.appendChild(c),this.registerDisposer(e),this.registerDisposer(r),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView));const g=this.registerDisposer(new Nr(s,H1));g.allShortcutsAreGlobal=!0,this.registerDisposer(new Bi(s,H1)),ve(a,"cancel",()=>{this.updateView();const S=document.activeElement;S instanceof HTMLElement&&s.contains(S)&&S.blur()});const v=this.depthGridContainer;v.classList.add("neuroglancer-depth-range-widget-grid"),s.appendChild(v);const y=document.createElement("label"),C=document.createElement("input");C.type="checkbox",y.classList.add("neuroglancer-depth-range-relative-checkbox-label"),C.classList.add("neuroglancer-depth-range-relative-checkbox"),y.appendChild(C),y.appendChild(document.createTextNode("Zoom-relative")),C.addEventListener("change",()=>{const S=C.checked;let w=this.depthRange.value;S!==w<0&&(S?w=-w/this.zoom.value:w=-w*this.zoom.value,this.depthRange.value=w)}),y.title="Depth range is multiplied by scale",s.appendChild(y),ve(v,"adjust-via-wheel",S=>{const w=S.detail.deltaY;if(w===0)return;const E=this.depthRange.value;this.depthRange.value=E*2**nd(w)}),this.registerDisposer(Di((S,w,{factors:E})=>{Xe(v);const k=w.displayRank,P=w.globalDimensionNames,D=w.displayDimensionIndices,L=w.displayDimensionUnits,R=w.displayDimensionScales,M=w.canonicalVoxelFactors,V=[],B=()=>{C.checked=this.depthRange.value<0;let U=this.depthRange.value;U<0&&(U*=-this.zoom.value);for(const O of V){const z=O.input;z.value=Qs(U*O.scale,O.unit,{precision:2,elide1:!1}),_n(z)}},_=U=>{const O=Jl(U.input.value);if(O===void 0||O.unit!==U.unit)return!1;let z=O.scale/U.scale;return this.depthRange.value<0&&(z=-z/this.zoom.value),this.depthRange.value=z,!0};for(let U=0;U<k;++U){const O=D[U],z=P[O],F=L[U],se=E[O];let oe=V.find(Re=>Re.unit===F&&Re.factor===se);if(oe===void 0){const Re=document.createElement("div");Re.title="Visible depth range",Re.style.display="contents",v.appendChild(Re);const le=document.createElement("span");le.textContent="±",Re.appendChild(le);const Se=document.createElement("input");Se.spellcheck=!1,Se.autocomplete="off",Se.addEventListener("focus",()=>{Se.select()}),ve(Se,"commit",()=>{_(oe)}),Se.addEventListener("change",()=>{_(oe)||B()}),Se.addEventListener("input",()=>{_n(Se)}),Re.appendChild(Se);const ne=document.createElement("span");ne.classList.add("neuroglancer-depth-range-widget-dimension-names"),Re.appendChild(ne),oe={unit:F,factor:se,dimensionNames:[],input:Se,label:ne,scale:R[U]/M[U]},V.push(oe)}oe.dimensionNames.push(z)}for(const U of V)U.dimensionNames.length!==k&&(U.label.textContent=U.dimensionNames.join(" "));S.registerDisposer(ve(v,"cancel",()=>{B();const U=document.activeElement;U instanceof HTMLElement&&v.contains(U)&&U.blur()}));const H=S.registerCancellable(ct(B));S.registerDisposer(this.depthRange.changed.add(H)),S.registerDisposer(this.zoom.changed.add(H)),B()},e,this.relativeDisplayScales)),this.updateView()}zoomDimension(e,t){this.updateScaleFactors();const r=this.displayDimensions,i=this.relativeDisplayScales,s=r.value.displayDimensionIndices[e];if(s===-1)return;const a=i.value.factors,l=new Float64Array(a);l[s]*=2**-t,i.setFactors(l)}updateNameValidity(){const e=this.dimensionElements,t=this.displayDimensions.value.displayDimensionIndices,r=e.map(l=>l.name.value),i=vv(r),s=this.displayDimensions.coordinateSpace.value.names,a=r.length;for(let l=0;l<a;++l){let c=i[l];const u=r[l];let h=-1;u.length===0?c=!0:(h=s.indexOf(u),h===-1&&(c=!1));const g=e[l];g.name.dataset.isValid=c.toString(),g.container.dataset.isModified=(h!==t[l]).toString()}}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}updateNames(){const e=this.dimensionElements.map(a=>a.name.value).filter(a=>a.length>0);if(!ih(e))return!1;const t=this.displayDimensionRenderInfo.displayDimensions;if(e.length===0)return t.reset(),!0;const r=new Int32Array(3);r.fill(-1);const i=t.coordinateSpace.value.names,s=e.length;for(let a=0;a<s;++a){const l=i.indexOf(e[a]);if(l===-1)return!1;r[a]=l}return Oe(r,t.value.displayDimensionIndices)||t.setDimensionIndices(s,r),!0}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){const e=this.displayDimensions,t=this.relativeDisplayScales;var r=e.value;const i=r.displayDimensionIndices,s=r.displayRank,a=t.value.factors,l=this.dimensionElements,c=new Float64Array(a);for(let u=0;u<s;++u){const h=l[u];if(!h.scaleFactorModified)continue;const g=Number(h.scaleFactor.value),v=i[u];!gt(g)||g<=0||(c[v]=g)}return Oe(c,a)||t.setFactors(c),!0}updateView(){const e=this.dimensionElements,t=this.displayDimensions.default;var r=this.displayDimensionRenderInfo.value;const i=r.displayDimensionIndices,s=r.canonicalVoxelFactors,a=r.displayDimensionUnits,l=r.displayDimensionScales,c=r.globalDimensionNames,u=this.relativeDisplayScales.value.factors;this.defaultCheckbox.checked=t;const h=this.zoom.value,g=i[0];let v=!0;if(g!==-1){const y=a[0],C=u[g];for(let S=1;S<3;++S){const w=i[S];if(w!==-1&&(a[S]!==y||u[w]!==C)){v=!1;break}}}for(let y=0;y<3;++y){const C=i[y],S=e[y];if(delete S.name.dataset.isValid,S.container.dataset.isModified=(C===-1).toString(),C===-1)S.name.value="",S.scale.textContent="",S.scaleFactor.value="";else{S.name.value=c[C];const w=l[y]*h/s[y];if(y===0||!v){const E=Qs(w,a[y],{precision:2,elide1:!1});S.scale.textContent=`${E}/${this.displayUnit}`}else S.scale.textContent="";S.scaleFactor.value=T$(u[C])}_n(S.name),_n(S.scaleFactor)}}disposed(){Et(this.element),super.disposed()}}const cI=new de([["xy",void 0],["xz",$N(Pn(),Pn(),Math.PI/2)],["yz",zN(Pn(),Pn(),Math.PI/2)]]),uI="◻",Kg=new de([["4panel","◱"],["3d",uI]]);function D$(n,e){let t;return e===void 0?t=n.navigationState.addRef():t=new Co(new So(n.navigationState.pose.position.addRef(),n.navigationState.pose.displayDimensionRenderInfo.addRef(),wo.makeRelative(n.navigationState.pose.orientation,e)),n.navigationState.zoomFactor.addRef(),n.navigationState.depthRange.addRef()),new mu(n.chunkManager,n.layerManager,t,n.wireFrame)}function Wl(n,e){return D$(n,cI.get(e))}function P$(n){return new de([["xy",Wl(n,"xy")],["xz",Wl(n,"xz")],["yz",Wl(n,"yz")]])}function hI(n){return{crossSectionBackgroundColor:n.crossSectionBackgroundColor,perspectiveViewBackgroundColor:n.perspectiveViewBackgroundColor,selectionDetailsState:n.selectionDetailsState,mouseState:n.mouseState,layerManager:n.layerManager,showAxisLines:n.showAxisLines,wireFrame:n.wireFrame,visibleLayerRoles:n.visibleLayerRoles,selectedLayer:n.selectedLayer,visibility:n.visibility,scaleBarOptions:n.scaleBarOptions}}function uy(n){const e=n.viewer;return j(j({},hI(e)),{navigationState:e.perspectiveNavigationState,inputEventMap:e.inputEventBindings.perspectiveView,orthographicProjection:n.specification.orthographicProjection,showScaleBar:e.showScaleBar,rpc:e.chunkManager.rpc})}function Tu(n){return j(j({},hI(n)),{navigationState:n.navigationState,inputEventMap:n.inputEventBindings.sliceView})}function ko(n,e){const t=e.navigationState;e.element.appendChild(n.registerDisposer(new I$(t.pose.displayDimensionRenderInfo.addRef(),t.zoomFactor,t.depthRange.addRef(),e instanceof Eh?"px":"vh")).element)}function Lo(n,e,t){const r=document.createElement("div");r.className="neuroglancer-data-panel-layout-controls",n.registerDisposer(()=>Et(r));for(let i=0;i<2;++i){const s=t[Math.min(t.length-1,i)];n.registerDisposer(ve(e.element,i===0?"toggle-layout":"toggle-layout-alternative",a=>{n.container.name=s,a.stopPropagation()}))}for(const i of t){const s=document.createElement("button"),a=document.createElement("div");s.appendChild(a),a.textContent=Kg.get(i),s.title=`Switch to ${i} layout.`,s.addEventListener("click",()=>{n.container.name=i}),r.appendChild(s)}e.element.appendChild(r)}function R$(n,e){const t=new mu(n.chunkManager,n.layerManager,e.navigationState.addRef(),n.wireFrame),r=()=>{const i=e.width.value,s=e.height.value;t.projectionParameters.setViewport({width:i,height:s,logicalWidth:i,logicalHeight:s,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return t.registerDisposer(e.width.changed.add(r)),t.registerDisposer(e.height.changed.add(r)),r(),t}function hy(n,e,t){const r=new de;(()=>{const i=new ze;for(const a of t.values()){if(i.add(a),r.has(a))continue;const l=R$(n,a);e.sliceViews.set(l,!0),r.set(a,l)}for(const a of r){var s=ae(a,2);const l=s[0],c=s[1];i.has(l)||e.sliceViews.delete(c)}})()}class M$ extends K{constructor(e,t,r,i){super(),this.container=e,this.rootElement=t,this.viewer=r;let s=P$(r),a=r.display;const l=j(j({},uy(e)),{showSliceViews:r.showPerspectiveSliceViews,showSliceViewsCheckbox:!0}),c=j(j({},Tu(r)),{showScaleBar:r.showScaleBar}),u=j(j({},Tu(r)),{showScaleBar:new Ft(!1,!1)}),h=(v,y,C,S)=>{const w=this.registerDisposer(new Eh(a,y,s.get(v),C));return S&&ko(this,w),Lo(this,w,[v,`${v}-3d`]),w};let g=[ir(1,qs("column",[ir(1,qs("row",[ir(1,v=>{h("xy",v,c,!0)}),ir(1,v=>{h("xz",v,u,!1)})])),ir(1,qs("row",[ir(1,v=>{let y=this.registerDisposer(new cy(a,v,l));for(let C of s.values())y.sliceViews.set(C.addRef(),!1);ko(this,y),hy(r,y,i),Lo(this,y,["3d"])}),ir(1,v=>{h("yz",v,u,!1)})]))]))];qs("row",g)(t)}disposed(){Xe(this.rootElement),super.disposed()}}class A$ extends K{constructor(e,t,r,i,s,a){super(),this.container=e,this.rootElement=t,this.viewer=r,this.direction=i;let l=Wl(r,s),c=r.display;const u=j(j({},uy(e)),{showSliceViews:r.showPerspectiveSliceViews,showSliceViewsCheckbox:!0}),h=j(j({},Tu(r)),{showScaleBar:r.showScaleBar});ir(1,qs(i,[ir(1,g=>{const v=this.registerDisposer(new Eh(c,g,l,h));ko(this,v),Lo(this,v,[s,"4panel"])}),ir(1,g=>{let v=this.registerDisposer(new cy(c,g,u));v.sliceViews.set(l.addRef(),!1),hy(r,v,a),ko(this,v),Lo(this,v,["3d","4panel"])})]))(t)}disposed(){Xe(this.rootElement),super.disposed()}}class N$ extends K{constructor(e,t,r,i){super(),this.container=e,this.rootElement=t,this.viewer=r;let s=Wl(r,i);const a=j(j({},Tu(r)),{showScaleBar:r.showScaleBar});qs("row",[ir(1,l=>{const c=this.registerDisposer(new Eh(r.display,l,s,a));ko(this,c),Lo(this,c,["4panel",`${i}-3d`])})])(t)}disposed(){Xe(this.rootElement),super.disposed()}}class V$ extends K{constructor(e,t,r,i){super(),this.container=e,this.rootElement=t,this.viewer=r;let s=j(j({},uy(e)),{showSliceViews:new Ft(!1,!1)});qs("row",[ir(1,a=>{const l=this.registerDisposer(new cy(r.display,a,s));hy(r,l,i),ko(this,l),Lo(this,l,["4panel"])})])(t)}disposed(){Xe(this.rootElement),super.disposed()}}const Zg=new de([["4panel",{factory:(n,e,t,r)=>new M$(n,e,t,r)}],["3d",{factory:(n,e,t,r)=>new V$(n,e,t,r)}]]);for(const n of cI.keys()){Zg.set(n,{factory:(t,r,i)=>new N$(t,r,i,n)});const e=`${n}-3d`;Kg.set(n,uI),Kg.set(e,"◫"),Zg.set(e,{factory:(t,r,i,s)=>new A$(t,r,i,"row",n,s)})}function pI(n){let e=Zg.get(n);if(e===void 0)throw new Error(`Invalid layout name: ${ie(n)}.`);return e}function O$(n){return pI(n),n}class B$ extends K{constructor(e){super(),this.width=new Jt(1e3,on),this.height=new Jt(1e3,on),this.changed=new we,this.position=new d2(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new Ug(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new $g(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new Co(new So(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){ge(e),pn(e,"width",this.width),pn(e,"height",this.height),pn(e,"position",rd(this.position)),pn(e,"orientation",this.orientation),pn(e,"scale",this.scale),pn(e,"zoom",rd(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}}class F$ extends xv{constructor(e){super((t,r)=>t.registerDisposer(t.registerDisposer(r).changed.add(this.changed.dispatch))),this.parentNavigationState=e,this.registerDisposer(e)}restoreState(e){ge(e);for(const t of Qt(e)){const r=new B$(this.parentNavigationState);try{this.set(t,r.addRef()),r.restoreState(e[t])}finally{r.dispose()}}}reset(){this.clear()}toJSON(){if(this.size===0)return;const e={};for(const r of this){var t=ae(r,2);const i=t[0],s=t[1];e[i]=s.toJSON()}return e}}class _$ extends K{constructor(e,t){super(),this.changed=new we,this.orthographicProjection=new Ft(!1),this.type=new Jt(t,O$),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new F$(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),typeof e=="string"?this.type.restoreState(e):(ge(e),X(e,"type",t=>this.type.restoreState(t)),X(e,"orthographicProjection",t=>this.orthographicProjection.restoreState(t)),X(e,"crossSections",t=>t!==void 0&&this.crossSections.restoreState(t)))}toJSON(){const e=this.type,t=this.crossSections,r=this.orthographicProjection.toJSON();return t.size===0&&r===void 0?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:r}}}class U$ extends K{constructor(e,t){super(),this.viewer=e,this.element=document.createElement("div"),this.specification=this.registerDisposer(new _$(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";const r=this.registerCancellable(rt(()=>this.updateLayout(),0));this.specification.type.changed.add(r),ve(this.element,"toggle-orthographic-projection",()=>this.specification.orthographicProjection.toggle()),this.registerDisposer(this.viewer.display.updateStarted.add(()=>r.flush())),r()}get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){let e=this.layout;e!==void 0&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=pI(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}}const fI=new de;function ca(n,e){fI.set(n,e)}function $$(n){const e=new PF(n.credentialsManager);for(const r of fI){var t=ae(r,2);const i=t[0],s=t[1];e.register(i,s(n))}return e}class na extends Error{constructor(e,t,r,i){let s=`Fetching ${ie(e)} resulted in HTTP error ${t}`;r&&(s+=`: ${r}`),s+=".",super(s),this.name="HttpError",this.message=s,this.url=e,this.status=t,this.statusText=r,i&&(this.response=i)}static fromResponse(e){return new na(e.url,e.status,e.statusText,e)}static fromRequestError(e,t){if(t instanceof TypeError){let r;return typeof e=="string"?r=e:r=e.url,new na(r,0,"Network or CORS error")}return t}}async function q1(n,e){let t;try{t=await fetch(n,e)}catch(r){throw na.fromRequestError(n,r)}if(!t.ok)throw na.fromResponse(t);return t}function z$(n){return n.arrayBuffer()}function si(n){return n.json()}async function ys(n,e,t,r=Vt){if(r===Vt){const a=await q1(n,e);return await t(a)}const i=new AbortController,s=r.add(()=>i.abort());try{const a=await q1(n,j(j({},e),{signal:i.signal}));return await t(a)}finally{s()}}function Io(n){const e=/^([^:\/]+):\/\/([^\/]+)((?:\/.*)?)$/;let t=n.match(e);if(t===null)throw new Error(`Invalid URL: ${ie(n)}`);return{protocol:t[1],host:t[2],path:t[3]}}function Th(n){return n instanceof na?n.status===0||n.status===403||n.status===404:!1}const G$=32,W$=3,j$=500,H$=1e4;function J1(n){return Math.min(2**n*j$,H$/2)*(1+Math.random())}async function py(n,e,t,r,i,s,a=Vt){let l;e:for(let c=0;;){SO(a),c>1&&await new xt(u=>setTimeout(u,J1(c-2))),l=await n.get(l,a);t:for(let u=0;;)try{return await ys(typeof e=="function"?e(l.credentials):e,i(l.credentials,t),r,a)}catch(h){if(h instanceof na){if(s(h,l.credentials)==="refresh"){if(++c===W$)throw h;continue e}if(++u===G$)throw h;await new xt(g=>setTimeout(g,J1(u-1)));continue t}throw h}}}function Js(n,e,t,r,i=Vt){return n===void 0?ys(e,t,r,i):py(n,e,t,r,(s,a)=>{if(!s.accessToken)return a;const l=new Headers(a.headers);return l.set("Authorization",`${s.tokenType} ${s.accessToken}`),j(j({},a),{headers:l})},(s,a)=>{const l=s.status;if(l===401)return"refresh";if(l===504||l===503)return"retry";if(l===403&&!a.accessToken)return"refresh";throw s},i)}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function q$(n,e,t,r,i){const s=await Js(n,`${e}?prefix=${encodeURIComponent(t)}&delimiter=${encodeURIComponent(r)}`,{},h=>h.text(),i),a=new DOMParser().parseFromString(s,"application/xml"),l=a.evaluate('//*[name()="CommonPrefixes"]/*[name()="Prefix"]',a,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),c=[];for(let h=0,g=l.snapshotLength;h<g;++h)c.push(l.snapshotItem(h).textContent||"");const u=a.evaluate('//*[name()="Contents"]/*[name()="Key"]',a,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let h=0,g=u.snapshotLength;h<g;++h)c.push(u.snapshotItem(h).textContent||"");return c}async function Qg(n,e,t,r,i){if(!r.startsWith("/"))throw null;const s=await q$(n,t,r.substring(1),"/",i);let a=r.lastIndexOf("/");return{offset:a+e.length+1,completions:s.map(l=>({value:l.substring(a)}))}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class J$ extends _d{constructor(e){super(),this.bucket=e,this.get=Sh(async()=>{var t;const r=this.bucket,i=await ys(`https://s3.amazonaws.com/${r}?location`,{},a=>a.text()),s=new DOMParser().parseFromString(i,"application/xml").querySelector("LocationConstraint");if(s===null)throw new Error(`Unable to determine location of S3 bucket: ${r}`);return{region:((t=s.textContent)===null||t===void 0?void 0:t.trim())||"us-east-1"}})}}let Oc;function gI(n){return Oc===void 0&&(Oc=new tI,Oc.register("s3",e=>new J$(e))),Oc.getCredentialsProvider("s3",n)}async function Y$(n,e,t,r,i,s=Vt){const a=(await n.get()).credentials.region;return await ys(`https://${e}.s3.${a}.amazonaws.com${t}`,r,i,s)}async function X$(n,e,t){const r=(await gI(n).get()).credentials.region;return await Qg(void 0,`s3://${n}`,`https://${n}.s3.${r}.amazonaws.com`,e,t)}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function K$(n,e){return n.getCredentialsProvider("middleauthapp",new URL(e).origin)}function Bc(n,e,t){const r=/^\/([^\/]+)/,i=t.match(r);if(i!==null)return typeof NEUROGLANCER_PYTHON_INTEGRATION<"u"?n.getCredentialsProvider("gcs",{bucket:i[1]}):n.getCredentialsProvider("ngauth_gcs",{authServer:e,bucket:i[1]})}function Ud(n,e){const t=Io(n);switch(t.protocol){case"gs":case"gs+json":case"gs+xml":return{credentialsProvider:typeof NEUROGLANCER_PYTHON_INTEGRATION<"u"?e.getCredentialsProvider("gcs",{bucket:t.host}):void 0,url:n};case"gs+ngauth+http":return{credentialsProvider:Bc(e,`http://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+ngauth+https":return{credentialsProvider:Bc(e,`https://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+xml+ngauth+http":return{credentialsProvider:Bc(e,`http://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"gs+xml+ngauth+https":return{credentialsProvider:Bc(e,`https://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"middleauth+https":return n=n.substr(11),{credentialsProvider:K$(e,n),url:n};case"s3":return{credentialsProvider:gI(t.host),url:n};default:return{credentialsProvider:void 0,url:n}}}async function zo(n,e,t,r,i=Vt){const s=Io(e);switch(s.protocol){case"gs":return Js(n,`https://www.googleapis.com/storage/v1/b/${s.host}/o/${encodeURIComponent(s.path.substring(1))}?alt=media&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,t,r,i);case"gs+json":return Js(n,`https://storage.googleapis.com/storage/v1/b/${s.host}/o/${encodeURIComponent(s.path.substring(1))}?alt=media`,t,r,i);case"gs+xml":return Js(n,`https://storage.googleapis.com/${s.host}${s.path}`,t,r,i);case"s3":return Y$(n,s.host,s.path,t,r,i);default:return Js(n,e,t,r,i)}}const Z$=typeof STATE_SERVERS<"u"&&Qt(STATE_SERVERS).length>0;class Q$ extends K{constructor(e){if(super(),this.element=document.createElement("div"),this.button=ft({text:"Share",title:"Share State"}),typeof STATE_SERVERS>"u")throw new Error("Cannot construct StateSare without defining STATE_SERVERS");if(Qt(STATE_SERVERS).length>1){const r=document.createElement("select");r.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add(()=>{const i=e.selectedStateServer.value;Jg(STATE_SERVERS).map(s=>s.url).includes(i)&&(r.value=i)})),this.registerEventListener(r,"change",()=>{e.selectedStateServer.value=r.value});for(let i of Ld(STATE_SERVERS)){var t=ae(i,2);let s=t[0],a=t[1];const l=document.createElement("option");l.textContent=s,l.value=a.url,l.selected=!!a.default,r.appendChild(l)}this.element.appendChild(r),this.selectStateServerElement=r}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",()=>{const r=this.selectStateServerElement?this.selectStateServerElement.value:Jg(STATE_SERVERS)[0].url,i=new URL(r).protocol;var s=Ud(r,$o);const a=s.url,l=s.credentialsProvider;Ke.forPromise(zo(l,a,{method:"POST",headers:{"Content-Type":"application/json"},body:ie(e.state.toJSON())},si).then(c=>{const u=new URL(c);u.protocol=i;const h=`${window.location.origin}/#!${u}`;navigator.clipboard.writeText(h).then(()=>{Ke.showTemporaryMessage("Share link copied to clipboard")})}).catch(()=>{Ke.showTemporaryMessage("Could not access state server.",4e3)}),{initialMessage:`Posting state to ${r}.`,delay:!0,errorPrefix:""})})}disposed(){this.element.remove(),super.disposed()}}function ez(n){return n.startsWith("key")?n.substring(3):n.startsWith("digit")||n.startsWith("arrow")?n.substring(5):n}function tz(n){return n.split("+").map(ez).join("+")}const nz=j(j({},la),{side:"left",row:1});class rz{constructor(){this.location=new Ls(nz)}get changed(){return this.location.changed}toJSON(){return No(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class iz extends da{constructor(e,t,r,i,s){super(e,t.location),this.bindings=r,this.toolBinder=s,this.scroll=document.createElement("div"),this.addTitleBar({title:"Help"});const a=document.createElement("div");a.classList.add("neuroglancer-help-body");const l=this.scroll;l.classList.add("neuroglancer-help-scroll-container"),a.appendChild(l),this.addBody(a);const c=this.registerCancellable(ct(()=>this.updateView()));this.registerDisposer(s.changed.add(c)),this.registerDisposer(i.layersChanged.add(c)),this.updateView()}updateView(){const e=this.scroll,t=this.bindings,r=this.toolBinder;Xe(e);const i=new de;function s(y,C){for(const w of y.parents)w.label!==void 0?a(w.label,w):s(w,C);for(const w of y.bindings.entries()){var S=ae(w,2);const E=S[0],k=S[1],P=E.indexOf(":"),D=E.substring(P+1);C.set(D,k.action)}}function a(y,C){if(i.has(C))return;const S={label:y,entries:new de};s(C,S.entries),i.set(C,S)}for(const y of t){var l=ae(y,2);const C=l[0],S=l[1];a(C,S)}const c=(y,C)=>{let S=document.createElement("h2");S.textContent=y,e.appendChild(S);for(const E of C){var w=ae(E,2);const k=w[0],P=w[1];let D=document.createElement("div");D.className="dt",D.textContent=tz(k);let L=document.createElement("div");L.className="dd",L.textContent=P,e.appendChild(D),e.appendChild(L)}},u=new de;for(const y of r.bindings){var h=ae(y,2);const C=h[0],S=h[1];let w=u.get(S.layer);w===void 0&&(w=[],u.set(S.layer,w)),w.push([`shift+key${C.toLowerCase()}`,S.description])}const g=Te(u.entries());g.length>0&&(g[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),g.sort((y,C)=>y[0].managedLayer.nonArchivedLayerIndex-C[0].managedLayer.nonArchivedLayerIndex));for(const y of g){var v=ae(y,2);const C=v[0],S=v[1];S.sort(),c(`Tool bindings for layer ${C.managedLayer.nonArchivedLayerIndex+1}: ${C.managedLayer.name}`,S)}for(const y of i.values())c(y.label,y.entries)}}function sz(n,e){n.style.display="block";const t=n.offsetWidth,r=n.offsetHeight,i=document.documentElement.clientWidth,s=document.documentElement.clientHeight,a=document.documentElement.scrollLeft+Math.min(i-t,e.clientX),l=document.documentElement.scrollTop+Math.min(s-r,e.clientY);n.style.left=a+"px",n.style.top=l+"px"}class az extends K{constructor(e){super(),this.element=document.createElement("div"),this.parentDisposers=new de,this.disabledValue=!1,this.opened=new we,this.closed=new we;const t=this.element;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),e!==void 0&&this.registerParent(e)}get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}get open(){return this.menuDisposer!==void 0}registerParent(e){const t=this.parentDisposers;t.has(e)||t.set(e,Lr(e,"contextmenu",r=>{this.show(r),r.stopPropagation(),r.preventDefault()}))}show(e){if(this.disabledValue)return;this.hide();const t=this.element,r=Lr(document,"mousedown",a=>{a.target instanceof Node&&!t.contains(a.target)&&this.hide()},!0),i=Lr(document,"keydown",a=>{a.code==="Escape"&&this.hide()},!0),s=()=>{i(),r(),t.style.display="none"};this.opened.dispatch(),sz(t,e),this.menuDisposer=s}unregisterParent(e){const t=this.parentDisposers,r=t.get(e);r!==void 0&&(r(),t.delete(e))}disposed(){const e=this.parentDisposers;for(const t of e.values())t();e.clear(),Et(this.element)}hide(){this.menuDisposer!==void 0&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}}function oz(n){return QN(new TextEncoder().encode(n))}function lz(n){return new TextDecoder().decode(eV(n))}function dz(n,e){if(n.startsWith(e))try{const t=lz(n.substring(e.length));return JSON.parse(t)}catch{return}}function cz(n,e){return n+oz(ie(e))}function uz(n,e){for(const t of n){const r=dz(t,e);if(r!==void 0)return{parameters:r,dragType:t}}}let mI;function fy(n,e){return n.dataTransfer.dropEffect=e,mI=e,e}function em(){return mI}function hz(n){return n.draggable=!0,Lr(n,"dragstart",e=>{e.stopPropagation(),e.preventDefault()})}const vI="neuroglancer-layer\0";let or;function yI(n,e){var t;n.dataTransfer.setData(cz(vI,e.layers.map(s=>({name:s.name,visible:s.visible}))),ie({layers:e.layers.map(s=>s.toJSON()),layout:e.layoutSpec})),or!==void 0&&or.disposer();let r,i=()=>{e.manager.unregisterDisposer(i);for(const s of e.layers)s.dispose();e.manager.dispose(),or===r&&(or=void 0)};or=r={manager:e.manager.addRef(),layers:e.layers.map(s=>s.addRef()),layoutSpec:e.layoutSpec,isLayerListPanel:(t=e.isLayerListPanel)!==null&&t!==void 0?t:!1,disposer:i}}function kh(n="none"){if(or!==void 0){if(n==="move"){const e=new ze(or.layers);or.manager.layerManager.filter(t=>!e.has(t))}or.disposer()}}function ku(n){return uz(n.dataTransfer.types,vI)}function bI(n){if(or!==void 0&&or.manager.rootLayers===n.rootLayers)return or}class Y1{initializeExternalLayers(e){const t=this.dragType;if(t!==void 0)try{var r=JSON.parse(e.dataTransfer.getData(t));const s=r.layers,a=r.layout;if(!Array.isArray(s)||this.numSourceLayers!==s.length)throw new Error("Invalid layer drop data");this.layoutSpec=a;for(const l of this.layers){var i=ae(l,2);const c=i[0],u=i[1];UG(c,s[u])}}catch{return!1}return!0}updateArchiveStates(e){const t=this.targetIsLayerListPanel,r=e.dataTransfer.dropEffect;for(const i of this.layers.keys()){let s=t;t&&!i.archived&&r!=="copy"&&this.sourceIsLayerListPanel&&(s=!1),(i.archived!==s||s&&i.visible)&&(i.archived=s,s&&(i.visible=!1),i.layerChanged.dispatch())}}get method(){return this.sourceManager!==void 0?this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link":"copy"}compatibleWithMethod(e){return this.method===e?!0:this.forceCopy&&e!=="copy"?!1:!this.moveSupported&&e==="move"}}function wI(n,e,t){let r;n.shiftKey?r="copy":n.ctrlKey&&t?r="move":r=e;let i="";const s=a=>{i!==""&&(i+=", "),i+=a};return e!=="none"&&r!==e&&(n.shiftKey?s(`release SHIFT to ${e}`):s(`release CONTROL to ${e}`)),r!=="copy"&&s("hold SHIFT to copy"),r!=="move"&&t&&e!=="move"&&s("hold CONTROL to move"),{dropEffect:r,dropEffectMessage:i}}function SI(n,e,t,r){const i=bI(e);let s=!1,a;return i===void 0?a="copy":r?(i.isLayerListPanel||(s=!0),a="link"):i.manager===e&&i.isLayerListPanel===t?(a="move",s=!0):t?a="none":(i.isLayerListPanel||(s=!0),a="link"),wI(n,a,s)}function pz(n,e,t,r){const i=SI(n,e,t,r);return fy(n,i.dropEffect),i}function tm(n,e,t){const r=t.forceCopy,i=t.newTarget;var s=t.isLayerListPanel;const a=s===void 0?!1:s,l=bI(e);if(!r&&l!==void 0){const u=!i&&l.manager===e&&(l.isLayerListPanel===a||l.isLayerListPanel),h=new Y1;return h.manager=e,h.numSourceLayers=l.layers.length,h.sourceManager=l.manager,h.targetIsLayerListPanel=a,h.sourceIsLayerListPanel=l.isLayerListPanel,h.moveSupported=u,h.layers=new de,h.forceCopy=!1,h.layoutSpec=l.layoutSpec,u?l.layers.forEach((g,v)=>{h.layers.set(g,v)}):l.layers.forEach((g,v)=>{(i||!e.layerManager.has(g))&&h.layers.set(g.addRef(),v)}),h}const c=ku(n);if(c!==void 0)try{const u=We(c.parameters,(g,v)=>{const y=X(g,"name",ke);let C=X(g,"visible",oo);const S=new vy(y,e);return a&&(C=!1),S.visible=C,S.archived=a,[S,v]}),h=new Y1;return h.numSourceLayers=u.length,h.targetIsLayerListPanel=a,h.sourceIsLayerListPanel=!1,h.sourceManager=void 0,h.moveSupported=!1,h.forceCopy=l!==void 0,h.manager=e,h.dragType=c.dragType,h.layers=new de(u),h}catch{}}function nm(n,e){return n.moveSupported?!1:(n.manager.layerManager.filter(t=>!n.layers.has(t)),e!==void 0&&n.layers.has(e))}function Lh(n,e,t,r=!1){function i(s,a){let l=n.dropLayers;var c=a?SI(s,n.manager,r,!1):{dropEffect:em(),dropEffectMessage:""};const u=c.dropEffect,h=c.dropEffectMessage;if(u===void 0)return;fy(s,u);let g=!0;if(!(l!==void 0&&!l.compatibleWithMethod(u)&&(n.dropLayers=void 0,nm(l,t)))){if(l===void 0){if(l=n.dropLayers=tm(s,n.manager,{forceCopy:u==="copy",newTarget:!1,isLayerListPanel:r}),l===void 0)return;g=l.method==="move"}if(t!==void 0&&l.layers.has(t))return{dropLayers:l,dropEffect:u,dropEffectMessage:h};if(g){const v=n.manager.layerManager,y=new ze;let C=Number.POSITIVE_INFINITY;const S=v.managedLayers=v.managedLayers.filter((E,k)=>l.layers.has(E)?(C===Number.POSITIVE_INFINITY&&(C=k),y.add(E),!1):!0);let w;t!==void 0?(w=S.indexOf(t),C<=w&&++w):w=S.length;for(const E of l.layers.keys())y.has(E)||l.layers.delete(E);S.splice(w,0,...l.layers.keys()),v.layersChanged.dispatch()}else{let v;t!==void 0&&(v=n.manager.layerManager.managedLayers.indexOf(t));for(const y of l.layers.keys())n.manager.add(y,v)}return{dropLayers:l,dropEffect:u,dropEffectMessage:h}}}e.addEventListener("dragenter",s=>{i(s,!0)!==void 0?s.preventDefault():fn(n.element,"drop")}),e.addEventListener("drop",s=>{var a;s.preventDefault(),n.dragEnterCount=0,fn(n.element,"drop");const l=(a=i(s,!1))===null||a===void 0?void 0:a.dropLayers;if(n.dropLayers=void 0,l!==void 0){if(!l.initializeExternalLayers(s)){nm(l);return}l.updateArchiveStates(s),kh(l.method==="move"?void 0:s.dataTransfer.dropEffect)}}),e.addEventListener("dragover",s=>{const a=i(s,!0);if(a===void 0){fn(n.element,"drop");return}const l=a.dropLayers,c=a.dropEffect,u=a.dropEffectMessage,h=l.layers.size;let g="";const v=l.numSourceLayers===1?"":"s",y=l.numSourceLayers;if(c==="none")g=`Cannot link dragged layer${v} here`;else{const C=y===h?`${y}`:`${h}/${y}`;g=`Drop to ${c} ${C} layer${v}`}u&&(g+=` (${u})`),Xr(n.element,"drop",g),s.preventDefault(),s.stopPropagation()})}function CI(n,e,t,r){e.draggable=!0,e.addEventListener("dragstart",i=>{Xr(e,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),yI(i,{manager:n.manager,layers:[t],layoutSpec:r.getLayoutSpec(),isLayerListPanel:r.isLayerListPanel}),i.stopPropagation()}),e.addEventListener("dragend",()=>{fn(e,"drag"),kh()})}function xI(n){n.element.addEventListener("dragenter",()=>{++n.dragEnterCount}),n.element.addEventListener("dragleave",()=>{if(--n.dragEnterCount!==0)return;fn(n.element,"drop");const e=n.dropLayers;e!==void 0&&(nm(e),n.manager.layerManager.layersChanged.dispatch(),n.dropLayers=void 0)})}const fz="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='binIconTitle'%3e%3ctitle%20id='binIconTitle'%3eBin%3c/title%3e%3cpath%20d='M19%206L5%206M14%205L10%205M6%2010L6%2020C6%2020.6666667%206.33333333%2021%207%2021%207.66666667%2021%2011%2021%2017%2021%2017.6666667%2021%2018%2020.6666667%2018%2020%2018%2019.3333333%2018%2016%2018%2010'/%3e%3c/svg%3e";function hs(n={}){const e=ft(j({svg:fz},n)),t=e.firstElementChild;return t&&(t.style.fill="white"),e}var X1={},K1;function gz(){if(K1)return X1;K1=1;var n=Ot(),e=Ym(),t=qu();return n(n.S,"String",{raw:function(r){for(var i=e(r.raw),s=t(i.length),a=arguments.length,l=[],c=0;s>c;)l.push(String(i[c++])),c<a&&l.push(String(arguments[c]));return l.join("")}}),X1}var Z1,Q1;function mz(){return Q1||(Q1=1,gz(),Z1=ut().String.raw),Z1}var eE,tE;function vz(){return tE||(tE=1,eE={default:mz(),__esModule:!0}),eE}var yz=vz();const Vl=Qe(yz),qc="neuroglancer-position",nE=at.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),bz=[n=>n.nameElement,n=>n.coordinate,n=>n.scaleElement];function Jc(n,e){const t=n.coordinateArrays[e];return t===void 0?t:n.units[e]!=""||n.scales[e]!==1?null:t}let wz=class{constructor(n,e){this.coordinateSpace=n,this.container=document.createElement("div"),this.nameContainer=document.createElement("span"),this.nameElement=document.createElement("input"),this.scaleContainer=document.createElement("span"),this.scaleElement=document.createElement("input"),this.coordinate=document.createElement("input"),this.coordinateLabel=document.createElement("span"),this.coordinateLabelWidth=0,this.dropdownOwner=void 0,this.modified=!1,this.draggingPosition=!1,this.hasFocus=!1;const t=this.container,r=this.scaleElement,i=this.scaleContainer,s=this.coordinate,a=this.nameElement,l=this.nameContainer,c=this.coordinateLabel;t.title="",t.classList.add("neuroglancer-position-dimension"),t.draggable=!0,t.tabIndex=-1,t.appendChild(l),t.appendChild(r),l.appendChild(a),l.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",i.appendChild(r),a.classList.add("neuroglancer-position-dimension-name"),a.disabled=!0,a.spellcheck=!1,a.autocomplete="off",a.required=!0,a.placeholder=" ",i.classList.add("neuroglancer-position-dimension-scale-container"),r.classList.add("neuroglancer-position-dimension-scale"),r.disabled=!0,r.spellcheck=!1,r.autocomplete="off",t.appendChild(i),t.appendChild(s),s.type="text",s.classList.add("neuroglancer-position-dimension-coordinate"),s.spellcheck=!1,s.autocomplete="off",s.pattern=Vl`(-?\d+(?:\.(?:\d+)?)?)`;const u=Jc(n,e);if(u!=null){let h=0;for(const g of u.labels)h=Math.max(h,g.length);this.coordinateLabelWidth=h,c.style.width=`${h+2}ch`,t.appendChild(c)}s.required=!0,s.placeholder=" ",c.classList.add("neuroglancer-position-dimension-coordinate-label")}};function rm(n,e,t,r){return Math.floor((n-e)*(r-1)/(t-e))}function Sz(n,e,t){const r=n.boundingBoxes,i=n.bounds,s=Math.floor(i.lowerBounds[e]),a=Math.ceil(i.upperBounds[e]-1);if(!gt(s)||!gt(a))return;const l=[],c=h=>rm(h,s,a,t),u=n.rank;for(const h of r){const g=Rk(h,e,u);g!==void 0&&(g.lower=c(g.lower),g.upper=c(Math.ceil(g.upper-1)),l.push(g))}return l.sort((h,g)=>{const v=h.lower-g.lower;return v!==0?v:g.upper-g.upper}),zT(l,(h,g)=>{if(g===0)return!0;const v=l[g-1];return v.lower!==h.lower||v.upper!==h.upper}),{lowerBound:s,upperBound:a,normalizedBounds:l}}const im=10,sm=15,Cz=10,Gf=im+sm+Cz;function xz(n,e,t){e.clearRect(0,0,n.width,n.height);const r=t.normalizedBounds;function i(l){e.fillRect(0,l,im,1)}e.fillStyle="#fff";for(const l of r){const c=l.lower,u=l.upper;i(c),i(u)}const s=r.length;e.fillStyle="#ccc";for(let l=0;l<s;++l){var a=r[l];const c=a.lower,u=a.upper,h=Math.floor(l*sm/s),g=Math.max(1,sm/s);e.fillRect(h+im,c,g,u+1-c)}}function rE(n,e){_n(n,e.length+1)}function iE(n){const e=n.value;_n(n),n.parentElement.dataset.isEmpty=e===""?"true":"false"}class Ih extends K{constructor(e,t,{copyButton:r=!0}={}){super(),this.position=e,this.combiner=t,this.element=document.createElement("div"),this.dimensionContainer=document.createElement("div"),this.coordinateSpace=void 0,this.dimensionWidgets=new de,this.dimensionWidgetList=[],this.dragSource=void 0;const i=this.element,s=this.dimensionContainer;if(this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable(ct(()=>this.updateDimensions())))),i.className="neuroglancer-position-widget",s.style.display="contents",i.appendChild(s),r){const l=Zr({title:"Copy position to clipboard",onClick:()=>{const c=Yn(this.getPositionText());Ke.showTemporaryMessage(c?"Position copied to clipboard":"Failed to copy position to clipboard")}});l.addEventListener("dragstart",c=>{c.dataTransfer.setData(qc,ie({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),c.dataTransfer.setData("text",this.getPositionText()),c.stopPropagation()}),l.draggable=!0,i.appendChild(l)}this.registerDisposer(e.changed.add(this.registerCancellable(ct(()=>this.updateView()))));const a=this.registerDisposer(new Nr(i,nE));a.allShortcutsAreGlobal=!0,this.registerDisposer(new Bi(i,nE)),this.registerDisposer(ve(i,"cancel",l=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();const c=l.target;c instanceof HTMLElement&&c.blur()})),this.updateView()}openRegularDropdown(e,t){t.classList.add("neuroglancer-position-dimension-dropdown");const r=document.createElement("canvas"),i=r.getContext("2d"),s=document.createElement("div"),a=document.createElement("div");a.appendChild(s);const l=document.createTextNode("");s.appendChild(l);const c=document.createElement("div"),u=document.createElement("div");a.classList.add("neuroglancer-position-dimension-dropdown-lowerbound"),c.classList.add("neuroglancer-position-dimension-dropdown-upperbound"),u.classList.add("neuroglancer-position-dimension-dropdown-hoverposition"),t.appendChild(a),t.appendChild(c),t.appendChild(u),t.appendChild(r);const h=100;r.width=Gf,r.height=h,c.style.marginTop=`${h-1}px`;let g,v,y;const C=()=>{const P=this.dimensionWidgetList.indexOf(e);if(P===-1)return;const D=e.coordinateSpace,L=Sz(D,P,h);if(L===void 0||D.bounds.lowerBounds[P]+1===D.bounds.upperBounds[P]){t.style.display="none",e.container.dataset.dropdownVisible=void 0;return}e.container.dataset.dropdownVisible="true",t.style.display="";const R=L.lowerBound,M=L.upperBound;g=R,v=M,l.textContent=R.toString(),c.textContent=M.toString(),xz(r,i,L);const V=this.position.value[P];if(V>=R&&V<=M&&(i.fillStyle="#f66",i.fillRect(0,rm(V,R,M,h),Gf,1)),y!==void 0&&y>=R&&y<=M){i.fillStyle="#66f";const B=rm(y,R,M,h);i.fillRect(0,B,Gf,1),u.textContent=y.toString();const _=s.clientHeight;s.style.visibility=B>_?"":"hidden",c.style.visibility=B<h-_?"":"hidden",u.style.display="",u.style.visibility="visible",u.style.marginTop=`${B}px`}else s.style.visibility="",u.style.display="none",c.style.visibility=""},S=e.dropdownOwner,w=S.registerCancellable(ct(C));S.registerDisposer(this.position.changed.add(w));const E=P=>{if(g===void 0||v===void 0)return;const D=r.getBoundingClientRect();let L=(P.clientY-D.top)/D.height;return L=Math.max(0,L),L=Math.min(1,L),Math.round(L*(v-g))+g},k=P=>{const D=this.dimensionWidgetList.indexOf(e);if(D===-1)return;const L=E(P);if(L===void 0)return;const R=this.position,M=R.value;M[D]=L+.5,e.modified=!1,R.value=M};r.addEventListener("pointermove",P=>{y=E(P),w()}),r.addEventListener("pointerleave",()=>{y=void 0,w()}),r.addEventListener("pointerdown",P=>{P.preventDefault(),P.stopPropagation(),!(P.ctrlKey||P.altKey||P.shiftKey||P.metaKey)&&(Rr(P,D=>{e.dropdownOwner!==void 0&&(y=void 0,k(D),w(),e.draggingPosition=!0)},()=>{e.draggingPosition=!1,this.updateDropdownVisibility(e)}),k(P))}),C()}openCoordinateArrayDropdown(e,t,r){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");const i=r.coordinates,s=r.labels,a=i.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let l=0;l<a;++l){const c=document.createElement("div");c.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");const u=document.createElement("div");u.classList.add("neuroglancer-dimension-dropdown-coordinate");const h=document.createElement("div");h.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),h.textContent=s[l],u.textContent=i[l].toString(),c.appendChild(u),c.appendChild(h),c.addEventListener("click",()=>{const g=this.dimensionWidgetList.indexOf(e);if(g===-1)return;const v=this.position,y=v.value;y[g]=i[l]+.5,e.modified=!1,v.value=y}),t.appendChild(c)}}openDropdown(e){if(e.dropdownOwner!==void 0)return;const t=this.dimensionWidgetList.indexOf(e);if(t===-1)return;this.closeDropdown();const r=e.dropdownOwner=new K,i=document.createElement("div");i.draggable=!0,i.addEventListener("dragstart",a=>{a.stopPropagation(),a.preventDefault()}),i.addEventListener("pointerenter",()=>{e.hasFocus=!0}),i.tabIndex=-1,e.container.appendChild(i);const s=Jc(e.coordinateSpace,t);s==null?this.openRegularDropdown(e,i):this.openCoordinateArrayDropdown(e,i,s),this.widgetWithOpenDropdown=e,r.registerDisposer(()=>{Et(i),e.dropdownOwner=void 0,delete e.container.dataset.dropdownVisible,this.widgetWithOpenDropdown=void 0}),r.registerEventListener(document,"pointerdown",a=>{const l=a.target;l instanceof Node&&e.container.contains(l)||this.closeDropdown(e)},{capture:!0})}closeDropdown(e=this.widgetWithOpenDropdown){if(e===void 0)return;const t=e.dropdownOwner;t!==void 0&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();const r=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(r===null)break;if(r[1]!==void 0&&document.execCommand("insertText",void 0,r[1]),r[2]!==void 0){const i=this.dimensionWidgetList,s=i.indexOf(e);if(s===-1||s+1===i.length)break;const a=t.substring(r[0].length);e=i[s+1],t=a;continue}break}}reorderDimensionTo(e,t){if(e===t)return;const r=this.position.coordinateSpace;r.value=Uk(r.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t){const r=new wz(e,t);r.container.addEventListener("dragstart",i=>{this.dragSource=r,i.stopPropagation(),i.dataTransfer.setData("neuroglancer-dimension","")}),r.container.addEventListener("dragenter",i=>{const s=this.dragSource;if(s===void 0||s===r)return;const a=this.dimensionWidgetList,l=a.indexOf(s),c=a.indexOf(r);l===-1||c===-1||(i.preventDefault(),this.reorderDimensionTo(c,l))}),r.container.addEventListener("dragend",i=>{this.dragSource===r&&(this.dragSource=void 0)}),r.nameContainer.addEventListener("dblclick",()=>{r.nameElement.disabled=!1,r.nameElement.focus(),r.nameElement.select()}),r.scaleContainer.addEventListener("dblclick",()=>{r.scaleElement.disabled=!1,r.scaleElement.focus(),r.scaleElement.select()}),r.coordinate.addEventListener("focus",()=>{r.coordinate.select()}),r.container.addEventListener("focusin",()=>{r.hasFocus=!0,this.updateDropdownVisibility(r)}),r.container.addEventListener("focusout",i=>{const s=i.relatedTarget;s instanceof Node&&r.container.contains(s)||(r.hasFocus=!1,this.updateDropdownVisibility(r))}),r.container.addEventListener("click",i=>{(!(i.target instanceof HTMLInputElement)||i.target.disabled)&&r.coordinate.focus()}),r.coordinate.addEventListener("paste",i=>{const s=r.coordinate,a=s.value,l=i.clipboardData;if(l===null)return;let c=l.getData("text"),u=s.selectionEnd,h=s.selectionStart;if(h!==0||u!==a.length){h==null&&(h=0),u==null&&(u=0);const g=c.match(/[^\-0-9\.]/);g!==null&&(c=c.substring(0,g.index)),c.length>0&&document.execCommand("insertText",void 0,c)}else this.pasteString(r,c);i.preventDefault(),i.stopPropagation()}),r.coordinate.addEventListener("input",()=>{r.modified=!0;const i=r.coordinate,s=i.value;let a=i.selectionDirection,l=i.selectionEnd,c=i.selectionStart;c===null&&(c=0),l===null&&(l=c);let u="";const h=/[^\-0-9\.]/g;u+=s.substring(0,c).replace(h,"");const g=u.length;u+=s.substring(c,l).replace(h,"");const v=u.length;u+=s.substring(l).replace(h,""),i.value=u,i.selectionStart=g,i.selectionEnd=v,i.selectionDirection=a,rE(i,u),l===c&&l===s.length&&s.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(r,1)}),r.nameElement.addEventListener("input",()=>{const i=r.nameElement;_n(i),this.updateNameValidity()}),r.scaleElement.addEventListener("input",()=>{const i=r.scaleElement;iE(i),this.updateScaleValidity(r)}),r.coordinate.addEventListener("blur",i=>{const s=i.relatedTarget;this.dimensionWidgetList.some(a=>a.coordinate===s)||r.modified&&this.updatePosition()}),r.nameElement.addEventListener("blur",i=>{r.nameElement.disabled=!0;const s=i.relatedTarget;this.dimensionWidgetList.some(a=>a.nameElement===s)||this.updateNames()||this.forceUpdateDimensions()}),r.scaleElement.addEventListener("blur",i=>{r.scaleElement.disabled=!0;const s=i.relatedTarget;this.dimensionWidgetList.some(a=>a.scaleElement===s)||this.updateScales()||this.forceUpdateDimensions()}),ve(r.container,"adjust-via-wheel",i=>{const s=i.detail.deltaY;s!==0&&this.adjustDimension(r,nd(s))}),ve(r.container,"adjust-up",()=>{this.adjustDimension(r,-1)}),ve(r.container,"adjust-down",()=>{this.adjustDimension(r,1)});for(const i of bz){const s=i(r);ve(s,"maybe-tab-forward",a=>{this.handleLeftRightMovement(a,r,1,i)}),ve(s,"maybe-tab-backward",a=>{this.handleLeftRightMovement(a,r,-1,i)}),ve(s,"tab-forward",()=>{this.selectAdjacentField(r,1,i)}),ve(s,"tab-backward",()=>{this.selectAdjacentField(r,-1,i)})}return ve(r.coordinate,"commit",()=>{this.updatePosition()}),ve(r.nameElement,"commit",()=>{this.updateNames()}),ve(r.scaleElement,"commit",()=>{this.updateScales()}),ve(r.coordinate,"delete-backward",i=>{i.stopPropagation();const s=r.coordinate;s.selectionStart===s.selectionEnd&&s.selectionStart===0&&(i.preventDefault(),this.selectAdjacentCoordinate(r,-1))}),r}forceUpdateDimensions(){let e=this.position.coordinateSpace.value;e.valid||(e=Pi),this.coordinateSpace=e;const t=this.dimensionWidgets,r=this.dimensionWidgetList;r.length=0;var i=e;const s=i.names,a=i.ids,l=i.scales,c=i.units;Yr(this.dimensionContainer,a.map((h,g)=>{let v=t.get(h);v===void 0?(v=this.newDimension(e,g),t.set(h,v)):v.coordinateSpace=e;const y=s[g];v.nameElement.value=y,delete v.nameElement.dataset.isValid,_n(v.nameElement);const C=Jc(e,g);C===void 0?v.container.dataset.coordinateArray="none":C===null?v.container.dataset.coordinateArray="invalid":v.container.dataset.coordinateArray="valid",v.scaleContainer.title="Drag to reorder, double click to change scale",C===null&&(v.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");var S=kk(l[g],c[g]);const w=S.scale,E=S.prefix,k=S.unit,P=`${w}${E}${k}`;return v.scaleElement.value=P,delete v.scaleElement.dataset.isValid,iE(v.scaleElement),r.push(v),v.container}));for(const h of t){var u=ae(h,2);const g=u[0],v=u[1];v.coordinateSpace!==e&&(this.closeDropdown(v),t.delete(g))}}updateDimensions(){this.position.coordinateSpace.value!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,r){const i=this.dimensionWidgetList;let s=i.indexOf(e);if(s!==-1)for(;;){if(s+=t,s<0||s>=i.length)return!1;const a=i[s],l=r(a);if(l.style.display!=="none")return l.disabled=!1,l.focus(),l.selectionStart=0,l.selectionEnd=l.value.length,l.selectionDirection=t===1?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,r=>r.coordinate)}handleLeftRightMovement(e,t,r,i){e.stopPropagation();const s=i(t);s.selectionStart!==s.selectionEnd||s.selectionStart!==(r===1?s.value.length:0)||this.selectAdjacentField(t,r,i)&&e.preventDefault()}updateNameValidity(){const e=this.dimensionWidgetList,t=e.map(s=>s.nameElement.value),r=t.length,i=this.combiner.getRenameValidity(t);for(let s=0;s<r;++s)e[s].nameElement.dataset.isValid=i[s]===!1?"false":"true"}updateScaleValidity(e){const t=Jl(e.scaleElement.value)!==void 0;e.scaleElement.dataset.isValid=t.toString()}adjustDimension(e,t){const r=this.dimensionWidgetList.indexOf(e);if(r===-1)return;this.updatePosition();const i=this.position;if(!i.valid)return;const s=i.coordinateSpace.value.bounds,a=Float32Array.from(i.value);let l=Math.floor(a[r]+t);if(t>0){const c=s.upperBounds[r];gt(c)&&(l=Math.min(l,Math.ceil(c-1)))}else{const c=s.lowerBounds[r];gt(c)&&(l=Math.max(l,Math.floor(c)))}a[r]=l+.5,this.position.value=a,this.updateView()}updatePosition(){const e=this.dimensionWidgetList,t=this.position,r=t.value;if(r===void 0)return;const i=e.length;for(let s=0;s<i;++s){const a=e[s];a.modified=!1;const l=Number(a.coordinate.value);gt(l)&&(r[s]=l+(Nn(l)?.5:0))}t.value=r}updateNames(){const e=this.dimensionWidgetList,t=this.position.coordinateSpace,r=t.value,i=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(i).includes(!1))return!1;const s=r.names;if(Oe(s,i))return!1;const a=r.timestamps.map((c,u)=>s[u]===i[u]?c:Date.now()),l=j(j({},r),{names:i,timestamps:a});return t.value=l,!0}updateScales(){const e=this.dimensionWidgetList,t=this.position.coordinateSpace,r=t.value,i=e.map(g=>Jl(g.scaleElement.value));if(i.includes(void 0))return!1;const s=Float64Array.from(i,g=>g.scale),a=Te(i,g=>g.unit),l=r.scales,c=r.units;if(Oe(l,s)&&Oe(c,a))return!1;const u=r.timestamps.map((g,v)=>s[v]===l[v]&&a[v]===c[v]?g:Date.now()),h=st({valid:r.valid,rank:r.rank,scales:s,units:a,timestamps:u,ids:r.ids,names:r.names,boundingBoxes:r.boundingBoxes,coordinateArrays:r.coordinateArrays});return t.value=h,!0}getPositionText(){const e=this.position;return e.valid?e.value.map(t=>Math.floor(t)).join(", "):""}updateView(){this.updateDimensions();const e=this.position.value,t=this.dimensionWidgetList,r=t.length;if(e===void 0)return;const i=this.coordinateSpace;for(let s=0;s<r;++s){const a=t[s],l=a.coordinate,c=Math.floor(e[s]),u=c.toString();rE(l,u),l.value=u;const h=Jc(i,s);let g="";if(h!=null){const y=h.coordinates,C=cN(y,c,(S,w)=>S-w);C!==y.length&&(g=h.labels[C])}const v=a.coordinateLabel;v.textContent=g}}disposed(){this.closeDropdown(),Et(this.element),super.disposed()}}class Ez extends K{constructor(e,t,r){super(),this.element=e,this.mouseState=t,this.coordinateSpace=r,this.tempPosition=Ne(),e.className="neuroglancer-mouse-position-widget";const i=this.registerCancellable(ct(()=>this.updateView()));this.registerDisposer(t.changed.add(i)),this.registerDisposer(r.changed.add(i))}updateView(){let e="";const t=this.mouseState,r=this.coordinateSpace.value;if(t.active&&r!==void 0){const i=t.position,s=r.rank,a=r.names;for(let l=0;l<s;++l)l!==0&&(e+="  "),e+=`${a[l]} ${Math.floor(i[l])}`}this.element.textContent=e}disposed(){Et(this.element),super.disposed()}}class Tz extends K{constructor(e,t){var r;super(),this.layer=e,this.panel=t,this.element=document.createElement("div"),this.layerNumberElement=document.createElement("div"),this.labelElement=document.createElement("div"),this.visibleProgress=document.createElement("div"),this.prefetchProgress=document.createElement("div"),this.labelElementText=document.createTextNode(""),this.valueElement=document.createElement("div"),this.maxLength=0,this.prevValueText="";const i=this.element,s=this.labelElement,a=this.layerNumberElement,l=this.valueElement,c=this.visibleProgress,u=this.prefetchProgress,h=this.labelElementText;i.className="neuroglancer-layer-item neuroglancer-noselect",i.appendChild(c),i.appendChild(u),s.className="neuroglancer-layer-item-label",s.appendChild(h),c.className="neuroglancer-layer-item-visible-progress",u.className="neuroglancer-layer-item-prefetch-progress",a.className="neuroglancer-layer-item-number",l.className="neuroglancer-layer-item-value";const g=document.createElement("div");g.className="neuroglancer-layer-item-value-container";const v=document.createElement("div");v.className="neuroglancer-layer-item-button-container";const y=Zv();y.title="Remove layer from this layer group";const C=hU();C.title="Refresh data",this.registerEventListener(C,"click",E=>{E.stopPropagation();const k=this.layer.layer;if(k&&k.dataSources&&k.dataSources[0].loadState){const P=k.dataSources[0].loadState;if(P instanceof Gv){const D=P.dataSource;if(D&&D.subsources[0]&&D.subsources[0].subsource){const L=D.subsources[0].subsource.annotation;L?.invalidateCache&&L.invalidateCache()}}}}),y.addEventListener("click",E=>{this.panel.layerManager===this.panel.manager.rootLayers?this.layer.setArchived(!0):this.layer.containers.size>2?this.panel.layerManager.removeManagedLayer(this.layer):this.layer.setArchived(!0),E.stopPropagation()});const S=hs();S.title="Delete this layer",S.addEventListener("click",E=>{Ho(this.layer),E.stopPropagation()}),i.appendChild(a),g.appendChild(l),g.appendChild(v),v.appendChild(y),v.appendChild(S),i.appendChild(s),!((r=e.layer)===null||r===void 0)&&r.allowingRefresh&&i.appendChild(C),i.appendChild(g);const w=this.registerDisposer(new Ih(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1}));i.appendChild(w.element),w.element.addEventListener("click",E=>{E.stopPropagation()}),w.element.addEventListener("dblclick",E=>{E.stopPropagation()}),i.addEventListener("click",E=>{E.ctrlKey?t.selectedLayer.toggle(e):E.altKey?e.pickEnabled=!e.pickEnabled:e.setVisible(!e.visible)}),i.addEventListener("contextmenu",E=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,E.stopPropagation(),E.preventDefault()}),CI(t,i,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),Lh(this.panel,i,this.layer)}update(){const e=this.layer,t=this.element;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let r=`Click to ${e.visible?"hide":"show"}, control+click to show side panel`;e.supportsPickOption&&(r+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),r+=", drag to move, shift+drag to copy",t.title=r}disposed(){this.element.remove(),super.disposed()}}class kz extends K{constructor(e,t,r,i,s,a){super(),this.display=e,this.manager=t,this.viewerNavigationState=r,this.selectedLayer=i,this.getLayoutSpecForDrag=s,this.showLayerHoverValues=a,this.layerWidgets=new de,this.element=document.createElement("div"),this.layerUpdateNeeded=!0,this.valueUpdateNeeded=!1,this.layerWidgetInsertionPoint=document.createElement("div"),this.positionWidget=this.registerDisposer(new Ih(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner)),this.dragEnterCount=0,this.scheduleUpdate=this.registerCancellable(ct(()=>this.update())),this.registerDisposer(i);const l=this.element;l.className="neuroglancer-layer-panel",this.registerDisposer(t.layerSelectedValues.changed.add(()=>{this.handleLayerValuesChanged()})),this.registerDisposer(t.layerManager.layersChanged.add(()=>{this.handleLayersChanged()})),this.registerDisposer(i.changed.add(()=>{this.handleLayersChanged()})),this.registerDisposer(a.changed.add(()=>{this.handleLayerItemValueChanged()})),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);let c=ft({svg:Su,title:"Click to add layer, control+click/right click/⌘+click to add local annotation layer."});c.classList.add("neuroglancer-layer-add-button");let u=this.dropZone=document.createElement("div");u.className="neuroglancer-layer-panel-drop-zone";const h=v=>{if(v.ctrlKey||v.metaKey||v.type==="contextmenu"){const y=_I(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(y),this.selectedLayer.layer=y,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(c,"click",h),this.registerEventListener(c,"contextmenu",h),l.appendChild(c),l.appendChild(u),this.registerDisposer(hz(c)),l.appendChild(this.positionWidget.element);const g=()=>{const v=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=v===Lt.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(g)),g(),this.update(),this.updateChunkStatistics(),xI(this),Lh(this,u,void 0),this.registerDisposer(e.updateStarted.add(()=>this.updateLayers())),this.registerDisposer(t.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable(ct(()=>this.updateChunkStatistics()))))}get layerManager(){return this.manager.layerManager}disposed(){this.layerWidgets.forEach(e=>e.dispose()),this.layerWidgets=void 0,Et(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){this.valueUpdateNeeded||(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),this.showLayerHoverValues.value===!1)return;let e=this.manager.layerSelectedValues;for(let r of this.layerWidgets){var t=ae(r,2);let i=t[0],s=t[1],a=i.layer,l="";if(a!==null){let c=e.get(a);if(c!==void 0){const u=c.value;u!==void 0&&(l=""+u)}}if(l!==s.prevValueText){if(s.prevValueText=l,l.length>s.maxLength){const c=s.maxLength=l.length;s.valueElement.style.width=`${c}ch`}s.valueElement.textContent=l}}}updateChunkStatistics(){for(const t of this.layerWidgets){var e=ae(t,2);const r=e[0],i=e[1];let s=0,a=0,l=0,c=0;const u=r.layer;if(u!==null)for(const h of u.renderLayers){const g=h.layerChunkProgressInfo;s+=g.numVisibleChunksNeeded,a+=g.numVisibleChunksAvailable,l+=g.numPrefetchChunksNeeded,c+=g.numPrefetchChunksAvailable}i.visibleProgress.style.width=`${a/Math.max(1,s)*100}%`,i.prefetchProgress.style.width=`${c/Math.max(1,l)*100}%`}}updateLayers(){var e;if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;let t=this.element,r=new ze,i=this.layerWidgetInsertionPoint.nextElementSibling;this.manager.rootLayers.updateNonArchivedLayerIndices();for(const l of this.manager.layerManager.managedLayers){if(l.archived&&!(!((e=this.dropLayers)===null||e===void 0)&&e.layers.has(l)))continue;r.add(l);let c=this.layerWidgets.get(l);const u=l.nonArchivedLayerIndex;c===void 0&&(c=new Tz(l,this),this.layerWidgets.set(l,c)),c.layerNumberElement.textContent=""+(1+u),c.update();var s=c;let h=s.element;h!==i&&t.insertBefore(c.element,i),i=h.nextElementSibling}for(let l of this.layerWidgets){var a=ae(l,2);let c=a[0],u=a[1];r.has(c)||(this.layerWidgets.delete(c),u.dispose())}}addLayerMenu(){HI(this.manager,this.selectedLayer)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function EI(n,e){const t=Lr(n,"drop",a=>{if(a.preventDefault(),a.dataTransfer.types.indexOf(qc)!==-1){a.stopPropagation();const l=ge(JSON.parse(a.dataTransfer.getData(qc))),c=X(l,"dimensions",yv),u=X(l,"position",y=>We(y,vt));if(u.length!==c.length)throw new Error("length mismatch between position and dimensions");const h=u.length,g=e.coordinateSpace.value.names,v=e.value;for(let y=0;y<h;++y){const C=g.indexOf(c[y]);C!==-1&&(v[C]=u[y])}e.changed.dispatch()}}),r=a=>{a.dataTransfer.types.indexOf(qc)!==-1&&(a.dataTransfer.dropEffect="link",a.preventDefault(),a.stopPropagation())},i=Lr(n,"dragenter",r),s=Lr(n,"dragover",r);return()=>{i(),s(),t()}}class TI extends K{constructor(e){super(),this.model=e,this.element=document.createElement("select"),this.valueIndexMap=new de;const t=this.element,r=this.valueIndexMap;let i=0;for(const s of Qt(e.enumType))if(isNaN(Number(s))){const a=document.createElement("option");a.textContent=a.value=s.toLowerCase(),t.appendChild(a),r.set(e.enumType[s],i),++i}this.registerDisposer(e.changed.add(()=>this.updateView())),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"wheel",s=>{s.preventDefault(),s.stopPropagation(),this.adjustViaWheel(s)}),this.updateView()}adjustViaWheel(e){const t=this.element;let r=e.deltaY;r>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):r<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){const e=this.element;e.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}}const gy="neuroglancer-layer-group-viewer";function sE(n){return n.dataTransfer.types.indexOf(gy)!==-1}let zr;function Lz(n){if(zr&&zr.viewer.layerSpecification.rootLayers===n.rootLayers)return zr.viewer}function Iz(n,e){const t=Lz(e);let r,i=!1;return t===void 0||t.layerSpecification===t.layerSpecification.root?r="copy":(i=!0,r="move"),wI(n,r,i)}class Dz extends K{constructor(e){super(),this.relativeDisplayScales=new v_(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new b_(e.navigationState.pose.displayDimensions.addRef()),this.position=new d2(e.navigationState.position.addRef()),this.crossSectionOrientation=new Ug(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new u2(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new $g(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new Wx(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new Wx(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new Co(new So(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new Ug(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new $g(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new Co(new So(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(const e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",rd(this.position)),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}}function Pz(n,e){const t=new az(n),r=t.element;r.classList.add("neuroglancer-layer-group-viewer-context-menu");const i=document.createElement("button");i.textContent="Remove layer group",r.appendChild(i),t.registerEventListener(i,"click",()=>{e.layerSpecification.layerManager.clear()});const s=e.viewerNavigationState;for(const l of[["Render scale factors",s.relativeDisplayScales.link],["Render dimensions",s.displayDimensions.link],["Position",s.position.link],["Cross-section orientation",s.crossSectionOrientation.link],["Cross-section zoom",s.crossSectionScale.link],["Cross-section depth range",s.crossSectionDepthRange.link],["3-D projection orientation",s.projectionOrientation.link],["3-D projection zoom",s.projectionScale.link],["3-D projection depth range",s.projectionDepthRange.link]]){var a=ae(l,2);const c=a[0],u=a[1],h=t.registerDisposer(new TI(u)),g=document.createElement("label");g.style.display="flex",g.style.flexDirection="row",g.style.whiteSpace="nowrap",g.textContent=c,g.appendChild(h.element),r.appendChild(g)}return t}class Lu extends K{constructor(e,t,r={}){super(),this.element=e,this.viewerState=t,this.state=new ph,this.options=j({showLayerPanel:new Ft(!0),showViewerMenu:!1,showLayerHoverValues:new Ft(!0)},r),this.layerSpecification=this.registerDisposer(t.layerSpecification),this.viewerNavigationState=this.registerDisposer(new Dz(t)),this.viewerNavigationState.register(this.state),this.layerSpecification instanceof $I?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map(i=>i.name),reset:()=>{throw new Error("not implemented")},restoreState:()=>{throw new Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new xh(e)),this.layout=this.registerDisposer(new U$(this,"xy")),this.state.add("layout",this.layout),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(EI(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable(rt(()=>this.updateUI(),0)))),this.makeUI()}get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}get changed(){return this.state.changed}bindAction(e,t){this.registerDisposer(ve(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",()=>{this.layerPanel&&this.layerPanel.addLayerMenu()}),this.bindAction("t-",()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)}),this.bindAction("t+",()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)})}toJSON(){return j({type:"viewer"},this.state.toJSON())}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),pn(e,"crossSectionZoom",rd(this.viewerNavigationState.crossSectionScale)),pn(e,"perspectiveZoom",rd(this.viewerNavigationState.projectionScale)),pn(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){const e=this.options,t=e.showLayerPanel.value;if(this.layerPanel!==void 0&&!t){this.layerPanel.dispose(),this.layerPanel=void 0;return}if(t&&this.layerPanel===void 0){const r=this.layerPanel=new kz(this.display,this.layerSpecification,this.viewerNavigationState,this.viewerState.selectedLayer.addRef(),()=>this.layout.toJSON(),this.options.showLayerHoverValues);if(e.showViewerMenu?(r.registerDisposer(Pz(r.element,this)),r.element.title="Right click for options, drag to move/copy layer group."):r.element.title="Drag to move/copy layer group.",typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS<"u"&&NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS===!0){{const s=document.createElement("button");s.textContent="Clear segments",s.title='De-select all objects ("x")',s.addEventListener("click",a=>{x2(a,a,{action:"clear-segments"})}),r.element.appendChild(s)}for(const s of["3d","xy","xz","yz"]){const a=document.createElement("button");a.textContent=s,a.title=`Switch to ${s} layout`,a.addEventListener("click",()=>{let l;this.layout.name===s?s!=="3d"?l=`${s}-3d`:l="4panel":l=s,this.layout.name=l}),r.element.appendChild(a)}}r.element.draggable=!0;const i=r.element;i.addEventListener("dragstart",s=>{Xr(r.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),yI(s,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});const a=()=>{zr&&zr.viewer===this&&(zr=void 0),this.unregisterDisposer(a)};zr={viewer:this,disposer:a},this.registerDisposer(a);const l=this.toJSON();delete l.layers,s.dataTransfer.setData(gy,ie(l)),r.element.style.backgroundColor="black",setTimeout(()=>{r.element.style.backgroundColor=""},0)}),r.element.addEventListener("dragend",()=>{fn(i,"drag"),kh(),zr!==void 0&&zr.viewer===this&&zr.disposer()}),this.element.insertBefore(i,this.element.firstChild)}}disposed(){Xe(this.element);const e=this.layerPanel;e!==void 0&&(e.dispose(),this.layerPanel=void 0),super.disposed()}}const aE=Xn("layoutComponentContainer");class Yc extends K{constructor(e,t,r){super(),this.viewer=e,this.parent=r,this.changed=new we,this.element=document.createElement("div");const i=this.element;i.style.display="flex",i.style.flex="1",i.style.position="relative",i.style.alignItems="stretch",i[aE]=this,this.setSpecification(t);const s=[],a=c=>{const u=document.createElement("div");u.className="neuroglancer-layout-split-drop-zone";let h;switch(u.style[c]="0",c){case"left":case"right":h="row",u.style.width="10px",u.style.height="100%";break;case"top":case"bottom":h="column",u.style.height="10px",u.style.width="100%";break}u.style.display="none",s.push({element:u,direction:h,orientation:c}),i.appendChild(u),LI(u,this.viewer.layerSpecification,()=>this.split(c).newContainer.component,h==="row"?"column":"row")};a("left"),a("right"),a("top"),a("bottom");let l=!1;i.addEventListener("dragenter",c=>{if(!l&&ku(c)!==void 0){l=!0;for(const u of s){const h=u.element,g=u.direction,v=u.orientation;if(r!==void 0&&g===r.direction&&((v==="left"||v==="top")&&r.get(0)!==this||(v==="bottom"||v==="right")&&r.get(r.length-1)!==this))continue;const y=this.component;y instanceof om&&y.direction===g||(h.style.display="block")}}},!0),i.addEventListener("drop",c=>{if(l){l=!1;for(const u of s){const h=u.element;h.style.display="none"}}},!0),i.addEventListener("dragleave",c=>{const u=c.relatedTarget;if(l&&!(u instanceof HTMLElement&&this.element.contains(u))){l=!1;for(const h of s){const g=h.element;g.style.display="none"}}},!0)}unsetComponent(){const e=this.componentValue;e!==void 0&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof Lu){const t=e.layerManager,r=e.registerCancellable(rt(()=>{t.managedLayers.length===0&&this.dispose()},0));e.registerDisposer(t.layersChanged.add(()=>{t.managedLayers.length===0&&r()})),r()}else if(e instanceof om){const t=e.registerCancellable(rt(()=>{const r=e.length;if(r===0&&this.parent!==void 0)this.dispose();else if(r===1){const i=e.get(0).component;let s;if(this.parent===void 0&&i instanceof Lu){s=i.layout.specification.toJSON(),i.viewerNavigationState.copyToParent();const a=i.layerManager.managedLayers,l=new ze(a),c=i.layerSpecification;c.rootLayers.filter(g=>l.has(g)||g.archived);const u=[],h=c.rootLayers.managedLayers;for(let g=0,v=h.length;g<v;++g)l.has(h[g])&&u.push(g);for(let g=0,v=a.length;g<v;++g)h[u[g]]=a[g];c.rootLayers.layersChanged.dispatch()}else s=i.toJSON();this.setSpecification(s)}},0));e.registerDisposer(e.changed.add(()=>{e.length<2&&t()})),t()}this.changed.dispatch()}toJSON(){return this.component.toJSON()}setSpecification(e){this.setComponent(Rz(this,e))}static getFromElement(e){return e[aE]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){const t={type:"viewer"},r=this.parent;if(r!==void 0){if(e==="left"&&r.direction==="row"||e==="top"&&r.direction==="column")return{newContainer:r.insertChild(t,this),existingContainer:this};if(e==="right"&&r.direction==="row"||e==="bottom"&&r.direction==="column")return{newContainer:r.insertChild(t),existingContainer:this}}let i;const s=this.component;s instanceof am?i=s.layerGroupViewer.toJSON():i=s.toJSON();let a,l;const c=e==="left"||e==="right"?"row":"column";switch(e){case"left":case"top":a={type:c,children:[t,i]},l=0;break;case"right":case"bottom":a={type:c,children:[i,t]},l=1;break}this.setSpecification(a);const u=this.component;return{newContainer:u.get(l),existingContainer:u.get(1-l)}}}function kI(n){return{mouseState:n.mouseState,showAxisLines:n.showAxisLines,wireFrame:n.wireFrame,showScaleBar:n.showScaleBar,scaleBarOptions:n.scaleBarOptions,showPerspectiveSliceViews:n.showPerspectiveSliceViews,inputEventBindings:n.inputEventBindings,visibility:n.visibility,selectedLayer:n.selectedLayer,visibleLayerRoles:n.visibleLayerRoles,navigationState:n.navigationState.addRef(),perspectiveNavigationState:n.perspectiveNavigationState.addRef(),crossSectionBackgroundColor:n.crossSectionBackgroundColor,perspectiveViewBackgroundColor:n.perspectiveViewBackgroundColor}}class am extends K{constructor(e,t,r){super(),this.element=e,this.layerGroupViewer=this.registerDisposer(new Lu(e,j({display:r.display,layerSpecification:r.layerSpecification.addRef()},kI(r)),{showLayerPanel:r.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:r.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}}function LI(n,e,t,r){n.addEventListener("dragenter",i=>{ku(i)!==void 0&&n.classList.add("neuroglancer-drag-over")}),n.addEventListener("dragleave",()=>{fn(n,"drop"),n.classList.remove("neuroglancer-drag-over")}),n.addEventListener("dragover",i=>{const s=(a,l)=>{a.dropEffectMessage&&(l+=` (${a.dropEffectMessage})`),Xr(n,"drop",l),i.stopPropagation(),i.preventDefault()};if(sE(i)){const a=Iz(i,e);fy(i,a.dropEffect),s(a,`Drop to ${a.dropEffect} layer group as new ${r}`);return}if(ku(i)!==void 0){const a=pz(i,e,!1,!0);s(a,`Drop to ${a.dropEffect} layer as new ${r}`);return}}),n.addEventListener("drop",i=>{n.classList.remove("neuroglancer-drag-over"),fn(n,"drop");let s,a;if(sE(i)){i.stopPropagation();try{a=JSON.parse(i.dataTransfer.getData(gy))}catch{return}if(s=tm(i,e,{forceCopy:!1,newTarget:!0}),s===void 0)return}else{if(s=tm(i,e,{forceCopy:em()==="copy",newTarget:!0}),s===void 0)return;a=s.layoutSpec}if(!s.initializeExternalLayers(i)){if(!s.moveSupported)for(const u of s.layers.keys())u.dispose();return}i.preventDefault();const l=i.dataTransfer.dropEffect=em();kh(l);const c=t();s.updateArchiveStates(i);for(const u of s.layers.keys())c.layerSpecification.add(u);try{c.restoreState(a)}catch{c.layout.reset()}})}class om extends K{constructor(e,t,r,i){super(),this.element=e,this.direction=t,this.container=i,this.changed=new we,e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this));for(const s of r)this.insertChild(s)}get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){const t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",LI(t,this.viewer.layerSpecification,()=>{const r=t.nextElementSibling;let i;return r!==null&&(i=Yc.getFromElement(r)),this.insertChild({type:"viewer",layers:[]},i).component},this.direction==="row"?"column":"row"),e.registerDisposer(()=>{Et(t)}),t}get viewer(){return this.container.viewer}get(e){return Yc.getFromElement(this.element.children[e*2+1])}insertChild(e,t){const r=new Yc(this.viewer,e,this),i=this.makeDropPlaceholder(r);r.element.classList.add("neuroglancer-stack-layout-child"),r.registerDisposer(r.changed.add(this.changed.dispatch)),r.registerDisposer(()=>{this.element.removeChild(r.element),this.changed.dispatch()});const s=t!==void 0?t.element:null;return this.element.insertBefore(r.element,s),this.element.insertBefore(i,s),this.changed.dispatch(),r}disposed(){this.clear(),super.disposed()}clear(){for(;this.length!==0;)this.get(0).dispose()}*[An](){const e=this.length;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:Te(this).map(e=>e.toJSON())}}}function Rz(n,e){const t=document.createElement("div");if(t.style.flex="1",t.style.width="0px",typeof e=="string"){if(n.parent!==void 0)throw new Error(`Invalid layout component specification: ${ie(e)}`);return new am(t,e,n.viewer)}ge(e);const r=X(e,"type",ke);switch(r){case"row":case"column":return new om(t,r,X(e,"children",i=>{const s=We(i,a=>a);if(n.parent===void 0&&s.length===0)throw new Error("Stack layout requires at least one child.");return s}),n);case"viewer":{const i=n.viewer,s=new $I(i.layerSpecification.addRef()),a=new Lu(t,j({display:i.display,layerSpecification:s},kI(i)),{showLayerPanel:i.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:i.uiControlVisibility.showLayerHoverValues});try{a.restoreState(e)}catch(l){throw a.dispose(),l}return a}default:return new am(t,e,n.viewer)}}class Mz extends K{constructor(e,t){super(),this.viewer=e,this.defaultSpecification=t,this.container=this.registerDisposer(new Yc(this.viewer,this.defaultSpecification,void 0))}get changed(){return this.container.changed}get element(){return this.container.element}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let lm=0;const Az=at.fromObject({escape:{action:"close"}});class Dh extends K{constructor(){super(),this.keyMap=new at,this.keyMap.addParent(Az,Number.NEGATIVE_INFINITY),++lm;let e=this.container=document.createElement("div");e.className="overlay";let t=this.content=document.createElement("div");this.registerDisposer(new xh(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new Nr(this.container,this.keyMap)),this.registerEventListener(e,"action:close",()=>{this.dispose()}),t.focus()}disposed(){--lm,document.body.removeChild(this.container),super.disposed()}}const Nz="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20xmlns='http://www.w3.org/2000/svg'%20aria-labelledby='eyeCrossedIconTitle'%3e%3ctitle%20id='eyeCrossedIconTitle'%3eHidden%20(crossed%20eye)%3c/title%3e%3cpath%20d='M22%2012C22%2012%2019%2018%2012%2018C5%2018%202%2012%202%2012C2%2012%205%206%2012%206C19%206%2022%2012%2022%2012Z'/%3e%3ccircle%20cx='12'%20cy='12'%20r='3'/%3e%3cpath%20d='M3%2021L20%204'/%3e%3c/svg%3e",Vz="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20xmlns='http://www.w3.org/2000/svg'%20aria-labelledby='eyeIconTitle'%3e%3ctitle%20id='eyeIconTitle'%3eVisible%20(eye)%3c/title%3e%3cpath%20d='M22%2012C22%2012%2019%2018%2012%2018C5%2018%202%2012%202%2012C2%2012%205%206%2012%206C19%206%2022%2012%2022%2012Z'/%3e%3ccircle%20cx='12'%20cy='12'%20r='3'/%3e%3c/svg%3e",Oz="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='cursorIconTitle'%3e%3ctitle%20id='cursorIconTitle'%3eCursor%3c/title%3e%3cpolygon%20points='7%2020%207%204%2019%2016%2012%2016%207%2021'/%3e%3c/svg%3e",Bz=at.fromObject({escape:{action:"cancel"}});class II extends K{constructor(e){super(),this.layer=e,this.element=document.createElement("input");const t=this.element;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off";const r=this.registerDisposer(new Nr(t,Bz));r.allShortcutsAreGlobal=!0,ve(t,"cancel",i=>{this.updateView(),t.blur(),i.stopPropagation(),i.preventDefault()}),t.title="Rename layer",this.registerDisposer(e.layerChanged.add(()=>this.updateView())),t.addEventListener("change",()=>this.updateModel()),t.addEventListener("blur",()=>this.updateModel()),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){WI(this.layer,this.element.value)}}class Fz extends K{constructor(e){super(),this.layer=e,this.element=document.createElement("select"),this.measureElement=document.createElement("div");const t=this.element,r=this.measureElement;t.classList.add("neuroglancer-layer-side-panel-type"),r.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(r);for(const s of Du){var i=ae(s,2);const a=i[0],l=i[1];if(l.type!==a)continue;const c=document.createElement("option");c.textContent=l.typeAbbreviation,c.value=a,t.appendChild(c)}t.addEventListener("change",()=>{const s=t.value,a=Du.get(s);wy(this.layer.managedLayer,a)}),this.updateView()}updateView(){const e=this.layer.type,t=this.element,r=this.measureElement;r.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${r.offsetWidth}px`}disposed(){this.measureElement.remove()}}class Iu extends da{constructor(e,t){super(e,t.location),this.panelState=t;const r=this.layer=t.layer,i=this.element;var s=this.addTitleBar({});const a=s.titleBar;a.classList.add("neuroglancer-layer-side-panel-title"),a.appendChild(this.registerDisposer(new Fz(r)).element),a.appendChild(this.registerDisposer(new II(r.managedLayer)).element),this.registerDisposer(ki(u=>{i.dataset.neuroglancerLayerVisible=u.toString()},{get value(){return r.managedLayer.visible},changed:r.managedLayer.layerChanged}));const l=this.registerDisposer(new Gr({get value(){return r.managedLayer.pickEnabled},set value(u){r.managedLayer.pickEnabled=u},changed:r.managedLayer.layerChanged},{svg:Oz,enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new tr({get value(){return r.managedLayer.supportsPickOption},changed:r.managedLayer.layerChanged},l.element)),a.appendChild(l.element);const c={get value(){return t!==r.panels.panels[0]},set value(u){u?t.pin():t.unpin()},changed:r.manager.root.layerManager.layersChanged};a.appendChild(this.registerDisposer(new Gr(c,{text:"📌︎",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer(ki(u=>{i.dataset.neuroglancerLayerPanelPinned=u.toString()},c)),a.appendChild(hs({title:"Delete layer",onClick:()=>{Ho(this.layer.managedLayer)}})),this.tabView=new w4({makeTab:u=>r.tabs.options.get(u).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new YT({get value(){return t.tabs.map(u=>({id:u,label:r.tabs.options.get(u).label}))},changed:t.tabsChanged})),handleTabElement:(u,h)=>{h.draggable=!0,h.addEventListener("dragstart",g=>{g.stopPropagation(),g.dataTransfer.setData("neuroglancer-side-panel","");let v="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find(y=>y!==t&&y.location.visible)&&(v+=`, or move tab to other ${ie(r.managedLayer.name)} panel`),Xr(h,"drag",v),this.sidePanelManager.startDrag({dropAsNewPanel:y=>{this.panelState.splitOffTab(u,j(j({},J2),y))},canDropAsTabs:y=>y instanceof Iu&&y.layer===this.layer&&y!==this?1:0,dropAsTab:y=>{this.panelState.moveTabTo(u,y.panelState)}},g)}),h.addEventListener("dragend",g=>{fn(h,"drag"),this.sidePanelManager.endDrag()})}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add(()=>{t.tabs.length===0&&(this.location.visible=!1)}))}makeDragSource(){return j(j({},super.makeDragSource()),{canDropAsTabs:e=>e instanceof Iu&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}})}makeTabDropZone(){const e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",t=>{var r;const i=this.sidePanelManager.dragSource,s=(r=i?.canDropAsTabs)===null||r===void 0?void 0:r.call(i,this);s&&(e.classList.add(ro),Xr(e,"drop",`Move ${s} ${s===1?"tab":"tabs"} to this panel`),t.preventDefault())}),e.addEventListener("dragleave",()=>{fn(e,"drop"),e.classList.remove(ro)}),e.addEventListener("dragover",t=>{var r;const i=this.sidePanelManager.dragSource;!((r=i?.canDropAsTabs)===null||r===void 0)&&r.call(i,this)&&t.preventDefault()}),e.addEventListener("drop",t=>{var r;fn(e,"drop");const i=this.sidePanelManager.dragSource;!((r=i?.canDropAsTabs)===null||r===void 0)&&r.call(i,this)&&(e.classList.remove(ro),i.dropAsTab(this),t.preventDefault(),t.stopPropagation())}),e}}class _z extends K{constructor(e,t){super(),this.sidePanelManager=e,this.selectedLayerState=t,this.layerSidePanels=new de,this.generation=0,this.layersNeedUpdate=!0;const r=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(r)),this.registerDisposer(t.layerManager.layersChanged.add(r)),this.registerDisposer(e.beforeRender.add(()=>this.update()))}getSelectedUserLayer(){var e,t;return(t=(e=this.selectedLayerState.layer)===null||e===void 0?void 0:e.layer)!==null&&t!==void 0?t:void 0}update(){var e;if(!this.layersNeedUpdate)return;const t=this.selectedLayerState.layerManager;let r=++this.generation;this.layersNeedUpdate=!1;const i=this.layerSidePanels,s=l=>{let c=i.get(l);c===void 0?(c={generation:r,unregister:this.sidePanelManager.registerPanel({location:l.location,makePanel:()=>new Iu(this.sidePanelManager,l)})},i.set(l,c)):c.generation=r};{const l=this.getSelectedUserLayer(),c=this.selectedLayerState.location;if(l===void 0||!c.visible)this.placeholderSelectedLayerPanel===void 0&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:c,makePanel:()=>new da(this.sidePanelManager,c)}));else{(e=this.placeholderSelectedLayerPanel)===null||e===void 0||e.call(this),this.placeholderSelectedLayerPanel=void 0;const u=l.panels.panels[0];u.location.value=c.value,s(u)}}for(const l of t.managedLayers){const c=l.layer;if(c===null)continue;const u=c.panels.panels;for(let h=1,g=u.length;h<g;++h)s(u[h])}for(const l of i){var a=ae(l,2);const c=a[0],u=a[1];u.generation!==r&&(u.unregister(),i.delete(c))}}disposed(){var e;(e=this.placeholderSelectedLayerPanel)===null||e===void 0||e.call(this);for(const t of this.layerSidePanels.values()){const r=t.unregister;r()}}}const Uz=j(j({},la),{side:"left",row:0});class $z{constructor(){this.location=new Ls(Uz)}get changed(){return this.location.changed}restoreState(e){e!==void 0&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return No(this.location.toJSON())}}class zz extends K{constructor(e){super(),this.layer=e,this.element=document.createElement("div");const t=this.element,r=ft({svg:Vz,title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),i=ft({svg:Nz,title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});t.appendChild(i),t.appendChild(r);const s=()=>{const a=this.layer.visible;r.style.display=a?"":"none",i.style.display=a?"none":""};s(),this.registerDisposer(e.layerChanged.add(s))}}function Gz(n){const e=n.manager.root.selectedLayer,t=new Gr({get value(){return e.layer===n&&e.visible},set value(r){r?(e.layer=n,e.visible=!0):e.visible=!1},changed:e.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:Q2});return t.element.classList.add("neuroglancer-layer-list-panel-item-controls"),t}class Wz extends K{constructor(e,t){super(),this.panel=e,this.layer=t,this.element=document.createElement("div"),this.numberElement=document.createElement("div"),this.generation=-1;const r=this.element,i=this.numberElement;r.classList.add("neuroglancer-layer-list-panel-item"),i.classList.add("neuroglancer-layer-list-panel-item-number"),r.appendChild(this.registerDisposer(new Ts({get value(){return!t.archived},set value(a){t.setArchived(!a)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),r.appendChild(i),r.appendChild(this.registerDisposer(new zz(t)).element),r.appendChild(this.registerDisposer(new II(t)).element),r.appendChild(this.registerDisposer(Gz(t)).element);const s=hs({title:"Delete layer",onClick:()=>{Ho(this.layer)}});s.classList.add("neuroglancer-layer-list-panel-item-delete"),r.appendChild(s),CI(e,r,t,{isLayerListPanel:!0,getLayoutSpec:()=>{}}),Lh(e,r,t,!0),r.addEventListener("click",a=>{a.ctrlKey?(e.selectedLayer.toggle(t),a.preventDefault()):a.altKey&&(t.pickEnabled=!t.pickEnabled,a.preventDefault())}),r.addEventListener("contextmenu",a=>{e.selectedLayer.toggle(t),a.stopPropagation(),a.preventDefault()})}}class jz extends da{constructor(e,t,r){super(e,r.location),this.manager=t,this.state=r,this.items=new de,this.itemContainer=document.createElement("div"),this.layerDropZone=document.createElement("div"),this.dragEnterCount=0,this.generation=-1;const i=this.itemContainer,s=this.layerDropZone;var a=this.addTitleBar({title:""});const l=a.titleElement;this.titleElement=l,i.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(i),s.style.flex="1";const c=this.registerCancellable(ct(()=>this.render()));this.visibility.changed.add(c),this.registerDisposer(this.layerManager.layersChanged.add(c)),this.registerDisposer(this.selectedLayer.changed.add(c)),xI(this),Lh(this,s,void 0,!0),this.render()}get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}render(){const e=this,t=this.selectedLayer.layer,r=++this.generation;let i=0,s=0,a=0;this.layerManager.updateNonArchivedLayerIndices();function*l(){const u=e.items;let h=0;for(const y of e.layerManager.managedLayers)y.archived||++h;const g=`${(h+1).toString().length}ch`;for(const y of e.layerManager.managedLayers){y.visible?++i:y.archived?++a:++s;let C=u.get(y);C===void 0&&(C=e.registerDisposer(new Wz(e,y)),u.set(y,C)),C.generation=r;const S=y.nonArchivedLayerIndex;C.numberElement.style.width=g,S===-1?C.numberElement.style.visibility="hidden":(C.numberElement.style.visibility="",C.numberElement.textContent=`${S+1}`),C.element.dataset.selected=(y===t).toString(),C.element.dataset.archived=y.archived.toString(),yield C.element}for(const y of u){var v=ae(y,2);const C=v[0],S=v[1];r!==S.generation&&(u.delete(C),e.unregisterDisposer(S),S.dispose())}yield e.layerDropZone}Yr(this.itemContainer,l());let c="Layers";if(i||s||a){c+=" (";let u="";i+s&&(c+=`${i}/${s+i} visible`,u=", "),a&&(c+=`${u}${a} archived`),c+=")"}this.titleElement.textContent=c}}class Hz extends K{constructor(e){super(),this.layerManager=e,this.element=document.createElement("div");const t=this.registerCancellable(ct(()=>this.render()));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0;const t=this.layerManager.managedLayers;for(const i of t)i.archived&&++e;const r=this.element;if(e!==0){const i=t.length;r.textContent=`${i-e}/${i}`}else r.textContent=""}}var qz={exports:{}},dm={exports:{}},Jz=dm.exports,oE;function Go(){return oE||(oE=1,(function(n,e){(function(t,r){n.exports=r()})(Jz,function(){var t=navigator.userAgent,r=navigator.platform,i=/gecko\/\d/i.test(t),s=/MSIE \d/.test(t),a=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(t),l=/Edge\/(\d+)/.exec(t),c=s||a||l,u=c&&(s?document.documentMode||6:+(l||a)[1]),h=!l&&/WebKit\//.test(t),g=h&&/Qt\/\d+\.\d+/.test(t),v=!l&&/Chrome\/(\d+)/.exec(t),y=v&&+v[1],C=/Opera\//.test(t),S=/Apple Computer/.test(navigator.vendor),w=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(t),E=/PhantomJS/.test(t),k=S&&(/Mobile\/\w+/.test(t)||navigator.maxTouchPoints>2),P=/Android/.test(t),D=k||P||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(t),L=k||/Mac/.test(r),R=/\bCrOS\b/.test(t),M=/win/i.test(r),V=C&&t.match(/Version\/(\d*\.\d*)/);V&&(V=Number(V[1])),V&&V>=15&&(C=!1,h=!0);var B=L&&(g||C&&(V==null||V<12.11)),_=i||c&&u>=9;function H(o){return new RegExp("(^|\\s)"+o+"(?:$|\\s)\\s*")}var U=function(o,d){var f=o.className,p=H(d).exec(f);if(p){var m=f.slice(p.index+p[0].length);o.className=f.slice(0,p.index)+(m?p[1]+m:"")}};function O(o){for(var d=o.childNodes.length;d>0;--d)o.removeChild(o.firstChild);return o}function z(o,d){return O(o).appendChild(d)}function F(o,d,f,p){var m=document.createElement(o);if(f&&(m.className=f),p&&(m.style.cssText=p),typeof d=="string")m.appendChild(document.createTextNode(d));else if(d)for(var b=0;b<d.length;++b)m.appendChild(d[b]);return m}function se(o,d,f,p){var m=F(o,d,f,p);return m.setAttribute("role","presentation"),m}var oe;document.createRange?oe=function(o,d,f,p){var m=document.createRange();return m.setEnd(p||o,f),m.setStart(o,d),m}:oe=function(o,d,f){var p=document.body.createTextRange();try{p.moveToElementText(o.parentNode)}catch{return p}return p.collapse(!0),p.moveEnd("character",f),p.moveStart("character",d),p};function Re(o,d){if(d.nodeType==3&&(d=d.parentNode),o.contains)return o.contains(d);do if(d.nodeType==11&&(d=d.host),d==o)return!0;while(d=d.parentNode)}function le(o){var d=o.ownerDocument||o,f;try{f=o.activeElement}catch{f=d.body||null}for(;f&&f.shadowRoot&&f.shadowRoot.activeElement;)f=f.shadowRoot.activeElement;return f}function Se(o,d){var f=o.className;H(d).test(f)||(o.className+=(f?" ":"")+d)}function ne(o,d){for(var f=o.split(" "),p=0;p<f.length;p++)f[p]&&!H(f[p]).test(d)&&(d+=" "+f[p]);return d}var he=function(o){o.select()};k?he=function(o){o.selectionStart=0,o.selectionEnd=o.value.length}:c&&(he=function(o){try{o.select()}catch{}});function Le(o){return o.display.wrapper.ownerDocument}function _e(o){return Ge(o.display.wrapper)}function Ge(o){return o.getRootNode?o.getRootNode():o.ownerDocument}function De(o){return Le(o).defaultView}function Ee(o){var d=Array.prototype.slice.call(arguments,1);return function(){return o.apply(null,d)}}function Me(o,d,f){d||(d={});for(var p in o)o.hasOwnProperty(p)&&(f!==!1||!d.hasOwnProperty(p))&&(d[p]=o[p]);return d}function Fe(o,d,f,p,m){d==null&&(d=o.search(/[^\s\u00a0]/),d==-1&&(d=o.length));for(var b=p||0,x=m||0;;){var T=o.indexOf("	",b);if(T<0||T>=d)return x+(d-b);x+=T-b,x+=f-x%f,b=T+1}}var Ue=function(){this.id=null,this.f=null,this.time=0,this.handler=Ee(this.onTimeout,this)};Ue.prototype.onTimeout=function(o){o.id=0,o.time<=+new Date?o.f():setTimeout(o.handler,o.time-+new Date)},Ue.prototype.set=function(o,d){this.f=d;var f=+new Date+o;(!this.id||f<this.time)&&(clearTimeout(this.id),this.id=setTimeout(this.handler,o),this.time=f)};function Ce(o,d){for(var f=0;f<o.length;++f)if(o[f]==d)return f;return-1}var Ye=50,_t={toString:function(){return"CodeMirror.Pass"}},Yt={scroll:!1},bn={origin:"*mouse"},Xt={origin:"+move"};function dn(o,d,f){for(var p=0,m=0;;){var b=o.indexOf("	",p);b==-1&&(b=o.length);var x=b-p;if(b==o.length||m+x>=d)return p+Math.min(x,d-m);if(m+=b-p,m+=f-m%f,p=b+1,m>=d)return p}}var wn=[""];function pr(o){for(;wn.length<=o;)wn.push(He(wn)+" ");return wn[o]}function He(o){return o[o.length-1]}function Kn(o,d){for(var f=[],p=0;p<o.length;p++)f[p]=d(o[p],p);return f}function _i(o,d,f){for(var p=0,m=f(d);p<o.length&&f(o[p])<=m;)p++;o.splice(p,0,d)}function Ui(){}function fr(o,d){var f;return Object.create?f=Object.create(o):(Ui.prototype=o,f=new Ui),d&&Me(d,f),f}var Jo=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;function Ds(o){return/\w/.test(o)||o>""&&(o.toUpperCase()!=o.toLowerCase()||Jo.test(o))}function Gn(o,d){return d?d.source.indexOf("\\w")>-1&&Ds(o)?!0:d.test(o):Ds(o)}function Gd(o){for(var d in o)if(o.hasOwnProperty(d)&&o[d])return!1;return!0}var ai=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function Rt(o){return o.charCodeAt(0)>=768&&ai.test(o)}function $i(o,d,f){for(;(f<0?d>0:d<o.length)&&Rt(o.charAt(d));)d+=f;return d}function Vr(o,d,f){for(var p=d>f?-1:1;;){if(d==f)return d;var m=(d+f)/2,b=p<0?Math.ceil(m):Math.floor(m);if(b==d)return o(b)?d:f;o(b)?f=b:d=b+p}}function zi(o,d,f,p){if(!o)return p(d,f,"ltr",0);for(var m=!1,b=0;b<o.length;++b){var x=o[b];(x.from<f&&x.to>d||d==f&&x.to==d)&&(p(Math.max(x.from,d),Math.min(x.to,f),x.level==1?"rtl":"ltr",b),m=!0)}m||p(d,f,"ltr")}var Ps=null;function Gi(o,d,f){var p;Ps=null;for(var m=0;m<o.length;++m){var b=o[m];if(b.from<d&&b.to>d)return m;b.to==d&&(b.from!=b.to&&f=="before"?p=m:Ps=m),b.from==d&&(b.from!=b.to&&f!="before"?p=m:Ps=m)}return p??Ps}var Vh=(function(){var o="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",d="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";function f(A){return A<=247?o.charAt(A):1424<=A&&A<=1524?"R":1536<=A&&A<=1785?d.charAt(A-1536):1774<=A&&A<=2220?"r":8192<=A&&A<=8203?"w":A==8204?"b":"L"}var p=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,m=/[stwN]/,b=/[LRr]/,x=/[Lb1n]/,T=/[1n]/;function I(A,$,W){this.level=A,this.from=$,this.to=W}return function(A,$){var W=$=="ltr"?"L":"R";if(A.length==0||$=="ltr"&&!p.test(A))return!1;for(var Y=A.length,J=[],Q=0;Q<Y;++Q)J.push(f(A.charCodeAt(Q)));for(var re=0,ue=W;re<Y;++re){var pe=J[re];pe=="m"?J[re]=ue:ue=pe}for(var be=0,fe=W;be<Y;++be){var xe=J[be];xe=="1"&&fe=="r"?J[be]="n":b.test(xe)&&(fe=xe,xe=="r"&&(J[be]="R"))}for(var Be=1,Ae=J[0];Be<Y-1;++Be){var je=J[Be];je=="+"&&Ae=="1"&&J[Be+1]=="1"?J[Be]="1":je==","&&Ae==J[Be+1]&&(Ae=="1"||Ae=="n")&&(J[Be]=Ae),Ae=je}for(var ht=0;ht<Y;++ht){var Wt=J[ht];if(Wt==",")J[ht]="N";else if(Wt=="%"){var yt=void 0;for(yt=ht+1;yt<Y&&J[yt]=="%";++yt);for(var Bn=ht&&J[ht-1]=="!"||yt<Y&&J[yt]=="1"?"1":"N",Tn=ht;Tn<yt;++Tn)J[Tn]=Bn;ht=yt-1}}for(var Mt=0,kn=W;Mt<Y;++Mt){var Kt=J[Mt];kn=="L"&&Kt=="1"?J[Mt]="L":b.test(Kt)&&(kn=Kt)}for(var Bt=0;Bt<Y;++Bt)if(m.test(J[Bt])){var At=void 0;for(At=Bt+1;At<Y&&m.test(J[At]);++At);for(var Ct=(Bt?J[Bt-1]:W)=="L",Ln=(At<Y?J[At]:W)=="L",Fa=Ct==Ln?Ct?"L":"R":W,ns=Bt;ns<At;++ns)J[ns]=Fa;Bt=At-1}for(var sn=[],Ur,jt=0;jt<Y;)if(x.test(J[jt])){var Dp=jt;for(++jt;jt<Y&&x.test(J[jt]);++jt);sn.push(new I(0,Dp,jt))}else{var fi=jt,_s=sn.length,Us=$=="rtl"?1:0;for(++jt;jt<Y&&J[jt]!="L";++jt);for(var un=fi;un<jt;)if(T.test(J[un])){fi<un&&(sn.splice(_s,0,new I(1,fi,un)),_s+=Us);var _a=un;for(++un;un<jt&&T.test(J[un]);++un);sn.splice(_s,0,new I(2,_a,un)),_s+=Us,fi=un}else++un;fi<jt&&sn.splice(_s,0,new I(1,fi,jt))}return $=="ltr"&&(sn[0].level==1&&(Ur=A.match(/^\s+/))&&(sn[0].from=Ur[0].length,sn.unshift(new I(0,0,Ur[0].length))),He(sn).level==1&&(Ur=A.match(/\s+$/))&&(He(sn).to-=Ur[0].length,sn.push(new I(0,Y-Ur[0].length,Y)))),$=="rtl"?sn.reverse():sn}})();function qe(o,d){var f=o.order;return f==null&&(f=o.order=Vh(o.text,d)),f}var Wd=[],Ve=function(o,d,f){if(o.addEventListener)o.addEventListener(d,f,!1);else if(o.attachEvent)o.attachEvent("on"+d,f);else{var p=o._handlers||(o._handlers={});p[d]=(p[d]||Wd).concat(f)}};function oi(o,d){return o._handlers&&o._handlers[d]||Wd}function tn(o,d,f){if(o.removeEventListener)o.removeEventListener(d,f,!1);else if(o.detachEvent)o.detachEvent("on"+d,f);else{var p=o._handlers,m=p&&p[d];if(m){var b=Ce(m,f);b>-1&&(p[d]=m.slice(0,b).concat(m.slice(b+1)))}}}function bt(o,d){var f=oi(o,d);if(f.length)for(var p=Array.prototype.slice.call(arguments,2),m=0;m<f.length;++m)f[m].apply(null,p)}function wt(o,d,f){return typeof d=="string"&&(d={type:d,preventDefault:function(){this.defaultPrevented=!0}}),bt(o,f||d.type,o,d),Sn(d)||d.codemirrorIgnore}function Zn(o){var d=o._handlers&&o._handlers.cursorActivity;if(d)for(var f=o.curOp.cursorActivityHandlers||(o.curOp.cursorActivityHandlers=[]),p=0;p<d.length;++p)Ce(f,d[p])==-1&&f.push(d[p])}function Vn(o,d){return oi(o,d).length>0}function gr(o){o.prototype.on=function(d,f){Ve(this,d,f)},o.prototype.off=function(d,f){tn(this,d,f)}}function nn(o){o.preventDefault?o.preventDefault():o.returnValue=!1}function ha(o){o.stopPropagation?o.stopPropagation():o.cancelBubble=!0}function Sn(o){return o.defaultPrevented!=null?o.defaultPrevented:o.returnValue==!1}function Wi(o){nn(o),ha(o)}function Yo(o){return o.target||o.srcElement}function mr(o){var d=o.which;return d==null&&(o.button&1?d=1:o.button&2?d=3:o.button&4&&(d=2)),L&&o.ctrlKey&&d==1&&(d=3),d}var Oh=(function(){if(c&&u<9)return!1;var o=F("div");return"draggable"in o||"dragDrop"in o})(),pa;function jd(o){if(pa==null){var d=F("span","​");z(o,F("span",[d,document.createTextNode("x")])),o.firstChild.offsetHeight!=0&&(pa=d.offsetWidth<=1&&d.offsetHeight>2&&!(c&&u<8))}var f=pa?F("span","​"):F("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return f.setAttribute("cm-text",""),f}var Xo;function ji(o){if(Xo!=null)return Xo;var d=z(o,document.createTextNode("AخA")),f=oe(d,0,1).getBoundingClientRect(),p=oe(d,1,2).getBoundingClientRect();return O(o),!f||f.left==f.right?!1:Xo=p.right-f.right<3}var Qn=`

b`.split(/\n/).length!=3?function(o){for(var d=0,f=[],p=o.length;d<=p;){var m=o.indexOf(`
`,d);m==-1&&(m=o.length);var b=o.slice(d,o.charAt(m-1)=="\r"?m-1:m),x=b.indexOf("\r");x!=-1?(f.push(b.slice(0,x)),d+=x+1):(f.push(b),d=m+1)}return f}:function(o){return o.split(/\r\n?|\n/)},Hi=window.getSelection?function(o){try{return o.selectionStart!=o.selectionEnd}catch{return!1}}:function(o){var d;try{d=o.ownerDocument.selection.createRange()}catch{}return!d||d.parentElement()!=o?!1:d.compareEndPoints("StartToEnd",d)!=0},Hd=(function(){var o=F("div");return"oncopy"in o?!0:(o.setAttribute("oncopy","return;"),typeof o.oncopy=="function")})(),vr=null;function Bh(o){if(vr!=null)return vr;var d=z(o,F("span","x")),f=d.getBoundingClientRect(),p=oe(d,0,1).getBoundingClientRect();return vr=Math.abs(f.left-p.left)>1}var fa={},yr={};function br(o,d){arguments.length>2&&(d.dependencies=Array.prototype.slice.call(arguments,2)),fa[o]=d}function ga(o,d){yr[o]=d}function ma(o){if(typeof o=="string"&&yr.hasOwnProperty(o))o=yr[o];else if(o&&typeof o.name=="string"&&yr.hasOwnProperty(o.name)){var d=yr[o.name];typeof d=="string"&&(d={name:d}),o=fr(d,o),o.name=d.name}else{if(typeof o=="string"&&/^[\w\-]+\/[\w\-]+\+xml$/.test(o))return ma("application/xml");if(typeof o=="string"&&/^[\w\-]+\/[\w\-]+\+json$/.test(o))return ma("application/json")}return typeof o=="string"?{name:o}:o||{name:"null"}}function va(o,d){d=ma(d);var f=fa[d.name];if(!f)return va(o,"text/plain");var p=f(o,d);if(qi.hasOwnProperty(d.name)){var m=qi[d.name];for(var b in m)m.hasOwnProperty(b)&&(p.hasOwnProperty(b)&&(p["_"+b]=p[b]),p[b]=m[b])}if(p.name=d.name,d.helperType&&(p.helperType=d.helperType),d.modeProps)for(var x in d.modeProps)p[x]=d.modeProps[x];return p}var qi={};function ya(o,d){var f=qi.hasOwnProperty(o)?qi[o]:qi[o]={};Me(d,f)}function Or(o,d){if(d===!0)return d;if(o.copyState)return o.copyState(d);var f={};for(var p in d){var m=d[p];m instanceof Array&&(m=m.concat([])),f[p]=m}return f}function Ko(o,d){for(var f;o.innerMode&&(f=o.innerMode(d),!(!f||f.mode==o));)d=f.state,o=f.mode;return f||{mode:o,state:d}}function ba(o,d,f){return o.startState?o.startState(d,f):!0}var St=function(o,d,f){this.pos=this.start=0,this.string=o,this.tabSize=d||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=f};St.prototype.eol=function(){return this.pos>=this.string.length},St.prototype.sol=function(){return this.pos==this.lineStart},St.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},St.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},St.prototype.eat=function(o){var d=this.string.charAt(this.pos),f;if(typeof o=="string"?f=d==o:f=d&&(o.test?o.test(d):o(d)),f)return++this.pos,d},St.prototype.eatWhile=function(o){for(var d=this.pos;this.eat(o););return this.pos>d},St.prototype.eatSpace=function(){for(var o=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>o},St.prototype.skipToEnd=function(){this.pos=this.string.length},St.prototype.skipTo=function(o){var d=this.string.indexOf(o,this.pos);if(d>-1)return this.pos=d,!0},St.prototype.backUp=function(o){this.pos-=o},St.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=Fe(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?Fe(this.string,this.lineStart,this.tabSize):0)},St.prototype.indentation=function(){return Fe(this.string,null,this.tabSize)-(this.lineStart?Fe(this.string,this.lineStart,this.tabSize):0)},St.prototype.match=function(o,d,f){if(typeof o=="string"){var p=function(x){return f?x.toLowerCase():x},m=this.string.substr(this.pos,o.length);if(p(m)==p(o))return d!==!1&&(this.pos+=o.length),!0}else{var b=this.string.slice(this.pos).match(o);return b&&b.index>0?null:(b&&d!==!1&&(this.pos+=b[0].length),b)}},St.prototype.current=function(){return this.string.slice(this.start,this.pos)},St.prototype.hideFirstChars=function(o,d){this.lineStart+=o;try{return d()}finally{this.lineStart-=o}},St.prototype.lookAhead=function(o){var d=this.lineOracle;return d&&d.lookAhead(o)},St.prototype.baseToken=function(){var o=this.lineOracle;return o&&o.baseToken(this.pos)};function Ie(o,d){if(d-=o.first,d<0||d>=o.size)throw new Error("There is no line "+(d+o.first)+" in the document.");for(var f=o;!f.lines;)for(var p=0;;++p){var m=f.children[p],b=m.chunkSize();if(d<b){f=m;break}d-=b}return f.lines[d]}function li(o,d,f){var p=[],m=d.line;return o.iter(d.line,f.line+1,function(b){var x=b.text;m==f.line&&(x=x.slice(0,f.ch)),m==d.line&&(x=x.slice(d.ch)),p.push(x),++m}),p}function Zo(o,d,f){var p=[];return o.iter(d,f,function(m){p.push(m.text)}),p}function Wn(o,d){var f=d-o.height;if(f)for(var p=o;p;p=p.parent)p.height+=f}function N(o){if(o.parent==null)return null;for(var d=o.parent,f=Ce(d.lines,o),p=d.parent;p;d=p,p=p.parent)for(var m=0;p.children[m]!=d;++m)f+=p.children[m].chunkSize();return f+d.first}function G(o,d){var f=o.first;e:do{for(var p=0;p<o.children.length;++p){var m=o.children[p],b=m.height;if(d<b){o=m;continue e}d-=b,f+=m.chunkSize()}return f}while(!o.lines);for(var x=0;x<o.lines.length;++x){var T=o.lines[x],I=T.height;if(d<I)break;d-=I}return f+x}function ee(o,d){return d>=o.first&&d<o.first+o.size}function ce(o,d){return String(o.lineNumberFormatter(d+o.firstLineNumber))}function Z(o,d,f){if(f===void 0&&(f=null),!(this instanceof Z))return new Z(o,d,f);this.line=o,this.ch=d,this.sticky=f}function me(o,d){return o.line-d.line||o.ch-d.ch}function et(o,d){return o.sticky==d.sticky&&me(o,d)==0}function Ut(o){return Z(o.line,o.ch)}function Cn(o,d){return me(o,d)<0?d:o}function wa(o,d){return me(o,d)<0?o:d}function Jy(o,d){return Math.max(o.first,Math.min(d,o.first+o.size-1))}function $e(o,d){if(d.line<o.first)return Z(o.first,0);var f=o.first+o.size-1;return d.line>f?Z(f,Ie(o,f).text.length):QP(d,Ie(o,d.line).text.length)}function QP(o,d){var f=o.ch;return f==null||f>d?Z(o.line,d):f<0?Z(o.line,0):o}function Yy(o,d){for(var f=[],p=0;p<d.length;p++)f[p]=$e(o,d[p]);return f}var qd=function(o,d){this.state=o,this.lookAhead=d},Br=function(o,d,f,p){this.state=d,this.doc=o,this.line=f,this.maxLookAhead=p||0,this.baseTokens=null,this.baseTokenPos=1};Br.prototype.lookAhead=function(o){var d=this.doc.getLine(this.line+o);return d!=null&&o>this.maxLookAhead&&(this.maxLookAhead=o),d},Br.prototype.baseToken=function(o){if(!this.baseTokens)return null;for(;this.baseTokens[this.baseTokenPos]<=o;)this.baseTokenPos+=2;var d=this.baseTokens[this.baseTokenPos+1];return{type:d&&d.replace(/( |^)overlay .*/,""),size:this.baseTokens[this.baseTokenPos]-o}},Br.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},Br.fromSaved=function(o,d,f){return d instanceof qd?new Br(o,Or(o.mode,d.state),f,d.lookAhead):new Br(o,Or(o.mode,d),f)},Br.prototype.save=function(o){var d=o!==!1?Or(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new qd(d,this.maxLookAhead):d};function Xy(o,d,f,p){var m=[o.state.modeGen],b={};n0(o,d.text,o.doc.mode,f,function(A,$){return m.push(A,$)},b,p);for(var x=f.state,T=function(A){f.baseTokens=m;var $=o.state.overlays[A],W=1,Y=0;f.state=!0,n0(o,d.text,$.mode,f,function(J,Q){for(var re=W;Y<J;){var ue=m[W];ue>J&&m.splice(W,1,J,m[W+1],ue),W+=2,Y=Math.min(J,ue)}if(Q)if($.opaque)m.splice(re,W-re,J,"overlay "+Q),W=re+2;else for(;re<W;re+=2){var pe=m[re+1];m[re+1]=(pe?pe+" ":"")+"overlay "+Q}},b),f.state=x,f.baseTokens=null,f.baseTokenPos=1},I=0;I<o.state.overlays.length;++I)T(I);return{styles:m,classes:b.bgClass||b.textClass?b:null}}function Ky(o,d,f){if(!d.styles||d.styles[0]!=o.state.modeGen){var p=Qo(o,N(d)),m=d.text.length>o.options.maxHighlightLength&&Or(o.doc.mode,p.state),b=Xy(o,d,p);m&&(p.state=m),d.stateAfter=p.save(!m),d.styles=b.styles,b.classes?d.styleClasses=b.classes:d.styleClasses&&(d.styleClasses=null),f===o.doc.highlightFrontier&&(o.doc.modeFrontier=Math.max(o.doc.modeFrontier,++o.doc.highlightFrontier))}return d.styles}function Qo(o,d,f){var p=o.doc,m=o.display;if(!p.mode.startState)return new Br(p,!0,d);var b=eR(o,d,f),x=b>p.first&&Ie(p,b-1).stateAfter,T=x?Br.fromSaved(p,x,b):new Br(p,ba(p.mode),b);return p.iter(b,d,function(I){Fh(o,I.text,T);var A=T.line;I.stateAfter=A==d-1||A%5==0||A>=m.viewFrom&&A<m.viewTo?T.save():null,T.nextLine()}),f&&(p.modeFrontier=T.line),T}function Fh(o,d,f,p){var m=o.doc.mode,b=new St(d,o.options.tabSize,f);for(b.start=b.pos=p||0,d==""&&Zy(m,f.state);!b.eol();)_h(m,b,f.state),b.start=b.pos}function Zy(o,d){if(o.blankLine)return o.blankLine(d);if(o.innerMode){var f=Ko(o,d);if(f.mode.blankLine)return f.mode.blankLine(f.state)}}function _h(o,d,f,p){for(var m=0;m<10;m++){p&&(p[0]=Ko(o,f).mode);var b=o.token(d,f);if(d.pos>d.start)return b}throw new Error("Mode "+o.name+" failed to advance stream.")}var Qy=function(o,d,f){this.start=o.start,this.end=o.pos,this.string=o.current(),this.type=d||null,this.state=f};function e0(o,d,f,p){var m=o.doc,b=m.mode,x;d=$e(m,d);var T=Ie(m,d.line),I=Qo(o,d.line,f),A=new St(T.text,o.options.tabSize,I),$;for(p&&($=[]);(p||A.pos<d.ch)&&!A.eol();)A.start=A.pos,x=_h(b,A,I.state),p&&$.push(new Qy(A,x,Or(m.mode,I.state)));return p?$:new Qy(A,x,I.state)}function t0(o,d){if(o)for(;;){var f=o.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!f)break;o=o.slice(0,f.index)+o.slice(f.index+f[0].length);var p=f[1]?"bgClass":"textClass";d[p]==null?d[p]=f[2]:new RegExp("(?:^|\\s)"+f[2]+"(?:$|\\s)").test(d[p])||(d[p]+=" "+f[2])}return o}function n0(o,d,f,p,m,b,x){var T=f.flattenSpans;T==null&&(T=o.options.flattenSpans);var I=0,A=null,$=new St(d,o.options.tabSize,p),W,Y=o.options.addModeClass&&[null];for(d==""&&t0(Zy(f,p.state),b);!$.eol();){if($.pos>o.options.maxHighlightLength?(T=!1,x&&Fh(o,d,p,$.pos),$.pos=d.length,W=null):W=t0(_h(f,$,p.state,Y),b),Y){var J=Y[0].name;J&&(W="m-"+(W?J+" "+W:J))}if(!T||A!=W){for(;I<$.start;)I=Math.min($.start,I+5e3),m(I,A);A=W}$.start=$.pos}for(;I<$.pos;){var Q=Math.min($.pos,I+5e3);m(Q,A),I=Q}}function eR(o,d,f){for(var p,m,b=o.doc,x=f?-1:d-(o.doc.mode.innerMode?1e3:100),T=d;T>x;--T){if(T<=b.first)return b.first;var I=Ie(b,T-1),A=I.stateAfter;if(A&&(!f||T+(A instanceof qd?A.lookAhead:0)<=b.modeFrontier))return T;var $=Fe(I.text,null,o.options.tabSize);(m==null||p>$)&&(m=T-1,p=$)}return m}function tR(o,d){if(o.modeFrontier=Math.min(o.modeFrontier,d),!(o.highlightFrontier<d-10)){for(var f=o.first,p=d-1;p>f;p--){var m=Ie(o,p).stateAfter;if(m&&(!(m instanceof qd)||p+m.lookAhead<d)){f=p+1;break}}o.highlightFrontier=Math.min(o.highlightFrontier,f)}}var r0=!1,di=!1;function nR(){r0=!0}function rR(){di=!0}function Jd(o,d,f){this.marker=o,this.from=d,this.to=f}function el(o,d){if(o)for(var f=0;f<o.length;++f){var p=o[f];if(p.marker==d)return p}}function iR(o,d){for(var f,p=0;p<o.length;++p)o[p]!=d&&(f||(f=[])).push(o[p]);return f}function sR(o,d,f){var p=f&&window.WeakSet&&(f.markedSpans||(f.markedSpans=new WeakSet));p&&o.markedSpans&&p.has(o.markedSpans)?o.markedSpans.push(d):(o.markedSpans=o.markedSpans?o.markedSpans.concat([d]):[d],p&&p.add(o.markedSpans)),d.marker.attachLine(o)}function aR(o,d,f){var p;if(o)for(var m=0;m<o.length;++m){var b=o[m],x=b.marker,T=b.from==null||(x.inclusiveLeft?b.from<=d:b.from<d);if(T||b.from==d&&x.type=="bookmark"&&(!f||!b.marker.insertLeft)){var I=b.to==null||(x.inclusiveRight?b.to>=d:b.to>d);(p||(p=[])).push(new Jd(x,b.from,I?null:b.to))}}return p}function oR(o,d,f){var p;if(o)for(var m=0;m<o.length;++m){var b=o[m],x=b.marker,T=b.to==null||(x.inclusiveRight?b.to>=d:b.to>d);if(T||b.from==d&&x.type=="bookmark"&&(!f||b.marker.insertLeft)){var I=b.from==null||(x.inclusiveLeft?b.from<=d:b.from<d);(p||(p=[])).push(new Jd(x,I?null:b.from-d,b.to==null?null:b.to-d))}}return p}function Uh(o,d){if(d.full)return null;var f=ee(o,d.from.line)&&Ie(o,d.from.line).markedSpans,p=ee(o,d.to.line)&&Ie(o,d.to.line).markedSpans;if(!f&&!p)return null;var m=d.from.ch,b=d.to.ch,x=me(d.from,d.to)==0,T=aR(f,m,x),I=oR(p,b,x),A=d.text.length==1,$=He(d.text).length+(A?m:0);if(T)for(var W=0;W<T.length;++W){var Y=T[W];if(Y.to==null){var J=el(I,Y.marker);J?A&&(Y.to=J.to==null?null:J.to+$):Y.to=m}}if(I)for(var Q=0;Q<I.length;++Q){var re=I[Q];if(re.to!=null&&(re.to+=$),re.from==null){var ue=el(T,re.marker);ue||(re.from=$,A&&(T||(T=[])).push(re))}else re.from+=$,A&&(T||(T=[])).push(re)}T&&(T=i0(T)),I&&I!=T&&(I=i0(I));var pe=[T];if(!A){var be=d.text.length-2,fe;if(be>0&&T)for(var xe=0;xe<T.length;++xe)T[xe].to==null&&(fe||(fe=[])).push(new Jd(T[xe].marker,null,null));for(var Be=0;Be<be;++Be)pe.push(fe);pe.push(I)}return pe}function i0(o){for(var d=0;d<o.length;++d){var f=o[d];f.from!=null&&f.from==f.to&&f.marker.clearWhenEmpty!==!1&&o.splice(d--,1)}return o.length?o:null}function lR(o,d,f){var p=null;if(o.iter(d.line,f.line+1,function(J){if(J.markedSpans)for(var Q=0;Q<J.markedSpans.length;++Q){var re=J.markedSpans[Q].marker;re.readOnly&&(!p||Ce(p,re)==-1)&&(p||(p=[])).push(re)}}),!p)return null;for(var m=[{from:d,to:f}],b=0;b<p.length;++b)for(var x=p[b],T=x.find(0),I=0;I<m.length;++I){var A=m[I];if(!(me(A.to,T.from)<0||me(A.from,T.to)>0)){var $=[I,1],W=me(A.from,T.from),Y=me(A.to,T.to);(W<0||!x.inclusiveLeft&&!W)&&$.push({from:A.from,to:T.from}),(Y>0||!x.inclusiveRight&&!Y)&&$.push({from:T.to,to:A.to}),m.splice.apply(m,$),I+=$.length-3}}return m}function s0(o){var d=o.markedSpans;if(d){for(var f=0;f<d.length;++f)d[f].marker.detachLine(o);o.markedSpans=null}}function a0(o,d){if(d){for(var f=0;f<d.length;++f)d[f].marker.attachLine(o);o.markedSpans=d}}function Yd(o){return o.inclusiveLeft?-1:0}function Xd(o){return o.inclusiveRight?1:0}function $h(o,d){var f=o.lines.length-d.lines.length;if(f!=0)return f;var p=o.find(),m=d.find(),b=me(p.from,m.from)||Yd(o)-Yd(d);if(b)return-b;var x=me(p.to,m.to)||Xd(o)-Xd(d);return x||d.id-o.id}function o0(o,d){var f=di&&o.markedSpans,p;if(f)for(var m=void 0,b=0;b<f.length;++b)m=f[b],m.marker.collapsed&&(d?m.from:m.to)==null&&(!p||$h(p,m.marker)<0)&&(p=m.marker);return p}function l0(o){return o0(o,!0)}function Kd(o){return o0(o,!1)}function dR(o,d){var f=di&&o.markedSpans,p;if(f)for(var m=0;m<f.length;++m){var b=f[m];b.marker.collapsed&&(b.from==null||b.from<d)&&(b.to==null||b.to>d)&&(!p||$h(p,b.marker)<0)&&(p=b.marker)}return p}function d0(o,d,f,p,m){var b=Ie(o,d),x=di&&b.markedSpans;if(x)for(var T=0;T<x.length;++T){var I=x[T];if(I.marker.collapsed){var A=I.marker.find(0),$=me(A.from,f)||Yd(I.marker)-Yd(m),W=me(A.to,p)||Xd(I.marker)-Xd(m);if(!($>=0&&W<=0||$<=0&&W>=0)&&($<=0&&(I.marker.inclusiveRight&&m.inclusiveLeft?me(A.to,f)>=0:me(A.to,f)>0)||$>=0&&(I.marker.inclusiveRight&&m.inclusiveLeft?me(A.from,p)<=0:me(A.from,p)<0)))return!0}}}function wr(o){for(var d;d=l0(o);)o=d.find(-1,!0).line;return o}function cR(o){for(var d;d=Kd(o);)o=d.find(1,!0).line;return o}function uR(o){for(var d,f;d=Kd(o);)o=d.find(1,!0).line,(f||(f=[])).push(o);return f}function zh(o,d){var f=Ie(o,d),p=wr(f);return f==p?d:N(p)}function c0(o,d){if(d>o.lastLine())return d;var f=Ie(o,d),p;if(!Ji(o,f))return d;for(;p=Kd(f);)f=p.find(1,!0).line;return N(f)+1}function Ji(o,d){var f=di&&d.markedSpans;if(f){for(var p=void 0,m=0;m<f.length;++m)if(p=f[m],!!p.marker.collapsed&&(p.from==null||!p.marker.widgetNode&&p.from==0&&p.marker.inclusiveLeft&&Gh(o,d,p)))return!0}}function Gh(o,d,f){if(f.to==null){var p=f.marker.find(1,!0);return Gh(o,p.line,el(p.line.markedSpans,f.marker))}if(f.marker.inclusiveRight&&f.to==d.text.length)return!0;for(var m=void 0,b=0;b<d.markedSpans.length;++b)if(m=d.markedSpans[b],m.marker.collapsed&&!m.marker.widgetNode&&m.from==f.to&&(m.to==null||m.to!=f.from)&&(m.marker.inclusiveLeft||f.marker.inclusiveRight)&&Gh(o,d,m))return!0}function ci(o){o=wr(o);for(var d=0,f=o.parent,p=0;p<f.lines.length;++p){var m=f.lines[p];if(m==o)break;d+=m.height}for(var b=f.parent;b;f=b,b=f.parent)for(var x=0;x<b.children.length;++x){var T=b.children[x];if(T==f)break;d+=T.height}return d}function Zd(o){if(o.height==0)return 0;for(var d=o.text.length,f,p=o;f=l0(p);){var m=f.find(0,!0);p=m.from.line,d+=m.from.ch-m.to.ch}for(p=o;f=Kd(p);){var b=f.find(0,!0);d-=p.text.length-b.from.ch,p=b.to.line,d+=p.text.length-b.to.ch}return d}function Wh(o){var d=o.display,f=o.doc;d.maxLine=Ie(f,f.first),d.maxLineLength=Zd(d.maxLine),d.maxLineChanged=!0,f.iter(function(p){var m=Zd(p);m>d.maxLineLength&&(d.maxLineLength=m,d.maxLine=p)})}var Sa=function(o,d,f){this.text=o,a0(this,d),this.height=f?f(this):1};Sa.prototype.lineNo=function(){return N(this)},gr(Sa);function hR(o,d,f,p){o.text=d,o.stateAfter&&(o.stateAfter=null),o.styles&&(o.styles=null),o.order!=null&&(o.order=null),s0(o),a0(o,f);var m=p?p(o):1;m!=o.height&&Wn(o,m)}function pR(o){o.parent=null,s0(o)}var fR={},gR={};function u0(o,d){if(!o||/^\s*$/.test(o))return null;var f=d.addModeClass?gR:fR;return f[o]||(f[o]=o.replace(/\S+/g,"cm-$&"))}function h0(o,d){var f=se("span",null,null,h?"padding-right: .1px":null),p={pre:se("pre",[f],"CodeMirror-line"),content:f,col:0,pos:0,cm:o,trailingSpace:!1,splitSpaces:o.getOption("lineWrapping")};d.measure={};for(var m=0;m<=(d.rest?d.rest.length:0);m++){var b=m?d.rest[m-1]:d.line,x=void 0;p.pos=0,p.addToken=vR,ji(o.display.measure)&&(x=qe(b,o.doc.direction))&&(p.addToken=bR(p.addToken,x)),p.map=[];var T=d!=o.display.externalMeasured&&N(b);wR(b,p,Ky(o,b,T)),b.styleClasses&&(b.styleClasses.bgClass&&(p.bgClass=ne(b.styleClasses.bgClass,p.bgClass||"")),b.styleClasses.textClass&&(p.textClass=ne(b.styleClasses.textClass,p.textClass||""))),p.map.length==0&&p.map.push(0,0,p.content.appendChild(jd(o.display.measure))),m==0?(d.measure.map=p.map,d.measure.cache={}):((d.measure.maps||(d.measure.maps=[])).push(p.map),(d.measure.caches||(d.measure.caches=[])).push({}))}if(h){var I=p.content.lastChild;(/\bcm-tab\b/.test(I.className)||I.querySelector&&I.querySelector(".cm-tab"))&&(p.content.className="cm-tab-wrap-hack")}return bt(o,"renderLine",o,d.line,p.pre),p.pre.className&&(p.textClass=ne(p.pre.className,p.textClass||"")),p}function mR(o){var d=F("span","•","cm-invalidchar");return d.title="\\u"+o.charCodeAt(0).toString(16),d.setAttribute("aria-label",d.title),d}function vR(o,d,f,p,m,b,x){if(d){var T=o.splitSpaces?yR(d,o.trailingSpace):d,I=o.cm.state.specialChars,A=!1,$;if(!I.test(d))o.col+=d.length,$=document.createTextNode(T),o.map.push(o.pos,o.pos+d.length,$),c&&u<9&&(A=!0),o.pos+=d.length;else{$=document.createDocumentFragment();for(var W=0;;){I.lastIndex=W;var Y=I.exec(d),J=Y?Y.index-W:d.length-W;if(J){var Q=document.createTextNode(T.slice(W,W+J));c&&u<9?$.appendChild(F("span",[Q])):$.appendChild(Q),o.map.push(o.pos,o.pos+J,Q),o.col+=J,o.pos+=J}if(!Y)break;W+=J+1;var re=void 0;if(Y[0]=="	"){var ue=o.cm.options.tabSize,pe=ue-o.col%ue;re=$.appendChild(F("span",pr(pe),"cm-tab")),re.setAttribute("role","presentation"),re.setAttribute("cm-text","	"),o.col+=pe}else Y[0]=="\r"||Y[0]==`
`?(re=$.appendChild(F("span",Y[0]=="\r"?"␍":"␤","cm-invalidchar")),re.setAttribute("cm-text",Y[0]),o.col+=1):(re=o.cm.options.specialCharPlaceholder(Y[0]),re.setAttribute("cm-text",Y[0]),c&&u<9?$.appendChild(F("span",[re])):$.appendChild(re),o.col+=1);o.map.push(o.pos,o.pos+1,re),o.pos++}}if(o.trailingSpace=T.charCodeAt(d.length-1)==32,f||p||m||A||b||x){var be=f||"";p&&(be+=p),m&&(be+=m);var fe=F("span",[$],be,b);if(x)for(var xe in x)x.hasOwnProperty(xe)&&xe!="style"&&xe!="class"&&fe.setAttribute(xe,x[xe]);return o.content.appendChild(fe)}o.content.appendChild($)}}function yR(o,d){if(o.length>1&&!/  /.test(o))return o;for(var f=d,p="",m=0;m<o.length;m++){var b=o.charAt(m);b==" "&&f&&(m==o.length-1||o.charCodeAt(m+1)==32)&&(b=" "),p+=b,f=b==" "}return p}function bR(o,d){return function(f,p,m,b,x,T,I){m=m?m+" cm-force-border":"cm-force-border";for(var A=f.pos,$=A+p.length;;){for(var W=void 0,Y=0;Y<d.length&&(W=d[Y],!(W.to>A&&W.from<=A));Y++);if(W.to>=$)return o(f,p,m,b,x,T,I);o(f,p.slice(0,W.to-A),m,b,null,T,I),b=null,p=p.slice(W.to-A),A=W.to}}}function p0(o,d,f,p){var m=!p&&f.widgetNode;m&&o.map.push(o.pos,o.pos+d,m),!p&&o.cm.display.input.needsContentAttribute&&(m||(m=o.content.appendChild(document.createElement("span"))),m.setAttribute("cm-marker",f.id)),m&&(o.cm.display.input.setUneditable(m),o.content.appendChild(m)),o.pos+=d,o.trailingSpace=!1}function wR(o,d,f){var p=o.markedSpans,m=o.text,b=0;if(!p){for(var x=1;x<f.length;x+=2)d.addToken(d,m.slice(b,b=f[x]),u0(f[x+1],d.cm.options));return}for(var T=m.length,I=0,A=1,$="",W,Y,J=0,Q,re,ue,pe,be;;){if(J==I){Q=re=ue=Y="",be=null,pe=null,J=1/0;for(var fe=[],xe=void 0,Be=0;Be<p.length;++Be){var Ae=p[Be],je=Ae.marker;if(je.type=="bookmark"&&Ae.from==I&&je.widgetNode)fe.push(je);else if(Ae.from<=I&&(Ae.to==null||Ae.to>I||je.collapsed&&Ae.to==I&&Ae.from==I)){if(Ae.to!=null&&Ae.to!=I&&J>Ae.to&&(J=Ae.to,re=""),je.className&&(Q+=" "+je.className),je.css&&(Y=(Y?Y+";":"")+je.css),je.startStyle&&Ae.from==I&&(ue+=" "+je.startStyle),je.endStyle&&Ae.to==J&&(xe||(xe=[])).push(je.endStyle,Ae.to),je.title&&((be||(be={})).title=je.title),je.attributes)for(var ht in je.attributes)(be||(be={}))[ht]=je.attributes[ht];je.collapsed&&(!pe||$h(pe.marker,je)<0)&&(pe=Ae)}else Ae.from>I&&J>Ae.from&&(J=Ae.from)}if(xe)for(var Wt=0;Wt<xe.length;Wt+=2)xe[Wt+1]==J&&(re+=" "+xe[Wt]);if(!pe||pe.from==I)for(var yt=0;yt<fe.length;++yt)p0(d,0,fe[yt]);if(pe&&(pe.from||0)==I){if(p0(d,(pe.to==null?T+1:pe.to)-I,pe.marker,pe.from==null),pe.to==null)return;pe.to==I&&(pe=!1)}}if(I>=T)break;for(var Bn=Math.min(T,J);;){if($){var Tn=I+$.length;if(!pe){var Mt=Tn>Bn?$.slice(0,Bn-I):$;d.addToken(d,Mt,W?W+Q:Q,ue,I+Mt.length==J?re:"",Y,be)}if(Tn>=Bn){$=$.slice(Bn-I),I=Bn;break}I=Tn,ue=""}$=m.slice(b,b=f[A++]),W=u0(f[A++],d.cm.options)}}}function f0(o,d,f){this.line=d,this.rest=uR(d),this.size=this.rest?N(He(this.rest))-f+1:1,this.node=this.text=null,this.hidden=Ji(o,d)}function Qd(o,d,f){for(var p=[],m,b=d;b<f;b=m){var x=new f0(o.doc,Ie(o.doc,b),b);m=b+x.size,p.push(x)}return p}var Ca=null;function SR(o){Ca?Ca.ops.push(o):o.ownsGroup=Ca={ops:[o],delayedCallbacks:[]}}function CR(o){var d=o.delayedCallbacks,f=0;do{for(;f<d.length;f++)d[f].call(null);for(var p=0;p<o.ops.length;p++){var m=o.ops[p];if(m.cursorActivityHandlers)for(;m.cursorActivityCalled<m.cursorActivityHandlers.length;)m.cursorActivityHandlers[m.cursorActivityCalled++].call(null,m.cm)}}while(f<d.length)}function xR(o,d){var f=o.ownsGroup;if(f)try{CR(f)}finally{Ca=null,d(f)}}var tl=null;function $t(o,d){var f=oi(o,d);if(f.length){var p=Array.prototype.slice.call(arguments,2),m;Ca?m=Ca.delayedCallbacks:tl?m=tl:(m=tl=[],setTimeout(ER,0));for(var b=function(T){m.push(function(){return f[T].apply(null,p)})},x=0;x<f.length;++x)b(x)}}function ER(){var o=tl;tl=null;for(var d=0;d<o.length;++d)o[d]()}function g0(o,d,f,p){for(var m=0;m<d.changes.length;m++){var b=d.changes[m];b=="text"?kR(o,d):b=="gutter"?v0(o,d,f,p):b=="class"?jh(o,d):b=="widget"&&LR(o,d,p)}d.changes=null}function nl(o){return o.node==o.text&&(o.node=F("div",null,null,"position: relative"),o.text.parentNode&&o.text.parentNode.replaceChild(o.node,o.text),o.node.appendChild(o.text),c&&u<8&&(o.node.style.zIndex=2)),o.node}function TR(o,d){var f=d.bgClass?d.bgClass+" "+(d.line.bgClass||""):d.line.bgClass;if(f&&(f+=" CodeMirror-linebackground"),d.background)f?d.background.className=f:(d.background.parentNode.removeChild(d.background),d.background=null);else if(f){var p=nl(d);d.background=p.insertBefore(F("div",null,f),p.firstChild),o.display.input.setUneditable(d.background)}}function m0(o,d){var f=o.display.externalMeasured;return f&&f.line==d.line?(o.display.externalMeasured=null,d.measure=f.measure,f.built):h0(o,d)}function kR(o,d){var f=d.text.className,p=m0(o,d);d.text==d.node&&(d.node=p.pre),d.text.parentNode.replaceChild(p.pre,d.text),d.text=p.pre,p.bgClass!=d.bgClass||p.textClass!=d.textClass?(d.bgClass=p.bgClass,d.textClass=p.textClass,jh(o,d)):f&&(d.text.className=f)}function jh(o,d){TR(o,d),d.line.wrapClass?nl(d).className=d.line.wrapClass:d.node!=d.text&&(d.node.className="");var f=d.textClass?d.textClass+" "+(d.line.textClass||""):d.line.textClass;d.text.className=f||""}function v0(o,d,f,p){if(d.gutter&&(d.node.removeChild(d.gutter),d.gutter=null),d.gutterBackground&&(d.node.removeChild(d.gutterBackground),d.gutterBackground=null),d.line.gutterClass){var m=nl(d);d.gutterBackground=F("div",null,"CodeMirror-gutter-background "+d.line.gutterClass,"left: "+(o.options.fixedGutter?p.fixedPos:-p.gutterTotalWidth)+"px; width: "+p.gutterTotalWidth+"px"),o.display.input.setUneditable(d.gutterBackground),m.insertBefore(d.gutterBackground,d.text)}var b=d.line.gutterMarkers;if(o.options.lineNumbers||b){var x=nl(d),T=d.gutter=F("div",null,"CodeMirror-gutter-wrapper","left: "+(o.options.fixedGutter?p.fixedPos:-p.gutterTotalWidth)+"px");if(T.setAttribute("aria-hidden","true"),o.display.input.setUneditable(T),x.insertBefore(T,d.text),d.line.gutterClass&&(T.className+=" "+d.line.gutterClass),o.options.lineNumbers&&(!b||!b["CodeMirror-linenumbers"])&&(d.lineNumber=T.appendChild(F("div",ce(o.options,f),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+p.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+o.display.lineNumInnerWidth+"px"))),b)for(var I=0;I<o.display.gutterSpecs.length;++I){var A=o.display.gutterSpecs[I].className,$=b.hasOwnProperty(A)&&b[A];$&&T.appendChild(F("div",[$],"CodeMirror-gutter-elt","left: "+p.gutterLeft[A]+"px; width: "+p.gutterWidth[A]+"px"))}}}function LR(o,d,f){d.alignable&&(d.alignable=null);for(var p=H("CodeMirror-linewidget"),m=d.node.firstChild,b=void 0;m;m=b)b=m.nextSibling,p.test(m.className)&&d.node.removeChild(m);y0(o,d,f)}function IR(o,d,f,p){var m=m0(o,d);return d.text=d.node=m.pre,m.bgClass&&(d.bgClass=m.bgClass),m.textClass&&(d.textClass=m.textClass),jh(o,d),v0(o,d,f,p),y0(o,d,p),d.node}function y0(o,d,f){if(b0(o,d.line,d,f,!0),d.rest)for(var p=0;p<d.rest.length;p++)b0(o,d.rest[p],d,f,!1)}function b0(o,d,f,p,m){if(d.widgets)for(var b=nl(f),x=0,T=d.widgets;x<T.length;++x){var I=T[x],A=F("div",[I.node],"CodeMirror-linewidget"+(I.className?" "+I.className:""));I.handleMouseEvents||A.setAttribute("cm-ignore-events","true"),DR(I,A,f,p),o.display.input.setUneditable(A),m&&I.above?b.insertBefore(A,f.gutter||f.text):b.appendChild(A),$t(I,"redraw")}}function DR(o,d,f,p){if(o.noHScroll){(f.alignable||(f.alignable=[])).push(d);var m=p.wrapperWidth;d.style.left=p.fixedPos+"px",o.coverGutter||(m-=p.gutterTotalWidth,d.style.paddingLeft=p.gutterTotalWidth+"px"),d.style.width=m+"px"}o.coverGutter&&(d.style.zIndex=5,d.style.position="relative",o.noHScroll||(d.style.marginLeft=-p.gutterTotalWidth+"px"))}function rl(o){if(o.height!=null)return o.height;var d=o.doc.cm;if(!d)return 0;if(!Re(document.body,o.node)){var f="position: relative;";o.coverGutter&&(f+="margin-left: -"+d.display.gutters.offsetWidth+"px;"),o.noHScroll&&(f+="width: "+d.display.wrapper.clientWidth+"px;"),z(d.display.measure,F("div",[o.node],null,f))}return o.height=o.node.parentNode.offsetHeight}function ui(o,d){for(var f=Yo(d);f!=o.wrapper;f=f.parentNode)if(!f||f.nodeType==1&&f.getAttribute("cm-ignore-events")=="true"||f.parentNode==o.sizer&&f!=o.mover)return!0}function ec(o){return o.lineSpace.offsetTop}function Hh(o){return o.mover.offsetHeight-o.lineSpace.offsetHeight}function w0(o){if(o.cachedPaddingH)return o.cachedPaddingH;var d=z(o.measure,F("pre","x","CodeMirror-line-like")),f=window.getComputedStyle?window.getComputedStyle(d):d.currentStyle,p={left:parseInt(f.paddingLeft),right:parseInt(f.paddingRight)};return!isNaN(p.left)&&!isNaN(p.right)&&(o.cachedPaddingH=p),p}function Fr(o){return Ye-o.display.nativeBarWidth}function Rs(o){return o.display.scroller.clientWidth-Fr(o)-o.display.barWidth}function qh(o){return o.display.scroller.clientHeight-Fr(o)-o.display.barHeight}function PR(o,d,f){var p=o.options.lineWrapping,m=p&&Rs(o);if(!d.measure.heights||p&&d.measure.width!=m){var b=d.measure.heights=[];if(p){d.measure.width=m;for(var x=d.text.firstChild.getClientRects(),T=0;T<x.length-1;T++){var I=x[T],A=x[T+1];Math.abs(I.bottom-A.bottom)>2&&b.push((I.bottom+A.top)/2-f.top)}}b.push(f.bottom-f.top)}}function S0(o,d,f){if(o.line==d)return{map:o.measure.map,cache:o.measure.cache};if(o.rest){for(var p=0;p<o.rest.length;p++)if(o.rest[p]==d)return{map:o.measure.maps[p],cache:o.measure.caches[p]};for(var m=0;m<o.rest.length;m++)if(N(o.rest[m])>f)return{map:o.measure.maps[m],cache:o.measure.caches[m],before:!0}}}function RR(o,d){d=wr(d);var f=N(d),p=o.display.externalMeasured=new f0(o.doc,d,f);p.lineN=f;var m=p.built=h0(o,p);return p.text=m.pre,z(o.display.lineMeasure,m.pre),p}function C0(o,d,f,p){return _r(o,xa(o,d),f,p)}function Jh(o,d){if(d>=o.display.viewFrom&&d<o.display.viewTo)return o.display.view[Ns(o,d)];var f=o.display.externalMeasured;if(f&&d>=f.lineN&&d<f.lineN+f.size)return f}function xa(o,d){var f=N(d),p=Jh(o,f);p&&!p.text?p=null:p&&p.changes&&(g0(o,p,f,Qh(o)),o.curOp.forceUpdate=!0),p||(p=RR(o,d));var m=S0(p,d,f);return{line:d,view:p,rect:null,map:m.map,cache:m.cache,before:m.before,hasHeights:!1}}function _r(o,d,f,p,m){d.before&&(f=-1);var b=f+(p||""),x;return d.cache.hasOwnProperty(b)?x=d.cache[b]:(d.rect||(d.rect=d.view.text.getBoundingClientRect()),d.hasHeights||(PR(o,d.view,d.rect),d.hasHeights=!0),x=AR(o,d,f,p),x.bogus||(d.cache[b]=x)),{left:x.left,right:x.right,top:m?x.rtop:x.top,bottom:m?x.rbottom:x.bottom}}var x0={left:0,right:0,top:0,bottom:0};function E0(o,d,f){for(var p,m,b,x,T,I,A=0;A<o.length;A+=3)if(T=o[A],I=o[A+1],d<T?(m=0,b=1,x="left"):d<I?(m=d-T,b=m+1):(A==o.length-3||d==I&&o[A+3]>d)&&(b=I-T,m=b-1,d>=I&&(x="right")),m!=null){if(p=o[A+2],T==I&&f==(p.insertLeft?"left":"right")&&(x=f),f=="left"&&m==0)for(;A&&o[A-2]==o[A-3]&&o[A-1].insertLeft;)p=o[(A-=3)+2],x="left";if(f=="right"&&m==I-T)for(;A<o.length-3&&o[A+3]==o[A+4]&&!o[A+5].insertLeft;)p=o[(A+=3)+2],x="right";break}return{node:p,start:m,end:b,collapse:x,coverStart:T,coverEnd:I}}function MR(o,d){var f=x0;if(d=="left")for(var p=0;p<o.length&&(f=o[p]).left==f.right;p++);else for(var m=o.length-1;m>=0&&(f=o[m]).left==f.right;m--);return f}function AR(o,d,f,p){var m=E0(d.map,f,p),b=m.node,x=m.start,T=m.end,I=m.collapse,A;if(b.nodeType==3){for(var $=0;$<4;$++){for(;x&&Rt(d.line.text.charAt(m.coverStart+x));)--x;for(;m.coverStart+T<m.coverEnd&&Rt(d.line.text.charAt(m.coverStart+T));)++T;if(c&&u<9&&x==0&&T==m.coverEnd-m.coverStart?A=b.parentNode.getBoundingClientRect():A=MR(oe(b,x,T).getClientRects(),p),A.left||A.right||x==0)break;T=x,x=x-1,I="right"}c&&u<11&&(A=NR(o.display.measure,A))}else{x>0&&(I=p="right");var W;o.options.lineWrapping&&(W=b.getClientRects()).length>1?A=W[p=="right"?W.length-1:0]:A=b.getBoundingClientRect()}if(c&&u<9&&!x&&(!A||!A.left&&!A.right)){var Y=b.parentNode.getClientRects()[0];Y?A={left:Y.left,right:Y.left+Ta(o.display),top:Y.top,bottom:Y.bottom}:A=x0}for(var J=A.top-d.rect.top,Q=A.bottom-d.rect.top,re=(J+Q)/2,ue=d.view.measure.heights,pe=0;pe<ue.length-1&&!(re<ue[pe]);pe++);var be=pe?ue[pe-1]:0,fe=ue[pe],xe={left:(I=="right"?A.right:A.left)-d.rect.left,right:(I=="left"?A.left:A.right)-d.rect.left,top:be,bottom:fe};return!A.left&&!A.right&&(xe.bogus=!0),o.options.singleCursorHeightPerLine||(xe.rtop=J,xe.rbottom=Q),xe}function NR(o,d){if(!window.screen||screen.logicalXDPI==null||screen.logicalXDPI==screen.deviceXDPI||!Bh(o))return d;var f=screen.logicalXDPI/screen.deviceXDPI,p=screen.logicalYDPI/screen.deviceYDPI;return{left:d.left*f,right:d.right*f,top:d.top*p,bottom:d.bottom*p}}function T0(o){if(o.measure&&(o.measure.cache={},o.measure.heights=null,o.rest))for(var d=0;d<o.rest.length;d++)o.measure.caches[d]={}}function k0(o){o.display.externalMeasure=null,O(o.display.lineMeasure);for(var d=0;d<o.display.view.length;d++)T0(o.display.view[d])}function il(o){k0(o),o.display.cachedCharWidth=o.display.cachedTextHeight=o.display.cachedPaddingH=null,o.options.lineWrapping||(o.display.maxLineChanged=!0),o.display.lineNumChars=null}function L0(o){return v&&P?-(o.body.getBoundingClientRect().left-parseInt(getComputedStyle(o.body).marginLeft)):o.defaultView.pageXOffset||(o.documentElement||o.body).scrollLeft}function I0(o){return v&&P?-(o.body.getBoundingClientRect().top-parseInt(getComputedStyle(o.body).marginTop)):o.defaultView.pageYOffset||(o.documentElement||o.body).scrollTop}function Yh(o){var d=wr(o),f=d.widgets,p=0;if(f)for(var m=0;m<f.length;++m)f[m].above&&(p+=rl(f[m]));return p}function tc(o,d,f,p,m){if(!m){var b=Yh(d);f.top+=b,f.bottom+=b}if(p=="line")return f;p||(p="local");var x=ci(d);if(p=="local"?x+=ec(o.display):x-=o.display.viewOffset,p=="page"||p=="window"){var T=o.display.lineSpace.getBoundingClientRect();x+=T.top+(p=="window"?0:I0(Le(o)));var I=T.left+(p=="window"?0:L0(Le(o)));f.left+=I,f.right+=I}return f.top+=x,f.bottom+=x,f}function D0(o,d,f){if(f=="div")return d;var p=d.left,m=d.top;if(f=="page")p-=L0(Le(o)),m-=I0(Le(o));else if(f=="local"||!f){var b=o.display.sizer.getBoundingClientRect();p+=b.left,m+=b.top}var x=o.display.lineSpace.getBoundingClientRect();return{left:p-x.left,top:m-x.top}}function nc(o,d,f,p,m){return p||(p=Ie(o.doc,d.line)),tc(o,p,C0(o,p,d.ch,m),f)}function Sr(o,d,f,p,m,b){p=p||Ie(o.doc,d.line),m||(m=xa(o,p));function x(Q,re){var ue=_r(o,m,Q,re?"right":"left",b);return re?ue.left=ue.right:ue.right=ue.left,tc(o,p,ue,f)}var T=qe(p,o.doc.direction),I=d.ch,A=d.sticky;if(I>=p.text.length?(I=p.text.length,A="before"):I<=0&&(I=0,A="after"),!T)return x(A=="before"?I-1:I,A=="before");function $(Q,re,ue){var pe=T[re],be=pe.level==1;return x(ue?Q-1:Q,be!=ue)}var W=Gi(T,I,A),Y=Ps,J=$(I,W,A=="before");return Y!=null&&(J.other=$(I,Y,A!="before")),J}function P0(o,d){var f=0;d=$e(o.doc,d),o.options.lineWrapping||(f=Ta(o.display)*d.ch);var p=Ie(o.doc,d.line),m=ci(p)+ec(o.display);return{left:f,right:f,top:m,bottom:m+p.height}}function Xh(o,d,f,p,m){var b=Z(o,d,f);return b.xRel=m,p&&(b.outside=p),b}function Kh(o,d,f){var p=o.doc;if(f+=o.display.viewOffset,f<0)return Xh(p.first,0,null,-1,-1);var m=G(p,f),b=p.first+p.size-1;if(m>b)return Xh(p.first+p.size-1,Ie(p,b).text.length,null,1,1);d<0&&(d=0);for(var x=Ie(p,m);;){var T=VR(o,x,m,d,f),I=dR(x,T.ch+(T.xRel>0||T.outside>0?1:0));if(!I)return T;var A=I.find(1);if(A.line==m)return A;x=Ie(p,m=A.line)}}function R0(o,d,f,p){p-=Yh(d);var m=d.text.length,b=Vr(function(x){return _r(o,f,x-1).bottom<=p},m,0);return m=Vr(function(x){return _r(o,f,x).top>p},b,m),{begin:b,end:m}}function M0(o,d,f,p){f||(f=xa(o,d));var m=tc(o,d,_r(o,f,p),"line").top;return R0(o,d,f,m)}function Zh(o,d,f,p){return o.bottom<=f?!1:o.top>f?!0:(p?o.left:o.right)>d}function VR(o,d,f,p,m){m-=ci(d);var b=xa(o,d),x=Yh(d),T=0,I=d.text.length,A=!0,$=qe(d,o.doc.direction);if($){var W=(o.options.lineWrapping?BR:OR)(o,d,f,b,$,p,m);A=W.level!=1,T=A?W.from:W.to-1,I=A?W.to:W.from-1}var Y=null,J=null,Q=Vr(function(Be){var Ae=_r(o,b,Be);return Ae.top+=x,Ae.bottom+=x,Zh(Ae,p,m,!1)?(Ae.top<=m&&Ae.left<=p&&(Y=Be,J=Ae),!0):!1},T,I),re,ue,pe=!1;if(J){var be=p-J.left<J.right-p,fe=be==A;Q=Y+(fe?0:1),ue=fe?"after":"before",re=be?J.left:J.right}else{!A&&(Q==I||Q==T)&&Q++,ue=Q==0?"after":Q==d.text.length?"before":_r(o,b,Q-(A?1:0)).bottom+x<=m==A?"after":"before";var xe=Sr(o,Z(f,Q,ue),"line",d,b);re=xe.left,pe=m<xe.top?-1:m>=xe.bottom?1:0}return Q=$i(d.text,Q,1),Xh(f,Q,ue,pe,p-re)}function OR(o,d,f,p,m,b,x){var T=Vr(function(W){var Y=m[W],J=Y.level!=1;return Zh(Sr(o,Z(f,J?Y.to:Y.from,J?"before":"after"),"line",d,p),b,x,!0)},0,m.length-1),I=m[T];if(T>0){var A=I.level!=1,$=Sr(o,Z(f,A?I.from:I.to,A?"after":"before"),"line",d,p);Zh($,b,x,!0)&&$.top>x&&(I=m[T-1])}return I}function BR(o,d,f,p,m,b,x){var T=R0(o,d,p,x),I=T.begin,A=T.end;/\s/.test(d.text.charAt(A-1))&&A--;for(var $=null,W=null,Y=0;Y<m.length;Y++){var J=m[Y];if(!(J.from>=A||J.to<=I)){var Q=J.level!=1,re=_r(o,p,Q?Math.min(A,J.to)-1:Math.max(I,J.from)).right,ue=re<b?b-re+1e9:re-b;(!$||W>ue)&&($=J,W=ue)}}return $||($=m[m.length-1]),$.from<I&&($={from:I,to:$.to,level:$.level}),$.to>A&&($={from:$.from,to:A,level:$.level}),$}var Ms;function Ea(o){if(o.cachedTextHeight!=null)return o.cachedTextHeight;if(Ms==null){Ms=F("pre",null,"CodeMirror-line-like");for(var d=0;d<49;++d)Ms.appendChild(document.createTextNode("x")),Ms.appendChild(F("br"));Ms.appendChild(document.createTextNode("x"))}z(o.measure,Ms);var f=Ms.offsetHeight/50;return f>3&&(o.cachedTextHeight=f),O(o.measure),f||1}function Ta(o){if(o.cachedCharWidth!=null)return o.cachedCharWidth;var d=F("span","xxxxxxxxxx"),f=F("pre",[d],"CodeMirror-line-like");z(o.measure,f);var p=d.getBoundingClientRect(),m=(p.right-p.left)/10;return m>2&&(o.cachedCharWidth=m),m||10}function Qh(o){for(var d=o.display,f={},p={},m=d.gutters.clientLeft,b=d.gutters.firstChild,x=0;b;b=b.nextSibling,++x){var T=o.display.gutterSpecs[x].className;f[T]=b.offsetLeft+b.clientLeft+m,p[T]=b.clientWidth}return{fixedPos:ep(d),gutterTotalWidth:d.gutters.offsetWidth,gutterLeft:f,gutterWidth:p,wrapperWidth:d.wrapper.clientWidth}}function ep(o){return o.scroller.getBoundingClientRect().left-o.sizer.getBoundingClientRect().left}function A0(o){var d=Ea(o.display),f=o.options.lineWrapping,p=f&&Math.max(5,o.display.scroller.clientWidth/Ta(o.display)-3);return function(m){if(Ji(o.doc,m))return 0;var b=0;if(m.widgets)for(var x=0;x<m.widgets.length;x++)m.widgets[x].height&&(b+=m.widgets[x].height);return f?b+(Math.ceil(m.text.length/p)||1)*d:b+d}}function tp(o){var d=o.doc,f=A0(o);d.iter(function(p){var m=f(p);m!=p.height&&Wn(p,m)})}function As(o,d,f,p){var m=o.display;if(!f&&Yo(d).getAttribute("cm-not-content")=="true")return null;var b,x,T=m.lineSpace.getBoundingClientRect();try{b=d.clientX-T.left,x=d.clientY-T.top}catch{return null}var I=Kh(o,b,x),A;if(p&&I.xRel>0&&(A=Ie(o.doc,I.line).text).length==I.ch){var $=Fe(A,A.length,o.options.tabSize)-A.length;I=Z(I.line,Math.max(0,Math.round((b-w0(o.display).left)/Ta(o.display))-$))}return I}function Ns(o,d){if(d>=o.display.viewTo||(d-=o.display.viewFrom,d<0))return null;for(var f=o.display.view,p=0;p<f.length;p++)if(d-=f[p].size,d<0)return p}function xn(o,d,f,p){d==null&&(d=o.doc.first),f==null&&(f=o.doc.first+o.doc.size),p||(p=0);var m=o.display;if(p&&f<m.viewTo&&(m.updateLineNumbers==null||m.updateLineNumbers>d)&&(m.updateLineNumbers=d),o.curOp.viewChanged=!0,d>=m.viewTo)di&&zh(o.doc,d)<m.viewTo&&Xi(o);else if(f<=m.viewFrom)di&&c0(o.doc,f+p)>m.viewFrom?Xi(o):(m.viewFrom+=p,m.viewTo+=p);else if(d<=m.viewFrom&&f>=m.viewTo)Xi(o);else if(d<=m.viewFrom){var b=rc(o,f,f+p,1);b?(m.view=m.view.slice(b.index),m.viewFrom=b.lineN,m.viewTo+=p):Xi(o)}else if(f>=m.viewTo){var x=rc(o,d,d,-1);x?(m.view=m.view.slice(0,x.index),m.viewTo=x.lineN):Xi(o)}else{var T=rc(o,d,d,-1),I=rc(o,f,f+p,1);T&&I?(m.view=m.view.slice(0,T.index).concat(Qd(o,T.lineN,I.lineN)).concat(m.view.slice(I.index)),m.viewTo+=p):Xi(o)}var A=m.externalMeasured;A&&(f<A.lineN?A.lineN+=p:d<A.lineN+A.size&&(m.externalMeasured=null))}function Yi(o,d,f){o.curOp.viewChanged=!0;var p=o.display,m=o.display.externalMeasured;if(m&&d>=m.lineN&&d<m.lineN+m.size&&(p.externalMeasured=null),!(d<p.viewFrom||d>=p.viewTo)){var b=p.view[Ns(o,d)];if(b.node!=null){var x=b.changes||(b.changes=[]);Ce(x,f)==-1&&x.push(f)}}}function Xi(o){o.display.viewFrom=o.display.viewTo=o.doc.first,o.display.view=[],o.display.viewOffset=0}function rc(o,d,f,p){var m=Ns(o,d),b,x=o.display.view;if(!di||f==o.doc.first+o.doc.size)return{index:m,lineN:f};for(var T=o.display.viewFrom,I=0;I<m;I++)T+=x[I].size;if(T!=d){if(p>0){if(m==x.length-1)return null;b=T+x[m].size-d,m++}else b=T-d;d+=b,f+=b}for(;zh(o.doc,f)!=f;){if(m==(p<0?0:x.length-1))return null;f+=p*x[m-(p<0?1:0)].size,m+=p}return{index:m,lineN:f}}function FR(o,d,f){var p=o.display,m=p.view;m.length==0||d>=p.viewTo||f<=p.viewFrom?(p.view=Qd(o,d,f),p.viewFrom=d):(p.viewFrom>d?p.view=Qd(o,d,p.viewFrom).concat(p.view):p.viewFrom<d&&(p.view=p.view.slice(Ns(o,d))),p.viewFrom=d,p.viewTo<f?p.view=p.view.concat(Qd(o,p.viewTo,f)):p.viewTo>f&&(p.view=p.view.slice(0,Ns(o,f)))),p.viewTo=f}function N0(o){for(var d=o.display.view,f=0,p=0;p<d.length;p++){var m=d[p];!m.hidden&&(!m.node||m.changes)&&++f}return f}function sl(o){o.display.input.showSelection(o.display.input.prepareSelection())}function V0(o,d){d===void 0&&(d=!0);var f=o.doc,p={},m=p.cursors=document.createDocumentFragment(),b=p.selection=document.createDocumentFragment(),x=o.options.$customCursor;x&&(d=!0);for(var T=0;T<f.sel.ranges.length;T++)if(!(!d&&T==f.sel.primIndex)){var I=f.sel.ranges[T];if(!(I.from().line>=o.display.viewTo||I.to().line<o.display.viewFrom)){var A=I.empty();if(x){var $=x(o,I);$&&np(o,$,m)}else(A||o.options.showCursorWhenSelecting)&&np(o,I.head,m);A||_R(o,I,b)}}return p}function np(o,d,f){var p=Sr(o,d,"div",null,null,!o.options.singleCursorHeightPerLine),m=f.appendChild(F("div"," ","CodeMirror-cursor"));if(m.style.left=p.left+"px",m.style.top=p.top+"px",m.style.height=Math.max(0,p.bottom-p.top)*o.options.cursorHeight+"px",/\bcm-fat-cursor\b/.test(o.getWrapperElement().className)){var b=nc(o,d,"div",null,null),x=b.right-b.left;m.style.width=(x>0?x:o.defaultCharWidth())+"px"}if(p.other){var T=f.appendChild(F("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));T.style.display="",T.style.left=p.other.left+"px",T.style.top=p.other.top+"px",T.style.height=(p.other.bottom-p.other.top)*.85+"px"}}function ic(o,d){return o.top-d.top||o.left-d.left}function _R(o,d,f){var p=o.display,m=o.doc,b=document.createDocumentFragment(),x=w0(o.display),T=x.left,I=Math.max(p.sizerWidth,Rs(o)-p.sizer.offsetLeft)-x.right,A=m.direction=="ltr";function $(fe,xe,Be,Ae){xe<0&&(xe=0),xe=Math.round(xe),Ae=Math.round(Ae),b.appendChild(F("div",null,"CodeMirror-selected","position: absolute; left: "+fe+`px;
                             top: `+xe+"px; width: "+(Be??I-fe)+`px;
                             height: `+(Ae-xe)+"px"))}function W(fe,xe,Be){var Ae=Ie(m,fe),je=Ae.text.length,ht,Wt;function yt(Mt,kn){return nc(o,Z(fe,Mt),"div",Ae,kn)}function Bn(Mt,kn,Kt){var Bt=M0(o,Ae,null,Mt),At=kn=="ltr"==(Kt=="after")?"left":"right",Ct=Kt=="after"?Bt.begin:Bt.end-(/\s/.test(Ae.text.charAt(Bt.end-1))?2:1);return yt(Ct,At)[At]}var Tn=qe(Ae,m.direction);return zi(Tn,xe||0,Be??je,function(Mt,kn,Kt,Bt){var At=Kt=="ltr",Ct=yt(Mt,At?"left":"right"),Ln=yt(kn-1,At?"right":"left"),Fa=xe==null&&Mt==0,ns=Be==null&&kn==je,sn=Bt==0,Ur=!Tn||Bt==Tn.length-1;if(Ln.top-Ct.top<=3){var jt=(A?Fa:ns)&&sn,Dp=(A?ns:Fa)&&Ur,fi=jt?T:(At?Ct:Ln).left,_s=Dp?I:(At?Ln:Ct).right;$(fi,Ct.top,_s-fi,Ct.bottom)}else{var Us,un,_a,Pp;At?(Us=A&&Fa&&sn?T:Ct.left,un=A?I:Bn(Mt,Kt,"before"),_a=A?T:Bn(kn,Kt,"after"),Pp=A&&ns&&Ur?I:Ln.right):(Us=A?Bn(Mt,Kt,"before"):T,un=!A&&Fa&&sn?I:Ct.right,_a=!A&&ns&&Ur?T:Ln.left,Pp=A?Bn(kn,Kt,"after"):I),$(Us,Ct.top,un-Us,Ct.bottom),Ct.bottom<Ln.top&&$(T,Ct.bottom,null,Ln.top),$(_a,Ln.top,Pp-_a,Ln.bottom)}(!ht||ic(Ct,ht)<0)&&(ht=Ct),ic(Ln,ht)<0&&(ht=Ln),(!Wt||ic(Ct,Wt)<0)&&(Wt=Ct),ic(Ln,Wt)<0&&(Wt=Ln)}),{start:ht,end:Wt}}var Y=d.from(),J=d.to();if(Y.line==J.line)W(Y.line,Y.ch,J.ch);else{var Q=Ie(m,Y.line),re=Ie(m,J.line),ue=wr(Q)==wr(re),pe=W(Y.line,Y.ch,ue?Q.text.length+1:null).end,be=W(J.line,ue?0:null,J.ch).start;ue&&(pe.top<be.top-2?($(pe.right,pe.top,null,pe.bottom),$(T,be.top,be.left,be.bottom)):$(pe.right,pe.top,be.left-pe.right,pe.bottom)),pe.bottom<be.top&&$(T,pe.bottom,null,be.top)}f.appendChild(b)}function rp(o){if(o.state.focused){var d=o.display;clearInterval(d.blinker);var f=!0;d.cursorDiv.style.visibility="",o.options.cursorBlinkRate>0?d.blinker=setInterval(function(){o.hasFocus()||ka(o),d.cursorDiv.style.visibility=(f=!f)?"":"hidden"},o.options.cursorBlinkRate):o.options.cursorBlinkRate<0&&(d.cursorDiv.style.visibility="hidden")}}function O0(o){o.hasFocus()||(o.display.input.focus(),o.state.focused||sp(o))}function ip(o){o.state.delayingBlurEvent=!0,setTimeout(function(){o.state.delayingBlurEvent&&(o.state.delayingBlurEvent=!1,o.state.focused&&ka(o))},100)}function sp(o,d){o.state.delayingBlurEvent&&!o.state.draggingText&&(o.state.delayingBlurEvent=!1),o.options.readOnly!="nocursor"&&(o.state.focused||(bt(o,"focus",o,d),o.state.focused=!0,Se(o.display.wrapper,"CodeMirror-focused"),!o.curOp&&o.display.selForContextMenu!=o.doc.sel&&(o.display.input.reset(),h&&setTimeout(function(){return o.display.input.reset(!0)},20)),o.display.input.receivedFocus()),rp(o))}function ka(o,d){o.state.delayingBlurEvent||(o.state.focused&&(bt(o,"blur",o,d),o.state.focused=!1,U(o.display.wrapper,"CodeMirror-focused")),clearInterval(o.display.blinker),setTimeout(function(){o.state.focused||(o.display.shift=!1)},150))}function sc(o){for(var d=o.display,f=d.lineDiv.offsetTop,p=Math.max(0,d.scroller.getBoundingClientRect().top),m=d.lineDiv.getBoundingClientRect().top,b=0,x=0;x<d.view.length;x++){var T=d.view[x],I=o.options.lineWrapping,A=void 0,$=0;if(!T.hidden){if(m+=T.line.height,c&&u<8){var W=T.node.offsetTop+T.node.offsetHeight;A=W-f,f=W}else{var Y=T.node.getBoundingClientRect();A=Y.bottom-Y.top,!I&&T.text.firstChild&&($=T.text.firstChild.getBoundingClientRect().right-Y.left-1)}var J=T.line.height-A;if((J>.005||J<-.005)&&(m<p&&(b-=J),Wn(T.line,A),B0(T.line),T.rest))for(var Q=0;Q<T.rest.length;Q++)B0(T.rest[Q]);if($>o.display.sizerWidth){var re=Math.ceil($/Ta(o.display));re>o.display.maxLineLength&&(o.display.maxLineLength=re,o.display.maxLine=T.line,o.display.maxLineChanged=!0)}}}Math.abs(b)>2&&(d.scroller.scrollTop+=b)}function B0(o){if(o.widgets)for(var d=0;d<o.widgets.length;++d){var f=o.widgets[d],p=f.node.parentNode;p&&(f.height=p.offsetHeight)}}function ac(o,d,f){var p=f&&f.top!=null?Math.max(0,f.top):o.scroller.scrollTop;p=Math.floor(p-ec(o));var m=f&&f.bottom!=null?f.bottom:p+o.wrapper.clientHeight,b=G(d,p),x=G(d,m);if(f&&f.ensure){var T=f.ensure.from.line,I=f.ensure.to.line;T<b?(b=T,x=G(d,ci(Ie(d,T))+o.wrapper.clientHeight)):Math.min(I,d.lastLine())>=x&&(b=G(d,ci(Ie(d,I))-o.wrapper.clientHeight),x=I)}return{from:b,to:Math.max(x,b+1)}}function UR(o,d){if(!wt(o,"scrollCursorIntoView")){var f=o.display,p=f.sizer.getBoundingClientRect(),m=null,b=f.wrapper.ownerDocument;if(d.top+p.top<0?m=!0:d.bottom+p.top>(b.defaultView.innerHeight||b.documentElement.clientHeight)&&(m=!1),m!=null&&!E){var x=F("div","​",null,`position: absolute;
                         top: `+(d.top-f.viewOffset-ec(o.display))+`px;
                         height: `+(d.bottom-d.top+Fr(o)+f.barHeight)+`px;
                         left: `+d.left+"px; width: "+Math.max(2,d.right-d.left)+"px;");o.display.lineSpace.appendChild(x),x.scrollIntoView(m),o.display.lineSpace.removeChild(x)}}}function $R(o,d,f,p){p==null&&(p=0);var m;!o.options.lineWrapping&&d==f&&(f=d.sticky=="before"?Z(d.line,d.ch+1,"before"):d,d=d.ch?Z(d.line,d.sticky=="before"?d.ch-1:d.ch,"after"):d);for(var b=0;b<5;b++){var x=!1,T=Sr(o,d),I=!f||f==d?T:Sr(o,f);m={left:Math.min(T.left,I.left),top:Math.min(T.top,I.top)-p,right:Math.max(T.left,I.left),bottom:Math.max(T.bottom,I.bottom)+p};var A=ap(o,m),$=o.doc.scrollTop,W=o.doc.scrollLeft;if(A.scrollTop!=null&&(ol(o,A.scrollTop),Math.abs(o.doc.scrollTop-$)>1&&(x=!0)),A.scrollLeft!=null&&(Vs(o,A.scrollLeft),Math.abs(o.doc.scrollLeft-W)>1&&(x=!0)),!x)break}return m}function zR(o,d){var f=ap(o,d);f.scrollTop!=null&&ol(o,f.scrollTop),f.scrollLeft!=null&&Vs(o,f.scrollLeft)}function ap(o,d){var f=o.display,p=Ea(o.display);d.top<0&&(d.top=0);var m=o.curOp&&o.curOp.scrollTop!=null?o.curOp.scrollTop:f.scroller.scrollTop,b=qh(o),x={};d.bottom-d.top>b&&(d.bottom=d.top+b);var T=o.doc.height+Hh(f),I=d.top<p,A=d.bottom>T-p;if(d.top<m)x.scrollTop=I?0:d.top;else if(d.bottom>m+b){var $=Math.min(d.top,(A?T:d.bottom)-b);$!=m&&(x.scrollTop=$)}var W=o.options.fixedGutter?0:f.gutters.offsetWidth,Y=o.curOp&&o.curOp.scrollLeft!=null?o.curOp.scrollLeft:f.scroller.scrollLeft-W,J=Rs(o)-f.gutters.offsetWidth,Q=d.right-d.left>J;return Q&&(d.right=d.left+J),d.left<10?x.scrollLeft=0:d.left<Y?x.scrollLeft=Math.max(0,d.left+W-(Q?0:10)):d.right>J+Y-3&&(x.scrollLeft=d.right+(Q?0:10)-J),x}function op(o,d){d!=null&&(oc(o),o.curOp.scrollTop=(o.curOp.scrollTop==null?o.doc.scrollTop:o.curOp.scrollTop)+d)}function La(o){oc(o);var d=o.getCursor();o.curOp.scrollToPos={from:d,to:d,margin:o.options.cursorScrollMargin}}function al(o,d,f){(d!=null||f!=null)&&oc(o),d!=null&&(o.curOp.scrollLeft=d),f!=null&&(o.curOp.scrollTop=f)}function GR(o,d){oc(o),o.curOp.scrollToPos=d}function oc(o){var d=o.curOp.scrollToPos;if(d){o.curOp.scrollToPos=null;var f=P0(o,d.from),p=P0(o,d.to);F0(o,f,p,d.margin)}}function F0(o,d,f,p){var m=ap(o,{left:Math.min(d.left,f.left),top:Math.min(d.top,f.top)-p,right:Math.max(d.right,f.right),bottom:Math.max(d.bottom,f.bottom)+p});al(o,m.scrollLeft,m.scrollTop)}function ol(o,d){Math.abs(o.doc.scrollTop-d)<2||(i||dp(o,{top:d}),_0(o,d,!0),i&&dp(o),cl(o,100))}function _0(o,d,f){d=Math.max(0,Math.min(o.display.scroller.scrollHeight-o.display.scroller.clientHeight,d)),!(o.display.scroller.scrollTop==d&&!f)&&(o.doc.scrollTop=d,o.display.scrollbars.setScrollTop(d),o.display.scroller.scrollTop!=d&&(o.display.scroller.scrollTop=d))}function Vs(o,d,f,p){d=Math.max(0,Math.min(d,o.display.scroller.scrollWidth-o.display.scroller.clientWidth)),!((f?d==o.doc.scrollLeft:Math.abs(o.doc.scrollLeft-d)<2)&&!p)&&(o.doc.scrollLeft=d,W0(o),o.display.scroller.scrollLeft!=d&&(o.display.scroller.scrollLeft=d),o.display.scrollbars.setScrollLeft(d))}function ll(o){var d=o.display,f=d.gutters.offsetWidth,p=Math.round(o.doc.height+Hh(o.display));return{clientHeight:d.scroller.clientHeight,viewHeight:d.wrapper.clientHeight,scrollWidth:d.scroller.scrollWidth,clientWidth:d.scroller.clientWidth,viewWidth:d.wrapper.clientWidth,barLeft:o.options.fixedGutter?f:0,docHeight:p,scrollHeight:p+Fr(o)+d.barHeight,nativeBarWidth:d.nativeBarWidth,gutterWidth:f}}var Os=function(o,d,f){this.cm=f;var p=this.vert=F("div",[F("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),m=this.horiz=F("div",[F("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");p.tabIndex=m.tabIndex=-1,o(p),o(m),Ve(p,"scroll",function(){p.clientHeight&&d(p.scrollTop,"vertical")}),Ve(m,"scroll",function(){m.clientWidth&&d(m.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,c&&u<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};Os.prototype.update=function(o){var d=o.scrollWidth>o.clientWidth+1,f=o.scrollHeight>o.clientHeight+1,p=o.nativeBarWidth;if(f){this.vert.style.display="block",this.vert.style.bottom=d?p+"px":"0";var m=o.viewHeight-(d?p:0);this.vert.firstChild.style.height=Math.max(0,o.scrollHeight-o.clientHeight+m)+"px"}else this.vert.scrollTop=0,this.vert.style.display="",this.vert.firstChild.style.height="0";if(d){this.horiz.style.display="block",this.horiz.style.right=f?p+"px":"0",this.horiz.style.left=o.barLeft+"px";var b=o.viewWidth-o.barLeft-(f?p:0);this.horiz.firstChild.style.width=Math.max(0,o.scrollWidth-o.clientWidth+b)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&o.clientHeight>0&&(p==0&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:f?p:0,bottom:d?p:0}},Os.prototype.setScrollLeft=function(o){this.horiz.scrollLeft!=o&&(this.horiz.scrollLeft=o),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},Os.prototype.setScrollTop=function(o){this.vert.scrollTop!=o&&(this.vert.scrollTop=o),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},Os.prototype.zeroWidthHack=function(){var o=L&&!w?"12px":"18px";this.horiz.style.height=this.vert.style.width=o,this.horiz.style.visibility=this.vert.style.visibility="hidden",this.disableHoriz=new Ue,this.disableVert=new Ue},Os.prototype.enableZeroWidthBar=function(o,d,f){o.style.visibility="";function p(){var m=o.getBoundingClientRect(),b=f=="vert"?document.elementFromPoint(m.right-1,(m.top+m.bottom)/2):document.elementFromPoint((m.right+m.left)/2,m.bottom-1);b!=o?o.style.visibility="hidden":d.set(1e3,p)}d.set(1e3,p)},Os.prototype.clear=function(){var o=this.horiz.parentNode;o.removeChild(this.horiz),o.removeChild(this.vert)};var dl=function(){};dl.prototype.update=function(){return{bottom:0,right:0}},dl.prototype.setScrollLeft=function(){},dl.prototype.setScrollTop=function(){},dl.prototype.clear=function(){};function Ia(o,d){d||(d=ll(o));var f=o.display.barWidth,p=o.display.barHeight;U0(o,d);for(var m=0;m<4&&f!=o.display.barWidth||p!=o.display.barHeight;m++)f!=o.display.barWidth&&o.options.lineWrapping&&sc(o),U0(o,ll(o)),f=o.display.barWidth,p=o.display.barHeight}function U0(o,d){var f=o.display,p=f.scrollbars.update(d);f.sizer.style.paddingRight=(f.barWidth=p.right)+"px",f.sizer.style.paddingBottom=(f.barHeight=p.bottom)+"px",f.heightForcer.style.borderBottom=p.bottom+"px solid transparent",p.right&&p.bottom?(f.scrollbarFiller.style.display="block",f.scrollbarFiller.style.height=p.bottom+"px",f.scrollbarFiller.style.width=p.right+"px"):f.scrollbarFiller.style.display="",p.bottom&&o.options.coverGutterNextToScrollbar&&o.options.fixedGutter?(f.gutterFiller.style.display="block",f.gutterFiller.style.height=p.bottom+"px",f.gutterFiller.style.width=d.gutterWidth+"px"):f.gutterFiller.style.display=""}var $0={native:Os,null:dl};function z0(o){o.display.scrollbars&&(o.display.scrollbars.clear(),o.display.scrollbars.addClass&&U(o.display.wrapper,o.display.scrollbars.addClass)),o.display.scrollbars=new $0[o.options.scrollbarStyle](function(d){o.display.wrapper.insertBefore(d,o.display.scrollbarFiller),Ve(d,"mousedown",function(){o.state.focused&&setTimeout(function(){return o.display.input.focus()},0)}),d.setAttribute("cm-not-content","true")},function(d,f){f=="horizontal"?Vs(o,d):ol(o,d)},o),o.display.scrollbars.addClass&&Se(o.display.wrapper,o.display.scrollbars.addClass)}var WR=0;function Bs(o){o.curOp={cm:o,viewChanged:!1,startHeight:o.doc.height,forceUpdate:!1,updateInput:0,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++WR,markArrays:null},SR(o.curOp)}function Fs(o){var d=o.curOp;d&&xR(d,function(f){for(var p=0;p<f.ops.length;p++)f.ops[p].cm.curOp=null;jR(f)})}function jR(o){for(var d=o.ops,f=0;f<d.length;f++)HR(d[f]);for(var p=0;p<d.length;p++)qR(d[p]);for(var m=0;m<d.length;m++)JR(d[m]);for(var b=0;b<d.length;b++)YR(d[b]);for(var x=0;x<d.length;x++)XR(d[x])}function HR(o){var d=o.cm,f=d.display;ZR(d),o.updateMaxLine&&Wh(d),o.mustUpdate=o.viewChanged||o.forceUpdate||o.scrollTop!=null||o.scrollToPos&&(o.scrollToPos.from.line<f.viewFrom||o.scrollToPos.to.line>=f.viewTo)||f.maxLineChanged&&d.options.lineWrapping,o.update=o.mustUpdate&&new lc(d,o.mustUpdate&&{top:o.scrollTop,ensure:o.scrollToPos},o.forceUpdate)}function qR(o){o.updatedDisplay=o.mustUpdate&&lp(o.cm,o.update)}function JR(o){var d=o.cm,f=d.display;o.updatedDisplay&&sc(d),o.barMeasure=ll(d),f.maxLineChanged&&!d.options.lineWrapping&&(o.adjustWidthTo=C0(d,f.maxLine,f.maxLine.text.length).left+3,d.display.sizerWidth=o.adjustWidthTo,o.barMeasure.scrollWidth=Math.max(f.scroller.clientWidth,f.sizer.offsetLeft+o.adjustWidthTo+Fr(d)+d.display.barWidth),o.maxScrollLeft=Math.max(0,f.sizer.offsetLeft+o.adjustWidthTo-Rs(d))),(o.updatedDisplay||o.selectionChanged)&&(o.preparedSelection=f.input.prepareSelection())}function YR(o){var d=o.cm;o.adjustWidthTo!=null&&(d.display.sizer.style.minWidth=o.adjustWidthTo+"px",o.maxScrollLeft<d.doc.scrollLeft&&Vs(d,Math.min(d.display.scroller.scrollLeft,o.maxScrollLeft),!0),d.display.maxLineChanged=!1);var f=o.focus&&o.focus==le(_e(d));o.preparedSelection&&d.display.input.showSelection(o.preparedSelection,f),(o.updatedDisplay||o.startHeight!=d.doc.height)&&Ia(d,o.barMeasure),o.updatedDisplay&&up(d,o.barMeasure),o.selectionChanged&&rp(d),d.state.focused&&o.updateInput&&d.display.input.reset(o.typing),f&&O0(o.cm)}function XR(o){var d=o.cm,f=d.display,p=d.doc;if(o.updatedDisplay&&G0(d,o.update),f.wheelStartX!=null&&(o.scrollTop!=null||o.scrollLeft!=null||o.scrollToPos)&&(f.wheelStartX=f.wheelStartY=null),o.scrollTop!=null&&_0(d,o.scrollTop,o.forceScroll),o.scrollLeft!=null&&Vs(d,o.scrollLeft,!0,!0),o.scrollToPos){var m=$R(d,$e(p,o.scrollToPos.from),$e(p,o.scrollToPos.to),o.scrollToPos.margin);UR(d,m)}var b=o.maybeHiddenMarkers,x=o.maybeUnhiddenMarkers;if(b)for(var T=0;T<b.length;++T)b[T].lines.length||bt(b[T],"hide");if(x)for(var I=0;I<x.length;++I)x[I].lines.length&&bt(x[I],"unhide");f.wrapper.offsetHeight&&(p.scrollTop=d.display.scroller.scrollTop),o.changeObjs&&bt(d,"changes",d,o.changeObjs),o.update&&o.update.finish()}function On(o,d){if(o.curOp)return d();Bs(o);try{return d()}finally{Fs(o)}}function zt(o,d){return function(){if(o.curOp)return d.apply(o,arguments);Bs(o);try{return d.apply(o,arguments)}finally{Fs(o)}}}function cn(o){return function(){if(this.curOp)return o.apply(this,arguments);Bs(this);try{return o.apply(this,arguments)}finally{Fs(this)}}}function Gt(o){return function(){var d=this.cm;if(!d||d.curOp)return o.apply(this,arguments);Bs(d);try{return o.apply(this,arguments)}finally{Fs(d)}}}function cl(o,d){o.doc.highlightFrontier<o.display.viewTo&&o.state.highlight.set(d,Ee(KR,o))}function KR(o){var d=o.doc;if(!(d.highlightFrontier>=o.display.viewTo)){var f=+new Date+o.options.workTime,p=Qo(o,d.highlightFrontier),m=[];d.iter(p.line,Math.min(d.first+d.size,o.display.viewTo+500),function(b){if(p.line>=o.display.viewFrom){var x=b.styles,T=b.text.length>o.options.maxHighlightLength?Or(d.mode,p.state):null,I=Xy(o,b,p,!0);T&&(p.state=T),b.styles=I.styles;var A=b.styleClasses,$=I.classes;$?b.styleClasses=$:A&&(b.styleClasses=null);for(var W=!x||x.length!=b.styles.length||A!=$&&(!A||!$||A.bgClass!=$.bgClass||A.textClass!=$.textClass),Y=0;!W&&Y<x.length;++Y)W=x[Y]!=b.styles[Y];W&&m.push(p.line),b.stateAfter=p.save(),p.nextLine()}else b.text.length<=o.options.maxHighlightLength&&Fh(o,b.text,p),b.stateAfter=p.line%5==0?p.save():null,p.nextLine();if(+new Date>f)return cl(o,o.options.workDelay),!0}),d.highlightFrontier=p.line,d.modeFrontier=Math.max(d.modeFrontier,p.line),m.length&&On(o,function(){for(var b=0;b<m.length;b++)Yi(o,m[b],"text")})}}var lc=function(o,d,f){var p=o.display;this.viewport=d,this.visible=ac(p,o.doc,d),this.editorIsHidden=!p.wrapper.offsetWidth,this.wrapperHeight=p.wrapper.clientHeight,this.wrapperWidth=p.wrapper.clientWidth,this.oldDisplayWidth=Rs(o),this.force=f,this.dims=Qh(o),this.events=[]};lc.prototype.signal=function(o,d){Vn(o,d)&&this.events.push(arguments)},lc.prototype.finish=function(){for(var o=0;o<this.events.length;o++)bt.apply(null,this.events[o])};function ZR(o){var d=o.display;!d.scrollbarsClipped&&d.scroller.offsetWidth&&(d.nativeBarWidth=d.scroller.offsetWidth-d.scroller.clientWidth,d.heightForcer.style.height=Fr(o)+"px",d.sizer.style.marginBottom=-d.nativeBarWidth+"px",d.sizer.style.borderRightWidth=Fr(o)+"px",d.scrollbarsClipped=!0)}function QR(o){if(o.hasFocus())return null;var d=le(_e(o));if(!d||!Re(o.display.lineDiv,d))return null;var f={activeElt:d};if(window.getSelection){var p=De(o).getSelection();p.anchorNode&&p.extend&&Re(o.display.lineDiv,p.anchorNode)&&(f.anchorNode=p.anchorNode,f.anchorOffset=p.anchorOffset,f.focusNode=p.focusNode,f.focusOffset=p.focusOffset)}return f}function eM(o){if(!(!o||!o.activeElt||o.activeElt==le(Ge(o.activeElt)))&&(o.activeElt.focus(),!/^(INPUT|TEXTAREA)$/.test(o.activeElt.nodeName)&&o.anchorNode&&Re(document.body,o.anchorNode)&&Re(document.body,o.focusNode))){var d=o.activeElt.ownerDocument,f=d.defaultView.getSelection(),p=d.createRange();p.setEnd(o.anchorNode,o.anchorOffset),p.collapse(!1),f.removeAllRanges(),f.addRange(p),f.extend(o.focusNode,o.focusOffset)}}function lp(o,d){var f=o.display,p=o.doc;if(d.editorIsHidden)return Xi(o),!1;if(!d.force&&d.visible.from>=f.viewFrom&&d.visible.to<=f.viewTo&&(f.updateLineNumbers==null||f.updateLineNumbers>=f.viewTo)&&f.renderedView==f.view&&N0(o)==0)return!1;j0(o)&&(Xi(o),d.dims=Qh(o));var m=p.first+p.size,b=Math.max(d.visible.from-o.options.viewportMargin,p.first),x=Math.min(m,d.visible.to+o.options.viewportMargin);f.viewFrom<b&&b-f.viewFrom<20&&(b=Math.max(p.first,f.viewFrom)),f.viewTo>x&&f.viewTo-x<20&&(x=Math.min(m,f.viewTo)),di&&(b=zh(o.doc,b),x=c0(o.doc,x));var T=b!=f.viewFrom||x!=f.viewTo||f.lastWrapHeight!=d.wrapperHeight||f.lastWrapWidth!=d.wrapperWidth;FR(o,b,x),f.viewOffset=ci(Ie(o.doc,f.viewFrom)),o.display.mover.style.top=f.viewOffset+"px";var I=N0(o);if(!T&&I==0&&!d.force&&f.renderedView==f.view&&(f.updateLineNumbers==null||f.updateLineNumbers>=f.viewTo))return!1;var A=QR(o);return I>4&&(f.lineDiv.style.display="none"),tM(o,f.updateLineNumbers,d.dims),I>4&&(f.lineDiv.style.display=""),f.renderedView=f.view,eM(A),O(f.cursorDiv),O(f.selectionDiv),f.gutters.style.height=f.sizer.style.minHeight=0,T&&(f.lastWrapHeight=d.wrapperHeight,f.lastWrapWidth=d.wrapperWidth,cl(o,400)),f.updateLineNumbers=null,!0}function G0(o,d){for(var f=d.viewport,p=!0;;p=!1){if(!p||!o.options.lineWrapping||d.oldDisplayWidth==Rs(o)){if(f&&f.top!=null&&(f={top:Math.min(o.doc.height+Hh(o.display)-qh(o),f.top)}),d.visible=ac(o.display,o.doc,f),d.visible.from>=o.display.viewFrom&&d.visible.to<=o.display.viewTo)break}else p&&(d.visible=ac(o.display,o.doc,f));if(!lp(o,d))break;sc(o);var m=ll(o);sl(o),Ia(o,m),up(o,m),d.force=!1}d.signal(o,"update",o),(o.display.viewFrom!=o.display.reportedViewFrom||o.display.viewTo!=o.display.reportedViewTo)&&(d.signal(o,"viewportChange",o,o.display.viewFrom,o.display.viewTo),o.display.reportedViewFrom=o.display.viewFrom,o.display.reportedViewTo=o.display.viewTo)}function dp(o,d){var f=new lc(o,d);if(lp(o,f)){sc(o),G0(o,f);var p=ll(o);sl(o),Ia(o,p),up(o,p),f.finish()}}function tM(o,d,f){var p=o.display,m=o.options.lineNumbers,b=p.lineDiv,x=b.firstChild;function T(Q){var re=Q.nextSibling;return h&&L&&o.display.currentWheelTarget==Q?Q.style.display="none":Q.parentNode.removeChild(Q),re}for(var I=p.view,A=p.viewFrom,$=0;$<I.length;$++){var W=I[$];if(!W.hidden)if(!W.node||W.node.parentNode!=b){var Y=IR(o,W,A,f);b.insertBefore(Y,x)}else{for(;x!=W.node;)x=T(x);var J=m&&d!=null&&d<=A&&W.lineNumber;W.changes&&(Ce(W.changes,"gutter")>-1&&(J=!1),g0(o,W,A,f)),J&&(O(W.lineNumber),W.lineNumber.appendChild(document.createTextNode(ce(o.options,A)))),x=W.node.nextSibling}A+=W.size}for(;x;)x=T(x)}function cp(o){var d=o.gutters.offsetWidth;o.sizer.style.marginLeft=d+"px",$t(o,"gutterChanged",o)}function up(o,d){o.display.sizer.style.minHeight=d.docHeight+"px",o.display.heightForcer.style.top=d.docHeight+"px",o.display.gutters.style.height=d.docHeight+o.display.barHeight+Fr(o)+"px"}function W0(o){var d=o.display,f=d.view;if(!(!d.alignWidgets&&(!d.gutters.firstChild||!o.options.fixedGutter))){for(var p=ep(d)-d.scroller.scrollLeft+o.doc.scrollLeft,m=d.gutters.offsetWidth,b=p+"px",x=0;x<f.length;x++)if(!f[x].hidden){o.options.fixedGutter&&(f[x].gutter&&(f[x].gutter.style.left=b),f[x].gutterBackground&&(f[x].gutterBackground.style.left=b));var T=f[x].alignable;if(T)for(var I=0;I<T.length;I++)T[I].style.left=b}o.options.fixedGutter&&(d.gutters.style.left=p+m+"px")}}function j0(o){if(!o.options.lineNumbers)return!1;var d=o.doc,f=ce(o.options,d.first+d.size-1),p=o.display;if(f.length!=p.lineNumChars){var m=p.measure.appendChild(F("div",[F("div",f)],"CodeMirror-linenumber CodeMirror-gutter-elt")),b=m.firstChild.offsetWidth,x=m.offsetWidth-b;return p.lineGutter.style.width="",p.lineNumInnerWidth=Math.max(b,p.lineGutter.offsetWidth-x)+1,p.lineNumWidth=p.lineNumInnerWidth+x,p.lineNumChars=p.lineNumInnerWidth?f.length:-1,p.lineGutter.style.width=p.lineNumWidth+"px",cp(o.display),!0}return!1}function hp(o,d){for(var f=[],p=!1,m=0;m<o.length;m++){var b=o[m],x=null;if(typeof b!="string"&&(x=b.style,b=b.className),b=="CodeMirror-linenumbers")if(d)p=!0;else continue;f.push({className:b,style:x})}return d&&!p&&f.push({className:"CodeMirror-linenumbers",style:null}),f}function H0(o){var d=o.gutters,f=o.gutterSpecs;O(d),o.lineGutter=null;for(var p=0;p<f.length;++p){var m=f[p],b=m.className,x=m.style,T=d.appendChild(F("div",null,"CodeMirror-gutter "+b));x&&(T.style.cssText=x),b=="CodeMirror-linenumbers"&&(o.lineGutter=T,T.style.width=(o.lineNumWidth||1)+"px")}d.style.display=f.length?"":"none",cp(o)}function ul(o){H0(o.display),xn(o),W0(o)}function nM(o,d,f,p){var m=this;this.input=f,m.scrollbarFiller=F("div",null,"CodeMirror-scrollbar-filler"),m.scrollbarFiller.setAttribute("cm-not-content","true"),m.gutterFiller=F("div",null,"CodeMirror-gutter-filler"),m.gutterFiller.setAttribute("cm-not-content","true"),m.lineDiv=se("div",null,"CodeMirror-code"),m.selectionDiv=F("div",null,null,"position: relative; z-index: 1"),m.cursorDiv=F("div",null,"CodeMirror-cursors"),m.measure=F("div",null,"CodeMirror-measure"),m.lineMeasure=F("div",null,"CodeMirror-measure"),m.lineSpace=se("div",[m.measure,m.lineMeasure,m.selectionDiv,m.cursorDiv,m.lineDiv],null,"position: relative; outline: none");var b=se("div",[m.lineSpace],"CodeMirror-lines");m.mover=F("div",[b],null,"position: relative"),m.sizer=F("div",[m.mover],"CodeMirror-sizer"),m.sizerWidth=null,m.heightForcer=F("div",null,null,"position: absolute; height: "+Ye+"px; width: 1px;"),m.gutters=F("div",null,"CodeMirror-gutters"),m.lineGutter=null,m.scroller=F("div",[m.sizer,m.heightForcer,m.gutters],"CodeMirror-scroll"),m.scroller.setAttribute("tabIndex","-1"),m.wrapper=F("div",[m.scrollbarFiller,m.gutterFiller,m.scroller],"CodeMirror"),v&&y>=105&&(m.wrapper.style.clipPath="inset(0px)"),m.wrapper.setAttribute("translate","no"),c&&u<8&&(m.gutters.style.zIndex=-1,m.scroller.style.paddingRight=0),!h&&!(i&&D)&&(m.scroller.draggable=!0),o&&(o.appendChild?o.appendChild(m.wrapper):o(m.wrapper)),m.viewFrom=m.viewTo=d.first,m.reportedViewFrom=m.reportedViewTo=d.first,m.view=[],m.renderedView=null,m.externalMeasured=null,m.viewOffset=0,m.lastWrapHeight=m.lastWrapWidth=0,m.updateLineNumbers=null,m.nativeBarWidth=m.barHeight=m.barWidth=0,m.scrollbarsClipped=!1,m.lineNumWidth=m.lineNumInnerWidth=m.lineNumChars=null,m.alignWidgets=!1,m.cachedCharWidth=m.cachedTextHeight=m.cachedPaddingH=null,m.maxLine=null,m.maxLineLength=0,m.maxLineChanged=!1,m.wheelDX=m.wheelDY=m.wheelStartX=m.wheelStartY=null,m.shift=!1,m.selForContextMenu=null,m.activeTouch=null,m.gutterSpecs=hp(p.gutters,p.lineNumbers),H0(m),f.init(m)}var dc=0,hi=null;c?hi=-.53:i?hi=15:v?hi=-.7:S&&(hi=-1/3);function q0(o){var d=o.wheelDeltaX,f=o.wheelDeltaY;return d==null&&o.detail&&o.axis==o.HORIZONTAL_AXIS&&(d=o.detail),f==null&&o.detail&&o.axis==o.VERTICAL_AXIS?f=o.detail:f==null&&(f=o.wheelDelta),{x:d,y:f}}function rM(o){var d=q0(o);return d.x*=hi,d.y*=hi,d}function J0(o,d){v&&y==102&&(o.display.chromeScrollHack==null?o.display.sizer.style.pointerEvents="none":clearTimeout(o.display.chromeScrollHack),o.display.chromeScrollHack=setTimeout(function(){o.display.chromeScrollHack=null,o.display.sizer.style.pointerEvents=""},100));var f=q0(d),p=f.x,m=f.y,b=hi;d.deltaMode===0&&(p=d.deltaX,m=d.deltaY,b=1);var x=o.display,T=x.scroller,I=T.scrollWidth>T.clientWidth,A=T.scrollHeight>T.clientHeight;if(p&&I||m&&A){if(m&&L&&h){e:for(var $=d.target,W=x.view;$!=T;$=$.parentNode)for(var Y=0;Y<W.length;Y++)if(W[Y].node==$){o.display.currentWheelTarget=$;break e}}if(p&&!i&&!C&&b!=null){m&&A&&ol(o,Math.max(0,T.scrollTop+m*b)),Vs(o,Math.max(0,T.scrollLeft+p*b)),(!m||m&&A)&&nn(d),x.wheelStartX=null;return}if(m&&b!=null){var J=m*b,Q=o.doc.scrollTop,re=Q+x.wrapper.clientHeight;J<0?Q=Math.max(0,Q+J-50):re=Math.min(o.doc.height,re+J+50),dp(o,{top:Q,bottom:re})}dc<20&&d.deltaMode!==0&&(x.wheelStartX==null?(x.wheelStartX=T.scrollLeft,x.wheelStartY=T.scrollTop,x.wheelDX=p,x.wheelDY=m,setTimeout(function(){if(x.wheelStartX!=null){var ue=T.scrollLeft-x.wheelStartX,pe=T.scrollTop-x.wheelStartY,be=pe&&x.wheelDY&&pe/x.wheelDY||ue&&x.wheelDX&&ue/x.wheelDX;x.wheelStartX=x.wheelStartY=null,be&&(hi=(hi*dc+be)/(dc+1),++dc)}},200)):(x.wheelDX+=p,x.wheelDY+=m))}}var jn=function(o,d){this.ranges=o,this.primIndex=d};jn.prototype.primary=function(){return this.ranges[this.primIndex]},jn.prototype.equals=function(o){if(o==this)return!0;if(o.primIndex!=this.primIndex||o.ranges.length!=this.ranges.length)return!1;for(var d=0;d<this.ranges.length;d++){var f=this.ranges[d],p=o.ranges[d];if(!et(f.anchor,p.anchor)||!et(f.head,p.head))return!1}return!0},jn.prototype.deepCopy=function(){for(var o=[],d=0;d<this.ranges.length;d++)o[d]=new tt(Ut(this.ranges[d].anchor),Ut(this.ranges[d].head));return new jn(o,this.primIndex)},jn.prototype.somethingSelected=function(){for(var o=0;o<this.ranges.length;o++)if(!this.ranges[o].empty())return!0;return!1},jn.prototype.contains=function(o,d){d||(d=o);for(var f=0;f<this.ranges.length;f++){var p=this.ranges[f];if(me(d,p.from())>=0&&me(o,p.to())<=0)return f}return-1};var tt=function(o,d){this.anchor=o,this.head=d};tt.prototype.from=function(){return wa(this.anchor,this.head)},tt.prototype.to=function(){return Cn(this.anchor,this.head)},tt.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch};function Cr(o,d,f){var p=o&&o.options.selectionsMayTouch,m=d[f];d.sort(function(Y,J){return me(Y.from(),J.from())}),f=Ce(d,m);for(var b=1;b<d.length;b++){var x=d[b],T=d[b-1],I=me(T.to(),x.from());if(p&&!x.empty()?I>0:I>=0){var A=wa(T.from(),x.from()),$=Cn(T.to(),x.to()),W=T.empty()?x.from()==x.head:T.from()==T.head;b<=f&&--f,d.splice(--b,2,new tt(W?$:A,W?A:$))}}return new jn(d,f)}function Ki(o,d){return new jn([new tt(o,d||o)],0)}function Zi(o){return o.text?Z(o.from.line+o.text.length-1,He(o.text).length+(o.text.length==1?o.from.ch:0)):o.to}function Y0(o,d){if(me(o,d.from)<0)return o;if(me(o,d.to)<=0)return Zi(d);var f=o.line+d.text.length-(d.to.line-d.from.line)-1,p=o.ch;return o.line==d.to.line&&(p+=Zi(d).ch-d.to.ch),Z(f,p)}function pp(o,d){for(var f=[],p=0;p<o.sel.ranges.length;p++){var m=o.sel.ranges[p];f.push(new tt(Y0(m.anchor,d),Y0(m.head,d)))}return Cr(o.cm,f,o.sel.primIndex)}function X0(o,d,f){return o.line==d.line?Z(f.line,o.ch-d.ch+f.ch):Z(f.line+(o.line-d.line),o.ch)}function iM(o,d,f){for(var p=[],m=Z(o.first,0),b=m,x=0;x<d.length;x++){var T=d[x],I=X0(T.from,m,b),A=X0(Zi(T),m,b);if(m=T.to,b=A,f=="around"){var $=o.sel.ranges[x],W=me($.head,$.anchor)<0;p[x]=new tt(W?A:I,W?I:A)}else p[x]=new tt(I,I)}return new jn(p,o.sel.primIndex)}function fp(o){o.doc.mode=va(o.options,o.doc.modeOption),hl(o)}function hl(o){o.doc.iter(function(d){d.stateAfter&&(d.stateAfter=null),d.styles&&(d.styles=null)}),o.doc.modeFrontier=o.doc.highlightFrontier=o.doc.first,cl(o,100),o.state.modeGen++,o.curOp&&xn(o)}function K0(o,d){return d.from.ch==0&&d.to.ch==0&&He(d.text)==""&&(!o.cm||o.cm.options.wholeLineUpdateBefore)}function gp(o,d,f,p){function m(be){return f?f[be]:null}function b(be,fe,xe){hR(be,fe,xe,p),$t(be,"change",be,d)}function x(be,fe){for(var xe=[],Be=be;Be<fe;++Be)xe.push(new Sa(A[Be],m(Be),p));return xe}var T=d.from,I=d.to,A=d.text,$=Ie(o,T.line),W=Ie(o,I.line),Y=He(A),J=m(A.length-1),Q=I.line-T.line;if(d.full)o.insert(0,x(0,A.length)),o.remove(A.length,o.size-A.length);else if(K0(o,d)){var re=x(0,A.length-1);b(W,W.text,J),Q&&o.remove(T.line,Q),re.length&&o.insert(T.line,re)}else if($==W)if(A.length==1)b($,$.text.slice(0,T.ch)+Y+$.text.slice(I.ch),J);else{var ue=x(1,A.length-1);ue.push(new Sa(Y+$.text.slice(I.ch),J,p)),b($,$.text.slice(0,T.ch)+A[0],m(0)),o.insert(T.line+1,ue)}else if(A.length==1)b($,$.text.slice(0,T.ch)+A[0]+W.text.slice(I.ch),m(0)),o.remove(T.line+1,Q);else{b($,$.text.slice(0,T.ch)+A[0],m(0)),b(W,Y+W.text.slice(I.ch),J);var pe=x(1,A.length-1);Q>1&&o.remove(T.line+1,Q-1),o.insert(T.line+1,pe)}$t(o,"change",o,d)}function Qi(o,d,f){function p(m,b,x){if(m.linked)for(var T=0;T<m.linked.length;++T){var I=m.linked[T];if(I.doc!=b){var A=x&&I.sharedHist;f&&!A||(d(I.doc,A),p(I.doc,m,A))}}}p(o,null,!0)}function Z0(o,d){if(d.cm)throw new Error("This document is already in use.");o.doc=d,d.cm=o,tp(o),fp(o),Q0(o),o.options.direction=d.direction,o.options.lineWrapping||Wh(o),o.options.mode=d.modeOption,xn(o)}function Q0(o){(o.doc.direction=="rtl"?Se:U)(o.display.lineDiv,"CodeMirror-rtl")}function sM(o){On(o,function(){Q0(o),xn(o)})}function cc(o){this.done=[],this.undone=[],this.undoDepth=o?o.undoDepth:1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=o?o.maxGeneration:1}function mp(o,d){var f={from:Ut(d.from),to:Zi(d),text:li(o,d.from,d.to)};return nb(o,f,d.from.line,d.to.line+1),Qi(o,function(p){return nb(p,f,d.from.line,d.to.line+1)},!0),f}function eb(o){for(;o.length;){var d=He(o);if(d.ranges)o.pop();else break}}function aM(o,d){if(d)return eb(o.done),He(o.done);if(o.done.length&&!He(o.done).ranges)return He(o.done);if(o.done.length>1&&!o.done[o.done.length-2].ranges)return o.done.pop(),He(o.done)}function tb(o,d,f,p){var m=o.history;m.undone.length=0;var b=+new Date,x,T;if((m.lastOp==p||m.lastOrigin==d.origin&&d.origin&&(d.origin.charAt(0)=="+"&&m.lastModTime>b-(o.cm?o.cm.options.historyEventDelay:500)||d.origin.charAt(0)=="*"))&&(x=aM(m,m.lastOp==p)))T=He(x.changes),me(d.from,d.to)==0&&me(d.from,T.to)==0?T.to=Zi(d):x.changes.push(mp(o,d));else{var I=He(m.done);for((!I||!I.ranges)&&uc(o.sel,m.done),x={changes:[mp(o,d)],generation:m.generation},m.done.push(x);m.done.length>m.undoDepth;)m.done.shift(),m.done[0].ranges||m.done.shift()}m.done.push(f),m.generation=++m.maxGeneration,m.lastModTime=m.lastSelTime=b,m.lastOp=m.lastSelOp=p,m.lastOrigin=m.lastSelOrigin=d.origin,T||bt(o,"historyAdded")}function oM(o,d,f,p){var m=d.charAt(0);return m=="*"||m=="+"&&f.ranges.length==p.ranges.length&&f.somethingSelected()==p.somethingSelected()&&new Date-o.history.lastSelTime<=(o.cm?o.cm.options.historyEventDelay:500)}function lM(o,d,f,p){var m=o.history,b=p&&p.origin;f==m.lastSelOp||b&&m.lastSelOrigin==b&&(m.lastModTime==m.lastSelTime&&m.lastOrigin==b||oM(o,b,He(m.done),d))?m.done[m.done.length-1]=d:uc(d,m.done),m.lastSelTime=+new Date,m.lastSelOrigin=b,m.lastSelOp=f,p&&p.clearRedo!==!1&&eb(m.undone)}function uc(o,d){var f=He(d);f&&f.ranges&&f.equals(o)||d.push(o)}function nb(o,d,f,p){var m=d["spans_"+o.id],b=0;o.iter(Math.max(o.first,f),Math.min(o.first+o.size,p),function(x){x.markedSpans&&((m||(m=d["spans_"+o.id]={}))[b]=x.markedSpans),++b})}function dM(o){if(!o)return null;for(var d,f=0;f<o.length;++f)o[f].marker.explicitlyCleared?d||(d=o.slice(0,f)):d&&d.push(o[f]);return d?d.length?d:null:o}function cM(o,d){var f=d["spans_"+o.id];if(!f)return null;for(var p=[],m=0;m<d.text.length;++m)p.push(dM(f[m]));return p}function rb(o,d){var f=cM(o,d),p=Uh(o,d);if(!f)return p;if(!p)return f;for(var m=0;m<f.length;++m){var b=f[m],x=p[m];if(b&&x)e:for(var T=0;T<x.length;++T){for(var I=x[T],A=0;A<b.length;++A)if(b[A].marker==I.marker)continue e;b.push(I)}else x&&(f[m]=x)}return f}function Da(o,d,f){for(var p=[],m=0;m<o.length;++m){var b=o[m];if(b.ranges){p.push(f?jn.prototype.deepCopy.call(b):b);continue}var x=b.changes,T=[];p.push({changes:T});for(var I=0;I<x.length;++I){var A=x[I],$=void 0;if(T.push({from:A.from,to:A.to,text:A.text}),d)for(var W in A)($=W.match(/^spans_(\d+)$/))&&Ce(d,Number($[1]))>-1&&(He(T)[W]=A[W],delete A[W])}}return p}function vp(o,d,f,p){if(p){var m=o.anchor;if(f){var b=me(d,m)<0;b!=me(f,m)<0?(m=d,d=f):b!=me(d,f)<0&&(d=f)}return new tt(m,d)}else return new tt(f||d,d)}function hc(o,d,f,p,m){m==null&&(m=o.cm&&(o.cm.display.shift||o.extend)),rn(o,new jn([vp(o.sel.primary(),d,f,m)],0),p)}function ib(o,d,f){for(var p=[],m=o.cm&&(o.cm.display.shift||o.extend),b=0;b<o.sel.ranges.length;b++)p[b]=vp(o.sel.ranges[b],d[b],null,m);var x=Cr(o.cm,p,o.sel.primIndex);rn(o,x,f)}function yp(o,d,f,p){var m=o.sel.ranges.slice(0);m[d]=f,rn(o,Cr(o.cm,m,o.sel.primIndex),p)}function sb(o,d,f,p){rn(o,Ki(d,f),p)}function uM(o,d,f){var p={ranges:d.ranges,update:function(m){this.ranges=[];for(var b=0;b<m.length;b++)this.ranges[b]=new tt($e(o,m[b].anchor),$e(o,m[b].head))},origin:f&&f.origin};return bt(o,"beforeSelectionChange",o,p),o.cm&&bt(o.cm,"beforeSelectionChange",o.cm,p),p.ranges!=d.ranges?Cr(o.cm,p.ranges,p.ranges.length-1):d}function ab(o,d,f){var p=o.history.done,m=He(p);m&&m.ranges?(p[p.length-1]=d,pc(o,d,f)):rn(o,d,f)}function rn(o,d,f){pc(o,d,f),lM(o,o.sel,o.cm?o.cm.curOp.id:NaN,f)}function pc(o,d,f){(Vn(o,"beforeSelectionChange")||o.cm&&Vn(o.cm,"beforeSelectionChange"))&&(d=uM(o,d,f));var p=f&&f.bias||(me(d.primary().head,o.sel.primary().head)<0?-1:1);ob(o,db(o,d,p,!0)),!(f&&f.scroll===!1)&&o.cm&&o.cm.getOption("readOnly")!="nocursor"&&La(o.cm)}function ob(o,d){d.equals(o.sel)||(o.sel=d,o.cm&&(o.cm.curOp.updateInput=1,o.cm.curOp.selectionChanged=!0,Zn(o.cm)),$t(o,"cursorActivity",o))}function lb(o){ob(o,db(o,o.sel,null,!1))}function db(o,d,f,p){for(var m,b=0;b<d.ranges.length;b++){var x=d.ranges[b],T=d.ranges.length==o.sel.ranges.length&&o.sel.ranges[b],I=fc(o,x.anchor,T&&T.anchor,f,p),A=x.head==x.anchor?I:fc(o,x.head,T&&T.head,f,p);(m||I!=x.anchor||A!=x.head)&&(m||(m=d.ranges.slice(0,b)),m[b]=new tt(I,A))}return m?Cr(o.cm,m,d.primIndex):d}function Pa(o,d,f,p,m){var b=Ie(o,d.line);if(b.markedSpans)for(var x=0;x<b.markedSpans.length;++x){var T=b.markedSpans[x],I=T.marker,A="selectLeft"in I?!I.selectLeft:I.inclusiveLeft,$="selectRight"in I?!I.selectRight:I.inclusiveRight;if((T.from==null||(A?T.from<=d.ch:T.from<d.ch))&&(T.to==null||($?T.to>=d.ch:T.to>d.ch))){if(m&&(bt(I,"beforeCursorEnter"),I.explicitlyCleared))if(b.markedSpans){--x;continue}else break;if(!I.atomic)continue;if(f){var W=I.find(p<0?1:-1),Y=void 0;if((p<0?$:A)&&(W=cb(o,W,-p,W&&W.line==d.line?b:null)),W&&W.line==d.line&&(Y=me(W,f))&&(p<0?Y<0:Y>0))return Pa(o,W,d,p,m)}var J=I.find(p<0?-1:1);return(p<0?A:$)&&(J=cb(o,J,p,J.line==d.line?b:null)),J?Pa(o,J,d,p,m):null}}return d}function fc(o,d,f,p,m){var b=p||1,x=Pa(o,d,f,b,m)||!m&&Pa(o,d,f,b,!0)||Pa(o,d,f,-b,m)||!m&&Pa(o,d,f,-b,!0);return x||(o.cantEdit=!0,Z(o.first,0))}function cb(o,d,f,p){return f<0&&d.ch==0?d.line>o.first?$e(o,Z(d.line-1)):null:f>0&&d.ch==(p||Ie(o,d.line)).text.length?d.line<o.first+o.size-1?Z(d.line+1,0):null:new Z(d.line,d.ch+f)}function ub(o){o.setSelection(Z(o.firstLine(),0),Z(o.lastLine()),Yt)}function hb(o,d,f){var p={canceled:!1,from:d.from,to:d.to,text:d.text,origin:d.origin,cancel:function(){return p.canceled=!0}};return f&&(p.update=function(m,b,x,T){m&&(p.from=$e(o,m)),b&&(p.to=$e(o,b)),x&&(p.text=x),T!==void 0&&(p.origin=T)}),bt(o,"beforeChange",o,p),o.cm&&bt(o.cm,"beforeChange",o.cm,p),p.canceled?(o.cm&&(o.cm.curOp.updateInput=2),null):{from:p.from,to:p.to,text:p.text,origin:p.origin}}function Ra(o,d,f){if(o.cm){if(!o.cm.curOp)return zt(o.cm,Ra)(o,d,f);if(o.cm.state.suppressEdits)return}if(!((Vn(o,"beforeChange")||o.cm&&Vn(o.cm,"beforeChange"))&&(d=hb(o,d,!0),!d))){var p=r0&&!f&&lR(o,d.from,d.to);if(p)for(var m=p.length-1;m>=0;--m)pb(o,{from:p[m].from,to:p[m].to,text:m?[""]:d.text,origin:d.origin});else pb(o,d)}}function pb(o,d){if(!(d.text.length==1&&d.text[0]==""&&me(d.from,d.to)==0)){var f=pp(o,d);tb(o,d,f,o.cm?o.cm.curOp.id:NaN),pl(o,d,f,Uh(o,d));var p=[];Qi(o,function(m,b){!b&&Ce(p,m.history)==-1&&(vb(m.history,d),p.push(m.history)),pl(m,d,null,Uh(m,d))})}}function gc(o,d,f){var p=o.cm&&o.cm.state.suppressEdits;if(!(p&&!f)){for(var m=o.history,b,x=o.sel,T=d=="undo"?m.done:m.undone,I=d=="undo"?m.undone:m.done,A=0;A<T.length&&(b=T[A],!(f?b.ranges&&!b.equals(o.sel):!b.ranges));A++);if(A!=T.length){for(m.lastOrigin=m.lastSelOrigin=null;;)if(b=T.pop(),b.ranges){if(uc(b,I),f&&!b.equals(o.sel)){rn(o,b,{clearRedo:!1});return}x=b}else if(p){T.push(b);return}else break;var $=[];uc(x,I),I.push({changes:$,generation:m.generation}),m.generation=b.generation||++m.maxGeneration;for(var W=Vn(o,"beforeChange")||o.cm&&Vn(o.cm,"beforeChange"),Y=function(re){var ue=b.changes[re];if(ue.origin=d,W&&!hb(o,ue,!1))return T.length=0,{};$.push(mp(o,ue));var pe=re?pp(o,ue):He(T);pl(o,ue,pe,rb(o,ue)),!re&&o.cm&&o.cm.scrollIntoView({from:ue.from,to:Zi(ue)});var be=[];Qi(o,function(fe,xe){!xe&&Ce(be,fe.history)==-1&&(vb(fe.history,ue),be.push(fe.history)),pl(fe,ue,null,rb(fe,ue))})},J=b.changes.length-1;J>=0;--J){var Q=Y(J);if(Q)return Q.v}}}}function fb(o,d){if(d!=0&&(o.first+=d,o.sel=new jn(Kn(o.sel.ranges,function(m){return new tt(Z(m.anchor.line+d,m.anchor.ch),Z(m.head.line+d,m.head.ch))}),o.sel.primIndex),o.cm)){xn(o.cm,o.first,o.first-d,d);for(var f=o.cm.display,p=f.viewFrom;p<f.viewTo;p++)Yi(o.cm,p,"gutter")}}function pl(o,d,f,p){if(o.cm&&!o.cm.curOp)return zt(o.cm,pl)(o,d,f,p);if(d.to.line<o.first){fb(o,d.text.length-1-(d.to.line-d.from.line));return}if(!(d.from.line>o.lastLine())){if(d.from.line<o.first){var m=d.text.length-1-(o.first-d.from.line);fb(o,m),d={from:Z(o.first,0),to:Z(d.to.line+m,d.to.ch),text:[He(d.text)],origin:d.origin}}var b=o.lastLine();d.to.line>b&&(d={from:d.from,to:Z(b,Ie(o,b).text.length),text:[d.text[0]],origin:d.origin}),d.removed=li(o,d.from,d.to),f||(f=pp(o,d)),o.cm?hM(o.cm,d,p):gp(o,d,p),pc(o,f,Yt),o.cantEdit&&fc(o,Z(o.firstLine(),0))&&(o.cantEdit=!1)}}function hM(o,d,f){var p=o.doc,m=o.display,b=d.from,x=d.to,T=!1,I=b.line;o.options.lineWrapping||(I=N(wr(Ie(p,b.line))),p.iter(I,x.line+1,function(J){if(J==m.maxLine)return T=!0,!0})),p.sel.contains(d.from,d.to)>-1&&Zn(o),gp(p,d,f,A0(o)),o.options.lineWrapping||(p.iter(I,b.line+d.text.length,function(J){var Q=Zd(J);Q>m.maxLineLength&&(m.maxLine=J,m.maxLineLength=Q,m.maxLineChanged=!0,T=!1)}),T&&(o.curOp.updateMaxLine=!0)),tR(p,b.line),cl(o,400);var A=d.text.length-(x.line-b.line)-1;d.full?xn(o):b.line==x.line&&d.text.length==1&&!K0(o.doc,d)?Yi(o,b.line,"text"):xn(o,b.line,x.line+1,A);var $=Vn(o,"changes"),W=Vn(o,"change");if(W||$){var Y={from:b,to:x,text:d.text,removed:d.removed,origin:d.origin};W&&$t(o,"change",o,Y),$&&(o.curOp.changeObjs||(o.curOp.changeObjs=[])).push(Y)}o.display.selForContextMenu=null}function Ma(o,d,f,p,m){var b;p||(p=f),me(p,f)<0&&(b=[p,f],f=b[0],p=b[1]),typeof d=="string"&&(d=o.splitLines(d)),Ra(o,{from:f,to:p,text:d,origin:m})}function gb(o,d,f,p){f<o.line?o.line+=p:d<o.line&&(o.line=d,o.ch=0)}function mb(o,d,f,p){for(var m=0;m<o.length;++m){var b=o[m],x=!0;if(b.ranges){b.copied||(b=o[m]=b.deepCopy(),b.copied=!0);for(var T=0;T<b.ranges.length;T++)gb(b.ranges[T].anchor,d,f,p),gb(b.ranges[T].head,d,f,p);continue}for(var I=0;I<b.changes.length;++I){var A=b.changes[I];if(f<A.from.line)A.from=Z(A.from.line+p,A.from.ch),A.to=Z(A.to.line+p,A.to.ch);else if(d<=A.to.line){x=!1;break}}x||(o.splice(0,m+1),m=0)}}function vb(o,d){var f=d.from.line,p=d.to.line,m=d.text.length-(p-f)-1;mb(o.done,f,p,m),mb(o.undone,f,p,m)}function fl(o,d,f,p){var m=d,b=d;return typeof d=="number"?b=Ie(o,Jy(o,d)):m=N(d),m==null?null:(p(b,m)&&o.cm&&Yi(o.cm,m,f),b)}function gl(o){this.lines=o,this.parent=null;for(var d=0,f=0;f<o.length;++f)o[f].parent=this,d+=o[f].height;this.height=d}gl.prototype={chunkSize:function(){return this.lines.length},removeInner:function(o,d){for(var f=o,p=o+d;f<p;++f){var m=this.lines[f];this.height-=m.height,pR(m),$t(m,"delete")}this.lines.splice(o,d)},collapse:function(o){o.push.apply(o,this.lines)},insertInner:function(o,d,f){this.height+=f,this.lines=this.lines.slice(0,o).concat(d).concat(this.lines.slice(o));for(var p=0;p<d.length;++p)d[p].parent=this},iterN:function(o,d,f){for(var p=o+d;o<p;++o)if(f(this.lines[o]))return!0}};function ml(o){this.children=o;for(var d=0,f=0,p=0;p<o.length;++p){var m=o[p];d+=m.chunkSize(),f+=m.height,m.parent=this}this.size=d,this.height=f,this.parent=null}ml.prototype={chunkSize:function(){return this.size},removeInner:function(o,d){this.size-=d;for(var f=0;f<this.children.length;++f){var p=this.children[f],m=p.chunkSize();if(o<m){var b=Math.min(d,m-o),x=p.height;if(p.removeInner(o,b),this.height-=x-p.height,m==b&&(this.children.splice(f--,1),p.parent=null),(d-=b)==0)break;o=0}else o-=m}if(this.size-d<25&&(this.children.length>1||!(this.children[0]instanceof gl))){var T=[];this.collapse(T),this.children=[new gl(T)],this.children[0].parent=this}},collapse:function(o){for(var d=0;d<this.children.length;++d)this.children[d].collapse(o)},insertInner:function(o,d,f){this.size+=d.length,this.height+=f;for(var p=0;p<this.children.length;++p){var m=this.children[p],b=m.chunkSize();if(o<=b){if(m.insertInner(o,d,f),m.lines&&m.lines.length>50){for(var x=m.lines.length%25+25,T=x;T<m.lines.length;){var I=new gl(m.lines.slice(T,T+=25));m.height-=I.height,this.children.splice(++p,0,I),I.parent=this}m.lines=m.lines.slice(0,x),this.maybeSpill()}break}o-=b}},maybeSpill:function(){if(!(this.children.length<=10)){var o=this;do{var d=o.children.splice(o.children.length-5,5),f=new ml(d);if(o.parent){o.size-=f.size,o.height-=f.height;var p=Ce(o.parent.children,o);o.parent.children.splice(p+1,0,f)}else{var m=new ml(o.children);m.parent=o,o.children=[m,f],o=m}f.parent=o.parent}while(o.children.length>10);o.parent.maybeSpill()}},iterN:function(o,d,f){for(var p=0;p<this.children.length;++p){var m=this.children[p],b=m.chunkSize();if(o<b){var x=Math.min(d,b-o);if(m.iterN(o,x,f))return!0;if((d-=x)==0)break;o=0}else o-=b}}};var vl=function(o,d,f){if(f)for(var p in f)f.hasOwnProperty(p)&&(this[p]=f[p]);this.doc=o,this.node=d};vl.prototype.clear=function(){var o=this.doc.cm,d=this.line.widgets,f=this.line,p=N(f);if(!(p==null||!d)){for(var m=0;m<d.length;++m)d[m]==this&&d.splice(m--,1);d.length||(f.widgets=null);var b=rl(this);Wn(f,Math.max(0,f.height-b)),o&&(On(o,function(){yb(o,f,-b),Yi(o,p,"widget")}),$t(o,"lineWidgetCleared",o,this,p))}},vl.prototype.changed=function(){var o=this,d=this.height,f=this.doc.cm,p=this.line;this.height=null;var m=rl(this)-d;m&&(Ji(this.doc,p)||Wn(p,p.height+m),f&&On(f,function(){f.curOp.forceUpdate=!0,yb(f,p,m),$t(f,"lineWidgetChanged",f,o,N(p))}))},gr(vl);function yb(o,d,f){ci(d)<(o.curOp&&o.curOp.scrollTop||o.doc.scrollTop)&&op(o,f)}function pM(o,d,f,p){var m=new vl(o,f,p),b=o.cm;return b&&m.noHScroll&&(b.display.alignWidgets=!0),fl(o,d,"widget",function(x){var T=x.widgets||(x.widgets=[]);if(m.insertAt==null?T.push(m):T.splice(Math.min(T.length,Math.max(0,m.insertAt)),0,m),m.line=x,b&&!Ji(o,x)){var I=ci(x)<o.scrollTop;Wn(x,x.height+rl(m)),I&&op(b,m.height),b.curOp.forceUpdate=!0}return!0}),b&&$t(b,"lineWidgetAdded",b,m,typeof d=="number"?d:N(d)),m}var bb=0,es=function(o,d){this.lines=[],this.type=d,this.doc=o,this.id=++bb};es.prototype.clear=function(){if(!this.explicitlyCleared){var o=this.doc.cm,d=o&&!o.curOp;if(d&&Bs(o),Vn(this,"clear")){var f=this.find();f&&$t(this,"clear",f.from,f.to)}for(var p=null,m=null,b=0;b<this.lines.length;++b){var x=this.lines[b],T=el(x.markedSpans,this);o&&!this.collapsed?Yi(o,N(x),"text"):o&&(T.to!=null&&(m=N(x)),T.from!=null&&(p=N(x))),x.markedSpans=iR(x.markedSpans,T),T.from==null&&this.collapsed&&!Ji(this.doc,x)&&o&&Wn(x,Ea(o.display))}if(o&&this.collapsed&&!o.options.lineWrapping)for(var I=0;I<this.lines.length;++I){var A=wr(this.lines[I]),$=Zd(A);$>o.display.maxLineLength&&(o.display.maxLine=A,o.display.maxLineLength=$,o.display.maxLineChanged=!0)}p!=null&&o&&this.collapsed&&xn(o,p,m+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,o&&lb(o.doc)),o&&$t(o,"markerCleared",o,this,p,m),d&&Fs(o),this.parent&&this.parent.clear()}},es.prototype.find=function(o,d){o==null&&this.type=="bookmark"&&(o=1);for(var f,p,m=0;m<this.lines.length;++m){var b=this.lines[m],x=el(b.markedSpans,this);if(x.from!=null&&(f=Z(d?b:N(b),x.from),o==-1))return f;if(x.to!=null&&(p=Z(d?b:N(b),x.to),o==1))return p}return f&&{from:f,to:p}},es.prototype.changed=function(){var o=this,d=this.find(-1,!0),f=this,p=this.doc.cm;!d||!p||On(p,function(){var m=d.line,b=N(d.line),x=Jh(p,b);if(x&&(T0(x),p.curOp.selectionChanged=p.curOp.forceUpdate=!0),p.curOp.updateMaxLine=!0,!Ji(f.doc,m)&&f.height!=null){var T=f.height;f.height=null;var I=rl(f)-T;I&&Wn(m,m.height+I)}$t(p,"markerChanged",p,o)})},es.prototype.attachLine=function(o){if(!this.lines.length&&this.doc.cm){var d=this.doc.cm.curOp;(!d.maybeHiddenMarkers||Ce(d.maybeHiddenMarkers,this)==-1)&&(d.maybeUnhiddenMarkers||(d.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(o)},es.prototype.detachLine=function(o){if(this.lines.splice(Ce(this.lines,o),1),!this.lines.length&&this.doc.cm){var d=this.doc.cm.curOp;(d.maybeHiddenMarkers||(d.maybeHiddenMarkers=[])).push(this)}},gr(es);function Aa(o,d,f,p,m){if(p&&p.shared)return fM(o,d,f,p,m);if(o.cm&&!o.cm.curOp)return zt(o.cm,Aa)(o,d,f,p,m);var b=new es(o,m),x=me(d,f);if(p&&Me(p,b,!1),x>0||x==0&&b.clearWhenEmpty!==!1)return b;if(b.replacedWith&&(b.collapsed=!0,b.widgetNode=se("span",[b.replacedWith],"CodeMirror-widget"),p.handleMouseEvents||b.widgetNode.setAttribute("cm-ignore-events","true"),p.insertLeft&&(b.widgetNode.insertLeft=!0)),b.collapsed){if(d0(o,d.line,d,f,b)||d.line!=f.line&&d0(o,f.line,d,f,b))throw new Error("Inserting collapsed marker partially overlapping an existing one");rR()}b.addToHistory&&tb(o,{from:d,to:f,origin:"markText"},o.sel,NaN);var T=d.line,I=o.cm,A;if(o.iter(T,f.line+1,function(W){I&&b.collapsed&&!I.options.lineWrapping&&wr(W)==I.display.maxLine&&(A=!0),b.collapsed&&T!=d.line&&Wn(W,0),sR(W,new Jd(b,T==d.line?d.ch:null,T==f.line?f.ch:null),o.cm&&o.cm.curOp),++T}),b.collapsed&&o.iter(d.line,f.line+1,function(W){Ji(o,W)&&Wn(W,0)}),b.clearOnEnter&&Ve(b,"beforeCursorEnter",function(){return b.clear()}),b.readOnly&&(nR(),(o.history.done.length||o.history.undone.length)&&o.clearHistory()),b.collapsed&&(b.id=++bb,b.atomic=!0),I){if(A&&(I.curOp.updateMaxLine=!0),b.collapsed)xn(I,d.line,f.line+1);else if(b.className||b.startStyle||b.endStyle||b.css||b.attributes||b.title)for(var $=d.line;$<=f.line;$++)Yi(I,$,"text");b.atomic&&lb(I.doc),$t(I,"markerAdded",I,b)}return b}var yl=function(o,d){this.markers=o,this.primary=d;for(var f=0;f<o.length;++f)o[f].parent=this};yl.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var o=0;o<this.markers.length;++o)this.markers[o].clear();$t(this,"clear")}},yl.prototype.find=function(o,d){return this.primary.find(o,d)},gr(yl);function fM(o,d,f,p,m){p=Me(p),p.shared=!1;var b=[Aa(o,d,f,p,m)],x=b[0],T=p.widgetNode;return Qi(o,function(I){T&&(p.widgetNode=T.cloneNode(!0)),b.push(Aa(I,$e(I,d),$e(I,f),p,m));for(var A=0;A<I.linked.length;++A)if(I.linked[A].isParent)return;x=He(b)}),new yl(b,x)}function wb(o){return o.findMarks(Z(o.first,0),o.clipPos(Z(o.lastLine())),function(d){return d.parent})}function gM(o,d){for(var f=0;f<d.length;f++){var p=d[f],m=p.find(),b=o.clipPos(m.from),x=o.clipPos(m.to);if(me(b,x)){var T=Aa(o,b,x,p.primary,p.primary.type);p.markers.push(T),T.parent=p}}}function mM(o){for(var d=function(p){var m=o[p],b=[m.primary.doc];Qi(m.primary.doc,function(I){return b.push(I)});for(var x=0;x<m.markers.length;x++){var T=m.markers[x];Ce(b,T.doc)==-1&&(T.parent=null,m.markers.splice(x--,1))}},f=0;f<o.length;f++)d(f)}var vM=0,En=function(o,d,f,p,m){if(!(this instanceof En))return new En(o,d,f,p,m);f==null&&(f=0),ml.call(this,[new gl([new Sa("",null)])]),this.first=f,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=f;var b=Z(f,0);this.sel=Ki(b),this.history=new cc(null),this.id=++vM,this.modeOption=d,this.lineSep=p,this.direction=m=="rtl"?"rtl":"ltr",this.extend=!1,typeof o=="string"&&(o=this.splitLines(o)),gp(this,{from:b,to:b,text:o}),rn(this,Ki(b),Yt)};En.prototype=fr(ml.prototype,{constructor:En,iter:function(o,d,f){f?this.iterN(o-this.first,d-o,f):this.iterN(this.first,this.first+this.size,o)},insert:function(o,d){for(var f=0,p=0;p<d.length;++p)f+=d[p].height;this.insertInner(o-this.first,d,f)},remove:function(o,d){this.removeInner(o-this.first,d)},getValue:function(o){var d=Zo(this,this.first,this.first+this.size);return o===!1?d:d.join(o||this.lineSeparator())},setValue:Gt(function(o){var d=Z(this.first,0),f=this.first+this.size-1;Ra(this,{from:d,to:Z(f,Ie(this,f).text.length),text:this.splitLines(o),origin:"setValue",full:!0},!0),this.cm&&al(this.cm,0,0),rn(this,Ki(d),Yt)}),replaceRange:function(o,d,f,p){d=$e(this,d),f=f?$e(this,f):d,Ma(this,o,d,f,p)},getRange:function(o,d,f){var p=li(this,$e(this,o),$e(this,d));return f===!1?p:f===""?p.join(""):p.join(f||this.lineSeparator())},getLine:function(o){var d=this.getLineHandle(o);return d&&d.text},getLineHandle:function(o){if(ee(this,o))return Ie(this,o)},getLineNumber:function(o){return N(o)},getLineHandleVisualStart:function(o){return typeof o=="number"&&(o=Ie(this,o)),wr(o)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(o){return $e(this,o)},getCursor:function(o){var d=this.sel.primary(),f;return o==null||o=="head"?f=d.head:o=="anchor"?f=d.anchor:o=="end"||o=="to"||o===!1?f=d.to():f=d.from(),f},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:Gt(function(o,d,f){sb(this,$e(this,typeof o=="number"?Z(o,d||0):o),null,f)}),setSelection:Gt(function(o,d,f){sb(this,$e(this,o),$e(this,d||o),f)}),extendSelection:Gt(function(o,d,f){hc(this,$e(this,o),d&&$e(this,d),f)}),extendSelections:Gt(function(o,d){ib(this,Yy(this,o),d)}),extendSelectionsBy:Gt(function(o,d){var f=Kn(this.sel.ranges,o);ib(this,Yy(this,f),d)}),setSelections:Gt(function(o,d,f){if(o.length){for(var p=[],m=0;m<o.length;m++)p[m]=new tt($e(this,o[m].anchor),$e(this,o[m].head||o[m].anchor));d==null&&(d=Math.min(o.length-1,this.sel.primIndex)),rn(this,Cr(this.cm,p,d),f)}}),addSelection:Gt(function(o,d,f){var p=this.sel.ranges.slice(0);p.push(new tt($e(this,o),$e(this,d||o))),rn(this,Cr(this.cm,p,p.length-1),f)}),getSelection:function(o){for(var d=this.sel.ranges,f,p=0;p<d.length;p++){var m=li(this,d[p].from(),d[p].to());f=f?f.concat(m):m}return o===!1?f:f.join(o||this.lineSeparator())},getSelections:function(o){for(var d=[],f=this.sel.ranges,p=0;p<f.length;p++){var m=li(this,f[p].from(),f[p].to());o!==!1&&(m=m.join(o||this.lineSeparator())),d[p]=m}return d},replaceSelection:function(o,d,f){for(var p=[],m=0;m<this.sel.ranges.length;m++)p[m]=o;this.replaceSelections(p,d,f||"+input")},replaceSelections:Gt(function(o,d,f){for(var p=[],m=this.sel,b=0;b<m.ranges.length;b++){var x=m.ranges[b];p[b]={from:x.from(),to:x.to(),text:this.splitLines(o[b]),origin:f}}for(var T=d&&d!="end"&&iM(this,p,d),I=p.length-1;I>=0;I--)Ra(this,p[I]);T?ab(this,T):this.cm&&La(this.cm)}),undo:Gt(function(){gc(this,"undo")}),redo:Gt(function(){gc(this,"redo")}),undoSelection:Gt(function(){gc(this,"undo",!0)}),redoSelection:Gt(function(){gc(this,"redo",!0)}),setExtending:function(o){this.extend=o},getExtending:function(){return this.extend},historySize:function(){for(var o=this.history,d=0,f=0,p=0;p<o.done.length;p++)o.done[p].ranges||++d;for(var m=0;m<o.undone.length;m++)o.undone[m].ranges||++f;return{undo:d,redo:f}},clearHistory:function(){var o=this;this.history=new cc(this.history),Qi(this,function(d){return d.history=o.history},!0)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(o){return o&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(o){return this.history.generation==(o||this.cleanGeneration)},getHistory:function(){return{done:Da(this.history.done),undone:Da(this.history.undone)}},setHistory:function(o){var d=this.history=new cc(this.history);d.done=Da(o.done.slice(0),null,!0),d.undone=Da(o.undone.slice(0),null,!0)},setGutterMarker:Gt(function(o,d,f){return fl(this,o,"gutter",function(p){var m=p.gutterMarkers||(p.gutterMarkers={});return m[d]=f,!f&&Gd(m)&&(p.gutterMarkers=null),!0})}),clearGutter:Gt(function(o){var d=this;this.iter(function(f){f.gutterMarkers&&f.gutterMarkers[o]&&fl(d,f,"gutter",function(){return f.gutterMarkers[o]=null,Gd(f.gutterMarkers)&&(f.gutterMarkers=null),!0})})}),lineInfo:function(o){var d;if(typeof o=="number"){if(!ee(this,o)||(d=o,o=Ie(this,o),!o))return null}else if(d=N(o),d==null)return null;return{line:d,handle:o,text:o.text,gutterMarkers:o.gutterMarkers,textClass:o.textClass,bgClass:o.bgClass,wrapClass:o.wrapClass,widgets:o.widgets}},addLineClass:Gt(function(o,d,f){return fl(this,o,d=="gutter"?"gutter":"class",function(p){var m=d=="text"?"textClass":d=="background"?"bgClass":d=="gutter"?"gutterClass":"wrapClass";if(!p[m])p[m]=f;else{if(H(f).test(p[m]))return!1;p[m]+=" "+f}return!0})}),removeLineClass:Gt(function(o,d,f){return fl(this,o,d=="gutter"?"gutter":"class",function(p){var m=d=="text"?"textClass":d=="background"?"bgClass":d=="gutter"?"gutterClass":"wrapClass",b=p[m];if(b)if(f==null)p[m]=null;else{var x=b.match(H(f));if(!x)return!1;var T=x.index+x[0].length;p[m]=b.slice(0,x.index)+(!x.index||T==b.length?"":" ")+b.slice(T)||null}else return!1;return!0})}),addLineWidget:Gt(function(o,d,f){return pM(this,o,d,f)}),removeLineWidget:function(o){o.clear()},markText:function(o,d,f){return Aa(this,$e(this,o),$e(this,d),f,f&&f.type||"range")},setBookmark:function(o,d){var f={replacedWith:d&&(d.nodeType==null?d.widget:d),insertLeft:d&&d.insertLeft,clearWhenEmpty:!1,shared:d&&d.shared,handleMouseEvents:d&&d.handleMouseEvents};return o=$e(this,o),Aa(this,o,o,f,"bookmark")},findMarksAt:function(o){o=$e(this,o);var d=[],f=Ie(this,o.line).markedSpans;if(f)for(var p=0;p<f.length;++p){var m=f[p];(m.from==null||m.from<=o.ch)&&(m.to==null||m.to>=o.ch)&&d.push(m.marker.parent||m.marker)}return d},findMarks:function(o,d,f){o=$e(this,o),d=$e(this,d);var p=[],m=o.line;return this.iter(o.line,d.line+1,function(b){var x=b.markedSpans;if(x)for(var T=0;T<x.length;T++){var I=x[T];!(I.to!=null&&m==o.line&&o.ch>=I.to||I.from==null&&m!=o.line||I.from!=null&&m==d.line&&I.from>=d.ch)&&(!f||f(I.marker))&&p.push(I.marker.parent||I.marker)}++m}),p},getAllMarks:function(){var o=[];return this.iter(function(d){var f=d.markedSpans;if(f)for(var p=0;p<f.length;++p)f[p].from!=null&&o.push(f[p].marker)}),o},posFromIndex:function(o){var d,f=this.first,p=this.lineSeparator().length;return this.iter(function(m){var b=m.text.length+p;if(b>o)return d=o,!0;o-=b,++f}),$e(this,Z(f,d))},indexFromPos:function(o){o=$e(this,o);var d=o.ch;if(o.line<this.first||o.ch<0)return 0;var f=this.lineSeparator().length;return this.iter(this.first,o.line,function(p){d+=p.text.length+f}),d},copy:function(o){var d=new En(Zo(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return d.scrollTop=this.scrollTop,d.scrollLeft=this.scrollLeft,d.sel=this.sel,d.extend=!1,o&&(d.history.undoDepth=this.history.undoDepth,d.setHistory(this.getHistory())),d},linkedDoc:function(o){o||(o={});var d=this.first,f=this.first+this.size;o.from!=null&&o.from>d&&(d=o.from),o.to!=null&&o.to<f&&(f=o.to);var p=new En(Zo(this,d,f),o.mode||this.modeOption,d,this.lineSep,this.direction);return o.sharedHist&&(p.history=this.history),(this.linked||(this.linked=[])).push({doc:p,sharedHist:o.sharedHist}),p.linked=[{doc:this,isParent:!0,sharedHist:o.sharedHist}],gM(p,wb(this)),p},unlinkDoc:function(o){if(o instanceof mt&&(o=o.doc),this.linked)for(var d=0;d<this.linked.length;++d){var f=this.linked[d];if(f.doc==o){this.linked.splice(d,1),o.unlinkDoc(this),mM(wb(this));break}}if(o.history==this.history){var p=[o.id];Qi(o,function(m){return p.push(m.id)},!0),o.history=new cc(null),o.history.done=Da(this.history.done,p),o.history.undone=Da(this.history.undone,p)}},iterLinkedDocs:function(o){Qi(this,o)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(o){return this.lineSep?o.split(this.lineSep):Qn(o)},lineSeparator:function(){return this.lineSep||`
`},setDirection:Gt(function(o){o!="rtl"&&(o="ltr"),o!=this.direction&&(this.direction=o,this.iter(function(d){return d.order=null}),this.cm&&sM(this.cm))})}),En.prototype.eachLine=En.prototype.iter;var Sb=0;function yM(o){var d=this;if(Cb(d),!(wt(d,o)||ui(d.display,o))){nn(o),c&&(Sb=+new Date);var f=As(d,o,!0),p=o.dataTransfer.files;if(!(!f||d.isReadOnly()))if(p&&p.length&&window.FileReader&&window.File)for(var m=p.length,b=Array(m),x=0,T=function(){++x==m&&zt(d,function(){f=$e(d.doc,f);var J={from:f,to:f,text:d.doc.splitLines(b.filter(function(Q){return Q!=null}).join(d.doc.lineSeparator())),origin:"paste"};Ra(d.doc,J),ab(d.doc,Ki($e(d.doc,f),$e(d.doc,Zi(J))))})()},I=function(J,Q){if(d.options.allowDropFileTypes&&Ce(d.options.allowDropFileTypes,J.type)==-1){T();return}var re=new FileReader;re.onerror=function(){return T()},re.onload=function(){var ue=re.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(ue)){T();return}b[Q]=ue,T()},re.readAsText(J)},A=0;A<p.length;A++)I(p[A],A);else{if(d.state.draggingText&&d.doc.sel.contains(f)>-1){d.state.draggingText(o),setTimeout(function(){return d.display.input.focus()},20);return}try{var $=o.dataTransfer.getData("Text");if($){var W;if(d.state.draggingText&&!d.state.draggingText.copy&&(W=d.listSelections()),pc(d.doc,Ki(f,f)),W)for(var Y=0;Y<W.length;++Y)Ma(d.doc,"",W[Y].anchor,W[Y].head,"drag");d.replaceSelection($,"around","paste"),d.display.input.focus()}}catch{}}}}function bM(o,d){if(c&&(!o.state.draggingText||+new Date-Sb<100)){Wi(d);return}if(!(wt(o,d)||ui(o.display,d))&&(d.dataTransfer.setData("Text",o.getSelection()),d.dataTransfer.effectAllowed="copyMove",d.dataTransfer.setDragImage&&!S)){var f=F("img",null,null,"position: fixed; left: 0; top: 0;");f.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",C&&(f.width=f.height=1,o.display.wrapper.appendChild(f),f._top=f.offsetTop),d.dataTransfer.setDragImage(f,0,0),C&&f.parentNode.removeChild(f)}}function wM(o,d){var f=As(o,d);if(f){var p=document.createDocumentFragment();np(o,f,p),o.display.dragCursor||(o.display.dragCursor=F("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),o.display.lineSpace.insertBefore(o.display.dragCursor,o.display.cursorDiv)),z(o.display.dragCursor,p)}}function Cb(o){o.display.dragCursor&&(o.display.lineSpace.removeChild(o.display.dragCursor),o.display.dragCursor=null)}function xb(o){if(document.getElementsByClassName){for(var d=document.getElementsByClassName("CodeMirror"),f=[],p=0;p<d.length;p++){var m=d[p].CodeMirror;m&&f.push(m)}f.length&&f[0].operation(function(){for(var b=0;b<f.length;b++)o(f[b])})}}var Eb=!1;function SM(){Eb||(CM(),Eb=!0)}function CM(){var o;Ve(window,"resize",function(){o==null&&(o=setTimeout(function(){o=null,xb(xM)},100))}),Ve(window,"blur",function(){return xb(ka)})}function xM(o){var d=o.display;d.cachedCharWidth=d.cachedTextHeight=d.cachedPaddingH=null,d.scrollbarsClipped=!1,o.setSize()}for(var ts={3:"Pause",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",145:"ScrollLock",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",224:"Mod",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},bl=0;bl<10;bl++)ts[bl+48]=ts[bl+96]=String(bl);for(var mc=65;mc<=90;mc++)ts[mc]=String.fromCharCode(mc);for(var wl=1;wl<=12;wl++)ts[wl+111]=ts[wl+63235]="F"+wl;var pi={};pi.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},pi.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},pi.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},pi.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},pi.default=L?pi.macDefault:pi.pcDefault;function EM(o){var d=o.split(/-(?!$)/);o=d[d.length-1];for(var f,p,m,b,x=0;x<d.length-1;x++){var T=d[x];if(/^(cmd|meta|m)$/i.test(T))b=!0;else if(/^a(lt)?$/i.test(T))f=!0;else if(/^(c|ctrl|control)$/i.test(T))p=!0;else if(/^s(hift)?$/i.test(T))m=!0;else throw new Error("Unrecognized modifier name: "+T)}return f&&(o="Alt-"+o),p&&(o="Ctrl-"+o),b&&(o="Cmd-"+o),m&&(o="Shift-"+o),o}function TM(o){var d={};for(var f in o)if(o.hasOwnProperty(f)){var p=o[f];if(/^(name|fallthrough|(de|at)tach)$/.test(f))continue;if(p=="..."){delete o[f];continue}for(var m=Kn(f.split(" "),EM),b=0;b<m.length;b++){var x=void 0,T=void 0;b==m.length-1?(T=m.join(" "),x=p):(T=m.slice(0,b+1).join(" "),x="...");var I=d[T];if(!I)d[T]=x;else if(I!=x)throw new Error("Inconsistent bindings for "+T)}delete o[f]}for(var A in d)o[A]=d[A];return o}function Na(o,d,f,p){d=vc(d);var m=d.call?d.call(o,p):d[o];if(m===!1)return"nothing";if(m==="...")return"multi";if(m!=null&&f(m))return"handled";if(d.fallthrough){if(Object.prototype.toString.call(d.fallthrough)!="[object Array]")return Na(o,d.fallthrough,f,p);for(var b=0;b<d.fallthrough.length;b++){var x=Na(o,d.fallthrough[b],f,p);if(x)return x}}}function Tb(o){var d=typeof o=="string"?o:ts[o.keyCode];return d=="Ctrl"||d=="Alt"||d=="Shift"||d=="Mod"}function kb(o,d,f){var p=o;return d.altKey&&p!="Alt"&&(o="Alt-"+o),(B?d.metaKey:d.ctrlKey)&&p!="Ctrl"&&(o="Ctrl-"+o),(B?d.ctrlKey:d.metaKey)&&p!="Mod"&&(o="Cmd-"+o),!f&&d.shiftKey&&p!="Shift"&&(o="Shift-"+o),o}function Lb(o,d){if(C&&o.keyCode==34&&o.char)return!1;var f=ts[o.keyCode];return f==null||o.altGraphKey?!1:(o.keyCode==3&&o.code&&(f=o.code),kb(f,o,d))}function vc(o){return typeof o=="string"?pi[o]:o}function Va(o,d){for(var f=o.doc.sel.ranges,p=[],m=0;m<f.length;m++){for(var b=d(f[m]);p.length&&me(b.from,He(p).to)<=0;){var x=p.pop();if(me(x.from,b.from)<0){b.from=x.from;break}}p.push(b)}On(o,function(){for(var T=p.length-1;T>=0;T--)Ma(o.doc,"",p[T].from,p[T].to,"+delete");La(o)})}function bp(o,d,f){var p=$i(o.text,d+f,f);return p<0||p>o.text.length?null:p}function wp(o,d,f){var p=bp(o,d.ch,f);return p==null?null:new Z(d.line,p,f<0?"after":"before")}function Sp(o,d,f,p,m){if(o){d.doc.direction=="rtl"&&(m=-m);var b=qe(f,d.doc.direction);if(b){var x=m<0?He(b):b[0],T=m<0==(x.level==1),I=T?"after":"before",A;if(x.level>0||d.doc.direction=="rtl"){var $=xa(d,f);A=m<0?f.text.length-1:0;var W=_r(d,$,A).top;A=Vr(function(Y){return _r(d,$,Y).top==W},m<0==(x.level==1)?x.from:x.to-1,A),I=="before"&&(A=bp(f,A,1))}else A=m<0?x.to:x.from;return new Z(p,A,I)}}return new Z(p,m<0?f.text.length:0,m<0?"before":"after")}function kM(o,d,f,p){var m=qe(d,o.doc.direction);if(!m)return wp(d,f,p);f.ch>=d.text.length?(f.ch=d.text.length,f.sticky="before"):f.ch<=0&&(f.ch=0,f.sticky="after");var b=Gi(m,f.ch,f.sticky),x=m[b];if(o.doc.direction=="ltr"&&x.level%2==0&&(p>0?x.to>f.ch:x.from<f.ch))return wp(d,f,p);var T=function(pe,be){return bp(d,pe instanceof Z?pe.ch:pe,be)},I,A=function(pe){return o.options.lineWrapping?(I=I||xa(o,d),M0(o,d,I,pe)):{begin:0,end:d.text.length}},$=A(f.sticky=="before"?T(f,-1):f.ch);if(o.doc.direction=="rtl"||x.level==1){var W=x.level==1==p<0,Y=T(f,W?1:-1);if(Y!=null&&(W?Y<=x.to&&Y<=$.end:Y>=x.from&&Y>=$.begin)){var J=W?"before":"after";return new Z(f.line,Y,J)}}var Q=function(pe,be,fe){for(var xe=function(ht,Wt){return Wt?new Z(f.line,T(ht,1),"before"):new Z(f.line,ht,"after")};pe>=0&&pe<m.length;pe+=be){var Be=m[pe],Ae=be>0==(Be.level!=1),je=Ae?fe.begin:T(fe.end,-1);if(Be.from<=je&&je<Be.to||(je=Ae?Be.from:T(Be.to,-1),fe.begin<=je&&je<fe.end))return xe(je,Ae)}},re=Q(b+p,p,$);if(re)return re;var ue=p>0?$.end:T($.begin,-1);return ue!=null&&!(p>0&&ue==d.text.length)&&(re=Q(p>0?0:m.length-1,p,A(ue)),re)?re:null}var Sl={selectAll:ub,singleSelection:function(o){return o.setSelection(o.getCursor("anchor"),o.getCursor("head"),Yt)},killLine:function(o){return Va(o,function(d){if(d.empty()){var f=Ie(o.doc,d.head.line).text.length;return d.head.ch==f&&d.head.line<o.lastLine()?{from:d.head,to:Z(d.head.line+1,0)}:{from:d.head,to:Z(d.head.line,f)}}else return{from:d.from(),to:d.to()}})},deleteLine:function(o){return Va(o,function(d){return{from:Z(d.from().line,0),to:$e(o.doc,Z(d.to().line+1,0))}})},delLineLeft:function(o){return Va(o,function(d){return{from:Z(d.from().line,0),to:d.from()}})},delWrappedLineLeft:function(o){return Va(o,function(d){var f=o.charCoords(d.head,"div").top+5,p=o.coordsChar({left:0,top:f},"div");return{from:p,to:d.from()}})},delWrappedLineRight:function(o){return Va(o,function(d){var f=o.charCoords(d.head,"div").top+5,p=o.coordsChar({left:o.display.lineDiv.offsetWidth+100,top:f},"div");return{from:d.from(),to:p}})},undo:function(o){return o.undo()},redo:function(o){return o.redo()},undoSelection:function(o){return o.undoSelection()},redoSelection:function(o){return o.redoSelection()},goDocStart:function(o){return o.extendSelection(Z(o.firstLine(),0))},goDocEnd:function(o){return o.extendSelection(Z(o.lastLine()))},goLineStart:function(o){return o.extendSelectionsBy(function(d){return Ib(o,d.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(o){return o.extendSelectionsBy(function(d){return Db(o,d.head)},{origin:"+move",bias:1})},goLineEnd:function(o){return o.extendSelectionsBy(function(d){return LM(o,d.head.line)},{origin:"+move",bias:-1})},goLineRight:function(o){return o.extendSelectionsBy(function(d){var f=o.cursorCoords(d.head,"div").top+5;return o.coordsChar({left:o.display.lineDiv.offsetWidth+100,top:f},"div")},Xt)},goLineLeft:function(o){return o.extendSelectionsBy(function(d){var f=o.cursorCoords(d.head,"div").top+5;return o.coordsChar({left:0,top:f},"div")},Xt)},goLineLeftSmart:function(o){return o.extendSelectionsBy(function(d){var f=o.cursorCoords(d.head,"div").top+5,p=o.coordsChar({left:0,top:f},"div");return p.ch<o.getLine(p.line).search(/\S/)?Db(o,d.head):p},Xt)},goLineUp:function(o){return o.moveV(-1,"line")},goLineDown:function(o){return o.moveV(1,"line")},goPageUp:function(o){return o.moveV(-1,"page")},goPageDown:function(o){return o.moveV(1,"page")},goCharLeft:function(o){return o.moveH(-1,"char")},goCharRight:function(o){return o.moveH(1,"char")},goColumnLeft:function(o){return o.moveH(-1,"column")},goColumnRight:function(o){return o.moveH(1,"column")},goWordLeft:function(o){return o.moveH(-1,"word")},goGroupRight:function(o){return o.moveH(1,"group")},goGroupLeft:function(o){return o.moveH(-1,"group")},goWordRight:function(o){return o.moveH(1,"word")},delCharBefore:function(o){return o.deleteH(-1,"codepoint")},delCharAfter:function(o){return o.deleteH(1,"char")},delWordBefore:function(o){return o.deleteH(-1,"word")},delWordAfter:function(o){return o.deleteH(1,"word")},delGroupBefore:function(o){return o.deleteH(-1,"group")},delGroupAfter:function(o){return o.deleteH(1,"group")},indentAuto:function(o){return o.indentSelection("smart")},indentMore:function(o){return o.indentSelection("add")},indentLess:function(o){return o.indentSelection("subtract")},insertTab:function(o){return o.replaceSelection("	")},insertSoftTab:function(o){for(var d=[],f=o.listSelections(),p=o.options.tabSize,m=0;m<f.length;m++){var b=f[m].from(),x=Fe(o.getLine(b.line),b.ch,p);d.push(pr(p-x%p))}o.replaceSelections(d)},defaultTab:function(o){o.somethingSelected()?o.indentSelection("add"):o.execCommand("insertTab")},transposeChars:function(o){return On(o,function(){for(var d=o.listSelections(),f=[],p=0;p<d.length;p++)if(d[p].empty()){var m=d[p].head,b=Ie(o.doc,m.line).text;if(b){if(m.ch==b.length&&(m=new Z(m.line,m.ch-1)),m.ch>0)m=new Z(m.line,m.ch+1),o.replaceRange(b.charAt(m.ch-1)+b.charAt(m.ch-2),Z(m.line,m.ch-2),m,"+transpose");else if(m.line>o.doc.first){var x=Ie(o.doc,m.line-1).text;x&&(m=new Z(m.line,1),o.replaceRange(b.charAt(0)+o.doc.lineSeparator()+x.charAt(x.length-1),Z(m.line-1,x.length-1),m,"+transpose"))}}f.push(new tt(m,m))}o.setSelections(f)})},newlineAndIndent:function(o){return On(o,function(){for(var d=o.listSelections(),f=d.length-1;f>=0;f--)o.replaceRange(o.doc.lineSeparator(),d[f].anchor,d[f].head,"+input");d=o.listSelections();for(var p=0;p<d.length;p++)o.indentLine(d[p].from().line,null,!0);La(o)})},openLine:function(o){return o.replaceSelection(`
`,"start")},toggleOverwrite:function(o){return o.toggleOverwrite()}};function Ib(o,d){var f=Ie(o.doc,d),p=wr(f);return p!=f&&(d=N(p)),Sp(!0,o,p,d,1)}function LM(o,d){var f=Ie(o.doc,d),p=cR(f);return p!=f&&(d=N(p)),Sp(!0,o,f,d,-1)}function Db(o,d){var f=Ib(o,d.line),p=Ie(o.doc,f.line),m=qe(p,o.doc.direction);if(!m||m[0].level==0){var b=Math.max(f.ch,p.text.search(/\S/)),x=d.line==f.line&&d.ch<=b&&d.ch;return Z(f.line,x?0:b,f.sticky)}return f}function yc(o,d,f){if(typeof d=="string"&&(d=Sl[d],!d))return!1;o.display.input.ensurePolled();var p=o.display.shift,m=!1;try{o.isReadOnly()&&(o.state.suppressEdits=!0),f&&(o.display.shift=!1),m=d(o)!=_t}finally{o.display.shift=p,o.state.suppressEdits=!1}return m}function IM(o,d,f){for(var p=0;p<o.state.keyMaps.length;p++){var m=Na(d,o.state.keyMaps[p],f,o);if(m)return m}return o.options.extraKeys&&Na(d,o.options.extraKeys,f,o)||Na(d,o.options.keyMap,f,o)}var DM=new Ue;function Cl(o,d,f,p){var m=o.state.keySeq;if(m){if(Tb(d))return"handled";if(/\'$/.test(d)?o.state.keySeq=null:DM.set(50,function(){o.state.keySeq==m&&(o.state.keySeq=null,o.display.input.reset())}),Pb(o,m+" "+d,f,p))return!0}return Pb(o,d,f,p)}function Pb(o,d,f,p){var m=IM(o,d,p);return m=="multi"&&(o.state.keySeq=d),m=="handled"&&$t(o,"keyHandled",o,d,f),(m=="handled"||m=="multi")&&(nn(f),rp(o)),!!m}function Rb(o,d){var f=Lb(d,!0);return f?d.shiftKey&&!o.state.keySeq?Cl(o,"Shift-"+f,d,function(p){return yc(o,p,!0)})||Cl(o,f,d,function(p){if(typeof p=="string"?/^go[A-Z]/.test(p):p.motion)return yc(o,p)}):Cl(o,f,d,function(p){return yc(o,p)}):!1}function PM(o,d,f){return Cl(o,"'"+f+"'",d,function(p){return yc(o,p,!0)})}var Cp=null;function Mb(o){var d=this;if(!(o.target&&o.target!=d.display.input.getField())&&(d.curOp.focus=le(_e(d)),!wt(d,o))){c&&u<11&&o.keyCode==27&&(o.returnValue=!1);var f=o.keyCode;d.display.shift=f==16||o.shiftKey;var p=Rb(d,o);C&&(Cp=p?f:null,!p&&f==88&&!Hd&&(L?o.metaKey:o.ctrlKey)&&d.replaceSelection("",null,"cut")),i&&!L&&!p&&f==46&&o.shiftKey&&!o.ctrlKey&&document.execCommand&&document.execCommand("cut"),f==18&&!/\bCodeMirror-crosshair\b/.test(d.display.lineDiv.className)&&RM(d)}}function RM(o){var d=o.display.lineDiv;Se(d,"CodeMirror-crosshair");function f(p){(p.keyCode==18||!p.altKey)&&(U(d,"CodeMirror-crosshair"),tn(document,"keyup",f),tn(document,"mouseover",f))}Ve(document,"keyup",f),Ve(document,"mouseover",f)}function Ab(o){o.keyCode==16&&(this.doc.sel.shift=!1),wt(this,o)}function Nb(o){var d=this;if(!(o.target&&o.target!=d.display.input.getField())&&!(ui(d.display,o)||wt(d,o)||o.ctrlKey&&!o.altKey||L&&o.metaKey)){var f=o.keyCode,p=o.charCode;if(C&&f==Cp){Cp=null,nn(o);return}if(!(C&&(!o.which||o.which<10)&&Rb(d,o))){var m=String.fromCharCode(p??f);m!="\b"&&(PM(d,o,m)||d.display.input.onKeyPress(o))}}}var MM=400,xp=function(o,d,f){this.time=o,this.pos=d,this.button=f};xp.prototype.compare=function(o,d,f){return this.time+MM>o&&me(d,this.pos)==0&&f==this.button};var xl,El;function AM(o,d){var f=+new Date;return El&&El.compare(f,o,d)?(xl=El=null,"triple"):xl&&xl.compare(f,o,d)?(El=new xp(f,o,d),xl=null,"double"):(xl=new xp(f,o,d),El=null,"single")}function Vb(o){var d=this,f=d.display;if(!(wt(d,o)||f.activeTouch&&f.input.supportsTouch())){if(f.input.ensurePolled(),f.shift=o.shiftKey,ui(f,o)){h||(f.scroller.draggable=!1,setTimeout(function(){return f.scroller.draggable=!0},100));return}if(!Ep(d,o)){var p=As(d,o),m=mr(o),b=p?AM(p,m):"single";De(d).focus(),m==1&&d.state.selectingText&&d.state.selectingText(o),!(p&&NM(d,m,p,b,o))&&(m==1?p?OM(d,p,b,o):Yo(o)==f.scroller&&nn(o):m==2?(p&&hc(d.doc,p),setTimeout(function(){return f.input.focus()},20)):m==3&&(_?d.display.input.onContextMenu(o):ip(d)))}}}function NM(o,d,f,p,m){var b="Click";return p=="double"?b="Double"+b:p=="triple"&&(b="Triple"+b),b=(d==1?"Left":d==2?"Middle":"Right")+b,Cl(o,kb(b,m),m,function(x){if(typeof x=="string"&&(x=Sl[x]),!x)return!1;var T=!1;try{o.isReadOnly()&&(o.state.suppressEdits=!0),T=x(o,f)!=_t}finally{o.state.suppressEdits=!1}return T})}function VM(o,d,f){var p=o.getOption("configureMouse"),m=p?p(o,d,f):{};if(m.unit==null){var b=R?f.shiftKey&&f.metaKey:f.altKey;m.unit=b?"rectangle":d=="single"?"char":d=="double"?"word":"line"}return(m.extend==null||o.doc.extend)&&(m.extend=o.doc.extend||f.shiftKey),m.addNew==null&&(m.addNew=L?f.metaKey:f.ctrlKey),m.moveOnDrag==null&&(m.moveOnDrag=!(L?f.altKey:f.ctrlKey)),m}function OM(o,d,f,p){c?setTimeout(Ee(O0,o),0):o.curOp.focus=le(_e(o));var m=VM(o,f,p),b=o.doc.sel,x;o.options.dragDrop&&Oh&&!o.isReadOnly()&&f=="single"&&(x=b.contains(d))>-1&&(me((x=b.ranges[x]).from(),d)<0||d.xRel>0)&&(me(x.to(),d)>0||d.xRel<0)?BM(o,p,d,m):FM(o,p,d,m)}function BM(o,d,f,p){var m=o.display,b=!1,x=zt(o,function(A){h&&(m.scroller.draggable=!1),o.state.draggingText=!1,o.state.delayingBlurEvent&&(o.hasFocus()?o.state.delayingBlurEvent=!1:ip(o)),tn(m.wrapper.ownerDocument,"mouseup",x),tn(m.wrapper.ownerDocument,"mousemove",T),tn(m.scroller,"dragstart",I),tn(m.scroller,"drop",x),b||(nn(A),p.addNew||hc(o.doc,f,null,null,p.extend),h&&!S||c&&u==9?setTimeout(function(){m.wrapper.ownerDocument.body.focus({preventScroll:!0}),m.input.focus()},20):m.input.focus())}),T=function(A){b=b||Math.abs(d.clientX-A.clientX)+Math.abs(d.clientY-A.clientY)>=10},I=function(){return b=!0};h&&(m.scroller.draggable=!0),o.state.draggingText=x,x.copy=!p.moveOnDrag,Ve(m.wrapper.ownerDocument,"mouseup",x),Ve(m.wrapper.ownerDocument,"mousemove",T),Ve(m.scroller,"dragstart",I),Ve(m.scroller,"drop",x),o.state.delayingBlurEvent=!0,setTimeout(function(){return m.input.focus()},20),m.scroller.dragDrop&&m.scroller.dragDrop()}function Ob(o,d,f){if(f=="char")return new tt(d,d);if(f=="word")return o.findWordAt(d);if(f=="line")return new tt(Z(d.line,0),$e(o.doc,Z(d.line+1,0)));var p=f(o,d);return new tt(p.from,p.to)}function FM(o,d,f,p){c&&ip(o);var m=o.display,b=o.doc;nn(d);var x,T,I=b.sel,A=I.ranges;if(p.addNew&&!p.extend?(T=b.sel.contains(f),T>-1?x=A[T]:x=new tt(f,f)):(x=b.sel.primary(),T=b.sel.primIndex),p.unit=="rectangle")p.addNew||(x=new tt(f,f)),f=As(o,d,!0,!0),T=-1;else{var $=Ob(o,f,p.unit);p.extend?x=vp(x,$.anchor,$.head,p.extend):x=$}p.addNew?T==-1?(T=A.length,rn(b,Cr(o,A.concat([x]),T),{scroll:!1,origin:"*mouse"})):A.length>1&&A[T].empty()&&p.unit=="char"&&!p.extend?(rn(b,Cr(o,A.slice(0,T).concat(A.slice(T+1)),0),{scroll:!1,origin:"*mouse"}),I=b.sel):yp(b,T,x,bn):(T=0,rn(b,new jn([x],0),bn),I=b.sel);var W=f;function Y(fe){if(me(W,fe)!=0)if(W=fe,p.unit=="rectangle"){for(var xe=[],Be=o.options.tabSize,Ae=Fe(Ie(b,f.line).text,f.ch,Be),je=Fe(Ie(b,fe.line).text,fe.ch,Be),ht=Math.min(Ae,je),Wt=Math.max(Ae,je),yt=Math.min(f.line,fe.line),Bn=Math.min(o.lastLine(),Math.max(f.line,fe.line));yt<=Bn;yt++){var Tn=Ie(b,yt).text,Mt=dn(Tn,ht,Be);ht==Wt?xe.push(new tt(Z(yt,Mt),Z(yt,Mt))):Tn.length>Mt&&xe.push(new tt(Z(yt,Mt),Z(yt,dn(Tn,Wt,Be))))}xe.length||xe.push(new tt(f,f)),rn(b,Cr(o,I.ranges.slice(0,T).concat(xe),T),{origin:"*mouse",scroll:!1}),o.scrollIntoView(fe)}else{var kn=x,Kt=Ob(o,fe,p.unit),Bt=kn.anchor,At;me(Kt.anchor,Bt)>0?(At=Kt.head,Bt=wa(kn.from(),Kt.anchor)):(At=Kt.anchor,Bt=Cn(kn.to(),Kt.head));var Ct=I.ranges.slice(0);Ct[T]=_M(o,new tt($e(b,Bt),At)),rn(b,Cr(o,Ct,T),bn)}}var J=m.wrapper.getBoundingClientRect(),Q=0;function re(fe){var xe=++Q,Be=As(o,fe,!0,p.unit=="rectangle");if(Be)if(me(Be,W)!=0){o.curOp.focus=le(_e(o)),Y(Be);var Ae=ac(m,b);(Be.line>=Ae.to||Be.line<Ae.from)&&setTimeout(zt(o,function(){Q==xe&&re(fe)}),150)}else{var je=fe.clientY<J.top?-20:fe.clientY>J.bottom?20:0;je&&setTimeout(zt(o,function(){Q==xe&&(m.scroller.scrollTop+=je,re(fe))}),50)}}function ue(fe){o.state.selectingText=!1,Q=1/0,fe&&(nn(fe),m.input.focus()),tn(m.wrapper.ownerDocument,"mousemove",pe),tn(m.wrapper.ownerDocument,"mouseup",be),b.history.lastSelOrigin=null}var pe=zt(o,function(fe){fe.buttons===0||!mr(fe)?ue(fe):re(fe)}),be=zt(o,ue);o.state.selectingText=be,Ve(m.wrapper.ownerDocument,"mousemove",pe),Ve(m.wrapper.ownerDocument,"mouseup",be)}function _M(o,d){var f=d.anchor,p=d.head,m=Ie(o.doc,f.line);if(me(f,p)==0&&f.sticky==p.sticky)return d;var b=qe(m);if(!b)return d;var x=Gi(b,f.ch,f.sticky),T=b[x];if(T.from!=f.ch&&T.to!=f.ch)return d;var I=x+(T.from==f.ch==(T.level!=1)?0:1);if(I==0||I==b.length)return d;var A;if(p.line!=f.line)A=(p.line-f.line)*(o.doc.direction=="ltr"?1:-1)>0;else{var $=Gi(b,p.ch,p.sticky),W=$-x||(p.ch-f.ch)*(T.level==1?-1:1);$==I-1||$==I?A=W<0:A=W>0}var Y=b[I+(A?-1:0)],J=A==(Y.level==1),Q=J?Y.from:Y.to,re=J?"after":"before";return f.ch==Q&&f.sticky==re?d:new tt(new Z(f.line,Q,re),p)}function Bb(o,d,f,p){var m,b;if(d.touches)m=d.touches[0].clientX,b=d.touches[0].clientY;else try{m=d.clientX,b=d.clientY}catch{return!1}if(m>=Math.floor(o.display.gutters.getBoundingClientRect().right))return!1;p&&nn(d);var x=o.display,T=x.lineDiv.getBoundingClientRect();if(b>T.bottom||!Vn(o,f))return Sn(d);b-=T.top-x.viewOffset;for(var I=0;I<o.display.gutterSpecs.length;++I){var A=x.gutters.childNodes[I];if(A&&A.getBoundingClientRect().right>=m){var $=G(o.doc,b),W=o.display.gutterSpecs[I];return bt(o,f,o,$,W.className,d),Sn(d)}}}function Ep(o,d){return Bb(o,d,"gutterClick",!0)}function Fb(o,d){ui(o.display,d)||UM(o,d)||wt(o,d,"contextmenu")||_||o.display.input.onContextMenu(d)}function UM(o,d){return Vn(o,"gutterContextMenu")?Bb(o,d,"gutterContextMenu",!1):!1}function _b(o){o.display.wrapper.className=o.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+o.options.theme.replace(/(^|\s)\s*/g," cm-s-"),il(o)}var Oa={toString:function(){return"CodeMirror.Init"}},Ub={},bc={};function $M(o){var d=o.optionHandlers;function f(p,m,b,x){o.defaults[p]=m,b&&(d[p]=x?function(T,I,A){A!=Oa&&b(T,I,A)}:b)}o.defineOption=f,o.Init=Oa,f("value","",function(p,m){return p.setValue(m)},!0),f("mode",null,function(p,m){p.doc.modeOption=m,fp(p)},!0),f("indentUnit",2,fp,!0),f("indentWithTabs",!1),f("smartIndent",!0),f("tabSize",4,function(p){hl(p),il(p),xn(p)},!0),f("lineSeparator",null,function(p,m){if(p.doc.lineSep=m,!!m){var b=[],x=p.doc.first;p.doc.iter(function(I){for(var A=0;;){var $=I.text.indexOf(m,A);if($==-1)break;A=$+m.length,b.push(Z(x,$))}x++});for(var T=b.length-1;T>=0;T--)Ma(p.doc,m,b[T],Z(b[T].line,b[T].ch+m.length))}}),f("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b\u200e\u200f\u2028\u2029\u202d\u202e\u2066\u2067\u2069\ufeff\ufff9-\ufffc]/g,function(p,m,b){p.state.specialChars=new RegExp(m.source+(m.test("	")?"":"|	"),"g"),b!=Oa&&p.refresh()}),f("specialCharPlaceholder",mR,function(p){return p.refresh()},!0),f("electricChars",!0),f("inputStyle",D?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),f("spellcheck",!1,function(p,m){return p.getInputField().spellcheck=m},!0),f("autocorrect",!1,function(p,m){return p.getInputField().autocorrect=m},!0),f("autocapitalize",!1,function(p,m){return p.getInputField().autocapitalize=m},!0),f("rtlMoveVisually",!M),f("wholeLineUpdateBefore",!0),f("theme","default",function(p){_b(p),ul(p)},!0),f("keyMap","default",function(p,m,b){var x=vc(m),T=b!=Oa&&vc(b);T&&T.detach&&T.detach(p,x),x.attach&&x.attach(p,T||null)}),f("extraKeys",null),f("configureMouse",null),f("lineWrapping",!1,GM,!0),f("gutters",[],function(p,m){p.display.gutterSpecs=hp(m,p.options.lineNumbers),ul(p)},!0),f("fixedGutter",!0,function(p,m){p.display.gutters.style.left=m?ep(p.display)+"px":"0",p.refresh()},!0),f("coverGutterNextToScrollbar",!1,function(p){return Ia(p)},!0),f("scrollbarStyle","native",function(p){z0(p),Ia(p),p.display.scrollbars.setScrollTop(p.doc.scrollTop),p.display.scrollbars.setScrollLeft(p.doc.scrollLeft)},!0),f("lineNumbers",!1,function(p,m){p.display.gutterSpecs=hp(p.options.gutters,m),ul(p)},!0),f("firstLineNumber",1,ul,!0),f("lineNumberFormatter",function(p){return p},ul,!0),f("showCursorWhenSelecting",!1,sl,!0),f("resetSelectionOnContextMenu",!0),f("lineWiseCopyCut",!0),f("pasteLinesPerSelection",!0),f("selectionsMayTouch",!1),f("readOnly",!1,function(p,m){m=="nocursor"&&(ka(p),p.display.input.blur()),p.display.input.readOnlyChanged(m)}),f("screenReaderLabel",null,function(p,m){m=m===""?null:m,p.display.input.screenReaderLabelChanged(m)}),f("disableInput",!1,function(p,m){m||p.display.input.reset()},!0),f("dragDrop",!0,zM),f("allowDropFileTypes",null),f("cursorBlinkRate",530),f("cursorScrollMargin",0),f("cursorHeight",1,sl,!0),f("singleCursorHeightPerLine",!0,sl,!0),f("workTime",100),f("workDelay",100),f("flattenSpans",!0,hl,!0),f("addModeClass",!1,hl,!0),f("pollInterval",100),f("undoDepth",200,function(p,m){return p.doc.history.undoDepth=m}),f("historyEventDelay",1250),f("viewportMargin",10,function(p){return p.refresh()},!0),f("maxHighlightLength",1e4,hl,!0),f("moveInputWithCursor",!0,function(p,m){m||p.display.input.resetPosition()}),f("tabindex",null,function(p,m){return p.display.input.getField().tabIndex=m||""}),f("autofocus",null),f("direction","ltr",function(p,m){return p.doc.setDirection(m)},!0),f("phrases",null)}function zM(o,d,f){var p=f&&f!=Oa;if(!d!=!p){var m=o.display.dragFunctions,b=d?Ve:tn;b(o.display.scroller,"dragstart",m.start),b(o.display.scroller,"dragenter",m.enter),b(o.display.scroller,"dragover",m.over),b(o.display.scroller,"dragleave",m.leave),b(o.display.scroller,"drop",m.drop)}}function GM(o){o.options.lineWrapping?(Se(o.display.wrapper,"CodeMirror-wrap"),o.display.sizer.style.minWidth="",o.display.sizerWidth=null):(U(o.display.wrapper,"CodeMirror-wrap"),Wh(o)),tp(o),xn(o),il(o),setTimeout(function(){return Ia(o)},100)}function mt(o,d){var f=this;if(!(this instanceof mt))return new mt(o,d);this.options=d=d?Me(d):{},Me(Ub,d,!1);var p=d.value;typeof p=="string"?p=new En(p,d.mode,null,d.lineSeparator,d.direction):d.mode&&(p.modeOption=d.mode),this.doc=p;var m=new mt.inputStyles[d.inputStyle](this),b=this.display=new nM(o,p,m,d);b.wrapper.CodeMirror=this,_b(this),d.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),z0(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:-1,cutIncoming:-1,selectingText:!1,draggingText:!1,highlight:new Ue,keySeq:null,specialChars:null},d.autofocus&&!D&&b.input.focus(),c&&u<11&&setTimeout(function(){return f.display.input.reset(!0)},20),WM(this),SM(),Bs(this),this.curOp.forceUpdate=!0,Z0(this,p),d.autofocus&&!D||this.hasFocus()?setTimeout(function(){f.hasFocus()&&!f.state.focused&&sp(f)},20):ka(this);for(var x in bc)bc.hasOwnProperty(x)&&bc[x](this,d[x],Oa);j0(this),d.finishInit&&d.finishInit(this);for(var T=0;T<Tp.length;++T)Tp[T](this);Fs(this),h&&d.lineWrapping&&getComputedStyle(b.lineDiv).textRendering=="optimizelegibility"&&(b.lineDiv.style.textRendering="auto")}mt.defaults=Ub,mt.optionHandlers=bc;function WM(o){var d=o.display;Ve(d.scroller,"mousedown",zt(o,Vb)),c&&u<11?Ve(d.scroller,"dblclick",zt(o,function(I){if(!wt(o,I)){var A=As(o,I);if(!(!A||Ep(o,I)||ui(o.display,I))){nn(I);var $=o.findWordAt(A);hc(o.doc,$.anchor,$.head)}}})):Ve(d.scroller,"dblclick",function(I){return wt(o,I)||nn(I)}),Ve(d.scroller,"contextmenu",function(I){return Fb(o,I)}),Ve(d.input.getField(),"contextmenu",function(I){d.scroller.contains(I.target)||Fb(o,I)});var f,p={end:0};function m(){d.activeTouch&&(f=setTimeout(function(){return d.activeTouch=null},1e3),p=d.activeTouch,p.end=+new Date)}function b(I){if(I.touches.length!=1)return!1;var A=I.touches[0];return A.radiusX<=1&&A.radiusY<=1}function x(I,A){if(A.left==null)return!0;var $=A.left-I.left,W=A.top-I.top;return $*$+W*W>400}Ve(d.scroller,"touchstart",function(I){if(!wt(o,I)&&!b(I)&&!Ep(o,I)){d.input.ensurePolled(),clearTimeout(f);var A=+new Date;d.activeTouch={start:A,moved:!1,prev:A-p.end<=300?p:null},I.touches.length==1&&(d.activeTouch.left=I.touches[0].pageX,d.activeTouch.top=I.touches[0].pageY)}}),Ve(d.scroller,"touchmove",function(){d.activeTouch&&(d.activeTouch.moved=!0)}),Ve(d.scroller,"touchend",function(I){var A=d.activeTouch;if(A&&!ui(d,I)&&A.left!=null&&!A.moved&&new Date-A.start<300){var $=o.coordsChar(d.activeTouch,"page"),W;!A.prev||x(A,A.prev)?W=new tt($,$):!A.prev.prev||x(A,A.prev.prev)?W=o.findWordAt($):W=new tt(Z($.line,0),$e(o.doc,Z($.line+1,0))),o.setSelection(W.anchor,W.head),o.focus(),nn(I)}m()}),Ve(d.scroller,"touchcancel",m),Ve(d.scroller,"scroll",function(){d.scroller.clientHeight&&(ol(o,d.scroller.scrollTop),Vs(o,d.scroller.scrollLeft,!0),bt(o,"scroll",o))}),Ve(d.scroller,"mousewheel",function(I){return J0(o,I)}),Ve(d.scroller,"DOMMouseScroll",function(I){return J0(o,I)}),Ve(d.wrapper,"scroll",function(){return d.wrapper.scrollTop=d.wrapper.scrollLeft=0}),d.dragFunctions={enter:function(I){wt(o,I)||Wi(I)},over:function(I){wt(o,I)||(wM(o,I),Wi(I))},start:function(I){return bM(o,I)},drop:zt(o,yM),leave:function(I){wt(o,I)||Cb(o)}};var T=d.input.getField();Ve(T,"keyup",function(I){return Ab.call(o,I)}),Ve(T,"keydown",zt(o,Mb)),Ve(T,"keypress",zt(o,Nb)),Ve(T,"focus",function(I){return sp(o,I)}),Ve(T,"blur",function(I){return ka(o,I)})}var Tp=[];mt.defineInitHook=function(o){return Tp.push(o)};function Tl(o,d,f,p){var m=o.doc,b;f==null&&(f="add"),f=="smart"&&(m.mode.indent?b=Qo(o,d).state:f="prev");var x=o.options.tabSize,T=Ie(m,d),I=Fe(T.text,null,x);T.stateAfter&&(T.stateAfter=null);var A=T.text.match(/^\s*/)[0],$;if(!p&&!/\S/.test(T.text))$=0,f="not";else if(f=="smart"&&($=m.mode.indent(b,T.text.slice(A.length),T.text),$==_t||$>150)){if(!p)return;f="prev"}f=="prev"?d>m.first?$=Fe(Ie(m,d-1).text,null,x):$=0:f=="add"?$=I+o.options.indentUnit:f=="subtract"?$=I-o.options.indentUnit:typeof f=="number"&&($=I+f),$=Math.max(0,$);var W="",Y=0;if(o.options.indentWithTabs)for(var J=Math.floor($/x);J;--J)Y+=x,W+="	";if(Y<$&&(W+=pr($-Y)),W!=A)return Ma(m,W,Z(d,0),Z(d,A.length),"+input"),T.stateAfter=null,!0;for(var Q=0;Q<m.sel.ranges.length;Q++){var re=m.sel.ranges[Q];if(re.head.line==d&&re.head.ch<A.length){var ue=Z(d,A.length);yp(m,Q,new tt(ue,ue));break}}}var xr=null;function wc(o){xr=o}function kp(o,d,f,p,m){var b=o.doc;o.display.shift=!1,p||(p=b.sel);var x=+new Date-200,T=m=="paste"||o.state.pasteIncoming>x,I=Qn(d),A=null;if(T&&p.ranges.length>1)if(xr&&xr.text.join(`
`)==d){if(p.ranges.length%xr.text.length==0){A=[];for(var $=0;$<xr.text.length;$++)A.push(b.splitLines(xr.text[$]))}}else I.length==p.ranges.length&&o.options.pasteLinesPerSelection&&(A=Kn(I,function(pe){return[pe]}));for(var W=o.curOp.updateInput,Y=p.ranges.length-1;Y>=0;Y--){var J=p.ranges[Y],Q=J.from(),re=J.to();J.empty()&&(f&&f>0?Q=Z(Q.line,Q.ch-f):o.state.overwrite&&!T?re=Z(re.line,Math.min(Ie(b,re.line).text.length,re.ch+He(I).length)):T&&xr&&xr.lineWise&&xr.text.join(`
`)==I.join(`
`)&&(Q=re=Z(Q.line,0)));var ue={from:Q,to:re,text:A?A[Y%A.length]:I,origin:m||(T?"paste":o.state.cutIncoming>x?"cut":"+input")};Ra(o.doc,ue),$t(o,"inputRead",o,ue)}d&&!T&&zb(o,d),La(o),o.curOp.updateInput<2&&(o.curOp.updateInput=W),o.curOp.typing=!0,o.state.pasteIncoming=o.state.cutIncoming=-1}function $b(o,d){var f=o.clipboardData&&o.clipboardData.getData("Text");if(f)return o.preventDefault(),!d.isReadOnly()&&!d.options.disableInput&&d.hasFocus()&&On(d,function(){return kp(d,f,0,null,"paste")}),!0}function zb(o,d){if(!(!o.options.electricChars||!o.options.smartIndent))for(var f=o.doc.sel,p=f.ranges.length-1;p>=0;p--){var m=f.ranges[p];if(!(m.head.ch>100||p&&f.ranges[p-1].head.line==m.head.line)){var b=o.getModeAt(m.head),x=!1;if(b.electricChars){for(var T=0;T<b.electricChars.length;T++)if(d.indexOf(b.electricChars.charAt(T))>-1){x=Tl(o,m.head.line,"smart");break}}else b.electricInput&&b.electricInput.test(Ie(o.doc,m.head.line).text.slice(0,m.head.ch))&&(x=Tl(o,m.head.line,"smart"));x&&$t(o,"electricInput",o,m.head.line)}}}function Gb(o){for(var d=[],f=[],p=0;p<o.doc.sel.ranges.length;p++){var m=o.doc.sel.ranges[p].head.line,b={anchor:Z(m,0),head:Z(m+1,0)};f.push(b),d.push(o.getRange(b.anchor,b.head))}return{text:d,ranges:f}}function Lp(o,d,f,p){o.setAttribute("autocorrect",f?"on":"off"),o.setAttribute("autocapitalize",p?"on":"off"),o.setAttribute("spellcheck",!!d)}function Wb(){var o=F("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; min-height: 1em; outline: none"),d=F("div",[o],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return h?o.style.width="1000px":o.setAttribute("wrap","off"),k&&(o.style.border="1px solid black"),d}function jM(o){var d=o.optionHandlers,f=o.helpers={};o.prototype={constructor:o,focus:function(){De(this).focus(),this.display.input.focus()},setOption:function(p,m){var b=this.options,x=b[p];b[p]==m&&p!="mode"||(b[p]=m,d.hasOwnProperty(p)&&zt(this,d[p])(this,m,x),bt(this,"optionChange",this,p))},getOption:function(p){return this.options[p]},getDoc:function(){return this.doc},addKeyMap:function(p,m){this.state.keyMaps[m?"push":"unshift"](vc(p))},removeKeyMap:function(p){for(var m=this.state.keyMaps,b=0;b<m.length;++b)if(m[b]==p||m[b].name==p)return m.splice(b,1),!0},addOverlay:cn(function(p,m){var b=p.token?p:o.getMode(this.options,p);if(b.startState)throw new Error("Overlays may not be stateful.");_i(this.state.overlays,{mode:b,modeSpec:p,opaque:m&&m.opaque,priority:m&&m.priority||0},function(x){return x.priority}),this.state.modeGen++,xn(this)}),removeOverlay:cn(function(p){for(var m=this.state.overlays,b=0;b<m.length;++b){var x=m[b].modeSpec;if(x==p||typeof p=="string"&&x.name==p){m.splice(b,1),this.state.modeGen++,xn(this);return}}}),indentLine:cn(function(p,m,b){typeof m!="string"&&typeof m!="number"&&(m==null?m=this.options.smartIndent?"smart":"prev":m=m?"add":"subtract"),ee(this.doc,p)&&Tl(this,p,m,b)}),indentSelection:cn(function(p){for(var m=this.doc.sel.ranges,b=-1,x=0;x<m.length;x++){var T=m[x];if(T.empty())T.head.line>b&&(Tl(this,T.head.line,p,!0),b=T.head.line,x==this.doc.sel.primIndex&&La(this));else{var I=T.from(),A=T.to(),$=Math.max(b,I.line);b=Math.min(this.lastLine(),A.line-(A.ch?0:1))+1;for(var W=$;W<b;++W)Tl(this,W,p);var Y=this.doc.sel.ranges;I.ch==0&&m.length==Y.length&&Y[x].from().ch>0&&yp(this.doc,x,new tt(I,Y[x].to()),Yt)}}}),getTokenAt:function(p,m){return e0(this,p,m)},getLineTokens:function(p,m){return e0(this,Z(p),m,!0)},getTokenTypeAt:function(p){p=$e(this.doc,p);var m=Ky(this,Ie(this.doc,p.line)),b=0,x=(m.length-1)/2,T=p.ch,I;if(T==0)I=m[2];else for(;;){var A=b+x>>1;if((A?m[A*2-1]:0)>=T)x=A;else if(m[A*2+1]<T)b=A+1;else{I=m[A*2+2];break}}var $=I?I.indexOf("overlay "):-1;return $<0?I:$==0?null:I.slice(0,$-1)},getModeAt:function(p){var m=this.doc.mode;return m.innerMode?o.innerMode(m,this.getTokenAt(p).state).mode:m},getHelper:function(p,m){return this.getHelpers(p,m)[0]},getHelpers:function(p,m){var b=[];if(!f.hasOwnProperty(m))return b;var x=f[m],T=this.getModeAt(p);if(typeof T[m]=="string")x[T[m]]&&b.push(x[T[m]]);else if(T[m])for(var I=0;I<T[m].length;I++){var A=x[T[m][I]];A&&b.push(A)}else T.helperType&&x[T.helperType]?b.push(x[T.helperType]):x[T.name]&&b.push(x[T.name]);for(var $=0;$<x._global.length;$++){var W=x._global[$];W.pred(T,this)&&Ce(b,W.val)==-1&&b.push(W.val)}return b},getStateAfter:function(p,m){var b=this.doc;return p=Jy(b,p??b.first+b.size-1),Qo(this,p+1,m).state},cursorCoords:function(p,m){var b,x=this.doc.sel.primary();return p==null?b=x.head:typeof p=="object"?b=$e(this.doc,p):b=p?x.from():x.to(),Sr(this,b,m||"page")},charCoords:function(p,m){return nc(this,$e(this.doc,p),m||"page")},coordsChar:function(p,m){return p=D0(this,p,m||"page"),Kh(this,p.left,p.top)},lineAtHeight:function(p,m){return p=D0(this,{top:p,left:0},m||"page").top,G(this.doc,p+this.display.viewOffset)},heightAtLine:function(p,m,b){var x=!1,T;if(typeof p=="number"){var I=this.doc.first+this.doc.size-1;p<this.doc.first?p=this.doc.first:p>I&&(p=I,x=!0),T=Ie(this.doc,p)}else T=p;return tc(this,T,{top:0,left:0},m||"page",b||x).top+(x?this.doc.height-ci(T):0)},defaultTextHeight:function(){return Ea(this.display)},defaultCharWidth:function(){return Ta(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(p,m,b,x,T){var I=this.display;p=Sr(this,$e(this.doc,p));var A=p.bottom,$=p.left;if(m.style.position="absolute",m.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(m),I.sizer.appendChild(m),x=="over")A=p.top;else if(x=="above"||x=="near"){var W=Math.max(I.wrapper.clientHeight,this.doc.height),Y=Math.max(I.sizer.clientWidth,I.lineSpace.clientWidth);(x=="above"||p.bottom+m.offsetHeight>W)&&p.top>m.offsetHeight?A=p.top-m.offsetHeight:p.bottom+m.offsetHeight<=W&&(A=p.bottom),$+m.offsetWidth>Y&&($=Y-m.offsetWidth)}m.style.top=A+"px",m.style.left=m.style.right="",T=="right"?($=I.sizer.clientWidth-m.offsetWidth,m.style.right="0px"):(T=="left"?$=0:T=="middle"&&($=(I.sizer.clientWidth-m.offsetWidth)/2),m.style.left=$+"px"),b&&zR(this,{left:$,top:A,right:$+m.offsetWidth,bottom:A+m.offsetHeight})},triggerOnKeyDown:cn(Mb),triggerOnKeyPress:cn(Nb),triggerOnKeyUp:Ab,triggerOnMouseDown:cn(Vb),execCommand:function(p){if(Sl.hasOwnProperty(p))return Sl[p].call(null,this)},triggerElectric:cn(function(p){zb(this,p)}),findPosH:function(p,m,b,x){var T=1;m<0&&(T=-1,m=-m);for(var I=$e(this.doc,p),A=0;A<m&&(I=Ip(this.doc,I,T,b,x),!I.hitSide);++A);return I},moveH:cn(function(p,m){var b=this;this.extendSelectionsBy(function(x){return b.display.shift||b.doc.extend||x.empty()?Ip(b.doc,x.head,p,m,b.options.rtlMoveVisually):p<0?x.from():x.to()},Xt)}),deleteH:cn(function(p,m){var b=this.doc.sel,x=this.doc;b.somethingSelected()?x.replaceSelection("",null,"+delete"):Va(this,function(T){var I=Ip(x,T.head,p,m,!1);return p<0?{from:I,to:T.head}:{from:T.head,to:I}})}),findPosV:function(p,m,b,x){var T=1,I=x;m<0&&(T=-1,m=-m);for(var A=$e(this.doc,p),$=0;$<m;++$){var W=Sr(this,A,"div");if(I==null?I=W.left:W.left=I,A=jb(this,W,T,b),A.hitSide)break}return A},moveV:cn(function(p,m){var b=this,x=this.doc,T=[],I=!this.display.shift&&!x.extend&&x.sel.somethingSelected();if(x.extendSelectionsBy(function($){if(I)return p<0?$.from():$.to();var W=Sr(b,$.head,"div");$.goalColumn!=null&&(W.left=$.goalColumn),T.push(W.left);var Y=jb(b,W,p,m);return m=="page"&&$==x.sel.primary()&&op(b,nc(b,Y,"div").top-W.top),Y},Xt),T.length)for(var A=0;A<x.sel.ranges.length;A++)x.sel.ranges[A].goalColumn=T[A]}),findWordAt:function(p){var m=this.doc,b=Ie(m,p.line).text,x=p.ch,T=p.ch;if(b){var I=this.getHelper(p,"wordChars");(p.sticky=="before"||T==b.length)&&x?--x:++T;for(var A=b.charAt(x),$=Gn(A,I)?function(W){return Gn(W,I)}:/\s/.test(A)?function(W){return/\s/.test(W)}:function(W){return!/\s/.test(W)&&!Gn(W)};x>0&&$(b.charAt(x-1));)--x;for(;T<b.length&&$(b.charAt(T));)++T}return new tt(Z(p.line,x),Z(p.line,T))},toggleOverwrite:function(p){p!=null&&p==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?Se(this.display.cursorDiv,"CodeMirror-overwrite"):U(this.display.cursorDiv,"CodeMirror-overwrite"),bt(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==le(_e(this))},isReadOnly:function(){return!!(this.options.readOnly||this.doc.cantEdit)},scrollTo:cn(function(p,m){al(this,p,m)}),getScrollInfo:function(){var p=this.display.scroller;return{left:p.scrollLeft,top:p.scrollTop,height:p.scrollHeight-Fr(this)-this.display.barHeight,width:p.scrollWidth-Fr(this)-this.display.barWidth,clientHeight:qh(this),clientWidth:Rs(this)}},scrollIntoView:cn(function(p,m){p==null?(p={from:this.doc.sel.primary().head,to:null},m==null&&(m=this.options.cursorScrollMargin)):typeof p=="number"?p={from:Z(p,0),to:null}:p.from==null&&(p={from:p,to:null}),p.to||(p.to=p.from),p.margin=m||0,p.from.line!=null?GR(this,p):F0(this,p.from,p.to,p.margin)}),setSize:cn(function(p,m){var b=this,x=function(I){return typeof I=="number"||/^\d+$/.test(String(I))?I+"px":I};p!=null&&(this.display.wrapper.style.width=x(p)),m!=null&&(this.display.wrapper.style.height=x(m)),this.options.lineWrapping&&k0(this);var T=this.display.viewFrom;this.doc.iter(T,this.display.viewTo,function(I){if(I.widgets){for(var A=0;A<I.widgets.length;A++)if(I.widgets[A].noHScroll){Yi(b,T,"widget");break}}++T}),this.curOp.forceUpdate=!0,bt(this,"refresh",this)}),operation:function(p){return On(this,p)},startOperation:function(){return Bs(this)},endOperation:function(){return Fs(this)},refresh:cn(function(){var p=this.display.cachedTextHeight;xn(this),this.curOp.forceUpdate=!0,il(this),al(this,this.doc.scrollLeft,this.doc.scrollTop),cp(this.display),(p==null||Math.abs(p-Ea(this.display))>.5||this.options.lineWrapping)&&tp(this),bt(this,"refresh",this)}),swapDoc:cn(function(p){var m=this.doc;return m.cm=null,this.state.selectingText&&this.state.selectingText(),Z0(this,p),il(this),this.display.input.reset(),al(this,p.scrollLeft,p.scrollTop),this.curOp.forceScroll=!0,$t(this,"swapDoc",this,m),m}),phrase:function(p){var m=this.options.phrases;return m&&Object.prototype.hasOwnProperty.call(m,p)?m[p]:p},getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},gr(o),o.registerHelper=function(p,m,b){f.hasOwnProperty(p)||(f[p]=o[p]={_global:[]}),f[p][m]=b},o.registerGlobalHelper=function(p,m,b,x){o.registerHelper(p,m,x),f[p]._global.push({pred:b,val:x})}}function Ip(o,d,f,p,m){var b=d,x=f,T=Ie(o,d.line),I=m&&o.direction=="rtl"?-f:f;function A(){var be=d.line+I;return be<o.first||be>=o.first+o.size?!1:(d=new Z(be,d.ch,d.sticky),T=Ie(o,be))}function $(be){var fe;if(p=="codepoint"){var xe=T.text.charCodeAt(d.ch+(f>0?0:-1));if(isNaN(xe))fe=null;else{var Be=f>0?xe>=55296&&xe<56320:xe>=56320&&xe<57343;fe=new Z(d.line,Math.max(0,Math.min(T.text.length,d.ch+f*(Be?2:1))),-f)}}else m?fe=kM(o.cm,T,d,f):fe=wp(T,d,f);if(fe==null)if(!be&&A())d=Sp(m,o.cm,T,d.line,I);else return!1;else d=fe;return!0}if(p=="char"||p=="codepoint")$();else if(p=="column")$(!0);else if(p=="word"||p=="group")for(var W=null,Y=p=="group",J=o.cm&&o.cm.getHelper(d,"wordChars"),Q=!0;!(f<0&&!$(!Q));Q=!1){var re=T.text.charAt(d.ch)||`
`,ue=Gn(re,J)?"w":Y&&re==`
`?"n":!Y||/\s/.test(re)?null:"p";if(Y&&!Q&&!ue&&(ue="s"),W&&W!=ue){f<0&&(f=1,$(),d.sticky="after");break}if(ue&&(W=ue),f>0&&!$(!Q))break}var pe=fc(o,d,b,x,!0);return et(b,pe)&&(pe.hitSide=!0),pe}function jb(o,d,f,p){var m=o.doc,b=d.left,x;if(p=="page"){var T=Math.min(o.display.wrapper.clientHeight,De(o).innerHeight||m(o).documentElement.clientHeight),I=Math.max(T-.5*Ea(o.display),3);x=(f>0?d.bottom:d.top)+f*I}else p=="line"&&(x=f>0?d.bottom+3:d.top-3);for(var A;A=Kh(o,b,x),!!A.outside;){if(f<0?x<=0:x>=m.height){A.hitSide=!0;break}x+=f*5}return A}var ot=function(o){this.cm=o,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Ue,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};ot.prototype.init=function(o){var d=this,f=this,p=f.cm,m=f.div=o.lineDiv;m.contentEditable=!0,Lp(m,p.options.spellcheck,p.options.autocorrect,p.options.autocapitalize);function b(T){for(var I=T.target;I;I=I.parentNode){if(I==m)return!0;if(/\bCodeMirror-(?:line)?widget\b/.test(I.className))break}return!1}Ve(m,"paste",function(T){!b(T)||wt(p,T)||$b(T,p)||u<=11&&setTimeout(zt(p,function(){return d.updateFromDOM()}),20)}),Ve(m,"compositionstart",function(T){d.composing={data:T.data,done:!1}}),Ve(m,"compositionupdate",function(T){d.composing||(d.composing={data:T.data,done:!1})}),Ve(m,"compositionend",function(T){d.composing&&(T.data!=d.composing.data&&d.readFromDOMSoon(),d.composing.done=!0)}),Ve(m,"touchstart",function(){return f.forceCompositionEnd()}),Ve(m,"input",function(){d.composing||d.readFromDOMSoon()});function x(T){if(!(!b(T)||wt(p,T))){if(p.somethingSelected())wc({lineWise:!1,text:p.getSelections()}),T.type=="cut"&&p.replaceSelection("",null,"cut");else if(p.options.lineWiseCopyCut){var I=Gb(p);wc({lineWise:!0,text:I.text}),T.type=="cut"&&p.operation(function(){p.setSelections(I.ranges,0,Yt),p.replaceSelection("",null,"cut")})}else return;if(T.clipboardData){T.clipboardData.clearData();var A=xr.text.join(`
`);if(T.clipboardData.setData("Text",A),T.clipboardData.getData("Text")==A){T.preventDefault();return}}var $=Wb(),W=$.firstChild;Lp(W),p.display.lineSpace.insertBefore($,p.display.lineSpace.firstChild),W.value=xr.text.join(`
`);var Y=le(Ge(m));he(W),setTimeout(function(){p.display.lineSpace.removeChild($),Y.focus(),Y==m&&f.showPrimarySelection()},50)}}Ve(m,"copy",x),Ve(m,"cut",x)},ot.prototype.screenReaderLabelChanged=function(o){o?this.div.setAttribute("aria-label",o):this.div.removeAttribute("aria-label")},ot.prototype.prepareSelection=function(){var o=V0(this.cm,!1);return o.focus=le(Ge(this.div))==this.div,o},ot.prototype.showSelection=function(o,d){!o||!this.cm.display.view.length||((o.focus||d)&&this.showPrimarySelection(),this.showMultipleSelections(o))},ot.prototype.getSelection=function(){return this.cm.display.wrapper.ownerDocument.getSelection()},ot.prototype.showPrimarySelection=function(){var o=this.getSelection(),d=this.cm,f=d.doc.sel.primary(),p=f.from(),m=f.to();if(d.display.viewTo==d.display.viewFrom||p.line>=d.display.viewTo||m.line<d.display.viewFrom){o.removeAllRanges();return}var b=Sc(d,o.anchorNode,o.anchorOffset),x=Sc(d,o.focusNode,o.focusOffset);if(!(b&&!b.bad&&x&&!x.bad&&me(wa(b,x),p)==0&&me(Cn(b,x),m)==0)){var T=d.display.view,I=p.line>=d.display.viewFrom&&Hb(d,p)||{node:T[0].measure.map[2],offset:0},A=m.line<d.display.viewTo&&Hb(d,m);if(!A){var $=T[T.length-1].measure,W=$.maps?$.maps[$.maps.length-1]:$.map;A={node:W[W.length-1],offset:W[W.length-2]-W[W.length-3]}}if(!I||!A){o.removeAllRanges();return}var Y=o.rangeCount&&o.getRangeAt(0),J;try{J=oe(I.node,I.offset,A.offset,A.node)}catch{}J&&(!i&&d.state.focused?(o.collapse(I.node,I.offset),J.collapsed||(o.removeAllRanges(),o.addRange(J))):(o.removeAllRanges(),o.addRange(J)),Y&&o.anchorNode==null?o.addRange(Y):i&&this.startGracePeriod()),this.rememberSelection()}},ot.prototype.startGracePeriod=function(){var o=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){o.gracePeriod=!1,o.selectionChanged()&&o.cm.operation(function(){return o.cm.curOp.selectionChanged=!0})},20)},ot.prototype.showMultipleSelections=function(o){z(this.cm.display.cursorDiv,o.cursors),z(this.cm.display.selectionDiv,o.selection)},ot.prototype.rememberSelection=function(){var o=this.getSelection();this.lastAnchorNode=o.anchorNode,this.lastAnchorOffset=o.anchorOffset,this.lastFocusNode=o.focusNode,this.lastFocusOffset=o.focusOffset},ot.prototype.selectionInEditor=function(){var o=this.getSelection();if(!o.rangeCount)return!1;var d=o.getRangeAt(0).commonAncestorContainer;return Re(this.div,d)},ot.prototype.focus=function(){this.cm.options.readOnly!="nocursor"&&((!this.selectionInEditor()||le(Ge(this.div))!=this.div)&&this.showSelection(this.prepareSelection(),!0),this.div.focus())},ot.prototype.blur=function(){this.div.blur()},ot.prototype.getField=function(){return this.div},ot.prototype.supportsTouch=function(){return!0},ot.prototype.receivedFocus=function(){var o=this,d=this;this.selectionInEditor()?setTimeout(function(){return o.pollSelection()},20):On(this.cm,function(){return d.cm.curOp.selectionChanged=!0});function f(){d.cm.state.focused&&(d.pollSelection(),d.polling.set(d.cm.options.pollInterval,f))}this.polling.set(this.cm.options.pollInterval,f)},ot.prototype.selectionChanged=function(){var o=this.getSelection();return o.anchorNode!=this.lastAnchorNode||o.anchorOffset!=this.lastAnchorOffset||o.focusNode!=this.lastFocusNode||o.focusOffset!=this.lastFocusOffset},ot.prototype.pollSelection=function(){if(!(this.readDOMTimeout!=null||this.gracePeriod||!this.selectionChanged())){var o=this.getSelection(),d=this.cm;if(P&&v&&this.cm.display.gutterSpecs.length&&HM(o.anchorNode)){this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),this.focus();return}if(!this.composing){this.rememberSelection();var f=Sc(d,o.anchorNode,o.anchorOffset),p=Sc(d,o.focusNode,o.focusOffset);f&&p&&On(d,function(){rn(d.doc,Ki(f,p),Yt),(f.bad||p.bad)&&(d.curOp.selectionChanged=!0)})}}},ot.prototype.pollContent=function(){this.readDOMTimeout!=null&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var o=this.cm,d=o.display,f=o.doc.sel.primary(),p=f.from(),m=f.to();if(p.ch==0&&p.line>o.firstLine()&&(p=Z(p.line-1,Ie(o.doc,p.line-1).length)),m.ch==Ie(o.doc,m.line).text.length&&m.line<o.lastLine()&&(m=Z(m.line+1,0)),p.line<d.viewFrom||m.line>d.viewTo-1)return!1;var b,x,T;p.line==d.viewFrom||(b=Ns(o,p.line))==0?(x=N(d.view[0].line),T=d.view[0].node):(x=N(d.view[b].line),T=d.view[b-1].node.nextSibling);var I=Ns(o,m.line),A,$;if(I==d.view.length-1?(A=d.viewTo-1,$=d.lineDiv.lastChild):(A=N(d.view[I+1].line)-1,$=d.view[I+1].node.previousSibling),!T)return!1;for(var W=o.doc.splitLines(qM(o,T,$,x,A)),Y=li(o.doc,Z(x,0),Z(A,Ie(o.doc,A).text.length));W.length>1&&Y.length>1;)if(He(W)==He(Y))W.pop(),Y.pop(),A--;else if(W[0]==Y[0])W.shift(),Y.shift(),x++;else break;for(var J=0,Q=0,re=W[0],ue=Y[0],pe=Math.min(re.length,ue.length);J<pe&&re.charCodeAt(J)==ue.charCodeAt(J);)++J;for(var be=He(W),fe=He(Y),xe=Math.min(be.length-(W.length==1?J:0),fe.length-(Y.length==1?J:0));Q<xe&&be.charCodeAt(be.length-Q-1)==fe.charCodeAt(fe.length-Q-1);)++Q;if(W.length==1&&Y.length==1&&x==p.line)for(;J&&J>p.ch&&be.charCodeAt(be.length-Q-1)==fe.charCodeAt(fe.length-Q-1);)J--,Q++;W[W.length-1]=be.slice(0,be.length-Q).replace(/^\u200b+/,""),W[0]=W[0].slice(J).replace(/\u200b+$/,"");var Be=Z(x,J),Ae=Z(A,Y.length?He(Y).length-Q:0);if(W.length>1||W[0]||me(Be,Ae))return Ma(o.doc,W,Be,Ae,"+input"),!0},ot.prototype.ensurePolled=function(){this.forceCompositionEnd()},ot.prototype.reset=function(){this.forceCompositionEnd()},ot.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},ot.prototype.readFromDOMSoon=function(){var o=this;this.readDOMTimeout==null&&(this.readDOMTimeout=setTimeout(function(){if(o.readDOMTimeout=null,o.composing)if(o.composing.done)o.composing=null;else return;o.updateFromDOM()},80))},ot.prototype.updateFromDOM=function(){var o=this;(this.cm.isReadOnly()||!this.pollContent())&&On(this.cm,function(){return xn(o.cm)})},ot.prototype.setUneditable=function(o){o.contentEditable="false"},ot.prototype.onKeyPress=function(o){o.charCode==0||this.composing||(o.preventDefault(),this.cm.isReadOnly()||zt(this.cm,kp)(this.cm,String.fromCharCode(o.charCode==null?o.keyCode:o.charCode),0))},ot.prototype.readOnlyChanged=function(o){this.div.contentEditable=String(o!="nocursor")},ot.prototype.onContextMenu=function(){},ot.prototype.resetPosition=function(){},ot.prototype.needsContentAttribute=!0;function Hb(o,d){var f=Jh(o,d.line);if(!f||f.hidden)return null;var p=Ie(o.doc,d.line),m=S0(f,p,d.line),b=qe(p,o.doc.direction),x="left";if(b){var T=Gi(b,d.ch);x=T%2?"right":"left"}var I=E0(m.map,d.ch,x);return I.offset=I.collapse=="right"?I.end:I.start,I}function HM(o){for(var d=o;d;d=d.parentNode)if(/CodeMirror-gutter-wrapper/.test(d.className))return!0;return!1}function Ba(o,d){return d&&(o.bad=!0),o}function qM(o,d,f,p,m){var b="",x=!1,T=o.doc.lineSeparator(),I=!1;function A(J){return function(Q){return Q.id==J}}function $(){x&&(b+=T,I&&(b+=T),x=I=!1)}function W(J){J&&($(),b+=J)}function Y(J){if(J.nodeType==1){var Q=J.getAttribute("cm-text");if(Q){W(Q);return}var re=J.getAttribute("cm-marker"),ue;if(re){var pe=o.findMarks(Z(p,0),Z(m+1,0),A(+re));pe.length&&(ue=pe[0].find(0))&&W(li(o.doc,ue.from,ue.to).join(T));return}if(J.getAttribute("contenteditable")=="false")return;var be=/^(pre|div|p|li|table|br)$/i.test(J.nodeName);if(!/^br$/i.test(J.nodeName)&&J.textContent.length==0)return;be&&$();for(var fe=0;fe<J.childNodes.length;fe++)Y(J.childNodes[fe]);/^(pre|p)$/i.test(J.nodeName)&&(I=!0),be&&(x=!0)}else J.nodeType==3&&W(J.nodeValue.replace(/\u200b/g,"").replace(/\u00a0/g," "))}for(;Y(d),d!=f;)d=d.nextSibling,I=!1;return b}function Sc(o,d,f){var p;if(d==o.display.lineDiv){if(p=o.display.lineDiv.childNodes[f],!p)return Ba(o.clipPos(Z(o.display.viewTo-1)),!0);d=null,f=0}else for(p=d;;p=p.parentNode){if(!p||p==o.display.lineDiv)return null;if(p.parentNode&&p.parentNode==o.display.lineDiv)break}for(var m=0;m<o.display.view.length;m++){var b=o.display.view[m];if(b.node==p)return JM(b,d,f)}}function JM(o,d,f){var p=o.text.firstChild,m=!1;if(!d||!Re(p,d))return Ba(Z(N(o.line),0),!0);if(d==p&&(m=!0,d=p.childNodes[f],f=0,!d)){var b=o.rest?He(o.rest):o.line;return Ba(Z(N(b),b.text.length),m)}var x=d.nodeType==3?d:null,T=d;for(!x&&d.childNodes.length==1&&d.firstChild.nodeType==3&&(x=d.firstChild,f&&(f=x.nodeValue.length));T.parentNode!=p;)T=T.parentNode;var I=o.measure,A=I.maps;function $(ue,pe,be){for(var fe=-1;fe<(A?A.length:0);fe++)for(var xe=fe<0?I.map:A[fe],Be=0;Be<xe.length;Be+=3){var Ae=xe[Be+2];if(Ae==ue||Ae==pe){var je=N(fe<0?o.line:o.rest[fe]),ht=xe[Be]+be;return(be<0||Ae!=ue)&&(ht=xe[Be+(be?1:0)]),Z(je,ht)}}}var W=$(x,T,f);if(W)return Ba(W,m);for(var Y=T.nextSibling,J=x?x.nodeValue.length-f:0;Y;Y=Y.nextSibling){if(W=$(Y,Y.firstChild,0),W)return Ba(Z(W.line,W.ch-J),m);J+=Y.textContent.length}for(var Q=T.previousSibling,re=f;Q;Q=Q.previousSibling){if(W=$(Q,Q.firstChild,-1),W)return Ba(Z(W.line,W.ch+re),m);re+=Q.textContent.length}}var kt=function(o){this.cm=o,this.prevInput="",this.pollingFast=!1,this.polling=new Ue,this.hasSelection=!1,this.composing=null,this.resetting=!1};kt.prototype.init=function(o){var d=this,f=this,p=this.cm;this.createField(o);var m=this.textarea;o.wrapper.insertBefore(this.wrapper,o.wrapper.firstChild),k&&(m.style.width="0px"),Ve(m,"input",function(){c&&u>=9&&d.hasSelection&&(d.hasSelection=null),f.poll()}),Ve(m,"paste",function(x){wt(p,x)||$b(x,p)||(p.state.pasteIncoming=+new Date,f.fastPoll())});function b(x){if(!wt(p,x)){if(p.somethingSelected())wc({lineWise:!1,text:p.getSelections()});else if(p.options.lineWiseCopyCut){var T=Gb(p);wc({lineWise:!0,text:T.text}),x.type=="cut"?p.setSelections(T.ranges,null,Yt):(f.prevInput="",m.value=T.text.join(`
`),he(m))}else return;x.type=="cut"&&(p.state.cutIncoming=+new Date)}}Ve(m,"cut",b),Ve(m,"copy",b),Ve(o.scroller,"paste",function(x){if(!(ui(o,x)||wt(p,x))){if(!m.dispatchEvent){p.state.pasteIncoming=+new Date,f.focus();return}var T=new Event("paste");T.clipboardData=x.clipboardData,m.dispatchEvent(T)}}),Ve(o.lineSpace,"selectstart",function(x){ui(o,x)||nn(x)}),Ve(m,"compositionstart",function(){var x=p.getCursor("from");f.composing&&f.composing.range.clear(),f.composing={start:x,range:p.markText(x,p.getCursor("to"),{className:"CodeMirror-composing"})}}),Ve(m,"compositionend",function(){f.composing&&(f.poll(),f.composing.range.clear(),f.composing=null)})},kt.prototype.createField=function(o){this.wrapper=Wb(),this.textarea=this.wrapper.firstChild;var d=this.cm.options;Lp(this.textarea,d.spellcheck,d.autocorrect,d.autocapitalize)},kt.prototype.screenReaderLabelChanged=function(o){o?this.textarea.setAttribute("aria-label",o):this.textarea.removeAttribute("aria-label")},kt.prototype.prepareSelection=function(){var o=this.cm,d=o.display,f=o.doc,p=V0(o);if(o.options.moveInputWithCursor){var m=Sr(o,f.sel.primary().head,"div"),b=d.wrapper.getBoundingClientRect(),x=d.lineDiv.getBoundingClientRect();p.teTop=Math.max(0,Math.min(d.wrapper.clientHeight-10,m.top+x.top-b.top)),p.teLeft=Math.max(0,Math.min(d.wrapper.clientWidth-10,m.left+x.left-b.left))}return p},kt.prototype.showSelection=function(o){var d=this.cm,f=d.display;z(f.cursorDiv,o.cursors),z(f.selectionDiv,o.selection),o.teTop!=null&&(this.wrapper.style.top=o.teTop+"px",this.wrapper.style.left=o.teLeft+"px")},kt.prototype.reset=function(o){if(!(this.contextMenuPending||this.composing&&o)){var d=this.cm;if(this.resetting=!0,d.somethingSelected()){this.prevInput="";var f=d.getSelection();this.textarea.value=f,d.state.focused&&he(this.textarea),c&&u>=9&&(this.hasSelection=f)}else o||(this.prevInput=this.textarea.value="",c&&u>=9&&(this.hasSelection=null));this.resetting=!1}},kt.prototype.getField=function(){return this.textarea},kt.prototype.supportsTouch=function(){return!1},kt.prototype.focus=function(){if(this.cm.options.readOnly!="nocursor"&&(!D||le(Ge(this.textarea))!=this.textarea))try{this.textarea.focus()}catch{}},kt.prototype.blur=function(){this.textarea.blur()},kt.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},kt.prototype.receivedFocus=function(){this.slowPoll()},kt.prototype.slowPoll=function(){var o=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){o.poll(),o.cm.state.focused&&o.slowPoll()})},kt.prototype.fastPoll=function(){var o=!1,d=this;d.pollingFast=!0;function f(){var p=d.poll();!p&&!o?(o=!0,d.polling.set(60,f)):(d.pollingFast=!1,d.slowPoll())}d.polling.set(20,f)},kt.prototype.poll=function(){var o=this,d=this.cm,f=this.textarea,p=this.prevInput;if(this.contextMenuPending||this.resetting||!d.state.focused||Hi(f)&&!p&&!this.composing||d.isReadOnly()||d.options.disableInput||d.state.keySeq)return!1;var m=f.value;if(m==p&&!d.somethingSelected())return!1;if(c&&u>=9&&this.hasSelection===m||L&&/[\uf700-\uf7ff]/.test(m))return d.display.input.reset(),!1;if(d.doc.sel==d.display.selForContextMenu){var b=m.charCodeAt(0);if(b==8203&&!p&&(p="​"),b==8666)return this.reset(),this.cm.execCommand("undo")}for(var x=0,T=Math.min(p.length,m.length);x<T&&p.charCodeAt(x)==m.charCodeAt(x);)++x;return On(d,function(){kp(d,m.slice(x),p.length-x,null,o.composing?"*compose":null),m.length>1e3||m.indexOf(`
`)>-1?f.value=o.prevInput="":o.prevInput=m,o.composing&&(o.composing.range.clear(),o.composing.range=d.markText(o.composing.start,d.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},kt.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},kt.prototype.onKeyPress=function(){c&&u>=9&&(this.hasSelection=null),this.fastPoll()},kt.prototype.onContextMenu=function(o){var d=this,f=d.cm,p=f.display,m=d.textarea;d.contextMenuPending&&d.contextMenuPending();var b=As(f,o),x=p.scroller.scrollTop;if(!b||C)return;var T=f.options.resetSelectionOnContextMenu;T&&f.doc.sel.contains(b)==-1&&zt(f,rn)(f.doc,Ki(b),Yt);var I=m.style.cssText,A=d.wrapper.style.cssText,$=d.wrapper.offsetParent.getBoundingClientRect();d.wrapper.style.cssText="position: static",m.style.cssText=`position: absolute; width: 30px; height: 30px;
      top: `+(o.clientY-$.top-5)+"px; left: "+(o.clientX-$.left-5)+`px;
      z-index: 1000; background: `+(c?"rgba(255, 255, 255, .05)":"transparent")+`;
      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);`;var W;h&&(W=m.ownerDocument.defaultView.scrollY),p.input.focus(),h&&m.ownerDocument.defaultView.scrollTo(null,W),p.input.reset(),f.somethingSelected()||(m.value=d.prevInput=" "),d.contextMenuPending=J,p.selForContextMenu=f.doc.sel,clearTimeout(p.detectingSelectAll);function Y(){if(m.selectionStart!=null){var re=f.somethingSelected(),ue="​"+(re?m.value:"");m.value="⇚",m.value=ue,d.prevInput=re?"":"​",m.selectionStart=1,m.selectionEnd=ue.length,p.selForContextMenu=f.doc.sel}}function J(){if(d.contextMenuPending==J&&(d.contextMenuPending=!1,d.wrapper.style.cssText=A,m.style.cssText=I,c&&u<9&&p.scrollbars.setScrollTop(p.scroller.scrollTop=x),m.selectionStart!=null)){(!c||c&&u<9)&&Y();var re=0,ue=function(){p.selForContextMenu==f.doc.sel&&m.selectionStart==0&&m.selectionEnd>0&&d.prevInput=="​"?zt(f,ub)(f):re++<10?p.detectingSelectAll=setTimeout(ue,500):(p.selForContextMenu=null,p.input.reset())};p.detectingSelectAll=setTimeout(ue,200)}}if(c&&u>=9&&Y(),_){Wi(o);var Q=function(){tn(window,"mouseup",Q),setTimeout(J,20)};Ve(window,"mouseup",Q)}else setTimeout(J,50)},kt.prototype.readOnlyChanged=function(o){o||this.reset(),this.textarea.disabled=o=="nocursor",this.textarea.readOnly=!!o},kt.prototype.setUneditable=function(){},kt.prototype.needsContentAttribute=!1;function YM(o,d){if(d=d?Me(d):{},d.value=o.value,!d.tabindex&&o.tabIndex&&(d.tabindex=o.tabIndex),!d.placeholder&&o.placeholder&&(d.placeholder=o.placeholder),d.autofocus==null){var f=le(Ge(o));d.autofocus=f==o||o.getAttribute("autofocus")!=null&&f==document.body}function p(){o.value=T.getValue()}var m;if(o.form&&(Ve(o.form,"submit",p),!d.leaveSubmitMethodAlone)){var b=o.form;m=b.submit;try{var x=b.submit=function(){p(),b.submit=m,b.submit(),b.submit=x}}catch{}}d.finishInit=function(I){I.save=p,I.getTextArea=function(){return o},I.toTextArea=function(){I.toTextArea=isNaN,p(),o.parentNode.removeChild(I.getWrapperElement()),o.style.display="",o.form&&(tn(o.form,"submit",p),!d.leaveSubmitMethodAlone&&typeof o.form.submit=="function"&&(o.form.submit=m))}},o.style.display="none";var T=mt(function(I){return o.parentNode.insertBefore(I,o.nextSibling)},d);return T}function XM(o){o.off=tn,o.on=Ve,o.wheelEventPixels=rM,o.Doc=En,o.splitLines=Qn,o.countColumn=Fe,o.findColumn=dn,o.isWordChar=Ds,o.Pass=_t,o.signal=bt,o.Line=Sa,o.changeEnd=Zi,o.scrollbarModel=$0,o.Pos=Z,o.cmpPos=me,o.modes=fa,o.mimeModes=yr,o.resolveMode=ma,o.getMode=va,o.modeExtensions=qi,o.extendMode=ya,o.copyState=Or,o.startState=ba,o.innerMode=Ko,o.commands=Sl,o.keyMap=pi,o.keyName=Lb,o.isModifierKey=Tb,o.lookupKey=Na,o.normalizeKeyMap=TM,o.StringStream=St,o.SharedTextMarker=yl,o.TextMarker=es,o.LineWidget=vl,o.e_preventDefault=nn,o.e_stopPropagation=ha,o.e_stop=Wi,o.addClass=Se,o.contains=Re,o.rmClass=U,o.keyNames=ts}$M(mt),jM(mt);var KM="iter insert remove copy getEditor constructor".split(" ");for(var Cc in En.prototype)En.prototype.hasOwnProperty(Cc)&&Ce(KM,Cc)<0&&(mt.prototype[Cc]=(function(o){return function(){return o.apply(this.doc,arguments)}})(En.prototype[Cc]));return gr(En),mt.inputStyles={textarea:kt,contenteditable:ot},mt.defineMode=function(o){!mt.defaults.mode&&o!="null"&&(mt.defaults.mode=o),br.apply(this,arguments)},mt.defineMIME=ga,mt.defineMode("null",function(){return{token:function(o){return o.skipToEnd()}}}),mt.defineMIME("text/plain","null"),mt.defineExtension=function(o,d){mt.prototype[o]=d},mt.defineDocExtension=function(o,d){En.prototype[o]=d},mt.fromTextArea=YM,XM(mt),mt.version="5.65.18",mt})})(dm)),dm.exports}var lE;function Yz(){return lE||(lE=1,(function(n,e){(function(t){t(Go())})(function(t){t.defineMode("javascript",function(r,i){var s=r.indentUnit,a=i.statementIndent,l=i.jsonld,c=i.json||l,u=i.trackScope!==!1,h=i.typescript,g=i.wordCharacters||/[\w$\xa1-\uffff]/,v=(function(){function N(Ut){return{type:Ut,style:"keyword"}}var G=N("keyword a"),ee=N("keyword b"),ce=N("keyword c"),Z=N("keyword d"),me=N("operator"),et={type:"atom",style:"atom"};return{if:N("if"),while:G,with:G,else:ee,do:ee,try:ee,finally:ee,return:Z,break:Z,continue:Z,new:N("new"),delete:ce,void:ce,throw:ce,debugger:N("debugger"),var:N("var"),const:N("var"),let:N("var"),function:N("function"),catch:N("catch"),for:N("for"),switch:N("switch"),case:N("case"),default:N("default"),in:me,typeof:me,instanceof:me,true:et,false:et,null:et,undefined:et,NaN:et,Infinity:et,this:N("this"),class:N("class"),super:N("atom"),yield:ce,export:N("export"),import:N("import"),extends:ce,await:ce}})(),y=/[+\-*&%=<>!?|~^@]/,C=/^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;function S(N){for(var G=!1,ee,ce=!1;(ee=N.next())!=null;){if(!G){if(ee=="/"&&!ce)return;ee=="["?ce=!0:ce&&ee=="]"&&(ce=!1)}G=!G&&ee=="\\"}}var w,E;function k(N,G,ee){return w=N,E=ee,G}function P(N,G){var ee=N.next();if(ee=='"'||ee=="'")return G.tokenize=D(ee),G.tokenize(N,G);if(ee=="."&&N.match(/^\d[\d_]*(?:[eE][+\-]?[\d_]+)?/))return k("number","number");if(ee=="."&&N.match(".."))return k("spread","meta");if(/[\[\]{}\(\),;\:\.]/.test(ee))return k(ee);if(ee=="="&&N.eat(">"))return k("=>","operator");if(ee=="0"&&N.match(/^(?:x[\dA-Fa-f_]+|o[0-7_]+|b[01_]+)n?/))return k("number","number");if(/\d/.test(ee))return N.match(/^[\d_]*(?:n|(?:\.[\d_]*)?(?:[eE][+\-]?[\d_]+)?)?/),k("number","number");if(ee=="/")return N.eat("*")?(G.tokenize=L,L(N,G)):N.eat("/")?(N.skipToEnd(),k("comment","comment")):Wn(N,G,1)?(S(N),N.match(/^\b(([gimyus])(?![gimyus]*\2))+\b/),k("regexp","string-2")):(N.eat("="),k("operator","operator",N.current()));if(ee=="`")return G.tokenize=R,R(N,G);if(ee=="#"&&N.peek()=="!")return N.skipToEnd(),k("meta","meta");if(ee=="#"&&N.eatWhile(g))return k("variable","property");if(ee=="<"&&N.match("!--")||ee=="-"&&N.match("->")&&!/\S/.test(N.string.slice(0,N.start)))return N.skipToEnd(),k("comment","comment");if(y.test(ee))return(ee!=">"||!G.lexical||G.lexical.type!=">")&&(N.eat("=")?(ee=="!"||ee=="=")&&N.eat("="):/[<>*+\-|&?]/.test(ee)&&(N.eat(ee),ee==">"&&N.eat(ee))),ee=="?"&&N.eat(".")?k("."):k("operator","operator",N.current());if(g.test(ee)){N.eatWhile(g);var ce=N.current();if(G.lastType!="."){if(v.propertyIsEnumerable(ce)){var Z=v[ce];return k(Z.type,Z.style,ce)}if(ce=="async"&&N.match(/^(\s|\/\*([^*]|\*(?!\/))*?\*\/)*[\[\(\w]/,!1))return k("async","keyword",ce)}return k("variable","variable",ce)}}function D(N){return function(G,ee){var ce=!1,Z;if(l&&G.peek()=="@"&&G.match(C))return ee.tokenize=P,k("jsonld-keyword","meta");for(;(Z=G.next())!=null&&!(Z==N&&!ce);)ce=!ce&&Z=="\\";return ce||(ee.tokenize=P),k("string","string")}}function L(N,G){for(var ee=!1,ce;ce=N.next();){if(ce=="/"&&ee){G.tokenize=P;break}ee=ce=="*"}return k("comment","comment")}function R(N,G){for(var ee=!1,ce;(ce=N.next())!=null;){if(!ee&&(ce=="`"||ce=="$"&&N.eat("{"))){G.tokenize=P;break}ee=!ee&&ce=="\\"}return k("quasi","string-2",N.current())}var M="([{}])";function V(N,G){G.fatArrowAt&&(G.fatArrowAt=null);var ee=N.string.indexOf("=>",N.start);if(!(ee<0)){if(h){var ce=/:\s*(?:\w+(?:<[^>]*>|\[\])?|\{[^}]*\})\s*$/.exec(N.string.slice(N.start,ee));ce&&(ee=ce.index)}for(var Z=0,me=!1,et=ee-1;et>=0;--et){var Ut=N.string.charAt(et),Cn=M.indexOf(Ut);if(Cn>=0&&Cn<3){if(!Z){++et;break}if(--Z==0){Ut=="("&&(me=!0);break}}else if(Cn>=3&&Cn<6)++Z;else if(g.test(Ut))me=!0;else if(/["'\/`]/.test(Ut))for(;;--et){if(et==0)return;var wa=N.string.charAt(et-1);if(wa==Ut&&N.string.charAt(et-2)!="\\"){et--;break}}else if(me&&!Z){++et;break}}me&&!Z&&(G.fatArrowAt=et)}}var B={atom:!0,number:!0,variable:!0,string:!0,regexp:!0,this:!0,import:!0,"jsonld-keyword":!0};function _(N,G,ee,ce,Z,me){this.indented=N,this.column=G,this.type=ee,this.prev=Z,this.info=me,ce!=null&&(this.align=ce)}function H(N,G){if(!u)return!1;for(var ee=N.localVars;ee;ee=ee.next)if(ee.name==G)return!0;for(var ce=N.context;ce;ce=ce.prev)for(var ee=ce.vars;ee;ee=ee.next)if(ee.name==G)return!0}function U(N,G,ee,ce,Z){var me=N.cc;for(O.state=N,O.stream=Z,O.marked=null,O.cc=me,O.style=G,N.lexical.hasOwnProperty("align")||(N.lexical.align=!0);;){var et=me.length?me.pop():c?Ce:Fe;if(et(ee,ce)){for(;me.length&&me[me.length-1].lex;)me.pop()();return O.marked?O.marked:ee=="variable"&&H(N,ce)?"variable-2":G}}}var O={state:null,marked:null,cc:null};function z(){for(var N=arguments.length-1;N>=0;N--)O.cc.push(arguments[N])}function F(){return z.apply(null,arguments),!0}function se(N,G){for(var ee=G;ee;ee=ee.next)if(ee.name==N)return!0;return!1}function oe(N){var G=O.state;if(O.marked="def",!!u){if(G.context){if(G.lexical.info=="var"&&G.context&&G.context.block){var ee=Re(N,G.context);if(ee!=null){G.context=ee;return}}else if(!se(N,G.localVars)){G.localVars=new ne(N,G.localVars);return}}i.globalVars&&!se(N,G.globalVars)&&(G.globalVars=new ne(N,G.globalVars))}}function Re(N,G){if(G)if(G.block){var ee=Re(N,G.prev);return ee?ee==G.prev?G:new Se(ee,G.vars,!0):null}else return se(N,G.vars)?G:new Se(G.prev,new ne(N,G.vars),!1);else return null}function le(N){return N=="public"||N=="private"||N=="protected"||N=="abstract"||N=="readonly"}function Se(N,G,ee){this.prev=N,this.vars=G,this.block=ee}function ne(N,G){this.name=N,this.next=G}var he=new ne("this",new ne("arguments",null));function Le(){O.state.context=new Se(O.state.context,O.state.localVars,!1),O.state.localVars=he}function _e(){O.state.context=new Se(O.state.context,O.state.localVars,!0),O.state.localVars=null}Le.lex=_e.lex=!0;function Ge(){O.state.localVars=O.state.context.vars,O.state.context=O.state.context.prev}Ge.lex=!0;function De(N,G){var ee=function(){var ce=O.state,Z=ce.indented;if(ce.lexical.type=="stat")Z=ce.lexical.indented;else for(var me=ce.lexical;me&&me.type==")"&&me.align;me=me.prev)Z=me.indented;ce.lexical=new _(Z,O.stream.column(),N,null,ce.lexical,G)};return ee.lex=!0,ee}function Ee(){var N=O.state;N.lexical.prev&&(N.lexical.type==")"&&(N.indented=N.lexical.indented),N.lexical=N.lexical.prev)}Ee.lex=!0;function Me(N){function G(ee){return ee==N?F():N==";"||ee=="}"||ee==")"||ee=="]"?z():F(G)}return G}function Fe(N,G){return N=="var"?F(De("vardef",G),ha,Me(";"),Ee):N=="keyword a"?F(De("form"),_t,Fe,Ee):N=="keyword b"?F(De("form"),Fe,Ee):N=="keyword d"?O.stream.match(/^\s*$/,!1)?F():F(De("stat"),bn,Me(";"),Ee):N=="debugger"?F(Me(";")):N=="{"?F(De("}"),_e,Vr,Ee,Ge):N==";"?F():N=="if"?(O.state.lexical.info=="else"&&O.state.cc[O.state.cc.length-1]==Ee&&O.state.cc.pop()(),F(De("form"),_t,Fe,Ee,pa)):N=="function"?F(Qn):N=="for"?F(De("form"),_e,jd,Fe,Ge,Ee):N=="class"||h&&G=="interface"?(O.marked="keyword",F(De("form",N=="class"?N:G),fa,Ee)):N=="variable"?h&&G=="declare"?(O.marked="keyword",F(Fe)):h&&(G=="module"||G=="enum"||G=="type")&&O.stream.match(/^\s*\w/,!1)?(O.marked="keyword",G=="enum"?F(Ie):G=="type"?F(Hd,Me("operator"),qe,Me(";")):F(De("form"),Sn,Me("{"),De("}"),Vr,Ee,Ee)):h&&G=="namespace"?(O.marked="keyword",F(De("form"),Ce,Fe,Ee)):h&&G=="abstract"?(O.marked="keyword",F(Fe)):F(De("stat"),Jo):N=="switch"?F(De("form"),_t,Me("{"),De("}","switch"),_e,Vr,Ee,Ee,Ge):N=="case"?F(Ce,Me(":")):N=="default"?F(Me(":")):N=="catch"?F(De("form"),Le,Ue,Fe,Ee,Ge):N=="export"?F(De("stat"),ma,Ee):N=="import"?F(De("stat"),qi,Ee):N=="async"?F(Fe):G=="@"?F(Ce,Fe):z(De("stat"),Ce,Me(";"),Ee)}function Ue(N){if(N=="(")return F(vr,Me(")"))}function Ce(N,G){return Yt(N,G,!1)}function Ye(N,G){return Yt(N,G,!0)}function _t(N){return N!="("?z():F(De(")"),bn,Me(")"),Ee)}function Yt(N,G,ee){if(O.state.fatArrowAt==O.stream.start){var ce=ee?Kn:He;if(N=="(")return F(Le,De(")"),Rt(vr,")"),Ee,Me("=>"),ce,Ge);if(N=="variable")return z(Le,Sn,Me("=>"),ce,Ge)}var Z=ee?dn:Xt;return B.hasOwnProperty(N)?F(Z):N=="function"?F(Qn,Z):N=="class"||h&&G=="interface"?(O.marked="keyword",F(De("form"),Bh,Ee)):N=="keyword c"||N=="async"?F(ee?Ye:Ce):N=="("?F(De(")"),bn,Me(")"),Ee,Z):N=="operator"||N=="spread"?F(ee?Ye:Ce):N=="["?F(De("]"),St,Ee,Z):N=="{"?$i(Gn,"}",null,Z):N=="quasi"?z(wn,Z):N=="new"?F(_i(ee)):F()}function bn(N){return N.match(/[;\}\)\],]/)?z():z(Ce)}function Xt(N,G){return N==","?F(bn):dn(N,G,!1)}function dn(N,G,ee){var ce=ee==!1?Xt:dn,Z=ee==!1?Ce:Ye;if(N=="=>")return F(Le,ee?Kn:He,Ge);if(N=="operator")return/\+\+|--/.test(G)||h&&G=="!"?F(ce):h&&G=="<"&&O.stream.match(/^([^<>]|<[^<>]*>)*>\s*\(/,!1)?F(De(">"),Rt(qe,">"),Ee,ce):G=="?"?F(Ce,Me(":"),Z):F(Z);if(N=="quasi")return z(wn,ce);if(N!=";"){if(N=="(")return $i(Ye,")","call",ce);if(N==".")return F(Ds,ce);if(N=="[")return F(De("]"),bn,Me("]"),Ee,ce);if(h&&G=="as")return O.marked="keyword",F(qe,ce);if(N=="regexp")return O.state.lastType=O.marked="operator",O.stream.backUp(O.stream.pos-O.stream.start-1),F(Z)}}function wn(N,G){return N!="quasi"?z():G.slice(G.length-2)!="${"?F(wn):F(bn,pr)}function pr(N){if(N=="}")return O.marked="string-2",O.state.tokenize=R,F(wn)}function He(N){return V(O.stream,O.state),z(N=="{"?Fe:Ce)}function Kn(N){return V(O.stream,O.state),z(N=="{"?Fe:Ye)}function _i(N){return function(G){return G=="."?F(N?fr:Ui):G=="variable"&&h?F(Vn,N?dn:Xt):z(N?Ye:Ce)}}function Ui(N,G){if(G=="target")return O.marked="keyword",F(Xt)}function fr(N,G){if(G=="target")return O.marked="keyword",F(dn)}function Jo(N){return N==":"?F(Ee,Fe):z(Xt,Me(";"),Ee)}function Ds(N){if(N=="variable")return O.marked="property",F()}function Gn(N,G){if(N=="async")return O.marked="property",F(Gn);if(N=="variable"||O.style=="keyword"){if(O.marked="property",G=="get"||G=="set")return F(Gd);var ee;return h&&O.state.fatArrowAt==O.stream.start&&(ee=O.stream.match(/^\s*:\s*/,!1))&&(O.state.fatArrowAt=O.stream.pos+ee[0].length),F(ai)}else{if(N=="number"||N=="string")return O.marked=l?"property":O.style+" property",F(ai);if(N=="jsonld-keyword")return F(ai);if(h&&le(G))return O.marked="keyword",F(Gn);if(N=="[")return F(Ce,zi,Me("]"),ai);if(N=="spread")return F(Ye,ai);if(G=="*")return O.marked="keyword",F(Gn);if(N==":")return z(ai)}}function Gd(N){return N!="variable"?z(ai):(O.marked="property",F(Qn))}function ai(N){if(N==":")return F(Ye);if(N=="(")return z(Qn)}function Rt(N,G,ee){function ce(Z,me){if(ee?ee.indexOf(Z)>-1:Z==","){var et=O.state.lexical;return et.info=="call"&&(et.pos=(et.pos||0)+1),F(function(Ut,Cn){return Ut==G||Cn==G?z():z(N)},ce)}return Z==G||me==G?F():ee&&ee.indexOf(";")>-1?z(N):F(Me(G))}return function(Z,me){return Z==G||me==G?F():z(N,ce)}}function $i(N,G,ee){for(var ce=3;ce<arguments.length;ce++)O.cc.push(arguments[ce]);return F(De(G,ee),Rt(N,G),Ee)}function Vr(N){return N=="}"?F():z(Fe,Vr)}function zi(N,G){if(h){if(N==":")return F(qe);if(G=="?")return F(zi)}}function Ps(N,G){if(h&&(N==":"||G=="in"))return F(qe)}function Gi(N){if(h&&N==":")return O.stream.match(/^\s*\w+\s+is\b/,!1)?F(Ce,Vh,qe):F(qe)}function Vh(N,G){if(G=="is")return O.marked="keyword",F()}function qe(N,G){if(G=="keyof"||G=="typeof"||G=="infer"||G=="readonly")return O.marked="keyword",F(G=="typeof"?Ye:qe);if(N=="variable"||G=="void")return O.marked="type",F(Zn);if(G=="|"||G=="&")return F(qe);if(N=="string"||N=="number"||N=="atom")return F(Zn);if(N=="[")return F(De("]"),Rt(qe,"]",","),Ee,Zn);if(N=="{")return F(De("}"),Ve,Ee,Zn);if(N=="(")return F(Rt(wt,")"),Wd,Zn);if(N=="<")return F(Rt(qe,">"),qe);if(N=="quasi")return z(tn,Zn)}function Wd(N){if(N=="=>")return F(qe)}function Ve(N){return N.match(/[\}\)\]]/)?F():N==","||N==";"?F(Ve):z(oi,Ve)}function oi(N,G){if(N=="variable"||O.style=="keyword")return O.marked="property",F(oi);if(G=="?"||N=="number"||N=="string")return F(oi);if(N==":")return F(qe);if(N=="[")return F(Me("variable"),Ps,Me("]"),oi);if(N=="(")return z(Hi,oi);if(!N.match(/[;\}\)\],]/))return F()}function tn(N,G){return N!="quasi"?z():G.slice(G.length-2)!="${"?F(tn):F(qe,bt)}function bt(N){if(N=="}")return O.marked="string-2",O.state.tokenize=R,F(tn)}function wt(N,G){return N=="variable"&&O.stream.match(/^\s*[?:]/,!1)||G=="?"?F(wt):N==":"?F(qe):N=="spread"?F(wt):z(qe)}function Zn(N,G){if(G=="<")return F(De(">"),Rt(qe,">"),Ee,Zn);if(G=="|"||N=="."||G=="&")return F(qe);if(N=="[")return F(qe,Me("]"),Zn);if(G=="extends"||G=="implements")return O.marked="keyword",F(qe);if(G=="?")return F(qe,Me(":"),qe)}function Vn(N,G){if(G=="<")return F(De(">"),Rt(qe,">"),Ee,Zn)}function gr(){return z(qe,nn)}function nn(N,G){if(G=="=")return F(qe)}function ha(N,G){return G=="enum"?(O.marked="keyword",F(Ie)):z(Sn,zi,mr,Oh)}function Sn(N,G){if(h&&le(G))return O.marked="keyword",F(Sn);if(N=="variable")return oe(G),F();if(N=="spread")return F(Sn);if(N=="[")return $i(Yo,"]");if(N=="{")return $i(Wi,"}")}function Wi(N,G){return N=="variable"&&!O.stream.match(/^\s*:/,!1)?(oe(G),F(mr)):(N=="variable"&&(O.marked="property"),N=="spread"?F(Sn):N=="}"?z():N=="["?F(Ce,Me("]"),Me(":"),Wi):F(Me(":"),Sn,mr))}function Yo(){return z(Sn,mr)}function mr(N,G){if(G=="=")return F(Ye)}function Oh(N){if(N==",")return F(ha)}function pa(N,G){if(N=="keyword b"&&G=="else")return F(De("form","else"),Fe,Ee)}function jd(N,G){if(G=="await")return F(jd);if(N=="(")return F(De(")"),Xo,Ee)}function Xo(N){return N=="var"?F(ha,ji):N=="variable"?F(ji):z(ji)}function ji(N,G){return N==")"?F():N==";"?F(ji):G=="in"||G=="of"?(O.marked="keyword",F(Ce,ji)):z(Ce,ji)}function Qn(N,G){if(G=="*")return O.marked="keyword",F(Qn);if(N=="variable")return oe(G),F(Qn);if(N=="(")return F(Le,De(")"),Rt(vr,")"),Ee,Gi,Fe,Ge);if(h&&G=="<")return F(De(">"),Rt(gr,">"),Ee,Qn)}function Hi(N,G){if(G=="*")return O.marked="keyword",F(Hi);if(N=="variable")return oe(G),F(Hi);if(N=="(")return F(Le,De(")"),Rt(vr,")"),Ee,Gi,Ge);if(h&&G=="<")return F(De(">"),Rt(gr,">"),Ee,Hi)}function Hd(N,G){if(N=="keyword"||N=="variable")return O.marked="type",F(Hd);if(G=="<")return F(De(">"),Rt(gr,">"),Ee)}function vr(N,G){return G=="@"&&F(Ce,vr),N=="spread"?F(vr):h&&le(G)?(O.marked="keyword",F(vr)):h&&N=="this"?F(zi,mr):z(Sn,zi,mr)}function Bh(N,G){return N=="variable"?fa(N,G):yr(N,G)}function fa(N,G){if(N=="variable")return oe(G),F(yr)}function yr(N,G){if(G=="<")return F(De(">"),Rt(gr,">"),Ee,yr);if(G=="extends"||G=="implements"||h&&N==",")return G=="implements"&&(O.marked="keyword"),F(h?qe:Ce,yr);if(N=="{")return F(De("}"),br,Ee)}function br(N,G){if(N=="async"||N=="variable"&&(G=="static"||G=="get"||G=="set"||h&&le(G))&&O.stream.match(/^\s+#?[\w$\xa1-\uffff]/,!1))return O.marked="keyword",F(br);if(N=="variable"||O.style=="keyword")return O.marked="property",F(ga,br);if(N=="number"||N=="string")return F(ga,br);if(N=="[")return F(Ce,zi,Me("]"),ga,br);if(G=="*")return O.marked="keyword",F(br);if(h&&N=="(")return z(Hi,br);if(N==";"||N==",")return F(br);if(N=="}")return F();if(G=="@")return F(Ce,br)}function ga(N,G){if(G=="!"||G=="?")return F(ga);if(N==":")return F(qe,mr);if(G=="=")return F(Ye);var ee=O.state.lexical.prev,ce=ee&&ee.info=="interface";return z(ce?Hi:Qn)}function ma(N,G){return G=="*"?(O.marked="keyword",F(ba,Me(";"))):G=="default"?(O.marked="keyword",F(Ce,Me(";"))):N=="{"?F(Rt(va,"}"),ba,Me(";")):z(Fe)}function va(N,G){if(G=="as")return O.marked="keyword",F(Me("variable"));if(N=="variable")return z(Ye,va)}function qi(N){return N=="string"?F():N=="("?z(Ce):N=="."?z(Xt):z(ya,Or,ba)}function ya(N,G){return N=="{"?$i(ya,"}"):(N=="variable"&&oe(G),G=="*"&&(O.marked="keyword"),F(Ko))}function Or(N){if(N==",")return F(ya,Or)}function Ko(N,G){if(G=="as")return O.marked="keyword",F(ya)}function ba(N,G){if(G=="from")return O.marked="keyword",F(Ce)}function St(N){return N=="]"?F():z(Rt(Ye,"]"))}function Ie(){return z(De("form"),Sn,Me("{"),De("}"),Rt(li,"}"),Ee,Ee)}function li(){return z(Sn,mr)}function Zo(N,G){return N.lastType=="operator"||N.lastType==","||y.test(G.charAt(0))||/[,.]/.test(G.charAt(0))}function Wn(N,G,ee){return G.tokenize==P&&/^(?:operator|sof|keyword [bcd]|case|new|export|default|spread|[\[{}\(,;:]|=>)$/.test(G.lastType)||G.lastType=="quasi"&&/\{\s*$/.test(N.string.slice(0,N.pos-(ee||0)))}return{startState:function(N){var G={tokenize:P,lastType:"sof",cc:[],lexical:new _((N||0)-s,0,"block",!1),localVars:i.localVars,context:i.localVars&&new Se(null,null,!1),indented:N||0};return i.globalVars&&typeof i.globalVars=="object"&&(G.globalVars=i.globalVars),G},token:function(N,G){if(N.sol()&&(G.lexical.hasOwnProperty("align")||(G.lexical.align=!1),G.indented=N.indentation(),V(N,G)),G.tokenize!=L&&N.eatSpace())return null;var ee=G.tokenize(N,G);return w=="comment"?ee:(G.lastType=w=="operator"&&(E=="++"||E=="--")?"incdec":w,U(G,ee,w,E,N))},indent:function(N,G){if(N.tokenize==L||N.tokenize==R)return t.Pass;if(N.tokenize!=P)return 0;var ee=G&&G.charAt(0),ce=N.lexical,Z;if(!/^\s*else\b/.test(G))for(var me=N.cc.length-1;me>=0;--me){var et=N.cc[me];if(et==Ee)ce=ce.prev;else if(et!=pa&&et!=Ge)break}for(;(ce.type=="stat"||ce.type=="form")&&(ee=="}"||(Z=N.cc[N.cc.length-1])&&(Z==Xt||Z==dn)&&!/^[,\.=+\-*:?[\(]/.test(G));)ce=ce.prev;a&&ce.type==")"&&ce.prev.type=="stat"&&(ce=ce.prev);var Ut=ce.type,Cn=ee==Ut;return Ut=="vardef"?ce.indented+(N.lastType=="operator"||N.lastType==","?ce.info.length+1:0):Ut=="form"&&ee=="{"?ce.indented:Ut=="form"?ce.indented+s:Ut=="stat"?ce.indented+(Zo(N,G)?a||s:0):ce.info=="switch"&&!Cn&&i.doubleIndentSwitch!=!1?ce.indented+(/^(?:case|default)\b/.test(G)?s:2*s):ce.align?ce.column+(Cn?0:1):ce.indented+(Cn?0:s)},electricInput:/^\s*(?:case .*?:|default:|\{|\})$/,blockCommentStart:c?null:"/*",blockCommentEnd:c?null:"*/",blockCommentContinue:c?null:" * ",lineComment:c?null:"//",fold:"brace",closeBrackets:"()[]{}''\"\"``",helperType:c?"json":"javascript",jsonldMode:l,jsonMode:c,expressionAllowed:Wn,skipExpression:function(N){U(N,"atom","atom","true",new t.StringStream("",2,null))}}}),t.registerHelper("wordChars","javascript",/[\w$]/),t.defineMIME("text/javascript","javascript"),t.defineMIME("text/ecmascript","javascript"),t.defineMIME("application/javascript","javascript"),t.defineMIME("application/x-javascript","javascript"),t.defineMIME("application/ecmascript","javascript"),t.defineMIME("application/json",{name:"javascript",json:!0}),t.defineMIME("application/x-json",{name:"javascript",json:!0}),t.defineMIME("application/manifest+json",{name:"javascript",json:!0}),t.defineMIME("application/ld+json",{name:"javascript",jsonld:!0}),t.defineMIME("text/typescript",{name:"javascript",typescript:!0}),t.defineMIME("application/typescript",{name:"javascript",typescript:!0})})})()),qz.exports}Yz();var Xz={exports:{}},dE;function DI(){return dE||(dE=1,(function(n,e){(function(t){t(Go())})(function(t){function r(l,c,u,h){if(u&&u.call){var g=u;u=null}else var g=a(l,u,"rangeFinder");typeof c=="number"&&(c=t.Pos(c,0));var v=a(l,u,"minFoldSize");function y(E){var k=g(l,c);if(!k||k.to.line-k.from.line<v)return null;if(h==="fold")return k;for(var P=l.findMarksAt(k.from),D=0;D<P.length;++D)if(P[D].__isFold){if(!E)return null;k.cleared=!0,P[D].clear()}return k}var C=y(!0);if(a(l,u,"scanUp"))for(;!C&&c.line>l.firstLine();)c=t.Pos(c.line-1,0),C=y(!1);if(!(!C||C.cleared||h==="unfold")){var S=i(l,u,C);t.on(S,"mousedown",function(E){w.clear(),t.e_preventDefault(E)});var w=l.markText(C.from,C.to,{replacedWith:S,clearOnEnter:a(l,u,"clearOnEnter"),__isFold:!0});w.on("clear",function(E,k){t.signal(l,"unfold",l,E,k)}),t.signal(l,"fold",l,C.from,C.to)}}function i(l,c,u){var h=a(l,c,"widget");if(typeof h=="function"&&(h=h(u.from,u.to)),typeof h=="string"){var g=document.createTextNode(h);h=document.createElement("span"),h.appendChild(g),h.className="CodeMirror-foldmarker"}else h&&(h=h.cloneNode(!0));return h}t.newFoldFunction=function(l,c){return function(u,h){r(u,h,{rangeFinder:l,widget:c})}},t.defineExtension("foldCode",function(l,c,u){r(this,l,c,u)}),t.defineExtension("isFolded",function(l){for(var c=this.findMarksAt(l),u=0;u<c.length;++u)if(c[u].__isFold)return!0}),t.commands.toggleFold=function(l){l.foldCode(l.getCursor())},t.commands.fold=function(l){l.foldCode(l.getCursor(),null,"fold")},t.commands.unfold=function(l){l.foldCode(l.getCursor(),{scanUp:!1},"unfold")},t.commands.foldAll=function(l){l.operation(function(){for(var c=l.firstLine(),u=l.lastLine();c<=u;c++)l.foldCode(t.Pos(c,0),{scanUp:!1},"fold")})},t.commands.unfoldAll=function(l){l.operation(function(){for(var c=l.firstLine(),u=l.lastLine();c<=u;c++)l.foldCode(t.Pos(c,0),{scanUp:!1},"unfold")})},t.registerHelper("fold","combine",function(){var l=Array.prototype.slice.call(arguments,0);return function(c,u){for(var h=0;h<l.length;++h){var g=l[h](c,u);if(g)return g}}}),t.registerHelper("fold","auto",function(l,c){for(var u=l.getHelpers(c,"fold"),h=0;h<u.length;h++){var g=u[h](l,c);if(g)return g}});var s={rangeFinder:t.fold.auto,widget:"↔",minFoldSize:0,scanUp:!1,clearOnEnter:!0};t.defineOption("foldOptions",null);function a(l,c,u){if(c&&c[u]!==void 0)return c[u];var h=l.options.foldOptions;return h&&h[u]!==void 0?h[u]:s[u]}t.defineExtension("foldOption",function(l,c){return a(this,l,c)})})})()),Xz.exports}DI();var Kz={exports:{}},cE;function Zz(){return cE||(cE=1,(function(n,e){(function(t){t(Go(),DI())})(function(t){t.defineOption("foldGutter",!1,function(w,E,k){k&&k!=t.Init&&(w.clearGutter(w.state.foldGutter.options.gutter),w.state.foldGutter=null,w.off("gutterClick",g),w.off("changes",y),w.off("viewportChange",C),w.off("fold",S),w.off("unfold",S),w.off("swapDoc",y),w.off("optionChange",v)),E&&(w.state.foldGutter=new i(s(E)),h(w),w.on("gutterClick",g),w.on("changes",y),w.on("viewportChange",C),w.on("fold",S),w.on("unfold",S),w.on("swapDoc",y),w.on("optionChange",v))});var r=t.Pos;function i(w){this.options=w,this.from=this.to=0}function s(w){return w===!0&&(w={}),w.gutter==null&&(w.gutter="CodeMirror-foldgutter"),w.indicatorOpen==null&&(w.indicatorOpen="CodeMirror-foldgutter-open"),w.indicatorFolded==null&&(w.indicatorFolded="CodeMirror-foldgutter-folded"),w}function a(w,E){for(var k=w.findMarks(r(E,0),r(E+1,0)),P=0;P<k.length;++P)if(k[P].__isFold){var D=k[P].find(-1);if(D&&D.line===E)return k[P]}}function l(w){if(typeof w=="string"){var E=document.createElement("div");return E.className=w+" CodeMirror-guttermarker-subtle",E}else return w.cloneNode(!0)}function c(w,E,k){var P=w.state.foldGutter.options,D=E-1,L=w.foldOption(P,"minFoldSize"),R=w.foldOption(P,"rangeFinder"),M=typeof P.indicatorFolded=="string"&&u(P.indicatorFolded),V=typeof P.indicatorOpen=="string"&&u(P.indicatorOpen);w.eachLine(E,k,function(B){++D;var _=null,H=B.gutterMarkers;if(H&&(H=H[P.gutter]),a(w,D)){if(M&&H&&M.test(H.className))return;_=l(P.indicatorFolded)}else{var U=r(D,0),O=R&&R(w,U);if(O&&O.to.line-O.from.line>=L){if(V&&H&&V.test(H.className))return;_=l(P.indicatorOpen)}}!_&&!H||w.setGutterMarker(B,P.gutter,_)})}function u(w){return new RegExp("(^|\\s)"+w+"(?:$|\\s)\\s*")}function h(w){var E=w.getViewport(),k=w.state.foldGutter;k&&(w.operation(function(){c(w,E.from,E.to)}),k.from=E.from,k.to=E.to)}function g(w,E,k){var P=w.state.foldGutter;if(P){var D=P.options;if(k==D.gutter){var L=a(w,E);L?L.clear():w.foldCode(r(E,0),D)}}}function v(w,E){E=="mode"&&y(w)}function y(w){var E=w.state.foldGutter;if(E){var k=E.options;E.from=E.to=0,clearTimeout(E.changeUpdate),E.changeUpdate=setTimeout(function(){h(w)},k.foldOnChangeTimeSpan||600)}}function C(w){var E=w.state.foldGutter;if(E){var k=E.options;clearTimeout(E.changeUpdate),E.changeUpdate=setTimeout(function(){var P=w.getViewport();E.from==E.to||P.from-E.to>20||E.from-P.to>20?h(w):w.operation(function(){P.from<E.from&&(c(w,P.from,E.from),E.from=P.from),P.to>E.to&&(c(w,E.to,P.to),E.to=P.to)})},k.updateViewportTimeSpan||400)}}function S(w,E){var k=w.state.foldGutter;if(k){var P=E.line;P>=k.from&&P<k.to&&c(w,P,P+1)}}})})()),Kz.exports}Zz();var Qz={exports:{}},uE;function eG(){return uE||(uE=1,(function(n,e){(function(t){t(Go())})(function(t){function r(i){return function(s,a){var l=a.line,c=s.getLine(l);function u(S){for(var w,E=a.ch,k=0;;){var P=E<=0?-1:c.lastIndexOf(S[0],E-1);if(P==-1){if(k==1)break;k=1,E=c.length;continue}if(k==1&&P<a.ch)break;if(w=s.getTokenTypeAt(t.Pos(l,P+1)),!/^(comment|string)/.test(w))return{ch:P+1,tokenType:w,pair:S};E=P-1}}function h(S){var w=1,E=s.lastLine(),k,P=S.ch,D;e:for(var L=l;L<=E;++L)for(var R=s.getLine(L),M=L==l?P:0;;){var V=R.indexOf(S.pair[0],M),B=R.indexOf(S.pair[1],M);if(V<0&&(V=R.length),B<0&&(B=R.length),M=Math.min(V,B),M==R.length)break;if(s.getTokenTypeAt(t.Pos(L,M+1))==S.tokenType){if(M==V)++w;else if(!--w){k=L,D=M;break e}}++M}return k==null||l==k?null:{from:t.Pos(l,P),to:t.Pos(k,D)}}for(var g=[],v=0;v<i.length;v++){var y=u(i[v]);y&&g.push(y)}g.sort(function(S,w){return S.ch-w.ch});for(var v=0;v<g.length;v++){var C=h(g[v]);if(C)return C}return null}}t.registerHelper("fold","brace",r([["{","}"],["[","]"]])),t.registerHelper("fold","brace-paren",r([["{","}"],["[","]"],["(",")"]])),t.registerHelper("fold","import",function(i,s){function a(v){if(v<i.firstLine()||v>i.lastLine())return null;var y=i.getTokenAt(t.Pos(v,1));if(/\S/.test(y.string)||(y=i.getTokenAt(t.Pos(v,y.end+1))),y.type!="keyword"||y.string!="import")return null;for(var C=v,S=Math.min(i.lastLine(),v+10);C<=S;++C){var w=i.getLine(C),E=w.indexOf(";");if(E!=-1)return{startCh:y.end,end:t.Pos(C,E)}}}var l=s.line,c=a(l),u;if(!c||a(l-1)||(u=a(l-2))&&u.end.line==l-1)return null;for(var h=c.end;;){var g=a(h.line+1);if(g==null)break;h=g.end}return{from:i.clipPos(t.Pos(l,c.startCh+1)),to:h}}),t.registerHelper("fold","include",function(i,s){function a(g){if(g<i.firstLine()||g>i.lastLine())return null;var v=i.getTokenAt(t.Pos(g,1));if(/\S/.test(v.string)||(v=i.getTokenAt(t.Pos(g,v.end+1))),v.type=="meta"&&v.string.slice(0,8)=="#include")return v.start+8}var l=s.line,c=a(l);if(c==null||a(l-1)!=null)return null;for(var u=l;;){var h=a(u+1);if(h==null)break;++u}return{from:t.Pos(l,c+1),to:i.clipPos(t.Pos(u))}})})})()),Qz.exports}eG();var tG=Go();const ls=Qe(tG),nG=100;class rG extends Dh{constructor(e){super(),this.viewer=e,this.parsedValue=null,this.debouncedValueUpdater=rt(()=>{const s=this.textEditor.getValue();try{const a=JSON.parse(s);this.parsedValue=a,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(a){this.parsedValue=null,this.applyButton.disabled=!0;let l=0,c=0,u="Unknown parse error";if(a instanceof Error){const h=a.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(h!==null){u=h[1];const g=parseInt(h[2],10),v=s.substring(0,g).split(`
`);l=v.length-1,c=v[v.length-1].length}else u=a.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:u,severity:"error",from:ls.Pos(l,c)}]})}},nG),this.content.classList.add("neuroglancer-state-editor");const t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",()=>this.applyChanges()),t.disabled=!0;const r=this.closeButton=document.createElement("button");r.classList.add("close-button"),r.textContent="Close",this.content.appendChild(r),r.addEventListener("click",()=>this.dispose());const i=this.downloadButton=document.createElement("button");i.textContent="Download",i.title="Download state as a JSON file",this.content.appendChild(i),i.addEventListener("click",()=>this.downloadState()),this.textEditor=ls(s=>{},{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",()=>{this.debouncedValueUpdater()}),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}downloadState(){const e=document.createElement("a"),t=new Blob([this.getJson()],{type:"text/json"}),r=URL.createObjectURL(t);e.href=r,e.download="state.json",e.click(),document.body.removeChild(e)}applyChanges(){this.parsedValue!==null&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}getJson(){return ie(Wv(this.viewer.state).value,null,"  ")}}var Fc={},hE;function iG(){if(hE)return Fc;hE=1,Fc.__esModule=!0;var n=$T(),e=t(n);function t(r){return r&&r.__esModule?r:{default:r}}return Fc.default=function(r){return Array.isArray(r)?r:(0,e.default)(r)},Fc}var sG=iG();const aG=Qe(sG),oG={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1};class lG{constructor(){this.location=new Ls(oG)}get changed(){return this.location.changed}restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return No(this.location.toJSON())}}function dG(n){const e=new de;function t(r,i){if(typeof r!="object"){e.set(i,""+r);return}for(const s of Qt(r))t(r[s],i+"."+s)}return t(n,""),e}function cG(n){const e=new ze;e.add(".type");const t=new ze;function r(i,s){for(const a of e)if(n[i].get(a)!==n[s].get(a))return!0;return!1}for(let i=0,s=n.length;i<s;++i){for(const l of n[i].keys())t.add(l);let a=[];for(let l=0;l<i;++l)r(i,l)||a.push(l);for(;a.length>0;){let l=a,c;for(const u of t){if(e.has(u))continue;const h=[];for(const g of a)n[g].get(u)===n[i].get(u)&&h.push(g);if(h.length<l.length&&(l=h,c=u),h.length===0)break}if(c===void 0)break;a=l,e.add(c)}}return Te(e)}function uG(n,e){const t={};for(const r of e){const i=n.get(r);if(i!==void 0){if(r==="")return i;t[r]=i}}return ie(t)}function hG(n){return j({type:n.RPC_TYPE_ID},n.key||{})}function pG(n){const e=n.map(dG),t=cG(e);return e.map(r=>uG(r,t))}const fG=1e3,Wf=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:n=>{let e=0;for(let t=0;t<jk;++t)e+=n[$s(t,mi.VISIBLE)*as+vi.numChunks];return e}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:n=>n[$s(pt.DOWNLOADING,mi.VISIBLE)*as+vi.numChunks]},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:n=>n[$s(pt.SYSTEM_MEMORY,mi.VISIBLE)*as+vi.numChunks]+n[$s(pt.SYSTEM_MEMORY_WORKER,mi.VISIBLE)*as+vi.numChunks]},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:n=>n[$s(pt.GPU_MEMORY,mi.VISIBLE)*as+vi.numChunks]},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:n=>n[$s(pt.FAILED,mi.VISIBLE)*as+vi.numChunks]},{label:"Visible memory",key:"visibleGpuMemory",getter:n=>n[$s(pt.GPU_MEMORY,mi.VISIBLE)*as+vi.gpuMemoryBytes]},{label:"Download latency",key:"downloadLatency",getter:n=>n[wC(uu.totalTime)]/n[wC(uu.totalChunks)]}];class gG extends da{constructor(e,t,r){super(e,r.location),this.chunkQueueManager=t,this.displayState=r,this.data=void 0,this.requestDataTimerId=-1,this.dataRequested=!1,this.body=document.createElement("div"),this.debouncedUpdateView=this.registerCancellable(rt(()=>this.updateView(),0));const i=this.body;i.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(i),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;const e=this.chunkQueueManager;this.dataRequested=!0,e.getStatistics().then(t=>{this.dataRequested=!1,this.data=t,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout(()=>{this.requestDataTimerId=-1,this.requestData()},fG)})}updateView(){const e=this.data;if(e===void 0)return;const t=document.createElement("table"),r=[];for(const u of e){var i=ae(u,2);const h=i[0],g=i[1],v=[h];for(const y of Wf){const C=y.getter;v.push(C(g))}r.push(v)}const s=pG(r.map(u=>hG(u[0]))),a=new de;s.forEach((u,h)=>{a.set(r[h][0],u)});{const u=document.createElement("thead");let h=document.createElement("tr");u.appendChild(h);const g=y=>{const C=document.createElement("td");C.textContent=y,h.appendChild(C)};g("Name");let v;for(const y of Wf){const C=y.label,S=C.indexOf("/");let w=C;if(S!==-1){if(w=C.substring(0,S),w===v){++h.lastElementChild.colSpan;continue}v=w}g(w)}h=document.createElement("tr"),u.appendChild(h);{const y=document.createElement("td");h.appendChild(y)}for(const y of Wf){const C=y.label,S=C.indexOf("/");let w="";S!==-1&&(w=C.substring(S+1));const E=document.createElement("td");E.textContent=w,h.appendChild(E)}t.appendChild(u)}const l=document.createElement("tbody");for(const u of r){var c=aG(u);const h=c[0],g=c.slice(1),v=document.createElement("tr"),y=C=>{const S=document.createElement("td");S.textContent=C,v.appendChild(S)};y(a.get(h));for(const C of g)y(""+C);l.appendChild(v)}t.appendChild(l),Xe(this.body),this.body.appendChild(t)}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class my extends K{constructor(e,t=()=>lt(1,0,0)){super(),this.model=e,this.getDefaultColor=t,this.element=document.createElement("input");const r=this.element;r.classList.add("neuroglancer-color-widget"),r.type="color",r.addEventListener("change",()=>this.updateModel()),r.addEventListener("input",()=>this.updateModel()),r.addEventListener("wheel",i=>{i.stopPropagation(),i.preventDefault(),this.adjustHueViaWheel(i)}),this.registerDisposer(e.changed.add(()=>this.updateView())),this.updateView()}getRGB(){var e;return(e=this.model.value)!==null&&e!==void 0?e:this.getDefaultColor()}updateView(){this.element.value=Rn(this.getRGB())}updateModel(){this.model.value=Ao(this.element.value)}adjustHueViaWheel(e){const t=this.getRGB(),r=Ne();q_(r,t[0],t[1],t[2]);const i=e.deltaY;let s=Math.round(r[0]*256);s+=i>0?1:i<0?-1:0,s=(s+256)%256,r[0]=s/256,bu(r,r[0],r[1],r[2]),this.model.value=r}}class mG extends K{constructor(e,t={}){super(),this.model=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input");let r=t.validator,i=t.label;const s=this.element,a=this.inputElement;r===void 0&&(e instanceof Jt?r=e.validator:r=l=>l),this.validator=r,i!==void 0&&(s.textContent=i),s.appendChild(a),s.className="neuroglancer-number-input",a.type="text",this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(a,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(Wr(e)){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){Et(this.element),super.disposed()}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class PI extends K{constructor(e){super(),this.model=e,this.element=document.createElement("input"),this.registerDisposer(e.changed.add(()=>this.updateView()));const t=this.element;t.type="text",this.registerEventListener(t,"change",()=>this.updateModel()),this.updateView()}disposed(){Et(this.element)}updateView(){var e;this.element.value=((e=this.model.value)!==null&&e!==void 0?e:"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}}const vG=j(j({},la),{side:"left",row:2});class yG{constructor(){this.location=new Ls(vG)}get changed(){return this.location.changed}toJSON(){return No(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class bG extends da{constructor(e,t,r){super(e,t.location),this.addTitleBar({title:"Settings"});const i=document.createElement("div");i.classList.add("neuroglancer-settings-body");let s=document.createElement("div");s.classList.add("neuroglancer-settings-scroll-container"),i.appendChild(s),this.addBody(i);{const u=this.registerDisposer(new PI(r.title));u.element.placeholder="Title",u.element.classList.add("neuroglancer-settings-title"),s.appendChild(u.element)}const a=(u,h)=>{const g=this.registerDisposer(new mG(h,{label:u}));g.element.classList.add("neuroglancer-settings-limit-widget"),s.appendChild(g.element)};a("GPU memory limit",r.chunkQueueManager.capacities.gpuMemory.sizeLimit),a("System memory limit",r.chunkQueueManager.capacities.systemMemory.sizeLimit),a("Concurrent chunk requests",r.chunkQueueManager.capacities.download.itemLimit);const l=(u,h)=>{const g=document.createElement("label");g.textContent=u;const v=this.registerDisposer(new Ts(h));g.appendChild(v.element),s.appendChild(g)};l("Show axis lines",r.showAxisLines),l("Show scale bar",r.showScaleBar),l("Show cross sections in 3-d",r.showPerspectiveSliceViews),l("Show default annotations",r.showDefaultAnnotations),l("Show chunk statistics",r.statisticsDisplayState.location.watchableVisible),l("Wire frame rendering",r.wireFrame),l("Enable prefetching",r.chunkQueueManager.enablePrefetch);const c=(u,h)=>{const g=document.createElement("label");g.textContent=u;const v=this.registerDisposer(new my(h));g.appendChild(v.element),s.appendChild(g)};c("Cross-section background",r.crossSectionBackgroundColor),c("Projection background",r.perspectiveViewBackgroundColor)}}class wG extends K{constructor(e,t){super(),this.selectedLayer=e,this.toolBinder=t,this.element=document.createElement("div"),this.viewContext=void 0,this.updateView=this.registerCancellable(ct(()=>{let i=this.viewContext;i!==void 0&&(this.unregisterDisposer(i),i.dispose()),this.viewContext=i=this.registerDisposer(new K),Xe(this.element);const s=this.selectedTool;s!==void 0&&this.element.appendChild(this.makeWidget(i,s));const a=Te(this.toolBinder.bindings);a.sort(([c],[u])=>kd(c,u));for(const c of a){var l=ae(c,2);const u=l[1];this.element.appendChild(this.makeWidget(i,u))}}));const r=this.element;r.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add(()=>this.selectedLayerChanged())),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}get selectedTool(){const e=this.selectedLayer.layer;if(e===void 0)return;const t=e.layer;if(t!==null)return t.tool.value}selectedLayerChanged(){let e=this.unbindPreviousLayer;e!==void 0&&e();const t=this.selectedLayer.layer;t!==void 0&&(this.unbindPreviousLayer=t.specificationChanged.add(()=>{this.updateView()})),this.updateView()}disposed(){const e=this.unbindPreviousLayer;e!==void 0&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){const r=document.createElement("div");r.title="dblclick → unbind",t instanceof To&&(r.title+=", click → bind key"),r.className="neuroglancer-annotation-tool-status-widget";const i=document.createElement("div");i.className="neuroglancer-annotation-tool-status-widget-layer-number";const s=t.layer.managedLayer;s.manager.rootLayers.updateNonArchivedLayerIndices();const a=s.nonArchivedLayerIndex;i.textContent=(a+1).toString();const l=document.createElement("div");if(l.className="neuroglancer-annotation-tool-status-widget-description",l.textContent=t.description,r.addEventListener("dblclick",()=>{t instanceof Y2?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)}),t instanceof To){const c=document.createElement("div");c.className="neuroglancer-annotation-tool-status-widget-key",c.textContent=t.keyBinding,r.appendChild(c),Z2(e,r,u=>t.layer.toolBinder.set(u,t.addRef()))}return r.appendChild(i),r.appendChild(l),r}}function SG(n){return encodeURI(n).replace(/[!'()*;,]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}class CG extends K{constructor(e,t,r=""){super(),this.gl=e,this.frameNumberCounter=t;const i=r+"chunk_worker.bundle.js";this.worker=typeof r=="string"?new Worker(i):r,this.chunkQueueManager=this.registerDisposer(new Ng(new kO(this.worker),this.gl,this.frameNumberCounter,{gpuMemory:new Lc({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new Lc({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new Lc({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new Lc({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer(()=>this.worker.terminate()),this.chunkManager=this.registerDisposer(new Vg(this.chunkQueueManager))}get rpc(){return this.chunkQueueManager.rpc}}const RI=["showHelpButton","showSettingsButton","showEditStateButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus"],MI=[...RI,"showLayerPanel","showLayerHoverValues"],AI=[...MI,"showUIControls","showPanelBorders"];function xG(){return Object.fromEntries(AI.map(n=>[n,new Ft(!0)]))}function EG(n,e){for(const t of AI){const r=e[t];r!==void 0&&(n[t].value=r)}}const TG=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS<"u"?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0};class kG extends ph{constructor(e){super(),this.viewer=e,this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer)}restoreState(e){const t=this.viewer;super.restoreState(e),ye(e,"navigation",r=>{ge(r),ye(r,"pose",i=>{ge(i),ye(i,"position",s=>{ge(s),pn(s,"voxelCoordinates",t.position),ye(s,"voxelSize",a=>{const l=it(new Float64Array(3),a,yn);for(let c=0;c<3;++c)l[c]*=1e-9;t.coordinateSpace.value=st({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:l})})}),pn(i,"orientation",t.crossSectionOrientation)}),pn(r,"zoomFactor",t.crossSectionScale.legacyJsonView)}),pn(e,"perspectiveOrientation",t.projectionOrientation),pn(e,"perspectiveZoom",t.projectionScale.legacyJsonView),pn(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}}const ps={expectingExternalUI:!1};class LG extends K{constructor(e,t={}){super(),this.display=e,this.title=new Jt(void 0,ke),this.coordinateSpace=new gv,this.position=this.registerDisposer(new Hs(this.coordinateSpace)),this.relativeDisplayScales=this.registerDisposer(new c2(this.coordinateSpace)),this.displayDimensions=this.registerDisposer(new h2(this.coordinateSpace)),this.displayDimensionRenderInfo=this.registerDisposer(new u2(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef())),this.crossSectionOrientation=this.registerDisposer(new wo),this.crossSectionScale=this.registerDisposer(new w_(this.displayDimensionRenderInfo.addRef())),this.projectionOrientation=this.registerDisposer(new wo),this.crossSectionDepthRange=this.registerDisposer(new zg(-10,this.displayDimensionRenderInfo)),this.projectionDepthRange=this.registerDisposer(new zg(-50,this.displayDimensionRenderInfo)),this.projectionScale=this.registerDisposer(new S_(this.displayDimensionRenderInfo.addRef())),this.navigationState=this.registerDisposer(new Co(new So(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef())),this.perspectiveNavigationState=this.registerDisposer(new Co(new So(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef())),this.mouseState=new RG,this.layerManager=this.registerDisposer(new NI),this.selectedLayer=this.registerDisposer(new FG(this.layerManager.addRef())),this.showAxisLines=new Ft(!0,!0),this.wireFrame=new Ft(!1,!1),this.showScaleBar=new Ft(!0,!0),this.showPerspectiveSliceViews=new Ft(!0,!0),this.visibleLayerRoles=MO(),this.showDefaultAnnotations=new Ft(!0,!0),this.crossSectionBackgroundColor=new ru(lt(.5,.5,.5)),this.perspectiveViewBackgroundColor=new ru(lt(0,0,0)),this.scaleBarOptions=new u$,this.partialViewport=new iO,this.statisticsDisplayState=new lG,this.helpPanelState=new rz,this.settingsPanelState=new yG,this.layerSelectedValues=this.registerDisposer(new MG(this.layerManager,this.mouseState)),this.selectionDetailsState=this.registerDisposer(new AG(this.coordinateSpace,this.layerSelectedValues)),this.selectedStateServer=new Jt("",ke),this.layerListPanelState=new $z,this.resetInitiated=new we,this.makeUrlFromState=P=>ps.expectingExternalUI?"/#!"+SG(ie(P)):window.location.toString(),this.uiControlVisibility={},this.visible=!0,this.toolInputEventMapBinder=(P,D)=>{D.registerDisposer(this.inputEventBindings.sliceView.addParent(P,Number.POSITIVE_INFINITY)),D.registerDisposer(this.inputEventBindings.perspectiveView.addParent(P,Number.POSITIVE_INFINITY))},this.toolBinder=this.registerDisposer(new M4(this.toolInputEventMapBinder));var r=t.dataContext;const i=r===void 0?new CG(e.gl,e,t.bundleRoot):r;var s=t.visibility;const a=s===void 0?new Nt(Nt.VISIBLE):s;var l=t.inputEventBindings;const c=l===void 0?{global:new at,sliceView:new at,perspectiveView:new at}:l;var u=t.element;const h=u===void 0?e.makeCanvasOverlayElement():u;var g=t.dataSourceProvider;const v=g===void 0?$$({credentialsManager:$o}):g;var y=t.uiConfiguration;const C=y===void 0?xG():y;this.visibility=a,this.inputEventBindings=c,this.element=h,this.dataSourceProvider=v,this.uiConfiguration=C,this.registerDisposer(ki(P=>{this.display.applyWindowedViewportToElement(h,P)},this.partialViewport)),this.registerDisposer(()=>Et(this.element)),this.dataContext=this.registerDisposer(i),EG(C,t);const S=j(j({},TG),t),w=S.resetStateWhenEmpty,E=S.showLayerDialog;for(const P of MI)this.uiControlVisibility[P]=this.makeUiControlVisibilityState(P);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add(()=>{this.updateShowBorders()})),this.showLayerDialog=E,this.resetStateWhenEmpty=w,this.layerSpecification=new $G(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.toolBinder),this.registerDisposer(e.updateStarted.add(()=>{this.onUpdateDisplay()})),this.showDefaultAnnotations.changed.add(()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(ur.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(ur.DEFAULT_ANNOTATION)}),this.registerDisposer(this.navigationState.changed.add(()=>{this.handleNavigationStateChanged()}));const k=this.registerCancellable(rt(()=>{!this.wasDisposed&&this.layerManager.managedLayers.length===0&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.resetInitiated.dispatch(),!lm&&this.showLayerDialog&&this.visibility.visible&&HI(this.layerSpecification,this.selectedLayer))}));this.layerManager.layersChanged.add(k),k(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.layerSelectedValues.handleLayerChange()})),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(EI(h,this.navigationState.position)),this.state=new kG(this)}get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}get expectingExternalUI(){return ps.expectingExternalUI}set expectingExternalUI(e){ps.expectingExternalUI=e}makeUiControlVisibilityState(e){const t=this.uiConfiguration.showUIControls,r=this.uiConfiguration[e];return this.registerDisposer(fS((i,s)=>i&&s,t,r))}get inputEventMap(){return this.inputEventBindings.global}updateShowBorders(){const e=this.element,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){const e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";const t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";const r=this.registerDisposer(new Ih(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner));this.registerDisposer(new tr(this.uiControlVisibility.showLocation,r.element)),t.appendChild(r.element);const i=this.registerDisposer(new Ez(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(i.element.style.flex="1",i.element.style.alignSelf="center",this.registerDisposer(new tr(this.uiControlVisibility.showLocation,i.element)),t.appendChild(i.element),typeof NEUROGLANCER_CREDIT_LINK<"u"){let l=NEUROGLANCER_CREDIT_LINK;Array.isArray(l)||(l=[l]);for(const c of l){const u=c.url,h=c.text,g=document.createElement("a");g.style.marginRight="5px",g.href=u,g.textContent=h,g.style.fontFamily="sans-serif",g.style.color="yellow",g.target="_blank",t.appendChild(g)}}const s=this.registerDisposer(new wG(this.selectedLayer,this.toolBinder));if(t.appendChild(s.element),this.registerDisposer(new tr(this.uiControlVisibility.showAnnotationToolStatus,s.element)),Z$){const l=this.registerDisposer(new Q$(this));t.appendChild(l.element)}{const l=this.layerListPanelState,c=this.registerDisposer(new Gr(l.location.watchableVisible,{svg:B4,backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));c.element.insertAdjacentElement("afterbegin",this.registerDisposer(new Hz(this.layerManager)).element),this.registerDisposer(new tr(this.uiControlVisibility.showLayerListPanelButton,c.element)),t.appendChild(c.element)}{const l=this.selectionDetailsState,c=this.registerDisposer(new Gr(l.location.watchableVisible,{svg:F4,backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new tr(this.uiControlVisibility.showSelectionPanelButton,c.element)),t.appendChild(c.element)}{const l=this.selectedLayer,c=this.registerDisposer(new Gr({get value(){return l.visible},set value(u){l.visible=u},changed:l.location.locationChanged},{svg:Q2,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new tr(this.uiControlVisibility.showLayerSidePanelButton,c.element)),t.appendChild(c.element)}{const l=ft({text:"{}",title:"Edit JSON state"});this.registerEventListener(l,"click",()=>{this.editJsonState()}),this.registerDisposer(new tr(this.uiControlVisibility.showEditStateButton,l)),t.appendChild(l)}{const l=Zr({title:"Copy view URL to clipboard",onClick:()=>{const c=Yn(this.makeUrlFromState(this.state.toJSON()));Ke.showTemporaryMessage(c?"URL copied to clipboard":"Failed to copy URL to clipboard")}});t.appendChild(l)}{const l=this.helpPanelState,c=this.registerDisposer(new Gr(l.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new tr(this.uiControlVisibility.showHelpButton,c.element)),t.appendChild(c.element)}{const l=this.settingsPanelState,c=this.registerDisposer(new Gr(l.location.watchableVisible,{svg:_4,backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new tr(this.uiControlVisibility.showSettingsButton,c.element)),t.appendChild(c.element)}this.registerDisposer(new tr(fS((...l)=>l.reduce((c,u)=>c||u,!1),...RI.map(l=>this.uiControlVisibility[l])),t)),e.appendChild(t),this.layout=this.registerDisposer(new Mz(this,"4panel")),this.sidePanelManager=this.registerDisposer(new gU(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new jz(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new _z(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new c1(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.closeSelectionTab=()=>{for(const l of this.sidePanelManager.registeredPanels)l.panel instanceof c1&&l.panel.close()},this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new gG(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{const l=this.inputEventBindings;return new iz(this.sidePanelManager,this.helpPanelState,[["Global",l.global],["Cross section view",l.sliceView],["3-D projection view",l.perspectiveView]],this.layerManager,this.toolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new bG(this.sidePanelManager,this.settingsPanelState,this)}));const a=()=>{const l=this.visibility.visible;l!==this.visible&&(e.style.visibility=l?"inherit":"hidden",this.visible=l)};a(),this.registerDisposer(this.visibility.changed.add(a))}registerEventActionBindings(){const e=this.element;this.registerDisposer(new Nr(e,this.inputEventMap)),this.registerDisposer(new xh(e))}bindAction(e,t){this.registerDisposer(ve(this.element,e,t))}bindCallback(e,t){const r=()=>{t(this)};this.registerDisposer(ve(this.element,e,r))}registerActionListeners(){for(const e of["recolor","clear-segments"])this.bindAction(e,()=>{this.layerManager.invokeAction(e),this.closeSelectionTab&&this.closeSelectionTab()});for(const e of["select"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e)});for(const e of["copy-segment-id","add-copy-segment-id"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e,this.selectedLayer.layer)});this.bindAction("help",()=>this.toggleHelpPanel());for(let e=1;e<=9;++e)this.bindAction(`toggle-layer-${e}`,()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&t.setVisible(!t.visible)}),this.bindAction(`toggle-pick-layer-${e}`,()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(t.pickEnabled=!t.pickEnabled)}),this.bindAction(`select-layer-${e}`,()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(this.selectedLayer.layer=t,this.selectedLayer.visible=!0)});for(let e=0;e<26;++e){const t=String.fromCharCode(65+e);this.bindAction(`tool-${t}`,()=>{this.activateTool(t)})}this.bindAction("annotate",()=>{const e=this.selectedLayer.layer;if(e===void 0){Ke.showTemporaryMessage("The annotate command requires a layer to be selected.");return}const t=e.layer;if(t===null||t.tool.value===void 0){Ke.showTemporaryMessage(`The selected layer (${ie(e.name)}) does not have an active annotation tool.`);return}t.tool.value.trigger(this.mouseState)}),this.bindAction("toggle-axis-lines",()=>this.showAxisLines.toggle()),this.bindAction("toggle-scale-bar",()=>this.showScaleBar.toggle()),this.bindAction("toggle-default-annotations",()=>this.showDefaultAnnotations.toggle()),this.bindAction("toggle-show-slices",()=>this.showPerspectiveSliceViews.toggle()),this.bindAction("toggle-show-statistics",()=>this.showStatistics())}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}activateTool(e){this.toolBinder.activate(e)}editJsonState(){new rG(this)}copyJsonStateToUrl(){Yn(this.makeUrlFromState(this.state.toJSON()))}showStatistics(e=void 0){e===void 0&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){let e=this.dataContext.chunkQueueManager;e.chunkUpdateDeadline===null&&(e.chunkUpdateDeadline=Date.now()+10)}}}const pE="tool",fE="toolBindings",jf="localPosition",gE="localDimensions",mE="source",IG="transform",vE="pick";class DG{constructor(){this.callbacks=[]}defer(e){this.callbacks.push(e)}}class Wo extends K{constructor(e){super(),this.managedLayer=e,this.pick=new Ft(!0,!0),this.layersChanged=new we,this.readyStateChanged=new we,this.specificationChanged=new we,this.renderLayers=new Array,this.loadingCounter=1,this.tabs=this.registerDisposer(new y4),this.panels=new L4(this),this.tool=this.registerDisposer(new R4(this)),this.toolBinder=new A4(this),this.dataSourcesChanged=new we,this.dataSources=[],this.allowingRefresh=!1,this.localCoordinateSpaceCombiner.includeDimensionPredicate=Vk,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("source",{label:"Source",order:-100,getter:()=>new T4(this)})}get localPosition(){return this.managedLayer.localPosition}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}get type(){return this.constructor.type}initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=co,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationType=void 0,e.annotationBuffer=void 0,e.annotationIndex=void 0,e.annotationCount=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){const r=(e.localCoordinateSpace=this.localCoordinateSpace.value).rank;if(r!==0){const i=ye(t,jf,s=>it(new Float32Array(r),s,vt));i===void 0?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=i)}(e.annotationId=ye(t,"annotationId",ke))!==void 0&&(e.annotationSourceIndex=ye(t,"annotationSource",hn,0),e.annotationPartIndex=ye(t,"annotationPart",hn),e.annotationSubsource=ye(t,"annotationSubsource",ke)),e.value=t.value}displaySelectionState(e,t,r){return!1}selectionStateToJson(e,t){const r={};if(e.localPositionValid){const i=e.localPosition;i.length>0&&(r.localPosition=Te(i))}return e.annotationId!==void 0&&(r.annotationId=e.annotationId,r.annotationPart=e.annotationPartIndex,r.annotationSource=e.annotationSourceIndex,r.annotationSubsource=e.annotationSubsource),e.value!=null&&(r.value=e.value),r}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;const r=this.localPosition.value;let i=e.localPosition;i.length!==r.length?e.localPosition=r.slice():i.set(r),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;const r=t.localPosition;e.localPosition.length!==r.length?e.localPosition=r.slice():e.localPosition.set(r),e.annotationId=t.annotationId,e.annotationType=t.annotationType,e.annotationBuffer=t.annotationBuffer,e.annotationIndex=t.annotationIndex,e.annotationCount=t.annotationCount,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}get isReady(){return this.loadingCounter===0}get manager(){return this.managedLayer.manager}canAddDataSource(){return!0}addDataSource(e){const t=new YF(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){function*e(){for(const t of this.dataSources){const r=t.loadState;if(!(r===void 0||r.error!==void 0))for(const i of r.subsources)if(i.enabled)yield i;else{const s=i.activated;i.messages.clearMessages(),s!==void 0&&(s.dispose(),i.activated=void 0,r.activatedSubsourcesChanged.dispatch())}}}this.activateDataSubsources(e.call(this))}decrementLoadingCounter(){--this.loadingCounter===0&&this.readyStateChanged.dispatch()}markLoading(){const e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return++this.loadingCounter===1&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){const t=this.manager.root.coordinateSpaceCombiner.bind(e),r=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),r()}}initializationDone(){const e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,r,i){return e===void 0?[]:[zl(e,r)]}getDataSourceSpecifications(e){let t,r=X(e,mE,s=>Array.isArray(s)?s.map(a=>zl(a)):typeof s=="object"?[zl(s)]:(t=s,[]));const i=X(e,IG,O3);return r.push(...this.getLegacyDataSourceSpecifications(t,e,i,r)),r=r.filter(s=>s.url),r.length===0&&r.push(e2()),r}restoreState(e){this.tool.restoreState(e[pE]),this.toolBinder.restoreState(e[fE]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[gE]),this.localPosition.restoreState(e[jf]),this.constructor.supportsPickOption&&this.pick.restoreState(e[vE]);for(const t of this.getDataSourceSpecifications(e))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);const t=this.layersChanged;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){const t=this.renderLayers,r=this.layersChanged,i=t.indexOf(e);if(i===-1)throw new Error("Attempted to remove invalid RenderLayer");t.splice(i,1),e.layerChanged.remove(r.dispatch),e.userLayer=void 0,e.dispose(),r.dispatch()}disposed(){const e=this.layersChanged;so(this.dataSources);for(const t of this.renderLayers)t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let r,i=this.renderLayers,s=t.pickedRenderLayer;if(s!==null&&i.indexOf(s)!==-1&&(r=s.transformPickedValue(t),r=this.transformPickedValue(r),r!=null))return r;for(let a of i)if(r=a.getValueAt(e),r!=null)break;return this.transformPickedValue(r)}transformPickedValue(e){return e}toJSON(){return j({type:this.type,[mE]:PG(this.dataSources),[pE]:this.tool.toJSON(),[fE]:this.toolBinder.toJSON(),[gE]:this.localCoordinateSpace.toJSON(),[jf]:this.localPosition.toJSON(),[vE]:this.pick.toJSON()},this.panels.toJSON())}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){const r=this.manager.root.globalPosition,i=this.localPosition;e?(oS(r.value,t,e.globalToRenderLayerDimensions),oS(i.value,t,e.localToRenderLayerDimensions)):r.value.set(t),i.changed.dispatch(),r.changed.dispatch()}}Wo.supportsPickOption=!1;function PG(n){if(n.length!==0)return n.length===1?n[0].toJSON():n.map(e=>e.toJSON())}class vy extends K{constructor(e,t){super(),this.manager=t,this.localCoordinateSpace=new gv,this.localCoordinateSpaceCombiner=new bv(this.localCoordinateSpace,Ul),this.localPosition=this.registerDisposer(new Hs(this.localCoordinateSpace)),this.nonArchivedLayerIndex=-1,this.readyStateChanged=new we,this.layerChanged=new we,this.specificationChanged=new we,this.containers=new ze,this.layer_=null,this.visible=!0,this.archived=!1,this.name_=e}get layer(){return this.layer_}set layer(e){let t=this.layer_;if(t!=null&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,e!=null){const r=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{r.forEach(i=>i())},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){const e=this.layer;return e!==null&&e.isReady}get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}get supportsPickOption(){const e=this.layer;return e!==null&&e.constructor.supportsPickOption}get pickEnabled(){const e=this.layer;return e!==null&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){const t=this.layer;t!==null&&t.constructor.supportsPickOption&&(t.pick.value=e)}toJSON(){let e=this.layer;if(e===null)return;let t=e.toJSON();return t.name=this.name,this.visible||(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived){this.visible=!0,this.setArchived(!1);return}this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(e===!0){this.visible=!1,this.archived=!0;for(const t of this.manager.root.subsets){const r=t.layerManager;r.has(this)&&r.removeManagedLayer(this)}}else{for(const t of this.manager.root.subsets){const r=t.layerManager;r.has(this)||r.addManagedLayer(this.addRef())}this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}}class NI extends K{constructor(){super(),this.managedLayers=new Array,this.layerSet=new ze,this.layersChanged=new we,this.readyStateChanged=new we,this.specificationChanged=new we,this.boundPositions=new GF,this.numDirectUsers=0,this.nonArchivedLayerIndexGeneration=-1,this.renderLayerToManagedLayerMapGeneration=-1,this.renderLayerToManagedLayerMap_=new de,this.scheduleRemoveLayersWithSingleRef=this.registerCancellable(rt(()=>this.removeLayersWithSingleRef(),0)),this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}updateNonArchivedLayerIndices(){const e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(const r of this.managedLayers)r.archived||(r.nonArchivedLayerIndex=t++);for(const r of this.managedLayers)r.archived&&(r.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(const r of this.managedLayers)if(!r.archived){if(t===e)return r;++t}}get renderLayerToManagedLayerMap(){const e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e){this.renderLayerToManagedLayerMapGeneration=e,t.clear();for(const r of this.managedLayers){const i=r.layer;if(i!==null)for(const s of i.renderLayers)t.set(s,r)}}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter(r=>e(r)?!0:(this.unbindManagedLayer(r),this.layerSet.delete(r),t=!0,!1)),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){this.numDirectUsers>0||this.filter(e=>e.refCount!==1||e.archived)}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return++this.numDirectUsers===1&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{--this.numDirectUsers===0&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,O4),this.layerSet.add(e),e.containers.add(this),t===void 0&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(let e of this.managedLayers)!e.visible||!e.layer||(yield*e.layer.renderLayers)}unbindManagedLayer(e){this.updateSignalBindings(e,V4),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.dispose()}clear(){for(let e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){const t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){let t=this.managedLayers.indexOf(e);if(t===-1)throw new Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){const r=this.managedLayers.length;if(e===t||e<0||e>=r||t<0||t>=r)return;var i=this.managedLayers.splice(e,1),s=ae(i,1);let a=s[0];this.managedLayers.splice(t,0,a),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find(t=>t.name===e)}getUniqueLayerName(e){let t=e,r=0;for(;this.getLayerByName(t)!==void 0;)t=e+ ++r;return t}has(e){return this.layerSet.has(e)}get renderLayers(){let e=this;return{*[An](){for(let t of e.managedLayers)if(t.layer!==null)for(let r of t.layer.renderLayers)yield r}}}get visibleRenderLayers(){let e=this;return{*[An](){for(let t of e.managedLayers)if(!(t.layer===null||!t.visible))for(let r of t.layer.renderLayers)yield r}}}invokeAction(e,t){const r=new DG;for(let i of this.managedLayers){if(i.layer===null||!i.visible||t!==void 0&&i!==t)continue;let s=i.layer;s.handleAction(e,r);for(let a of s.renderLayers)a.handleAction(e)}for(const i of r.callbacks)i()}}class RG{constructor(){this.changed=new we,this.coordinateSpace=Pi,this.position=co,this.unsnappedPosition=co,this.active=!1,this.displayDimensions=void 0,this.pickedRenderLayer=null,this.pickedValue=new te(0,0),this.pickedOffset=0,this.pickedAnnotationLayer=void 0,this.pickedAnnotationId=void 0,this.pickedAnnotationBuffer=void 0,this.pickedAnnotationBufferBaseOffset=void 0,this.pickedAnnotationIndex=void 0,this.pickedAnnotationCount=void 0,this.pickedAnnotationType=void 0,this.forcerFunction=void 0}removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,e===void 0&&this.setActive(!1)}updateUnconditionally(){const e=this.forcerFunction;return e===void 0?!1:(e(),this.active)}setActive(e){(this.active!==e||e===!0)&&(this.active=e,this.changed.dispatch())}}class MG extends K{constructor(e,t){super(),this.layerManager=e,this.mouseState=t,this.changed=new we,this.needsUpdate=!0,this.registerDisposer(t.changed.add(()=>{this.handleChange()})),this.registerDisposer(e.layersChanged.add(()=>{this.handleLayerChange()}))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;let e=this.mouseState;const t=this.changed.count;if(e.active)for(const r of this.layerManager.managedLayers){const i=r.layer;if(r.visible&&i!==null){const s=i.selectionState;s&&(i.resetSelectionState(s),s.generation=t,i.captureSelectionState(s,e))}}}get(e){this.update();const t=e.selectionState;if(!(t&&t.generation!==this.changed.count))return t}toJSON(){this.update();const e={};for(const t of this.layerManager.managedLayers){const r=t.layer;if(r){const i=this.get(r);i!==void 0&&(e[t.name]=r.selectionStateToJson(i,!0))}}return e}}const yE=10,cm=j(j({},la),{minSize:150,row:1}),bE=j(j({},cm),{visible:!0});class AG extends K{constructor(e,t){super(),this.coordinateSpace=e,this.layerSelectedValues=t,this.changed=new we,this.history=[],this.historyIndex=0,this.location=new Ls(cm),this.pin=new dt(!0),this.registerDisposer(Di((r,i)=>{i||(this.capture(!0),r.registerDisposer(t.changed.add(r.registerCancellable(hh(()=>this.capture(!0),100,{leading:!0,trailing:!0})))))},this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}get value(){return this.value_}goBack(){const e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return this.pin.value?this.historyIndex+1<this.history.length:!1}goForward(){if(!this.pin.value)return;const e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,e!==void 0&&this.pin.value){const t=this.history;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>yE&&t.splice(0,t.length-yE),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t,r=!0,i=!0){if(r===!1&&(!this.location.visible||this.pin.value))return;const s={};e.initializeSelectionState(s),t(s)&&(i&&(this.location.visible=!0),r===!0?this.pin.value=!0:r==="toggle"&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:s}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){const e=this.value;let t;if(this.location.visible){if(t=this.location.toJSON(j(j({},bE),{visible:!ps.expectingExternalUI})),this.pin.value&&e!==void 0){const r={};for(const i of e.layers){let s=i.layer.selectionStateToJson(i.state,!1);Qt(s).length===0&&(s=void 0),r[i.layer.managedLayer.name]=s}e.position!==void 0&&(t.position=Te(e.position)),t.layers=r}}else t=this.location.toJSON(cm),t=No(t),t!==void 0&&(t.visible=!1);return t}select(e=!0){const t=this.pin;e&&(this.location.visible=!0),t.value=!t.value,t.value&&this.capture()}capture(e=!1){const t=NG(this.layerSelectedValues);e&&t===void 0||(this.value=t)}restoreState(e){if(e===void 0){this.pin.value=!0,this.value=void 0;return}if(e===null){this.pin.value=!1,this.location.visible=!0,this.value=void 0;return}ge(e),this.location.restoreState(e,j(j({},bE),{visible:!ps.expectingExternalUI}));const t=this.coordinateSpace.value,r=t.rank>0?ye(e,"position",s=>it(new Float32Array(t.rank),s,vt)):void 0,i=[];ye(e,"layers",s=>{ge(s);const a=this.layerSelectedValues.layerManager;for(const c of Ld(s)){var l=ae(c,2);const u=l[0],h=l[1],g=a.getLayerByName(u);if(g===void 0)return;const v=g.layer;if(v===null)return;ge(h);const y={};v.initializeSelectionState(y),v.selectionStateFromJson(y,h),i.push({layer:v,state:y})}}),this.pin.value=i.length>0||r!==void 0,this.value={position:r,coordinateSpace:t,layers:i}}}function NG(n){const e=n.mouseState;if(!e.active)return;const t=[];for(const r of n.layerManager.managedLayers){const i=r.layer;if(i===null)continue;const s=n.get(i);if(s===void 0)continue;const a={};i.initializeSelectionState(a),i.copySelectionState(a,s),t.push({layer:i,state:a})}return{position:e.position.slice(),coordinateSpace:e.coordinateSpace,layers:t}}class VG extends K{constructor(e){super(),this.view=e,this.messages=new Vo,this.seenGeneration=-1,this.state=void 0}}let OG=0;class BG extends K{constructor(e,t,r,i,s,a){super(),this.layerManager=e,this.renderLayerType=t,this.view=r,this.roles=i,this.layerAdded=s,this.visibility=a,this.visibleLayers_=new de,this.debouncedUpdateVisibleLayers=this.registerCancellable(rt(()=>this.updateVisibleLayers(),0)),this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(i.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach(e=>e.dispose()),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){const e=++OG,t=this.visibleLayers_,r=this.renderLayerType,i=this.layerAdded,s=this.roles;for(let l of this.layerManager.readyRenderLayers())if(l instanceof r&&s.has(l.role)){let c=l,u=t.get(c);u===void 0&&(u=new VG(this.view),u.registerDisposer(c.messages.addChild(u.messages)),u.registerDisposer(c.addRef()),u.registerDisposer(c.visibility.add(this.visibility)),t.set(c,u),i(c,u),c.attach(u)),u.seenGeneration=e}for(const l of t){var a=ae(l,2);const c=a[0],u=a[1];u.seenGeneration!==e&&(t.delete(c),u.dispose())}}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}}function VI(n,e,t,r,i){return r.registerDisposer(new BG(n,e,r,t,(s,a)=>{a.registerDisposer(s.redrawNeeded.add(()=>r.scheduleRedraw()));const l=s.backend;l&&(l.rpc.invoke(oO,{layer:l.rpcId,view:r.rpcId}),a.registerDisposer(()=>l.rpc.invoke(lO,{layer:l.rpcId,view:r.rpcId}))),r.scheduleRedraw(),a.registerDisposer(()=>r.scheduleRedraw())},r.visibility))}class FG extends K{constructor(e){super(),this.layerManager=e,this.changed=new we,this.location=new Ls(k4),this.registerDisposer(e),this.location.changed.add(()=>{var t,r;this.changed.dispatch();const i=(r=(t=this.layer)===null||t===void 0?void 0:t.layer)!==null&&r!==void 0?r:void 0;if(i!==void 0){const s=this.location.value;if(s.visible){const a=i.panels.panels[0];a.location.value!==s&&(a.location.value=s,a.location.locationChanged.dispatch())}}})}get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(e===!0&&t===void 0){const r=this.layerManager.managedLayers;r.length>0?t=this.layer=r[0]:e=!1}if(e===!0&&t!==void 0){const r=t.layer;(r===null||r.panels.panels[0].tabs.length===0)&&(e=!1)}this.visible!==e&&(this.location.visible=e,!e&&t!==void 0&&this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;const t=e.layer;t!==null&&t instanceof Ai&&(t.dataSources.some(r=>r.spec.url.length!==0)||Ho(e))}set layer(e){if(e===this.layer_)return;const t=this.layer_;if(t!==void 0&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,e!==void 0){const r=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(r);const i=e.specificationChanged.add(()=>{this.changed.dispatch()});this.existingLayerDisposer=()=>{const s=e.layer;if(s!==null){const a=s.tool.value;a!==void 0&&a.deactivate()}e.unregisterDisposer(r),i()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){const e=this.location.toJSON();return this.layer!==void 0&&(e.layer=this.layer.name),No(e)}restoreState(e){if(e===void 0){this.reset();return}ge(e),this.location.restoreState(e);const t=X(e,"layer",Ir),r=t!==void 0?this.layerManager.getLayerByName(t):void 0;r===void 0&&(this.visible=!1),this.layer=r}reset(){this.location.reset(),this.layer=void 0}}class _G extends K{constructor(e,t){super(),this.layerManager=e,this.filter=t,this.changed=new we,this.validate=rt(()=>{const r=this.layerName_;if(r!==void 0){const i=this.layerManager.getLayerByName(r);i!==void 0&&this.filter(i)?(this.layer_=i,this.changed.dispatch()):(this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch())}},0),this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add(()=>{const r=this.layer_;if(r!==void 0)if(!this.layerManager.layerSet.has(r)||!this.filter(r))this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch();else{const i=r.name;i!==this.layerName_&&(this.layerName_=i,this.changed.dispatch())}}))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){this.layer_!==e&&(e!==void 0&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch())}set layerName(e){e!==this.layerName_&&(this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate())}restoreState(e){const t=Ir(e);this.layerName=t}toJSON(){const e=this.layer_;return e!==void 0?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}}class wE extends K{constructor(e,t,r,i){super(),this.layerManager=e,this.layer=t,this.predicate=r,this.getGroup=i,this.linkedLayers_=new ze,this.changed=new we,this.linkedLayersChanged=new we,this.root_=t;const s=this;this.root={get value(){return s.root_},changed:s.changed}}get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}reset(){this.isolate()}restoreState(e){if(e===void 0)return;const t=ke(e);this.linkByName(t)}toJSON(){const e=this.root.value;if(e!==this.layer)return e.managedLayer.name}isolate(e=!0){const t=this.getGroup,r=this.layer,i=this.root_;if(i===r){const a=this.linkedLayers_;if(a.size!==0){for(const l of a){const c=t(l);c.root_=l,c.changed.dispatch()}a.clear(),this.linkedLayersChanged.dispatch()}return}const s=t(i);s.linkedLayers_.delete(r),s.linkedLayersChanged.dispatch(),this.root_=r,e&&this.changed.dispatch()}linkByName(e){const t=this.layer.managedLayer,r=this.layerManager.getLayerByName(e);if(r===void 0||r===t)return;const i=r.layer;i!==null&&this.predicate(i)&&this.linkToLayer(i)}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);const t=this.getGroup,r=t(e).root_;if(r===this.layer)return;const i=t(r);i.linkedLayers_.add(this.layer),i.linkedLayersChanged.dispatch(),this.root_=r,this.changed.dispatch()}disposed(){this.isolate(!1)}}function OI(n,e){const t=ye(e,"type",ke,"auto");n.archived=ye(e,"archived",oo,!1),n.archived?n.visible=!1:n.visible=ye(e,"visible",oo,!0);const r=Du.get(t)||Ai;return n.layer=new r(n),e}function BI(n,e){try{const t=n.layer;if(t===null)return;t.restoreState(e),t.initializationDone()}catch(t){throw Ho(n),t}}function FI(n,e){try{ge(e),OI(n,e),BI(n,e)}catch(t){throw Ho(n),t}}function UG(n,e){try{FI(n,e)}catch(t){new Ke().setErrorMessage(t instanceof Error?t.message:""+t)}}function _I(n,e,t){const r=new vy(e,n);return FI(r,t),r}class UI extends K{constructor(){super(...arguments),this.changed=new we}}class $G extends UI{constructor(e,t,r,i,s,a,l,c,u){super(),this.display=e,this.dataSourceProviderRegistry=t,this.layerManager=r,this.chunkManager=i,this.selectionState=s,this.selectedLayer=a,this.coordinateSpace=l,this.globalPosition=c,this.toolBinder=u,this.coordinateSpaceCombiner=new bv(this.coordinateSpace,R3),this.subsets=new ze,this.layerSelectedValues=this.selectionState.layerSelectedValues,this.registerDisposer(r.layersChanged.add(this.changed.dispatch)),this.registerDisposer(r.specificationChanged.add(this.changed.dispatch))}get rpc(){return this.chunkManager.rpc}get root(){return this}reset(){this.layerManager.clear()}restoreState(e){this.layerManager.clear();let t;Array.isArray(e)?t=e:(ge(e),t=Ld(e).map(([i,s])=>typeof s=="string"?{name:i,source:s}:(ge(s),j(j({},s),{name:i}))));const r=[];for(const i of t){ge(i);const s=this.layerManager.getUniqueLayerName(X(i,"name",ke)),a=new vy(s,this);try{OI(a,i),this.layerManager.addManagedLayer(a),r.push({managedLayer:a,spec:i})}catch(l){a.dispose(),new Ke().setErrorMessage(`Error creating layer ${ie(s)}: `+(l instanceof Error)?l.message:""+l)}}for(const i of r){const s=i.managedLayer,a=i.spec;try{BI(s,a)}catch(l){new Ke().setErrorMessage(`Error creating layer ${ie(name)}: `+(l instanceof Error)?l.message:""+l)}}}add(e,t){this.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){const e=[];let t=0;for(let r of this.layerManager.managedLayers){const i=r.toJSON();i!=null&&(e.push(i),++t)}if(t!==0)return e}get rootLayers(){return this.layerManager}}class $I extends UI{constructor(e){super(),this.master=e,this.changed=new we,this.layerManager=this.registerDisposer(new NI),this.registerDisposer(e);const t=this.layerManager;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){const t=this.master.layerManager,r=[];for(const i of new ze(We(e,ke))){const s=t.getLayerByName(i);if(s===void 0)throw new Error(`Undefined layer referenced in subset specification: ${ie(i)}`);s.archived||r.push(s)}this.layerManager.clear();for(const i of r)this.layerManager.addManagedLayer(i.addRef())}toJSON(){return this.layerManager.managedLayers.map(e=>e.name)}add(e,t){this.master.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}}const Du=new de,yy=new de,zI=[n=>{const e=n.volume;if(e===void 0)return;const t=yy.get(e.volumeType);if(t!==void 0)return{layerConstructor:t,priority:0}}];function jo(n,e=n.type){Du.set(e,n)}function by(n){zI.push(n)}function GI(n,e){yy.set(n,e)}function wy(n,e){const t=n.layer;if(t===null)return;const r=t.toJSON(),i=new e(n);i.restoreState(r),i.initializationDone(),n.layer=i}function WI(n,e){return e!==n.name?(e=n.manager.root.layerManager.getUniqueLayerName(e),n.name=e,n.layerChanged.dispatch(),!0):!1}function Ho(n){if(!n.wasDisposed)for(const e of n.containers)e.removeManagedLayer(n)}function um(n,e){return n===void 0?e:e===void 0?n:n.priority<e.priority?e:n}function zG(n){let e;for(const r of zI)e=um(e,r(n));const t=n.volume;if(t!==void 0){const r=yy.get(t.volumeType);r!==void 0&&(e=um(e,{layerConstructor:r,priority:0}))}return e}function jI(n){let e;for(const t of n){const r=t.subsourceEntry.subsource;e=um(e,zG(r))}return e}class Ai extends Wo{activateDataSubsources(e){var t;this.detectedLayerConstructor=(t=jI(e))===null||t===void 0?void 0:t.layerConstructor}}Ai.type="new";Ai.typeAbbreviation="new";class Sy extends Wo{activateDataSubsources(e){var t;const r=(t=jI(e))===null||t===void 0?void 0:t.layerConstructor;r!==void 0&&wy(this.managedLayer,r)}}Sy.type="auto";Sy.typeAbbreviation="auto";function HI(n,e){const t=_I(n,"new layer",{type:"new"});n.add(t),e.layer=t,e.visible=!0}jo(Ai);jo(Sy);function SE(n,e){return e=jr(e,3432918353)>>>0,e=(e<<15|e>>>17)>>>0,e=jr(e,461845907)>>>0,n^=e,n=(n<<13|n>>>19)>>>0,n=jr(n,5)+3864292196>>>0,n}function GG(n,e){return n^=e,n^=n>>>16,n=jr(n,2246822507)>>>0,n^=n>>>13,n*=3266489909,n^=n>>>16,n>>>0}function qI(n,e,t){let r=n;return r=SE(r,e),r=SE(r,t),GG(r,8)}class WG extends Oi{constructor(e,t){super(e,t),this.properties=t.properties}static encodeOptions(e){return{properties:e.properties}}}function jG(n,e,t){const r=n.length-1;for(;;){if(e=e&r,n[e]===0){n[e]=t;return}++e}}function Pu(n,e){return e<=255?new Uint8Array(n):e<=65535?new Uint16Array(n):new Uint32Array(n)}function HG(n){const e=n.length/2,t=2**(Math.ceil(Un(e))+1),r=Pu(t,e+1);for(let i=0;i<e;++i){const s=n[2*i],a=n[2*i+1];jG(r,qI(0,s,a),i+1)}return r}function qG(n,e,t,r){let i=qI(0,t,r);const s=n.length-1;for(;;){i=i&s;let a=n[i];if(a===0)return-1;if(--a,e[2*a]===t&&e[2*a+1]===r)return a;++i}}class JI{constructor(e){this.inlineProperties=e.inlineProperties}}class JG{constructor(e){var t;this.segmentPropertyMap=e;const r=e.inlineProperties;r!==void 0&&(this.inlineIdToIndex=HG(r.ids)),this.tags=r?.properties.find(i=>i.type==="tags"),this.labels=r?.properties.find(i=>i.type==="label"),this.numericalProperties=(t=r?.properties.filter(i=>i.type==="number"))!==null&&t!==void 0?t:[]}getSegmentInlineIndex(e){const t=this.inlineIdToIndex;return t===void 0?-1:qG(t,this.segmentPropertyMap.inlineProperties.ids,e.low,e.high)}getSegmentLabel(e){const t=this.getSegmentInlineIndex(e);if(t===-1)return;const r=this.labels,i=this.tags;let s="";if(r!==void 0&&(s=r.values[t]),i!==void 0){const a=i.tags;let l=i.values[t];for(let c=0,u=l.length;c<u;++c){const h=a[l.charCodeAt(c)];s.length>0&&(s+=" "),s+="#",s+=h}}if(s.length!==0)return s}}function YI(n,e,t){for(let r=0,i=t.length;r<i;++r)e[t[r]]=n[r]}function YG(n){const e=n.length;if(e===0)return!0;let t=n[0],r=n[1];for(let i=0;i<e;i+=2){const s=n[i],a=n[i+1];if((a-r||s-t)<=0)return!1;t=s,r=a}return!0}function XG(n){const e=n.ids;if(YG(e))return n;const t=e.length/2,r=Pu(t,t-1);for(let a=0;a<t;++a)r[a]=a;r.sort((a,l)=>{const c=e[a*2],u=e[a*2+1],h=e[l*2],g=e[l*2+1];return u-g||c-h});const i=new Uint32Array(t*2);for(let a=0;a<t;++a){const l=r[a];i[a*2]=e[l*2],i[a*2+1]=e[l*2+1]}const s=n.properties.map(a=>{const l=a.values,c=new l.constructor(t);for(let u=0;u<t;++u)c[u]=l[r[u]];return j(j({},a),{values:c})});return{ids:i,properties:s}}function KG(n,e,t){const r=new Array(e);return r.fill(""),YI(n.values,r,t),j(j({},n),{values:r})}function ZG(n,e,t){const r=new Float32Array(e);return r.fill(Number.NaN),YI(n.values,r,t),j(j({},n),{values:r})}function CE(n,e,t){const r=n.type;return r==="label"||r==="description"||r==="string"||r==="tags"?KG(n,e,t):ZG(n,e,t)}function QG(n,e){if(n===void 0)return e;if(e===void 0)return n;let t=0;const r=n.ids.length/2,i=e.ids.length/2,s=new Uint32Array(r),a=new Uint32Array(i),l=n.ids,c=e.ids;mN(r,i,(g,v)=>{const y=l[2*g+1],C=l[2*g],S=c[2*v+1],w=c[2*v];return y-S||C-w},g=>{s[g]=t,++t},g=>{a[g]=t,++t},(g,v)=>{s[g]=t,a[v]=t,++t});let u;if(t===r)u=l;else if(t===i)u=c;else{u=new Uint32Array(t*2);for(let g=0;g<r;++g){const v=s[g];u[2*v]=l[2*g],u[2*v+1]=l[2*g+1]}for(let g=0;g<i;++g){const v=a[g];u[2*v]=c[2*g],u[2*v+1]=c[2*g+1]}}const h=[];if(t===r)h.push(...n.properties);else for(const g of n.properties)h.push(CE(g,t,s));if(t===i)h.push(...e.properties);else for(const g of e.properties)h.push(CE(g,t,a));return{ids:u,properties:h}}function eW(n,e){return new JI({inlineProperties:QG(n.inlineProperties,e.inlineProperties)})}function tW(n){for(;;){if(n.length===0)return;if(n.length===1)return n[0];const e=[];for(let t=0,r=n.length;t<r;t+=2)t+1===r?e.push(n[t]):e.push(eW(n[t],n[t+1]));n=e}}function nW(n,e){return n.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:e.map(t=>ln(t))},()=>{const t=tW(e);if(t!==void 0)return new JG(t)})}const rW=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function iW(n,e){var t;if(e.match(rW)!==null){const g=e.split(/[\s,]+/),v=[],y=new ze;for(let C=0,S=g.length;C<S;++C){const w=g[C];if(w==="")continue;const E=new te;if(!E.tryParseString(w))continue;const k=E.toString();y.has(k)||(y.add(k),v.push(E))}return v.sort(te.compare),{ids:v}}const r={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},i=(t=n?.segmentPropertyMap.inlineProperties)===null||t===void 0?void 0:t.properties,s=n?.tags,a=s?.tags||[],l=a.map(g=>g.toLowerCase()),c=n?.labels,u=[];let h;for(let g=0;g<e.length;g=h){let v=e.indexOf(" ",g),y;if(v===-1?h=v=e.length:h=v+1,y=e.substring(g,v),y.length===0)continue;const C=(w,E)=>{const k=w.toLowerCase(),P=l.indexOf(k);if(P===-1){u.push({begin:E,end:v,message:`Invalid tag: ${w}`});return}if(w=a[P],r.includeTags.includes(w)||r.excludeTags.includes(w)){u.push({begin:E,end:v,message:`Duplicate tag: ${w}`});return}return w};if(y.startsWith("#")){const w=C(y.substring(1),g+1);w!==void 0&&r.includeTags.push(w);continue}if(y.startsWith("-#")){const w=C(y.substring(2),g+2);w!==void 0&&r.excludeTags.push(w);continue}if(y.startsWith("<")||y.startsWith(">")){let w=y.substring(1).toLowerCase();if(w!=="id"&&w!=="label"){const E=i?.find(k=>k.id.toLowerCase()===w&&(k.type==="number"||k.type==="label"||k.type==="string"));if(E===void 0){u.push({begin:g+1,end:v,message:`Invalid field: ${w}`});continue}w=E.id}if(r.sortBy.find(E=>E.fieldId===w)!==void 0){u.push({begin:g+1,end:v,message:`Duplicate sort field: ${w}`});continue}r.sortBy.push({order:y[0],fieldId:w});continue}if(y.startsWith("|")){let w=y.substring(1).toLowerCase();if(w==="id"||w==="label")continue;const E=i?.find(k=>k.id.toLowerCase()===w&&(k.type==="number"||k.type==="string"));if(E===void 0){u.push({begin:g+1,end:v,message:`Invalid field: ${w}`});continue}if(w=E.id,r.sortBy.find(k=>k.fieldId===w)||r.includeColumns.find(k=>k===w))continue;r.includeColumns.push(w);continue}if(y.startsWith("/")){if(r.regexp!==void 0){u.push({begin:g,end:v,message:"Only one regular expression allowed"});continue}if(r.prefix!==void 0){u.push({begin:g,end:v,message:"Prefix cannot be combined with regular expression"});continue}if(c===void 0){u.push({begin:g,end:v,message:"No label property"});continue}try{r.regexp=new RegExp(y.substring(1))}catch{u.push({begin:g,end:v,message:"Invalid regular expression syntax"})}continue}const S=y.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)([0-9.].*)$/);if(S!==null){let w=S[1].toLowerCase();const E=S[2],k=n?.numericalProperties.find(B=>B.id.toLowerCase()===w);if(k===void 0){u.push({begin:g,end:g+w.length,message:`Invalid numerical field: ${w}`});continue}w=k.id;let P;try{P=vd(k.dataType,S[3])}catch(B){u.push({begin:g+S[1].length+S[2].length,end:v,message:B.message});continue}let D=r.numericalConstraints.find(B=>B.fieldId===w);D===void 0&&(D={fieldId:w,bounds:k.bounds},r.numericalConstraints.push(D));const L=ql(k.bounds,D.bounds[0]),R=ql(k.bounds,D.bounds[1]);let M=R,V=L;switch(E){case"<":M=au(k.dataType,P,-1);break;case"<=":M=P;break;case"=":M=V=P;break;case">=":V=P;break;case">":V=au(k.dataType,P,1);break}if(V=cr(L,V)>0?L:V,M=cr(R,M)<0?R:M,cr(V,M)>0){u.push({begin:g,end:v,message:"Constraint would not match any values"});continue}D.bounds=[V,M];continue}if(r.regexp!==void 0){u.push({begin:g,end:v,message:"Prefix cannot be combined with regular expression"});continue}if(c===void 0){u.push({begin:g,end:v,message:"No label property"});continue}r.prefix!==void 0?r.prefix+=` ${y}`:r.prefix=y}return u.length>0?{errors:u}:(r.sortBy.length===0&&r.sortBy.push({fieldId:XI(n),order:"<"}),r)}function Hf(n){return"\\u"+n.toString(16).padStart(4,"0")}function sW(n,e){var t;if(e.errors!==void 0)return{query:e,total:-1,count:0,errors:e.errors};if(e.ids!==void 0){const L=e.ids;return{query:e,total:-1,explicitIds:L,count:L.length}}const r=(t=n?.segmentPropertyMap)===null||t===void 0?void 0:t.inlineProperties;if(r===void 0)return{query:e,count:0,total:-1};const i=r?.properties,s=r.ids.length/2;let a=Pu(s,s);for(let L=0;L<s;++L)a[L]=L;const l=L=>{let R=a.length,M=0;for(let V=0;V<R;++V){const B=a[V];L(B)&&(a[M]=B,++M)}a=a.subarray(0,M)};if(e.regexp!==void 0||e.prefix!==void 0){const L=n.labels.values,R=e.regexp,M=e.prefix;R!==void 0&&l(V=>L[V].match(R)!==null),M!==void 0&&l(V=>L[V].startsWith(M))}const c=e.includeTags,u=e.excludeTags,h=n.tags;if(c.length>0||u.length>0){const L=h.values,R=h.tags,M=[];for(const U of c)M.push([R.indexOf(U),1]);for(const U of u)M.push([R.indexOf(U),0]);M.sort((U,O)=>U[0]-O[0]);let V="^",B=0;const _=U=>{U<B||(V+=`[${Hf(B)}-${Hf(U)}]*`)};for(const U of M){var g=ae(U,2);const O=g[0],z=g[1];_(O-1),z&&(V+=Hf(O)),B=O+1}_(65535),V+="$";const H=new RegExp(V);l(U=>L[U].match(H)!==null)}let v,y;const C=e.numericalConstraints;if(C.length>0){const L=n.numericalProperties,R=C.length,M=2**R-1;v=Pu(a.length,M);for(let _=0;_<R;++_){const H=C[_],U=L.find(se=>se.id===H.fieldId).values,O=2**_;var S=ae(H.bounds,2);const z=S[0],F=S[1];for(let se=0,oe=a.length;se<oe;++se){const Re=U[a[se]];v[se]|=O*(Re>=z&&Re<=F)}}y=a,a=y.slice();let V=a.length,B=0;for(let _=0;_<V;++_)v[_]===M&&(a[B]=a[_],++B);a=a.subarray(0,B)}let w=[];if(h!==void 0){const L=[],R=h.tags,M=h.values,V=new Uint32Array(R.length);for(let B=0,_=a.length;B<_;++B){const H=M[a[B]];for(let U=0,O=H.length;U<O;++U)++V[H.charCodeAt(U)]}for(let B=0,_=R.length;B<_;++B){const H=V[B],U=R[B],O={tag:U,tagIndex:B,count:V[B]};e.includeTags.includes(U)||e.excludeTags.includes(U)?L.push(O):H>0&&w.push(O)}L.push(...w),w=L}const E=(L,R)=>{if(L.type!=="number"){const M=L.values;a.sort((V,B)=>kd(M[V],M[B])*R)}else{const M=L.values;a.sort((V,B)=>(M[V]-M[B])*R)}},k=L=>{h!==void 0&&E(h,L);const R=n?.labels;R!==void 0&&E(R,L)},P=e.sortBy;for(let L=P.length-1;L>=0;--L){var D=P[L];const R=D.fieldId,M=D.order,V=M==="<"?1:-1;if(R==="id"){if(L+1===P.length){if(M==="<")continue;a.reverse();continue}a.sort((B,_)=>V*(B-_));continue}else R==="label"?k(V):E(i.find(B=>B.id===R),V)}return{query:e,intermediateIndices:y,intermediateIndicesMask:v,indices:a,tags:w,count:a.length,total:s}}function aW(n,e,t){const r=e.values;var i=ae(t,2);const s=i[0],a=i[1],l=a<=s?0:256/(a-s),c=new Uint32Array(258),u=n.query.numericalConstraints,h=u.findIndex(g=>g.fieldId===e.id);if(h===-1){const g=n.indices;for(let v=0,y=g.length;v<y;++v){const C=r[g[v]];isNaN(C)||++c[Math.min(255,Math.max(-1,(C-s)*l))+1>>>0]}}else{const g=n.intermediateIndices,v=n.intermediateIndicesMask,y=2**u.length-1-2**h;for(let C=0,S=g.length;C<S;++C)if((v[C]&y)==y){const w=r[g[C]];isNaN(w)||++c[Math.min(255,Math.max(-1,(w-s)*l))+1>>>0]}}return{queryResult:n,histogram:c,window:t}}function oW(n,e,t,r){if(n===void 0){t.length=0,r.length=0;return}const i=n.numericalProperties,s=i.length;if(e?.indices===void 0){t.length=0;return}for(let a=0;a<s;++a){const l=t[a],c=r[a],u=i[a];l!==void 0&&l.queryResult===e&&xi(u.dataType,l.window,c)||(t[a]=aW(e,u,c))}}function XI(n){return n?.tags||n?.labels?"label":"id"}function lW(n,e){var t=e;const r=t.ids;if(r!==void 0)return r.map(g=>g.toString()).join(", ");let i="";e=e;var s=e;const a=s.prefix,l=s.regexp;a!==void 0?i=a:l!==void 0&&(i=`/${l}`);for(const g of e.includeTags)i.length>0&&(i+=" "),i+=`#${g}`;for(const g of e.excludeTags)i.length>0&&(i+=" "),i+=`-#${g}`;for(const g of e.numericalConstraints){const v=g.fieldId,y=g.bounds;var c=ae(y,2);const C=c[0],S=c[1],w=n.numericalProperties.find(E=>E.id===v);if(!xi(w.dataType,w.bounds,y)){if(cr(C,S)===0){i.length>0&&(i+=" "),i+=`${v}=${C}`;continue}if(cr(C,w.bounds[0])>0){i.length>0&&(i+=" ");const E=au(w.dataType,C,-1),k=C.toString(),P=E.toString();w.dataType!==q.FLOAT32||k.length<=P.length?i+=`${v}>=${k}`:i+=`${v}>${P}`}if(cr(S,w.bounds[1])<0){i.length>0&&(i+=" ");const E=au(w.dataType,S,1),k=S.toString(),P=E.toString();w.dataType!==q.FLOAT32||k.length<=P.length?i+=`${v}<=${k}`:i+=`${v}<${P}`}}}var u=e;let h=u.sortBy;if(h.length===1){const g=h[0];g.order==="<"&&g.fieldId===XI(n)&&(h=[])}for(const g of h)i.length>0&&(i+=" "),i+=`${g.order}${g.fieldId}`;for(const g of e.includeColumns)i.length>0&&(i+=" "),i+=`|${g}`;return i}const qf=new te;function Xc(n,e,t){if(e===void 0)return;const r=e.explicitIds;if(r!==void 0){r.forEach(t);return}const i=e.indices;if(i!==void 0){var s=n?.segmentPropertyMap.inlineProperties;const a=s.ids;for(let l=0,c=i.length;l<c;++l){const u=i[l];qf.low=a[u*2],qf.high=a[u*2+1],t(qf,l)}}}function dW(n,e,t){if(t.size===0)return 0;let r=0;return Xc(n,e,i=>{t.has(i)&&++r}),r}function xE(n,e,t,r){const i=n.includeTags.filter(a=>a!==e),s=n.excludeTags.filter(a=>a!==e);return r===!0&&(t?i:s).push(e),j(j({},n),{includeTags:i,excludeTags:s})}function cW(n){return n.ids!==void 0?!1:n.errors!==void 0?!0:!(n.numericalConstraints.length>0||n.includeTags.length>0||n.excludeTags.length>0||n.prefix||n.regexp)}function Cy(n,e){if(n===void 0||n.ids!==void 0||n.errors!==void 0)return!1;const t=n.sortBy,r=n.includeColumns;return t.find(i=>i.fieldId===e)!==void 0||r.includes(e)}const Kc=Xn("disjoint_sets:rank"),Ei=Xn("disjoint_sets:parent"),Ru=Xn("disjoint_sets:next"),Ol=Xn("disjoint_sets:prev");function Jf(n){let e=n,t=n[Ei];for(;t!==n;)n=t,t=n[Ei];for(n=e[Ei];t!==n;)e[Ei]=t,e=n,n=e[Ei];return t}function uW(n,e){let t=n[Kc],r=e[Kc];return t>r?(e[Ei]=n,n):(n[Ei]=e,t===r&&(e[Kc]=r+1),e)}function hW(n,e){let t=n[Ol],r=e[Ol];e[Ol]=t,t[Ru]=e,n[Ol]=r,r[Ru]=n}function*EE(n){let e=n;do yield e,e=e[Ru];while(e!==n)}function pW(n){n[Ei]=n,n[Kc]=0,n[Ru]=n[Ol]=n}const ja=Xn("disjoint_sets:min");function TE(n){return n[Ei]===n}class KI{constructor(){this.map=new de,this.visibleSegmentEquivalencePolicy=new dt(Dr.MIN_REPRESENTATIVE),this.generation=0}has(e){let t=e.toString();return this.map.get(t)!==void 0}get(e){let t=e.toString(),r=this.map.get(t);return r===void 0?e:Jf(r)[ja]}isMinElement(e){let t=this.get(e);return t===e||te.equal(t,e)}makeSet(e){let t=e.toString(),r=this.map,i=r.get(t);return i===void 0?(i=e.clone(),pW(i),i[ja]=i,r.set(t,i),i):Jf(i)}link(e,t){if(e=this.makeSet(e),t=this.makeSet(t),e===t)return!1;this.generation++;let r=uW(e,t);hW(e,t);let i=e[ja],s=t[ja];const a=(this.visibleSegmentEquivalencePolicy.value&Dr.MAX_REPRESENTATIVE)!==0;return r[ja]=te.less(i,s)===a?s:i,!0}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}deleteSet(e){const t=this.map;let r=!1;for(const i of this.setElements(e))t.delete(i.toString()),r=!0;return r}*setElements(e){let t=e.toString(),r=this.map.get(t);r===void 0?yield e:yield*EE(r)}clear(){let e=this.map;return e.size===0?!1:(++this.generation,e.clear(),!0)}get size(){return this.map.size}*mappings(e=new Array(2)){for(let t of this.map.values())e[0]=t,e[1]=Jf(t)[ja],yield e}*roots(){for(let e of this.map.values())TE(e)&&(yield e)}[An](){return this.mappings()}toJSON(){let e=new Array;for(let t of this.map.values())if(TE(t)){let r=new Array;for(let i of EE(t))r.push(i);r.sort(te.compare),e.push(r)}return e.sort((t,r)=>te.compare(t[0],r[0])),e.map(t=>t.map(r=>r.toString()))}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var fW=function(n,e,t,r){var i=arguments.length,s=i<3?e:r===null?r=Ar(e,t):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,r);else for(var l=n.length-1;l>=0;l--)(a=n[l])&&(s=(i<3?a(s):i>3?a(e,t,s):a(e,t))||s);return i>3&&s&&Mr(e,t,s),s},hm;const gW="DisjointUint64Sets",ZI="DisjointUint64Sets.add",QI="DisjointUint64Sets.clear",eD="DisjointUint64Sets.highBitRepresentativeChanged",tD="DisjointUint64Sets.deleteSet";let ld=hm=class extends sh{constructor(){super(...arguments),this.disjointSets=new KI,this.changed=new we}get value(){return this}static makeWithCounterpart(n,e){let t=new this;return t.disjointSets.visibleSegmentEquivalencePolicy=e,t.registerDisposer(e.changed.add(()=>{kE(t)})),t.initializeCounterpart(n),e.value&&kE(t),t}disposed(){this.disjointSets=void 0,this.changed=void 0,super.disposed()}link(n,e){if(this.disjointSets.link(n,e)){let t=this.rpc;return t&&t.invoke(ZI,{id:this.rpcId,al:n.low,ah:n.high,bl:e.low,bh:e.high}),this.changed.dispatch(),!0}return!1}linkAll(n){for(let e=1,t=n.length;e<t;++e)this.link(n[0],n[e])}has(n){return this.disjointSets.has(n)}get(n){return this.disjointSets.get(n)}clear(){if(this.disjointSets.clear()){let n=this.rpc;n&&n.invoke(QI,{id:this.rpcId}),this.changed.dispatch()}}setElements(n){return this.disjointSets.setElements(n)}deleteSet(n){if(this.disjointSets.deleteSet(n)){let e=this.rpc;e&&e.invoke(tD,{id:this.rpcId,l:n.low,h:n.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(n){if(n!==void 0){let e=[new te,new te];We(n,t=>{We(t,(r,i)=>{e[i%2].parseString(String(r),10),i!==0&&this.link(e[0],e[1])})})}}assignFrom(n){this.clear(),n instanceof hm&&(n=n.disjointSets);for(const t of n){var e=ae(t,2);const r=e[0],i=e[1];this.link(r,i)}}};ld=hm=fW([ah(gW)],ld);const io=new te,Yf=new te;Tt(ZI,function(n){let e=this.get(n.id);io.low=n.al,io.high=n.ah,Yf.low=n.bl,Yf.high=n.bh,e.disjointSets.link(io,Yf)&&e.changed.dispatch()});Tt(QI,function(n){let e=this.get(n.id);e.disjointSets.clear()&&e.changed.dispatch()});function kE(n){n.rpc.invoke(eD,{id:n.rpcId,value:n.disjointSets.visibleSegmentEquivalencePolicy.value})}Tt(eD,function(n){let e=this.get(n.id);e.disjointSets.visibleSegmentEquivalencePolicy.value=n.value});Tt(tD,function(n){let e=this.get(n.id);io.low=n.l,io.high=n.h,e.disjointSets.deleteSet(io)&&e.changed.dispatch()});class mW extends dF{constructor(){super(...arguments),this.spanningTreeEdges=new de,this.equivalences=new ld,this.connections=new ze,this.changed=new Ze}link(e,t){this.equivalences.link(e,t);for(const r of this.connections)r.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){this.equivalences.linkAll(e);for(const t of this.connections)t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){this.equivalences.deleteSet(e);for(const t of this.connections)t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(const e of this.connections)Xf(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){const r=e.toString(),i=t.toString(),s=this.spanningTreeEdges;let a=s.get(r);a===void 0&&(a=new ze,s.set(r,a));let l=s.get(i);l===void 0&&(l=new ze,s.set(i,l)),a.add(i),l.add(r)}removeSpanningTreeEdge(e,t){const r=e.toString(),i=t.toString(),s=this.spanningTreeEdges,a=s.get(r),l=s.get(i);a.delete(i),a.size===0&&s.delete(r),l.delete(r),l.size===0&&s.delete(i)}*getSpanningTreeNeighbors(e){const t=new te,r=this.spanningTreeEdges.get(e.toString());if(r!==void 0)for(const i of r)t.parseString(i),yield t}restoreState(e){const t=this.equivalences,r=this.spanningTreeEdges;if(t.clear(),r.clear(),e===void 0)return;const i=[new te,new te];We(e,s=>{We(s,(a,l)=>{i[l%2].parseString(String(a),10),l!==0&&t.link(i[0],i[1])&&this.addSpanningTreeEdge(i[0],i[1])})})}toJSON(){const e=this.spanningTreeEdges;if(e.size===0)return;const t=new Array;for(let i of e){var r=ae(i,2);let s=r[0],a=r[1];const l=te.parseString(s);for(const c of a){const u=te.parseString(c);te.compare(l,u)>0||t.push([l,u])}}return t.sort((i,s)=>te.compare(i[0],s[0])||te.compare(i[1],s[1])),t.map(i=>i.map(s=>s.toString()))}get visibleSegmentEquivalencePolicy(){return Dr.MIN_REPRESENTATIVE}async merge(e,t){const r=this.equivalences;return te.equal(r.get(e),r.get(t))?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),r.get(e))}async split(e,t){const r=this.computeSplit(e,t);if(r===void 0)throw new Error("Segments are already split");const i=r.includeBaseSegments,s=r.includeRepresentative,a=r.excludeBaseSegments,l=r.excludeRepresentative,c=this.equivalences;this.deleteSet(e),this.linkAll(i),this.linkAll(a);const u=(v,y)=>{for(const C of v)for(const S of this.getSpanningTreeNeighbors(C))te.equal(c.get(S),y)||this.removeSpanningTreeEdge(C,S)},h=c.get(e),g=c.get(t);u(i,h),u(a,g);for(const v of this.connections){const y=v.segmentsState.visibleSegments;y.has(l)&&(y.delete(l),y.add(s))}return this.normalizeAll(),this.changed.dispatch(),{include:h,exclude:g}}trackSegment(e,t){return()=>{}}computeSplit(e,t){const r=this.equivalences,i=r.get(e);if(!te.equal(i,r.get(t)))return;const s=new KI;for(const g of r.setElements(i))if(!te.equal(g,t))for(const v of this.getSpanningTreeNeighbors(g))te.equal(v,t)||s.link(g,v);const a=[],l=[],c=s.get(e);let u=e,h=t;for(const g of r.setElements(i))te.equal(s.get(g),c)?(a.push(g),te.compare(g,u)<0&&(u=g)):(l.push(g),te.compare(g,h)<0&&(h=g));return a.sort(te.compare),l.sort(te.compare),{includeBaseSegments:a,includeRepresentative:u,excludeBaseSegments:l,excludeRepresentative:h}}connect(e){const t=new vW(this,e);return e.segmentEquivalences.assignFrom(this.equivalences),Xf(e.visibleSegments,e.segmentEquivalences.disjointSets),t.registerDisposer(e.visibleSegments.changed.add(t.registerCancellable(rt(()=>Xf(e.visibleSegments,e.segmentEquivalences.disjointSets),0)))),this.connections.add(t),t.registerDisposer(()=>{this.connections.delete(t)}),t}}function Xf(n,e){const t=[];for(const r of n.unsafeKeys()){const i=e.get(r);te.equal(r,i)||(t.push(i),n.delete(r))}for(const r of t)n.add(r)}class vW extends cF{computeSplit(e,t){return this.graph.computeSplit(e,t)}}var gn;(function(n){n[n.UNKNOWN=0]="UNKNOWN",n[n.IMAGE=1]="IMAGE",n[n.SEGMENTATION=2]="SEGMENTATION"})(gn||(gn={}));function LE(n){const e=n.rank,t=n.dataType,r=n.compressedSegmentationBlockSize;var i=n.baseVoxelOffset;const s=i===void 0?new Float32Array(e):i;return j(j({},Cd(n)),{compressedSegmentationBlockSize:r,baseVoxelOffset:s,dataType:t})}function yW(n){if(n.compressedSegmentationBlockSize!==void 0||n.volumeType!==gn.SEGMENTATION&&!n.volumeSourceOptions.discreteValues)return!1;switch(n.dataType){case q.UINT32:case q.UINT64:break;default:return!1}switch(n.rank){case 3:return!0;case 4:return n.chunkDataSize[3]===1;default:return!1}}function bW(n){let e=n.rank,t=n.lowerVoxelBound,r=n.upperVoxelBound;if(!yW(n))return LE(n);var i=n.volumeSourceOptions;let s=i.displayRank,a=i.multiscaleToViewTransform,l=n.chunkToMultiscaleTransform,c=n.chunkToViewTransform;c===void 0&&(c=rh(new Float32Array(e*s),s,a,s,l,e+1,s,e,e));const u=n.maxCompressedSegmentationBlockSize,h=n.chunkDataSize;return LE(j(j({},n),{compressedSegmentationBlockSize:Float32Array.from(gu({rank:e,chunkToViewTransform:c,displayRank:s,lowerVoxelBound:t,upperVoxelBound:r,maxVoxelsPerChunkLog2:9,maxBlockSize:u===void 0?h:y3(new Uint32Array(e),h,u)}))}))}function $d(n){const e=n.rank;var t=n.volumeSourceOptions;const r=t.displayRank,i=t.multiscaleToViewTransform,s=t.modelChannelDimensionIndices,a=n.chunkToMultiscaleTransform,l=rh(new Float32Array(r*e),r,i,r,a,e+1,r,e,e);let c=n.minBlockSize;c===void 0?(c=new Uint32Array(e),c.fill(1)):c=new Uint32Array(c);const u=n.lowerVoxelBound,h=n.upperVoxelBound;if(s.length!==0)for(const v of nh(a,e,s)){let y=h[v];u!==void 0&&(y-=u[v]),c[v]=y}var g=n.chunkDataSizes;return(g===void 0?zB(j(j({},n),{minBlockSize:c,chunkToViewTransform:l,displayRank:r})):g).map(v=>bW(j(j({},n),{chunkDataSize:v,chunkToViewTransform:l})))}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const wW=Ne(),SW=Ne(),IE=.001,CW=.001;function xW(n){let e=0;for(var t=0;t<3;++t)n[t]<0&&(e+=1<<t);return e}const nD=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),EW=(()=>{const n=[0,1,2,4,5,3,6,7],e=[0,1,2,5,3,4,6,7],t=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],r=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],i=new Int32Array(384);for(let s=0;s<8;++s)for(let a=0;a<t.length;++a){const l=e[s]*8+t[a];i[s*8*6+a]=n[r[l]]}return i})();function Mu(n){n.addUniform("highp vec3","uPlaneNormal"),n.addUniform("highp float","uPlaneDistance"),n.addUniform("highp ivec2","uVertexIndex",24),n.addUniform("highp vec3","uVertexBasePosition",8),n.addInitializer(e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),nD)}),n.addVertexCode(`
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {
  for (int e = 0; e < 4; ++e) {
    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];
    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));
    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));
    highp vec3 vDir = v2 - v1;
    highp float denom = dot(vDir, uPlaneNormal);
    if (abs(denom) > ${CW}) {
      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;
      if ((lambda >= -${IE}) && (lambda <= (1.0 + ${IE}))) {
        lambda = clamp(lambda, 0.0, 1.0);
        highp vec3 position = v1 + lambda * vDir;
        return position;
      }
    }
  }
  return vec3(0, 0, 0);
}
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {
  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);
}
`)}function TW(n,e,t){const r=n.gl;r.uniform3fv(n.uniform("uPlaneNormal"),e),r.uniform1f(n.uniform("uPlaneDistance"),t);const i=xW(e);r.uniform2iv(n.uniform("uVertexIndex"),EW.subarray(i*48,(i+1)*48))}function xy(n,e,t,r,i){const s=ok(wW,e,r);eu(s,s);const a=iv(ar(SW,t,i),s);TW(n,s,a)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const kW=.001,LW=Je();function IW(n,e){if(Mi(n),Mu(n),n.addUniform("highp vec3","uTranslation"),n.addUniform("highp mat4","uProjectionMatrix"),n.addUniform("highp vec3","uChunkDataSize"),n.addUniform("highp vec3","uLowerClipBound"),n.addUniform("highp vec3","uUpperClipBound"),e){ti(n),n.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${us};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`),n.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()));
`);return}n.addVarying("highp vec3","vChunkPosition"),n.setVertexMain(`
vec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);
gl_Position = uProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
vChunkPosition = (position - uTranslation) +
    ${kW} * abs(uPlaneNormal);
`)}function DW(n,e,t){t&&ri(n,e,1)}function PW(n,e,t,r,i,s){const a=t.projectionParameters.value,l=a.centerDataPosition;xy(e,a.viewportNormalInGlobalCoordinates,l,s.transform,s.invTransform),n.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,en(LW,r,s.transform)),n.uniform3fv(e.uniform("uLowerClipBound"),i.lowerClipDisplayBound),n.uniform3fv(e.uniform("uUpperClipBound"),i.upperClipDisplayBound)}function RW(n,e,t){n.uniform3fv(e.uniform("uChunkDataSize"),t)}function MW(n,e,t,r){n.uniform3fv(e.uniform("uTranslation"),t),r?ni(e.gl,6,1):n.drawArrays(n.TRIANGLE_FAN,0,6)}function AW(n,e,t){return n>e?t>n?n:e>t?e:t:t>e?e:n>t?n:t}class rD extends _v{constructor(e,t){var r=t.shaderError;const i=r===void 0?lh():r,s=t.shaderParameters;super(e.chunkManager,e,t);const a=this.gl;this.vertexIdHelper=this.registerDisposer(ii.get(a)),this.shaderParameters=s;const l=t.channelCoordinateSpace;this.channelCoordinateSpace=l===void 0?Zs(Pi):l,this.registerDisposer(s.changed.add(this.redrawNeeded.dispatch));const c=this.registerDisposer(dr((u,h)=>({numChannelDimensions:u.rank,dataHistogramChannelSpecifications:h}),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=Tv(this,a,{memoizeKey:`volume/RenderLayer:${ln(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:s,encodeParameters:t.encodeShaderParameters,shaderError:i,extraParameters:c,defineShader:(u,h,g,v)=>{const y=h.chunkFormat,C=h.dataHistogramsEnabled,S=v.dataHistogramChannelSpecifications,w=v.numChannelDimensions;if(IW(u,y===null),u.addOutputBuffer("vec4","v4f_fragData0",0),u.addFragmentCode(`
void emit(vec4 color) {
  v4f_fragData0 = color;
}
`),y===null)return;z2(u,y,w,"vChunkPosition");const E=S.length;if(C&&E>0){let k="";const P=y.dataType;for(let D=0;D<E;++D){const L=S[D].channel,R=`out_histogram${D}`;u.addOutputBuffer("vec4",R,1+D);const M=`getDataValue(${L.join(",")})`,V=`invlerpForHistogram${D}`;u.addFragmentCode(LL(u,V,P,!1)),u.addFragmentCode(`
float getHistogramValue${D}() {
  return invlerpForHistogram${D}(${M});
}
`),k+=`{
float x = getHistogramValue${D}();
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
${R} = vec4(x, x, x, 1.0);
}`}u.addFragmentCode(`void userMain();
void main() {
  ${k}
  userMain();
}
#define main userMain
`)}this.defineShader(u,g)},getContextKey:u=>{var h;return`${(h=u.chunkFormat)===null||h===void 0?void 0:h.shaderKey}/${u.dataHistogramsEnabled}`}}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){let t=this.tempChunkPosition;for(const r of this.visibleSourcesList){const i=r.source,s=r.chunkTransform;if(!Yl(t,e,this.localPosition.value,s.layerRank,s.combinedGlobalLocalToChunkTransform))continue;const a=i.getValueAt(t,s);if(a!=null)return a}return null}beginChunkFormat(e,t,r){const i=this.gl,s=this.dataHistogramSpecifications.visibility.visible,a=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:s}),l=a.shader,c=a.parameters,u=a.fallback;if(l!==null&&(l.bind(),DW(l,r,t===null),t!==null)){if(s){const h=a.extraParameters.dataHistogramChannelSpecifications.length,g=this.dataHistogramSpecifications.bounds.value;for(let v=0;v<h;++v)Rv(l,`invlerpForHistogram${v}`,t.dataType,g[v])}this.initializeShader(e,l,c,u),t.beginDrawing(i,l)}return a}endSlice(e,t,r){}draw(e){const t=e.sliceView,r=t.visibleLayers.get(this).visibleSources;if(r.length===0)return;const i=e.projectionParameters,s=e.wireFrame,a=this.gl;this.vertexIdHelper.enable();const l=Ne(),c=this.renderScaleHistogram;c!==void 0&&c.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let u,h=null,g;const v=Ne(),y=()=>{h!==null&&(g!==null&&g.endDrawing(a,h),this.endSlice(t,h,u.parameters))};let C=!0;for(const S of r){const w=Ov(i,S.chunkLayout),E=S.chunkTransform.channelToChunkDimensionIndices,k=S.source,P=S.fixedPositionWithinChunk,D=S.chunkDisplayDimensionIndices;for(const U of D)P[U]=0;const L=s?null:k.chunkFormat;if(L!==g&&(g=L,y(),u=this.beginChunkFormat(t,L,i),h=u.shader),h===null)continue;const R=k.chunks;v.fill(1);let M=w.size,V;const B=k.spec.rank;PW(a,h,t,i.viewProjectionMat,S,w),L!==null&&L.beginSource(a,h),C=!0;let _=0,H=0;if(t.forEachVisibleChunk(S,w,U=>{let O=R.get(U);if(O&&O.state===pt.GPU_MEMORY){let z=O.chunkDataSize;if(z!==V){V=z;for(let se=0;se<3;++se){const oe=D[se];v[se]=oe===-1||oe>=B?1:V[oe]}RW(a,h,v)}const F=O.chunkGridPosition;for(let se=0;se<3;++se){const oe=D[se];l[se]=oe===-1||oe>=B?0:M[se]*F[oe]}L!==null&&L.bindChunk(a,h,O,P,D,E,C),C=!1,MW(a,h,l,s),++_}else++H}),(_!==0||H!==0)&&c!==void 0){const U=S.effectiveVoxelSize,O=AW(U[0],U[1],U[2]);c.add(O,O/i.pixelSize,_,H)}}if(y(),this.vertexIdHelper.disable(),!e.wireFrame){const S=this.getDataHistogramCount();S>0&&t.computeHistograms(S,this.dataHistogramSpecifications)}}}class DE{constructor(e){this.disjointSets=e,this.generation=Number.NaN,this.hashMap=new jv}update(){let e=this.disjointSets;const t=e.generation;if(this.generation!==t){this.generation=t;let i=this.hashMap;i.clear();for(let s of e.mappings()){var r=ae(s,2);let a=r[0],l=r[1];i.set(a,l)}}}}class Kf extends rD{constructor(e,t){super(e,{shaderParameters:new XT(r=>({hasEquivalences:r.registerDisposer(dr(i=>i.size!==0,[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:r.registerDisposer(dr(i=>i.size!==0,[t.segmentStatedColors])),hasSegmentDefaultColor:r.registerDisposer(dr(i=>i!==void 0,[t.segmentDefaultColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring})),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition}),this.displayState=t,this.segmentationGroupState=this.displayState.segmentationGroupState.value,this.segmentColorShaderManager=new J_("segmentColorHash"),this.segmentStatedColorShaderManager=new Y_("segmentStatedColor"),this.hashTableManager=new y2("visibleSegments"),this.gpuHashTable=this.registerDisposer(Rl.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable)),this.gpuTemporaryHashTable=Rl.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable),this.equivalencesShaderManager=new b2("equivalences"),this.equivalencesHashMap=new DE(this.segmentationGroupState.segmentEquivalences.disjointSets),this.temporaryEquivalencesHashMap=new DE(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets),this.gpuEquivalencesHashTable=this.registerDisposer(Rl.get(this.gl,this.equivalencesHashMap.hashMap)),this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(Rl.get(this.gl,this.temporaryEquivalencesHashMap.hashMap)),this.registerDisposer(this.shaderParameters),R2(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){var e;(e=this.gpuSegmentStatedColorHashTable)===null||e===void 0||e.dispose()}getSources(e){return this.multiscaleSource.getSources(j(j({},e),{discreteValues:!0}))}defineShader(e,t){this.hashTableManager.defineShader(e);let r=`
uint64_t getUint64DataValue() {
  uint64_t x = toUint64(getDataValue());
`;r+=`return x;
}
`,e.addFragmentCode(r),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  uint64_t mappedValue;
  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {
    return mappedValue;
  }
  return value;
}
`)):e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  return value;
}
`),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uShowAllSegments"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let i=`
  uint64_t baseValue = getUint64DataValue();
  uint64_t value = getMappedObjectId(baseValue);
  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};

  float alpha = uSelectedAlpha;
  float saturation = uSaturation;
`;t.hideSegmentZero&&(i+=`
  if (value.value[0] == 0u && value.value[1] == 0u) {
    emit(vec4(vec4(0, 0, 0, 0)));
    return;
  }
`),i+=`
  bool has = uShowAllSegments != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);
  if (uSelectedSegment == value.value) {
    float adjustment = has ? 0.5 : 0.75;
    if (saturation > adjustment) {
      saturation -= adjustment;
    } else {
      saturation += adjustment;
    }
  } else if (!has) {
    alpha = uNotSelectedAlpha;
  }
`;let s=`vec3 getMappedIdColor(uint64_t value) {
`;t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),s+=`
  vec3 rgb;
  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgb)) {
    return rgb;
  }
`),t.hasSegmentDefaultColor?(e.addUniform("highp vec3","uSegmentDefaultColor"),s+=`  return uSegmentDefaultColor;
`):(this.segmentColorShaderManager.defineShader(e),s+=`  return segmentColorHash(value);
`),s+=`
}
`,e.addFragmentCode(s),i+=`
  vec3 rgb = getMappedIdColor(valueForColor);
  emit(vec4(mix(vec3(1.0,1.0,1.0), rgb, saturation), alpha));
`,e.setFragmentMain(i)}initializeShader(e,t,r){const i=this.gl,s=this.displayState,a=this.segmentationGroupState,l=this.displayState.segmentSelectionState;var c=this.displayState;const u=c.segmentDefaultColor.value,h=c.segmentColorHash.value,g=_L(a),v=this.displayState.ignoreNullVisibleSet.value;let y=0,C=0;if(l.hasSelectedSegment){let S=l.selectedSegment;y=S.low,C=S.high}if(i.uniform1f(t.uniform("uSelectedAlpha"),s.selectedAlpha.value),i.uniform1f(t.uniform("uSaturation"),s.saturation.value),i.uniform1f(t.uniform("uNotSelectedAlpha"),s.notSelectedAlpha.value),i.uniform2ui(t.uniform("uSelectedSegment"),y,C),i.uniform1ui(t.uniform("uShowAllSegments"),g.hashTable.size||!v?0:1),this.hashTableManager.enable(i,t,a.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),r.hasEquivalences){const S=a.useTemporarySegmentEquivalences.value;(S?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(i,t,S?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}if(u===void 0?this.segmentColorShaderManager.enable(i,t,h):i.uniform3fv(t.uniform("uSegmentDefaultColor"),u),r.hasSegmentStatedColors){const S=this.displayState.segmentStatedColors.value;let w=this.gpuSegmentStatedColorHashTable;(w===void 0||w.hashTable!==S.hashTable)&&(w?.dispose(),this.gpuSegmentStatedColorHashTable=w=Rl.get(i,S.hashTable)),this.segmentStatedColorShaderManager.enable(i,t,w)}}endSlice(e,t,r){const i=this.gl;this.hashTableManager.disable(i,t),r.hasEquivalences&&this.equivalencesShaderManager.disable(i,t),r.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(i,t),super.endSlice(e,t,r)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Bl(n=.5){return new Jt(n,vk)}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ey=12,iD=8,NW=6,VW=`
vec3 getBoxFaceVertexPosition(int vertexIndex) {
  const vec3 vertexPositions[] = vec3[](
  // Front face
  vec3(0.0, 0.0,  1.0), // 0
  vec3(1.0, 0.0,  1.0), // 1
  vec3(1.0,  1.0,  1.0), // 2
  vec3(0.0,  1.0,  1.0), // 3

  // Back face
  vec3(0.0, 0.0, 0.0), // 4
  vec3(0.0,  1.0, 0.0), // 5
  vec3(1.0,  1.0, 0.0), // 6
  vec3(1.0, 0.0, 0.0), // 7

  // Top face
  vec3(0.0,  1.0, 0.0), // 8
  vec3(0.0,  1.0,  1.0), // 9
  vec3(1.0,  1.0,  1.0), // 10
  vec3(1.0,  1.0, 0.0), // 11

  // Bottom face
  vec3(0.0, 0.0, 0.0), // 12
  vec3( 1.0, 0.0, 0.0), // 13
  vec3( 1.0, 0.0,  1.0), // 14
  vec3(0.0, 0.0,  1.0), // 15

  // Right face
  vec3( 1.0, 0.0, 0.0), // 16
  vec3( 1.0,  1.0, 0.0), // 17
  vec3( 1.0,  1.0,  1.0), // 18
  vec3( 1.0, 0.0,  1.0), // 19

  // Left face
  vec3(0.0, 0.0, 0.0), // 20
  vec3(0.0, 0.0,  1.0), // 21
  vec3(0.0,  1.0,  1.0), // 22
  vec3(0.0,  1.0, 0.0) // 23
  );
  const int indices[] = int[](
    0,  1,  2,      0,  2,  3,    // front
    4,  5,  6,      4,  6,  7,    // back
    8,  9,  10,     8,  10, 11,   // top
    12, 13, 14,     12, 14, 15,   // bottom
    16, 17, 18,     16, 18, 19,   // right
    20, 21, 22,     20, 22, 23   // left
  );
  return vertexPositions[indices[vertexIndex]];
}
`;function OW(n,e,t){n.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*NW*e,t)}const BW=0,Ty=BW+1,Fn=Ty+iD,FW=Fn+Ey,_W=FW+6,UW=Float32Array.from([0,0,0,0,0,1,Fn+0,1,0,0,1,0,1,Fn+1,0,1,0,0,1,1,Fn+2,1,1,0,1,1,1,Fn+3,0,0,0,0,1,0,Fn+4,0,0,1,0,1,1,Fn+5,1,0,0,1,1,0,Fn+6,1,0,1,1,1,1,Fn+7,0,0,0,1,0,0,Fn+8,0,0,1,1,0,1,Fn+9,0,1,0,1,1,0,Fn+10,0,1,1,1,1,1,Fn+11]),PE=Je(),ss=new Float32Array(6);let sD=class extends xd{constructor(){super(...arguments),this.vertexIdHelper=this.registerDisposer(ii.get(this.gl))}defineShader(n){Mi(n);const e=this.rank;wd(n,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",e,2),n.addUniform("vec3","uModelSpaceBoundOffsets",2)}enable(n,e,t){fs(PE,e.modelViewProjectionMatrix),ZN(PE,ss);const r=e.chunkDisplayTransform.numChunkDisplayDims;for(let i=0;i<r;++i)ss[i]=0,ss[i+3]=0;for(let i=r;i<3;++i){const s=Math.abs(ss[i+3]-ss[i]);ss[i]-=s,ss[i+3]+=s}super.enable(n,e,i=>{const s=i.vertexShaderInputBinders.Bounds;s.enable(1);const a=this.gl;a.uniform3fv(i.uniform("uModelSpaceBoundOffsets"),ss),a.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer),s.bind(this.geometryDataStride,e.bufferOffset);const l=this.vertexIdHelper;l.enable(),t(i),l.disable(),s.disable()})}};function aD(n){n.addVertexCode(`
void setBoundingBoxBorderWidth(float width) {}
void setBoundingBoxBorderColor(vec4 color) {}
`)}function oD(n){n.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {}
`)}function pm(n){oD(n),n.addVertexCode(`
float ng_lineWidth;
void setBoundingBoxBorderWidth(float size) {
  ng_lineWidth = size;
}
void setBoundingBoxBorderColor(vec4 color) {
  vColor = color;
}
`)}function $W(n){aD(n),n.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {
  vColor = color;
}
`)}class zW extends sD{constructor(){super(...arguments),this.edgeBoxCornerOffsetsBuffer=this.registerDisposer($n.fromData(this.gl,og(UW,7,1,us))),this.edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",e=>{const t=this.rank;this.defineShader(e),ti(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),pm(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);
vec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(endpointA, 1.0),
         uModelViewProjection * vec4(endpointB, 1.0),
         ng_lineWidth);
${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));
`)}),this.boxCornerOffsetsBuffer=this.registerDisposer($n.fromData(this.gl,og(nD,3,1,oy))),this.cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",e=>{const t=this.rank;this.defineShader(e),Nd(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),pm(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);
emitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);
uint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);
uint cornerPickOffset = ${Ty}u + cornerIndex;
${this.setPartIndex(e,"cornerPickOffset")};
`),e.setFragmentMain(`
vec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);
vec4 color = getCircleColor(vColor, borderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}drawEdges(e){const t=this.gl;this.enable(this.edgeShaderGetter,e,r=>{const i=r.attribute("aBoxCornerOffset1"),s=r.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1,28,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(s,4,WebGL2RenderingContext.FLOAT,!1,28,12),ri(r,e.renderContext.projectionParameters,1),ni(t,Ey,e.count),t.disableVertexAttribArray(i),t.disableVertexAttribArray(s)})}drawCorners(e){const t=this.gl;this.enable(this.cornerShaderGetter,e,r=>{const i=r.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1),Vd(r,e.renderContext.projectionParameters,{featherWidthInPixels:0}),Od(r.gl,iD,e.count),t.disableVertexAttribArray(i)})}draw(e){this.drawEdges(e),this.drawCorners(e)}}let GW=class extends sD{constructor(){super(...arguments),this.faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",n=>{const e=this.rank;super.defineShader(n),Mu(n),ti(n),n.addVarying("highp float","vClipCoefficient"),pm(n),n.setVertexMain(`
float modelPositionA[${e}] = getBounds0();
float modelPositionB[${e}] = getBounds1();
for (int i = 0; i < ${e}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex1 = gl_VertexID / ${us};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),
         uModelViewProjection * vec4(vertexPosition2, 1.0),
         ng_lineWidth);
${this.setPartIndex(n)};
`),n.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));
`)}),this.fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",n=>{const e=this.rank;super.defineShader(n),Mu(n),n.addVarying("highp float","vClipCoefficient"),$W(n),n.setVertexMain(`
float modelPositionA[${e}] = getBounds0();
float modelPositionB[${e}] = getBounds1();
for (int i = 0; i < ${e}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex = gl_VertexID;
vec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);
gl_Position = uModelViewProjection * vec4(vertexPosition, 1);
${this.invokeUserMain}
${this.setPartIndex(n)};
`),n.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)})}enableForBoundingBox(n,e,t){super.enable(n,e,r=>{const i=e.renderContext.sliceView.projectionParameters.value;xy(r,i.viewportNormalInGlobalCoordinates,i.centerDataPosition,e.renderSubspaceModelMatrix,e.renderSubspaceInvModelMatrix),t(r)})}draw(n){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,n,()=>{UO(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,6,n.count)}),this.enableForBoundingBox(this.faceShaderGetter,n,e=>{ri(e,n.renderContext.projectionParameters,1),ni(e.gl,6,n.count)})}};function WW(n,e){const t=n.length;for(let r=0;r<t;++r){const i=e[r],s=e[r+t],a=n[r];n[r]=Math.abs(i-a)<Math.abs(s-a)?i:s}}Ed(Pe.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:GW,perspectiveViewRenderHelper:zW,defineShaderNoOpSetters(n){oD(n),aD(n)},pickIdsPerInstance:_W,snapPosition(n,e,t,r){const i=n.length,s=new Float32Array(e,t,i*2);r>=Ty&&r<Fn&&WW(n,s)},getRepresentativePoint(n,e,t){n.set(e.pointA)},updateViaRepresentativePoint(n,e,t){const r=e.length,i=n.pointA,s=n.pointB,a=new Float32Array(r),l=new Float32Array(r);for(let c=0;c<r;++c){const u=a[c]=e[c];l[c]=s[c]+(u-i[c])}return j(j({},n),{pointA:a,pointB:l})}});const qa=0,fm=qa+1,jW=fm+2;function lD(n){n.addVertexCode(`
void setEndpointMarkerSize(float startSize, float endSize) {}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
`)}function dD(n){n.addVertexCode(`
void setLineWidth(float width) {}
void setLineColor(vec4 startColor, vec4 endColor) {}
`)}let RE=class extends xd{constructor(){super(...arguments),this.vertexIdHelper=this.registerDisposer(ii.get(this.gl)),this.edgeShaderGetter=this.getDependentShader("annotation/line/edge",n=>{const e=this.rank;this.defineShader(n),ti(n),n.addVarying(`highp float[${e}]`,"vModelPosition"),n.addVertexCode(`
float ng_LineWidth;
`),lD(n),n.addVertexCode(`
void setLineWidth(float width) {
  ng_LineWidth = width;
}
void setLineColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),n.setVertexMain(`
float modelPositionA[${e}] = getVertexPosition0();
float modelPositionB[${e}] = getVertexPosition1();
for (int i = 0; i < ${e}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(n)};
`),n.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)}),this.endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",n=>{const e=this.rank;this.defineShader(n),Nd(n,this.targetIsSliceView),n.addVarying("highp float","vClipCoefficient"),n.addVarying("highp vec4","vBorderColor"),dD(n),n.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${oy};
}
void setEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),n.setVertexMain(`
float modelPosition[${e}] = getVertexPosition0();
float modelPositionB[${e}] = getVertexPosition1();
for (int i = 0; i < ${e}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(n,"uint(getEndpointIndex()) + 1u")};
`),n.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}defineShader(n){Mi(n);const e=this.rank;wd(n,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",e,2)}enable(n,e,t){super.enable(n,e,r=>{const i=r.vertexShaderInputBinders.VertexPosition;i.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer),i.bind(this.geometryDataStride,e.bufferOffset);const s=this.vertexIdHelper;s.enable(),t(r),s.disable(),i.disable()})}drawEdges(n){this.enable(this.edgeShaderGetter,n,e=>{ri(e,n.renderContext.projectionParameters,1),ni(e.gl,1,n.count)})}drawEndpoints(n){this.enable(this.endpointShaderGetter,n,e=>{Vd(e,n.renderContext.projectionParameters,{featherWidthInPixels:.5}),Od(e.gl,2,n.count)})}draw(n){this.drawEdges(n),this.drawEndpoints(n)}};function HW(n,e){const t=n.length;lk(n,e.subarray(0,t),e.subarray(t),n)}function qW(n,e,t){const r=n.length,i=r*t;for(let s=0;s<r;++s)n[s]=e[i+s]}Ed(Pe.LINE,{sliceViewRenderHelper:RE,perspectiveViewRenderHelper:RE,defineShaderNoOpSetters(n){lD(n),dD(n)},pickIdsPerInstance:jW,snapPosition(n,e,t,r){const i=n.length,s=new Float32Array(e,t,i*2);r===qa?HW(n,s):qW(n,s,r-fm)},getRepresentativePoint(n,e,t){n.set(t===qa||t===fm?e.pointA:e.pointB)},updateViaRepresentativePoint(n,e,t){let r=j({},n);const i=e.length;switch(t){case qa:{const s=n.pointA,a=n.pointB,l=new Float32Array(i),c=new Float32Array(i);for(let u=0;u<i;++u){const h=l[u]=e[u];c[u]=a[u]+(h-s[u])}return j(j({},n),{pointA:l,pointB:c})}case qa+1:return j(j({},n),{pointA:new Float32Array(e)});case qa+2:return j(j({},n),{pointB:new Float32Array(e)})}return r}});let ME=class extends xd{constructor(){super(...arguments),this.shaderGetter3d=this.getDependentShader("annotation/point:3d",n=>{Mi(n),Nd(n,this.targetIsSliceView),this.defineShaderCommon(n),n.addVertexMain(`
emitCircle(uModelViewProjection *
           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
`),n.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
emitAnnotation(color);
`)}),this.makeShaderGetter2d=n=>this.getDependentShader(`annotation/point:2d:${n}`,e=>{Mi(e),ti(e,!0),this.defineShaderCommon(e),e.addVertexMain(`
vec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);
vec3 subspacePositionB = subspacePositionA;
vec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);
vec4 zCoeffs = uModelViewProjection[${n}];
float minZ = 1e30;
float maxZ = -1e30;
for (int i = 0; i < 3; ++i) {
  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1
  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];
  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;
  if (k1 != 0.0) {
    minZ = min(minZ, q1);
    maxZ = max(maxZ, q1);
  }
  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2
  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];
  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;
  if (k2 != 0.0) {
    minZ = min(minZ, q2);
    maxZ = max(maxZ, q2);
  }
}
if (minZ > maxZ) minZ = maxZ = 0.0;
subspacePositionA[${n}] = minZ;
subspacePositionB[${n}] = maxZ;
emitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);
`),e.setFragmentMain(`
vec4 color = getRoundedLineColor(vColor, vBorderColor);
emitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));
`)}),this.shaderGetter2d=this.makeShaderGetter2d(2),this.shaderGetter1d=this.makeShaderGetter2d(1),this.vertexIdHelper=this.registerDisposer(ii.get(this.gl))}defineShaderCommon(n){const e=this.rank;wd(n,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",e),n.addVarying("highp vec4","vBorderColor"),n.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
void setPointMarkerSize(float size) {
  ng_markerDiameter = size;
}
void setPointMarkerBorderWidth(float size) {
  ng_markerBorderWidth = size;
}
void setPointMarkerColor(vec4 color) {
  vColor = color;
}
void setPointMarkerBorderColor(vec4 color) {
  vBorderColor = color;
}
`),n.addVertexMain(`
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
float modelPosition[${e}] = getVertexPosition0();
float clipCoefficient = getSubspaceClipCoefficient(modelPosition);
if (clipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
${this.invokeUserMain}
vColor.a *= clipCoefficient;
vBorderColor.a *= clipCoefficient;
${this.setPartIndex(n)};
`)}enable(n,e,t){super.enable(n,e,r=>{const i=r.vertexShaderInputBinders.VertexPosition;i.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer),i.bind(this.geometryDataStride,e.bufferOffset);const s=this.vertexIdHelper;s.enable(),t(r),s.disable(),i.disable()})}draw(n){const e=n.chunkDisplayTransform.numChunkDisplayDims;switch(e){case 3:this.enable(this.shaderGetter3d,n,t=>{Vd(t,n.renderContext.projectionParameters,{featherWidthInPixels:1}),Od(t.gl,1,n.count)});break;case 2:case 1:this.enable(e===2?this.shaderGetter2d:this.shaderGetter1d,n,t=>{ri(t,n.renderContext.projectionParameters,1),ni(t.gl,1,n.count)});break}}};Ed(Pe.POINT,{sliceViewRenderHelper:ME,perspectiveViewRenderHelper:ME,defineShaderNoOpSetters(n){n.addVertexCode(`
void setPointMarkerSize(float size) {}
void setPointMarkerBorderWidth(float size) {}
void setPointMarkerColor(vec4 color) {}
void setPointMarkerBorderColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition(n,e,t){n.set(new Float32Array(e,t,n.length))},getRepresentativePoint(n,e){n.set(e.point)},updateViaRepresentativePoint(n,e){return j(j({},n),{point:new Float32Array(e)})}});/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cD=`
struct EllipseQuadraticForm {
  highp float A;  // x*x coefficient
  highp float B;  // x*y coefficient
  highp float C;  // y*y coefficient
  highp float D;  // x coefficient
  highp float E;  // y coefficient
  highp float F;  // 1 coefficient
};
`,JW=[cD,`
EllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {
  EllipseQuadraticForm p;
  p.A = A[0][0];
  p.B = A[0][1] + A[1][0];
  p.C = A[1][1];
  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +
        c[2] * (A[0][2] + A[2][0]);
  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +
        c[2] * (A[1][2] + A[2][1]);
  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -
        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -
        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;
  return p;
}
`],YW=`
struct CenterOrientEllipse {
  vec2 k;   // center
  vec2 u1;  // minor axis direction
  vec2 u2;  // major axis direction
  float a;  // semimajor axis
  float b;  // semiminor axis
  bool valid; // indicates if the ellipse is valid
};
`,XW=[cD,YW,`
CenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {
  CenterOrientEllipse r;
  float a11 = p.A;
  float a12 = p.B / 2.0;
  float a22 = p.C;
  float b1 = p.D;
  float b2 = p.E;
  float c = p.F;
  float kdenom = 2.0 * (a12 * a12 - a11 * a22);
  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;
  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;
  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);
  float m11 = mu * a11;
  float m12 = mu * a12;
  float m22 = mu * a22;
  float lambdaTerm1 = m11 + m22;
  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);
  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);
  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);
  r.a = 1.0 / sqrt(lambda1);
  r.b = 1.0 / sqrt(lambda2);
  r.valid = lambda1 > 0.0 && lambda2 > 0.0;
  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {
    r.u1 = vec2(1.0, 0.0);
  } else if (m11 >= m22) {
    r.u1 = normalize(vec2(lambda1 - m22, m12));
  } else {
    r.u1 = normalize(vec2(m12, lambda1 - m11));
  }
  r.u2 = vec2(-r.u1.y, r.u1.x);
  return r;
}
`],AE=Je();let uD=class extends xd{defineShader(n){const e=this.rank;wd(n,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",e,2),n.addVertexCode(`
struct SubspaceParams {
  highp vec3 subspaceCenter;
  highp vec3 subspaceRadii;
  highp float clipCoefficient;
  bool cull;
};
SubspaceParams getSubspaceParams() {
  SubspaceParams params;
  highp float modelCenter[${e}] = getCenterAndRadii0();
  highp float modelRadii[${e}] = getCenterAndRadii1();
  float radiusAdjustment = 1.0;
  float clipCoefficient = 1.0;
  for (int i = 0; i < ${e}; ++i) {
    float r = modelRadii[i];
    float c = modelCenter[i];
    float x = uModelClipBounds[i];
    float clipRadius = uModelClipBounds[i + ${e}];
    if (r != 0.0 && clipRadius != 0.0) {
      float d = c - x;
      d = d * d;
      radiusAdjustment -= d / (r * r);
    }
    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;
    clipCoefficient *= max(0.0, 1.0 - e);
  }
  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));
  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);
  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;
  params.clipCoefficient = clipCoefficient;
  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;
  return params;
}
void setEllipsoidFillColor(vec4 color) {
  vColor = color;
}
`)}enable(n,e,t){super.enable(n,e,r=>{const i=r.vertexShaderInputBinders.CenterAndRadii;i.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer),i.bind(this.geometryDataStride,e.bufferOffset),t(r),i.disable()})}};class KW extends uD{constructor(){super(...arguments),this.sphereRenderHelper=this.registerDisposer(new _2(this.gl,10,10)),this.shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
${this.invokeUserMain}
emitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));
`)}),this.tempLightVec=new Float32Array(4)}draw(e){this.enable(this.shaderGetter,e,t=>{const r=t.gl;let i=this.tempLightVec;var s=e.renderContext;let a=s.lightDirection,l=s.ambientLighting,c=s.directionalLighting;rv(i,a,c),i[3]=l,r.uniform4fv(t.uniform("uLightDirection"),i),r.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,nv(Je(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)})}}class ZW extends uD{constructor(){super(...arguments),this.shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",e=>{Mi(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(JW),e.addVertexCode(XW),e.addVertexCode(sy),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
mat3 Aobject = mat3(0.0);
for (int i = 0; i < 3; ++i) {
  float r = max(params.subspaceRadii[i], 1e-3);
  Aobject[i][i] = 1.0 / (r * r);
}
mat3 RviewportToObject = mat3(uViewportToObject);
mat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;
vec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;
EllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);
vec2 u1, u2;
float a, b;
CenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);
vec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
vec2 viewportCorner = centerOrient.k +
  centerOrient.u1 * cornerOffset.x * centerOrient.a +
  centerOrient.u2 * cornerOffset.y * centerOrient.b;
if (centerOrient.valid) {
  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);
} else {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
}
vCircleCoord = cornerOffset;
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
if (dot(vCircleCoord, vCircleCoord) > 1.0) {
  discard;
}
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)}),this.vertexIdHelper=this.registerDisposer(ii.get(this.gl))}draw(e){this.enable(this.shaderGetter,e,t=>{const r=t.gl,i=e.renderContext.sliceView.projectionParameters.value,s=en(AE,e.renderSubspaceInvModelMatrix,i.invViewMatrix);r.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,s),r.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,i.projectionMat);const a=AE;fs(a,s),r.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,a);const l=this.vertexIdHelper;l.enable(),ay(r,1,e.count),l.disable()})}}Ed(Pe.ELLIPSOID,{sliceViewRenderHelper:ZW,perspectiveViewRenderHelper:KW,defineShaderNoOpSetters(n){n.addVertexCode(`
void setEllipsoidFillColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(n,e){n.set(e.center)},updateViaRepresentativePoint(n,e){return j(j({},n),{center:new Float32Array(e)})}});const Ja=0,gm=Ja+1,QW=gm+2;function mm(n){n.addVertexCode(`
 void setAxisEndpointMarkerSize(float startSize, float endSize) {}
 void setAxisEndpointMarkerBorderWidth(float startSize, float endSize) {}
 void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
 void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
 `)}function vm(n){n.addVertexCode(`
 void setAxisWidth(float width) {}
 void setAxisColor(vec4 startColor, vec4 endColor) {}
 `)}function ym(n){n.addVertexCode(`
 void setSphereColor(vec4 color) {}
 `)}class NE extends xd{constructor(){super(...arguments),this.sphereShader=this.registerDisposer(new $U(this.gl)),this.vertexIdHelper=this.registerDisposer(ii.get(this.gl)),this.edgeShaderGetter=this.getDependentShader("annotation/sphere/axis",e=>{const t=this.rank;this.defineShader(e),ti(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),mm(e),ym(e),e.addVertexCode(`
void setAxisWidth(float width) {
  ng_LineWidth = width;
}
void setAxisColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)}),this.endpointShaderGetter=this.getDependentShader("annotation/sphere/endpoint",e=>{const t=this.rank;this.defineShader(e),Nd(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),vm(e),ym(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${oy};
}
void setAxisEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setAxisEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)}),this.sphereShadeGetter=this.getDependentShader("annotation/sphere/sphere",e=>{const t=this.rank;this.defineShader(e),this.sphereShader.defineShader(e),e.addVarying("highp float","vClipCoefficient"),vm(e),mm(e),e.addVertexCode(`
 void setSphereColor(vec4 color) {
   vColor = color;
 }
 `),e.setVertexMain(`
 float modelPosition[${t}] = getVertexPosition0();
 float modelPositionB[${t}] = getVertexPosition1();
 float diameter = 0.0;
 for (int i = 0; i < ${t}; ++i) {
   float dx = modelPosition[i] - modelPositionB[i];
   diameter += dx * dx;
   modelPosition[i] = (modelPosition[i] + modelPositionB[i]) * 0.5;
 }
 float radius = sqrt(diameter) * 0.5;
 if (radius > 0.0) {
   vClipCoefficient = getRadiusAdjustment(vec3(modelPosition[0], modelPosition[1], modelPosition[2]), radius);
 } else {
   vClipCoefficient = 1.0;
 }

 // vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
 vColor = vec4(1.0, 0.0, 0.0, 0.5);
 // vColor = vec4(defaultColor(), 0.5);
 ${this.invokeUserMain}
 // float radius = diameter * 0.5;
 emitSphere(uModelViewProjection, uNormalTransform, projectModelVectorToSubspace(modelPosition), vec3(radius, radius, radius), uLightDirection);
 ${this.setPartIndex(e)};
 `),e.setFragmentMain(`
     vec4 color = vColor;
     color.a *= vClipCoefficient;
     emitAnnotation(color);
 `)})}defineShader(e){Mi(e);const t=this.rank;wd(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,r,i=!0){super.enable(e,t,s=>{const a=s.vertexShaderInputBinders.VertexPosition;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.serializedBytesPerAnnotation,t.bufferOffset);const l=this.vertexIdHelper;i&&l.enable(),r(s),i&&l.disable(),a.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{ri(t,e.renderContext.projectionParameters,1),ni(t.gl,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{Vd(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),Od(t.gl,2,e.count)})}drawSphere(e){this.enable(this.sphereShadeGetter,e,t=>{this.sphereShader.draw(t,e,e.count)},!1)}draw(e){this.drawEdges(e),this.drawEndpoints(e),this.drawSphere(e)}}function e6(n,e){const t=n.length;lk(n,e.subarray(0,t),e.subarray(t),n)}function t6(n,e,t){const r=n.length,i=r*t;for(let s=0;s<r;++s)n[s]=e[i+s]}Ed(Pe.SPHERE,{sliceViewRenderHelper:NE,perspectiveViewRenderHelper:NE,defineShaderNoOpSetters(n){mm(n),vm(n),ym(n)},pickIdsPerInstance:QW,snapPosition(n,e,t,r){const i=n.length,s=new Float32Array(e,t,i*2);r===Ja?e6(n,s):t6(n,s,r-gm)},getRepresentativePoint(n,e,t){n.set(t===Ja||t===gm?e.pointA:e.pointB)},updateViaRepresentativePoint(n,e,t){let r=j({},n);const i=e.length;switch(t){case Ja:{const s=n.pointA,a=n.pointB,l=new Float32Array(i),c=new Float32Array(i);for(let u=0;u<i;++u){const h=l[u]=e[u];c[u]=a[u]+(h-s[u])}return j(j({},n),{pointA:l,pointB:c})}case Ja+1:return j(j({},n),{pointA:new Float32Array(e)});case Ja+2:return j(j({},n),{pointB:new Float32Array(e)})}return r}});/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const hD=Je(),pD=Ne();function fD(n){n.addUniform("highp vec3","uTranslation"),n.addUniform("highp mat4","uProjectionMatrix"),n.addUniform("highp vec3","uChunkDataSize"),n.addUniform("highp vec3","uLowerClipBound"),n.addUniform("highp vec3","uUpperClipBound"),n.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);
`)}const n6={defineShader(n){fD(n),ti(n),n.addVertexCode(`
const vec3[24] boxCornerOffsets = vec3[](
  vec3(0, 0, 0), vec3(0, 0, 1),  // e1
  vec3(1, 0, 0), vec3(1, 0, 1),  // e2
  vec3(0, 1, 0), vec3(0, 1, 1),  // e3
  vec3(1, 1, 0), vec3(1, 1, 1),  // e4
  vec3(0, 0, 0), vec3(0, 1, 0),  // e5
  vec3(0, 0, 1), vec3(0, 1, 1),  // e6
  vec3(1, 0, 0), vec3(1, 1, 0),  // e7
  vec3(1, 0, 1), vec3(1, 1, 1),  // e8
  vec3(0, 0, 0), vec3(1, 0, 0),  // e9
  vec3(0, 0, 1), vec3(1, 0, 1),  // e10
  vec3(0, 1, 0), vec3(1, 1, 0),  // e11
  vec3(0, 1, 1), vec3(1, 1, 1)  // e12
);
`),n.setVertexMain(`
int edgeIndex = gl_VertexID / ${us};
vec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));
vec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));
vec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);
vec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(n,e){ri(n,e,1)},draw(n,e,t){const r=n.gl,i=hD,s=e.chunkLayout;en(i,t.viewProjectionMat,s.transform),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,i),r.uniform3fv(n.uniform("uChunkDataSize"),s.size),r.uniform3fv(n.uniform("uLowerClipBound"),e.lowerClipDisplayBound),r.uniform3fv(n.uniform("uUpperClipBound"),e.upperClipDisplayBound);const a=s.size,l=e.curPositionInChunks,c=e.chunkDisplayDimensionIndices,u=pD;for(let h=0;h<3;++h){const g=c[h];u[h]=(g===-1?0:l[g])*a[h]}r.uniform3fv(n.uniform("uTranslation"),u),ni(r,Ey,1)}},r6={defineShader(n){Mu(n),fD(n),ti(n),n.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${us};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(n,e){ri(n,e,1)},draw(n,e,t){const r=n.gl,i=hD,s=e.chunkLayout;en(i,t.viewProjectionMat,s.transform),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,i),r.uniform3fv(n.uniform("uChunkDataSize"),s.size),r.uniform3fv(n.uniform("uLowerClipBound"),e.lowerClipDisplayBound),r.uniform3fv(n.uniform("uUpperClipBound"),e.upperClipDisplayBound);const a=s.size,l=e.curPositionInChunks,c=e.chunkDisplayDimensionIndices,u=pD;for(let h=0;h<3;++h){const g=c[h];u[h]=(g===-1?0:l[g])*a[h]}r.uniform3fv(n.uniform("uTranslation"),u),xy(n,t.viewportNormalInGlobalCoordinates,t.centerDataPosition,s.transform,s.invTransform),ni(r,6,1)}};/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var i6=function(n,e,t,r){var i=arguments.length,s=i<3?e:r===null?r=Ar(e,t):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,r);else for(var l=n.length-1;l>=0;l--)(a=n[l])&&(s=(i<3?a(s):i>3?a(e,t,s):a(e,t))||s);return i>3&&s&&Mr(e,t,s),s};const s6=Je();function a6(n){if(n!==void 0)return e=>{const t=e.relatedSegments;if(t===void 0)return!1;for(let i=0,s=t.length;i<s;++i){const a=n[i];if(a==null)continue;var r=a.segmentationGroupState.value;const l=r.visibleSegments,c=r.segmentEquivalences;for(const u of t[i])if(l.has(c.get(u)))return!0}return!1}}function o6(n,e){const t=new s3(n.annotationPropertySerializers);for(const r of n)(e===void 0||e(r))&&t.add(r);return t.serialize()}let bm=class extends oh(Td){constructor(n,e,t,r){super(r),this.chunkManager=n,this.source=e,this.segmentationStates=t,this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:e.rpcId,segmentationStates:this.serializeDisplayState()});const i=()=>{const s={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke(sF,s)};this.registerDisposer(t.changed.add(i))}serializeDisplayState(){const n=this.segmentationStates.value;if(n!==void 0)return n.map(e=>e==null?e:N2(e.segmentationGroupState.value))}};bm=i6([hr(iF)],bm);class l6 extends K{constructor(e,t){super(),this.chunkManager=e,this.state=t,this.layerChunkProgressInfo=new wv,this.numPickIds=0,this.generation=-1,this.redrawNeeded=new we,this.serializedAnnotations=void 0,this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()},this.segmentationStates=this.registerDisposer(dr(i=>{var s=this.state;const a=s.displayState,l=s.source,c=a.relationshipStates;return a.displayUnfiltered.value?void 0:l.relationships.map(u=>{const h=c.get(u);return h.showMatches.value?h.segmentationState.value:void 0})},[this.state.displayState.relationshipStates],(i,s)=>i===void 0||s===void 0?i===s:Oe(i,s))),this.registerDisposer(t),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer(Di((i,s)=>{if(this.handleChangeAffectingBuffer(),s!==void 0)for(const a of s)a!=null&&i.registerDisposer(ao((l,c)=>{l.registerDisposer(c.visibleSegments.changed.add(()=>this.handleChangeAffectingBuffer())),l.registerDisposer(c.segmentEquivalences.changed.add(()=>this.handleChangeAffectingBuffer()))},a.segmentationGroupState))},this.segmentationStates)),this.source instanceof lo||(this.sharedObject=this.registerDisposer(new bm(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));const r=this.state.displayState;this.registerDisposer(r.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}get visibility(){const e=this.sharedObject;if(e!==void 0)return e.visibility}get gl(){return this.chunkManager.gl}updateBuffer(){const e=this.source;if(e instanceof lo){const t=e.changed.count;if(this.generation!==t){let r=this.buffer;r===void 0&&(r=this.buffer=this.registerDisposer(new $n(this.chunkManager.gl))),this.generation=t;const i=this.serializedAnnotations=o6(e,a6(this.segmentationStates.value));r.setData(this.serializedAnnotations.data),this.numPickIds=HL(i)}}}}function gD(n){const e=n.chunkTransform.modelTransform.unpaddedRank,t=new Float32Array(e*2),r=new Float32Array(e*3);r.fill(0),t.fill(1,e);const i=n.numChunkDisplayDims,s=n.chunkDisplayDimensionIndices;for(let a=0;a<i;++a){const l=s[a];t[e+l]=0,r[l*3+a]=1}return{modelClipBounds:t,renderSubspaceTransform:r}}function VE(n,e,t){t.clearMessages();const r=u=>{t.addMessage({severity:Kr.error,message:u})};if(n.error!==void 0)return r(n.error);const i=Gk(n.modelTransform,e.displayDimensionIndices);let s;try{s=Wk(n,i)}catch(u){return r(u.message)}var a=gD(s);const l=a.modelClipBounds,c=a.renderSubspaceTransform;return{chunkTransform:n,chunkDisplayTransform:s,modelClipBounds:l,renderSubspaceTransform:c}}function ky(n,e){class t extends n{constructor(i,s){super(),this.base=i,this.renderScaleHistogram=s,this.curRank=-1,this.renderHelpers=[],this.isAnnotation=!0;const a=i.visibility;a!==void 0&&this.registerDisposer(a.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer(()=>{for(const l of this.renderHelpers)l.dispose()}),this.role=i.state.role,this.registerDisposer(i.redrawNeeded.add(this.redrawNeeded.dispatch)),this.handleRankChanged()}handleRankChanged(){const i=this.base.source.rank;if(i===this.curRank)return;this.curRank=i,this.tempChunkPosition=new Float32Array(i);const s=this.renderHelpers,a=this.gl;for(const u of s)u.dispose();const l=this.base.source.properties,c=this.base.state.displayState;for(const u of Li){const h=$l(u),g=h[e],v=s[u]=new g(a,u,i,l,c.shaderControls,c.fallbackShaderControls,c.shaderError);v.pickIdsPerInstance=h.pickIdsPerInstance,v.targetIsSliceView=e==="sliceViewRenderHelper"}}attach(i){super.attach(i),this.handleRankChanged();const s=this.chunkTransform,a=i.view.displayDimensionRenderInfo.value;i.state={chunkTransform:s,displayDimensionRenderInfo:a,chunkRenderParameters:VE(s,a,i.messages)}}updateAttachmentState(i){const s=i.state;this.handleRankChanged();const a=this.chunkTransform,l=i.view.displayDimensionRenderInfo.value;return s!==void 0&&s.chunkTransform===a&&s.displayDimensionRenderInfo===l?s.chunkRenderParameters:(s.chunkTransform=a,s.displayDimensionRenderInfo=l,s.chunkRenderParameters=VE(a,l,i.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(i,s){const a=s.modelClipBounds,l=this.curRank,c=s.chunkTransform;Yl(a.subarray(0,l),i.projectionParameters.globalPosition,this.base.state.localPosition.value,c.layerRank,c.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(i,s,a,l=1){if(!i.bufferValid){let c=i.buffer;c===void 0&&(c=i.buffer=new $n(this.gl));const u=i.serializedAnnotations;c.setData(u.data),i.numPickIds=HL(u),i.bufferValid=!0}this.drawGeometry(i,s,a,l)}drawGeometry(i,s,a,l=1){const c=this.base,u=a.chunkDisplayTransform,h=i.serializedAnnotations,g=h.typeToIdMaps,v=h.typeToOffset;let y=0;s.emitPickID&&(y=s.pickIDs.register(this,i.numPickIds,0,0,i));const C=c.hoverState.value,S=en(s6,s.projectionParameters.viewProjectionMat,u.displaySubspaceModelMatrix),w={annotationLayer:c,renderContext:s,selectedIndex:0,basePickId:y,buffer:i.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:S,modelClipBounds:a.modelClipBounds,subspaceMatrix:a.renderSubspaceTransform,renderSubspaceModelMatrix:u.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:u.displaySubspaceInvModelMatrix,chunkDisplayTransform:u};for(const E of Li){const k=g[E];let P=k.size;if(P>0){const D=$l(E);let L=4294967295;if(C!==void 0){const R=k.get(C.id);R!==void 0&&(L=R*D.pickIdsPerInstance)}P=Math.round(P*l),w.count=P,w.bufferOffset=v[E],w.selectedIndex=L,this.renderHelpers[E].draw(w),w.basePickId+=P*D.pickIdsPerInstance}}}updateMouseState(i,s,a,l){const c=l.serializedAnnotations,u=c.typeToIds,h=c.typeToOffset,g=this.curRank,v=this.chunkTransform;if(v.error===void 0)for(const y of Li){const C=u[y],S=$l(y),w=S.pickIdsPerInstance;if(a<C.length*w){const E=Math.floor(a/w),k=C[E],P=a%w;i.pickedAnnotationId=k,i.pickedAnnotationLayer=this.base.state,i.pickedOffset=P,i.pickedAnnotationBuffer=c.data.buffer,i.pickedAnnotationType=y,i.pickedAnnotationBufferBaseOffset=c.data.byteOffset+h[y],i.pickedAnnotationIndex=E,i.pickedAnnotationCount=C.length;const D=this.tempChunkPosition,L=v.chunkToLayerTransform,R=v.combinedGlobalLocalToChunkTransform,M=v.layerRank,V=v.modelTransform.globalToRenderLayerDimensions,B=i.position;if(!Yl(D,B,this.base.state.localPosition.value,M,R))return;const _=this.base.source.annotationPropertySerializers[y];S.snapPosition(D,i.pickedAnnotationBuffer,i.pickedAnnotationBufferBaseOffset+i.pickedAnnotationIndex*_.propertyGroupBytes[0],P);const H=V.length;for(let U=0;U<H;++U){const O=V[U];if(O===-1)continue;let z=L[(g+1)*g+O];for(let F=0;F<g;++F)z+=D[F]*L[F*(M+1)+O];gt(z)&&(B[U]=z)}return}a-=C.length*w}}transformPickedValue(i){const s=i.pickedAnnotationBuffer;if(s===void 0)return;const a=this.base.source.properties;if(a.length===0)return;const l=i.pickedAnnotationBufferBaseOffset,c=i.pickedAnnotationType,u=i.pickedAnnotationIndex,h=i.pickedAnnotationCount,g=this.base.source.annotationPropertySerializers,v=new Array(a.length);return g[c].deserialize(new DataView(s),l,u,h,Jn.LITTLE===pd,v),qV(a[0],v[0])}isReady(){const i=this.base.source;if(!(i instanceof Pr))return!0;const s=this.base.segmentationStates.value;if(s===void 0)return!0;for(let a=0,l=s.length;a<l;++a){const c=s[a];if(c===null)return!1;if(c===void 0)continue;const u=i.segmentFilteredSources[a].chunks;let h=!1;if(Bo(c.segmentationGroupState.value,g=>{const v=Jr(g);u.has(v)||(h=!0)}),h)return!1}return!0}}return t}const mD=n=>class extends n{constructor(){super(...arguments),this.layerChunkProgressInfo=this.base.layerChunkProgressInfo}draw(e,t){const r=this.updateAttachmentState(t);if(this.curRank===0||r===void 0)return;this.updateModelClipBounds(e,r);const i=this.base.source;if(i instanceof lo){const s=this.base;s.updateBuffer(),this.drawGeometry(s,e,r)}else{const s=this.renderScaleHistogram;s.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(i.temporary.data,e,r);const a=this.base.segmentationStates.value;let l=0,c=0;if(a!==void 0)for(let u=0,h=a.length;u<h;++u){const g=a[u];if(g==null)continue;const v=i.segmentFilteredSources[u].chunks;Bo(g.segmentationGroupState.value,y=>{const C=Jr(y),S=v.get(C);if(S!==void 0&&S.state===pt.GPU_MEMORY){const w=S.data;if(w===void 0)return;this.drawGeometryChunkData(w,e,r),++l}else++c})}s.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,l,c)}}},vD=ky(Uo,"perspectiveViewRenderHelper");class d6 extends mD(vD){}const yD=n=>{class e extends n{constructor(r){super(r.annotationLayer,r.renderScaleHistogram),this.wireFrameRenderHelper=this instanceof yo?r6:n6,this.wireFrameShaderGetter=ho(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof yo}`,parameters:Zs(void 0),defineShader:a=>{this.wireFrameRenderHelper.defineShader(a)}}),this.renderScaleTarget=r.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));const i=this.registerDisposer(new Td(this.layerChunkProgressInfo)),s=this.base.chunkManager.rpc;i.RPC_TYPE_ID=nF,i.initializeCounterpart(s,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(mn.makeFromExisting(s,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(mn.makeFromExisting(s,this.renderScaleTarget)).rpcId}),this.backend=i}attach(r){super.attach(r),r.state.sources=r.registerDisposer(Di((i,s,a)=>{const l=$v(a,s,c=>this.base.state.source.getSources(c),r.messages,this);for(const c of l)for(const u of c)i.registerDisposer(u.source),j(u,gD(u.chunkDisplayTransform));return r.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(rF,{layer:this.backend.rpcId,view:r.view.rpcId,displayDimensionRenderInfo:a,sources:Uv(l)}),this.redrawNeeded.dispatch(),l},this.base.state.transform,r.view.displayDimensionRenderInfo))}draw(r,i){const s=this.updateAttachmentState(i);if(this.curRank===0||s===void 0)return;const a=i.state.sources.value;if(a.length===0)return;this.updateModelClipBounds(r,s);const l=this.renderScaleHistogram;l.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);const c=r.projectionParameters;let u;if(r.wireFrame){var h=this.wireFrameShaderGetter(r.emitter);const g=h.shader;if(g===null)return;g.bind(),this.wireFrameRenderHelper.initialize(g,c),u=g}oF(c,this.base.state.localPosition.value,this.renderScaleTarget.value,a[0],()=>{},(g,v,y,C,S)=>{const w=g.source.chunks.get(g.curPositionInChunks.join());let E;if(w===void 0||w.state!==pt.GPU_MEMORY)E=0;else{const k=w.data;if(k===void 0)return;u!==void 0?this.wireFrameRenderHelper.draw(u,g,c):this.drawGeometryChunkData(k,r,s,y),E=1}l.add(C,S,E,1-E)})}}return e},c6=yD(vD),u6=yD(ky(yo,"sliceViewRenderHelper")),h6=mD(ky(yo,"sliceViewRenderHelper"));class p6 extends K{constructor(){super(...arguments),this.changed=new we,this.isLoadingChanged=new we,this.states=[],this.relationships=[],this.loadingCount=0}get value(){return this.states}get isLoading(){return this.loadingCount!==0}markLoading(){return this.loadingCount++,()=>{--this.loadingCount===0&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort((e,t)=>{let r=e.sourceIndex-t.sourceIndex;return r!==0?r:e.subsourceIndex-t.subsourceIndex})}updateRelationships(){const e=new ze;for(const t of this.states)for(const r of t.source.relationships)e.add(r);this.relationships=Te(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{const t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}}function f6(n,e){switch(e.type){case Pe.AXIS_ALIGNED_BOUNDING_BOX:case Pe.LINE:case Pe.SPHERE:Lk(n,e.pointA,e.pointB),v3(n,n,.5);break;case Pe.POINT:n.set(e.point);break;case Pe.ELLIPSOID:n.set(e.center);break}}function bD(n,e,t){e.error===void 0&&n.setLayerPosition(e.modelTransform,t)}function wD(n,e,t){const r=e.layerRank,i=new Float32Array(r);Dn[n.type].visitGeometry(n,(s,a)=>{i.set(s);const l=new Float32Array(r);(a?xk:Ti)(l,e.chunkToLayerTransform,r+1,i,r),t(l,a)})}class g6 extends Fi{constructor(e,t){super(),this.layer=e,this.displayState=t,this.previousSelectedState=void 0,this.previousHoverId=void 0,this.previousHoverAnnotationLayerState=void 0,this.virtualListSource={length:0,render:y=>this.render(y),changed:new Ze},this.virtualList=new ly({source:this.virtualListSource}),this.listElements=[],this.updated=!1,this.mutableControls=document.createElement("div"),this.headerRow=document.createElement("div"),this.attachedAnnotationStates=new de,this.forceUpdateView=()=>{this.updated=!1,this.updateView()},this.globalDimensionIndices=[],this.localDimensionIndices=[],this.curCoordinateSpaceGeneration=-1,this.prevCoordinateSpaceGeneration=-1,this.columnWidths=[],this.gridTemplate="",this.selectedAnnotationState=Hr((y,C)=>{var S;if(y===void 0)return;const w=this.layer,E=(S=y.layers.find(D=>D.layer===w))===null||S===void 0?void 0:S.state;if(E===void 0)return;const k=E.annotationId;if(k===void 0)return;const P=this.annotationStates.states.find(D=>D.sourceIndex===E.annotationSourceIndex&&(E.annotationSubsource===void 0||D.subsourceId===E.annotationSubsource));if(P!==void 0)return{annotationId:k,annotationLayerState:P,pin:C}},this.layer.manager.root.selectionState,this.layer.manager.root.selectionState.pin),this.element.classList.add("neuroglancer-annotation-layer-view"),this.registerDisposer(this.visibility.changed.add(()=>this.updateView())),this.registerDisposer(e.annotationStates.changed.add(()=>this.updateAttachedAnnotationLayerStates())),this.headerRow.classList.add("neuroglancer-annotation-list-header");const r=document.createElement("div");r.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this);const i=this.registerDisposer(new my(this.displayState.color));i.element.title="Change annotation display color",this.registerDisposer(new tr(Hr(y=>y.match(/\bdefaultColor\b/)!==null,t.shaderControls.processedFragmentMain),i.element)),r.appendChild(i.element);const s=this.mutableControls,a=ft({text:Dn[Pe.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new LD(this.layer,{})}});s.appendChild(a);const l=ft({text:Dn[Pe.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new Iy(this.layer,{})}});s.appendChild(l);const c=ft({text:Dn[Pe.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new Dy(this.layer,{})}});s.appendChild(c);const u=ft({text:Dn[Pe.SPHERE].icon,title:"Annotate Sphere",onClick:()=>{this.layer.tool.value=new Py(this.layer,{})}});s.appendChild(u);const h=ft({text:Dn[Pe.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new DD(this.layer,{})}});s.appendChild(h),r.appendChild(s),this.element.appendChild(r),this.element.appendChild(this.headerRow);const g=this.virtualList;g.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(g.element),this.virtualList.element.addEventListener("mouseleave",()=>{this.displayState.hoverState.value=void 0});const v=tU();this.registerDisposer(new Bi(this.virtualList.element,v)),this.virtualList.element.title=v.describe(),this.registerDisposer(this.displayState.hoverState.changed.add(()=>this.updateHoverView())),this.registerDisposer(this.selectedAnnotationState.changed.add(()=>this.updateSelectionView())),this.registerDisposer(this.layer.localCoordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}get annotationStates(){return this.layer.annotationStates}updateAttachedAnnotationLayerStates(){const e=this.annotationStates.states,t=this.attachedAnnotationStates,r=new de;for(const s of t){var i=ae(s,2);const a=i[0],l=i[1];e.includes(a)||(t.delete(a),l.refCounted.dispose())}for(const s of e){const a=t.get(s);if(a!==void 0){r.set(s,a);continue}const l=s.source,c=new K;(l instanceof lo||l instanceof Pr)&&(c.registerDisposer(l.childAdded.add(u=>this.addAnnotationElement(u,s))),c.registerDisposer(l.childUpdated.add(u=>this.updateAnnotationElement(u,s))),c.registerDisposer(l.childDeleted.add(u=>this.deleteAnnotationElement(u,s))),c.registerDisposer(l.childRefreshed.add(()=>this.clearAnnotationElement(s)))),c.registerDisposer(s.transform.changed.add(this.forceUpdateView)),r.set(s,{refCounted:c,annotations:[],idToIndex:new de,listOffset:0})}this.attachedAnnotationStates=r,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}updateCoordinateSpace(){const e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,r=[],i=[];for(let s=0,a=t.rank;s<a;++s)this.annotationStates.states.some(l=>{const c=l.transform.value;return c.error!==void 0?!1:c.globalToRenderLayerDimensions[s]!==-1})&&r.push(s);for(let s=0,a=e.rank;s<a;++s)this.annotationStates.states.some(l=>{const c=l.transform.value;return c.error!==void 0?!1:c.localToRenderLayerDimensions[s]!==-1})&&i.push(s);(!Oe(r,this.globalDimensionIndices)||!Oe(i,this.localDimensionIndices))&&(this.localDimensionIndices=i,this.globalDimensionIndices=r,++this.curCoordinateSpaceGeneration)}getRenderedAnnotationListElement(e,t,r=!1){const i=this.attachedAnnotationStates.get(e);if(i==null)return;const s=i.idToIndex.get(t);if(s===void 0)return;const a=i.listOffset+s;return r&&this.virtualList.scrollItemIntoView(s),this.virtualList.getItemElement(a)}clearSelectionClass(){const e=this.previousSelectedState;if(e===void 0)return;this.previousSelectedState=void 0;const t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);t!==void 0&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){const e=this.previousHoverId,t=this.previousHoverAnnotationLayerState;if(t!==void 0){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;const r=this.getRenderedAnnotationListElement(t,e);r!==void 0&&r.classList.remove("neuroglancer-annotation-hover")}}updateSelectionView(){const e=this.selectedAnnotationState.value,t=this.previousSelectedState;if(t===e||t!==void 0&&e!==void 0&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin||(this.clearSelectionClass(),this.previousSelectedState=e,e===void 0))return;const r=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);r!==void 0&&r.classList.add("neuroglancer-annotation-selected")}updateHoverView(){const e=this.displayState.hoverState.value;let t,r;e!==void 0&&(t=e.id,r=e.annotationLayerState);const i=this.previousHoverId,s=this.previousHoverAnnotationLayerState;if(t===i&&r===s||(this.clearHoverClass(),this.previousHoverId=t,this.previousHoverAnnotationLayerState=r,t===void 0))return;const a=this.getRenderedAnnotationListElement(r,t);a!==void 0&&a.classList.add("neuroglancer-annotation-hover")}render(e){var t=this.listElements[e];const r=t.annotation,i=t.state;return this.makeAnnotationListElement(r,i)}setColumnWidth(e,t){t+=2;const r=this.columnWidths;r[e]>t||(r[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`))}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;const s=this.columnWidths;s.length=0;const a=this.headerRow,l=document.createElement("div");l.style.gridColumn="symbol";const c=document.createElement("div");c.style.gridColumn="delete",Xe(a),a.appendChild(l);let u=0,h="[symbol] 2ch";const g=(C,S)=>{const w=document.createElement("div");w.classList.add("neuroglancer-annotations-view-dimension");const E=document.createElement("span");E.classList.add("neuroglancer-annotations-view-dimension-name"),E.textContent=C.names[S];const k=document.createElement("scale");k.classList.add("neuroglancer-annotations-view-dimension-scale"),k.textContent=Qs(C.scales[S],C.units[S],{precision:2}),w.appendChild(E),w.appendChild(k),w.style.gridColumn=`dim ${u+1}`,this.setColumnWidth(u,k.textContent.length+E.textContent.length+3),h+=` [dim] var(--neuroglancer-column-${u}-width)`,++u,a.appendChild(w)},v=this.layer.manager.root.coordinateSpace.value;for(const C of this.globalDimensionIndices)g(v,C);const y=this.layer.localCoordinateSpace.value;for(const C of this.localDimensionIndices)g(y,C);a.appendChild(c),h+=" [delete] 2ch",this.gridTemplate=h,a.style.gridTemplateColumns=h,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1;const t=this.listElements;t.length=0;for(const s of this.attachedAnnotationStates){var r=ae(s,2);const a=r[0],l=r[1];if(a.source.readonly||(e=!0),a.chunkTransform.value.error!==void 0)continue;const c=a.source,u=Te(c);l.annotations=u;const h=l.idToIndex;h.clear();for(let g=0,v=u.length;g<v;++g)h.set(u[g].id,g);for(const g of u)t.push({state:a,annotation:g})}const i=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:i,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(const t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}clearAnnotationElement(e){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const t=this.attachedAnnotationStates.get(e);if(t!==void 0){const r=t.annotations.length;t.annotations=[],t.idToIndex.clear(),this.listElements=[],this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:r,insertCount:0}])}this.resetOnUpdate()}addAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const r=this.attachedAnnotationStates.get(t);if(r!==void 0){const i=r.annotations.length;r.annotations.push(e),r.idToIndex.set(e.id,i);const s=r.listOffset+i;this.listElements.splice(s,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:s,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const r=this.attachedAnnotationStates.get(t);if(r!==void 0){const i=r.idToIndex.get(e.id);if(i!==void 0){const s=r.listOffset+i;r.annotations[i]=e,this.listElements[s].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:s,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const r=this.attachedAnnotationStates.get(t);if(r!==void 0){const i=r.idToIndex,s=i.get(e);if(s!==void 0){const a=r.listOffset+s,l=r.annotations;l.splice(s,1),i.delete(e);for(let c=s,u=l.length;c<u;++c)i.set(l[c].id,c);this.listElements.splice(a,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:a,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}makeAnnotationListElement(e,t){const r=t.chunkTransform.value,i=document.createElement("div");i.classList.add("neuroglancer-annotation-list-entry"),i.style.gridTemplateColumns=this.gridTemplate;const s=document.createElement("div");s.className="neuroglancer-annotation-icon",s.textContent=Dn[e.type].icon,i.appendChild(s);let a;const l=()=>{t.source.readonly||a===void 0&&(a=hs({title:"Delete annotation",onClick:h=>{h.stopPropagation(),h.preventDefault();const g=t.source.getReference(e.id);try{t.source.delete(g)}finally{g.dispose()}}}),a.classList.add("neuroglancer-annotation-list-entry-delete"),i.appendChild(a))};let c=0;if(wD(e,r,(h,g)=>{++c;const v=document.createElement("div");v.className="neuroglancer-annotation-position",i.appendChild(v);let y=0;const C=(S,w)=>{for(const E of S){const k=w[E];if(k!==-1){const P=Math.floor(h[k]),D=document.createElement("div"),L=P.toString();D.textContent=L,D.classList.add("neuroglancer-annotation-coordinate"),D.style.gridColumn=`dim ${y+1}`,this.setColumnWidth(y,L.length),v.appendChild(D)}++y}};C(this.globalDimensionIndices,r.modelTransform.globalToRenderLayerDimensions),C(this.localDimensionIndices,r.modelTransform.localToRenderLayerDimensions),l()}),e.description){++c;const h=document.createElement("div");h.classList.add("neuroglancer-annotation-description"),h.textContent=e.description,i.appendChild(h)}s.style.gridRow=`span ${c}`,a!==void 0&&(a.style.gridRow=`span ${c}`),i.addEventListener("mouseenter",()=>{this.displayState.hoverState.value={id:e.id,partIndex:0,annotationLayerState:t},this.layer.selectAnnotation(t,e.id,!1)}),i.addEventListener("action:select-position",h=>{h.stopPropagation(),this.layer.selectAnnotation(t,e.id,"toggle")}),i.addEventListener("action:pin-annotation",h=>{h.stopPropagation(),this.layer.selectAnnotation(t,e.id,!0)}),i.addEventListener("action:move-to-annotation",h=>{h.stopPropagation(),h.preventDefault();const g=r.layerRank,v=new Float32Array(g),y=new Float32Array(g);f6(v,e),Ti(y,r.chunkToLayerTransform,g+1,v,g),bD(this.layer,r,y)});const u=this.selectedAnnotationState.value;return u!==void 0&&u.annotationLayerState===t&&u.annotationId===e.id&&i.classList.add("neuroglancer-annotation-selected"),i}}class m6 extends Fi{constructor(e){super(),this.layer=e,this.layerView=this.registerDisposer(new g6(this.layer,this.layer.annotationDisplayState));const t=this.element;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}}function Do(n){let e=[];const t=n.source.relationships,r=n.displayState.relationshipStates;for(let i=0,s=t.length;i<s;++i){const a=r.get(t[i]).segmentationState.value;if(a!=null&&a.segmentSelectionState.hasSelectedSegment){e[i]=[a.segmentSelectionState.selectedSegment.clone()];continue}e[i]=[]}return e}class SD extends Y2{constructor(e,t){super(e)}get annotationLayer(){for(const e of this.layer.annotationStates.states)if(!e.source.readonly)return e}}const CD="annotatePoint",xD="annotateLine",ED="annotateBoundingBox",TD="annotateEllipsoid",kD="annotateSphere";class LD extends SD{constructor(){super(...arguments),this.sourceSignalUpdated=!1}trigger(e){const t=this.annotationLayer;if(t!==void 0&&e.updateUnconditionally()){const r=dd(e,t);if(r===void 0)return;const i={id:"",description:"",relatedSegments:Do(t),point:r,type:Pe.POINT,properties:t.source.properties.map(a=>a.default)},s=t.source.add(i,!0);t.source instanceof Pr?this.sourceSignalUpdated||(t.source.childAdded.add(a=>{a.source===void 0&&this.layer.selectAnnotation(t,a.id,!0,!ps.expectingExternalUI)}),this.sourceSignalUpdated=!0):this.layer.selectAnnotation(t,s.id,!0),s.dispose()}}get description(){return"annotate point"}toJSON(){return CD}}function dd(n,e){const t=e.chunkTransform.value;if(t.error!==void 0)return;const r=new Float32Array(t.modelTransform.unpaddedRank);if(Yl(r,n.unsnappedPosition,e.localPosition.value,t.layerRank,t.combinedGlobalLocalToChunkTransform))return r}class ID extends SD{trigger(e){const t=this.annotationLayer;if(t!==void 0&&e.updateUnconditionally()){const r=()=>{const i=this.inProgressAnnotation,s=i.reference,a=this.getUpdatedAnnotation(s.value,e,t);ie(Eg(a,t.source))!==ie(Eg(s.value,t.source))&&(i.annotationLayer.source.update(s,a),this.layer.selectAnnotation(t,s.id,!0,!ps.expectingExternalUI))};if(this.inProgressAnnotation===void 0){const i=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,i.id,!0,!ps.expectingExternalUI);const s=e.changed.add(r),a=()=>{s(),i.dispose()};this.inProgressAnnotation={annotationLayer:t,reference:i,disposer:a}}else r(),this.inProgressAnnotation.annotationLayer.source.commit(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0}}disposed(){this.deactivate(),super.disposed()}deactivate(){this.inProgressAnnotation!==void 0&&(this.inProgressAnnotation.annotationLayer.source.delete(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0)}}class Ly extends ID{getInitialAnnotation(e,t){const r=dd(e,t);return{id:"",type:this.annotationType,description:"",pointA:r,pointB:r,properties:t.source.properties.map(i=>i.default)}}getUpdatedAnnotation(e,t,r){const i=dd(t,r);return i===void 0?e:j(j({},e),{pointB:i})}}class Iy extends Ly{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,r){const i=super.getUpdatedAnnotation(e,t,r),s=i.pointA,a=i.pointB,l=s.length;for(let c=0;c<l;++c)s[c]===a[c]&&(a[c]+=1);return i}toJSON(){return ED}}Iy.prototype.annotationType=Pe.AXIS_ALIGNED_BOUNDING_BOX;class Dy extends Ly{get description(){return"annotate line"}getInitialAnnotation(e,t){const r=super.getInitialAnnotation(e,t);return this.initialRelationships=r.relatedSegments=Do(t),r}getUpdatedAnnotation(e,t,r){const i=super.getUpdatedAnnotation(e,t,r),s=this.initialRelationships,a=Do(r);return s===void 0?i.relatedSegments=a:i.relatedSegments=Te(a,(l,c)=>{const u=s[c];return l=l.filter(h=>u.findIndex(g=>te.equal(h,g))===-1),[...u,...l]}),i}toJSON(){return xD}}Dy.prototype.annotationType=Pe.LINE;class Py extends Ly{get description(){return"annotate sphere"}getInitialAnnotation(e,t){const r=super.getInitialAnnotation(e,t);return this.initialRelationships=r.relatedSegments=Do(t),r}getUpdatedAnnotation(e,t,r){const i=super.getUpdatedAnnotation(e,t,r),s=this.initialRelationships,a=Do(r);return s===void 0?i.relatedSegments=a:i.relatedSegments=Te(a,(l,c)=>{const u=s[c];return l=l.filter(h=>u.findIndex(g=>te.equal(h,g))===-1),[...u,...l]}),i}toJSON(){return kD}}Py.prototype.annotationType=Pe.SPHERE;class DD extends ID{getInitialAnnotation(e,t){const r=dd(e,t);return{type:Pe.ELLIPSOID,id:"",description:"",segments:Do(t),center:r,radii:lt(0,0,0),properties:t.source.properties.map(i=>i.default)}}getUpdatedAnnotation(e,t,r){const i=dd(t,r);if(i===void 0)return e;const s=e.center,a=s.length;for(let l=0;l<a;++l)i[l]=Math.abs(s[l]-i[l]);return j(j({},e),{radii:i})}get description(){return"annotate ellipsoid"}toJSON(){return TD}}Fd(CD,(n,e)=>new LD(n,e));Fd(ED,(n,e)=>new Iy(n,e));Fd(xD,(n,e)=>new Dy(n,e));Fd(TD,(n,e)=>new DD(n,e));Fd(kD,(n,e)=>new Py(n,e));const v6=at.fromObject({enter:{action:"commit"},escape:{action:"cancel"}});function y6(n,e,t,r){return new Qr(t,(i,s,a)=>{const l=document.createElement("div");l.classList.add("neuroglancer-related-segment-list"),i!=null&&a.registerDisposer(sd(i,l));const c=document.createElement("div");c.classList.add("neuroglancer-related-segment-list-header");const u=Zr({title:"Copy segment IDs",onClick:()=>{Yn(e.map(C=>C.toString()).join(", "))}});c.appendChild(u);let h;if(i!=null&&(h=document.createElement("input"),h.type="checkbox",h.addEventListener("change",()=>{const C=i.segmentationGroupState.value.visibleSegments,S=e.some(w=>!C.has(w));for(const w of e)C.set(w,S)}),c.appendChild(h)),r!==void 0){const C=hs({title:"Remove all IDs",onClick:()=>{r([])}});c.appendChild(C)}const g=document.createElement("span");if(g.classList.add("neuroglancer-related-segment-list-title"),g.textContent=n,c.appendChild(g),r!==void 0){const C=j2({title:"Add related segment ID",onClick:()=>{const S=new K,w=a.registerDisposer(HT(S)),E=document.createElement("div");E.classList.add("neuroglancer-segment-list-entry"),E.classList.add("neuroglancer-segment-list-entry-new");const k=Zr({});if(k.classList.add("neuroglancer-segment-list-entry-copy"),E.appendChild(k),i!=null){const M=document.createElement("input");M.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),M.type="checkbox",E.appendChild(M)}const P=hs({title:"Cancel adding new segment ID",onClick:()=>{w()}});P.classList.add("neuroglancer-segment-list-entry-delete"),E.appendChild(P);const D=document.createElement("input");D.autocomplete="off",D.spellcheck=!1,D.classList.add("neuroglancer-segment-list-entry-id");const L=S.registerDisposer(new Nr(D,v6));L.allShortcutsAreGlobal=!0;const R=()=>{const M=new te;if(M.tryParseString(D.value))return D.dataset.valid="true",M;D.dataset.valid="false"};R(),D.addEventListener("input",()=>{R()}),D.addEventListener("blur",()=>{const M=R();M!==void 0&&r([...e,M]),w()}),ve(D,"cancel",w),ve(D,"commit",()=>{const M=R();M!==void 0&&r([...e,M]),w()}),E.appendChild(D),l.appendChild(E),D.focus(),S.registerDisposer(()=>{D.value="",E.remove()})}});c.appendChild(C)}l.appendChild(c);const v=[],y=Rd.make(i??void 0,!1);for(const C of e){const S=y.get(C);if(v.push(S),r!==void 0){const w=hs({title:"Remove ID",onClick:E=>{r(e.filter(k=>!te.equal(k,C))),E.stopPropagation()}});w.classList.add("neuroglancer-segment-list-entry-delete"),S.children[0].appendChild(w)}l.appendChild(S)}if(i!=null){const C=a.registerCancellable(ct(()=>{const S=i.segmentationGroupState.value.visibleSegments;let w=0;for(const E of e)S.has(E)&&++w;for(const E of v)y.update(E);h.checked=w===e.length&&w>0,h.indeterminate=w>0&&w<e.length}));C(),C.flush(),Md(i,a,C),a.registerDisposer(i.segmentationGroupState.changed.add(C))}s.appendChild(l)})}const OE="annotationColor";function Ry(n){class e extends n{constructor(...r){super(...r),this.annotationStates=this.registerDisposer(new p6),this.annotationDisplayState=new AB,this.annotationCrossSectionRenderScaleHistogram=new vo,this.annotationCrossSectionRenderScaleTarget=ta(8),this.annotationProjectionRenderScaleHistogram=new vo,this.annotationProjectionRenderScaleTarget=ta(8),this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new m6(this)});let i;const s=()=>{const l=this.isReady;l&&i!==void 0?(i(),i=void 0):!l&&i===void 0&&(i=this.annotationStates.markLoading())};this.readyStateChanged.add(s),s();const a=this.manager.layerSelectedValues.mouseState;this.registerDisposer(a.changed.add(()=>{if(a.active){const l=a.pickedAnnotationLayer;if(l!==void 0&&this.annotationStates.states.includes(l)){const c=this.annotationDisplayState.hoverState.value;(c===void 0||c.id!==a.pickedAnnotationId||c.partIndex!==a.pickedOffset||c.annotationLayerState!==l)&&(this.annotationDisplayState.hoverState.value={id:a.pickedAnnotationId,partIndex:a.pickedOffset,annotationLayerState:l});return}}this.annotationDisplayState.hoverState.value=void 0}))}initializeAnnotationLayerViewTab(r){}restoreState(r){super.restoreState(r),this.annotationDisplayState.color.restoreState(r[OE])}captureSelectionState(r,i){super.captureSelectionState(r,i);const s=i.pickedAnnotationLayer;s===void 0||!this.annotationStates.states.includes(s)||(r.annotationId=i.pickedAnnotationId,r.annotationType=i.pickedAnnotationType,r.annotationBuffer=new Uint8Array(i.pickedAnnotationBuffer,i.pickedAnnotationBufferBaseOffset),r.annotationIndex=i.pickedAnnotationIndex,r.annotationCount=i.pickedAnnotationCount,r.annotationPartIndex=i.pickedOffset,r.annotationSourceIndex=s.sourceIndex,r.annotationSubsource=s.subsourceId)}displayAnnotationState(r,i,s){if(r.annotationId===void 0)return!1;const a=this.annotationStates.states.find(c=>c.sourceIndex===r.annotationSourceIndex&&(r.annotationSubsource===void 0||c.subsourceId===r.annotationSubsource));if(a===void 0)return!1;a.source instanceof Pr;const l=s.registerDisposer(a.source.getReference(r.annotationId));return i.appendChild(s.registerDisposer(new Qr(s.registerDisposer(new XT(()=>({annotation:l,chunkTransform:a.chunkTransform}))),({annotation:c,chunkTransform:u},h,g)=>{let v;if(c==null)if(r.annotationType!==void 0&&r.annotationBuffer!==void 0){const S=Dn[r.annotationType],w=a.source.rank,E=S.serializedBytes(w),k=r.annotationBuffer.byteOffset,P=new DataView(r.annotationBuffer.buffer),D=Jn.LITTLE===pd,L=a.source.properties,R=new wk(w,E,L),M=r.annotationIndex,V=r.annotationCount;c=S.deserialize(P,k+R.propertyGroupBytes[0]*M,D,w,r.annotationId),R.deserialize(P,k,M,V,D,c.properties=new Array(L.length)),a.source.hasNonSerializedProperties()&&(v="Loading...")}else v=c===null?"Annotation not found":"Loading...";if(c!=null){const S=u.error===void 0?u.layerRank:0,w=document.createElement("div");w.classList.add("neuroglancer-selected-annotation-details-position-grid"),w.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${S}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,h.appendChild(w);const E=Dn[c.type],k=document.createElement("div");if(k.className="neuroglancer-selected-annotation-details-icon",k.textContent=E.icon,w.appendChild(k),S!==0){const B=u.modelTransform.layerDimensionNames;for(let _=0;_<S;++_){const H=document.createElement("div");H.classList.add("neuroglancer-selected-annotation-details-position-dim"),H.textContent=B[_],H.style.gridColumn=`dim ${_+1}`,w.appendChild(H)}wD(c,u,(_,H)=>{const U=Zr({title:"Copy position",onClick:()=>{Yn(_.map(O=>Math.floor(O)).join(", "))}});U.style.gridColumn="copy",w.appendChild(U);for(let O=0;O<S;++O){const z=document.createElement("div");z.classList.add("neuroglancer-selected-annotation-details-position-coord"),z.style.gridColumn=`coord ${O+1}`,z.textContent=Math.floor(_[O]).toString(),w.appendChild(z)}if(!H){const O=D2({title:"Move to position",onClick:()=>{bD(this,u,_)}});O.style.gridColumn="move",w.appendChild(O)}})}if(!a.source.readonly){const B=hs({title:"Delete annotation",onClick:()=>{a.source.delete(l)}});B.classList.add("neuroglancer-selected-annotation-details-delete"),w.appendChild(B)}var y=a.source;const P=y.relationships,D=y.properties,L=a.source.readonly;for(let B=0,_=D.length;B<_;++B){const H=D[B],U=document.createElement("label");U.classList.add("neuroglancer-annotation-property");const O=document.createElement("span");O.classList.add("neuroglancer-annotation-property-label"),O.textContent=H.identifier,U.appendChild(O);const z=H.description;z!==void 0&&(U.title=z);const F=c.properties[B],se=document.createElement("span");switch(se.classList.add("neuroglancer-annotation-property-value"),H.type){case"rgb":{const oe=eo(F),Re=Rn(oe);se.textContent=Re,se.style.backgroundColor=Re,se.style.color=yg(oe)?"white":"black";break}case"rgba":{const oe=eo(F);se.textContent=Rn(sv(F)),se.style.backgroundColor=Rn(eo(F)),se.style.color=yg(oe)?"white":"black";break}default:se.textContent=Sk(H,F);break}U.appendChild(se),h.appendChild(U)}var C=c;const R=C.relatedSegments;for(let B=0,_=P.length;B<_;++B){const H=R===void 0?[]:R[B];if(H.length===0&&L)continue;const U=B,O=P[B];h.appendChild(g.registerDisposer(y6(O,H,a.displayState.relationshipStates.get(O).segmentationState,L?void 0:z=>{const F=l.value;if(F==null)return;let se=F.relatedSegments;se===void 0?se=a.source.relationships.map(()=>[]):se=se.slice(),se[U]=z;const oe=j(j({},F),{relatedSegments:se});a.source.update(l,oe),a.source.commit(l)})).element)}let M=null,V=a.source;if(V instanceof Pr&&V.makeEditWidget&&(M=V.makeEditWidget(l),M&&(M.className="neuroglancer-annotation-details-description",h.appendChild(M))),(!a.source.readonly||c.description)&&M===null)if(a.source.readonly){const B=document.createElement("div");B.className="neuroglancer-annotation-details-description",B.textContent=c.description||"",h.appendChild(B)}else{const B=document.createElement("textarea");B.value=c.description||"",B.rows=3,B.className="neuroglancer-annotation-details-description",B.placeholder="Description",B.addEventListener("change",()=>{const _=B.value;a.source.update(l,j(j({},c),{description:_||void 0})),a.source.commit(l)}),h.appendChild(B)}}if(v!==void 0){const S=document.createElement("div");S.classList.add("neuroglancer-selection-annotation-status"),S.textContent=v,h.appendChild(S)}})).element),!0}displaySelectionState(r,i,s){let a=this.displayAnnotationState(r,i,s);return super.displaySelectionState(r,i,s)&&(a=!0),a}addLocalAnnotations(r,i,s){const a=r.subsourceEntry,l=new Ag({localPosition:this.localPosition,transform:r.getRenderLayerTransform(),source:i,displayState:this.annotationDisplayState,dataSource:r.loadedDataSource.layerDataSource,subsourceIndex:r.subsourceIndex,subsourceId:a.id,role:s});this.addAnnotationLayerState(l,r)}addStaticAnnotations(r){const i=r.subsourceEntry.subsource.staticAnnotations;return i===void 0?!1:(r.activate(()=>{this.addLocalAnnotations(r,i,ur.DEFAULT_ANNOTATION)}),!0)}addAnnotationLayerState(r,i){const s=i.activated;s.registerDisposer(this.annotationStates.add(r));const a=new l6(this.manager.chunkManager,r.addRef());if(a.source instanceof Pr){const l=new u6({annotationLayer:a.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});s.registerDisposer(i.messages.addChild(l.messages));const c=new c6({annotationLayer:a.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});s.registerDisposer(i.messages.addChild(c.messages)),s.registerDisposer(Di((u,h)=>{h&&(u.registerDisposer(this.addRenderLayer(l.addRef())),u.registerDisposer(this.addRenderLayer(c.addRef())))},this.annotationDisplayState.displayUnfiltered))}{const l=new h6(a,this.annotationCrossSectionRenderScaleHistogram);s.registerDisposer(this.addRenderLayer(l)),s.registerDisposer(i.messages.addChild(l.messages))}{const l=new d6(a.addRef(),this.annotationProjectionRenderScaleHistogram);s.registerDisposer(this.addRenderLayer(l)),s.registerDisposer(i.messages.addChild(l.messages))}}selectAnnotation(r,i,s,a=!0){this.manager.root.selectionState.captureSingleLayerState(this,l=>(l.annotationId=i,l.annotationSourceIndex=r.sourceIndex,l.annotationSubsource=r.subsourceId,!0),s,a)}toJSON(){const r=super.toJSON();return r[OE]=this.annotationDisplayState.color.toJSON(),r}}return e}const BE=at.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}});class PD extends K{constructor(e,t,r,i){super(),this.element=e,this.dataType=t,this.getModel=r,this.setModel=i,e.title=BE.describe(),this.registerDisposer(new Bi(e,BE)),ve(e,"set",s=>{const a=s.detail,l=this.getModel(),c=this.getTargetValue(a);if(c===void 0)return;const u=_l(l.window,l.range),h=GV(u,c),g=v=>{const y=this.getModel();this.setModel(Au(y,"range",h,v))};g(c),Rr(a,v=>{const y=this.getTargetValue(v);y!==void 0&&g(y)})}),ve(e,"adjust-window-via-drag",s=>{const a=s.detail,l=this.getTargetFraction(a),c=this.getWindowLerp(l),u=l<.5?0:1,h=g=>{const v=this.getModel();this.setModel(Au(v,"window",u,g))};Rr(a,g=>{const v=this.getModel().window,y=this.getTargetFraction(g);h(u===0?Ci([c,v[1]],this.dataType,-y/(1-y)):Ci([v[0],c],this.dataType,1/y))})}),ve(e,"zoom-via-wheel",s=>{const a=s.detail,l=xu(a),c=this.getTargetFraction(a),u=this.dataType,h=this.getModel(),g=Ci(h.window,u,c*(1-l)),v=Ci(h.window,u,(1-c)*l+c);this.setModel(j(j({},h),{window:[g,v],range:h.range}))})}getTargetFraction(e){const t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return Ci(this.getModel().window,this.dataType,e)}getTargetValue(e){const t=this.getTargetFraction(e);if(gt(t))return this.getWindowLerp(t)}}const FE=Xn("histogramSamplerTexture");function Au(n,e,t,r,i=!1){const s=j({},n),a=n[e];if(s[e]=[a[0],a[1]],s[e][t]=r,e==="window"&&cr(r,a[1-t])*(2*t-1)<0&&(s[e][1-t]=r),e==="range"&&i){const l=[n.window[0],n.window[1]];for(let c=0;c<2;++c)cr(r,l[c])*(2*c-1)>0&&(l[c]=r);s.window=l}return s}const b6=254,Nl=b6+1;class w6 extends Zk{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.controller=this.registerDisposer(new PD(this.element,this.parent.dataType,()=>this.parent.trackable.value,t=>{this.parent.trackable.value=t})),this.dataValuesBuffer=this.registerDisposer(Zl(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{const t=new Uint8Array(Nl*us);for(let r=0;r<Nl;++r)for(let i=0;i<us;++i)t[r*us+i]=r;return t})).value,this.lineShader=this.registerDisposer((()=>{const t=new ea(this.gl);return ti(t),t.addTextureSampler("sampler2D","uHistogramSampler",FE),t.addOutputBuffer("vec4","out_color",0),t.addAttribute("uint","aDataValue"),t.addUniform("float","uBoundsFraction"),t.addVertexCode(`
float getCount(int i) {
  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;
}
vec4 getVertex(float cdf, int i) {
  float x;
  if (i == 0) {
    x = -1.0;
  } else if (i == 255) {
    x = 1.0;
  } else {
    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;
  }
  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);
}
`),t.setVertexMain(`
int lineNumber = int(aDataValue);
int dataValue = lineNumber;
float cumSum = 0.0;
for (int i = 0; i <= dataValue; ++i) {
  cumSum += getCount(i);
}
float total = cumSum + getCount(dataValue + 1);
float cumSumEnd = dataValue == ${Nl-1} ? cumSum : total;
if (dataValue == ${Nl-1}) {
  cumSum + getCount(dataValue + 1);
}
for (int i = dataValue + 2; i < 256; ++i) {
  total += getCount(i);
}
total = max(total, 1.0);
float cdf1 = cumSum / total;
float cdf2 = cumSumEnd / total;
emitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);
`),t.setFragmentMain(`
out_color = vec4(0.0, 1.0, 1.0, getLineAlpha());
`),t.build()})()),this.regionCornersBuffer=Ql(this.gl,0,-1,1,1),this.regionShader=this.registerDisposer((()=>{const t=new ea(this.gl);return t.addAttribute("vec2","aVertexPosition"),t.addUniform("vec2","uBounds"),t.addUniform("vec4","uColor"),t.addOutputBuffer("vec4","out_color",0),t.setVertexMain(`
gl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);
`),t.setFragmentMain(`
out_color = uColor;
`),t.build()})()),this.element.classList.add("neuroglancer-invlerp-cdfpanel")}get drawOrder(){return 100}drawIndirect(){const e=this.lineShader,t=this.gl,r=this.regionShader;var i=this.parent;const s=i.dataType,a=i.trackable.value;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{r.bind(),t.uniform4f(r.uniform("uColor"),.2,.2,.2,1);const l=nr(a.window,a.range[0]),c=nr(a.window,a.range[1]),u=ou(s,a.window);t.uniform2f(r.uniform("uBounds"),Math.min(l,c)*u,Math.max(l,c)*u+(1-u));const h=r.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(h,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(h)}if(this.parent.histogramSpecifications.producerVisibility.visible){const l=this.renderViewport;e.bind(),ri(e,{width:l.logicalWidth,height:l.logicalHeight},1);const c=e.textureUnit(FE);t.uniform1f(e.uniform("uBoundsFraction"),ou(s,a.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+c),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),po(t);const u=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(u,1,WebGL2RenderingContext.UNSIGNED_BYTE),ni(t,Nl,1),t.disableVertexAttribArray(u),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}}function S6(){}class C6 extends Zk{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.cornersBuffer=Ql(this.gl,-1,-1,1,1),this.element.classList.add("neuroglancer-invlerp-legend-panel");const t=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=ho(this,this.gl,j(j({},t),{memoizeKey:{id:"colorLegendShader",base:t.memoizeKey},defineShader:(r,i,s)=>{r.addOutputBuffer("vec4","v4f_fragData0",0),r.addAttribute("vec2","aVertexPosition"),r.addUniform("float","uLegendOffset"),r.addVarying("float","vLinearPosition"),r.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);
`);const a=this.parent.dataType,l=an(a);r.addFragmentCode(yB(r,"ng_colorLegendLerp",a)),r.addFragmentCode(`
void emit(vec4 v) {
  v4f_fragData0 = v;
}
${l} getDataValue() {
  return ng_colorLegendLerp(vLinearPosition);
}
${l} getDataValue(int dummyChannel) {
  return getDataValue();
}
${l} getInterpolatedDataValue() {
  return getDataValue();
}
${l} getInterpolatedDataValue(int dummyChannel) {
  return getDataValue();
}
`),t.defineShader(r,i,s)}}))}drawIndirect(){const e=this.shaderGetter(S6),t=e.shader;if(t===null)return;this.setGLLogicalViewport();const r=this.gl;r.clearColor(0,0,0,0),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),r.enable(WebGL2RenderingContext.BLEND);var i=this.parent;const s=i.trackable.value.window,a=i.dataType;Rv(t,"ng_colorLegendLerp",this.parent.dataType,s);const l=WV(a,s);r.uniform1f(t.uniform("uLegendOffset"),gt(l)?l:0),r.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),r.disable(WebGL2RenderingContext.DEPTH_TEST),r.disable(WebGL2RenderingContext.STENCIL_TEST);const c=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(c,2,WebGL2RenderingContext.FLOAT),r.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),r.disableVertexAttribArray(c)}isReady(){return!0}}function _E(n,e){const t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add("neuroglancer-invlerp-widget-bound"),t.classList.add(`neuroglancer-invlerp-widget-${n}-bound`),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=n==="range"?`Data value that maps to ${e}`:`${e===0?"Lower":"Upper"} bound for distribution`,t}function UE(n,e,t){const r=document.createElement("div");r.classList.add("neuroglancer-invlerp-widget-bounds"),r.classList.add(`neuroglancer-invlerp-widget-${n}-bounds`);const i=[_E(n,0),_E(n,1)];for(let a=0;a<2;++a){const l=i[a];l.addEventListener("input",()=>{RD(l)}),l.addEventListener("change",()=>{const c=t.value,u=c[n];try{const h=vd(e,l.value);t.value=Au(c,n,a,h,!0)}catch{wm(l,u[a])}})}let s;return r.appendChild(i[0]),r.appendChild(i[1]),n==="range"&&(s=[document.createElement("div"),document.createElement("div"),document.createElement("div")],s[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),r.insertBefore(s[0],i[0]),r.insertBefore(s[1],i[1]),r.appendChild(s[2])),{container:r,inputs:i,spacers:s}}function RD(n){_n(n,Math.max(1,n.value.length+.1))}function wm(n,e){let t;e instanceof te||Nn(e)?t=e.toString():t=e.toPrecision(6),n.value=t,RD(n)}function MD(n){const e=n.value,t=e.range;n.value=j(j({},e),{range:[t[1],t[0]]})}function x6(n,e,t){const r=e.value,i=Ci(r.range,n,.5-t/2),s=Ci(r.range,n,.5+t/2);e.value=j(j({},r),{range:[i,s]})}function E6(n,e,t,r,i){const s=Math.exp(i),a=e.value,l=Ci(t,n,.5-s/2+r),c=Ci(t,n,.5+s/2+r);e.value=j(j({},a),{range:[l,c]})}class T6 extends Fi{constructor(e,t,r,i,s,a,l){super(e),this.display=t,this.dataType=r,this.trackable=i,this.histogramSpecifications=s,this.histogramIndex=a,this.legendShaderOptions=l,this.cdfPanel=this.registerDisposer(new w6(this)),this.boundElements={range:UE("range",this.dataType,this.trackable),window:UE("window",this.dataType,this.trackable)},this.registerDisposer(s.visibility.add(this.visibility));const c=this.element,u=this.boundElements;if(l!==void 0){const g=this.registerDisposer(new C6(this));c.appendChild(g.element)}const h=g=>{const v=ft({svg:g,title:"Invert range",onClick:()=>{this.invertRange()}});return u.range.spacers[1].appendChild(v),v};this.invertArrows=[h(C2),h(S2)],c.appendChild(u.range.container),c.appendChild(this.cdfPanel.element),c.classList.add("neuroglancer-invlerp-widget"),c.appendChild(u.window.container),this.updateView(),this.registerDisposer(i.changed.add(this.registerCancellable(ct(()=>this.updateView()))))}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){MD(this.trackable)}updateView(){const e=this.boundElements,t=this.trackable.value,r=this.dataType;for(let g=0;g<2;++g)wm(e.range.inputs[g],t.range[g]),wm(e.window.inputs[g],t.window[g]);const i=cr(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=i?"row-reverse":"row";const s=_l(t.window,t.range),a=e.range.spacers,l=ou(r,t.window),c=nr(t.window,s[i?1:0])*l,u=nr(t.window,s[i?0:1])*l+(1-l);a[i?2:0].style.width=`${c*100}%`,a[i?0:2].style.width=`${(1-u)*100}%`;const h=this.invertArrows;h[i?1:0].style.display="",h[i?0:1].style.display="none"}}const My="mergeSegments",Ay="splitSegments",k6=at.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),L6=at.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+alt+mousedown0":{action:"split-and-select-segments"},"at:shift?+mousedown2":{action:"set-anchor"}});class I6 extends To{constructor(e){super(e),this.lastAnchorBaseSegment=new dt(void 0);const t=()=>{const r=e.anchorSegment.value;if(r===void 0)return;const i=e.displayState.segmentSelectionState;if(!i.hasSelectedSegment)return;const s=e.displayState.segmentationGroupState.value.segmentEquivalences,a=s.get(r);if(!te.equal(i.selectedSegment,a))return;const l=i.baseSelectedSegment,c=uF(l),u=s.disjointSets.visibleSegmentEquivalencePolicy.value;u&Dr.NONREPRESENTATIVE_EXCLUDED&&c||u&Dr.REPRESENTATIVE_EXCLUDED&&!c||(this.lastAnchorBaseSegment.value=l.clone())};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return My}activate(e){const t=this.layer.displayState.segmentationGroupState.value,r=()=>{let h=this.layer.anchorSegment.value,g=this.lastAnchorBaseSegment.value;if(h===void 0)return{anchorSegment:void 0,error:"Select anchor segment for merge"};const v=t.segmentEquivalences.get(h);return t.visibleSegments.has(v)?g===void 0||!te.equal(t.segmentEquivalences.get(g),v)?{anchorSegment:h,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:g,error:void 0}:{anchorSegment:h,error:"Anchor segment must be in visible set"}},i=()=>{var h=r();let g=h.anchorSegment,v=h.error;if(g===void 0||v!==void 0)return{anchorSegment:g,error:v,otherSegment:void 0,anchorSegmentValid:!1};const y=this.layer.displayState,C=y.segmentSelectionState.baseValue;return C===void 0||te.equal(y.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(g))?{anchorSegment:g,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:g,otherSegment:C,error:void 0,anchorSegmentValid:!0}};var s=wh(e);const a=s.body,l=s.header;l.textContent="Merge segments",a.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(k6),e.registerDisposer(()=>{wu(t)});const c=()=>{Xe(a);const h=this.layer.displayState;var g=i();let v=g.anchorSegment,y=g.otherSegment,C=g.anchorSegmentValid,S=g.error;const w=k=>{const P=ey(this.layer.displayState,k);return P.classList.add("neuroglancer-segment-list-entry-double-line"),P};if(v!==void 0&&a.appendChild(w(xo(h,v))),S!==void 0){const k=document.createElement("span");k.textContent=S,a.appendChild(k)}if(y!==void 0){const k=document.createElement("span");k.textContent=" merge ",a.appendChild(k),a.appendChild(w(xo(h,y)))}const E=t.segmentEquivalences;if(C){t.useTemporaryVisibleSegments.value=!0;const k=t.temporaryVisibleSegments;k.clear(),k.add(E.get(v)),y!==void 0&&k.add(E.get(y))}else{wu(t);return}};c(),e.registerDisposer(sd(this.layer.displayState,a));const u=e.registerCancellable(ct(c));Md(this.layer.displayState,e,u),e.registerDisposer(this.layer.anchorSegment.changed.add(u)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(u)),e.bindAction("merge-segments",h=>{h.stopPropagation(),(async()=>{const g=t.graph.value;if(g===void 0)return;var v=i();const y=v.anchorSegment,C=v.otherSegment,S=v.error;if(!(y===void 0||C===void 0||S!==void 0))try{await g.merge(y,C),Ke.showTemporaryMessage("Merge performed")}catch(w){Ke.showTemporaryMessage(`Merge failed: ${w}`)}})()}),e.bindAction("set-anchor",h=>{h.stopPropagation();const g=this.layer.displayState.segmentSelectionState.baseValue;if(g===void 0)return;const v=this.layer.anchorSegment.value;if(t.visibleSegments.add(g),v===void 0||!te.equal(v,g)){this.layer.anchorSegment.value=g.clone();return}})}get description(){return"merge"}}class D6 extends To{toJSON(){return Ay}activate(e){const t=this.layer.displayState.segmentationGroupState.value,r=()=>{let g=this.layer.anchorSegment.value;if(g===void 0)return{anchorSegment:void 0,error:"Select anchor segment for split"};const v=t.segmentEquivalences.get(g);return t.visibleSegments.has(v)?{anchorSegment:g,error:void 0}:{anchorSegment:g,error:"Anchor segment must be in visible set"}};var i=wh(e);const s=i.body,a=i.header;a.textContent="Split segments",s.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(L6);const l=()=>{var g=r();let v=g.anchorSegment,y=g.error;if(v===void 0||y!==void 0)return{anchorSegment:v,error:y,otherSegment:void 0,anchorSegmentValid:!1};const C=this.layer.displayState,S=C.segmentSelectionState.baseValue;return S===void 0||!te.equal(C.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(v))||te.equal(S,v)?{anchorSegment:v,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:v,otherSegment:S,anchorSegmentValid:!0,error:void 0}};e.registerDisposer(()=>{wu(t)});const c=()=>{Xe(s);const g=this.layer.displayState;var v=l();let y=v.anchorSegment,C=v.otherSegment,S=v.anchorSegmentValid,w=v.error,E,k;(()=>{const D=t.segmentEquivalences,L=this.layer.graphConnection;if(!S||L===void 0){wu(t);return}else{if(t.useTemporaryVisibleSegments.value=!0,C!==void 0){const M=L.computeSplit(y,C);if(M!==void 0){E=new vs(y,M.includeRepresentative),k=new vs(C,M.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;const V=M.includeRepresentative,B=M.excludeRepresentative,_=t.temporarySegmentEquivalences;_.clear();for(const U of M.includeBaseSegments)_.link(U,V);for(const U of M.excludeBaseSegments)_.link(U,B);const H=t.temporaryVisibleSegments;H.clear(),H.add(V),H.add(B);return}}t.useTemporarySegmentEquivalences.value=!1;const R=t.temporaryVisibleSegments;R.clear(),R.add(D.get(y))}})();const P=D=>{const L=ey(this.layer.displayState,D);return L.classList.add("neuroglancer-segment-list-entry-double-line"),L};if(y!==void 0&&s.appendChild(P(E??xo(g,y))),w!==void 0){const D=document.createElement("span");D.textContent=w,s.appendChild(D)}if(k!==void 0){const D=document.createElement("span");D.textContent=" split ",s.appendChild(D),s.appendChild(P(k))}};e.registerDisposer(sd(this.layer.displayState,s)),c();const u=e.registerCancellable(ct(c));Md(this.layer.displayState,e,u),e.registerDisposer(this.layer.anchorSegment.changed.add(u));const h=async g=>{const v=t.graph.value;if(v===void 0)return;var y=l();const C=y.anchorSegment,S=y.otherSegment,w=y.error;if(!(C===void 0||S===void 0||w!==void 0))try{await v.split(C,S),g&&t.visibleSegments.add(t.segmentEquivalences.get(S)),Ke.showTemporaryMessage("Split performed")}catch(E){Ke.showTemporaryMessage(`Split failed: ${E}`)}};e.bindAction("split-segments",g=>{g.stopPropagation(),h(!1)}),e.bindAction("split-and-select-segments",g=>{g.stopPropagation(),h(!0)}),e.bindAction("set-anchor",g=>{g.stopPropagation();const v=this.layer.displayState.segmentSelectionState.baseValue;if(v===void 0)return;t.visibleSegments.add(v);const y=this.layer.anchorSegment.value;if(y===void 0||!te.equal(y,v)){this.layer.anchorSegment.value=v.clone();return}})}get description(){return"split"}}function P6(){od(qt,My,n=>new I6(n)),od(qt,Ay,n=>new D6(n))}/**
 * /**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2021 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ny="selectSegments",Sm="mousedown0",R6=at.fromObject({[`at:alt?+shift?+${Sm}`]:"drag-select-segments"});var In;(function(n){n[n.IDLE=0]="IDLE",n[n.SELECT=1]="SELECT",n[n.DESELECT=2]="DESELECT"})(In||(In={}));class M6 extends To{constructor(e){super(e)}toJSON(){return Ny}activate(e){const t=this.layer;var r=wh(e);const i=r.body,s=r.header;let a=In.IDLE,l=!1;e.bindInputEventMap(R6);const c=()=>Cu.value&2?In.DESELECT:In.SELECT,u=y=>{a!==y&&(a=y,l=!1,h())},h=()=>{Xe(i);const y=document.createElement("span");switch(a){case In.IDLE:s.textContent="Select/Deselect segments",y.textContent=`${Sm} to select segments; alt+${Sm} to deselect segments.`;break;case In.SELECT:case In.DESELECT:s.textContent=`${a==In.SELECT?"Select":"Deselect"} segments`,y.textContent=`Drag to ${a==In.SELECT?"select":"deselect"} segments (${t.displayState.segmentationGroupState.value.visibleSegments.size} selected).`}i.appendChild(y)};h();const g=()=>{if(a==In.IDLE)return;const y=t.displayState.segmentSelectionState;if(y.hasSelectedSegment){const C=y.selectedSegment,S=t.displayState.segmentationGroupState.value.visibleSegments;switch(a){case In.SELECT:S.add(C);break;case In.DESELECT:S.delete(C);break}}};e.registerDisposer(t.displayState.segmentSelectionState.changed.add(()=>{l&&g()})),e.registerDisposer(t.displayState.segmentationGroupState.value.visibleSegments.changed.add(h)),e.registerDisposer(Cu.changed.add(()=>{a!=In.IDLE&&u(c())}));const v=(y,C)=>{y.stopPropagation(),u(C),g();const S=y.detail.screenX,w=y.detail.screenY;Rr(y.detail,(E,k,P)=>{if(!l){const D=E.screenX-S,L=E.screenY-w;D*D+L*L>25&&(g(),l=!0)}},E=>{l=!1,u(In.IDLE)})};e.bindAction("drag-select-segments",y=>v(y,c()))}get description(){return"select"}}function A6(){od(qt,Ny,n=>new M6(n))}const N6=new te;class V6 extends K{constructor(e,t,r,i){super(),this.query=e,this.segmentPropertyMap=t,this.segmentationDisplayState=r,this.parentElement=i,this.changed=new Ze,this.explicitSegmentsVisible=!1,this.visibleSegmentsGeneration=-1,this.queryResult=new dt(void 0),this.statusText=new dt(""),this.selectedMatches=0,this.matchStatusTextPrefix="",this.debouncedUpdate=rt(()=>this.update(),0),this.render=s=>{const a=this.explicitSegments;let l,c=!1;if(a!==void 0&&s<a.length)l=a[s],c=this.explicitSegmentsVisible;else{a!==void 0&&(s-=a.length),l=N6;const h=this.queryResult.value.indices[s],g=this.segmentPropertyMap.segmentPropertyMap.inlineProperties.ids;l.low=g[h*2],l.high=g[h*2+1]}const u=this.segmentWidgetFactory.get(l);return c&&(u.dataset.visibleList="true"),u},this.update(),this.registerDisposer(r.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(e.changed.add(this.debouncedUpdate))}get numMatches(){var e,t;return(t=(e=this.queryResult.value)===null||e===void 0?void 0:e.count)!==null&&t!==void 0?t:0}update(){var e;const t=this.query.value,r=this.segmentPropertyMap,i=this.queryResult.value;let s;if(this.prevQuery===t)s=i;else{const w=iW(r,t);s=sW(r,w)}const a=[];let l=!1,c="";const u=this.segmentationDisplayState.segmentationGroupState.value.visibleSegments,h=u.changed.count,g=this.visibleSegmentsGeneration,v=cW(s.query);if(v){if(g!==h||this.explicitSegments===void 0||!this.explicitSegmentsVisible){this.visibleSegmentsGeneration=h;const w=Te(u,k=>k.clone());w.sort(te.compare);const E=this.explicitSegments;E===void 0?(this.explicitSegments=w,a.push({retainCount:0,insertCount:w.length,deleteCount:0})):a.push(...gN(E,w,te.compare)),this.explicitSegments=w,l=!0}else a.push({retainCount:this.explicitSegments.length,deleteCount:0,insertCount:0});this.explicitSegmentsVisible=!0}else this.visibleSegmentsGeneration=h,this.explicitSegments!==void 0&&this.explicitSegmentsVisible&&(a.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,l=!0),this.explicitSegmentsVisible=!1;var y=s;const C=y.explicitIds;if(C!==void 0?this.explicitSegments=C:this.explicitSegmentsVisible||(this.explicitSegments=void 0),i!==s&&(a.push({retainCount:0,deleteCount:(e=i?.count)!==null&&e!==void 0?e:0,insertCount:s.count}),l=!0,this.queryResult.value=s),s.explicitIds!==void 0?c=`${s.count} ids`:v?c=`${s.count} listed ids`:s.total>0&&(c=`${s.count}/${s.total} matches`),i!==s||h!==g){let w=c,E=0;r!==void 0&&s.count>0&&(E=dW(r,s,u),w+=` (${E} visible)`),this.selectedMatches=E,this.statusText.value=w}this.prevQuery=t,this.matchStatusTextPrefix=c;const S=this.explicitSegments;this.length=(this.explicitSegmentsVisible?S.length:0)+s.count,l&&this.changed.dispatch(a)}updateRendering(e){this.segmentWidgetFactory.update(e)}updateRenderedItems(e){e.forEachRenderedItem(t=>{this.updateRendering(t)})}}const $E=at.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}}),O6=100;function AD(n){_n(n,Math.max(1,n.value.length+.1))}function Zf(n,e){let t;if(Nn(e))t=e.toString();else{const r=e.toString(),i=e.toPrecision(6);t=r.length<i.length?r:i}n.value=t,AD(n)}function B6(n,e){const t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add(`neuroglancer-segment-query-result-numerical-plot-${n}-bound`),t.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=(e===0?"Lower":"Upper")+" bound "+(n==="range"?"range":"for distribution"),t.addEventListener("input",()=>{AD(t)}),t}function F6(n,e,t){if(n===void 0||n.indices===void 0)return;const r=n.query;let i=r.sortBy,s=r.includeColumns;Cy(r,t)?(i=i.filter(a=>a.fieldId!==t),s=s.filter(a=>a!==t)):s.push(t),e(j(j({},r),{sortBy:i,includeColumns:s}))}function ND(n,e,t){var r;const i=n?.query,s=i?.sortBy;if(s===void 0)return;const a=i.includeColumns,l=((r=s.find(u=>u.fieldId===t))===null||r===void 0?void 0:r.order)==="<"?">":"<",c=a.filter(u=>u!==t);for(const u of s)u.fieldId!=="id"&&u.fieldId!=="label"&&u.fieldId!==t&&c.push(u.fieldId);e(j(j({},i),{sortBy:[{fieldId:t,order:l}],includeColumns:c}))}function VD(n,e,t){var r,i;const s=(r=n?.query)===null||r===void 0?void 0:r.sortBy,a=(i=s?.find(l=>l.fieldId===t))===null||i===void 0?void 0:i.order;e.textContent=a===">"?"▼":"▲",e.style.visibility=a===void 0?"":"visible",e.title=`Sort by ${t} in ${a==="<"?"descending":"ascending"} order`}class _6 extends K{constructor(e,t,r){super(),this.segmentPropertyMap=e,this.queryResult=t,this.setQuery=r,this.propertyHistograms=[],this.bounds={window:new dt([]),range:new dt([])},this.throttledUpdate=this.registerCancellable(hh(()=>this.updateHistograms(),100)),this.debouncedRender=this.registerCancellable(ct(()=>this.updateHistogramRenderings())),this.debouncedSetQuery=this.registerCancellable(rt(()=>this.setQueryFromBounds(),200));const i=e?.numericalProperties,s=[];let a;if(i!==void 0&&i.length>0){a=document.createElement("details");const l=document.createElement("summary");l.textContent=`${i.length} numerical propert${i.length>1?"ies":"y"}`,a.appendChild(l),a.classList.add("neuroglancer-segment-query-result-numerical-list");const c=this.bounds.window.value;for(let u=0,h=i.length;u<h;++u){const g=i[u],v=this.makeNumericalPropertySummary(u,g);s.push(v),a.appendChild(v.element),c[u]=g.bounds}}this.listElement=a,this.properties=s,this.registerDisposer(this.queryResult.changed.add(()=>{this.handleNewQueryResult()})),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){const e=this.queryResult.value;if(e===void 0||e.indices===void 0)return;const t=e.query,r=[],i=this.bounds.range.value,s=this.properties;for(let a=0,l=s.length;a<l;++a){const c=s[a].property;r.push({fieldId:c.id,bounds:i[a]})}this.setQuery(j(j({},t),{numericalConstraints:r}))}getBounds(e){const t=this.bounds;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){const r=this.properties[e].property;let i=_l(r.bounds,t.range);cr(i[0],i[1])>0&&(i=[i[1],i[0]]);const s=_l(r.bounds,t.window),a=this.getBounds(e),l=this.properties[e].property.dataType;xi(l,s,a.window)||(this.bounds.window.value[e]=s,this.bounds.window.changed.dispatch()),xi(l,i,a.range)||(this.bounds.range.value[e]=i,this.bounds.range.changed.dispatch())}setBound(e,t,r,i){const s=this.segmentPropertyMap.numericalProperties[r].bounds;i=ql(s,i);const a=this.getBounds(r),l=Au(a,e,t,i,!0);this.setBounds(r,l)}handleNewQueryResult(){const e=this.queryResult.value;if(this.listElement!==void 0){if(e?.indices!==void 0){const t=e.query.numericalConstraints,r=this.segmentPropertyMap.numericalProperties,i=this.bounds.range.value,s=t.length,a=r.length;i.length=a;for(let l=0;l<a;++l)i[l]=r[l].bounds;for(let l=0;l<s;++l){const c=t[l],u=r.findIndex(h=>h.id===c.fieldId);i[u]=c.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){const e=this.queryResult.value;this.listElement!==void 0&&(oW(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();const e=this.listElement;if(e===void 0)return;const t=this.propertyHistograms;if(t.length===0){e.style.display="none";return}e.style.display="";const r=this.properties;for(let i=0,s=r.length;i<s;++i)this.updateNumericalPropertySummary(i,r[i],t[i])}makeNumericalPropertySummary(e,t){const r=document.createElement("div");r.classList.add("neuroglancer-segment-query-result-numerical-plot-container");const i=document.createElement("img");i.classList.add("neuroglancer-segment-query-result-numerical-plot");const s=new PD(i,t.dataType,()=>this.getBounds(e),h=>this.setBounds(e,h)),a=document.createElement("span");a.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");const l=document.createElement("input");l.type="checkbox",l.addEventListener("click",()=>{F6(this.queryResult.value,this.setQuery,t.id)});const c=h=>{const g=document.createElement("div");g.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),g.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${h}`);const v=S=>{const w=B6(h,S);return w.addEventListener("change",()=>{if(this.bounds[h].value[e]!==void 0){try{const E=vd(t.dataType,w.value);this.setBound(h,S,e,E),this.bounds[h].changed.dispatch()}catch{}Zf(w,this.bounds[h].value[e][S])}}),w},y=[v(0),v(1)];let C;if(h==="range"){C=[document.createElement("div"),document.createElement("div"),document.createElement("div")],C[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),C[1].appendChild(l);const S=document.createElement("span");S.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),S.appendChild(document.createTextNode(t.id)),S.appendChild(a),S.addEventListener("click",()=>{ND(this.queryResult.value,this.setQuery,t.id)}),C[1].appendChild(S);const w=t.description;w&&(C[1].title=w),g.appendChild(C[0]),g.appendChild(y[0]);const E=document.createElement("div");E.textContent="≤",E.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),g.appendChild(E),g.appendChild(C[1]);const k=document.createElement("div");k.textContent="≤",k.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),g.appendChild(k),g.appendChild(y[1]),g.appendChild(C[2])}else g.appendChild(y[0]),g.appendChild(y[1]);return{container:g,spacers:C,inputs:y}},u={range:c("range"),window:c("window")};return r.appendChild(u.range.container),r.appendChild(i),r.appendChild(u.window.container),{property:t,controller:s,element:r,plotImg:i,boundElements:u,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:l,sortIcon:a}}updateNumericalPropertySummary(e,t,r){const i=t.bounds.window,s=this.bounds.window.value[e],a=t.bounds.range,l=this.bounds.range.value[e],c=t.property,u=this.queryResult.value,h=Cy(u?.query,c.id);if(t.columnCheckbox.checked=h,t.columnCheckbox.title=h?"Remove column from result table":"Add column to result table",VD(u,t.sortIcon,c.id),t.propertyHistogram===r&&xi(c.dataType,i,s)&&xi(c.dataType,a,l))return;const g=r.histogram,v="http://www.w3.org/2000/svg",y=document.createElementNS(v,"svg");y.setAttribute("width","1"),y.setAttribute("height","1"),y.setAttribute("preserveAspectRatio","none");const C=document.createElementNS(v,"rect"),S=nr(s,l[0]),w=nr(s,l[1]);C.setAttribute("x",`${S}`),C.setAttribute("y","0"),C.setAttribute("width",`${w-S}`),C.setAttribute("height","1"),C.setAttribute("fill","#4f4f4f"),y.appendChild(C);const E=g.length,k=(B,_,H)=>{const U=document.createElementNS(v,"polyline");let O="",z=0;for(let le=B;le<H;++le)z+=g[le];if(z===0)return;const F=nr(s,r.window[0]),se=nr(s,r.window[1]),oe=(le,Se)=>{const ne=le/(E-2),he=F*(1-ne)+se*ne;O+=` ${he},${1-Se}`};B!==0&&oe(B,0);let Re=0;for(let le=B;le<_;++le){const Se=g[le];Re+=Se,oe(le,Re/z)}return U.setAttribute("fill","none"),U.setAttribute("stroke-width","1px"),U.setAttribute("points",O),U.setAttribute("vector-effect","non-scaling-stroke"),U};{const B=k(0,E-1,E);B!==void 0&&(B.setAttribute("stroke","cyan"),y.appendChild(B))}if(!xi(c.dataType,c.bounds,l)){const B=Math.floor(Math.max(0,Math.min(1,nr(r.window,l[0])))*(E-2)),_=Math.ceil(Math.max(0,Math.min(1,nr(r.window,l[1])))*(E-2)),H=k(B,_,_);H!==void 0&&(H.setAttribute("stroke","white"),y.appendChild(H))}const P=new XMLSerializer().serializeToString(y);t.plotImg.src=`data:image/svg+xml;base64,${btoa(P)}`,t.propertyHistogram=r;for(let B=0;B<2;++B)i[B]=s[B],Zf(t.boundElements.window.inputs[B],s[B]),a[B]=l[B],Zf(t.boundElements.range.inputs[B],l[B]);const D=t.boundElements.range.spacers,L=_l(s,l),R=ou(c.dataType,s),M=nr(s,L[0])*R,V=nr(s,L[1])*R+(1-R);D[0].style.width=`${M*100}%`,D[2].style.width=`${(1-V)*100}%`}}function U6(n,e){const t=n.tags;if(t===void 0||t.length===0)return;const r=n.query,i=document.createElement("div");i.classList.add("neuroglancer-segment-query-result-tag-list");for(const s of t){const a=s.tag,l=s.count,c=document.createElement("div");c.classList.add("neuroglancer-segment-query-result-tag");const u=document.createElement("span");u.classList.add("neuroglancer-segment-query-result-tag-name"),u.textContent=a,i.appendChild(c);const h=r.includeTags.includes(a),g=r.excludeTags.includes(a);let v;h?v="Remove tag from required set":g?v="Remove tag from excluded set":v="Add tag to required set",u.addEventListener("click",()=>{e(xE(r,a,!0,!h&&!g))}),u.title=v;const y=h||g,C=w=>{const E=w?l:n.count-l,k=document.createElement("div");if(k.classList.add("neuroglancer-segment-query-result-tag-toggle"),k.classList.add(`neuroglancer-segment-query-result-tag-${w?"include":"exclude"}`),c.appendChild(k),!y&&E===0)return;const P=w?h:g;k.appendChild(new Gr({get value(){return P},set value(D){e(xE(r,a,w,D))},changed:qT},{text:w?"+":"-",enableTitle:`Add tag to ${w?"required":"exclusion"} set`,disableTitle:`Remove tag from ${w?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};C(!0),C(!1),c.appendChild(u);const S=document.createElement("span");S.classList.add("neuroglancer-segment-query-result-tag-count"),y||(S.textContent=l.toString()),c.appendChild(S)}return i}class $6 extends Fi{constructor(e){super(),this.layer=e;const t=this.element;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new Qr(e.displayState.segmentationGroupState.value.graph,(c,u,h)=>{if(c===void 0)return;const g=document.createElement("div");g.className="neuroglancer-segmentation-toolbox",g.appendChild(Uf(h,e,{toolJson:My,label:"Merge",title:"Merge segments"})),g.appendChild(Uf(h,e,{toolJson:Ay,label:"Split",title:"Split segments"})),u.appendChild(g)})).element);const r=document.createElement("div");r.className="neuroglancer-segmentation-toolbox",r.appendChild(Uf(this,e,{toolJson:Ny,label:"Select",title:"Select/Deselect segments"})),t.appendChild(r);const i=document.createElement("input");i.classList.add("neuroglancer-segment-list-query"),i.addEventListener("focus",()=>{i.select()});const s=this.registerDisposer(new Nr(i,$E));s.allShortcutsAreGlobal=!0;const a=this.layer.displayState.segmentQuery,l=this.registerCancellable(rt(()=>{a.value=i.value},200));i.autocomplete="off",i.title=$E.describe(),i.spellcheck=!1,i.placeholder="Enter ID, name prefix or /regexp",this.registerDisposer(ki(c=>{i.value=c},a)),this.registerDisposer(ki(c=>{Date.now()-c<100&&(setTimeout(()=>{i.focus()},0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)},this.layer.segmentQueryFocusTime)),t.appendChild(i),t.appendChild(this.registerDisposer(new Qr(e.displayState.segmentPropertyMap,(c,u,h)=>{const g=le=>{i.focus(),i.select();const Se=lW(c,le);document.execCommand("insertText",!1,Se),a.value=Se,i.select()},v=h.registerDisposer(new V6(a,c,e.displayState,u)),y=e.displayState.segmentationGroupState.value,C=document.createElement("ul");C.classList.add("neuroglancer-segment-query-errors"),u.appendChild(C);const S=document.createElement("div");S.classList.add("neuroglancer-segment-query-result-statistics");const w=document.createElement("span"),E=document.createElement("input");E.type="checkbox",E.checked=!0,E.title="Deselect all segment IDs",E.addEventListener("change",()=>{y.visibleSegments.clear()});const k=Zr({title:"Copy visible segment IDs",onClick:()=>{const le=Te(y.visibleSegments,Se=>Se.clone());le.sort(te.compare),Yn(le.join(", "))}}),P=document.createElement("span");w.appendChild(k),w.appendChild(E),w.appendChild(P);const D=document.createElement("span"),L=document.createElement("input"),R=Zr({onClick:()=>{l(),l.flush(),v.debouncedUpdate.flush();const le=v.queryResult.value;if(le===void 0)return;const Se=new Array(le.count);Xc(c,le,(ne,he)=>{Se[he]=ne.toString()}),Yn(Se.join(", "))}});L.type="checkbox";const M=()=>{l(),l.flush(),v.debouncedUpdate.flush();const le=v.queryResult.value;if(le===void 0)return;const Se=y.visibleSegments,ne=v.selectedMatches,he=ne!==le.count;if(he&&le.count-ne>O6){if(!U)return U=!0,V.textContent=`Confirm: show ${le.count-ne} segments?`,!1;U=!1,H()}return Xc(c,le,Le=>{Se.set(Le,he)}),!0};L.addEventListener("click",le=>{M()||le.preventDefault()});const V=document.createElement("span");D.appendChild(R),D.appendChild(L),D.appendChild(V),w.classList.add("neuroglancer-segment-list-status"),D.classList.add("neuroglancer-segment-list-status"),u.appendChild(S);const B=document.createElement("div");B.classList.add("neuroglancer-segment-query-result-statistics-separator"),u.appendChild(B),u.appendChild(D),u.appendChild(w);let _=-1;const H=()=>{const le=y.visibleSegments.size;_!==le&&(_=le,P.textContent=`${le} visible in total`,E.checked=le>0,E.style.visibility=le?"visible":"hidden",k.style.visibility=le?"visible":"hidden"),V.textContent=v.statusText.value;const Se=v.numMatches,ne=v.selectedMatches;R.style.visibility=Se?"visible":"hidden",R.title=`Copy ${Se} segment ID(s)`,L.style.visibility=Se?"visible":"hidden",ne===0?(L.checked=!1,L.indeterminate=!1,L.title=`Show ${Se} segment ID(s)`):ne===Se?(L.checked=!0,L.indeterminate=!1,L.title=`Hide ${ne} segment ID(s)`):(L.checked=!0,L.indeterminate=!0,L.title=`Show ${Se-ne} segment ID(s)`)};H(),v.statusText.changed.add(H),h.registerDisposer(y.visibleSegments.changed.add(H));let U=!1;h.registerEventListener(i,"input",()=>{l(),U&&(U=!1,H())}),h.registerDisposer(ve(i,"cancel",()=>{i.focus(),i.select(),document.execCommand("delete"),i.blur(),i.value="",a.value="",U=!1,H()})),h.registerDisposer(ve(i,"toggle-listed",M)),h.registerDisposer(ve(i,"hide-all",()=>{y.visibleSegments.clear()})),h.registerDisposer(ve(i,"hide-listed",()=>{l(),l.flush(),v.debouncedUpdate.flush();const le=y.visibleSegments;if(a.value==="")le.clear();else{const Se=v.queryResult.value;if(Se===void 0)return;Xc(c,Se,ne=>{le.delete(ne)})}}));const O=h.registerDisposer(new ly({source:v,horizontalScroll:!0})),z=h.registerCancellable(ct(()=>{v.updateRenderedItems(O)})),F=this.layer.displayState;h.registerDisposer(F.segmentSelectionState.changed.add(z)),h.registerDisposer(y.visibleSegments.changed.add(z)),h.registerDisposer(F.segmentColorHash.changed.add(z)),h.registerDisposer(F.segmentStatedColors.changed.add(z)),h.registerDisposer(F.segmentDefaultColor.changed.add(z)),O.element.classList.add("neuroglancer-segment-list"),h.registerDisposer(e.bindSegmentListWidth(O.element)),h.registerDisposer(new Bi(O.element,vh()));const se=h.registerDisposer(new _6(c,v.queryResult,g));{const le=se.listElement;le!==void 0&&S.appendChild(le)}let oe;const Re=le=>{const Se=le?.errors;if(Xe(C),Se!==void 0)for(const ne of Se){const he=document.createElement("li");he.textContent=ne.message,C.appendChild(he)}};ki(le=>{if(v.segmentWidgetFactory=new EU(v.segmentationDisplayState,v.parentElement,ne=>Cy(le?.query,ne.id)),O.scrollToTop(),Xe(O.header),c!==void 0){const ne=v.segmentWidgetFactory.getHeader();ne.container.classList.add("neuroglancer-segment-list-header");for(const he of ne.propertyLabels){const Le=he.label,_e=he.sortIcon,Ge=he.id;Le.addEventListener("click",()=>{ND(v.queryResult.value,g,Ge)}),VD(le,_e,Ge)}O.header.appendChild(ne.container)}if(Re(le),B.style.display="none",oe?.remove(),le===void 0)return;let Se=le.query;Se.errors!==void 0||Se.ids!==void 0||(oe=U6(le,g),oe!==void 0&&S.appendChild(oe),(se.properties.length>0||oe!==void 0)&&(B.style.display=""))},v.queryResult),u.appendChild(O.element)})).element)}}function Vy(n={}){return ft(j({text:"?"},n))}function OD(n,e,t,r){const i=document.createElement("label");i.classList.add("neuroglancer-layer-control-container");const s=document.createElement("div");s.classList.add("neuroglancer-layer-control-label-container");const a=document.createElement("div");a.classList.add("neuroglancer-layer-control-label"),s.appendChild(a);const l=document.createElement("div");l.classList.add("neuroglancer-layer-control-label-text-container"),l.appendChild(document.createTextNode(t.label)),a.appendChild(l),t.title&&(a.title=t.title),i.appendChild(s);var c=t.makeControl(e,n,{labelContainer:s,labelTextContainer:l,display:e.manager.root.display,visibility:r});const u=c.control,h=c.controlElement;return h.classList.add("neuroglancer-layer-control-control"),i.appendChild(h),{controlContainer:i,label:a,labelContainer:s,labelTextContainer:l,control:u}}class BD extends To{constructor(e,t){super(e),this.options=t}activate(e){const t=this.options,r=this.layer,i=t.isValid;if(i!==void 0&&!i(r).value)return;var s=wh(e);const a=s.header,l=s.body;var c=OD(e,r,t,new Nt(Nt.VISIBLE));const u=c.controlContainer,h=c.control,g=c.labelContainer;a.appendChild(g),l.appendChild(u),t.activateTool(e,h)}get description(){var e;const t=this.options;return(e=t.toolDescription)!==null&&e!==void 0?e:t.label}toJSON(){return this.options.toolJson}}function zE(n,e,t,r){var i=OD(n,e,t,r);const s=i.controlContainer,a=i.label;return s.classList.add("neuroglancer-layer-options-control-container"),a.prepend(n.registerDisposer(new K2(e,t.toolJson)).element),s}function Oy(n,e,t,r){const i=r.isValid;return i===void 0?zE(n,e,r,t):n.registerDisposer(new Qr(i(e),(s,a,l)=>{s&&a.appendChild(zE(l,e,r,t))},t)).element}function FD(n,e){const t=e.toolJson,r=typeof t=="string"?t:t.type;od(n,r,i=>new BD(i,e))}class GE extends K{constructor(e){super(),this.group=e,this.element=document.createElement("div"),this.topRow=document.createElement("div"),this.label=document.createElement("label"),this.selectElement=document.createElement("select"),this.linkedLayers=document.createElement("div"),this.unlinkButton=document.createElement("button");const t=this.element,r=this.label,i=this.topRow,s=this.selectElement,a=this.linkedLayers,l=this.unlinkButton;i.appendChild(r),i.appendChild(s),i.appendChild(l),l.textContent="Unlink",l.addEventListener("click",()=>{this.group.isolate()}),t.appendChild(i),t.appendChild(a),this.updateView();const c=rt(()=>this.updateView(),0);this.registerEventListener(s,"change",()=>{this.updateModel(),c()}),this.registerDisposer(this.group.changed.add(c)),this.registerDisposer(this.group.linkedLayersChanged.add(c)),this.registerDisposer(this.group.layerManager.layersChanged.add(c))}updateModel(){const e=this.selectElement.value;e===""&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){var e;const t=this.selectElement,r=this.group,i=r.predicate;Xe(t);const s=this.group.rootGroup.linkedLayers.size!==0;this.unlinkButton.style.display=s?"":"none";const a=this.linkedLayers,l=r.linkedLayers.size!==0;if(a.style.display=l?"":"none",this.unlinkButton.textContent=l?"Unlink all":"Unlink",l){this.element.style.display="",t.style.display="none",Xe(a);for(const c of r.linkedLayers){const u=document.createElement("div");u.classList.add("neuroglancer-linked-layer-widget-layer");const h=Zv({title:"Unlink layer",onClick:()=>{this.group.getGroup(c).isolate()}});u.appendChild(h),u.appendChild(document.createTextNode(c.managedLayer.name)),a.appendChild(u)}}else{t.style.display="";const c=document.createElement("option");t.appendChild(c);let u=0;for(const h of this.group.layerManager.managedLayers){const g=h.layer;if(g!==null&&g!==r.layer&&i(g)){++u;const v=document.createElement("option"),y=h.name;v.textContent=y,v.value=y,t.appendChild(v)}}t.value=(e=r.toJSON())!==null&&e!==void 0?e:"",this.element.style.display=u===0?"none":""}}}const z6="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='maximiseIconTitle'%3e%3ctitle%20id='maximiseIconTitle'%3eMaximise%20View%3c/title%3e%3cpolyline%20points='21%2016%2021%2021%2016%2021'/%3e%3cpolyline%20points='8%2021%203%2021%203%2016'/%3e%3cpolyline%20points='16%203%2021%203%2021%208'/%3e%3cpolyline%20points='3%208%203%203%208%203'/%3e%3c/svg%3e";function By(n={}){return ft(j({svg:z6},n))}var G6={exports:{}},WE;function W6(){return WE||(WE=1,(function(n,e){(function(t){t(Go())})(function(t){var r="CodeMirror-lint-markers",i="CodeMirror-lint-line-";function s(M,V,B){var _=document.createElement("div");_.className="CodeMirror-lint-tooltip cm-s-"+M.options.theme,_.appendChild(B.cloneNode(!0)),M.state.lint.options.selfContain?M.getWrapperElement().appendChild(_):document.body.appendChild(_);function H(U){if(!_.parentNode)return t.off(document,"mousemove",H);var O=Math.max(0,U.clientY-_.offsetHeight-5),z=Math.max(0,Math.min(U.clientX+5,_.ownerDocument.defaultView.innerWidth-_.offsetWidth));_.style.top=O+"px",_.style.left=z+"px"}return t.on(document,"mousemove",H),H(V),_.style.opacity!=null&&(_.style.opacity=1),_}function a(M){M.parentNode&&M.parentNode.removeChild(M)}function l(M){M.parentNode&&(M.style.opacity==null&&a(M),M.style.opacity=0,setTimeout(function(){a(M)},600))}function c(M,V,B,_){var H=s(M,V,B);function U(){t.off(_,"mouseout",U),H&&(l(H),H=null)}var O=setInterval(function(){if(H)for(var z=_;;z=z.parentNode){if(z&&z.nodeType==11&&(z=z.host),z==document.body)return;if(!z){U();break}}if(!H)return clearInterval(O)},400);t.on(_,"mouseout",U)}function u(M,V,B){this.marked=[],V instanceof Function&&(V={getAnnotations:V}),(!V||V===!0)&&(V={}),this.options={},this.linterOptions=V.options||{};for(var _ in h)this.options[_]=h[_];for(var _ in V)h.hasOwnProperty(_)?V[_]!=null&&(this.options[_]=V[_]):V.options||(this.linterOptions[_]=V[_]);this.timeout=null,this.hasGutter=B,this.onMouseOver=function(H){R(M,H)},this.waitingFor=0}var h={highlightLines:!1,tooltips:!0,delay:500,lintOnChange:!0,getAnnotations:null,async:!1,selfContain:null,formatAnnotation:null,onUpdateLinting:null};function g(M){var V=M.state.lint;V.hasGutter&&M.clearGutter(r),V.options.highlightLines&&v(M);for(var B=0;B<V.marked.length;++B)V.marked[B].clear();V.marked.length=0}function v(M){M.eachLine(function(V){var B=V.wrapClass&&/\bCodeMirror-lint-line-\w+\b/.exec(V.wrapClass);B&&M.removeLineClass(V,"wrap",B[0])})}function y(M,V,B,_,H){var U=document.createElement("div"),O=U;return U.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+B,_&&(O=U.appendChild(document.createElement("div")),O.className="CodeMirror-lint-marker CodeMirror-lint-marker-multiple"),H!=!1&&t.on(O,"mouseover",function(z){c(M,z,V,O)}),U}function C(M,V){return M=="error"?M:V}function S(M){for(var V=[],B=0;B<M.length;++B){var _=M[B],H=_.from.line;(V[H]||(V[H]=[])).push(_)}return V}function w(M){var V=M.severity;V||(V="error");var B=document.createElement("div");return B.className="CodeMirror-lint-message CodeMirror-lint-message-"+V,typeof M.messageHTML<"u"?B.innerHTML=M.messageHTML:B.appendChild(document.createTextNode(M.message)),B}function E(M,V){var B=M.state.lint,_=++B.waitingFor;function H(){_=-1,M.off("change",H)}M.on("change",H),V(M.getValue(),function(U,O){M.off("change",H),B.waitingFor==_&&(O&&U instanceof t&&(U=O),M.operation(function(){P(M,U)}))},B.linterOptions,M)}function k(M){var V=M.state.lint;if(V){var B=V.options,_=B.getAnnotations||M.getHelper(t.Pos(0,0),"lint");if(_)if(B.async||_.async)E(M,_);else{var H=_(M.getValue(),V.linterOptions,M);if(!H)return;H.then?H.then(function(U){M.operation(function(){P(M,U)})}):M.operation(function(){P(M,H)})}}}function P(M,V){var B=M.state.lint;if(B){var _=B.options;g(M);for(var H=S(V),U=0;U<H.length;++U){var O=H[U];if(O){for(var z=null,F=B.hasGutter&&document.createDocumentFragment(),se=0;se<O.length;++se){var oe=O[se],Re=oe.severity;Re||(Re="error"),z=C(z,Re),_.formatAnnotation&&(oe=_.formatAnnotation(oe)),B.hasGutter&&F.appendChild(w(oe)),oe.to&&B.marked.push(M.markText(oe.from,oe.to,{className:"CodeMirror-lint-mark CodeMirror-lint-mark-"+Re,__annotation:oe}))}B.hasGutter&&M.setGutterMarker(U,r,y(M,F,z,O.length>1,_.tooltips)),_.highlightLines&&M.addLineClass(U,"wrap",i+z)}}_.onUpdateLinting&&_.onUpdateLinting(V,H,M)}}function D(M){var V=M.state.lint;V&&(clearTimeout(V.timeout),V.timeout=setTimeout(function(){k(M)},V.options.delay))}function L(M,V,B){for(var _=B.target||B.srcElement,H=document.createDocumentFragment(),U=0;U<V.length;U++){var O=V[U];H.appendChild(w(O))}c(M,B,H,_)}function R(M,V){var B=V.target||V.srcElement;if(/\bCodeMirror-lint-mark-/.test(B.className)){for(var _=B.getBoundingClientRect(),H=(_.left+_.right)/2,U=(_.top+_.bottom)/2,O=M.findMarksAt(M.coordsChar({left:H,top:U},"client")),z=[],F=0;F<O.length;++F){var se=O[F].__annotation;se&&z.push(se)}z.length&&L(M,z,V)}}t.defineOption("lint",!1,function(M,V,B){if(B&&B!=t.Init&&(g(M),M.state.lint.options.lintOnChange!==!1&&M.off("change",D),t.off(M.getWrapperElement(),"mouseover",M.state.lint.onMouseOver),clearTimeout(M.state.lint.timeout),delete M.state.lint),V){for(var _=M.getOption("gutters"),H=!1,U=0;U<_.length;++U)_[U]==r&&(H=!0);var O=M.state.lint=new u(M,V,H);O.options.lintOnChange&&M.on("change",D),O.options.tooltips!=!1&&O.options.tooltips!="gutter"&&t.on(M.getWrapperElement(),"mouseover",O.onMouseOver),k(M)}}),t.defineExtension("performLint",function(){k(this)})})})()),G6.exports}W6();var jE,HE;function j6(){return HE||(HE=1,jE=function(n){n.defineMode("glsl",function(s,a){var l=s.indentUnit,c=a.keywords||e(t),u=a.builtins||e(r),h=a.blockKeywords||e("case do else for if switch while struct"),g=a.atoms||e("null"),v=a.hooks||{},y=a.multiLineStrings,C=/[+\-*&%=<>!?|\/]/,S;function w(R,M){var V=R.next();if(v[V]){var B=v[V](R,M);if(B!==!1)return B}if(V=='"'||V=="'")return M.tokenize=E(V),M.tokenize(R,M);if(/[\[\]{}\(\),;\:\.]/.test(V))return S=V,"bracket";if(/\d/.test(V))return R.eatWhile(/[\w\.]/),"number";if(V=="/"){if(R.eat("*"))return M.tokenize=k,k(R,M);if(R.eat("/"))return R.skipToEnd(),"comment"}if(V=="#")return R.eatWhile(/[\S]+/),R.eatWhile(/[\s]+/),R.eatWhile(/[\S]+/),R.eatWhile(/[\s]+/),"comment";if(C.test(V))return R.eatWhile(C),"operator";R.eatWhile(/[\w\$_]/);var _=R.current();return c.propertyIsEnumerable(_)?(h.propertyIsEnumerable(_)&&(S="newstatement"),"keyword"):u.propertyIsEnumerable(_)?"builtin":g.propertyIsEnumerable(_)?"atom":"word"}function E(R){return function(M,V){for(var B=!1,_,H=!1;(_=M.next())!=null;){if(_==R&&!B){H=!0;break}B=!B&&_=="\\"}return(H||!(B||y))&&(V.tokenize=w),"string"}}function k(R,M){for(var V=!1,B;B=R.next();){if(B=="/"&&V){M.tokenize=w;break}V=B=="*"}return"comment"}function P(R,M,V,B,_){this.indented=R,this.column=M,this.type=V,this.align=B,this.prev=_}function D(R,M,V){return R.context=new P(R.indented,M,V,null,R.context)}function L(R){var M=R.context.type;return(M==")"||M=="]"||M=="}")&&(R.indented=R.context.indented),R.context=R.context.prev}return{startState:function(R){return{tokenize:null,context:new P((R||0)-l,0,"top",!1),indented:0,startOfLine:!0}},token:function(R,M){var V=M.context;if(R.sol()&&(V.align==null&&(V.align=!1),M.indented=R.indentation(),M.startOfLine=!0),R.eatSpace())return null;S=null;var B=(M.tokenize||w)(R,M);if(B=="comment"||B=="meta")return B;if(V.align==null&&(V.align=!0),(S==";"||S==":")&&V.type=="statement")L(M);else if(S=="{")D(M,R.column(),"}");else if(S=="[")D(M,R.column(),"]");else if(S=="(")D(M,R.column(),")");else if(S=="}"){for(;V.type=="statement";)V=L(M);for(V.type=="}"&&(V=L(M));V.type=="statement";)V=L(M)}else S==V.type?L(M):(V.type=="}"||V.type=="top"||V.type=="statement"&&S=="newstatement")&&D(M,R.column(),"statement");return M.startOfLine=!1,B},indent:function(R,M){if(R.tokenize!=w&&R.tokenize!=null)return 0;var V=M&&M.charAt(0),B=R.context,_=V==B.type;return B.type=="statement"?B.indented+(V=="{"?0:l):B.align?B.column+(_?0:1):B.indented+(_?0:l)},electricChars:"{}"}});function e(s){for(var a={},l=s.split(" "),c=0;c<l.length;++c)a[l[c]]=!0;return a}var t="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor",r="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod require export";function i(s,a){return a.startOfLine?(s.skipToEnd(),"meta"):!1}(function(){n.defineMIME("text/x-glsl",{name:"glsl",keywords:e(t),builtins:e(r),blockKeywords:e("case do else for if switch while struct"),atoms:e("null"),hooks:{"#":i}})})()}),jE}var H6=j6();const q6=Qe(H6);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */q6(ls);const J6=500;class Fy extends K{constructor(e){super(),this.state=e,this.changingValue=!1,this.debouncedValueUpdater=rt(()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}},J6),this.textEditor=ls(i=>{},{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",()=>{this.setValidState(void 0),this.debouncedValueUpdater()}),this.registerDisposer(this.state.fragmentMain.changed.add(()=>{this.changingValue||this.textEditor.setValue(this.state.fragmentMain.value)})),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add(()=>{this.updateErrorState()}));const t=this.state.shaderControlState;t!==void 0&&this.registerDisposer(t.parseErrors.changed.add(()=>{this.updateErrorState()})),this.updateErrorState();const r=new IntersectionObserver(i=>{i.some(s=>s.isIntersecting)&&this.textEditor.refresh()},{root:document.body});r.observe(this.element),this.registerDisposer(()=>r.disconnect())}get element(){return this.textEditor.getWrapperElement()}updateErrorState(){var e=this.state.sourceStringNumber;const t=e===void 0?1:e,r=this.state.shaderError.value;let i;const s=this.state.shaderControlState;s!==void 0?i=s.parseErrors.value:i=[],r===void 0&&i.length===0?this.setValidState(void 0):r!=null||i.length!==0?(this.textEditor.setOption("lint",{getAnnotations:()=>{const a=[];for(const l of i)a.push({message:l.message,severity:"error",from:ls.Pos(l.line)});if(r!=null)if(r.name==="ShaderCompilationError")for(const l of r.errorMessages)a.push({message:l.message,severity:"error",from:ls.Pos(l.file===t&&l.line||0)});else r.name==="ShaderLinkError"?a.push({message:r.log,severity:"error",from:ls.Pos(0)}):a.push({message:r.message,severity:"error",from:ls.Pos(0)});return a}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){let t=this.element;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),e===!0?t.classList.add("valid-input"):e===!1&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,Et(this.element),this.textEditor=void 0,super.disposed()}}const Y6=at.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function X6(n){return{makeControl:(e,t,r)=>{var i=n(e);const s=i.watchableValue,a=i.channelCoordinateSpaceCombiner,l=i.dataType,c=i.defaultChannel,u=i.histogramSpecifications,h=i.legendShaderOptions,g=i.histogramIndex;if(a!==void 0&&c.length!==0){const y=t.registerDisposer(new Hs(a.combined)),C=t.registerDisposer(new Ih(y,a,{copyButton:!1}));t.registerDisposer(y.changed.add(()=>{const w=y.value,E=Te(w,P=>Math.floor(P)),k=s.value;Oe(k.channel,E)||(s.value=j(j({},s.value),{channel:E}))}));const S=()=>{const w=y.value,E=s.value;Oe(w,E.channel)||(w.set(E.channel),y.changed.dispatch())};S(),t.registerDisposer(s.changed.add(S)),r.labelContainer.appendChild(C.element)}const v=t.registerDisposer(new T6(r.visibility,r.display,l,s,u,g,c.length===0?h:void 0));return{control:v,controlElement:v.element}},activateTool:(e,t)=>{e.bindInputEventMap(Y6),e.bindAction("adjust-contrast-via-wheel",r=>{r.stopPropagation();const i=xu(r.detail);x6(t.dataType,t.trackable,i)}),e.bindAction("adjust-via-drag",r=>{r.stopPropagation();let i=r.detail.screenX,s=r.detail.screenY,a=t.trackable.value.range,l=a,c=i,u=s;Rr(r.detail,h=>{const g=t.trackable.value.range,v=h.screenX,y=h.screenY;xi(t.dataType,g,l)||(a=g,i=c,s=u),E6(t.dataType,t.trackable,a,(y-s)*2/screen.height,(v-i)*4/screen.width),l=t.trackable.value.range,c=v,u=y})}),e.bindAction("invert-range",r=>{r.stopPropagation(),MD(t.trackable)})}}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function jl(n){return{makeControl:(e,t)=>{const r=n(e),i=t.registerDisposer(new Ts(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const K6=at.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function _D(n){return{makeControl:(e,t)=>{const r=n(e),i=t.registerDisposer(new my(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{e.bindInputEventMap(K6),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustHueViaWheel(r.detail)})}}}class Z6 extends K{constructor(e,{min:t=0,max:r=1,step:i=.01}={}){super(),this.value=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input"),this.numericInputElement=document.createElement("input");let s=this.element,a=this.inputElement,l=this.numericInputElement;s.className="range-slider";const c=h=>{h.min=""+t,h.max=""+r,h.step=""+i,h.valueAsNumber=this.value.value,this.registerEventListener(h,"change",()=>this.inputValueChanged(h)),this.registerEventListener(h,"input",()=>this.inputValueChanged(h)),this.registerEventListener(h,"wheel",g=>{this.adjustViaWheel(h,g)})};a.type="range",c(a),l.type="number";const u=Math.max(t.toString().length,r.toString().length,Math.min(r,t+i).toString().length,Math.max(t,r-i).toString().length);l.style.width=u+2+"ch",c(l),s.appendChild(a),s.appendChild(l),e.changed.add(()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value})}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){const r=this.inputElement;let i=t.deltaY;i>0?(r.stepUp(),this.inputValueChanged(e)):i<0&&(r.stepDown(),this.inputValueChanged(e))}disposed(){Et(this.element),super.disposed()}}/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Q6=at.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function ds(n){return{makeControl:(e,t)=>{var r=n(e);const i=r.value,s=r.options,a=t.registerDisposer(new Z6(i,s));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(Q6),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(t.inputElement,r.detail)})}}}function qE(n,e){const t=n.shaderControlState,r=t.state.get(e);if(r===void 0)return;const i=r.control;switch(i.type){case"slider":return ds(()=>({value:r.trackable,options:{min:i.min,max:i.max,step:i.step}}));case"color":return _D(()=>r.trackable);case"checkbox":return jl(()=>r.trackable);case"invlerp":{let a=0;for(const l of t.state){var s=ae(l,2);const c=s[0],u=s[1].control.type;if(c===e)break;u==="invlerp"&&++a}return X6(()=>({dataType:i.dataType,defaultChannel:i.default.channel,watchableValue:r.trackable,channelCoordinateSpaceCombiner:t.channelCoordinateSpaceCombiner,histogramSpecifications:t.histogramSpecifications,histogramIndex:a,legendShaderOptions:n.legendShaderOptions}))}}}function UD(n,e,t){return{label:t,toolJson:ej(t,e),makeControl:(r,i,s)=>{const a=n(r);return qE(a,t).makeControl(r,i,s)},activateTool:(r,i)=>{const s=n(r.tool.layer);return qE(s,t).activateTool(r,i)}}}class _y extends Fi{constructor(e,t,r,i={}){super(i.visibility),this.state=e,this.display=t,this.layer=r,this.options=i,this.controlDisposer=void 0;var s=i.toolId;const a=s===void 0?$D:s;this.toolId=a;const l=this.element;l.style.display="contents";const c=e.controls;this.registerDisposer(c.changed.add(this.registerCancellable(rt(()=>this.updateControls(),0)))),this.updateControls()}updateControls(){const e=this.element;this.controlDisposer!==void 0&&(this.controlDisposer.dispose(),Xe(e));const t=this.controlDisposer=new K,r=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(const i of this.state.state.keys())e.appendChild(Oy(t,this.layer,this.visibility,UD(r,this.toolId,i)))}disposed(){var e;(e=this.controlDisposer)===null||e===void 0||e.dispose(),super.disposed()}}const $D="shaderControl",zD="control";function ej(n,e){return{type:e,[zD]:n}}class tj extends BD{constructor(e,t,r,i){super(e,UD(()=>t,r,i)),this.layerShaderControls=t,this.control=i,this.registerDisposer(t.shaderControlState.controls.changed.add(this.registerCancellable(rt(()=>{t.shaderControlState.state.get(i)===void 0&&this.unbind()}))))}activate(e){this.layerShaderControls.shaderControlState.state.get(this.control)!==void 0&&super.activate(e)}}function Uy(n,e,t=$D){od(n,t,(r,i)=>{const s=X(i,zD,ke);return new tj(r,e(r),t,s)})}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function GD(n){return new Fy({fragmentMain:n.displayState.skeletonRenderingOptions.shader,shaderError:n.displayState.shaderError,shaderControlState:n.displayState.skeletonRenderingOptions.shaderControlState})}class nj extends Fi{constructor(e){super(),this.layer=e;const t=this.element;t.classList.add("neuroglancer-segmentation-rendering-tab");{const i=this.registerDisposer(new GE(e.displayState.linkedSegmentationGroup));i.label.textContent="Linked to: ",t.appendChild(i.element)}{const i=this.registerDisposer(new GE(e.displayState.linkedSegmentationColorGroup));i.label.textContent="Colors linked to: ",t.appendChild(i.element)}for(const i of HD)t.appendChild(Oy(this,e,this.visibility,i));const r=this.registerDisposer(new Qr(e.hasSkeletonsLayer,(i,s,a)=>{if(!i)return;let l=document.createElement("div");l.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let c=document.createElement("div");c.style.flex="1",c.textContent="Skeleton shader:",l.appendChild(c),l.appendChild(By({title:"Show larger editor view",onClick:()=>{new rj(this.layer)}})),l.appendChild(Vy({title:"Documentation on skeleton rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),s.appendChild(l);const u=a.registerDisposer(GD(this.layer));s.appendChild(u.element),s.appendChild(a.registerDisposer(new _y(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:jD})).element),u.textEditor.refresh()},this.visibility));t.appendChild(r.element)}}let rj=class extends Dh{constructor(n){super(),this.layer=n,this.codeWidget=this.registerDisposer(GD(this.layer)),this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var ij=function(n,e,t,r){var i=arguments.length,s=i<3?e:r===null?r=Ar(e,t):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,r);else for(var l=n.length-1;l>=0;l--)(a=n[l])&&(s=(i<3?a(s):i>3?a(e,t,s):a(e,t))||s);return i>3&&s&&Mr(e,t,s),s},Cm;let xm=Cm=class extends sh{constructor(){super(...arguments),this.hashTable=new jv,this.changed=new Ze}get value(){return this}static makeWithCounterpart(n){let e=new Cm;return e.initializeCounterpart(n),e}set_(n,e){return this.hashTable.set(n,e)}set(n,e){if(this.set_(n,e)){let t=this.rpc;t&&t.invoke("Uint64Map.set",{id:this.rpcId,key:n,value:e}),this.changed.dispatch(n,!0)}}has(n){return this.hashTable.has(n)}get(n,e){return this.hashTable.get(n,e)}[An](){return this.hashTable.entries()}unsafeEntries(){return this.hashTable.unsafeEntries()}delete_(n){return this.hashTable.delete(n)}delete(n){if(this.delete_(n)){let e=this.rpc;e&&e.invoke("Uint64Map.delete",{id:this.rpcId,key:n}),this.changed.dispatch(n,!1)}}get size(){return this.hashTable.size}assignFrom(n){this.clear();for(const t of n.unsafeEntries()){var e=ae(t,2);const r=e[0],i=e[1];this.set(r,i)}}clear(){if(this.hashTable.clear()){let n=this.rpc;n&&n.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let n={};for(let t of this.hashTable.unsafeEntries()){var e=ae(t,2);let r=e[0],i=e[1];n[r.toString()]=i.toString()}return n}};xm=Cm=ij([ah("Uint64Map")],xm);Tt("Uint64Map.set",function(n){let e=this.get(n.id);e.set_(n.key,n.value)&&e.changed.dispatch()});Tt("Uint64Map.delete",function(n){let e=this.get(n.id);e.delete_(n.key)&&e.changed.dispatch()});Tt("Uint64Map.clear",function(n){let e=this.get(n.id);e.hashTable.clear()&&e.changed.dispatch()});/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var sj=function(n,e,t,r){var i=arguments.length,s=i<3?e:r===null?r=Ar(e,t):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,r);else for(var l=n.length-1;l>=0;l--)(a=n[l])&&(s=(i<3?a(s):i>3?a(e,t,s):a(e,t))||s);return i>3&&s&&Mr(e,t,s),s},Em;let Nu=Em=class extends sh{constructor(){super(...arguments),this.hashTable=new g2,this.changed=new Ze}get value(){return this}static makeWithCounterpart(n){let e=new Em;return e.initializeCounterpart(n),e}set(n,e){e?this.add(n):this.delete(n)}reserve_(n){return this.hashTable.reserve(n)}reserve(n){if(this.reserve_(n)){let e=this.rpc;e&&e.invoke("Uint64Set.reserve",{id:this.rpcId,value:n})}}add_(n){let e=!1;for(const t of n)e=this.hashTable.add(t)||e;return e}add(n){const e=Array().concat(n);if(this.add_(e)){let t=this.rpc;t&&t.invoke("Uint64Set.add",{id:this.rpcId,value:e}),this.changed.dispatch(n,!0)}}has(n){return this.hashTable.has(n)}[An](){return this.hashTable.keys()}unsafeKeys(){return this.hashTable.unsafeKeys()}delete_(n){let e=!1;for(const t of n)e=this.hashTable.delete(t)||e;return e}delete(n){const e=Array().concat(n);if(this.delete_(Array().concat(n))){let t=this.rpc;t&&t.invoke("Uint64Set.delete",{id:this.rpcId,value:e}),this.changed.dispatch(n,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let n=this.rpc;n&&n.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let n=new Array;for(let e of this.unsafeKeys())n.push(e.toString());return n.sort(),n}assignFrom(n){this.clear();for(const e of n.unsafeKeys())this.add(e)}};Nu=Em=sj([ah("Uint64Set")],Nu);Tt("Uint64Set.reserve",function(n){let e=this.get(n.id);e.reserve_(n.value)&&e.changed.dispatch()});Tt("Uint64Set.add",function(n){let e=this.get(n.id);e.add_(n.value)&&e.changed.dispatch()});Tt("Uint64Set.delete",function(n){let e=this.get(n.id);e.delete_(n.value)&&e.changed.dispatch()});Tt("Uint64Set.clear",function(n){let e=this.get(n.id);e.hashTable.clear()&&e.changed.dispatch()});/**
 * @license
 * Copyright 2021 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const aj=at.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function WD(n){return{makeControl:(e,t)=>{const r=n(e),i=t.registerDisposer(new TI(r));return{control:i,controlElement:i.element}},activateTool:(e,t)=>{e.bindInputEventMap(aj),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(r.detail)})}}}const oj=200,JE=at.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});function lj(n){if(n<1||n>1024){const e=Un(n)|0,t=n/2**e;return`${dI(t,1)}p${e}`}return Math.round(n)+""}class Tm extends K{constructor(e,t){super(),this.histogram=e,this.target=t,this.label=document.createElement("div"),this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.legend=document.createElement("div"),this.legendRenderScale=document.createElement("div"),this.legendSpatialScale=document.createElement("div"),this.legendChunks=document.createElement("div"),this.ctx=this.canvas.getContext("2d"),this.hoverTarget=new dt(void 0),this.throttledUpdateView=this.registerCancellable(hh(()=>this.debouncedUpdateView(),oj,{leading:!0,trailing:!0})),this.debouncedUpdateView=this.registerCancellable(rt(()=>this.updateView(),0));const r=this.canvas,i=this.label,s=this.element,a=this.legend,l=this.legendRenderScale,c=this.legendSpatialScale,u=this.legendChunks;i.className="neuroglancer-render-scale-widget-prompt",s.className="neuroglancer-render-scale-widget",s.title=JE.describe(),a.className="neuroglancer-render-scale-widget-legend",s.appendChild(i),s.appendChild(r),s.appendChild(a),l.title="Target resolution of data in screen pixels",u.title="Number of chunks rendered",a.appendChild(l),a.appendChild(u),a.appendChild(c),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new Bi(r,JE)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));const h=v=>{const y=v.offsetX/r.width*Ht;return vF(y)};this.registerEventListener(r,"pointermove",v=>{this.hoverTarget.value=[h(v),v.offsetY]}),this.registerEventListener(r,"pointerleave",()=>{this.hoverTarget.value=void 0}),this.registerDisposer(ve(r,"set",v=>{this.target.value=h(v.detail)})),this.registerDisposer(ve(r,"adjust-via-wheel",v=>{this.adjustViaWheel(v.detail)})),this.registerDisposer(ve(r,"reset",v=>{this.reset(),v.preventDefault()}));const g=new ResizeObserver(()=>this.debouncedUpdateView());g.observe(r),this.registerDisposer(()=>g.disconnect()),this.updateView()}adjustViaWheel(e){const t=e.deltaY;t!==0&&(this.hoverTarget.value=void 0,this.target.value*=2**nd(t),e.preventDefault())}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){const e=this.ctx,t=this.canvas,r=t.width=t.offsetWidth,i=t.height=t.offsetHeight,s=this.target.value,a=this.hoverTarget.value;{const L=this.legendRenderScale,R=a===void 0?s:a[0],M=lj(R);L.textContent=M+" px"}function l(L){return L*r/Ht}e.clearRect(0,0,r,i);const c=this.histogram,u=c.value,h=c.spatialScales;c.visibility.visible||u.fill(0);const g=Te(h.keys());g.sort();const v=Ne();let y=1;const C=h.size;let S=0,w=0;for(let L=0;L<Ht;++L){let R=0;for(let M=0;M<C;++M){const V=M*Ht*2+L,B=u[V],_=u[V+Ht];S+=B,w+=_,R+=B+_}y=Math.max(R,y)}const E=i/Math.log(1+y);function k(L){return i-Math.log(1+L)*E}let P;if(a!==void 0){const L=Math.floor(Hc(a[0]));if(L>=0&&L<Ht){let R=0;const M=a[1];for(let V=C-1;V>=0;--V){const B=g[V],_=2*h.get(B)*Ht+L,H=u[_]+u[_+Ht];if(H===0)continue;const U=Math.round(k(R));if(R+=H,Math.round(k(R))<=M&&M<=U){P=B;break}}}}if(P!==void 0){S=0,w=0;const L=2*h.get(P)*Ht;for(let R=0;R<Ht;++R){const M=L+R;S+=u[M],w+=u[M+Ht]}gt(P)?this.legendSpatialScale.textContent=Qs(P,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${S}/${S+w}`;const D=g.map(L=>{const R=L===P?.5:1;let M;gt(L)?M=(Un(L)*.1%1+1)%1:M=0,bu(v,M,R,1);const V=Rn(v);bu(v,M,R,.5);const B=Rn(v);return[V,B]});for(let L=0;L<Ht;++L){let R=0;for(let M=C-1;M>=0;--M){const V=g[M],B=h.get(V)*Ht*2+L,_=u[B],H=u[B+Ht],U=_+H;if(U===0)continue;const O=Math.round(l(L)),z=Math.round(l(L+1)),F=Math.round(k(R));R+=U;const se=Math.round(k(R)),oe=(_*se+H*F)/U;e.fillStyle=D[M][1],e.fillRect(O,se,z-O,oe-se),e.fillStyle=D[M][0],e.fillRect(O,oe,z-O,F-oe)}}{const L=s;e.fillStyle="#fff";const R=l(Hc(L));e.fillRect(Math.floor(R),0,1,i)}if(a!==void 0){const L=a[0];e.fillStyle="#888";const R=l(Hc(L));e.fillRect(Math.floor(R),0,1,i)}}}const dj=at.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function Vu(n){return{makeControl:(e,t)=>{var r=n(e);const i=r.histogram,s=r.target,a=t.registerDisposer(new Tm(i,s));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(dj),e.bindAction("adjust-via-wheel",r=>{r.stopPropagation(),r.preventDefault(),t.adjustViaWheel(r.detail)}),e.bindAction("reset",r=>{r.stopPropagation(),r.preventDefault(),t.reset()})}}}const cj="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='rotateIconTitle'%3e%3ctitle%20id='rotateIconTitle'%3eRotate%3c/title%3e%3cpath%20d='M22%2012l-3%203-3-3'/%3e%3cpath%20d='M2%2012l3-3%203%203'/%3e%3cpath%20d='M19.016%2014v-1.95A7.05%207.05%200%200%200%208%206.22'/%3e%3cpath%20d='M16.016%2017.845A7.05%207.05%200%200%201%205%2012.015V10'/%3e%3cpath%20stroke-linecap='round'%20d='M5%2010V9'/%3e%3cpath%20stroke-linecap='round'%20d='M19%2015v-1'/%3e%3c/svg%3e";function Ou(n,e){e?n.displayState.segmentDefaultColor.value=lt(1,0,0):n.displayState.segmentDefaultColor.value=void 0}function uj(){const n=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(e,t,{labelTextContainer:r})=>{const i=document.createElement("input");i.type="radio",i.addEventListener("change",()=>{Ou(e,!i.checked)}),r.prepend(i);const s=document.createElement("div");s.classList.add("neuroglancer-segmentation-color-seed-control");const a=t.registerDisposer(new PI(e.displayState.segmentColorHash));s.appendChild(a.element);const l=ft({svg:cj,title:"Randomize",onClick:()=>n(e)});return s.appendChild(l),t.registerDisposer(ki(c=>{const u=c===void 0;s.style.visibility=u?"":"hidden",i.checked=u},e.displayState.segmentDefaultColor)),{controlElement:s,control:a}},activateTool:e=>{const t=e.tool.layer;Ou(t,!1),n(t)}}}function hj(){const n=_D(e=>e.displayState.segmentDefaultColor);return j(j({},n),{makeControl:(e,t,r)=>{const i=n.makeControl(e,t,r),s=i.controlElement,a=document.createElement("input");return a.type="radio",a.addEventListener("change",()=>{Ou(e,a.checked),a.checked&&s.click()}),r.labelTextContainer.prepend(a),t.registerDisposer(ki(l=>{const c=l!==void 0;s.style.visibility=c?"":"hidden",a.checked=c},e.displayState.segmentDefaultColor)),i},activateTool:(e,t)=>{Ou(e.tool.layer,!0),n.activateTool(e,t)}})}const km="selectedAlpha",Lm="notSelectedAlpha",Im="objectAlpha",Dm="saturation",Pm="hideSegmentZero",Rm="baseSegmentColoring",Mm="ignoreNullVisibleSet",pj="mesh",fj="skeletons",YE="segments",Bu="equivalences",Am="colorSeed",XE="segmentColors",Nm="meshRenderScale",Vm="crossSectionRenderScale",Fu="skeletonRendering",gj="skeletonShader",KE="segmentQuery",Om="meshSilhouetteRendering",ZE="linkedSegmentationGroup",QE="linkedSegmentationColorGroup",Bm="segmentDefaultColor",eT="anchorSegment",jD="skeletonShaderControl";class mj extends K{constructor(e){super(),this.layer=e,this.specificationChanged=new Ze,this.localGraph=new mW,this.visibleSegments=this.registerDisposer(Nu.makeWithCounterpart(this.layer.manager.rpc)),this.segmentPropertyMap=new dt(void 0),this.graph=new dt(void 0),this.segmentEquivalences=this.registerDisposer(ld.makeWithCounterpart(this.layer.manager.rpc,this.layer.registerDisposer(dr(r=>r&&r.visibleSegmentEquivalencePolicy||Dr.MIN_REPRESENTATIVE,[this.graph])))),this.localSegmentEquivalences=!1,this.maxIdLength=new dt(1),this.hideSegmentZero=new Ft(!0,!0),this.segmentQuery=new Jt("",ke),this.temporaryVisibleSegments=this.layer.registerDisposer(Nu.makeWithCounterpart(this.layer.manager.rpc)),this.temporarySegmentEquivalences=this.layer.registerDisposer(ld.makeWithCounterpart(this.layer.manager.rpc,this.segmentEquivalences.disjointSets.visibleSegmentEquivalencePolicy)),this.useTemporaryVisibleSegments=this.layer.registerDisposer(mn.make(this.layer.manager.rpc,!1)),this.useTemporarySegmentEquivalences=this.layer.registerDisposer(mn.make(this.layer.manager.rpc,!1));const t=this.specificationChanged;this.visibleSegments.changed.add(t.dispatch),this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch)}restoreState(e){ye(e,Pm,t=>this.hideSegmentZero.restoreState(t)),ye(e,Bu,t=>{this.localGraph.restoreState(t)}),ye(e,YE,t=>{const r=this.segmentEquivalences,i=this.visibleSegments;We(t,s=>{let a=te.parseString(String(s),10);i.add(r.get(a))})}),ye(e,KE,t=>this.segmentQuery.restoreState(t))}toJSON(){const e={};e[Pm]=this.hideSegmentZero.toJSON();let t=this.visibleSegments;t.size>0&&(e[YE]=t.toJSON());let r=this.segmentEquivalences;return this.localSegmentEquivalences&&r.size>0&&(e[Bu]=r.toJSON()),e[KE]=this.segmentQuery.toJSON(),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences)}}class vj extends K{constructor(e){super(),this.layer=e,this.specificationChanged=new Ze,this.segmentColorHash=Yv.getDefault(),this.segmentStatedColors=this.registerDisposer(new xm),this.segmentDefaultColor=new rV;const t=this.specificationChanged;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch)}restoreState(e){ye(e,Am,t=>this.segmentColorHash.restoreState(t)),ye(e,Bm,t=>this.segmentDefaultColor.restoreState(t)),ye(e,XE,t=>{let r=av(t,s=>Ao(String(s)));for(let s of r){var i=ae(s,2);let a=i[0],l=i[1];const c=te.parseString(String(a)),u=new te(vg(l));this.segmentStatedColors.set(c,u)}})}toJSON(){const e={};e[Am]=this.segmentColorHash.toJSON(),e[Bm]=this.segmentDefaultColor.toJSON();const t=this.segmentStatedColors;if(t.size>0){const i=e[XE]={};for(const s of t.unsafeEntries()){var r=ae(s,2);const a=r[0],l=r[1];i[a.toString()]=Rn(eo(l.low))}}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.segmentDefaultColor.value=e.segmentDefaultColor.value}}class tT extends K{constructor(e,t){super(),this.linkedGroup=e,this.propertyName=t,this.value}get changed(){return this.linkedGroup.root.changed}get value(){const e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;const t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){const r=this.curGroupState;r!==void 0&&(t.assignFrom(r),r.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){var e;(e=this.curGroupState)===null||e===void 0||e.dispose()}}class yj{constructor(e){this.layer=e,this.segmentSelectionState=new wU,this.selectedAlpha=Bl(.5),this.saturation=Bl(1),this.notSelectedAlpha=Bl(0),this.silhouetteRendering=new Jt(0,gk,0),this.objectAlpha=Bl(1),this.ignoreNullVisibleSet=new Ft(!0,!0),this.skeletonRenderingOptions=new WU,this.shaderError=lh(),this.renderScaleHistogram=new vo,this.renderScaleTarget=ta(1),this.selectSegment=this.layer.selectSegment,this.transparentPickEnabled=this.layer.pick,this.baseSegmentColoring=new Ft(!1,!1),this.filterBySegmentLabel=this.layer.filterBySegmentLabel,this.moveToSegment=t=>{this.layer.moveToSegment(t)},this.linkedSegmentationGroup=this.layer.registerDisposer(new wE(this.layer.manager.rootLayers,this.layer,t=>t instanceof qt,t=>t.displayState.linkedSegmentationGroup)),this.linkedSegmentationColorGroup=this.layer.registerDisposer(new wE(this.layer.manager.rootLayers,this.layer,t=>t instanceof qt,t=>t.displayState.linkedSegmentationColorGroup)),this.originalSegmentationGroupState=this.layer.registerDisposer(new mj(this.layer)),this.originalSegmentationColorGroupState=this.layer.registerDisposer(new vj(this.layer)),e.displayState=this,this.segmentationGroupState=this.layer.registerDisposer(new tT(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new tT(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.hideSegmentZero=this.layer.registerDisposer(new $c(this.segmentationGroupState,t=>t.hideSegmentZero)),this.segmentColorHash=this.layer.registerDisposer(new df(this.segmentationColorGroupState,t=>t.segmentColorHash)),this.segmentStatedColors=this.layer.registerDisposer(new df(this.segmentationColorGroupState,t=>t.segmentStatedColors)),this.segmentDefaultColor=this.layer.registerDisposer(new df(this.segmentationColorGroupState,t=>t.segmentDefaultColor)),this.segmentQuery=this.layer.registerDisposer(new $c(this.segmentationGroupState,t=>t.segmentQuery)),this.segmentPropertyMap=this.layer.registerDisposer(new $c(this.segmentationGroupState,t=>t.segmentPropertyMap))}}const bj=Ry(Wo);class qt extends bj{constructor(e){super(e),this.sliceViewRenderScaleHistogram=new vo,this.sliceViewRenderScaleTarget=ta(1),this.segmentQueryFocusTime=new dt(Number.NEGATIVE_INFINITY),this.selectSegment=(t,r)=>{this.manager.root.selectionState.captureSingleLayerState(this,i=>(i.value=t.clone(),!0),r)},this.filterBySegmentLabel=t=>{const r=xo(this.displayState,t).label;r&&this.filterSegments(r)},this.filterSegments=t=>{this.displayState.segmentationGroupState.value.segmentQuery.value=t,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer},this.displayState=new yj(this),this.anchorSegment=new Jt(void 0,t=>t===void 0?void 0:te.parseString(t)),this.has2dLayer=this.registerDisposer(Hr(t=>t.some(r=>r instanceof Kf),{changed:this.layersChanged,value:this.renderLayers})),this.has3dLayer=this.registerDisposer(Hr(t=>t.some(r=>r instanceof g1||r instanceof Bf||r instanceof Ff||r instanceof T1),{changed:this.layersChanged,value:this.renderLayers})),this.hasSkeletonsLayer=this.registerDisposer(Hr(t=>t.some(r=>r instanceof Ff),{changed:this.layersChanged,value:this.renderLayers})),this.registerDisposer(ao((t,r)=>{t.registerDisposer(r.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationGroupState)),this.registerDisposer(ao((t,r)=>{t.registerDisposer(r.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new nj(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new $6(this)}),this.tabs.default="rendering"}bindSegmentListWidth(e){return sd(this.displayState,e)}get volumeOptions(){return{volumeType:gn.SEGMENTATION}}activateDataSubsources(e){const t=[],r=this.displayState.linkedSegmentationGroup.root.value===this;let i;for(const a of e){if(this.addStaticAnnotations(a))continue;var s=a.subsourceEntry.subsource;const l=s.volume,c=s.mesh,u=s.segmentPropertyMap,h=s.segmentationGraph,g=s.local;if(l instanceof Is){switch(l.dataType){case q.FLOAT32:a.deactivate("Data type not compatible with segmentation layer");continue}a.activate(()=>a.addRenderLayer(new Kf(l,j(j({},this.displayState),{transform:a.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition}))),this.displayState.segmentationGroupState.value)}else c!==void 0?a.activate(()=>{const v=j(j({},this.displayState),{transform:a.getRenderLayerTransform()});if(c instanceof Ad)a.addRenderLayer(new g1(this.manager.chunkManager,c,v));else if(c instanceof yh)a.addRenderLayer(new Bf(this.manager.chunkManager,c,v));else{const y=new jU(this.manager.chunkManager,c,v);a.addRenderLayer(new Ff(y.addRef())),a.addRenderLayer(new T1(y))}},this.displayState.segmentationGroupState.value):u!==void 0?r?(a.activate(()=>{}),t.push(u)):a.deactivate("Not supported on non-root linked segmentation layers"):h!==void 0?r?i!==void 0?a.deactivate("Only one segmentation graph is supported"):(i=h,a.activate(v=>{this.graphConnection=v.registerDisposer(h.connect(this.displayState.segmentationGroupState.value));const y=j(j({},this.displayState),{transform:a.getRenderLayerTransform()}),C=this.graphConnection.createRenderLayers(this.manager.chunkManager,y,this.localPosition);for(const S of C)a.addRenderLayer(S)})):a.deactivate("Not supported on non-root linked segmentation layers"):g===Ri.equivalences?r?i!==void 0?a.deactivate("Only one segmentation graph is supported"):(i=this.displayState.originalSegmentationGroupState.localGraph,a.activate(v=>{this.graphConnection=v.registerDisposer(i.connect(this.displayState.segmentationGroupState.value)),v.registerDisposer(()=>{this.graphConnection=void 0})})):a.deactivate("Not supported on non-root linked segmentation layers"):a.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=nW(this.manager.chunkManager,t),this.displayState.originalSegmentationGroupState.graph.value=i}getLegacyDataSourceSpecifications(e,t,r,i){const s=super.getLegacyDataSourceSpecifications(e,t,r,i),a=ye(t,pj,c=>c===null?null:ke(c)),l=ye(t,fj,c=>c===null?null:ke(c));if(a!==void 0||l!==void 0)for(const c of s)c.enableDefaultSubsources=!1,c.subsources=new de([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return a!=null&&s.push(zl(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:a,type:"mesh"}))),l!=null&&s.push(zl(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:l,type:"skeletons"}))),t[Bu]!==void 0&&i.find(c=>c.url===_g)===void 0&&s.push({url:_g,enableDefaultSubsources:!0,transform:{outputSpace:uo,sourceRank:0,transform:void 0,inputSpace:uo},subsources:new de}),s}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[km]),this.displayState.saturation.restoreState(e[Dm]),this.displayState.notSelectedAlpha.restoreState(e[Lm]),this.displayState.objectAlpha.restoreState(e[Im]),this.displayState.baseSegmentColoring.restoreState(e[Rm]),this.displayState.silhouetteRendering.restoreState(e[Om]),this.displayState.ignoreNullVisibleSet.restoreState(e[Mm]);const t=this.displayState.skeletonRenderingOptions;t.restoreState(e[Fu]);const r=e[gj];r!==void 0&&t.shader.restoreState(r),this.displayState.renderScaleTarget.restoreState(e[Nm]),this.anchorSegment.restoreState(e[eT]),this.sliceViewRenderScaleTarget.restoreState(e[Vm]);const i=ye(e,ZE,ke);i!==void 0&&this.displayState.linkedSegmentationGroup.linkByName(i);const s=ye(e,QE,a=>a===!1?void 0:ke(a),i);s!==void 0&&this.displayState.linkedSegmentationColorGroup.linkByName(s),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){var e;const t=super.toJSON();t[km]=this.displayState.selectedAlpha.toJSON(),t[Lm]=this.displayState.notSelectedAlpha.toJSON(),t[Dm]=this.displayState.saturation.toJSON(),t[Im]=this.displayState.objectAlpha.toJSON(),t[Rm]=this.displayState.baseSegmentColoring.toJSON(),t[Mm]=this.displayState.ignoreNullVisibleSet.toJSON(),t[Om]=this.displayState.silhouetteRendering.toJSON(),t[eT]=this.anchorSegment.toJSON(),t[Fu]=this.displayState.skeletonRenderingOptions.toJSON(),t[Nm]=this.displayState.renderScaleTarget.toJSON(),t[Vm]=this.sliceViewRenderScaleTarget.toJSON();var r=this.displayState;const i=r.linkedSegmentationGroup,s=r.linkedSegmentationColorGroup;return t[ZE]=i.toJSON(),s.root.value!==i.root.value&&(t[QE]=(e=s.toJSON())!==null&&e!==void 0?e:!1),t[Bu]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),i.root.value===this&&j(t,this.displayState.segmentationGroupState.value.toJSON()),s.root.value===this&&j(t,this.displayState.segmentationColorGroupState.value.toJSON()),t}transformPickedValue(e){return e==null?e:P2(this.displayState,e,!0)}handleAction(e,t){switch(e){case"recolor":{this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break}case"clear-segments":{if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break}case"select":{if(!this.pick.value)break;const r=this.displayState.segmentSelectionState;if(r.hasSelectedSegment){const i=r.selectedSegment,s=this.displayState.segmentationGroupState.value.visibleSegments,a=!s.has(i);(a||t.segmentationToggleSegmentState===void 0)&&(t.segmentationToggleSegmentState=a),t.defer(()=>{t.segmentationToggleSegmentState===a&&s.set(i,a)})}break}case"copy-segment-id":{if(!this.pick.value)break;const r=this.displayState.segmentSelectionState;if(r.hasSelectedSegment){const i=r.selectedSegment;this.copiedSegments=[i.clone()];const s=i.toString();Yn(s)&&Ke.showTemporaryMessage(s+" copied to clipboard")}break}case"add-copy-segment-id":{if(!this.pick.value)break;const r=this.displayState.segmentSelectionState;if(r.hasSelectedSegment){const i=r.selectedSegment;this.copiedSegments.push(i.clone());const s=this.copiedSegments.map(a=>a.toString()).join(",");Yn(s)&&Ke.showTemporaryMessage(s+" copied to clipboard")}break}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);const r=new te;let i=e.value;typeof i=="number"&&(i=i.toString()),typeof i!="string"||!r.tryParseString(i)?e.value=void 0:e.value=r}selectionStateToJson(e,t){const r=super.selectionStateToJson(e,t);let i=e.value;return i instanceof vs?t?r.value={key:i.key.toString(),value:i.value?i.value.toString():void 0,label:i.label}:r.value=(i.value||i.key).toString():i instanceof te&&(r.value=i.toString()),r}displaySegmentationSelection(e,t,r){const i=e.value;let s;if((typeof i=="number"||typeof i=="string")&&(s=new te,!s.tryParseString(i.toString())))return!1;if(i instanceof te)s=i.clone();else if(i instanceof vs)s=i.key.clone();else return!1;const a=this.displayState,l=xo(a,s);var c=this.displayState.segmentationGroupState.value;const u=c.segmentEquivalences,h=c.segmentPropertyMap.value,g=u.get(s),v=ey(this.displayState,l);if(Md(a,r,r.redraw),r.registerDisposer(sd(a,v)),v.classList.add("neuroglancer-selection-details-segment"),t.appendChild(v),h!==void 0){const y=h.segmentPropertyMap.inlineProperties;if(y!==void 0){const C=h.getSegmentInlineIndex(g);if(C!==-1){for(const S of y.properties)if(S.type!=="label"){if(S.type==="description"){const w=S.values[C];if(!w)continue;const E=document.createElement("div");E.classList.add("neuroglancer-selection-details-segment-description"),E.textContent=w,t.appendChild(E)}else if(S.type==="number"||S.type==="string"){const w=S.values[C];if(S.type==="number"?isNaN(w):!w)continue;const E=document.createElement("div");E.classList.add("neuroglancer-selection-details-segment-property");const k=document.createElement("div");k.classList.add("neuroglancer-selection-details-segment-property-name"),k.textContent=S.id,S.description&&(k.title=S.description);const P=document.createElement("div");P.classList.add("neuroglancer-selection-details-segment-property-value"),P.textContent=w.toString(),E.appendChild(k),E.appendChild(P),t.appendChild(E)}}}}}return!0}displaySelectionState(e,t,r){let i=this.displaySegmentationSelection(e,t,r);return super.displaySelectionState(e,t,r)&&(i=!0),i}moveToSegment(e){for(const r of this.renderLayers){if(!(r instanceof Bf))continue;const i=r.getObjectPosition(e);if(i!==void 0){this.setLayerPosition(r.displayState.transform.value,i);return}}let t=!1;for(const r of this.renderLayers)if(r instanceof Kf){const i=r.multiscaleSource;i.getSegmentPosition&&(t=!0,i.getSegmentPosition(e).then(s=>{this.setLayerPosition(null,s)}).catch(s=>{Ke.showTemporaryMessage(`Failed to retrieve position for segment ${e}: ${s}`)}))}t||Ke.showTemporaryMessage(`No position information loaded for segment ${e}`)}}qt.type="segmentation";qt.typeAbbreviation="seg";qt.supportsPickOption=!0;const wj=10;function nT(n){return[j({label:`Skeleton mode (${n})`,toolJson:`${Fu}.mode${n}`,isValid:e=>e.hasSkeletonsLayer},WD(e=>e.displayState.skeletonRenderingOptions[`params${n}`].mode)),j({label:`Line width (${n})`,toolJson:`${Fu}.lineWidth${n}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${n})`,title:`Skeleton line width (${n})`},ds(e=>({value:e.displayState.skeletonRenderingOptions[`params${n}`].lineWidth,options:{min:1,max:40,step:1}})))]}const HD=[j({label:"Color seed",title:"Color segments based on a hash of their id",toolJson:Am},uj()),j({label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:Bm},hj()),j({label:"Saturation",toolJson:Dm,title:"Saturation of segment colors"},ds(n=>({value:n.displayState.saturation}))),j({label:"Opacity (on)",toolJson:km,isValid:n=>n.has2dLayer,title:"Opacity in cross-section views of segments that are selected"},ds(n=>({value:n.displayState.selectedAlpha}))),j({label:"Opacity (off)",toolJson:Lm,isValid:n=>n.has2dLayer,title:"Opacity in cross-section views of segments that are not selected"},ds(n=>({value:n.displayState.notSelectedAlpha}))),j({label:"Resolution (slice)",toolJson:Vm,isValid:n=>n.has2dLayer},Vu(n=>({histogram:n.sliceViewRenderScaleHistogram,target:n.sliceViewRenderScaleTarget}))),j({label:"Resolution (mesh)",toolJson:Nm,isValid:n=>n.has3dLayer},Vu(n=>({histogram:n.displayState.renderScaleHistogram,target:n.displayState.renderScaleTarget}))),j({label:"Opacity (3d)",toolJson:Im,isValid:n=>n.has3dLayer,title:"Opacity of meshes and skeletons"},ds(n=>({value:n.displayState.objectAlpha}))),j({label:"Silhouette (3d)",toolJson:Om,isValid:n=>n.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction"},ds(n=>({value:n.displayState.silhouetteRendering,options:{min:0,max:wj,step:.1}}))),j({label:"Hide segment ID 0",toolJson:Pm,title:"Disallow selection and display of segment id 0"},jl(n=>n.displayState.hideSegmentZero)),j({label:"Base segment coloring",toolJson:Rm,title:"Color base segments individually"},jl(n=>n.displayState.baseSegmentColoring)),j({label:"Show all by default",title:"Show all segments if none are selected",toolJson:Mm},jl(n=>n.displayState.ignoreNullVisibleSet)),...nT("2d"),...nT("3d")];for(const n of HD)FD(qt,n);jo(qt);GI(gn.SEGMENTATION,qt);by(n=>{if(n.mesh!==void 0)return{layerConstructor:qt,priority:1}});Uy(qt,n=>({shaderControlState:n.displayState.skeletonRenderingOptions.shaderControlState}),jD);P6();A6();/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sj extends K{constructor(e){super(),this.ref=e,this.element=document.createElement("label"),this.selectElement=document.createElement("select"),this.registerDisposer(e);const t=this.element,r=this.selectElement;t.appendChild(r),this.updateView(),this.registerEventListener(r,"change",()=>this.updateModel()),this.registerDisposer(this.ref.changed.add(rt(()=>this.updateView(),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){const e=this.selectElement,t=this.ref,r=t.filter;Xe(e);const i=document.createElement("option");e.appendChild(i);for(const s of this.ref.layerManager.managedLayers)if(r(s)){const a=document.createElement("option"),l=s.name;a.textContent=l,a.value=l,e.appendChild(a)}e.value=t.layerName||""}}const Cj="points",Qf="annotations",rT="annotationProperties",iT="annotationRelationships",sT="crossSectionAnnotationSpacing",aT="projectionAnnotationSpacing",oT="shader",lT="shaderControls";function xj(n,e){e!==void 0&&We(e,(t,r)=>{n.add({type:Pe.POINT,id:""+r,point:DV(t),properties:[]})})}function Ej(n){const e=n.layer;return e===null||e instanceof qt}function Tj(n){if(n===void 0)return null;const e=n.layer;return e===null||!(e instanceof qt)?null:e.displayState}const dT="linkedSegmentationLayer",cT="filterBySegmentation",uT="ignoreNullSegmentFilter";class kj extends K{constructor(e,t,r){super(),this.layerManager=e,this.annotationStates=t,this.annotationDisplayState=r,this.changed=new we,this.curGeneration=-1,this.wasLoading=void 0,this.map=new de,this.registerDisposer(t.changed.add(()=>this.update())),this.registerDisposer(t.isLoadingChanged.add(()=>this.update())),this.update()}update(){const e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;const r=this.map;let i=!1;for(const a of this.annotationStates.relationships){let l=r.get(a);l===void 0&&(l=this.addRelationship(a),i=!0),l.seenGeneration=e}if(!t)for(const a of r){var s=ae(a,2);const l=s[0];s[1].seenGeneration!==e&&(r.delete(l),i=!0)}i&&this.changed.dispatch()}addRelationship(e){const t=this.annotationDisplayState.relationshipStates.get(e),r=new _G(this.layerManager.addRef(),Ej);r.registerDisposer(r.changed.add(()=>{t.segmentationState.value=r.layerName===void 0?void 0:Tj(r.layer)}));const i=t.showMatches,s={layerRef:r,showMatches:i,seenGeneration:-1};return r.changed.add(this.changed.dispatch),i.changed.add(this.changed.dispatch),this.map.set(e,s),s}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(const e of this.map.values())e.showMatches.reset()}toJSON(){const e=this.map;if(e.size===0)return{};let t;const r=[];for(const s of e){var i=ae(s,2);const a=i[0],l=i[1];l.showMatches.value&&r.push(a);const c=l.layerRef.layerName;c!==void 0&&((t=t||{})[a]=c)}return r.sort(),{[dT]:t,[cT]:r.length===0?void 0:r}}restoreState(e){const t=this.annotationStates.isLoading;ye(e,dT,r=>{typeof r=="string"&&(r={segments:r}),ge(r);for(const s of Qt(r)){const a=ke(r[s]);let l=this.map.get(s);if(l===void 0){if(!t)continue;l=this.addRelationship(s)}l.layerRef.layerName=a}for(const s of this.map){var i=ae(s,2);const a=i[0],l=i[1];Object.prototype.hasOwnProperty.call(r,a)||(l.layerRef.layerName=void 0)}}),ye(e,cT,r=>{typeof r=="boolean"&&(r=r===!0?["segments"]:[]);for(const i of kr(r)){let s=this.map.get(i);if(s===void 0){if(!t)continue;s=this.addRelationship(i)}s.showMatches.value=!0}})}disposed(){const e=this.map;for(const t of e.values())this.unbind(t);e.clear(),super.disposed()}}class Lj extends K{constructor(e,t){super(),this.relationship=e,this.state=t,this.element=document.createElement("label"),this.seenGeneration=-1;const r=this.element,i=this.registerDisposer(new Ts(t.showMatches)),s=new Sj(t.layerRef);r.appendChild(i.element),r.appendChild(document.createTextNode(e)),r.appendChild(s.element)}}class Ij extends K{constructor(e){super(),this.linkedSegmentationLayers=e,this.widgets=new de,this.element=document.createElement("div"),this.element.style.display="contents";const t=this.registerCancellable(ct(()=>this.updateView()));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){const e=this.linkedSegmentationLayers,t=e.annotationStates,r=t.changed.count,i=this.widgets;function*s(){for(const l of t.relationships){let c=i.get(l);c===void 0&&(c=new Lj(l,e.get(l))),c.seenGeneration=r,yield c.element}}for(const l of i){var a=ae(l,2);const c=a[0],u=a[1];u.seenGeneration!==r&&(u.dispose(),i.delete(c))}Yr(this.element,s.call(this))}disposed(){super.disposed();for(const e of this.widgets.values())e.dispose()}}const Dj=Ry(Wo);class bs extends Dj{constructor(e){super(e),this.annotationProperties=new dt(void 0),this.localAnnotationsJson=void 0,this.pointAnnotationsJson=void 0,this.linkedSegmentationLayers=this.registerDisposer(new kj(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState)),this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new Rj(this)}),this.tabs.default="annotations",this.allowingRefresh=!0}disposed(){const e=this.localAnnotations;e!==void 0&&e.dispose(),super.disposed()}restoreState(e){super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.localAnnotationsJson=e[Qf],this.localAnnotationProperties=ye(e,rT,Ck),this.localAnnotationRelationships=ye(e,iT,kr,["segments"]),this.pointAnnotationsJson=e[Cj],this.annotationCrossSectionRenderScaleTarget.restoreState(e[sT]),this.annotationProjectionRenderScaleTarget.restoreState(e[aT]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[uT]),this.annotationDisplayState.shader.restoreState(e[oT]),this.annotationDisplayState.shaderControls.restoreState(e[lT])}getLegacyDataSourceSpecifications(e,t,r,i){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,r,i);const s=ye(t,"voxelSize",l=>it(new Float64Array(3),l,c=>yn(c)/1e9)),a=["m","m","m"];if(s!==void 0){const l=st({rank:3,units:a,scales:s,names:["x","y","z"]});r===void 0?r={outputSpace:l,sourceRank:3,transform:void 0,inputSpace:l}:r=j(j({},r),{inputSpace:l})}return[{url:t2,transform:r,enableDefaultSubsources:!0,subsources:new de}]}activateDataSubsources(e){var t;let r=!1,i;for(const a of e){const l=a.subsourceEntry,c=l.subsource.local,u=g=>i!==void 0&&lr(g)!==lr(i)?(a.deactivate("Annotation properties are not compatible"),!1):(i=g,!0);if(c===Ri.annotations){if(r){a.deactivate("Only one local annotations source per layer is supported");continue}if(r=!0,!u((t=this.localAnnotationProperties)!==null&&t!==void 0?t:[]))continue;a.activate(g=>{var v;const y=this.localAnnotations=new t3(a.loadedDataSource.transform,(v=this.localAnnotationProperties)!==null&&v!==void 0?v:[],this.localAnnotationRelationships);try{y.restoreState(this.localAnnotationsJson)}catch{}g.registerDisposer(()=>{y.dispose(),this.localAnnotations=void 0}),g.registerDisposer(this.localAnnotations.changed.add(this.specificationChanged.dispatch));try{xj(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;const C=new Ag({localPosition:this.localPosition,transform:g.registerDisposer($k(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,a.loadedDataSource.transform,void 0)),source:y.addRef(),displayState:this.annotationDisplayState,dataSource:a.loadedDataSource.layerDataSource,subsourceIndex:a.subsourceIndex,subsourceId:l.id,role:ur.ANNOTATION});this.addAnnotationLayerState(C,a)});continue}const h=l.subsource.annotation;if(h!==void 0){if(!u(h.properties))continue;a.activate(()=>{const g=new Ag({localPosition:this.localPosition,transform:a.getRenderLayerTransform(),source:h,displayState:this.annotationDisplayState,dataSource:a.loadedDataSource.layerDataSource,subsourceIndex:a.subsourceIndex,subsourceId:l.id,role:ur.ANNOTATION});this.addAnnotationLayerState(g,a)});continue}a.deactivate("Not compatible with annotation layer")}const s=this.annotationProperties.value;lr(s)!==lr(i)&&(this.annotationProperties.value=i)}initializeAnnotationLayerViewTab(e){const t=e.registerDisposer(Hr(i=>i.some(s=>s.source instanceof Pr),this.annotationStates)),r=e.registerDisposer(new Qr(t,(i,s,a)=>{if(i){{const l=a.registerDisposer(new Tm(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));l.label.textContent="Spacing (cross section)",s.appendChild(l.element)}{const l=a.registerDisposer(new Tm(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));l.label.textContent="Spacing (projection)",s.appendChild(l.element)}}}));e.element.insertBefore(r.element,e.element.firstChild);{const i=e.registerDisposer(new Ts(this.annotationDisplayState.ignoreNullSegmentFilter)),s=document.createElement("label");s.appendChild(document.createTextNode("Ignore null related segment filter")),s.title="Display all annotations if filtering by related segments is enabled but no segments are selected",s.appendChild(i.element),e.element.appendChild(s)}e.element.appendChild(e.registerDisposer(new Ij(this.linkedSegmentationLayers)).element)}toJSON(){const e=super.toJSON();e[sT]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[aT]=this.annotationProjectionRenderScaleTarget.toJSON(),this.localAnnotations!==void 0?e[Qf]=this.localAnnotations.toJSON():this.localAnnotationsJson!==void 0&&(e[Qf]=this.localAnnotationsJson),e[rT]=QV(this.localAnnotationProperties);const t=this.localAnnotationRelationships;return e[iT]=t&&t.length===1&&t[0]==="segments"?void 0:t,e[uT]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[oT]=this.annotationDisplayState.shader.toJSON(),e[lT]=this.annotationDisplayState.shaderControls.toJSON(),j(e,this.linkedSegmentationLayers.toJSON()),e}}bs.type="annotation";bs.typeAbbreviation="ann";function qD(n){return new Fy({shaderError:n.annotationDisplayState.shaderError,fragmentMain:n.annotationDisplayState.shader,shaderControlState:n.annotationDisplayState.shaderControls})}let Pj=class extends Dh{constructor(n){super(),this.layer=n,this.codeWidget=this.registerDisposer(qD(this.layer)),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}},Rj=class extends Fi{constructor(n){super(),this.layer=n,this.codeWidget=this.registerDisposer(qD(this.layer));const e=this.element;e.classList.add("neuroglancer-annotation-rendering-tab"),e.appendChild(this.registerDisposer(new Qr(n.annotationProperties,(i,s)=>{if(i===void 0||i.length===0)return;const a=document.createElement("div");s.appendChild(a),a.classList.add("neuroglancer-annotation-shader-property-list");for(const l of i){const c=document.createElement("div");c.classList.add("neuroglancer-annotation-shader-property");const u=document.createElement("span");u.classList.add("neuroglancer-annotation-shader-property-type"),u.textContent=l.type;const h=document.createElement("span");h.classList.add("neuroglancer-annotation-shader-property-identifier"),h.textContent=`prop_${l.identifier}`,c.appendChild(u),c.appendChild(h);const g=l.description;g!==void 0&&(c.title=g),a.appendChild(c)}})).element);let t=document.createElement("div");t.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let r=document.createElement("div");r.style.flex="1",r.textContent="Annotation shader:",t.appendChild(r),t.appendChild(By({title:"Show larger editor view",onClick:()=>{new Pj(this.layer)}})),t.appendChild(Vy({title:"Documentation on annotation rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/annotation/rendering.md"})),e.appendChild(t),e.appendChild(this.codeWidget.element),e.appendChild(this.registerDisposer(new _y(n.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}};jo(bs);jo(bs,"pointAnnotation");by(n=>{if(n.local===Ri.annotations)return{layerConstructor:bs,priority:100};if(n.annotation!==void 0)return{layerConstructor:bs,priority:1}});Uy(bs,n=>({shaderControlState:n.annotationDisplayState.shaderControls}));function Mj(n){n.registerEventListener(document,"copy",e=>{if(Kv(e.target))return;const t=document.getSelection();if(t!==null&&t.type==="Range")return;const r=Wv(n.state).value,i=e.clipboardData;i!==null&&i.setData("text/plain",ie(r,void 0,"  ")),e.preventDefault()})}function Aj(n,e){let t=Vl`^[\[\]{}()\s,]*`;for(let s=0;s<e;++s)s!==0&&(t+=Vl`[,\s]+`),t+=Vl`(\d+(?:\.\d+)?)`;t+=Vl`[\[\]{}()\s,]*$`;const r=n.match(t);if(r===null)return;const i=new Float32Array(e);for(let s=0;s<e;++s){const a=Number(r[s+1]);if(!gt(a))return;i[s]=a}return i}function Nj(n){n.registerEventListener(document,"paste",e=>{if(Kv(e.target))return;const t=e.clipboardData;if(t!==null){const r=t.getData("text/plain"),i=Aj(r,n.coordinateSpace.value.rank);i!==void 0&&(n.navigationState.position.value=i)}e.preventDefault()})}const hT=Xn("SingleTextureVolumeChunk.textureUnit"),_c=Xn("SingleTextureVolumeChunk.textureLayout");class JD extends K{constructor(e,t){super(),this.shaderKey=e,this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",hT)}beginDrawing(e,t){let r=t.textureUnit(hT);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),t[_c]=null}endDrawing(e,t){e.bindTexture(Mg[this.shaderSamplerType],null),t[_c]=null}bindChunk(e,t,r,i,s,a,l){let c=r.textureLayout;(t[_c]!==c||l)&&(t[_c]=c,this.setupTextureLayout(e,t,c,i,s,a)),e.bindTexture(Mg[this.shaderSamplerType],r.texture)}beginSource(e,t){}}class YD extends ZU{constructor(e,t){super(e,t),this.texture=null,this.data=t.data}copyToGPU(e){super.copyToGPU(e);let t=this.texture=e.createTexture();const r=Mg[this.chunkFormat.shaderSamplerType];e.bindTexture(r,t),this.setTextureData(e),e.bindTexture(r,null)}freeGPUMemory(e){super.freeGPUMemory(e),e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Vj=class XD extends K{constructor(e,t,r){super(),this.chunkDataSize=t,this.textureDims=r,this.textureShape=new Uint32Array(this.textureDims);const i=t.length;let s=0;for(const g of t)g!==1&&++s;const a=this.strides=new Uint32Array(i*r),l=r===3?e.max3dTextureSize:e.maxTextureSize;let c=0,u=1;const h=this.textureShape;h.fill(1);for(let g=0;g<i;++g){const v=t[g];if(v===1)continue;const y=v*u;let C;y>l||u!==1&&c+s<r?(++c,u=v,C=1):(C=u,u=y),a[r*g+c]=C,h[c]=u}}static get(e,t,r){return e.memoize.get(`sliceview.UncompressedTextureLayout:${t.join()}:${r}`,()=>new XD(e,t,r))}},eg=new Uint32Array(15),Oj=class KD extends JD{constructor(e,t,r,i){super(r,t),this.textureDims=i,Pd(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${i}D`,this.textureAccessHelper=new j_("chunkData",i)}static get(e,t,r){const i=`sliceview.UncompressedChunkFormat:${t}:${r}`;return e.memoize.get(i,()=>new KD(e,t,i,r))}defineShader(e,t){super.defineShader(e,t);const r=this.textureDims,i=`ivec${this.textureDims}`;let s=this.textureAccessHelper;const a=(4+t)*r;eg.length<a&&(eg=new Uint32Array(a)),e.addUniform(`highp ${i}`,"uVolumeChunkStrides",4+t),e.addFragmentCode(s.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType));let l=`
${an(this.dataType)} getDataValueAt(highp ivec3 p`;for(let c=0;c<t;++c)l+=`, highp int channelIndex${c}`;l+=`) {
  highp ${i} offset = uVolumeChunkStrides[0]
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let c=0;c<t;++c)l+=`
  offset += channelIndex${c} * uVolumeChunkStrides[${4+c}];
`;l+=`
  return readVolumeData(offset);
}
`,e.addFragmentCode(l)}setupTextureLayout(e,t,r,i,s,a){const l=eg,c=a.length,u=r.strides,h=i.length,g=this.textureDims;for(let y=0;y<g;++y){let C=0;for(let S=0;S<h;++S)C+=i[S]*u[S*g+y];l[y]=C}for(let y=0;y<3;++y){const C=s[y];if(!(C>=h))for(let S=0;S<g;++S)l[(y+1)*g+S]=u[C*g+S]}for(let y=0;y<c;++y){const C=a[y];if(C===-1)l.fill(0,(4+y)*g,(4+y+1)*g);else for(let S=0;S<g;++S)l[(4+y)*g+S]=u[C*g+S]}const v=(4+c)*g;g===3?e.uniform3iv(t.uniform("uVolumeChunkStrides"),l,0,v):e.uniform2iv(t.uniform("uVolumeChunkStrides"),l,0,v)}getTextureLayout(e,t){return Vj.get(e,t,this.textureDims)}setTextureData(e,t,r){const i=t.textureShape;(this.textureDims===3?G_:z_)(e,this,r,i[0],i[1],i[2])}};class Bj extends YD{setTextureData(e){let t=this.source,r=t.chunkFormatHandler,i=r.chunkFormat,s;this.chunkDataSize===t.spec.chunkDataSize?this.textureLayout=s=r.textureLayout.addRef():this.textureLayout=s=i.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,s,this.data)}getValueAt(e){let t=this.chunkFormat;const r=this.chunkDataSize;let i=0,s=1;const a=e.length;for(let u=0;u<a;++u)i+=s*e[u],s*=r[u];let l=t.dataType,c=this.data;switch(l){case q.UINT8:case q.INT8:case q.FLOAT32:case q.UINT16:case q.INT16:case q.UINT32:case q.INT32:return c[i];case q.UINT64:{let u=i*2;return new te(c[u],c[u+1])}}}}class Fj extends K{constructor(e,t){super();let r=0;for(const i of t.chunkDataSize)i>1&&++r;this.chunkFormat=this.registerDisposer(Oj.get(e,t.dataType,r>=3?3:2)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize))}getChunk(e,t){return new Bj(e,t)}}W2((n,e)=>e.compressedSegmentationBlockSize==null?new Fj(n,e):null);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ZD(n,e,t,r,i,s){let a=0,l=0,c=1,u=1;for(let S=0;S<3;++S){let w=i[S],E=r[S],k=Math.floor(w/E),P=w%E;a+=k*c,c*=Math.ceil(t[S]/E),l+=P*u,u*=E}let h=e+a*2,g=n[h],v=n[h+1],y=g&16777215,C=g>>24&255;if(C>0){let S=(e+v&16777215)+Math.floor(l*C/32),w=n[S],E=l*C%32,k=w>>E&(1<<C)-1;y+=s*k}return y}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function _j(n,e,t,r,i){let s=ZD(n,e,t,r,i,1)+e;return n[s]}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Uj(n,e,t,r,i,s){let a=ZD(e,t,r,i,s,2)+t;return n.low=e[a],n.high=e[a+1],n}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $y extends K{constructor(e,t){super(),this.chunkDataSize=e,this.subchunkSize=t;const r=this.subchunkGridSize=Ne();for(let i=0;i<3;++i)r[i]=Math.ceil(e[i]/t[i])}static get(e,t,r){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${mg(t)},${mg(r)}`,()=>new $y(t,r))}}const $j=Pd(new gh,q.UINT32);let tg=new Uint32Array(16);class zy extends JD{constructor(e,t,r,i){super(i,e),this.subchunkSize=t,this.numChannels=r,this.textureAccessHelper=new Jv("chunkData")}static get(e,t,r,i){let s=`sliceview.CompressedSegmentationChunkFormat:${t}:${i}`,a=`${s}:${mg(r)}`;return e.memoize.get(a,()=>new zy(t,r,i,s))}get shaderSamplerType(){return"usampler2D"}defineShader(e,t){super.defineShader(e,t);const r=4*(4+t);tg.length<r&&(tg=new Uint32Array(r));let i=this.textureAccessHelper;i.defineShader(e);let s=u=>"compressedSegmentationChunkFormat_"+u;e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode(sB);const a=this.dataType,l=an(a);a===q.UINT64?e.addFragmentCode(It):e.addFragmentCode(Lv),e.addFragmentCode(i.getAccessor(s("readTextureValue"),"uVolumeChunkSampler",q.UINT32,1));let c=`
uint ${s("getChannelOffset")}(int channelIndex) {
  if (channelIndex == 0) {
    return ${this.numChannels}u;
  }
  return ${s("readTextureValue")}(uint(channelIndex)).value;
}
${l} getDataValueAt(highp ivec3 p`;for(let u=0;u<t;++u)c+=`, highp int channelIndex${u}`;c+=`) {
  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let u=0;u<t;++u)c+=`
  chunkPositionFull += channelIndex${u} * uVolumeChunkStrides[${4+u}];
`;c+=`
  highp ivec3 chunkPosition = chunkPositionFull.xyz;

  // TODO: maybe premultiply this and store as uniform.
  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;
  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);

  int channelOffset = int(${s("getChannelOffset")}(chunkPositionFull[3]));

  // TODO: Maybe just combine this offset into subchunkGridStrides.
  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;

  highp uint subchunkHeader0 = ${s("readTextureValue")}(uint(subchunkHeaderOffset)).value;
  highp uint subchunkHeader1 = ${s("readTextureValue")}(uint(subchunkHeaderOffset + 1)).value;
  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);
  highp uint encodingBits = subchunkHeader0 >> 24u;
  if (encodingBits > 0u) {
    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;
    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);
    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);
    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;
    uint encodedValue = ${s("readTextureValue")}(encodedValueOffset).value;
    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;
    uint encodedValueShifted = encodedValue >> wordOffset;
    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);
    outputValueOffset += decodedValue * ${this.dataType===q.UINT64?"2u":"1u"};
  }
  ${l} result;
`,a===q.UINT64?c+=`
  result.value[0] = ${s("readTextureValue")}(outputValueOffset).value;
  result.value[1] = ${s("readTextureValue")}(outputValueOffset+1u).value;
`:c+=`
  result.value = ${s("readTextureValue")}(outputValueOffset).value;
`,c+=`
  return result;
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,r,i,s,a){const l=r.subchunkGridSize;e.uniform3i(t.uniform("uSubchunkGridSize"),l[0],l[1],l[2]);const c=tg,u=a.length;c.fill(0);for(let h=0;h<3;++h){c[h]=i[h];const g=s[h];g!==-1&&(c[4*(h+1)+g]=1)}for(let h=0;h<u;++h){const g=a[h];g!==-1&&(c[4*(4+h)+g]=1)}e.uniform4iv(t.uniform("uVolumeChunkStrides"),c,0,(u+4)*4)}setTextureData(e,t,r){qv(e,$j,r)}getTextureLayout(e,t){return $y.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);const r=this.subchunkSize;e.uniform3i(t.uniform("uSubchunkSize"),r[0],r[1],r[2])}}class zj extends YD{setTextureData(e){let t=this.data,r=this.chunkFormat,i=this.textureLayout=r.getTextureLayout(e,this.chunkDataSize);r.setTextureData(e,i,t)}getValueAt(e){let t=this.chunkDataSize,r=this.chunkFormat,i=this.data,s=i[e[3]||0];if(r.dataType===q.UINT64){let a=new te;return Uj(a,i,s,t,r.subchunkSize,e),a}else return _j(i,s,t,r.subchunkSize,e)}}class Gj extends K{constructor(e,t){super();let r=t.dataType;if(r!==q.UINT64&&r!==q.UINT32)throw new Error(`Unsupported compressed segmentation data type: ${q[r]}`);this.chunkFormat=this.registerDisposer(zy.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1))}getChunk(e,t){return new zj(e,t)}}W2((n,e)=>e.compressedSegmentationBlockSize!=null?new Gj(n,e):null);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Wj(n,e=document.getElementById("neuroglancer-container")){try{let t=new sO(e);return new LG(t,n)}catch(t){throw Ke.showMessage(`Error: ${t.message}`),t}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function jj(n=document){return Lr(n,"contextmenu",e=>{e.preventDefault()})}const Gy="DVID";function Hj(n){return n.text()}function qj(n,e=Vt){const t=`${n.url}`,r={method:n.method,body:n.payload};return ys(t,r,si,e)}function Jj(n,e,t=Vt){return Yj(n,e.url,{method:e.method,body:e.payload},si,t)}function Yj(n,e,t,r,i=Vt){return py(n,e,t,r,(s,a)=>{const l=j({},a);return s.token&&(l.headers=j(j({},l.headers),{Authorization:`Bearer ${s}`})),l},s=>{if(s.status===504)return"retry";throw s},i)}async function Xj(n,e=Vt){return{token:await ys(n,{method:"GET",credentials:"include"},Hj,e)}}class Kj extends _d{constructor(e){super(),this.authServer=e,this.get=Sh(t=>{if(!this.authServer)return xt.resolve({token:""});const r=new Ke(!0);let i;return new xt((s,a)=>{const l=()=>{i=void 0,r.dispose()};t.add(()=>{i!==void 0&&(i.cancel(),i=void 0,r.dispose(),a(ms))});function c(h,g="DVID authorization required.",v="Request authorization."){r.setText(g+" ");let y=document.createElement("button");y.textContent=v,r.element.appendChild(y),y.addEventListener("click",()=>{let C=h.match(/^[^\/]+\/\/[^\/\.]+\.([^\/]+)/);if(C){const S=`https://flyemlogin.${C[1]}/login`;window.alert(`Please log into ${S} and then refresh the neurogalncer page to try again.
If you are unable to log into ${S}, please check your authorization server ${h} to make sure it is correct.`)}else window.alert(`Please check your authorization server ${h} to make sure it is correct.`)}),r.setVisible(!0)}function u(h){i!==void 0&&i.cancel(),i=new Es,c(h,"Waiting for DVID authorization...","Retry"),Xj(h,i).then(g=>{i!==void 0&&(l(),s(g))},g=>{i!==void 0&&(i=void 0,c(h,`DVID authorization failed: ${g}.`,"Retry"))})}u(this.authServer)})})}}class Zj extends z4{constructor(e,t){super(new Kj(t),{})}}/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */$o.register(Gy,n=>new Zj(n.dvidServer,n.authServer));/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Qj="CredentialsProvider",eH="CredentialsProvider.get";/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var tH=function(n,e,t,r){var i=arguments.length,s=i<3?e:r===null?r=Ar(e,t):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,r);else for(var l=n.length-1;l>=0;l--)(a=n[l])&&(s=(i<3?a(s):i>3?a(e,t,s):a(e,t))||s);return i>3&&s&&Mr(e,t,s),s};let Fm=class extends ei{constructor(n,e){super(),this.provider=n,this.registerDisposer(n),this.initializeCounterpart(e)}get(n,e){return this.provider.get(n,e)}};Fm=tH([hr(Qj)],Fm);lL(eH,function(n,e){return this.get(n.providerId).get(n.invalidCredentials,e).then(t=>({value:t}))});/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function nH(n,e){if(e===void 0)return;const t=n.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:ln(e)},()=>new Fm(e.addRef(),n.rpc)),r=t.addCounterpartRef();return t.dispose(),r}function Pt(){return function(n){class e extends n{constructor(...r){var i;super(...r);const s=r[1];this.credentialsProvider=(i=s.credentialsProvider)===null||i===void 0?void 0:i.addRef()}initializeCounterpart(r,i){const s=this.credentialsProvider;i.credentialsProvider=nH(this.chunkManager,s),super.initializeCounterpart(r,i)}static encodeOptions(r){const i=super.encodeOptions(r),s=r.credentialsProvider;return i.credentialsProvider=s===void 0?void 0:ln(s),i}}return e}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const rH=lt(128,128,128);var sr;(function(n){n[n.JPEG=0]="JPEG",n[n.RAW=1]="RAW",n[n.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",n[n.COMPRESSED_SEGMENTATIONARRAY=3]="COMPRESSED_SEGMENTATIONARRAY"})(sr||(sr={}));class Ph{}let QD=class extends Ph{};QD.RPC_ID="dvid/VolumeChunkSource";let eP=class extends Ph{};eP.RPC_ID="dvid/SkeletonSource";let tP=class extends Ph{};tP.RPC_ID="dvid/MeshSource";let nP=class extends Ph{constructor(){super(...arguments),this.chunkDataSize=rH}},Wy=class extends nP{};Wy.RPC_ID="dvid/AnnotationSource";let rP=class extends nP{};rP.RPC_ID="dvid/AnnotationChunkSource";let iP=class{constructor(n,e){this.numLevels=1;try{if(ge(n),e==="dvid"){let t=X(n,"Extended",ge);if(t.MaxDownresLevel){let r=X(t,"MaxDownresLevel",on);this.numLevels=r+1}this.voxelSize=X(t,"VoxelSize",r=>$a(Ne(),r)),this.upperVoxelBound=X(t,"MaxPoint",r=>$a(Ne(),r.map(i=>++i))),this.lowerVoxelBound=X(t,"MinPoint",r=>$a(Ne(),r)),this.blockSize=X(t,"BlockSize",r=>$a(Ne(),r))}else if(e==="gs"){ge(n);const t=X(n,"scales",s=>s);if(t.length===0)throw new Error("Expected at least one scale");const r=t[0];this.voxelSize=X(r,"resolution",s=>Fl(Ne(),s)),this.lowerVoxelBound=ye(r,"offset",s=>$a(Ne(),s))||lt(0,0,0);const i=X(r,"size",s=>$a(Ne(),s));this.upperVoxelBound=ek(Ne(),i,this.lowerVoxelBound),this.blockSize=lt(64,64,64)}else throw new Error("unrecognized volume info")}catch(t){throw new Error(`Failed to parse volume geometry: ${t.message}`)}}},iH=class{constructor(n){try{this.scales=[],this.scales.push(n);let e=n.voxelSize,t=n.lowerVoxelBound,r=n.upperVoxelBound;for(let i=1;i<n.numLevels;++i){let s=j({},n);s.voxelSize=nk(Ne(),e,lt(2,2,2)),e=s.voxelSize,s.upperVoxelBound=gS(Ne(),ug(Ne(),r,lt(2,2,2))),r=s.upperVoxelBound,s.lowerVoxelBound=gS(Ne(),ug(Ne(),t,lt(2,2,2))),t=s.lowerVoxelBound,this.scales.push(s)}}catch(e){throw new Error(`Failed to parse multiscale volume specification: ${e.message}`)}}get numChannels(){return this.scales.length===0?0:this.scales[0].numChannels}},Rh=new de;Rh.set("uint8",q.UINT8);Rh.set("uint32",q.UINT32);Rh.set("uint64",q.UINT64);class sP{constructor(e){this.obj=e,ge(e),X(e,"TypeName",ke)}get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}get tags(){return this.obj.Tags}}class aP{constructor(e,t,r){this.name=t,this.base=r,this.volumeInfo=new iP(lH(r.tags,e),"dvid")}get lowerVoxelBound(){return this.volumeInfo.lowerVoxelBound}get upperVoxelBound(){return this.volumeInfo.upperVoxelBound}get blockSize(){return this.volumeInfo.blockSize}get voxelSize(){return this.volumeInfo.voxelSize}get numLevels(){return this.volumeInfo.numLevels}}class sH extends Dt(Pt()(Bd),QD){}class aH extends Dt(Pt()(bh),eP){}class oH extends Dt(Pt()(Ad),tP){}class Zc extends aP{constructor(e,t,r,i,s){super(e,t,r),this.encoding=i;let a=X(e,"Extended",ge),l=X(a,"Values",u=>We(u,ge));if(l.length<1)throw new Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");let c=new ze(s);if(i!==sr.COMPRESSED_SEGMENTATIONARRAY)for(;c.has(t+"_"+this.volumeInfo.numLevels.toString());)this.volumeInfo.numLevels+=1;c.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",c.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=X(l[0],"DataType",u=>mk(u,Rh))}get volumeType(){return this.encoding===sr.COMPRESSED_SEGMENTATION||this.encoding===sr.COMPRESSED_SEGMENTATIONARRAY?gn.SEGMENTATION:gn.IMAGE}getSources(e,t,r,i){const s=this.encoding,a=[],l=64;for(let c=0;c<this.numLevels;++c){const u=Math.pow(2,c),h=Math.pow(2,-c),g=Ne(),v=Ne();for(let E=0;E<3;++E){const k=Math.floor(this.lowerVoxelBound[E]*h);g[E]=k-k%l;const P=Math.ceil(this.upperVoxelBound[E]*h);v[E]=P,P%l!==0&&(v[E]+=l-P%l)}let y=t.dataInstanceKey;s!==sr.COMPRESSED_SEGMENTATIONARRAY&&c>0&&(y+="_"+c.toString());const C=j(j({},t),{dataInstanceKey:y,dataScale:c.toString(),encoding:s}),S=Je();for(let E=0;E<3;++E)S[5*E]=u,S[12+E]=g[E]*u;const w=$d({rank:3,chunkToMultiscaleTransform:S,dataType:this.dataType,baseVoxelOffset:g,upperVoxelBound:tk(Ne(),v,g),volumeType:this.volumeType,volumeSourceOptions:r,compressedSegmentationBlockSize:s===sr.COMPRESSED_SEGMENTATION||s===sr.COMPRESSED_SEGMENTATIONARRAY?lt(8,8,8):void 0}).map(E=>({chunkSource:e.getChunkSource(sH,{spec:E,parameters:C,credentialsProvider:i}),chunkToMultiscaleTransform:S}));a.push(w)}return cd(a)}}function oP(n){let e=X(n,"Base",ge),t=X(e,"Syncs",kr);return t.length===1?t[0]:""}function lH(n,e){if(!n)return e;const t=e&&e.Extended||{};let r=t.MaxDownresLevel,i=t.MaxPoint,s=t.MinPoint,a=t.VoxelSize,l=t.BlockSize;try{n.MaxDownresLevel&&typeof n.MaxDownresLevel=="string"?(r=parseInt(X(n,"MaxDownresLevel",ke)),r<0&&(r=t.MaxDownresLevel)):typeof n.MaxDownresLevel=="number"&&(r=X(n,"MaxDownresLevel",LV))}catch{}try{n.MaxPoint&&typeof n.MaxPoint=="string"?i=JSON.parse(X(n,"MaxPoint",ke)):Array.isArray(n.MaxPoint)&&n.MaxPoint.length===3&&(i=n.MaxPoint)}catch{}try{n.MinPoint&&typeof n.MinPoint=="string"?s=JSON.parse(X(n,"MinPoint",ke)):Array.isArray(n.MinPoint)&&n.MinPoint.length===3&&(s=n.MinPoint)}catch{}try{n.VoxelSize&&typeof n.VoxelSize=="string"?a=JSON.parse(X(n,"VoxelSize",ke)):Array.isArray(n.VoxelSize)&&n.VoxelSize.length===3&&(a=n.VoxelSize)}catch{}try{n.BlockSize&&typeof n.BlockSize=="string"?l=JSON.parse(X(n,"BlockSize",ke)):Array.isArray(n.BlockSize)&&n.BlockSize.length===3&&(l=n.BlockSize)}catch{}return{Base:e&&e.Base||{},Extended:j(j({},t),{VoxelSize:a,MinPoint:s,MaxPoint:i,MaxDownresLevel:r,BlockSize:l})}}class lP extends aP{get tags(){return X(this.base.obj,"Tags",ge)}constructor(e,t,r){super(e,t,r)}}function dH(n,e,t){ge(n);let r=n[e],i=X(r,"Base",s=>new sP(s));if(i.typeName==="annotation"){let s=oP(r);return s&&(r=n[s]),new lP(r,e,i)}return cH(r,e,t)}function cH(n,e,t){ge(n);let r=X(n,"Base",i=>new sP(i));switch(r.typeName){case"uint8blk":case"grayscale8":let i=r.compressionName.indexOf("jpeg")!==-1;return new Zc(n,e,r,i?sr.JPEG:sr.RAW,t);case"labels64":case"labelblk":return new Zc(n,e,r,sr.COMPRESSED_SEGMENTATION,t);case"labelarray":case"labelmap":return new Zc(n,e,r,sr.COMPRESSED_SEGMENTATIONARRAY,t);default:throw new Error(`DVID data type ${ie(r.typeName)} is not supported.`)}}class _u{constructor(e){if(this.errors=[],this.dataInstances=new de,this.vnodes=new ze,e instanceof _u){this.alias=e.alias,this.description=e.description,this.errors=e.errors,this.dataInstances=e.dataInstances;return}ge(e),this.alias=X(e,"Alias",ke),this.description=X(e,"Description",ke);let t=X(e,"DataInstances",ge),r=Qt(t);for(let a of r)try{this.dataInstances.set(a,dH(t,a,r))}catch(l){let c=`Failed to parse data instance ${ie(a)}: ${l.message}`;console.log(c),this.errors.push(c)}let i=X(e,"DAG",ge),s=X(i,"Nodes",ge);for(let a of Qt(s))this.vnodes.add(a)}}function uH(n){try{let r=av(n,s=>new _u(s)),i=new de;for(let s of r){var e=ae(s,2);let a=e[0],l=e[1];i.set(a,l);for(let c of l.vnodes)if(c!==a){let u=new _u(l);i.set(c,u)}}for(let s of i){var t=ae(s,2);let a=t[0],l=t[1];l.uuid=a}return i}catch(r){throw new Error(`Failed to parse DVID repositories info: ${r.message}`)}}class hH{constructor(e){this.repositories=uH(e)}getNode(e){let t=[];for(let r of this.repositories.keys())r.startsWith(e)&&t.push(r);if(t.length!==1)throw new Error(`Node key ${ie(e)} matches ${ie(t)} nodes.`);return this.repositories.get(t[0])}}function dP(n,e,t){return n.memoize.getUncounted({type:"dvid:getServerInfo",baseUrl:e},()=>{const r=Jj(t,{url:`${e}/api/repos/info`,method:"GET"}).then(s=>new hH(s)),i=`repository info for DVID server ${e}`;return Ke.forPromise(r,{initialMessage:`Retrieving ${i}.`,delay:!0,errorPrefix:`Error retrieving ${i}: `}),r})}class pH extends Is{constructor(e,t,r,i){super(e),this.sourceParameters=t,this.info=r,this.credentialsProvider=i}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}get baseUrl(){return this.sourceParameters.baseUrl}get nodeKey(){return this.sourceParameters.nodeKey}get dataInstanceKey(){return this.sourceParameters.dataInstanceKey}get supervoxels(){return this.sourceParameters.supervoxels||!1}getSegmentPosition(e){const t=this.sourceParameters.dvidService;return t?fetch(`${t}/locate-body?dvid=${this.baseUrl}&uuid=${this.nodeKey}&segmentation=${this.dataInstanceKey}&body=${e.toString()}${this.supervoxels?"&supervoxels=true":""}`,{method:"GET"}).then(r=>r.json()).then(r=>new Float32Array(r)):xt.reject("No locate service is available")}getSources(e){return this.info.getSources(this.chunkManager,this.sourceParameters,e,this.credentialsProvider)}}const fH=/^((?:http|https):\/\/[^\/]+)\/([^\/]+)\/([^\/\?#]+)(?:(?:\?|#)(.*))?$/;function cP(n){if(n.startsWith("https"))return n+"/api/server/token"}function gH(n){let e=n.match(fH);if(e===null)throw new Error(`Invalid DVID URL: ${ie(n)}.`);let t={baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]};const r=e[4];if(r){const i=gd(r);i.usertag==="true"&&(t.usertag=!0),i.user&&(t.user=i.user);const s=i.dvidService||i.dvidservice||i["dvid-service"];s&&(t.dvidService=s),(i.forceDvidService||i.forcedividservice||i["force-dvid-service"])&&(t.forceDvidService=!0),t.supervoxels=i.supervoxels==="true"}return t.authServer=cP(t.baseUrl),t}function mH(n,e,t){return n.usertag?BN(Ne(),t,e):n.chunkDataSize}function vH(n,e){let t=r=>{const i=r.lowerVoxelBound,s=r.upperVoxelBound,a=mH(e,i,s);return{spec:Cd({rank:3,chunkDataSize:Uint32Array.from(a),lowerVoxelBound:i,upperVoxelBound:s}),chunkToMultiscaleTransform:Je()}};if(e.usertag){if(e.user)return[[t(n.scales[0])]];throw"Expecting a valid user"}else return[n.scales.map(r=>t(r))]}const yH=Dt(Pt()(Pr),Wy);class bH extends Dt(Pt()(bo),rP){}class wH extends yH{constructor(e,t){super(e,j({rank:3,relationships:["segments"],properties:t.parameters.properties},t)),this.readonly=!1,this.parameters=t.parameters,this.multiscaleVolumeInfo=t.multiscaleVolumeInfo,this.childAdded=this.childAdded||new Ze,this.childUpdated=this.childUpdated||new Ze,this.childDeleted=this.childDeleted||new Ze,this.childRefreshed=this.childRefreshed||new we,this.parameters.readonly!==void 0&&(this.readonly=this.parameters.readonly),this.parameters.user||(this.readonly=!0)}getSources(e){let t=vH(this.multiscaleVolumeInfo,this.parameters),r=0;return t[0].length>1&&(r=3),this.chunkSources=t.map(i=>i.map(({spec:s,chunkToMultiscaleTransform:a})=>({chunkSource:this.chunkManager.getChunkSource(bH,{spec:j({limit:r,chunkToMultiscaleTransform:a},s),parent:this,credentialsProvider:this.credentialsProvider,parameters:this.parameters}),chunkToMultiscaleTransform:a}))),this.chunkSources}invalidateCache(){this.metadataChunkSource.invalidateCache();for(let e of this.chunkSources)for(let t of e)t.chunkSource.invalidateCache();for(let e of this.segmentFilteredSources)e.invalidateCache();this.childRefreshed.dispatch()}}async function SH(n,e,t,r){let i=(a,l)=>n.chunkManager.getChunkSource(wH,{parameters:l,credentialsProvider:r,multiscaleVolumeInfo:a}),s=new iH(t.volumeInfo);return i(s,e)}async function CH(n,e,t,r){const i={lowerBounds:new Float64Array(t.lowerVoxelBound),upperBounds:Float64Array.from(t.upperVoxelBound)},s=st({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(t.voxelSize,l=>l/1e9),boundingBoxes:[aa(i)]}),a=await SH(n,e,t,r);return{modelTransform:zn(s),subsources:[{id:"default",subsource:{annotation:a},default:!0}]}}function xH(n,e,t,r){const i=t,s={lowerBounds:new Float64Array(i.lowerVoxelBound),upperBounds:Float64Array.from(i.upperVoxelBound)},a=st({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(i.voxelSize,u=>u/1e9),boundingBoxes:[aa(s)]}),l=new pH(n.chunkManager,e,i,r),c={modelTransform:zn(a),subsources:[{id:"default",subsource:{volume:l},default:!0}]};if(i.meshSrc){const u=Je();for(let h=0;h<3;++h)u[5*h]=1/i.voxelSize[h];c.subsources.push({id:"meshes",default:!0,subsource:{mesh:n.chunkManager.getChunkSource(oH,{parameters:j(j({},e),{segmentationName:i.name,dataInstanceKey:i.meshSrc}),credentialsProvider:r})},subsourceToModelSubspaceTransform:u})}return i.skeletonSrc&&c.subsources.push({id:"skeletons",default:!0,subsource:{mesh:n.chunkManager.getChunkSource(aH,{parameters:j(j({},e),{dataInstanceKey:i.skeletonSrc}),credentialsProvider:r})}}),c.subsources.push({id:"bounds",subsource:{staticAnnotations:yd(s)},default:!0}),c}function EH(n){return n.chunkManager.memoize.getUncounted({type:"dvid:MultiscaleVolumeChunkSource",sourceUrl:n.providerUrl},async()=>{const e=gH(n.providerUrl),t=e.baseUrl,r=e.nodeKey,i=e.dataInstanceKey,s=r.indexOf(":"),a=s!==-1?r.slice(0,s):r,l=n.credentialsManager.getCredentialsProvider(Gy,{dvidServer:e.baseUrl,authServer:e.authServer}),c=(await dP(n.chunkManager,t,l)).getNode(a);if(c===void 0)throw new Error(`Invalid node: ${ie(r)}.`);const u=c.dataInstances.get(i);if(!u)throw new Error(`Invalid data instance ${i}.`);if(u.base.typeName==="annotation"){if(!(u instanceof lP))throw new Error(`Invalid data instance ${i}.`);let h=j(j({},new Wy),e);return u.blockSize&&(h.chunkDataSize=u.blockSize),h.syncedLabel=oP({Base:u.base.obj}),h.properties=[{identifier:"rendering_attribute",description:"rendering attribute",type:"int32",default:0,min:0,max:5,step:1},{identifier:"confidence",description:"confidence",type:"float32",default:0,min:0,max:1,step:.01}],CH(n,h,u,l)}else{if(!(u instanceof Zc))throw new Error(`Invalid data instance ${i}.`);return xH(n,e,u,l)}})}function TH(n,e){return{offset:0,completions:_o(e,n.dataInstances.values(),t=>t.name,t=>`${t.base.typeName}`)}}function kH(n,e){let t=e.match(/^(?:([^\/]+)(?:\/([^\/]*))?)?$/);if(t===null)throw new Error("Invalid DVID URL syntax.");if(t[2]===void 0)return{offset:0,completions:_o(e,n.repositories.values(),s=>s.uuid+"/",s=>`${s.alias}: ${s.description}`)};let r=t[1],i=n.getNode(r);return Fo(r.length+1,TH(i,t[2]))}async function LH(n){const e=/^((?:http|https):\/\/[^\/]+)\/([^\?]*).*$/;let t=n.providerUrl.match(e);if(t===null)throw null;let r=t[1],i=t[2],s=cP(r);const a=await dP(n.chunkManager,r,n.credentialsManager.getCredentialsProvider(Gy,{dvidServer:r,authServer:s}));return Fo(r.length+1,kH(a,i))}class IH extends oa{constructor(e){super(),this.credentialsManager=e}get description(){return"DVID"}get(e){return EH(e)}completeUrl(e){return LH(e)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ca("dvid",n=>new IH(n.credentialsManager));function pT(n){return n.text()}function DH(n,e,t,r=Vt){const i={method:t.method,body:t.payload};return i.method==="POST"&&(i.headers={"Content-Type":"application/json"}),RH(n,e,t.url,i,si,r)}function PH(n){return(e,t)=>{let r=j({},t);return e?r.headers=j(j({},r.headers),{Authorization:`Bearer ${e}`}):n.startsWith("https:")&&(r.credentials="include"),r}}function RH(n,e,t,r,i,s=Vt){return py(n,t,r,i,PH(t),a=>{const l=a.status;if((l===403||l===401)&&e)return"refresh";if(l===504)return"retry";throw a},s)}function MH(n){return"neurohub"in n?xt.resolve(n.neurohub.clio.auth.getAuthResponse().id_token):xt.resolve("")}class AH extends _d{constructor(e,t){super(),this.authServer=e,this.retry=t,this.get=Sh(r=>{const i=new Ke(!0);let s;return new xt((a,l)=>{const c=()=>{s=void 0,i.dispose()};r.add(()=>{s!==void 0&&(s.cancel(),s=void 0,i.dispose(),l(ms))});const u=(g="Authorization required.",v="Request authorization.")=>{if(i.setText(g+" "),this.retry){let y=document.createElement("button");y.textContent=v,i.element.appendChild(y),y.addEventListener("click",this.retry)}i.setVisible(!0)};let h=this.authServer;s!==void 0&&s.cancel(),s=new Es,u("Waiting for authorization...","Retry"),this.getAuthToken(h,s).then(g=>{s!==void 0&&(c(),a(g))},g=>{s!==void 0&&(s=void 0,u(`Authorization failed: ${g}.`,"Retry"))})})})}getAuthToken(e,t=Vt){if(e){if(e.startsWith("token:"))return xt.resolve(e.substring(6));if(e=="neurohub")return MH(window);{const r=new Headers;return ys(e,{method:"GET",headers:r},pT,t).catch(()=>ys(e,{method:"GET"},pT,t))}}else return xt.resolve("")}}const uP="Clio",NH=/^([^\/]+:\/\/[^\/]+)\/([^\/]+)\/([^\/\?]+)(\?.*)?$/;function VH(n){let e=n.match(NH);if(e===null)throw new Error(`Invalid DVID URL: ${ie(n)}.`);return{baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]}}function hP(n){let e=Io(n);return e.protocol==="precomputed"&&(e=Io(e.host+e.path)),e}function pP(n){let e=n.protocol,t=n.host,r=n.path;switch(e){case"gs":return`https://storage.googleapis.com/${t}${r}/info`;case"dvid":const i=VH(t+r);return`${i.baseUrl}/api/node/${i.nodeKey}/${i.dataInstanceKey}/info`;case"https":return`${e}://${t}${r}/info`;default:throw Error("Unrecognized volume information")}}class OH{constructor(e){this.parameters=e}getTopLevelUrl(){var e=this.parameters;const t=e.baseUrl,r=e.api;return`${t}/${r||"clio_toplevel"}`}getDatasetsUrl(){return`${this.getTopLevelUrl()}/datasets`}getGrayscaleInfoUrl(){let e=hP(this.parameters.grayscale);return pP(e)}getAnnotationEndpoint(){return this.parameters.kind==="Atlas"?"atlas":"annotations"}getAnnotationEntryUrl(){return`${this.getTopLevelUrl()}/${this.getAnnotationEndpoint()}/${this.parameters.dataset}`}getAllAnnotationsUrl(){return this.getAnnotationEntryUrl()+(this.parameters.groups?`?groups=${this.parameters.groups}`:"")}hasPointQueryApi(){return this.parameters.api==="clio_toplevel"||this.parameters.kind==="Atlas"}getPostAnnotationUrl(e){return this.hasPointQueryApi()?`${this.getAnnotationEntryUrl()}?x=${e[0]}&y=${e[1]}&z=${e[2]}`:this.getAnnotationEntryUrl()}getDeleteAnnotationUrl(e){if(this.hasPointQueryApi()){const t=e.match(/(-?\d+)_(-?\d+)_(-?\d+)/);if(t)return this.getAnnotationUrl(t?.slice(1,4))}return`${this.getAnnotationEntryUrl()}/${e}`}getAnnotationUrl(e){return`${this.getAnnotationEntryUrl()}?x=${e[0]}&y=${e[1]}&z=${e[2]}`}}/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class BH extends AH{constructor(e){super(e),this.authServer=e}}$o.register(uP,n=>new BH(n));const FH="annotation.add.signal";Tt(FH,function(n){const e=this.get(n.id),t=dv(n.newAnnotation);t&&(e.parent.updateReference(t),e.parent.childAdded.dispatch(t))});class _H{constructor(e){this.annotation=e}get renderingAttribute(){if(this.kind==="Atlas")if(this.title){if(this.checked)return 1}else return-1;else{if(this.bookmarkType==="False Split")return 2;if(this.bookmarkType==="False Merge")return 3}return 0}get confidence(){return 0}updateProperties(){this.annotation.properties=[this.renderingAttribute,this.confidence]}get ext(){return this.annotation.ext===void 0&&(this.annotation.ext={}),this.annotation.ext}get prop(){return this.annotation.prop}set prop(e){this.annotation.prop=e}get bookmarkType(){if(this.prop)switch(this.prop.type){case"Split":return"False Merge";case"Merge":return"False Split"}return"Other"}get type(){return this.annotation.type}get kind(){return this.annotation.kind}set kind(e){this.annotation.kind=e,this.update()}roundPos(){this.annotation.type===Pe.POINT?this.annotation.point=this.annotation.point.map(e=>Math.round(e)):(this.annotation.type===Pe.LINE||this.annotation.type===Pe.SPHERE)&&(this.annotation.pointA=this.annotation.pointA.map(e=>Math.round(e)),this.annotation.pointB=this.annotation.pointB.map(e=>Math.round(e)))}setProp(e){this.prop=j(j({},this.prop),e)}get user(){return this.prop&&this.prop.user}set user(e){this.setProp({user:e})}get comment(){return this.prop&&this.prop.comment}get description(){return this.comment}updatePresentation(){this.title?this.annotation.description=this.title+": ":this.annotation.description="",this.description&&(this.annotation.description+=this.description)}update(){this.updatePresentation(),this.updateProperties()}set comment(e){this.setProp({comment:e}),this.updatePresentation()}updateComment(){this.comment=this.annotation.description||"",this.annotation.description=void 0}get title(){return this.prop&&this.prop.title}set title(e){this.setProp({title:e}),this.updatePresentation()}get timestamp(){return this.prop&&this.prop.timestamp?Number(this.prop.timestamp):0}addTimeStamp(){this.setProp({timestamp:String(Date.now())})}get checked(){return this.ext&&this.ext.verified||this.prop&&this.prop.checked||!1}set checked(e){this.setProp({checked:e})}get presentation(){return this.updatePresentation(),this.annotation.description||""}set presentation(e){this.annotation.description=e}}function UH(n){const e=n.split(".")[1];if(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(window.atob(t).split("").map(function(i){return"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(r)}}function fP(n,e){let t;const r=UH(n);return r&&("user"in r?t=r.user:"email"in r&&(t=r.email)),t||(t=e),t}const $H={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["comment"],properties:{comment:{$id:"#/properties/Prop/properties/comment",type:"string",title:"Comment",default:""}}}}};class Uc extends _H{get title(){return this.annotation.ext&&this.annotation.ext.title}set title(e){this.ext.title=e}get description(){return this.annotation.ext&&this.annotation.ext.description}set description(e){this.ext.description=e}get user(){return this.annotation.ext&&this.annotation.ext.user}set user(e){this.ext.user=e}get checked(){return this.ext&&this.ext.verified}set checked(e){this.ext.verified=e}}function zH(n){let e=n.match(/^\${(.*):JSON}$/);return e?JSON.parse(e[1]):null}const GH={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["description"],properties:{description:{$id:"#/properties/Prop/properties/description",type:"string",title:"Description",default:""}}}}},WH={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["title","description"],properties:{title:{$id:"#/properties/Prop/properties/title",type:"string",title:"Title",default:""},description:{$id:"#/properties/Prop/properties/description",type:"string",title:"Description",default:""}}}}};function gP(n){return Array.isArray(n)}function jH(n){return gP(n)||n===null?!1:typeof n=="object"}class mP{constructor(e){this.name=e,this.childNodeList=new Array,this.parentNode=null}isRoot(){return this.parentNode===null}isLeaf(){return this.childNodeList.length===0}*[An](){function*e(t){yield t;for(let r of t.childNodeList)yield*e(r)}yield*e(this)}*leafNodes(){for(let e of this)e.childNodeList.length===0&&(yield e)}get fullName(){let e=this.name,t=this.parentNode;for(;t;)e=t.name+"/"+e,t=t.parentNode;return e}get nameArray(){let e=new Array;if(!this.isRoot()){e.push(this.name);let t=this.parentNode;for(;t&&!t.isRoot();)e.push(t.name),t=t.parentNode}return e}getPropertyValue(e){if(!this.isRoot()&&e){let t=this.nameArray,r=e;for(let i=t.length-1;i>=0;--i)if(jH(r)){let s=t[i];r=r[s]}else return r;return r}}}function vP(n,e){if(n.type=="object"){e.properties==null&&(e.properties={}),e.properties.title=n.title;let t=n.required;gP(t)&&t.forEach(r=>{let i=new mP(r);i.parentNode=e,e.childNodeList.push(i);let s=n.properties[r];vP(s,i)})}else e.properties=n}function HH(n,e){let t=new mP(e);return vP(n,t),t}const qH="annotation";function JH(n,e,t,r=!1){let i=document.createElement("div"),s=n.title;s&&i.appendChild(document.createTextNode(s));let a;switch(n.type){case"number":a=document.createElement("input"),typeof t=="number"&&(a.text=t);break;case"string":let l=n.enum;Array.isArray(l)?(a=document.createElement("select"),i.appendChild(a),l.forEach(c=>{let u=document.createElement("option");u.text=c,u.value=c,u.disabled=r,a.appendChild(u)}),t!==void 0&&(a.value=t)):(a=document.createElement("input"),a.setAttribute("autocomplete","off"),typeof t=="string"&&(a.value=t,a.setAttribute("value",t)));break;case"boolean":a=document.createElement("input"),a.type="checkbox",typeof t=="boolean"?a.checked=t:a.checked=t==1;break}return a&&(a.id=e,a.readOnly=r,i.appendChild(a)),i}function YH(n,e){return n+"/"+e}function XH(n,e,t,r=!1){let i=document.createElement("div"),s=HH(n,t);s.record=i;for(let a of s)if(!a.isRoot())if(a.isLeaf()){let l=a.getPropertyValue(e),c=JH(a.properties,a.fullName,l,r);a.parentNode.record.appendChild(c)}else{let l=document.createElement("fieldset"),c=document.createElement("legend");c.textContent=a.properties.title,l.appendChild(c),a.record=l,a.parentNode.record.appendChild(l)}return i}function KH(n,e,t=!1){return XH(n,e,qH,t)}function ZH(n){let e=document.getElementById(n);if(e)return e.type==="checkbox"?e.checked:e.value}function yP(n,e,t,r){n.type==="object"?n.required.forEach(i=>{let s=t;e&&(typeof t[e]>"u"&&(t[e]={}),s=t[e]),yP(n.properties[i],i,s,YH(r,i))}):t[e]=ZH(r)}function QH(n,e,t,r,i,s){const a=j({},n.value);if(a.type!==Pe.POINT&&a.type!==Pe.LINE&&a.type!==Pe.SPHERE)return null;e||(e=$H);const l=r(a),c=i?i(a):l.prop;let u=KH(e,c?{Prop:c}:{},t.readonly),h=document.createElement("button");return h.textContent="update",h.onclick=()=>{let g={};yP(e,"",g,"annotation");const v=g.Prop;s?s(a,v):l.setProp(v),l.update(),t.update(n,a),t.commit(n)},u.appendChild(h),u}let e5=`
{
  "definitions": {},
  "type": "object",
  "required": [
    "Prop"
  ],
  "properties": {
    "Prop": {
      "$id": "#/properties/Prop",
      "type": "object",
      "title": "Properties",
      "required": [
        "comment",
        "type",
        "checked"
      ],
      "properties": {
        "comment": {
          "$id": "#/properties/Prop/properties/comment",
          "type": "string",
          "title": "Comment",
          "default": ""
        },
        "type": {
          "$id": "#/properties/Prop/properties/type",
          "type": "string",
          "title": "Type",
          "enum": ["Merge", "Split", "Other"]
        },
        "checked": {
          "$id": "#/properties/Prop/properties/checked",
          "type": "boolean",
          "title": "Checked"
        }
      }
    }
  }
}
`;JSON.parse(e5);/**
 * @license
 * This work is a derivative of the Google Neuroglancer project,
 * Copyright 2016 Google Inc.
 * The Derivative Work is covered by
 * Copyright 2019 Howard Hughes Medical Institute
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const t5=lt(64,64,64);class n5{}function r5(n){return n.authServer?n.authServer==="neurohub"||n.authServer.startsWith("http"):!1}class bP extends n5{constructor(){super(...arguments),this.chunkDataSize=t5}}let jy=class extends bP{};jy.RPC_ID="clio/Annotation";class wP extends bP{}wP.RPC_ID="clio/AnnotationChunkSource";class i5 extends Dt(Pt()(bo),wP){}async function s5(n){const e=n.grayscale;if(e){let t=hP(e);return qj({method:"GET",url:pP(t)}).then(r=>new iP(r,t.protocol==="https"?"gs":t.protocol))}else return xt.resolve({numChannels:1,voxelSize:lt(8,8,8),lowerVoxelBound:lt(0,0,0),upperVoxelBound:lt(5e4,5e4,5e4),blockSize:lt(64,64,64),numLevels:1})}function a5(n){return[[(e=>{const t=e.upperVoxelBound;return{spec:Cd({rank:3,chunkDataSize:Uint32Array.from(t),lowerVoxelBound:e.lowerVoxelBound,upperVoxelBound:e.upperVoxelBound}),chunkToMultiscaleTransform:Je()}})(n)]]}const o5=Dt(Pt()(Pr),jy);class l5 extends o5{constructor(e,t){super(e,j({rank:3,relationships:["segments"],properties:t.parameters.properties},t)),this.readonly=!1,this.parameters=t.parameters,this.dataInfo=t.dataInfo,this.childAdded=this.childAdded||new Ze,this.childUpdated=this.childUpdated||new Ze,this.childDeleted=this.childDeleted||new Ze,this.makeEditWidget=r=>{const i=l=>new Uc(l),s=l=>j(j({},l.prop),l.ext),a=(l,c)=>{const u=new Uc(l);c.title&&(u.title=c.title),c.description&&(u.description=c.description)};return QH(r,this.parameters.schema,this,i,s,a)},this.getUser=()=>this.parameters.user}getSources(e){let t=a5(this.dataInfo),r=0;return t[0].length>1&&(r=10),t.map(i=>i.map(({spec:s,chunkToMultiscaleTransform:a})=>({chunkSource:this.chunkManager.getChunkSource(i5,{spec:j({limit:r,chunkToMultiscaleTransform:a},s),parent:this,credentialsProvider:this.credentialsProvider,parameters:this.parameters}),chunkToMultiscaleTransform:a})))}*[An](){for(let e of this.references)e[1].value&&(yield e[1].value)}commit(e){e.value&&(e.value.type===Pe.LINE||e.value.type===Pe.SPHERE)&&(e.value.pointA=e.value.pointA.map(t=>Math.round(t)),e.value.pointB=e.value.pointB.map(t=>Math.round(t))),super.commit(e)}add(e,t=!0){if(this.readonly){let i="Permission denied for changing annotations.";throw Ke.showTemporaryMessage(i),Error(i)}const r=new Uc(e);if(r.addTimeStamp(),this.parameters.user&&(r.user=this.parameters.user),e.type===Pe.POINT&&(r.kind=this.parameters.kind||"Note",e.description)){let i=zH(e.description);i&&r.setProp(i)}return r.roundPos(),r.update(),super.add(e,t)}update(e,t){const r=new Uc(t);r.roundPos(),r.update(),super.update(e,t)}invalidateCache(){this.references.forEach(e=>{e.dispose()}),this.references.clear(),this.childRefreshed.dispatch(),this.metadataChunkSource.invalidateCache();for(let e of this.getSources({multiscaleToViewTransform:new Float32Array,displayRank:1,modelChannelDimensionIndices:[]}))for(let t of e)t.chunkSource.invalidateCache();for(let e of this.segmentFilteredSources)e.invalidateCache()}}async function d5(n,e,t,r){return((i,s)=>n.chunkManager.getChunkSource(l5,{parameters:s,credentialsProvider:r,dataInfo:i}))(t,e)}async function c5(n,e,t){const r=await s5(e),i={lowerBounds:new Float64Array(r.lowerVoxelBound),upperBounds:Float64Array.from(r.upperVoxelBound)},s=st({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(r.voxelSize,l=>l/1e9),boundingBoxes:[aa(i)]}),a=await d5(n,e,r,t);return{modelTransform:zn(s),subsources:[{id:"default",subsource:{annotation:a},default:!0}]}}const u5=/^([^\/]+:\/\/[^\/]+)\/(?:([^\/\?#]+)\/)?([^\/\?#]+)(?:(?:\?|#)(.*))?$/;function h5(n){let e=n.match(u5);if(e===null)throw new Error(`Invalid Clio URL: ${ie(n)}.`);let t={baseUrl:e[1],api:e[2],dataset:e[3]},r=e[4];if(r){let i=gd(r);i.token?(t.authToken=i.token,t.authServer="token:"+i.token):i.auth&&(t.authServer=i.auth),i.user?t.user=i.user:t.authToken&&(t.user=fP(t.authToken)),i.kind?i.kind==="atlas"?t.kind="Atlas":t.kind=i.kind:t.kind="Normal",i.groups&&(t.groups=i.groups)}return t}async function p5(n,e){const t=new OH(n);return DH(e(n.authServer),r5(n),{url:t.getDatasetsUrl(),method:"GET"}).then(r=>{const i=X(r,n.dataset,ge);if("location"in i)n.grayscale=X(i,"location",ke);else if("mainLayer"in i){const s=X(i,"mainLayer",ke),a=X(i,"neuroglancer",ge).layers.find(l=>l.name===s);a.source&&a.source.url?n.grayscale=X(a.source,"url",ke):n.grayscale=X(a,"source",ke)}return n})}async function f5(n,e){let t=h5(n.providerUrl);if(!t.user&&t.authServer){let r=e(t.authServer).get();t.authToken=(await r).credentials,t.user=fP(t.authToken)}return n.chunkManager.memoize.getUncounted(j({type:"clio:MultiscaleVolumeChunkSource"},t),async()=>{t=await p5(t,e);let r=j(j({},new jy),t);t.kind==="Atlas"?r.schema=WH:r.schema=GH,r.properties=[{identifier:"rendering_attribute",description:"rendering attribute",type:"int32",default:0,min:0,max:5,step:1}];const i=e(t.authServer);return c5(n,r,i)})}async function g5(n){return xt.resolve({offset:0,completions:[{value:""}]})}class m5 extends oa{constructor(e){super(),this.credentialsManager=e,this.description="Clio"}getCredentialsProvider(e){let t="";return e&&(t=e),this.credentialsManager.getCredentialsProvider(uP,t)}get(e){return f5(e,this.getCredentialsProvider.bind(this))}completeUrl(e){return g5(e.providerUrl)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ca("clio",n=>new m5(n.credentialsManager));/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Mh="google-brainmaps";function Ha(n,e,t,r=Vt){return Js(e,`${n.serverUrl}${t.path}`,{method:t.method,body:t.payload},t.responseType==="json"?si:z$,r)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var wi;(function(n){n[n.RAW=0]="RAW",n[n.JPEG=1]="JPEG",n[n.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"})(wi||(wi={}));class SP{}SP.RPC_ID="brainmaps/VolumeChunkSource";let CP=class{};CP.RPC_ID="brainmaps/MultiscaleMeshSource";let xP=class{};xP.RPC_ID="brainmaps/MeshSource";let EP=class{};EP.RPC_ID="brainmaps/SkeletonSource";let TP=class{};TP.RPC_ID="brainmaps/Annotation";let kP=class{};kP.RPC_ID="brainmaps/AnnotationSpatialIndex";class v5 extends Dt(Pt()(Bd),SP){}class y5 extends Dt(Pt()(yh),CP){}class b5 extends Dt(Pt()(Ad),xP){}class w5 extends Dt(Pt()(bh),EP){}class S5 extends Dt(Pt()(bo),kP){}const zd=new de;zd.set("UINT8",q.UINT8);zd.set("FLOAT",q.FLOAT32);zd.set("UINT32",q.UINT32);zd.set("UINT64",q.UINT64);function C5(n){ge(n);try{return{corner:X(n,"corner",e=>iu(Ne(),e,vt)),size:X(n,"size",e=>iu(Ne(),e,yn)),metadata:X(n,"metadata",Ir)}}catch(e){throw new Error(`Failed to parse bounding box: ${e.message}`)}}class x5{constructor(e){try{ge(e),this.numChannels=X(e,"channelCount",on),this.dataType=X(e,"channelType",t=>mk(t,zd)),this.voxelSize=X(e,"pixelSize",t=>iu(Ne(),t,yn)),this.upperVoxelBound=X(e,"volumeSize",t=>iu(Ne(),t,on)),this.boundingBoxes=X(e,"boundingBox",t=>t===void 0?[]:We(t,C5))}catch(t){throw new Error(`Failed to parse BrainMaps volume geometry: ${t.message}`)}}}function E5(n){return ge(n),{name:X(n,"name",ke),type:X(n,"type",ke)}}function T5(n){try{return ge(n),X(n,"meshes",e=>e===void 0?[]:We(e,E5))}catch(e){throw new Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}}const k5="([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",ng="([0-9]+)",LP=new RegExp(`^(.*)_${ng}x${ng}x${ng}_lod([0-9]+)_${k5}$`);function L5(n,e){const t=new de,r=n.scales[0],i=new ze;for(const a of e){if(a.type!=="TRIANGLES")continue;const l=a.name.match(LP);if(l===null)continue;const c=l[1];let u=t.get(c);u===void 0&&(u={key:c,chunkShape:Ne(),lods:[]},t.set(c,u));const h=parseInt(l[5]);if(u.lods[h]!==void 0){i.add(c);continue}const g=lt(parseInt(l[2],10),parseInt(l[3],10),parseInt(l[4],10)),v=new Uint32Array(3);for(let y=0;y<3;++y)v[y]=Math.ceil(r.upperVoxelBound[y]/g[y]);u.lods[h]={info:a,scale:parseFloat(l[6]),relativeBlockShape:g,gridShape:v}}const s=[];e:for(const a of t.values()){if(i.has(a.key))continue e;const l=a.lods[0];if(l===void 0)continue e;const c=l.relativeBlockShape;nk(a.chunkShape,c,r.voxelSize);for(let u=1;u<a.lods.length;++u){const h=a.lods[u];if(h===void 0)continue e;const g=h.relativeBlockShape;for(let v=0;v<3;++v){const y=g[v],C=c[v];if(y<C||y%C!==0)continue e;g[v]=y/C}}c.fill(1),s.push(a)}return s}function I5(n,e){const t=L5(n,e),r=[],i=a=>{r.some(l=>l.name===a.name)||r.push(a)},s=new ze;for(const a of t){i({multi:a,single:void 0,name:a.key,partOfMultiscale:!1});for(const l of a.lods)s.add(l.info)}for(const a of e)i({single:a,multi:void 0,name:a.name,partOfMultiscale:s.has(a)});return r}class D5{constructor(e){try{ge(e);let t=this.scales=X(e,"geometry",a=>We(a,l=>new x5(l)));if(t.length===0)throw new Error("Expected at least one scale.");let r=t[0],i=this.numChannels=r.numChannels,s=this.dataType=r.dataType;for(let a=1,l=t.length;a<l;++a){let c=t[a];if(c.dataType!==s)throw new Error(`Scale ${a} has data type ${q[c.dataType]} but scale 0 has data type ${q[s]}.`);if(c.numChannels!==i)throw new Error(`Scale ${a} has ${c.numChannels} channel(s) but scale 0 has ${i} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(r.upperVoxelBound)}}catch(t){throw new Error(`Failed to parse BrainMaps multiscale volume specification: ${t.message}`)}}getModelSpace(e=!1){const t=this.scales[0],r=["x","y","z"],i=["m","m","m"],s=Te(t.voxelSize,l=>l/1e9),a=Te(t.upperVoxelBound);return e&&(r.push("c^"),i.push(""),s.push(1),a.push(this.numChannels)),st({names:r,units:i,scales:Float64Array.from(s),boundingBoxes:[aa({lowerBounds:new Float64Array(r.length),upperBounds:Float64Array.from(a)})]})}}let P5=class extends Is{constructor(n,e,t,r,i,s,a){super(n),this.instance=e,this.credentialsProvider=t,this.volumeId=r,this.changeSpec=i,this.multiscaleVolumeInfo=s,this.encoding=a.encoding,this.jpegQuality=a.jpegQuality,this.chunkLayoutPreference=a.chunkLayoutPreference;let l=gn.IMAGE;this.dataType===q.UINT64&&(l=gn.SEGMENTATION),this.volumeType=l}get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return this.multiscaleVolumeInfo.numChannels!==1?4:3}getSources(n){let e=wi.RAW;(this.dataType===q.UINT64||this.dataType===q.UINT32)&&this.volumeType===gn.SEGMENTATION&&this.encoding!==wi.RAW?e=wi.COMPRESSED_SEGMENTATION:this.volumeType===gn.IMAGE&&this.dataType===q.UINT8&&this.multiscaleVolumeInfo.numChannels===1&&this.encoding!==wi.RAW&&n.discreteValues!==!0&&(e=wi.JPEG);const t=e===wi.JPEG?this.jpegQuality:void 0,r=this.scales[0],i=r.upperVoxelBound,s=Ne(),a=this.rank;return cd(this.scales.map((l,c)=>{ug(s,l.voxelSize,r.voxelSize);let u=l.upperVoxelBound,h,g=l.numChannels;const v=new Float32Array((a+1)**2);v[(a+1)*a+a]=1;const y=new Float32Array(a);g!==1&&(u=Float32Array.of(...u,g),h=Uint32Array.of(1,1,1,g),v[(a+1)*3+3]=1,y[3]=g);for(let C=0;C<3;++C)v[(a+1)*C+C]=s[C],y[C]=i[C]/s[C];return $d({rank:a,minBlockSize:h,chunkToMultiscaleTransform:v,dataType:l.dataType,upperVoxelBound:u,volumeType:this.volumeType,volumeSourceOptions:n,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:lt(64,64,64)}).map(C=>({chunkSource:this.chunkManager.getChunkSource(v5,{credentialsProvider:this.credentialsProvider,spec:C,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:c,encoding:e,jpegQuality:t,instance:this.instance}}),chunkToMultiscaleTransform:v,upperClipBound:y}))}))}};function R5(n){const e=Je(),t=n.scales[0].voxelSize;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}function M5(n){const e=n.match(/^([^:?\/]+:[^:?\/]+:[^:?\/]+)(?::([^:?\/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(e===null)throw new Error(`Invalid Brain Maps volume key: ${ie(n)}.`);let t;e[2]!==void 0&&(t={changeStackId:e[2]});const r=gd(e[4]||"");return{volumeId:e[1],changeSpec:t,meshName:e[3],parameters:r}}function A5(n){try{return ge(n),{id:X(n,"id",ke),label:X(n,"label",ke),description:X(n,"description",Ir)}}catch(e){throw new Error(`Failed to parse project: ${e.message}`)}}function N5(n){try{return ge(n),X(n,"project",e=>e===void 0?[]:We(e,A5))}catch(e){throw new Error(`Error parsing project list: ${e.message}`)}}function fT(n,e){try{return ge(n),X(n,e,t=>t===void 0?[]:We(t,ke))}catch(t){throw new Error(`Error parsing dataset list: ${t.message}`)}}function V5(n){return X(n,"changeStackId",e=>e===void 0?void 0:We(e,ke))}const O5=Dt(Pt()(Pr),TP);class B5 extends O5{constructor(e,t){super(e,j({rank:3,relationships:["segments"],properties:[]},t)),this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}hasNonSerializedProperties(){return!0}getSources(){const e=this.parameters.upperVoxelBound,t=Cd({rank:3,chunkDataSize:e,upperVoxelBound:e}),r=Je();return[[{chunkSource:this.chunkManager.getChunkSource(S5,{parent:this,spec:j({limit:0,chunkToMultiscaleTransform:r},t),parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:r}]]}}const F5=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}];class IP extends oa{constructor(e,t){super(),this.instance=e,this.credentialsProvider=t}get description(){return this.instance.description}getMultiscaleInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance,credentialsProvider:ln(this.credentialsProvider)},()=>Ha(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes/${t}`,responseType:"json"}).then(r=>new D5(r)))}getMeshesInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance,credentialsProvider:ln(this.credentialsProvider)},()=>Ha(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/objects/${t}/meshes`,responseType:"json"}).then(r=>T5(r)))}get(e){var t=M5(e.providerUrl);const r=t.volumeId,i=t.changeSpec,s=t.meshName,a=t.parameters;ge(a);const l=ye(a,"encoding",g=>Mn(g,wi)),c=ye(a,"jpegQuality",g=>{const v=hn(g);if(v<1||v>100)throw new Error(`Expected integer in range [1, 100], but received: ${g}`);return v},70),u=ye(a,"chunkLayout",g=>Mn(g,to)),h={encoding:l,chunkLayoutPreference:u,jpegQuality:c};return e.chunkManager.memoize.getUncounted({type:"brainmaps:get",instance:this.instance,volumeId:r,changeSpec:i,brainmapsOptions:h},async()=>{var g=await xt.all([this.getMultiscaleInfo(e.chunkManager,r),this.getMeshesInfo(e.chunkManager,r)]),v=ae(g,2);const y=v[0],C=v[1],S=new P5(e.chunkManager,this.instance,this.credentialsProvider,r,i,y,h),w={modelTransform:zn(y.getModelSpace(y.numChannels!==1)),subsources:[{id:s===void 0?"default":"volume",subsource:{volume:S},default:s===void 0}]},E=yd(y.box);y.scales[0].boundingBoxes.forEach((D,L)=>{E.add({type:Pe.AXIS_ALIGNED_BOUNDING_BOX,description:D.metadata,pointA:D.corner,pointB:ek(Ne(),D.corner,D.size),id:`boundingBox${L}`,properties:[]})}),w.subsources.push({id:"bounds",subsource:{staticAnnotations:E},default:!0});const k=I5(y,C),P=(D,L)=>{let R;const M=D.single;if(M!==void 0)M.type==="TRIANGLES"?R=e.chunkManager.getChunkSource(b5,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:r,meshName:M.name,changeSpec:i}}):R=e.chunkManager.getChunkSource(w5,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:r,meshName:D.name,changeSpec:i}});else{const V=D.multi;R=e.chunkManager.getChunkSource(y5,{credentialsProvider:this.credentialsProvider,format:{fragmentRelativeVertices:!1,vertexPositionFormat:Ii.float32},parameters:{instance:this.instance,volumeId:r,info:V,changeSpec:i}})}w.subsources.push({id:s===void 0?`/${D.name}`:"default",subsource:{mesh:R},subsourceToModelSubspaceTransform:R5(y),modelSubspaceDimensionIndices:[0,1,2],default:L})};if(s!==void 0){const D=k.find(L=>L.name===s);if(D===void 0)throw new Error(`Mesh/skeleton source not found: ${ie(D)}`);P(D,!0)}else{let D=!0;for(const L of k)L.partOfMultiscale||(P(L,D),D=!1)}return i!==void 0&&w.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.chunkManager.getChunkSource(B5,{parameters:{volumeId:r,changestack:i.changeStackId,instance:this.instance,upperVoxelBound:y.scales[0].upperVoxelBound},credentialsProvider:this.credentialsProvider})}}),w})}getProjectList(e){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getProjectList"},()=>{let t=Ha(this.instance,this.credentialsProvider,{method:"GET",path:"/v1beta2/projects",responseType:"json"}).then(i=>N5(i));const r=`${this.instance.description} project list`;return Ke.forPromise(t,{delay:!0,initialMessage:`Retrieving ${r}.`,errorPrefix:`Error retrieving ${r}: `}),t})}getDatasetList(e,t){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},()=>{let r=Ha(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/datasets?project_id=${t}`,responseType:"json"}).then(s=>fT(s,"datasetIds"));const i=`${this.instance.description} dataset list`;return Ke.forPromise(r,{delay:!0,initialMessage:`Retrieving ${i}`,errorPrefix:`Error retrieving ${i}`}),r})}getVolumeList(e,t,r){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:${r}:getVolumeList`},()=>{let i=Ha(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes?project_id=${t}&dataset_id=${r}`,responseType:"json"}).then(a=>{const l=fT(a,"volumeId"),c=t.length+r.length+2,u=[];for(const h of l)u.push(h.substring(c));return u});const s=`${this.instance.description} volume list`;return Ke.forPromise(i,{delay:!0,initialMessage:`Retrieving ${s}`,errorPrefix:`Error retrieving ${s}`}),i})}getChangeStackList(e,t){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},()=>{let r=Ha(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/changes/${t}/change_stacks`,responseType:"json"}).then(s=>V5(s));const i=`change stacks for ${t}`;return Ke.forPromise(r,{delay:!0,initialMessage:`Retrieving ${i}.`,errorPrefix:`Error retrieving ${i}: `}),r})}async completeUrl(e){const t=e.providerUrl,r=t.match(/^([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(r===null)throw null;var i=ae(r,7);const s=i[1],a=i[2],l=i[3],c=i[4],u=i[5],h=i[6];if(h!==void 0)return Fo(t.length-h.length,await KL(h,F5));if(u!==void 0){const v=`${s}:${a}:${l}`,y=await this.getMeshesInfo(e.chunkManager,v),C=[],S=new ze;for(const w of y)if(w.name.startsWith(u))switch(w.type){case"LINE_SEGMENTS":C.push({value:w.name,description:"Skeletons"});break;case"TRIANGLES":{C.push({value:w.name,description:"Mesh (single-resolution)"});const E=w.name.match(LP);if(E!==null){const k=E[1];if(S.has(k))break;S.add(k),C.push({value:k,description:"Mesh (multi-resolution)"})}break}}return C.sort((w,E)=>kd(w.value,E.value)),{offset:t.length-u.length,completions:C}}if(c!==void 0){const v=`${s}:${a}:${l}`,y=await this.getChangeStackList(e.chunkManager,v);if(y===void 0)throw null;return{offset:t.length-c.length,completions:kf(c,y)}}if(l!==void 0)return{offset:t.length-l.length,completions:kf(l,await this.getVolumeList(e.chunkManager,s,a))};if(a!==void 0){const v=await this.getDatasetList(e.chunkManager,s);return{offset:t.length-a.length,completions:kf(a,v.map(y=>`${y}:`))}}const g=await this.getProjectList(e.chunkManager);return{offset:0,completions:_o(s,g,v=>`${v.id}:`,v=>v.label)}}}const _5={description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"};ca("brainmaps",n=>new IP(_5,n.credentialsManager.getCredentialsProvider(Mh)));if(typeof NEUROGLANCER_BRAINMAPS_SERVERS<"u")for(const n of Ld(NEUROGLANCER_BRAINMAPS_SERVERS)){var gT=ae(n,2);const e=gT[0],t=gT[1];ca(`brainmaps-${e}`,r=>new IP(t,r.credentialsManager.getCredentialsProvider(Mh)))}const U5="https://accounts.google.com/o/oauth2/auth",mT="https://accounts.google.com";function $5(n,e){let t=document.createElement("iframe");t.style.display="none",t.id=n,t.name=n;const r=location.origin;t.src=`https://accounts.google.com/o/oauth2/postmessageRelay?parent=${encodeURIComponent(r)}#rpctoken=${e}`,document.body.appendChild(t)}class z5{constructor(){this.finished=new Ze}}class G5{constructor(){this.proxyName=`postmessageRelay${lu()}`,this.rpcToken=`${lu()}`,this.relayReadyService=`oauth2relayReady:${this.rpcToken}`,this.oauth2CallbackService=`oauth2callback:${this.rpcToken}`,this.pendingRequests=new de,$5(this.proxyName,this.rpcToken),this.relayReadyPromise=new xt(e=>{addEventListener("message",t=>{if(t.origin===mT)try{let r=ge(JSON.parse(t.data)),i=ke(r.s);if(i===this.relayReadyService&&e(),i===this.oauth2CallbackService){let s=We(r.a,E=>E),a=ke(s[0]),l=location.origin;if(!a.startsWith(l+"#")&&!a.startsWith(l+"?"))throw new Error(`oauth2callback: URL ${ie(a)} does not match current origin ${l}.`);let c=a.substring(l.length+1).split("&"),u=new de;for(let E of c){let k=E.match("^([a-z_]+)=(.*)$");if(k===null)throw new Error(`oauth2callback: URL part ${ie(k)} does not match expected pattern.`);u.set(k[1],k[2])}let h=u.get("state");if(h===void 0)throw new Error("oauth2callback: State argument is missing.");let g=this.pendingRequests.get(h);if(g===void 0)return;let v=u.get("error");if(v!==void 0){let E=u.get("error_subtype"),k=v;E!==void 0&&(k+=": "+E),g.finished.dispatch(void 0,new Error(`Error obtaining Google OAuth2 token: ${k}`));return}let y=u.get("access_token"),C=u.get("token_type"),S=u.get("expires_in"),w=u.get("scope");if(y===void 0||C===void 0||S===void 0||w===void 0)throw new Error("oauth2callback: URL lacks expected parameters.");g.finished.dispatch({accessToken:y,tokenType:C,expiresIn:S,scope:w});return}}catch(r){throw new Error(`Invalid message received from ${mT}: ${ie(t.data)}: ${r.message}.`)}})})}addPendingRequest(e){let t=new z5;return this.pendingRequests.set(e,t),t.finished.add(()=>{this.pendingRequests.delete(e)}),t}makeAuthRequestUrl(e){let t=`${U5}?client_id=${encodeURIComponent(e.clientId)}`;t+="&redirect_uri=postmessage",t+="&response_type=token";var r=e.origin;let i=r===void 0?location.origin:r;return t+=`&origin=${encodeURIComponent(i)}`,t+=`&proxy=${this.proxyName}`,t+="&include_granted_scopes=true",t+=`&scope=${encodeURIComponent(e.scopes.join(" "))}`,e.state&&(t+=`&state=${e.state}`),e.approvalPrompt&&(t+=`&approval_prompt=${encodeURIComponent(e.approvalPrompt)}`),e.loginHint&&(t+=`&login_hint=${encodeURIComponent(e.loginHint)}`),e.immediate&&(t+="&immediate=true"),e.authUser!==void 0&&(t+=`&authuser=${e.authUser}`),t}}let rg;function W5(){return rg===void 0&&(rg=new G5),rg}function j5(n,e=Vt){const t=lu(),r=W5(),i=r.makeAuthRequestUrl({state:t,clientId:n.clientId,scopes:n.scopes,approvalPrompt:n.approvalPrompt,loginHint:n.loginHint,immediate:n.immediate,authUser:n.authUser}),s=r.addPendingRequest(t),a=new xt((l,c)=>{s.finished.add((u,h)=>{u!==void 0?l(u):c(h)})});if(s.finished.add(e.add(()=>{s.finished.dispatch(void 0,ms)})),n.immediate)r.relayReadyPromise.then(()=>{if(e.isCanceled)return;const l=document.createElement("iframe");l.src=i,l.style.display="none",document.body.appendChild(l),s.finished.add(()=>{Et(l)})});else if(!e.isCanceled){const l=open(i);l!==null&&s.finished.add(()=>{l.close()})}return a}class H5 extends _d{constructor(e){super(),this.options=e,this.get=Sh(t=>{const r=this.options,i=new Ke(!0);let s;return new xt((a,l)=>{const c=()=>{s=void 0,i.dispose()};t.add(()=>{s!==void 0&&(s.cancel(),s=void 0,i.dispose(),l(ms))});function u(g=`${r.description} authorization required.`,v="Request authorization."){i.setText(g+"  ");let y=document.createElement("button");y.textContent=v,i.element.appendChild(y),y.addEventListener("click",()=>{h(!1)}),i.setVisible(!0)}function h(g){s!==void 0&&s.cancel(),s=new Es,u(`Waiting for ${r.description} authorization...`,"Retry"),j5({clientId:r.clientId,scopes:r.scopes,immediate:g,authUser:0},s).then(v=>{s!==void 0&&(c(),a(v))},v=>{s!==void 0&&(s=void 0,g?u():u(`${r.description} authorization failed: ${v}.`,"Retry"))})}h(!0)})})}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const q5="https://www.googleapis.com/auth/brainmaps";class DP extends H5{constructor(e){super({clientId:e,scopes:[q5],description:"Brain Maps"})}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */$o.register(Mh,()=>new DP(BRAINMAPS_CLIENT_ID));/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Uu;(function(n){n[n.RAW=0]="RAW",n[n.JPEG=1]="JPEG",n[n.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",n[n.COMPRESSO=3]="COMPRESSO",n[n.PNG=4]="PNG"})(Uu||(Uu={}));let PP=class{};PP.RPC_ID="precomputed/VolumeChunkSource";class RP{}RP.RPC_ID="precomputed/MeshSource";var $u;(function(n){n[n.RAW=0]="RAW",n[n.GZIP=1]="GZIP"})($u||($u={}));var _m;(function(n){n[n.IDENTITY=0]="IDENTITY",n[n.MURMURHASH3_X86_128=1]="MURMURHASH3_X86_128"})(_m||(_m={}));class MP{}MP.RPC_ID="precomputed/MultiscaleMeshSource";class AP{}AP.RPC_ID="precomputed/SkeletonSource";class NP{}NP.RPC_ID="precomputed/AnnotationSpatialIndexSource";class VP{}VP.RPC_ID="precomputed/AnnotationSource";class OP{}OP.RPC_ID="precomputed/IndexedSegmentPropertySource";/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function J5(n,e,t,r,i){const s=await Js(n,`https://www.googleapis.com/storage/v1/b/${e}/o?delimiter=${encodeURIComponent(r)}&prefix=${encodeURIComponent(t)}&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,{},si,i);ge(s);const a=ye(s,"prefixes",kr,[]),l=ye(s,"items",c=>We(c,u=>(ge(u),X(u,"name",ke))),[]).filter(c=>!c.endsWith("_$folder$"));return[...a,...l]}async function Y5(n,e,t,r,i){if(!r.startsWith("/"))throw null;const s=await J5(n,t,r.substring(1),"/",i);let a=r.lastIndexOf("/");return{offset:a+e.length+1,completions:s.map(l=>({value:l.substring(a)}))}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function X5(n,e,t){var r=await zo(t,n,{headers:{accept:"text/html"}},async u=>({text:await u.text(),contentType:u.headers.get("content-type")}),e);const i=r.text,s=r.contentType;if(s===null||/\btext\/html\b/i.exec(s)===null)return[];const a=new DOMParser().parseFromString(i,"text/html"),l=a.evaluate("//a/@href",a,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),c=[];for(let u=0,h=l.snapshotLength;u<h;++u){const g=l.snapshotItem(u).textContent;g&&c.push(new URL(g,n).toString())}return c}async function K5(n,e,t){console.log("getHtmlPathCompletions");const r=n.match(/^([a-z]+:\/\/.*\/)([^\/?#]*)$/);if(r===null)throw null;const i=await X5(r[1],e,t),s=r[1].length,a=[];for(const l of i)l.startsWith(n)&&a.push({value:l.substring(s)});return{offset:s,completions:a}}const Z5=[{value:"gs://",description:"Google Cloud Storage (JSON API)"},{value:"gs+xml://",description:"Google Cloud Storage (XML API)"},{value:"gs+json://",description:"Google Cloud Storage (storage JSON API)"},{value:"gs+ngauth+http://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+ngauth+https://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+xml+ngauth+http://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"gs+xml+ngauth+https://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"s3://",description:"Amazon Simple Storage Service (S3)"},{value:"https://"},{value:"http://"}];async function Hy(n,e,t){if(!e.includes("://"))return{offset:0,completions:_o(e,Z5,y=>y.value,y=>y.description)};var r=Ud(e,n);const i=r.url,s=r.credentialsProvider,a=e.length-i.length;let l;try{l=Io(i)}catch{throw null}var c=l;const u=c.protocol,h=c.host,g=c.path,v=await(async()=>{if(u==="gs+xml"&&g.length>0)return await Qg(s,`${u}://${h}`,`https://storage.googleapis.com/${h}`,g,t);if((u==="gs"||u==="gs+json")&&g.length>0)return await Y5(s,`${u}://${h}`,h,g,t);if(u==="s3"&&g.length>0)return await X$(h,g,t);const y=i.match(/^((?:http|https):\/\/(?:storage\.googleapis\.com\/[^\/]+|[^\/]+\.storage\.googleapis\.com|[^\/]+\.s3(?:[^./]+)?\.amazonaws.com))(\/.*)$/);if(y!==null)return await Qg(s,y[1],y[1],y[2],t);if((u==="http"||u==="https")&&g.length>0)return await K5(i,t,s);throw null})();return{offset:a+v.offset,completions:v.completions}}class Q5 extends Dt(Pt()(Bd),PP){}class eq extends Dt(Pt()(Ad),RP){}class tq extends Dt(Pt()(yh),MP){}class nq extends Dt(Pt()(bh),AP){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}}function Xs(n,e){const t=n.split("/");for(const r of e.split("/")){if(r===".."&&t.length!==0){t.length=t.length-1;continue}t.push(r)}return t.join("/")}class rq{constructor(e,t){ge(e);const r=t===1?3:4,i=this.resolution=new Float64Array(r),s=this.voxelOffset=new Float32Array(r),a=this.size=new Float32Array(r);if(r===4&&(i[3]=1,a[3]=t),X(e,"resolution",l=>it(i.subarray(0,3),l,yn)),ye(e,"voxel_offset",l=>it(s.subarray(0,3),l,hn)),X(e,"size",l=>it(a.subarray(0,3),l,on)),this.chunkSizes=X(e,"chunk_sizes",l=>We(l,c=>{const u=new Uint32Array(r);return r===4&&(u[3]=t),it(u.subarray(0,3),c,on),u})),this.chunkSizes.length===0)throw new Error("No chunk sizes specified.");if(this.sharding=X(e,"sharding",Ah),this.sharding!==void 0&&this.chunkSizes.length!==1)throw new Error("Sharding requires a single chunk size per scale");(this.encoding=X(e,"encoding",l=>Mn(l,Uu)))===Uu.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=X(e,"compressed_segmentation_block_size",l=>it(Ne(),l,on))),this.key=X(e,"key",ke)}}function iq(n){ge(n);const e=X(n,"data_type",w=>Mn(w,q)),t=X(n,"num_channels",on),r=X(n,"type",w=>Mn(w,gn)),i=X(n,"mesh",Ir),s=X(n,"skeletons",Ir),a=X(n,"segment_properties",Ir),l=X(n,"scales",w=>We(w,E=>new rq(E,t)));if(l.length===0)throw new Error("Expected at least one scale");const c=l[0],u=t===1?3:4,h=new Float64Array(u),g=new Float64Array(u),v=new Float64Array(u),y=["x","y","z"],C=["m","m","m"];for(let w=0;w<3;++w)h[w]=c.resolution[w]/1e9,g[w]=c.voxelOffset[w],v[w]=g[w]+c.size[w];u===4&&(h[3]=1,v[3]=t,y[3]="c^",C[3]="");const S=st({rank:u,names:y,units:C,scales:h,boundingBoxes:[aa({lowerBounds:g,upperBounds:v})]});return{dataType:e,volumeType:r,mesh:i,skeletons:s,segmentPropertyMap:a,scales:l,modelSpace:S}}class sq extends Is{constructor(e,t,r,i){super(e),this.credentialsProvider=t,this.url=r,this.info=i}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}getSources(e){const t=this.info.scales[0].resolution,r=this.rank;return cd(this.info.scales.map(i=>{const s=i.resolution,a=r+1,l=new Float32Array(a*a);l[l.length-1]=1;var c=this.info.modelSpace.boundingBoxes[0].box;const u=c.lowerBounds,h=c.upperBounds,g=new Float32Array(r),v=new Float32Array(r);for(let y=0;y<3;++y){const C=s[y]/t[y];l[a*y+y]=C;const S=i.voxelOffset[y];l[a*r+y]=S*C,g[y]=u[y]/C-S,v[y]=h[y]/C-S}return r===4&&(l[a*3+3]=1,g[3]=u[3],v[3]=h[3]),$d({rank:r,dataType:this.dataType,chunkToMultiscaleTransform:l,upperVoxelBound:i.size,volumeType:this.volumeType,chunkDataSizes:i.chunkSizes,baseVoxelOffset:i.voxelOffset,compressedSegmentationBlockSize:i.compressedSegmentationBlockSize,volumeSourceOptions:e}).map(y=>({chunkSource:this.chunkManager.getChunkSource(Q5,{credentialsProvider:this.credentialsProvider,spec:y,parameters:{url:Xs(this.url,i.key),encoding:i.encoding,sharding:i.sharding}}),chunkToMultiscaleTransform:l,lowerClipBound:g,upperClipBound:v}))}))}}const aq=Dt(Pt()(Pr),VP);class oq extends Dt(Pt()(bo),NP){}class lq extends aq{constructor(e,t){const r=t.parameters;super(e,{rank:r.rank,relationships:r.relationships.map(i=>i.name),properties:r.properties,parameters:r}),this.readonly=!0,this.metadata=t.metadata,this.credentialsProvider=t.credentialsProvider}getSources(){return[this.metadata.spatialIndices.map(e=>{const t=e.spec;return{chunkSource:this.chunkManager.getChunkSource(oq,{credentialsProvider:this.credentialsProvider,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}})]}}function dq(n,e,t){return n.getChunkSource(eq,{parameters:t,credentialsProvider:e})}function BP(n){return X(n,"transform",e=>{const t=Je();return e!==void 0&&it(t.subarray(0,12),e,vt),nv(t,t),t})}function cq(n){ge(n);const e=X(n,"@type",ke);let t;if(e==="neuroglancer_legacy_mesh")t=void 0;else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${ie(e)}`);{const i=X(n,"lod_scale_multiplier",yn),s=X(n,"vertex_quantization_bits",on),a=BP(n),l=X(n,"sharding",Ah);t={lodScaleMultiplier:i,transform:a,sharding:l,vertexQuantizationBits:s}}}const r=X(n,"segment_properties",Ir);return{metadata:t,segmentPropertyMap:r}}async function uq(n,e,t){let r;try{r=await qo(n,e,t)}catch(i){if(Th(i))return{metadata:void 0};throw i}return cq(r)}function vT(n){return n===void 0?$u.RAW:Mn(n,$u)}function Ah(n){if(n===void 0)return;ge(n);const e=X(n,"@type",ke);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${ie(e)}`);const t=X(n,"hash",c=>Mn(c,_m)),r=X(n,"preshift_bits",hn),i=X(n,"shard_bits",hn),s=X(n,"minishard_bits",hn),a=X(n,"minishard_index_encoding",vT),l=X(n,"data_encoding",vT);return{hash:t,preshiftBits:r,shardBits:i,minishardBits:s,minishardIndexEncoding:a,dataEncoding:l}}function hq(n){ge(n);const e=X(n,"@type",ke);if(e!=="neuroglancer_skeletons")throw new Error(`Unsupported skeleton type: ${ie(e)}`);const t=BP(n),r=new de;X(n,"vertex_attributes",a=>{a!==void 0&&We(a,l=>{ge(l);const c=X(l,"id",ke);if(c==="")throw new Error("vertex attribute id must not be empty");if(r.has(c))throw new Error(`duplicate vertex attribute id ${ie(c)}`);const u=X(l,"data_type",g=>Mn(g,q)),h=X(l,"num_components",on);r.set(c,{dataType:u,numComponents:h})})});const i=X(n,"sharding",Ah),s=X(n,"segment_properties",Ir);return{metadata:{transform:t,vertexAttributes:r,sharding:i},segmentPropertyMap:s}}async function pq(n,e,t){const r=await qo(n,e,t);return hq(r)}function FP(){return st({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function _P(n,e,t){var r=await uq(n,e,t);const i=r.metadata,s=r.segmentPropertyMap;if(i===void 0)return{source:dq(n,e,{url:t,lod:0}),transform:Je(),segmentPropertyMap:s};let a;const l=i.vertexQuantizationBits;if(l===10)a=Ii.uint10;else if(l===16)a=Ii.uint16;else throw new Error(`Invalid vertex quantization bits: ${l}`);return{source:n.getChunkSource(tq,{credentialsProvider:e,parameters:{url:t,metadata:i},format:{fragmentRelativeVertices:!0,vertexPositionFormat:a}}),transform:i.transform,segmentPropertyMap:s}}async function UP(n,e,t){var r=await pq(n,e,t);const i=r.metadata,s=r.segmentPropertyMap;return{source:n.getChunkSource(nq,{credentialsProvider:e,parameters:{url:t,metadata:i}}),transform:i.transform,segmentPropertyMap:s}}function qo(n,e,t){return n.memoize.getUncounted({type:"precomputed:metadata",url:t,credentialsProvider:ln(e)},async()=>await zo(e,`${t}/info`,{},si))}function yT(n){const e=Je(),t=n.scales[0].resolution;for(let r=0;r<3;++r)e[5*r]=1/t[r];return e}async function fq(n,e,t,r){const i=iq(r),s=new sq(n.chunkManager,e,t,i),a=i.modelSpace,l=[{id:"default",default:!0,subsource:{volume:s}},{id:"bounds",default:!0,subsource:{staticAnnotations:yd(a.bounds)}}];if(i.segmentPropertyMap!==void 0){const h=Xs(t,i.segmentPropertyMap),g=await qo(n.chunkManager,e,h),v=Nh(n.chunkManager,e,g);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:v}})}if(i.mesh!==void 0){const h=Xs(t,i.mesh);var c=await _P(n.chunkManager,e,h);const g=c.source,v=c.transform,y=yT(i);en(y,y,v),l.push({id:"mesh",default:!0,subsource:{mesh:g},subsourceToModelSubspaceTransform:y})}if(i.skeletons!==void 0){const h=Xs(t,i.skeletons);var u=await UP(n.chunkManager,e,h);const g=u.source,v=u.transform,y=yT(i);en(y,y,v),l.push({id:"skeletons",default:!0,subsource:{mesh:g},subsourceToModelSubspaceTransform:y})}return{modelTransform:zn(a),subsources:l}}async function gq(n,e,t){var r=await UP(n.chunkManager,e,t);const i=r.source,s=r.transform,a=r.segmentPropertyMap,l=[{id:"default",default:!0,subsource:{mesh:i},subsourceToModelSubspaceTransform:s}];if(a!==void 0){const c=Xs(t,a),u=await qo(n.chunkManager,e,c),h=Nh(n.chunkManager,e,u);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:h}})}return{modelTransform:zn(FP()),subsources:l}}function ig(n,e){return ge(e),{url:Xs(n,X(e,"key",ke)),sharding:X(e,"sharding",Ah)}}class mq{constructor(e,t){this.url=e,ge(t);const r=X(t,"dimensions",cu),i=r.rank,s=X(t,"lower_bound",l=>it(new Float64Array(i),l,vt)),a=X(t,"upper_bound",l=>it(new Float64Array(i),l,vt));this.coordinateSpace=st({rank:i,names:r.names,units:r.units,scales:r.scales,boundingBoxes:[aa({lowerBounds:s,upperBounds:a})]}),this.parameters={type:X(t,"annotation_type",l=>Mn(l,Pe)),rank:i,relationships:X(t,"relationships",l=>We(l,c=>{const u=ig(e,c),h=X(c,"id",ke);return j(j({},u),{name:h})})),properties:X(t,"properties",Ck),byId:X(t,"by_id",l=>ig(e,l))},this.spatialIndices=X(t,"spatial",l=>We(l,c=>{const u=ig(e,c),h=X(c,"grid_shape",w=>it(new Float32Array(i),w,on)),g=X(c,"chunk_size",w=>it(new Float32Array(i),w,yn)),v=X(c,"limit",on),y=new Float32Array(i);for(let w=0;w<i;++w)y[w]=h[w]*g[w];const C=xs(Float32Array,i+1);for(let w=0;w<i;++w)C[(i+1)*i+w]=s[w];const S=j({limit:v,chunkToMultiscaleTransform:C},Cd({rank:i,chunkDataSize:g,upperVoxelBound:y}));return S.upperChunkBound=h,{parameters:u,spec:S,limit:v}})),this.spatialIndices.reverse()}}async function vq(n,e,t,r){const i=new mq(t,r);return{modelTransform:zn(i.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:n.chunkManager.getChunkSource(lq,{credentialsProvider:e,metadata:i,parameters:i.parameters})}}]}}async function bT(n,e,t){var r=await _P(n.chunkManager,e,t);const i=r.source,s=r.transform,a=r.segmentPropertyMap,l=[{id:"default",default:!0,subsource:{mesh:i},subsourceToModelSubspaceTransform:s}];if(a!==void 0){const c=Xs(t,a),u=await qo(n.chunkManager,e,c),h=Nh(n.chunkManager,e,u);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:h}})}return{modelTransform:zn(FP()),subsources:l}}function yq(n){ge(n);const e=new te,t=X(n,"ids",s=>{s=kr(s);const a=s.length,l=new Uint32Array(a*2);for(let c=0;c<a;++c){if(!e.tryParseString(s[c]))throw new Error(`Invalid uint64 id: ${ie(s[c])}`);l[2*c]=e.low,l[2*c+1]=e.high}return l}),r=t.length/2,i=X(n,"properties",s=>We(s,a=>{ge(a);const l=X(a,"id",ke),c=ye(a,"description",ke),u=X(a,"type",g=>{if(g!=="label"&&g!=="description"&&g!=="string"&&g!=="tags"&&g!=="number")throw new Error(`Invalid property type: ${ie(g)}`);return g});if(u==="tags"){const g=X(a,"tags",kr);let v=ye(a,"tag_descriptions",kr);if(v===void 0)v=new Array(g.length),v.fill("");else if(v.length!==g.length)throw new Error(`Expected tag_descriptions to have length: ${g.length}`);const y=X(a,"values",C=>{if(!Array.isArray(C)||C.length!==r)throw new Error(`Expected ${r} values, but received: ${C.length}`);return C.map(S=>String.fromCharCode(...S))});return{id:l,description:c,type:u,tags:g,tagDescriptions:v,values:y}}if(u==="number"){const g=X(a,"data_type",S=>Mn(S,q));if(g===q.UINT64)throw new Error("uint64 properties not supported");const v=X(a,"values",S=>{if(!Array.isArray(S)||S.length!==r)throw new Error(`Expected ${r} values, but received: ${S.length}`);return sV[g].from(S)});let y=1/0,C=-1/0;for(let S=v.length-1;S>=0;--S){const w=v[S];w<y&&(y=w),w>C&&(C=w)}return{id:l,description:c,type:u,dataType:g,values:v,bounds:[y,C]}}const h=X(a,"values",g=>{if(kr(g),g.length!==r)throw new Error(`Expected ${r} values, but received: ${g.length}`);return g});return{id:l,description:c,type:u,values:h}}));return XG({ids:t,properties:i})}Dt(Pt()(WG),OP);function Nh(n,e,t,r){try{const i=X(t,"@type",ke);if(i!=="neuroglancer_segment_properties")throw new Error(`Unsupported segment property map type: ${ie(i)}`);const s=ye(t,"inline",yq);return new JI({inlineProperties:s})}catch(i){throw new Error(`Error parsing segment property map: ${i.message}`)}}async function bq(n,e,t,r){return{modelTransform:zn(uo),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:Nh(n.chunkManager,e,r)}}]}}const wq=/^([^#]*)(?:#(.*))?$/;function sg(n){var e=n.match(wq),t=ae(e,3);let r=t[1],i=t[2];r.endsWith("/")&&(r=r.substring(0,r.length-1));const s=gd(i||"");return{url:r,parameters:s}}function wT(n,e){const t=IV(e);return t&&(n+=`#${t}`),n}class Sq extends oa{get description(){return"Precomputed file-backed data source"}normalizeUrl(e){var t=sg(e.providerUrl);const r=t.url,i=t.parameters;return e.providerProtocol+"://"+wT(r,i)}convertLegacyUrl(e){var t=sg(e.providerUrl);const r=t.url,i=t.parameters;return e.type==="mesh"&&(i.type="mesh"),e.providerProtocol+"://"+wT(r,i)}get(e){var t=sg(e.providerUrl);const r=t.url,i=t.parameters;return e.chunkManager.memoize.getUncounted({type:"precomputed:get",providerUrl:r,parameters:i},async()=>{var s=Ud(r,e.credentialsManager);const a=s.url,l=s.credentialsProvider;let c;try{c=await qo(e.chunkManager,l,a)}catch(g){if(Th(g)&&i.type==="mesh")return await bT(e,l,a);throw g}ge(c);const u=ye(c,"redirect",ke);if(u!==void 0)throw new ZL(u);const h=ye(c,"@type",ke);switch(h){case"neuroglancer_skeletons":return await gq(e,l,a);case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":return await bT(e,l,a);case"neuroglancer_annotations_v1":return await vq(e,l,a,c);case"neuroglancer_segment_properties":return await bq(e,l,a,c);case"neuroglancer_multiscale_volume":case void 0:return await fq(e,l,a,c);default:throw new Error(`Invalid type: ${ie(h)}`)}})}completeUrl(e){return Hy(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ca("precomputed",()=>new Sq);var ag={},ST;function Cq(){return ST||(ST=1,ag.__esModule=!0,ag.default=function(n){if(n==null)throw new TypeError("Cannot destructure undefined")}),ag}var xq=Cq();const $P=Qe(xq);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var zu;(function(n){n[n.RAW=0]="RAW",n[n.GZIP=1]="GZIP",n[n.BLOSC=2]="BLOSC"})(zu||(zu={}));let zP=class{};zP.RPC_ID="n5/VolumeChunkSource";class Eq extends Dt(Pt()(Bd),zP){}let Tq=class extends Is{constructor(n,e,t,r){super(n),this.credentialsProvider=e,this.multiscaleMetadata=t,this.scales=r;let i,s;if(r.forEach((h,g)=>{if(h!==void 0){if(s===void 0&&(s=g),i!==void 0&&h.dataType!==i)throw new Error(`Scale s${g} has data type ${q[h.dataType]} but expected ${q[i]}.`);i=h.dataType}}),i===void 0)throw new Error("At least one scale must be specified.");const a=t.scales[s],l=r[s];this.dataType=i,this.volumeType=gn.IMAGE,this.baseScaleIndex=s;const c=t.modelSpace,u=c.rank;this.modelSpace=st({names:c.names,scales:c.scales,units:c.units,boundingBoxes:[{transform:KS(Float64Array,a.downsamplingFactor,!1),box:{lowerBounds:new Float64Array(u),upperBounds:new Float64Array(l.size)}}],coordinateArrays:c.coordinateArrays})}get rank(){return this.modelSpace.rank}getSources(n){$P(this);const e=this.scales,t=this.rank,r=this.multiscaleMetadata.scales;return cd(e.filter(i=>i!==void 0).map((i,s)=>{const a=r[s],l=KS(Float32Array,a.downsamplingFactor);return $d({rank:t,chunkToMultiscaleTransform:l,dataType:i.dataType,upperVoxelBound:i.size,volumeType:this.volumeType,chunkDataSizes:[i.chunkSize],volumeSourceOptions:n}).map(c=>({chunkSource:this.chunkManager.getChunkSource(Eq,{credentialsProvider:this.credentialsProvider,spec:c,parameters:{url:a.url,encoding:i.encoding}}),chunkToMultiscaleTransform:l}))}))}};class kq{constructor(e){ge(e),this.dataType=X(e,"dataType",r=>Mn(r,q)),this.size=Float32Array.from(X(e,"dimensions",r=>We(r,on))),this.chunkSize=X(e,"blockSize",r=>it(new Uint32Array(this.size.length),r,on));let t;ye(e,"compression",r=>{t=X(r,"type",i=>Mn(i,zu))}),t===void 0&&(t=X(e,"compressionType",r=>Mn(r,zu))),this.encoding=t}}function Lq(n,e,t){return xt.all(t.scales.map(async r=>{const i=await GP(n,e,r.url,!0);if(i!==void 0)return new kq(i)}))}function Iq(n){var e=Io(n);let t=e.protocol,r=e.host,i=e.path;i.endsWith("/")&&(i=i.substring(0,i.length-1));const s=[];for(;;){s.push(`${t}://${r}${i}/attributes.json`);const a=i.lastIndexOf("/");if(a===-1)break;i=i.substring(0,a)}return s}function Dq(n,e,t,r){return n.memoize.getUncounted({type:"n5:attributes.json",url:t,credentialsProvider:ln(e)},()=>zo(e,t,{},si).then(i=>{try{return ge(i)}catch(s){throw new Error(`Error reading attributes from ${t}: ${s.message}`)}}).catch(i=>{if(Th(i))return r?void 0:{};throw i}))}async function GP(n,e,t,r){const i=Iq(t),s=await xt.all(i.map((a,l)=>Dq(n,e,a,r&&l===i.length-1)));if(s.indexOf(void 0)===-1)return s.reverse(),j({},...s)}function os(n,e){if(n!==-1&&e!==n)throw new Error(`Rank mismatch, received ${e} but expected ${n}`);return e}function WP(n){return Float64Array.from(We(n,yn))}function jP(n){const e=qr(n);if(e.length===0)throw new Error("Expected non-empty array");let t=-1;return{all:We(e,r=>{const i=WP(r);return t=os(t,i.length),i}),single:void 0,rank:t}}function Pq(n){const e=qr(n);if(e.length===0)throw new Error("Expected non-empty array");if(Array.isArray(e[0]))return jP(e);const t=WP(n);return{all:void 0,single:t,rank:t.length}}const Rq=["x","y","z","t","c"];function Mq(n){const e=Rq.slice(0,n);for(;e.length<n;)e.push(`d${e.length+1}`);return e}function Aq(n,e){ge(e);let t=-1,r=ye(e,"resolution",v=>{const y=Float64Array.from(We(v,yn));return t=os(t,y.length),y}),i=ye(e,"axes",v=>{const y=We(v,ke);return t=os(t,y.length),y}),s=ye(e,"units",v=>{const y=We(v,iC);return t=os(t,y.length),y}),a={unit:"m",exponent:-9},l,c;ye(e,"downsamplingFactors",v=>{var y=Pq(v);const C=y.single,S=y.all,w=y.rank;t=os(t,w),C!==void 0&&(l=C),S!==void 0&&(c=S)}),ye(e,"pixelResolution",v=>{a=X(v,"unit",iC),ye(v,"dimensions",y=>{r=Float64Array.from(We(y,yn)),t=os(t,r.length)})}),ye(e,"scales",v=>{var y=jP(v);const C=y.all,S=y.rank;t=os(t,S),c=C});const u=ye(e,"dimensions",v=>{const y=We(v,on);return t=os(t,y.length),y});if(t===-1)throw new Error("Unable to determine rank of dataset");s===void 0&&(s=new Array(t),s.fill(a)),r===void 0&&(r=new Float64Array(t),r.fill(1));for(let v=0;v<t;++v)r[v]=pv(r[v],s[v].exponent);const h=new Array(t);i!==void 0&&ye(e,"coordinateArrays",v=>{ge(v);for(let y=0;y<t;++y){const C=i[y];if(Object.prototype.hasOwnProperty.call(v,C)){const S=kr(v[C]);h[y]={explicit:!1,labels:S,coordinates:Te(S,(w,E)=>E)},s[y]={unit:"",exponent:0},r[y]=1}}}),i===void 0&&(i=Mq(t));const g=st({rank:t,valid:!0,names:i,scales:r,units:s.map(v=>v.unit),coordinateArrays:h});if(u===void 0){if(c===void 0)throw new Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:g,url:n,attributes:e,scales:c.map((v,y)=>({url:`${n}/s${y}`,downsamplingFactor:v}))}}return l===void 0&&(l=new Float64Array(t),l.fill(1)),{modelSpace:g,url:n,attributes:e,scales:[{url:n,downsamplingFactor:l}]}}class Nq extends oa{get description(){return"N5 data source"}get(e){let t=e.providerUrl;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"n5:MultiscaleVolumeChunkSource",providerUrl:t},async()=>{var r=Ud(t,e.credentialsManager);const i=r.url,s=r.credentialsProvider,a=await GP(e.chunkManager,s,i,!1),l=Aq(i,a),c=await Lq(e.chunkManager,s,l),u=new Tq(e.chunkManager,s,l,c);return{modelTransform:zn(u.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:u}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:yd(u.modelSpace.bounds)}}]}})}completeUrl(e){return Hy(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ca("n5",()=>new Nq);/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Za;(function(n){n[n.RAW=0]="RAW",n[n.GZIP=1]="GZIP",n[n.BLOSC=2]="BLOSC"})(Za||(Za={}));class HP{}HP.RPC_ID="zarr/VolumeChunkSource";const Si=new de;Si.set("|u1",{endianness:Jn.LITTLE,dataType:q.UINT8});Si.set("|i1",{endianness:Jn.LITTLE,dataType:q.INT8});for(let n of[["<",Jn.LITTLE],[">",Jn.BIG]]){var CT=ae(n,2);let e=CT[0],t=CT[1];for(let r of["u","i"])Si.set(`${e}${r}8`,{endianness:t,dataType:q.UINT64});Si.set(`${e}u2`,{endianness:t,dataType:q.UINT16}),Si.set(`${e}i2`,{endianness:t,dataType:q.INT16}),Si.set(`${e}u4`,{endianness:t,dataType:q.UINT32}),Si.set(`${e}i4`,{endianness:t,dataType:q.INT32}),Si.set(`${e}f4`,{endianness:t,dataType:q.FLOAT32})}function Vq(n){const e=Si.get(n);if(e===void 0)throw new Error(`Unsupported numpy data type: ${ie(n)}`);return e}class Oq extends Dt(Pt()(Bd),HP){}function qP(n){return ye(n,"dimension_separator",e=>{if(e!=="."&&e!=="/")throw new Error(`Expected "." or "/", but received: ${ie(e)}`);return e})}function Bq(n){try{ge(n),X(n,"zarr_format",l=>{if(l!==2)throw new Error(`Expected 2 but received: ${ie(l)}`)});const e=X(n,"shape",l=>We(l,c=>{if(typeof c!="number"||!Nn(c)||c<0)throw new Error(`Expected non-negative integer, but received: ${ie(c)}`);return c})),t=X(n,"chunks",l=>it(new Array(e.length),l,c=>{if(typeof c!="number"||!Nn(c)||c<=0)throw new Error(`Expected positive integer, but received: ${ie(c)}`);return c})),r=X(n,"order",l=>{if(l!=="C"&&l!=="F")throw new Error(`Expected "C" or "F", but received: ${ie(l)}`);return l}),i=qP(n),s=X(n,"dtype",l=>Vq(ke(l))),a=X(n,"compressor",l=>{if(l===null)return Za.RAW;ge(l);const c=X(l,"id",ke);switch(c){case"blosc":return Za.BLOSC;case"gzip":return Za.GZIP;case"zlib":return Za.GZIP;default:throw new Error(`Unsupported compressor: ${ie(c)}`)}});return{rank:e.length,shape:e,chunks:t,order:r,dataType:s.dataType,encoding:{compressor:a,endianness:s.endianness},dimensionSeparator:i}}catch(e){throw new Error(`Error parsing zarr metadata: ${e.message}`)}}class Fq extends Is{constructor(e,t,r,i,s,a){super(e),this.credentialsProvider=t,this.url=r,this.separator=i,this.metadata=s,this.attrs=a,this.dataType=s.dataType,this.volumeType=gn.IMAGE;let l=ye(a,"_ARRAY_DIMENSIONS",c=>it(new Array(s.rank),c,ke));l===void 0&&(l=Te(s.shape,(c,u)=>`d${u}`)),this.modelSpace=st({names:l,scales:Float64Array.from(s.shape,()=>1),units:Te(s.shape,()=>""),boundingBoxes:[aa({lowerBounds:new Float64Array(s.rank),upperBounds:Float64Array.from(s.shape)})]})}get rank(){return this.metadata.rank}getSources(e){const t=this.metadata,r=t.rank,i=t.chunks,s=t.shape;let a,l,c;if(t.order==="F")a=Uint32Array.from(i),l=Float32Array.from(s),c=xs(Float32Array,r+1);else{a=new Uint32Array(r),l=new Float32Array(r),c=new Float32Array((r+1)**2),c[(r+1)**2-1]=1;for(let u=0;u<r;++u)a[u]=i[r-1-u],l[u]=s[r-1-u],c[u+(r-1-u)*(r+1)]=1}return cd([$d({rank:r,chunkToMultiscaleTransform:c,dataType:t.dataType,upperVoxelBound:l,volumeType:this.volumeType,chunkDataSizes:[a],volumeSourceOptions:e}).map(u=>({chunkSource:this.chunkManager.getChunkSource(Oq,{credentialsProvider:this.credentialsProvider,spec:u,parameters:{url:this.url,encoding:t.encoding,separator:this.separator}}),chunkToMultiscaleTransform:c}))])}}function _q(n,e,t){return n.memoize.getUncounted({type:"zarr:.zattrs json",url:t,credentialsProvider:ln(e)},async()=>{try{const r=await zo(e,t+"/.zattrs",{},si);return ge(r),r}catch(r){if(Th(r))return{};throw r}})}function Uq(n,e,t){return n.memoize.getUncounted({type:"zarr:.zarray json",url:t,credentialsProvider:ln(e)},async()=>{const r=await zo(e,t+"/.zarray",{},si);return Bq(r)})}const $q=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}];class zq extends oa{get description(){return"Zarr data source"}get(e){var t=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),r=ae(t,3);let i=r[1],s=r[2];const a=gd(s||"");ge(a);const l=qP(a);return i.endsWith("/")&&(i=i.substring(0,i.length-1)),e.chunkManager.memoize.getUncounted({type:"zarr:MultiscaleVolumeChunkSource",providerUrl:i,dimensionSeparator:l},async()=>{var c=Ud(i,e.credentialsManager);const u=c.url,h=c.credentialsProvider;var g=await xt.all([Uq(e.chunkManager,h,u),_q(e.chunkManager,h,u)]),v=ae(g,2);const y=v[0],C=v[1];if(y.dimensionSeparator!==void 0&&l!==void 0&&y.dimensionSeparator!==l)throw new Error(`Explicitly specified dimension separator ${ie(l)} does not match value in .zarray ${ie(y.dimensionSeparator)}`);const S=new Fq(e.chunkManager,h,u,l||y.dimensionSeparator||".",y,C);return{modelTransform:zn(S.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:S}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:yd(S.modelSpace.bounds)}}]}})}async completeUrl(e){var t=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),r=ae(t,3);let i=r[2];return i!==void 0?Fo(e.providerUrl.length-i.length,await KL(i,$q)):await Hy(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ca("zarr",()=>new zq);var ra;(function(n){n[n.DEFAULT=0]="DEFAULT",n[n.ADDITIVE=1]="ADDITIVE"})(ra||(ra={}));const Gq=new de([[ra.DEFAULT,n=>{n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA)}],[ra.ADDITIVE,n=>{n.blendFunc(n.SRC_ALPHA,n.ONE)}]]);function Wq(n=ra.DEFAULT){return new fh(ra,n)}const JP=`#uicontrol invlerp normalized
void main() {
  emitGrayscale(normalized());
}
`;function jq(n=JP){return Ev(n)}function YP(n,e){n.addFragmentCode(`
#define VOLUME_RENDERING false

void emitRGBA(vec4 rgba) {
  emit(vec4(rgba.rgb, rgba.a * uOpacity));
}
void emitRGB(vec3 rgb) {
  emit(vec4(rgb, uOpacity));
}
void emitGrayscale(float value) {
  emit(vec4(value, value, value, uOpacity));
}
void emitTransparent() {
  emit(vec4(0.0, 0.0, 0.0, 0.0));
}
`),n.addFragmentCode(td),ed(e,n),n.setFragmentMainFunction(Kl(e.parseResult.code))}class Hq extends rD{constructor(e,t){var r,i,s;const a=t.opacity,l=t.blendMode,c=t.shaderControlState;super(e,j(j({},t),{fallbackShaderParameters:new dt(Mv(ch(JP,{imageData:{dataType:e.dataType,channelRank:(s=(i=(r=t.channelCoordinateSpace)===null||r===void 0?void 0:r.value)===null||i===void 0?void 0:i.rank)!==null&&s!==void 0?s:0}}))),encodeShaderParameters:u=>u.key,shaderParameters:c.builderState,dataHistogramSpecifications:c.histogramSpecifications})),this.shaderControlState=c,this.opacity=a,this.blendMode=l,this.registerDisposer(a.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(l.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(c.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),YP(e,t)}initializeShader(e,t,r){const i=this.gl;i.uniform1f(t.uniform("uOpacity"),this.opacity.value),mo(i,t,this.shaderControlState,r.parseResult.controls)}setGLBlendMode(e,t){const r=this.blendMode.value;r===ra.ADDITIVE||t>0?(e.enable(e.BLEND),Gq.get(r)(e)):e.disable(WebGL2RenderingContext.BLEND)}}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const qq="volume_rendering/VolumeRenderingRenderLayer",Jq="volume_rendering/VolumeRenderingRenderLayer/update",Um=64,Yq=ud();function Xq(n,e,t){let r=0,i=0;for(let u=0;u<3;++u){const h=n[16+u],g=h*e[u],v=h*t[u];r+=Math.min(g,v),i+=Math.max(g,v)}const s=-n[19],a=Math.max(s,r),l=n[23],c=Math.min(l,i);return{near:s,far:l,adjustedNear:a,adjustedFar:c}}function xT(n,e,t,r,i,s){if(r.length===0)return;const a=n.viewMatrix,l=n.projectionMat,c=n.displayDimensionRenderInfo.voxelPhysicalScales,u=gg(c),h=(uk(l)/Um)**3,g=tv(th(Yq,a)),v=P=>{const D=r[P];return Math.abs(D.chunkLayout.detTransform*g)};let y=r.length-1,C=v(y);for(let P=y-1;P>=0;--P){const D=v(P);if(Math.abs(D-h)<Math.abs(C-h))C=D,y=P;else break}const S=Math.pow(C*u/g,1/3),w=Math.pow(C,1/3)*n.width/(2*l[0]);let E=!0;const k=r[y];OL(n,e,k,(P,D)=>{E&&(i(k,y,S,w,D),E=!1),s(k,y,P)})}const Kq=Je(),Zq=new Float32Array(24);class Qq extends Uo{constructor(e){super(),this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.renderScaleTarget=e.renderScaleTarget,this.renderScaleHistogram=e.renderScaleHistogram,this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility));const t=this.registerDisposer(dr(a=>a.rank,[this.channelCoordinateSpace]));this.shaderGetter=Tv(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:({emitter:a,chunkFormat:l})=>`${ln(a)}:${l.shaderKey}`,shaderError:e.shaderError,extraParameters:t,defineShader:(a,{emitter:l,chunkFormat:c},u,h)=>{if(u.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Mi(a),a.addFragmentCode(`
#define VOLUME_RENDERING true
`),l(a),a.addUniform("highp float","uNearLimitFraction"),a.addUniform("highp float","uFarLimitFraction"),a.addUniform("highp int","uMaxSteps"),a.addUniform("highp vec3","uTranslation"),a.addUniform("highp mat4","uModelViewProjectionMatrix"),a.addUniform("highp mat4","uInvModelViewProjectionMatrix"),a.addUniform("highp vec3","uChunkDataSize"),a.addUniform("highp vec3","uLowerClipBound"),a.addUniform("highp vec3","uUpperClipBound"),a.addUniform("highp float","uBrightnessFactor"),a.addVarying("highp vec4","vNormalizedPosition"),a.addVertexCode(VW),a.setVertexMain(`
vec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);
vec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));
vNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
`),a.addFragmentCode(`
vec3 curChunkPosition;
vec4 outputColor;
void userMain();
`),z2(a,c,h,"curChunkPosition"),a.addFragmentCode(`
void emitRGBA(vec4 rgba) {
  float alpha = rgba.a * uBrightnessFactor;
  outputColor += vec4(rgba.rgb * alpha, alpha);
}
void emitRGB(vec3 rgb) {
  emitRGBA(vec4(rgb, 1.0));
}
void emitGrayscale(float value) {
  emitRGB(vec3(value, value, value));
}
void emitTransparent() {
  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));
}
`),a.setFragmentMainFunction(`
void main() {
  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;
  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);
  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);
  vec3 nearPoint = nearPointH.xyz / nearPointH.w;
  vec3 farPoint = farPointH.xyz / farPointH.w;
  vec3 rayVector = farPoint - nearPoint;
  vec3 boxStart = max(uLowerClipBound, uTranslation);
  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);
  float intersectStart = uNearLimitFraction;
  float intersectEnd = uFarLimitFraction;
  for (int i = 0; i < 3; ++i) {
    float startPt = nearPoint[i];
    float endPt = farPoint[i];
    float boxLower = boxStart[i];
    float boxUpper = boxEnd[i];
    float r = rayVector[i];
    float startFraction;
    float endFraction;
    if (startPt >= boxLower && startPt <= boxUpper) {
      startFraction = 0.0;
    } else {
      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    if (endPt >= boxLower && endPt <= boxUpper) {
      endFraction = 1.0;
    } else {
      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    intersectStart = max(intersectStart, startFraction);
    intersectEnd = min(intersectEnd, endFraction);
  }
  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);
  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));
  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);
  outputColor = vec4(0, 0, 0, 0);
  for (int step = startStep; step < endStep; ++step) {
    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(step) * stepSize);
    curChunkPosition = position - uTranslation;
    userMain();
  }
  emit(outputColor, 0u);
}
`),a.addFragmentCode(td),ed(u,a),a.addFragmentCode(`
#define main userMain
`+Kl(u.parseResult.code)+`
#undef main
`)}}),this.vertexIdHelper=this.registerDisposer(ii.get(this.gl)),this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));const r=this.multiscaleSource.chunkManager,i=this.registerDisposer(new Td(this.layerChunkProgressInfo)),s=r.rpc;i.RPC_TYPE_ID=qq,i.initializeCounterpart(s,{chunkManager:r.rpcId,localPosition:this.registerDisposer(mn.makeFromExisting(s,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(mn.makeFromExisting(s,this.renderScaleTarget)).rpcId}),this.backend=i}get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer(Di((t,r,i)=>{const s=$v(i,r,a=>this.multiscaleSource.getSources(a),e.messages,this);for(const a of s)for(const l of a)t.registerDisposer(l.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(Jq,{layer:this.backend.rpcId,view:e.view.rpcId,sources:Uv(s)}),this.redrawNeeded.dispatch(),s},this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){if(!e.emitColor)return;const r=t.state.sources.value;if(r.length===0)return;let i=0,s=0,a=null,l,c;const u=Ne(),h=this.gl;this.vertexIdHelper.enable();const g=this.renderScaleHistogram;g.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);const v=()=>{a!==null&&(l!==null&&l.endDrawing(h,a),(w!==0||E!==0)&&g.add(i,s,w,E))};let y=!0;const C=e.projectionParameters;let S,w=0,E=0,k;const P=this.multiscaleSource.rank,D=Ne();h.enable(WebGL2RenderingContext.CULL_FACE),h.cullFace(WebGL2RenderingContext.FRONT),xT(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,r[0],(L,R,M,V)=>{i=M,s=V;const B=Ov(C,L.chunkLayout),_=L.source,H=L.fixedPositionWithinChunk,U=L.chunkDisplayDimensionIndices;for(const _e of U)H[_e]=0;const O=_.chunkFormat;if(O!==l&&(l=O,v(),c=this.shaderGetter({emitter:e.emitter,chunkFormat:O}),a=c.shader,a!==null&&(a.bind(),O!==null&&(mo(h,a,this.shaderControlState,c.parameters.parseResult.controls),O.beginDrawing(h,a),O.beginSource(h,a)))),k=void 0,a===null)return;S=_.chunks,u.fill(1);const z=en(Kq,C.viewProjectionMat,B.transform);h.uniformMatrix4fv(a.uniform("uModelViewProjectionMatrix"),!1,z);const F=Zq;nu(F,z),fs(z,z),h.uniformMatrix4fv(a.uniform("uInvModelViewProjectionMatrix"),!1,z);var se=Xq(F,L.lowerClipDisplayBound,L.upperClipDisplayBound);const oe=se.near,Re=se.far,le=se.adjustedNear,Se=se.adjustedFar,ne=(Se-le)/(Um-1)/(Re-oe);h.uniform1f(a.uniform("uBrightnessFactor"),ne);const he=(le-oe)/(Re-oe),Le=(Se-oe)/(Re-oe);h.uniform1f(a.uniform("uNearLimitFraction"),he),h.uniform1f(a.uniform("uFarLimitFraction"),Le),h.uniform1i(a.uniform("uMaxSteps"),Um),h.uniform3fv(a.uniform("uLowerClipBound"),L.lowerClipDisplayBound),h.uniform3fv(a.uniform("uUpperClipBound"),L.upperClipDisplayBound)},L=>{if(a===null)return;const R=L.curPositionInChunks.join(),M=S.get(R);if(M!==void 0&&M.state===pt.GPU_MEMORY){const V=L.chunkLayout.size;let B=M.chunkDataSize;const _=L.chunkDisplayDimensionIndices,H=L.fixedPositionWithinChunk,U=L.chunkTransform.channelToChunkDimensionIndices;if($P(L),B!==k){k=B;for(let z=0;z<3;++z){const F=_[z];u[z]=F===-1||F>=P?1:k[F]}h.uniform3fv(a.uniform("uChunkDataSize"),u)}const O=M.chunkGridPosition;for(let z=0;z<3;++z){const F=_[z];D[z]=F===-1||F>=P?0:V[z]*O[F]}l?.bindChunk(h,a,M,H,_,U,y),y=!1,h.uniform3fv(a.uniform("uTranslation"),D),OW(h,1,1),++w}else++E}),h.disable(WebGL2RenderingContext.CULL_FACE),v(),this.vertexIdHelper.disable()}isReady(e,t){const r=t.state.sources.value;if(r.length===0)return!0;let i=!1;return xT(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,r[0],()=>{},s=>{const a=s.source.chunks.get(s.curPositionInChunks.join());(a===void 0||a.state!==pt.GPU_MEMORY)&&(i=!0)}),i}}const e8=at.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}});class t8{constructor(e){this.id=e,this.element=document.createElement("div"),this.nameContainer=document.createElement("div"),this.nameElement=document.createElement("input"),this.lowerElement=document.createElement("div"),this.upperElement=document.createElement("div");const t=this.element,r=this.nameContainer,i=this.nameElement,s=this.lowerElement,a=this.upperElement;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),r.classList.add("neuroglancer-channel-dimensions-widget-name-container"),i.classList.add("neuroglancer-channel-dimensions-widget-name"),r.appendChild(i),s.classList.add("neuroglancer-channel-dimensions-widget-lower"),a.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(r),t.appendChild(s),t.appendChild(a),r.draggable=!0,i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",i.required=!0,i.placeholder=" ",r.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",r.addEventListener("dblclick",()=>{i.disabled=!1,i.focus(),i.select()}),i.addEventListener("focus",()=>{i.select()})}}class n8 extends K{constructor(e){super(),this.combiner=e,this.element=document.createElement("div"),this.dimensionWidgets=[],this.curCoordinateSpace=void 0,this.dragSource=void 0,this.coordinateSpace=this.combiner.combined;const t=this.element;t.classList.add("neuroglancer-channel-dimensions-widget");const r=this.registerCancellable(ct(()=>this.updateView()));this.registerDisposer(e.combined.changed.add(r));const i=this.registerDisposer(new Nr(t,e8));i.allShortcutsAreGlobal=!0,this.registerDisposer(ve(t,"cancel",s=>{this.forceUpdateView();const a=s.target;a instanceof HTMLElement&&a.blur()})),this.updateView()}reorderDimensionTo(e,t){if(e===t)return;const r=this.coordinateSpace;r.value=Uk(r.value,e,t)}makeNewDimensionWidget(e){const t=new t8(e);return t.nameContainer.addEventListener("dragstart",r=>{this.dragSource=t,r.stopPropagation(),r.dataTransfer.setData("neuroglancer-dimension","")}),t.nameContainer.addEventListener("dragenter",r=>{const i=this.dragSource;if(i===void 0||i===t)return;const s=this.dimensionWidgets,a=s.indexOf(i),l=s.indexOf(t);a===-1||l===-1||(r.preventDefault(),this.reorderDimensionTo(l,a))}),t.nameContainer.addEventListener("dragend",r=>{this.dragSource===t&&(this.dragSource=void 0)}),t.nameElement.addEventListener("blur",r=>{t.nameElement.disabled=!0;const i=r.relatedTarget;this.dimensionWidgets.some(s=>s.nameElement===i)||this.updateNames()||this.forceUpdateView()}),t.nameElement.addEventListener("input",()=>{const r=t.nameElement;_n(r),this.updateNameValidity()}),ve(t.nameElement,"commit",()=>{this.updateNames()}),ve(t.nameElement,"tab-forward",r=>this.selectAdjacentField(r,t,1)),ve(t.nameElement,"tab-backward",r=>this.selectAdjacentField(r,t,-1)),t}selectAdjacentField(e,t,r){e.stopPropagation();const i=this.dimensionWidgets,s=i.indexOf(t);if(s===-1)return;const a=s+r;if(a<0||a>=i.length)return;const l=i[a];l.nameElement.disabled=!1,l.nameElement.focus(),e.preventDefault()}updateNames(){const e=this.dimensionWidgets,t=this.coordinateSpace,r=t.value,i=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(i).includes(!1))return!1;const s=r.names;if(Oe(s,i))return!1;const a=r.timestamps.map((c,u)=>s[u]===i[u]?c:Date.now()),l=j(j({},r),{names:i,timestamps:a});return t.value=l,!0}updateNameValidity(){const e=this.dimensionWidgets,t=e.map(s=>s.nameElement.value),r=t.length,i=this.combiner.getRenameValidity(t);for(let s=0;s<r;++s)e[s].nameElement.dataset.isValid=i[s]===!1?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){const e=this.coordinateSpace.value;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;const t=this.element,r=this.dimensionWidgets,i=this.dimensionWidgets=e.ids.map(a=>r.find(l=>l.id===a)||this.makeNewDimensionWidget(a));function*s(){const a=e.names,l=e.rank;var c=e.bounds;const u=c.lowerBounds,h=c.upperBounds;for(let g=0;g<l;++g){const v=i[g];v.nameElement.value=a[g],delete v.nameElement.dataset.isValid,_n(v.nameElement),v.lowerElement.textContent=u[g].toString(),v.upperElement.textContent=h[g].toString(),yield v.element}}Yr(t,s.call(this))}}const $m="opacity",zm="blend",ET="shader",TT="shaderControls",Gm="crossSectionRenderScale",kT="channelDimensions",Wm="volumeRendering",r8="volumeRenderScale",i8=Ry(Wo);class ua extends i8{constructor(e){super(e),this.opacity=Bl(.5),this.blendMode=Wq(),this.fragmentMain=jq(),this.shaderError=lh(),this.dataType=new dt(void 0),this.sliceViewRenderScaleHistogram=new vo,this.sliceViewRenderScaleTarget=ta(1),this.volumeRenderingRenderScaleHistogram=new vo,this.volumeRenderingRenderScaleTarget=ta(1),this.channelCoordinateSpace=new gv,this.channelCoordinateSpaceCombiner=new bv(this.channelCoordinateSpace,P3),this.channelSpace=this.registerDisposer(Hr(t=>fL(()=>F3(t)),this.channelCoordinateSpace)),this.volumeRendering=new Ft(!1,!1),this.shaderControlState=this.registerDisposer(new Av(this.fragmentMain,this.registerDisposer(dr((t,r)=>t===void 0?null:{imageData:{dataType:t,channelRank:r.rank}},[this.dataType,this.channelCoordinateSpace],(t,r)=>ie(t)===ie(r))),this.channelCoordinateSpaceCombiner)),this.localCoordinateSpaceCombiner.includeDimensionPredicate=Ul,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRendering.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new s8(this)}),this.tabs.default="rendering"}markLoading(){const e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){const t=super.addCoordinateSpace(e),r=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),r()}}activateDataSubsources(e){let t;for(const r of e){if(this.addStaticAnnotations(r))continue;const i=r.subsourceEntry.subsource.volume;if(!(i instanceof Is)){r.deactivate("Not compatible with image layer");continue}if(t&&i.dataType!==t){r.deactivate(`Data type must be ${q[i.dataType].toLowerCase()}`);continue}t=i.dataType,r.activate(s=>{r.addRenderLayer(new Hq(i,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:r.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));const a=s.registerDisposer(new Qq({multiscaleSource:i,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:r.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.volumeRenderingRenderScaleTarget,renderScaleHistogram:this.volumeRenderingRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));s.registerDisposer(r.messages.addChild(a.messages)),s.registerDisposer(Di((l,c)=>{c&&l.registerDisposer(this.addRenderLayer(a.addRef()))},this.volumeRendering)),this.shaderError.changed.dispatch()})}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[$m]),ye(e,zm,t=>this.blendMode.restoreState(t)),this.fragmentMain.restoreState(e[ET]),this.shaderControlState.restoreState(e[TT]),this.sliceViewRenderScaleTarget.restoreState(e[Gm]),this.channelCoordinateSpace.restoreState(e[kT]),this.volumeRendering.restoreState(e[Wm])}toJSON(){const e=super.toJSON();return e[$m]=this.opacity.toJSON(),e[zm]=this.blendMode.toJSON(),e[ET]=this.fragmentMain.toJSON(),e[TT]=this.shaderControlState.toJSON(),e[Gm]=this.sliceViewRenderScaleTarget.toJSON(),e[kT]=this.channelCoordinateSpace.toJSON(),e[Wm]=this.volumeRendering.toJSON(),e}displayImageSelectionState(e,t){const r=e.value;if(r==null)return!1;const i=this.channelSpace.value;if(i.error!==void 0)return!1;const s=i.numChannels,a=i.coordinates;var l=i.channelCoordinateSpace;const c=l.names,u=l.rank,h=document.createElement("div");h.classList.add("neuroglancer-selection-details-value-grid");let g="[copy] 0fr ";u!==0&&(g+=`repeat(${u}, [dim] 0fr [coord] 0fr) `),g+="[value] 1fr",h.style.gridTemplateColumns=g;for(let v=0;v<s;++v){const y=u===0?r:r[v],C=y==null?"":y.toString(),S=Zr({title:"Copy value",onClick:()=>{Yn(C)}});h.appendChild(S);for(let E=0;E<u;++E){const k=document.createElement("div");k.classList.add("neuroglancer-selection-details-value-grid-dim"),k.textContent=c[E],h.appendChild(k);const P=document.createElement("div");P.classList.add("neuroglancer-selection-details-value-grid-coord"),P.textContent=a[v*u+E].toString(),h.appendChild(P)}const w=document.createElement("div");w.classList.add("neuroglancer-selection-details-value-grid-value"),w.textContent=C,h.appendChild(w)}return t.appendChild(h),!0}displaySelectionState(e,t,r){let i=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,r)&&(i=!0),i}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode(`
#define uOpacity 1.0
`),YP(e,t)},initializeShader:e=>{const t=e.shader;mo(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}}ua.type="image";ua.typeAbbreviation="img";function XP(n){return new Fy({shaderError:n.shaderError,fragmentMain:n.fragmentMain,shaderControlState:n.shaderControlState})}const KP=[j({label:"Resolution (slice)",toolJson:Gm},Vu(n=>({histogram:n.sliceViewRenderScaleHistogram,target:n.sliceViewRenderScaleTarget}))),j({label:"Blending",toolJson:zm},WD(n=>n.blendMode)),j({label:"Volume rendering (experimental)",toolJson:Wm},jl(n=>n.volumeRendering)),j({label:"Resolution (3d)",toolJson:r8,isValid:n=>n.volumeRendering},Vu(n=>({histogram:n.volumeRenderingRenderScaleHistogram,target:n.volumeRenderingRenderScaleTarget}))),j({label:"Opacity",toolJson:$m},ds(n=>({value:n.opacity})))];for(const n of KP)FD(ua,n);class s8 extends Fi{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(XP(this.layer));const t=this.element;t.classList.add("neuroglancer-image-dropdown");for(const s of KP)t.appendChild(Oy(this,e,this.visibility,s));let r=document.createElement("div");r.style.flex="1";let i=document.createElement("div");i.className="neuroglancer-image-dropdown-top-row",i.appendChild(document.createTextNode("Shader")),i.appendChild(r),i.appendChild(By({title:"Show larger editor view",onClick:()=>{new a8(this.layer)}})),i.appendChild(Vy({title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(i),t.appendChild(this.registerDisposer(new n8(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new _y(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}}class a8 extends Dh{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(XP(this.layer)),this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}jo(ua);GI(gn.IMAGE,ua);by(n=>{const e=n.volume;if(e!==void 0&&e.volumeType===gn.UNKNOWN)return{layerConstructor:ua,priority:-100}});Uy(ua,n=>({shaderControlState:n.shaderControlState,legendShaderOptions:n.getLegendShaderOptions()}));function o8(n){if(n.brainMapsClientId){const t=n.brainMapsClientId;$o.register(Mh,()=>new DP(t))}let e=Wj({bundleRoot:n.bundleRoot},n.target);return iU(e.inputEventBindings),Mj(e),Nj(e),jj(n.target),e}const l8="#323232",ws={};let Ss;function m8(n){let e=null,t=n.replace(/^[^#]+/,"");if((t===""||t==="#"||t==="#!")&&(t="#!{}"),t.startsWith("#!+"))t=t.slice(3),t=decodeURIComponent(t),e=bg(t);else if(t.startsWith("#!"))t=t.slice(2),t=decodeURIComponent(t),e=bg(t);else throw new Error("URL hash is expected to be of the form '#!{...}' or '#!+{...}'.");return e}function v8(n){const e=n?ws[n]:Ss;return e?e.state.toJSON():{}}function y8(n,e){try{const t=te.parseString(n),r=e?ws[e]:Ss;if(r){for(const i of r.layerManager.managedLayers)if(i.layer instanceof qt){const{displayState:s}=i.layer,a=A2(s,t);if(s.segmentSelectionState.isSelected(t))for(let l=0;l<3;l+=1)a[l]=(a[l]-.5)/.5;return Rn(a)}}}catch{}return""}function b8(n){const e=n?ws[n]:Ss;e&&e.closeSelectionTab&&e.closeSelectionTab()}function qy(n){const e=n?ws[n]:Ss;if(e)return e.layerManager}function jm(n,e){const t=qy(n);if(t)return t.managedLayers.filter(r=>r.name===e)[0]}function ZP(n,e){const t=jm(n,e);if(t&&t.layer instanceof bs)return t.layer}function w8(n,e){const t=ZP(n,e);if(t&&t.dataSources&&t.dataSources[0].loadState_){const{dataSource:r}=t.dataSources[0].loadState_;if(r)return r.subsources[0].subsource.annotation}}function d8(n,e,t){const r=qy(n);r&&e&&t&&(r.customSignalHandlerRemovers||(r.customSignalHandlerRemovers={}),r.customSignalHandlerRemovers[e]||(r.customSignalHandlerRemovers[e]=[]),r.customSignalHandlerRemovers[e].push(t))}function LT(n,e){n&&n.customSignalHandlerRemovers&&n.customSignalHandlerRemovers[e]&&(n.customSignalHandlerRemovers[e].forEach(t=>{t()}),delete n.customSignalHandlerRemovers[e])}function S8(n,e){const t=qy(n);if(t){const{layerName:r}=e;if(LT(t,r),e.process){(s=>d8(void 0,r,s))(t.layersChanged.add(()=>{const s=jm(void 0,r);s&&e.process(s)}));const i=jm(void 0,r);return i&&e.process(i),()=>{e.cancel&&e.cancel(),LT(t,r)}}}return e.cancel}function c8(n,e,t){n&&!n.signalReady&&(e.onAnnotationAdded&&t(n.childAdded.add(r=>{e.onAnnotationAdded(r)})),e.onAnnotationDeleted&&t(n.childDeleted.add(r=>{e.onAnnotationDeleted(r)})),e.onAnnotationUpdated&&t(n.childUpdated.add(r=>{e.onAnnotationUpdated(r)})),e.onAnnotationChanged&&n.referencesChanged&&t(n.referencesChanged.add(e.onAnnotationChanged)),n.signalReady=!0,t(()=>{n.signalReady=!1}))}function u8(n){if(n.dataSources&&n.dataSources.length>0&&n.dataSources[0].loadState_&&n.dataSources[0].loadState_.dataSource)return n.dataSources[0].loadState_.dataSource}function h8(n){const e=u8(n);if(e)return e.subsources[0].subsource.annotation}function p8(n,e,t){const r=()=>{const s=h8(n);s&&c8(s,e,t)},i=n.dataSourcesChanged;i&&!i.signalReady&&(t(i.add(r)),i.signalReady=!0,t(()=>{i.signalReady=!1}),r())}function IT(n,e,t){n&&(n.expectingExternalTable=!0,n.selectedAnnotation&&!n.selectedAnnotation.changed.signalReady&&e.onAnnotationSelectionChanged&&(t(n.selectedAnnotation.changed.add(()=>{e.onAnnotationSelectionChanged(n.selectedAnnotation.value)})),t(()=>{n.selectedAnnotation.changed.signalReady=!1}),n.selectedAnnotation.changed.signalReady=!0),p8(n,e,t))}function C8(n,e,t){if(!n.layerChanged.signalReady){const r=n.layerChanged.add(()=>{IT(n.layer,e,t)});n.layerChanged.signalReady=!0,t(r),t(()=>{n.layerChanged.signalReady=!1}),IT(n.layer,e,t)}}function x8(n){const e=n?ws[n]:Ss;return e?e.selectionDetailsState?"viewer":"layer":null}function E8(n,e){const t=n?ws[n]:Ss;if(t)if(t.selectionDetailsState){if(t.selectionDetailsState.value){const{layers:r}=t.selectionDetailsState.value;if(r){const i=r.find(s=>s.layer.managedLayer.name===e);if(i&&i.state)return i.state.annotationId}}}else{const r=ZP(void 0,e);if(r&&r.selectedAnnotation&&r.selectedAnnotation.value)return r.selectedAnnotation.value.id}return null}class f8 extends qb.Component{constructor(e){super(e),Er(this,"minimalPoseSnapshot",()=>{const t=this.viewer,r=t.projectionScale?.value,i=t.projectionOrientation?.orientation;return{position:Array.from(t.position.value||[]),projectionScale:r,projectionOrientation:Array.from(i||[])}}),Er(this,"scheduleEmit",()=>{let t=null;return()=>{this.muteViewerChanged||t===null&&(t=requestAnimationFrame(()=>{t=null,this.props.onViewerStateChanged?.(this.minimalPoseSnapshot())}))}}),Er(this,"withoutEmitting",t=>{this.muteViewerChanged=!0;try{t()}finally{requestAnimationFrame(()=>{this.muteViewerChanged=!1})}}),Er(this,"didLayersChange",(t,r)=>{const i=l=>(l||[]).map(c=>{if(!c)return c;const{segmentColors:u,...h}=c;return h}),s=i(t?.layers),a=i(r?.layers);return JSON.stringify(s)!==JSON.stringify(a)}),Er(this,"applyColorsAndVisibility",t=>{if(!this.viewer)return;const r={...t||{}};for(const a of Object.keys(r))this.allKnownIds.add(a);if(this.allKnownIds.size===0){const a=this.props.viewerState?.layers?.[0]?.segmentColors||{};for(const l of Object.keys(a))this.allKnownIds.add(l)}const i={};for(const a of this.allKnownIds)i[a]=r[a]||l8;const s=(this.props.viewerState?.layers??(this.viewer.state.toJSON().layers||[])).map((a,l)=>l===0||a?.type==="segmentation"?{...a,segmentColors:i}:a);this.withoutEmitting(()=>{this.viewer.state.restoreState({layers:s})})}),Er(this,"updateEventBindings",t=>{const r=this.viewer.inputEventBindings,i=s=>{const a=(c,u,h)=>{const g=c.get(u);g&&(c.delete(u),h&&c.set(h,g))},l=s.bindings;t.forEach(c=>{const u=Array.isArray(c)?c[0]:c,h=`at:${u}`,g=c[1]?`at:${c[1]}`:void 0;a(l,h,g);const v=`bubble:${u}`,y=c[1]?`bubble:${c[1]}`:void 0;a(l,v,y)}),s.parents.forEach(c=>{i(c)})};i(r.global),i(r.perspectiveView),i(r.sliceView)}),Er(this,"selectionDetailsStateChanged",()=>{if(this.viewer){const{onSelectionDetailsStateChanged:t}=this.props;t&&t()}}),Er(this,"layersChanged",()=>{if(this.handlerRemovers&&this.handlerRemovers.forEach(t=>t()),this.viewer){const{onSelectedChanged:t,onVisibleChanged:r}=this.props;if(t||r){this.handlerRemovers=[];for(const i of this.viewer.layerManager.managedLayers)if(i.layer instanceof qt){const{segmentSelectionState:s}=i.layer.displayState,{visibleSegments:a}=i.layer.displayState.segmentationGroupState.value;if(s&&t){const l=this.selectedChanged.bind(void 0,i),c=s.changed.add(l);this.handlerRemovers.push(c),i.registerDisposer(c)}if(a&&r){const l=this.visibleChanged.bind(void 0,i),c=a.changed.add(l);this.handlerRemovers.push(c),i.registerDisposer(c)}}}}}),Er(this,"selectedChanged",t=>{if(!this.viewer)return;const{onSelectedChanged:r}=this.props;if(r){const{segmentSelectionState:i}=t.layer.displayState;if(!i)return;const s=i.selectedSegment;s&&r(s,t)}}),Er(this,"visibleChanged",t=>{if(this.viewer){const{onVisibleChanged:r}=this.props;if(r){const{visibleSegments:i}=t.layer.displayState.segmentationGroupState.value;i&&r(i,t)}}}),this.ngContainer=qb.createRef(),this.viewer=null,this.muteViewerChanged=!1,this.prevVisibleIds=new Set,this.prevColorMap=null,this.disposers=[],this.prevColorOverrides=new Set,this.overrideColorsById=Object.create(null),this.allKnownIds=new Set}componentDidMount(){const{viewerState:e,brainMapsClientId:t,eventBindingsToUpdate:r,callbacks:i,key:s,bundleRoot:a}=this.props;this.viewer=o8({brainMapsClientId:t,target:this.ngContainer.current,bundleRoot:a}),this.setCallbacks(i),r&&this.updateEventBindings(r),this.viewer.expectingExternalUI=!0,this.viewer.selectionDetailsState&&this.viewer.selectionDetailsState.changed.add(this.selectionDetailsStateChanged),this.viewer.layerManager.layersChanged.add(this.layersChanged);const l=this.scheduleEmit();this.disposers.push(this.viewer.projectionScale.changed.add(l)),this.disposers.push(this.viewer.projectionOrientation.changed.add(l)),this.disposers.push(this.viewer.position.changed.add(l)),e&&this.withoutEmitting(()=>{this.viewer.state.restoreState(e)}),s?ws[s]=this.viewer:Ss=this.viewer}componentDidUpdate(e,t){const{viewerState:r,cellColorMapping:i}=this.props,s={};for(const D of this.viewer.layerManager.managedLayers)if(D.layer instanceof qt){const{segmentSelectionState:L}=D.layer.displayState;s[D.name]=L.selectedSegment}for(const D of this.viewer.layerManager.managedLayers)if(D.layer instanceof qt){const{segmentSelectionState:L}=D.layer.displayState;L.set(s[D.name])}if(!r)return;const a=e.viewerState,l=ZM(a,r);if(l.changed){const D={};l.scale?(D.projectionScale=r.projectionScale,Array.isArray(r.position)&&(D.position=r.position)):l.pos&&(D.position=r.position),l.rot&&(D.projectionOrientation=r.projectionOrientation),this.withoutEmitting(()=>this.viewer.state.restoreState(D))}this.didLayersChange(a,r)&&this.withoutEmitting(()=>{const D=Array.isArray(r.layers)?r.layers:[];this.viewer.state.restoreState({layers:D}),i&&Object.keys(i).length&&this.applyColorsAndVisibility(i)});const c=e.cellColorMapping?Object.keys(e.cellColorMapping).length:0,u=i?Object.keys(i).length:0,h=e.cellColorMapping!==i;!this.didLayersChange(a,r)&&(h||c!==u)&&this.withoutEmitting(()=>{this.applyColorsAndVisibility(i)});const g=D=>(D||[]).map(L=>{if(!L)return L;const{segments:R,segmentColors:M,...V}=L;return V}),v=e.viewerState?.layers,y=r?.layers,C=JSON.stringify(g(v)),S=JSON.stringify(g(y)),w=C!==S,E=v&&v[0]&&Array.isArray(v[0].segments)?v[0].segments.length:0,k=y&&y[0]&&Array.isArray(y[0].segments)?y[0].segments.length:0,P=E===0&&k>0;(w||P)&&this.withoutEmitting(()=>{this.viewer.state.restoreState({layers:y})})}componentWillUnmount(){this.disposers.forEach(t=>{try{t()}catch{}}),this.disposers=[];const{key:e}=this.props;e?delete ws[e]:Ss=void 0}setCallbacks(e){e.forEach(t=>{this.viewer.bindCallback(t.name,t.function),this.viewer.inputEventBindings.sliceView.set(t.event,t.name)})}render(){const{perspectiveZoom:e}=this.props;return Jb.jsx("div",{className:"neuroglancer-container",ref:this.ngContainer,children:Jb.jsxs("p",{children:["Neuroglancer here with zoom ",e]})})}}Er(f8,"defaultProps",{perspectiveZoom:20,eventBindingsToUpdate:null,brainMapsClientId:"NOT_A_VALID_ID",viewerState:null,onSelectedChanged:null,onVisibleChanged:null,onSelectionDetailsStateChanged:null,onViewerStateChanged:null,key:null,callbacks:[],ngServer:"https://neuroglancer-demo.appspot.com/"});export{d8 as addLayerSignalRemover,b8 as closeSelectionTab,IT as configureAnnotationLayer,C8 as configureAnnotationLayerChanged,S8 as configureLayersChangedSignals,f8 as default,ZP as getAnnotationLayer,x8 as getAnnotationSelectionHost,w8 as getAnnotationSource,qy as getLayerManager,jm as getManagedLayer,y8 as getNeuroglancerColor,v8 as getNeuroglancerViewerState,E8 as getSelectedAnnotationId,m8 as parseUrlHash,LT as unsubscribeLayersChangedSignals};

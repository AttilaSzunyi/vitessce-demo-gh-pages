import{b1 as qS,b7 as ZM,H as JS,w as Qe,b8 as QM,b9 as eA,ba as tA,bb as Io,bc as ra,bd as ut,be as iA,bf as jm,bg as Ot,bh as qm,bi as PE,bj as nA,bk as rA,bl as Gu,bm as sA,bn as sa,bo as aA,bp as oA,bq as Wu,br as Hu,bs as Cs,bt as Nr,bu as IE,bv as RE,bw as ju,bx as Jm,by as ME,bz as qu,bA as lA,bB as cA,bC as Xm,bD as Vr,bE as Km,bF as Ro,bG as dA,bH as Ym,bI as uA,bJ as hA,bK as pA,bL as fA,bM as gA,bN as mA,bO as vA,bP as yA,bQ as SA}from"./index-Bm04Wswa.js";var bA=Object.defineProperty,wA=(i,e,t)=>e in i?bA(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,kn=(i,e,t)=>wA(i,typeof e!="symbol"?e+"":e,t),CA=QM();const H=Qe(CA);var XS={},Rp,KS;function AE(){if(KS)return Rp;KS=1;var i=Ot(),e=ut(),t=qm();return Rp=function(n,r){var s=(e.Object||{})[n]||Object[n],a={};a[n]=r(s),i(i.S+i.F*t(function(){s(1)}),"Object",a)},Rp}var YS;function xA(){if(YS)return XS;YS=1;var i=Jm(),e=ME();return AE()("keys",function(){return function(t){return e(i(t))}}),XS}var ZS,QS;function kA(){return QS||(QS=1,xA(),ZS=ut().Object.keys),ZS}var eb,tb;function EA(){return tb||(tb=1,eb={default:kA(),__esModule:!0}),eb}var LA=EA();const Qt=Qe(LA);var xd={},Mp,ib;function Ju(){if(ib)return Mp;ib=1;var i=Ym(),e=Vr()("toStringTag"),t=i((function(){return arguments})())=="Arguments",n=function(r,s){try{return r[s]}catch{}};return Mp=function(r){var s,a,l;return r===void 0?"Undefined":r===null?"Null":typeof(a=n(s=Object(r),e))=="string"?a:t?i(s):(l=i(s))=="Object"&&typeof s.callee=="function"?"Arguments":l},Mp}var Ap,nb;function TA(){if(nb)return Ap;nb=1;var i=Ju(),e=Vr()("iterator"),t=Km();return Ap=ut().isIterable=function(n){var r=Object(n);return r[e]!==void 0||"@@iterator"in r||t.hasOwnProperty(i(r))},Ap}var rb,sb;function DA(){return sb||(sb=1,ra(),Io(),rb=TA()),rb}var ab,ob;function PA(){return ob||(ob=1,ab={default:DA(),__esModule:!0}),ab}var Np,lb;function Zm(){if(lb)return Np;lb=1;var i=Ju(),e=Vr()("iterator"),t=Km();return Np=ut().getIteratorMethod=function(n){if(n!=null)return n[e]||n["@@iterator"]||t[i(n)]},Np}var Vp,cb;function IA(){if(cb)return Vp;cb=1;var i=Ro(),e=Zm();return Vp=ut().getIterator=function(t){var n=e(t);if(typeof n!="function")throw TypeError(t+" is not iterable!");return i(n.call(t))},Vp}var db,ub;function RA(){return ub||(ub=1,ra(),Io(),db=IA()),db}var hb,pb;function NE(){return pb||(pb=1,hb={default:RA(),__esModule:!0}),hb}var fb;function MA(){if(fb)return xd;fb=1,xd.__esModule=!0;var i=PA(),e=r(i),t=NE(),n=r(t);function r(s){return s&&s.__esModule?s:{default:s}}return xd.default=(function(){function s(a,l){var d=[],u=!0,h=!1,g=void 0;try{for(var v=(0,n.default)(a),y;!(u=(y=v.next()).done)&&(d.push(y.value),!(l&&d.length===l));u=!0);}catch(C){h=!0,g=C}finally{try{!u&&v.return&&v.return()}finally{if(h)throw g}}return d}return function(a,l){if(Array.isArray(a))return a;if((0,e.default)(Object(a)))return s(a,l);throw new TypeError("Invalid attempt to destructure non-iterable instance")}})(),xd}var AA=MA();const ae=Qe(AA);var Op,gb;function Xu(){if(gb)return Op;gb=1;var i=IE();return Op=function(e,t,n){for(var r in t)n&&e[r]?e[r]=t[r]:i(e,r,t[r]);return e},Op}var mb,vb;function Ku(){return vb||(vb=1,mb=function(i,e,t,n){if(!(i instanceof e)||n!==void 0&&n in i)throw TypeError(t+": incorrect invocation!");return i}),mb}var Bp={exports:{}},_p,yb;function VE(){if(yb)return _p;yb=1;var i=Ro();return _p=function(e,t,n,r){try{return r?t(i(n)[0],n[1]):t(n)}catch(a){var s=e.return;throw s!==void 0&&i(s.call(e)),a}},_p}var Fp,Sb;function OE(){if(Sb)return Fp;Sb=1;var i=Km(),e=Vr()("iterator"),t=Array.prototype;return Fp=function(n){return n!==void 0&&(i.Array===n||t[e]===n)},Fp}var bb;function Mo(){if(bb)return Bp.exports;bb=1;var i=sa(),e=VE(),t=OE(),n=Ro(),r=qu(),s=Zm(),a={},l={},d=Bp.exports=function(u,h,g,v,y){var C=y?function(){return u}:s(u),w=i(g,v,h?2:1),b=0,k,L,I,P;if(typeof C!="function")throw TypeError(u+" is not iterable!");if(t(C)){for(k=r(u.length);k>b;b++)if(P=h?w(n(L=u[b])[0],L[1]):w(u[b]),P===a||P===l)return P}else for(I=C.call(u);!(L=I.next()).done;)if(P=e(I,w,L.value,h),P===a||P===l)return P};return d.BREAK=a,d.RETURN=l,Bp.exports}var Up,wb;function BE(){if(wb)return Up;wb=1;var i=Nr(),e=ut(),t=Gu(),n=Wu(),r=Vr()("species");return Up=function(s){var a=typeof e[s]=="function"?e[s]:i[s];n&&a&&!a[r]&&t.f(a,r,{configurable:!0,get:function(){return this}})},Up}var zp,Cb;function Ys(){if(Cb)return zp;Cb=1;var i=Cs();return zp=function(e,t){if(!i(e)||e._t!==t)throw TypeError("Incompatible receiver, "+t+" required!");return e},zp}var $p,xb;function _E(){if(xb)return $p;xb=1;var i=Gu().f,e=sA(),t=Xu(),n=sa(),r=Ku(),s=Mo(),a=aA(),l=oA(),d=BE(),u=Wu(),h=Hu().fastKey,g=Ys(),v=u?"_s":"size",y=function(C,w){var b=h(w),k;if(b!=="F")return C._i[b];for(k=C._f;k;k=k.n)if(k.k==w)return k};return $p={getConstructor:function(C,w,b,k){var L=C(function(I,P){r(I,L,w,"_i"),I._t=w,I._i=e(null),I._f=void 0,I._l=void 0,I[v]=0,P!=null&&s(P,b,I[k],I)});return t(L.prototype,{clear:function(){for(var I=g(this,w),P=I._i,T=I._f;T;T=T.n)T.r=!0,T.p&&(T.p=T.p.n=void 0),delete P[T.i];I._f=I._l=void 0,I[v]=0},delete:function(I){var P=g(this,w),T=y(P,I);if(T){var R=T.n,M=T.p;delete P._i[T.i],T.r=!0,M&&(M.n=R),R&&(R.p=M),P._f==T&&(P._f=R),P._l==T&&(P._l=M),P[v]--}return!!T},forEach:function(I){g(this,w);for(var P=n(I,arguments.length>1?arguments[1]:void 0,3),T;T=T?T.n:this._f;)for(P(T.v,T.k,this);T&&T.r;)T=T.p},has:function(I){return!!y(g(this,w),I)}}),u&&i(L.prototype,"size",{get:function(){return g(this,w)[v]}}),L},def:function(C,w,b){var k=y(C,w),L,I;return k?k.v=b:(C._l=k={i:I=h(w,!0),k:w,v:b,p:L=C._l,n:void 0,r:!1},C._f||(C._f=k),L&&(L.n=k),C[v]++,I!=="F"&&(C._i[I]=k)),C},getEntry:y,setStrong:function(C,w,b){a(C,w,function(k,L){this._t=g(k,w),this._k=L,this._l=void 0},function(){for(var k=this,L=k._k,I=k._l;I&&I.r;)I=I.p;return!k._t||!(k._l=I=I?I.n:k._t._f)?(k._t=void 0,l(1)):L=="keys"?l(0,I.k):L=="values"?l(0,I.v):l(0,[I.k,I.v])},b?"entries":"values",!b,!0),d(w)}},$p}var Gp,kb;function NA(){if(kb)return Gp;kb=1;var i=Cs(),e=gA(),t=Vr()("species");return Gp=function(n){var r;return e(n)&&(r=n.constructor,typeof r=="function"&&(r===Array||e(r.prototype))&&(r=void 0),i(r)&&(r=r[t],r===null&&(r=void 0))),r===void 0?Array:r},Gp}var Wp,Eb;function VA(){if(Eb)return Wp;Eb=1;var i=NA();return Wp=function(e,t){return new(i(e))(t)},Wp}var Hp,Lb;function Qm(){if(Lb)return Hp;Lb=1;var i=sa(),e=dA(),t=Jm(),n=qu(),r=VA();return Hp=function(s,a){var l=s==1,d=s==2,u=s==3,h=s==4,g=s==6,v=s==5||g,y=a||r;return function(C,w,b){for(var k=t(C),L=e(k),I=i(w,b,3),P=n(L.length),T=0,R=l?y(C,P):d?y(C,0):void 0,M,V;P>T;T++)if((v||T in L)&&(M=L[T],V=I(M,T,k),s)){if(l)R[T]=V;else if(V)switch(s){case 3:return!0;case 5:return M;case 6:return T;case 2:R.push(M)}else if(h)return!1}return g?-1:u||h?h:R}},Hp}var jp,Tb;function Yu(){if(Tb)return jp;Tb=1;var i=Nr(),e=Ot(),t=Hu(),n=qm(),r=IE(),s=Xu(),a=Mo(),l=Ku(),d=Cs(),u=RE(),h=Gu().f,g=Qm()(0),v=Wu();return jp=function(y,C,w,b,k,L){var I=i[y],P=I,T=k?"set":"add",R=P&&P.prototype,M={};return!v||typeof P!="function"||!(L||R.forEach&&!n(function(){new P().entries().next()}))?(P=b.getConstructor(C,y,k,T),s(P.prototype,w),t.NEED=!0):(P=C(function(V,B){l(V,P,y,"_c"),V._c=new I,B!=null&&a(B,k,V[T],V)}),g("add,clear,delete,forEach,get,has,set,keys,values,entries,toJSON".split(","),function(V){var B=V=="add"||V=="set";V in R&&!(L&&V=="clear")&&r(P.prototype,V,function(F,j){if(l(this,P,V),!B&&L&&!d(F))return V=="get"?void 0:!1;var U=this._c[V](F===0?0:F,j);return B?this:U})}),L||h(P.prototype,"size",{get:function(){return this._c.size}})),u(P,y),M[y]=P,e(e.G+e.W+e.F,M),L||b.setStrong(P,y,k),P},jp}var qp,Db;function OA(){if(Db)return qp;Db=1;var i=_E(),e=Ys(),t="Map";return qp=Yu()(t,function(n){return function(){return n(this,arguments.length>0?arguments[0]:void 0)}},{get:function(n){var r=i.getEntry(e(this,t),n);return r&&r.v},set:function(n,r){return i.def(e(this,t),n===0?0:n,r)}},i,!0),qp}var Pb={},Jp,Ib;function BA(){if(Ib)return Jp;Ib=1;var i=Mo();return Jp=function(e,t){var n=[];return i(e,!1,n.push,n,t),n},Jp}var Xp,Rb;function FE(){if(Rb)return Xp;Rb=1;var i=Ju(),e=BA();return Xp=function(t){return function(){if(i(this)!=t)throw TypeError(t+"#toJSON isn't generic");return e(this)}},Xp}var Mb;function _A(){if(Mb)return Pb;Mb=1;var i=Ot();return i(i.P+i.R,"Map",{toJSON:FE()("Map")}),Pb}var FA={},Kp,Ab;function Zu(){if(Ab)return Kp;Ab=1;var i=Ot();return Kp=function(e){i(i.S,e,{of:function(){for(var t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return new this(n)}})},Kp}var Nb;function UA(){return Nb||(Nb=1,Zu()("Map")),FA}var zA={},Yp,Vb;function Qu(){if(Vb)return Yp;Vb=1;var i=Ot(),e=ju(),t=sa(),n=Mo();return Yp=function(r){i(i.S,r,{from:function(s){var a=arguments[1],l,d,u,h;return e(this),l=a!==void 0,l&&e(a),s==null?new this:(d=[],l?(u=0,h=t(a,arguments[2],2),n(s,!1,function(g){d.push(h(g,u++))})):n(s,!1,d.push,d),new this(d))}})},Yp}var Ob;function $A(){return Ob||(Ob=1,Qu()("Map")),zA}var Bb,_b;function GA(){return _b||(_b=1,Io(),ra(),OA(),_A(),UA(),$A(),Bb=ut().Map),Bb}var Fb,Ub;function WA(){return Ub||(Ub=1,Fb={default:GA(),__esModule:!0}),Fb}var HA=WA();const ce=Qe(HA);var jA=eA();const Mi=Qe(jA);var zb={},Zp,$b;function qA(){if($b)return Zp;$b=1;var i=Gu(),e=uA();return Zp=function(t,n,r){n in t?i.f(t,n,e(0,r)):t[n]=r},Zp}var Qp,Gb;function UE(){if(Gb)return Qp;Gb=1;var i=Vr()("iterator"),e=!1;try{var t=[7][i]();t.return=function(){e=!0},Array.from(t,function(){throw 2})}catch{}return Qp=function(n,r){if(!r&&!e)return!1;var s=!1;try{var a=[7],l=a[i]();l.next=function(){return{done:s=!0}},a[i]=function(){return l},n(a)}catch{}return s},Qp}var Wb;function JA(){if(Wb)return zb;Wb=1;var i=sa(),e=Ot(),t=Jm(),n=VE(),r=OE(),s=qu(),a=qA(),l=Zm();return e(e.S+e.F*!UE()(function(d){Array.from(d)}),"Array",{from:function(d){var u=t(d),h=typeof this=="function"?this:Array,g=arguments.length,v=g>1?arguments[1]:void 0,y=v!==void 0,C=0,w=l(u),b,k,L,I;if(y&&(v=i(v,g>2?arguments[2]:void 0,2)),w!=null&&!(h==Array&&r(w)))for(I=w.call(u),k=new h;!(L=I.next()).done;C++)a(k,C,y?n(I,v,[L.value,C],!0):L.value);else for(b=s(u.length),k=new h(b);b>C;C++)a(k,C,y?v(u[C],C):u[C]);return k.length=C,k}}),zb}var Hb,jb;function XA(){return jb||(jb=1,Io(),JA(),Hb=ut().Array.from),Hb}var qb,Jb;function zE(){return Jb||(Jb=1,qb={default:XA(),__esModule:!0}),qb}var KA=zE();const Ee=Qe(KA);var ef,Xb;function YA(){if(Xb)return ef;Xb=1;var i=_E(),e=Ys(),t="Set";return ef=Yu()(t,function(n){return function(){return n(this,arguments.length>0?arguments[0]:void 0)}},{add:function(n){return i.def(e(this,t),n=n===0?0:n,n)}},i),ef}var Kb={},Yb;function ZA(){if(Yb)return Kb;Yb=1;var i=Ot();return i(i.P+i.R,"Set",{toJSON:FE()("Set")}),Kb}var QA={},Zb;function eN(){return Zb||(Zb=1,Zu()("Set")),QA}var tN={},Qb;function iN(){return Qb||(Qb=1,Qu()("Set")),tN}var ew,tw;function nN(){return tw||(tw=1,Io(),ra(),YA(),ZA(),eN(),iN(),ew=ut().Set),ew}var iw,nw;function rN(){return nw||(nw=1,iw={default:nN(),__esModule:!0}),iw}var sN=rN();const $e=Qe(sN);var tf,rw;function aN(){if(rw)return tf;rw=1;var i=ut(),e=i.JSON||(i.JSON={stringify:JSON.stringify});return tf=function(t){return e.stringify.apply(e,arguments)},tf}var sw,aw;function oN(){return aw||(aw=1,sw={default:aN(),__esModule:!0}),sw}var lN=oN();const re=Qe(lN);/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function $E(i,e){let t=i.length,n=0;for(let r=0;r<t;++r)e(i[r],r,i)&&(i[n]=i[r],++n);i.length=n}function cN(i,e){if(i.length===e)return i;let t=new i.constructor(e);return t.set(i),t}function og(i,e,t,n){const r=i.length/e,s=i.length*t*n,a=new i.constructor(s),l=i.length*n,d=e,u=e*n;for(let h=0;h<r;++h)for(let g=0;g<e;++g){const v=i[h*e+g],y=h*u+g;for(let C=0;C<t;++C)for(let w=0;w<n;++w)a[C*l+w*d+y]=v}return a}function dN(i,e,t,n=0,r=i.length){for(;n<r;){const s=n+r-1>>1,a=t(e,i[s]);if(a>0)n=s+1;else if(a<0)r=s;else return s}return~n}function uN(i,e,t){let n=e-i;for(;n>0;){let r=Math.floor(n/2),s=i+r;t(s)?n=r:(i=s+1,n-=r+1)}return i}function hN(i,e){const t=[];for(let n=0,r=i.length;n<r;++n)i[n]===e&&t.push(n);return t}function Oe(i,e){const t=i.length;if(e.length!==t)return!1;for(let n=0;n<t;++n)if(i[n]!==e[n])return!1;return!0}function lg(i,e,t=(n,r)=>n===r){const n=i.length;if(e.length!==n)return!1;for(let r=0;r<n;++r)if(!t(i[r],e[r]))return!1;return!0}function pN(i,e,t){const n=[];if(t===e){for(let r=0;r<i;++r)n[r]=r;return n}n[t]=e;for(let r=0,s=0;r<i;){if(r===e){++r;continue}s===t&&++s,n[s++]=r++}return n}function ow(i,e,t){for(let n=0,r=t.length;n<r;++n){const s=t[n];s!==-1&&(i[n]=e[s])}return i}function dc(i){const e=[];for(let t=0,n=i.length;t<n;++t){const r=i[t];for(let s=0,a=r.length;s<a;++s){let l=e[s];l===void 0&&(l=e[s]=[]),l.push(r[s])}}return e}function fN(i,e){const t=[];let n=0;for(let a=0,l=e.length;a<l;++a){var r=e[a];const d=r.retainCount,u=r.deleteCount,h=r.insertCount;d!==0&&(t.push(i.slice(n,n+d)),n+=d),n+=u,h!==0&&t.push(new Array(h))}const s=i.length;return n!==s&&t.push(i.slice(n)),new Array(0).concat(...t)}function gN(i,e,t){const n=[];let r=0,s=0,a=i.length,l=e.length;for(;r<a&&s<l;){let d,u=i[r],h=e[s];if(d=t(u,h),d===0){let g=1;for(++r,++s;r<a&&s<l&&(d=t(i[r],e[s]))===0;)++g,++r,++s;n.push({retainCount:g,deleteCount:0,insertCount:0});continue}if(d<0){let g=1;for(;++r<a&&(d=t(i[r],h))<0;)++g;n.push({retainCount:0,deleteCount:g,insertCount:0});continue}if(d>0){let g=1;for(;++s<l&&(d=t(u,e[s]))>0;)++g;n.push({retainCount:0,deleteCount:0,insertCount:g});continue}}return(r<a||s<l)&&n.push({retainCount:0,deleteCount:a-r,insertCount:l-s}),n}function mN(i,e,t,n,r,s){let a=0,l=0;if(i!==0&&e!==0)for(;;){const d=t(a,l);if(d<0){if(n(a),++a===i)break}else if(d>0){if(r(l),++l===e)break}else if(s(a,l),++a,++l,a===i||l===e)break}for(;a<i;)n(a),++a;for(;l<e;)r(l),++l}var vN=NE();const ev=Qe(vN);var nf,lw;function yN(){if(lw)return nf;lw=1;var i=iA(),e=function(){return i.Date.now()};return nf=e,nf}var rf,cw;function SN(){if(cw)return rf;cw=1;var i=/\s/;function e(t){for(var n=t.length;n--&&i.test(t.charAt(n)););return n}return rf=e,rf}var sf,dw;function bN(){if(dw)return sf;dw=1;var i=SN(),e=/^\s+/;function t(n){return n&&n.slice(0,i(n)+1).replace(e,"")}return sf=t,sf}var af,uw;function wN(){if(uw)return af;uw=1;var i=nA(),e=rA(),t="[object Symbol]";function n(r){return typeof r=="symbol"||e(r)&&i(r)==t}return af=n,af}var of,hw;function CN(){if(hw)return of;hw=1;var i=bN(),e=jm(),t=wN(),n=NaN,r=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,a=/^0o[0-7]+$/i,l=parseInt;function d(u){if(typeof u=="number")return u;if(t(u))return n;if(e(u)){var h=typeof u.valueOf=="function"?u.valueOf():u;u=e(h)?h+"":h}if(typeof u!="string")return u===0?u:+u;u=i(u);var g=s.test(u);return g||a.test(u)?l(u.slice(2),g?2:8):r.test(u)?n:+u}return of=d,of}var lf,pw;function GE(){if(pw)return lf;pw=1;var i=jm(),e=yN(),t=CN(),n="Expected a function",r=Math.max,s=Math.min;function a(l,d,u){var h,g,v,y,C,w,b=0,k=!1,L=!1,I=!0;if(typeof l!="function")throw new TypeError(n);d=t(d)||0,i(u)&&(k=!!u.leading,L="maxWait"in u,v=L?r(t(u.maxWait)||0,d):v,I="trailing"in u?!!u.trailing:I);function P(O){var $=h,_=g;return h=g=void 0,b=O,y=l.apply(_,$),y}function T(O){return b=O,C=setTimeout(V,d),k?P(O):y}function R(O){var $=O-w,_=O-b,se=d-$;return L?s(se,v-_):se}function M(O){var $=O-w,_=O-b;return w===void 0||$>=d||$<0||L&&_>=v}function V(){var O=e();if(M(O))return B(O);C=setTimeout(V,R(O))}function B(O){return C=void 0,I&&h?P(O):(h=g=void 0,y)}function F(){C!==void 0&&clearTimeout(C),b=0,h=w=g=C=void 0}function j(){return C===void 0?y:B(e())}function U(){var O=e(),$=M(O);if(h=arguments,g=this,w=O,$){if(C===void 0)return T(w);if(L)return clearTimeout(C),C=setTimeout(V,d),P(w)}return C===void 0&&(C=setTimeout(V,d)),y}return U.cancel=F,U.flush=j,U}return lf=a,lf}var xN=GE();const nt=Qe(xN);/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function WE(i){typeof i=="object"?i.dispose():i()}function so(i){for(let e=i.length;e>0;--e)WE(i[e-1])}function Tn(i,e,t,n){return i.addEventListener(e,t,n),()=>i.removeEventListener(e,t,n)}class Y{constructor(){this.refCount=1}addRef(){return++this.refCount,this}dispose(){--this.refCount===0&&this.refCountReachedZero()}refCountReachedZero(){this.disposed();let e=this.disposers;e!==void 0&&(so(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let t=this.disposers;return t==null?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let t=this.disposers;if(t!=null){let n=t.indexOf(e);n!==-1&&t.splice(n,1)}return e}registerEventListener(e,t,n,r){this.registerDisposer(Tn(e,t,n,r))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}}class HE extends Y{constructor(e){super(),this.value=e}}function jE(i){return()=>{if(i!==void 0){let e=i;i=void 0,WE(e)}}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class Ze{constructor(){this.handlers=new $e,this.count=0;const e=this;this.dispatch=function(){++e.count,e.handlers.forEach(t=>{t.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}remove(e){return this.handlers.delete(e)}dispose(){this.handlers=void 0}}class be extends Ze{}const qE={count:0,add(i){return()=>{}},remove(i){return!1}};class ct{constructor(e){this.value_=e,this.changed=new be}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}}class Jt extends ct{constructor(e,t,n=e){super(e),this.validator=t,this.defaultValue=n}toJSON(){if(this.value_!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(e!==void 0){let t=this.validator;try{this.value=t(e);return}catch{}}this.value=this.defaultValue}}class JE extends Y{constructor(e,t){super(),this.changed=new be,this.f=e,this.ws=t;for(const n of t)this.registerDisposer(n.changed.add(this.changed.dispatch))}get value(){return this.f(...this.ws.map(e=>e.value))}}function fw(i,...e){return new JE(i,e)}class kN extends Y{constructor(e,t){super(),this.changed=new be,this.valueGeneration=-1,this.f=e,this.ws=t;for(const n of t)this.registerDisposer(n.changed.add(this.changed.dispatch))}get value(){const e=this.changed.count;return e!==this.valueGeneration&&(this.value_=this.f(...this.ws.map(t=>t.value)),this.valueGeneration=e),this.value_}}function jn(i,...e){return new kN(i,e)}class XE extends Y{constructor(e,t=(n,r)=>n===r){super(),this.changed=new Ze,this.value=e.value,this.registerDisposer(e.changed.add(()=>{const n=e.value;t(this.value,n)||(this.value=n,this.changed.dispatch())}))}}function cn(i,e,t){const n=new JE(i,e),r=new XE(n,t);return r.registerDisposer(n),r}class KE extends Y{constructor(e){super(),this.changed=new be;const t=e(this),n=Qt(t),r=()=>{const s=Array.isArray(t)?[]:{};for(const a of n)s[a]=t[a].value;this.value=s,this.changed.dispatch()};r();for(const s of n){const a=t[s];this.registerDisposer(a.changed.add(()=>r()))}}}class EN{constructor(e){this.changed=new be,e===void 0?this.values=new $e:this.values=new $e(e)}add(e){const t=this.values;return t.has(e)||(t.add(e),this.changed.dispatch()),this}delete(e){return this.values.delete(e)?(this.changed.dispatch(),!0):!1}has(e){return this.values.has(e)}get size(){return this.values.size}[Mi](){return ev(this.values)}clear(){const e=this.values;e.size>0&&(e.clear(),this.changed.dispatch())}}function Pr(i,...e){let t=e.map(d=>d.value);const n=e.length;let r=new Y,s=i(r,...t);const a=nt(()=>{let d=!1;for(let u=0;u<n;++u){const h=e[u].value;t[u]!==h&&(t[u]=h,d=!0)}d&&(r.dispose(),r=new Y,s=i(r,...t))},0),l=e.map(d=>d.changed.add(a));return{flush(){a.flush()},dispose(){a.cancel(),so(l),r.dispose()},get value(){return a.flush(),s}}}function ao(i,...e){let t=e.map(d=>d.value);const n=e.length;let r=new Y,s=i(r,...t);const a=()=>{let d=!1;for(let u=0;u<n;++u){const h=e[u].value;t[u]!==h&&(t[u]=h,d=!0)}d&&(r.dispose(),r=new Y,s=i(r,...t))},l=e.map(d=>d.changed.add(a));return{dispose(){so(l),r.dispose()},get value(){return s}}}function Zs(i){return{changed:qE,value:i}}function Lr(i,e){return i(e.value),e.changed.add(()=>i(e.value))}class zd{constructor(e,t){this.outer=e,this.getInner=t,this.changed=new be,this.update=()=>{const n=this.disposer,r=this.outer;n!==void 0&&n();const s=this.inner=this.getInner(r.value);this.disposer=s.changed.add(this.changed.dispatch),this.changed.dispatch()},e.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(e){this.inner.value=e}}class cf extends zd{reset(){this.inner.reset()}restoreState(e){this.inner.restoreState(e)}toJSON(){return this.inner.toJSON()}}/**
* @license
* Copyright 2018 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const kd=new Float32Array(1);function LN(i){kd[0]=i,i=kd[0];for(let e=1;e<21;++e){let t=i.toPrecision(e);if(kd[0]=parseFloat(t),kd[0]===i)return t}return i.toString()}var $d=1e-6,mi=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var i=0,e=arguments.length;e--;)i+=arguments[e]*arguments[e];return Math.sqrt(i)});function uc(){var i=new mi(9);return mi!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[5]=0,i[6]=0,i[7]=0),i[0]=1,i[4]=1,i[8]=1,i}function TN(i,e){if(i===e){var t=e[1],n=e[2],r=e[5];i[1]=e[3],i[2]=e[6],i[3]=t,i[5]=e[7],i[6]=n,i[7]=r}else i[0]=e[0],i[1]=e[3],i[2]=e[6],i[3]=e[1],i[4]=e[4],i[5]=e[7],i[6]=e[2],i[7]=e[5],i[8]=e[8];return i}function DN(i,e){var t=e[0],n=e[1],r=e[2],s=e[3],a=e[4],l=e[5],d=e[6],u=e[7],h=e[8],g=h*a-l*u,v=-h*s+l*d,y=u*s-a*d,C=t*g+n*v+r*y;return C?(C=1/C,i[0]=g*C,i[1]=(-h*n+r*u)*C,i[2]=(l*n-r*a)*C,i[3]=v*C,i[4]=(h*t-r*d)*C,i[5]=(-l*t+r*s)*C,i[6]=y*C,i[7]=(-u*t+n*d)*C,i[8]=(a*t-n*s)*C,i):null}function tv(i){var e=i[0],t=i[1],n=i[2],r=i[3],s=i[4],a=i[5],l=i[6],d=i[7],u=i[8];return e*(u*s-a*d)+t*(-u*r+a*l)+n*(d*r-s*l)}function YE(i,e){var t=e[0],n=e[1],r=e[2],s=e[3],a=t+t,l=n+n,d=r+r,u=t*a,h=n*a,g=n*l,v=r*a,y=r*l,C=r*d,w=s*a,b=s*l,k=s*d;return i[0]=1-g-C,i[3]=h-k,i[6]=v+b,i[1]=h+k,i[4]=1-u-C,i[7]=y-w,i[2]=v-b,i[5]=y+w,i[8]=1-u-g,i}function Je(){var i=new mi(16);return mi!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i}function PN(i){var e=new mi(16);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],e}function Qd(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function ZE(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function iv(i,e){if(i===e){var t=e[1],n=e[2],r=e[3],s=e[6],a=e[7],l=e[11];i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=t,i[6]=e[9],i[7]=e[13],i[8]=n,i[9]=s,i[11]=e[14],i[12]=r,i[13]=a,i[14]=l}else i[0]=e[0],i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=e[1],i[5]=e[5],i[6]=e[9],i[7]=e[13],i[8]=e[2],i[9]=e[6],i[10]=e[10],i[11]=e[14],i[12]=e[3],i[13]=e[7],i[14]=e[11],i[15]=e[15];return i}function fs(i,e){var t=e[0],n=e[1],r=e[2],s=e[3],a=e[4],l=e[5],d=e[6],u=e[7],h=e[8],g=e[9],v=e[10],y=e[11],C=e[12],w=e[13],b=e[14],k=e[15],L=t*l-n*a,I=t*d-r*a,P=t*u-s*a,T=n*d-r*l,R=n*u-s*l,M=r*u-s*d,V=h*w-g*C,B=h*b-v*C,F=h*k-y*C,j=g*b-v*w,U=g*k-y*w,O=v*k-y*b,$=L*O-I*U+P*j+T*F-R*B+M*V;return $?($=1/$,i[0]=(l*O-d*U+u*j)*$,i[1]=(r*U-n*O-s*j)*$,i[2]=(w*M-b*R+k*T)*$,i[3]=(v*R-g*M-y*T)*$,i[4]=(d*F-a*O-u*B)*$,i[5]=(t*O-r*F+s*B)*$,i[6]=(b*P-C*M-k*I)*$,i[7]=(h*M-v*P+y*I)*$,i[8]=(a*U-l*F+u*V)*$,i[9]=(n*F-t*U-s*V)*$,i[10]=(C*R-w*P+k*L)*$,i[11]=(g*P-h*R-y*L)*$,i[12]=(l*B-a*j-d*V)*$,i[13]=(t*j-n*B+r*V)*$,i[14]=(w*I-C*T-b*L)*$,i[15]=(h*T-g*I+v*L)*$,i):null}function ei(i,e,t){var n=e[0],r=e[1],s=e[2],a=e[3],l=e[4],d=e[5],u=e[6],h=e[7],g=e[8],v=e[9],y=e[10],C=e[11],w=e[12],b=e[13],k=e[14],L=e[15],I=t[0],P=t[1],T=t[2],R=t[3];return i[0]=I*n+P*l+T*g+R*w,i[1]=I*r+P*d+T*v+R*b,i[2]=I*s+P*u+T*y+R*k,i[3]=I*a+P*h+T*C+R*L,I=t[4],P=t[5],T=t[6],R=t[7],i[4]=I*n+P*l+T*g+R*w,i[5]=I*r+P*d+T*v+R*b,i[6]=I*s+P*u+T*y+R*k,i[7]=I*a+P*h+T*C+R*L,I=t[8],P=t[9],T=t[10],R=t[11],i[8]=I*n+P*l+T*g+R*w,i[9]=I*r+P*d+T*v+R*b,i[10]=I*s+P*u+T*y+R*k,i[11]=I*a+P*h+T*C+R*L,I=t[12],P=t[13],T=t[14],R=t[15],i[12]=I*n+P*l+T*g+R*w,i[13]=I*r+P*d+T*v+R*b,i[14]=I*s+P*u+T*y+R*k,i[15]=I*a+P*h+T*C+R*L,i}function IN(i,e,t){var n=t[0],r=t[1],s=t[2],a,l,d,u,h,g,v,y,C,w,b,k;return e===i?(i[12]=e[0]*n+e[4]*r+e[8]*s+e[12],i[13]=e[1]*n+e[5]*r+e[9]*s+e[13],i[14]=e[2]*n+e[6]*r+e[10]*s+e[14],i[15]=e[3]*n+e[7]*r+e[11]*s+e[15]):(a=e[0],l=e[1],d=e[2],u=e[3],h=e[4],g=e[5],v=e[6],y=e[7],C=e[8],w=e[9],b=e[10],k=e[11],i[0]=a,i[1]=l,i[2]=d,i[3]=u,i[4]=h,i[5]=g,i[6]=v,i[7]=y,i[8]=C,i[9]=w,i[10]=b,i[11]=k,i[12]=a*n+h*r+C*s+e[12],i[13]=l*n+g*r+w*s+e[13],i[14]=d*n+v*r+b*s+e[14],i[15]=u*n+y*r+k*s+e[15]),i}function RN(i,e,t){var n=t[0],r=t[1],s=t[2];return i[0]=e[0]*n,i[1]=e[1]*n,i[2]=e[2]*n,i[3]=e[3]*n,i[4]=e[4]*r,i[5]=e[5]*r,i[6]=e[6]*r,i[7]=e[7]*r,i[8]=e[8]*s,i[9]=e[9]*s,i[10]=e[10]*s,i[11]=e[11]*s,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function MN(i,e,t,n){var r=e[0],s=e[1],a=e[2],l=e[3],d=r+r,u=s+s,h=a+a,g=r*d,v=r*u,y=r*h,C=s*u,w=s*h,b=a*h,k=l*d,L=l*u,I=l*h,P=n[0],T=n[1],R=n[2];return i[0]=(1-(C+b))*P,i[1]=(v+I)*P,i[2]=(y-L)*P,i[3]=0,i[4]=(v-I)*T,i[5]=(1-(g+b))*T,i[6]=(w+k)*T,i[7]=0,i[8]=(y+L)*R,i[9]=(w-k)*R,i[10]=(1-(g+C))*R,i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}function AN(i,e){var t=e[0],n=e[1],r=e[2],s=e[3],a=t+t,l=n+n,d=r+r,u=t*a,h=n*a,g=n*l,v=r*a,y=r*l,C=r*d,w=s*a,b=s*l,k=s*d;return i[0]=1-g-C,i[1]=h+k,i[2]=v-b,i[3]=0,i[4]=h-k,i[5]=1-u-C,i[6]=y+w,i[7]=0,i[8]=v+b,i[9]=y-w,i[10]=1-u-g,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function NN(i,e,t,n,r){var s=1/Math.tan(e/2),a;return i[0]=s/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=s,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,r!=null&&r!==1/0?(a=1/(n-r),i[10]=(r+n)*a,i[14]=2*r*n*a):(i[10]=-1,i[14]=-2*n),i}function QE(i,e,t,n,r,s,a){var l=1/(e-t),d=1/(n-r),u=1/(s-a);return i[0]=-2*l,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*d,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*u,i[11]=0,i[12]=(e+t)*l,i[13]=(r+n)*d,i[14]=(a+s)*u,i[15]=1,i}function Ne(){var i=new mi(3);return mi!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function cg(i){var e=new mi(3);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e}function VN(i){var e=i[0],t=i[1],n=i[2];return Math.hypot(e,t,n)}function lt(i,e,t){var n=new mi(3);return n[0]=i,n[1]=e,n[2]=t,n}function ON(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i}function dg(i,e,t,n){return i[0]=e,i[1]=t,i[2]=n,i}function eL(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i}function tL(i,e,t){return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i}function iL(i,e,t){return i[0]=e[0]*t[0],i[1]=e[1]*t[1],i[2]=e[2]*t[2],i}function ug(i,e,t){return i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i}function gw(i,e){return i[0]=Math.ceil(e[0]),i[1]=Math.ceil(e[1]),i[2]=Math.ceil(e[2]),i}function nv(i,e,t){return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i}function eu(i,e){var t=e[0],n=e[1],r=e[2],s=t*t+n*n+r*r;return s>0&&(s=1/Math.sqrt(s)),i[0]=e[0]*s,i[1]=e[1]*s,i[2]=e[2]*s,i}function rv(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]}function df(i,e,t){var n=e[0],r=e[1],s=e[2],a=t[0],l=t[1],d=t[2];return i[0]=r*d-s*l,i[1]=s*a-n*d,i[2]=n*l-r*a,i}function an(i,e,t){var n=e[0],r=e[1],s=e[2],a=t[3]*n+t[7]*r+t[11]*s+t[15];return a=a||1,i[0]=(t[0]*n+t[4]*r+t[8]*s+t[12])/a,i[1]=(t[1]*n+t[5]*r+t[9]*s+t[13])/a,i[2]=(t[2]*n+t[6]*r+t[10]*s+t[14])/a,i}function Qa(i,e,t){var n=t[0],r=t[1],s=t[2],a=t[3],l=e[0],d=e[1],u=e[2],h=r*u-s*d,g=s*l-n*u,v=n*d-r*l,y=r*v-s*g,C=s*h-n*v,w=n*g-r*h,b=a*2;return h*=b,g*=b,v*=b,y*=2,C*=2,w*=2,i[0]=l+h+y,i[1]=d+g+C,i[2]=u+v+w,i}function hg(i,e){var t=i[0],n=i[1],r=i[2],s=e[0],a=e[1],l=e[2];return Math.abs(t-s)<=$d*Math.max(1,Math.abs(t),Math.abs(s))&&Math.abs(n-a)<=$d*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(r-l)<=$d*Math.max(1,Math.abs(r),Math.abs(l))}var BN=tL,_N=VN;(function(){var i=Ne();return function(e,t,n,r,s,a){var l,d;for(t||(t=3),n||(n=0),r?d=Math.min(r*t+n,e.length):d=e.length,l=n;l<d;l+=t)i[0]=e[l],i[1]=e[l+1],i[2]=e[l+2],s(i,i,a),e[l]=i[0],e[l+1]=i[1],e[l+2]=i[2];return e}})();function eh(){var i=new mi(4);return mi!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0,i[3]=0),i}function hc(i,e,t,n){var r=new mi(4);return r[0]=i,r[1]=e,r[2]=t,r[3]=n,r}function FN(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i}function UN(i,e){var t=e[0],n=e[1],r=e[2],s=e[3],a=t*t+n*n+r*r+s*s;return a>0&&(a=1/Math.sqrt(a)),i[0]=t*a,i[1]=n*a,i[2]=r*a,i[3]=s*a,i}(function(){var i=eh();return function(e,t,n,r,s,a){var l,d;for(t||(t=4),n||(n=0),r?d=Math.min(r*t+n,e.length):d=e.length,l=n;l<d;l+=t)i[0]=e[l],i[1]=e[l+1],i[2]=e[l+2],i[3]=e[l+3],s(i,i,a),e[l]=i[0],e[l+1]=i[1],e[l+2]=i[2],e[l+3]=i[3];return e}})();function Pi(){var i=new mi(4);return mi!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i[3]=1,i}function mw(i){return i[0]=0,i[1]=0,i[2]=0,i[3]=1,i}function pg(i,e,t){t=t*.5;var n=Math.sin(t);return i[0]=n*e[0],i[1]=n*e[1],i[2]=n*e[2],i[3]=Math.cos(t),i}function ds(i,e,t){var n=e[0],r=e[1],s=e[2],a=e[3],l=t[0],d=t[1],u=t[2],h=t[3];return i[0]=n*h+a*l+r*u-s*d,i[1]=r*h+a*d+s*l-n*u,i[2]=s*h+a*u+n*d-r*l,i[3]=a*h-n*l-r*d-s*u,i}function zN(i,e,t){t*=.5;var n=e[0],r=e[1],s=e[2],a=e[3],l=Math.sin(t),d=Math.cos(t);return i[0]=n*d+a*l,i[1]=r*d+s*l,i[2]=s*d-r*l,i[3]=a*d-n*l,i}function $N(i,e,t){t*=.5;var n=e[0],r=e[1],s=e[2],a=e[3],l=Math.sin(t),d=Math.cos(t);return i[0]=n*d-s*l,i[1]=r*d+a*l,i[2]=s*d+n*l,i[3]=a*d-r*l,i}function uf(i,e,t,n){var r=e[0],s=e[1],a=e[2],l=e[3],d=t[0],u=t[1],h=t[2],g=t[3],v,y,C,w,b;return y=r*d+s*u+a*h+l*g,y<0&&(y=-y,d=-d,u=-u,h=-h,g=-g),1-y>$d?(v=Math.acos(y),C=Math.sin(v),w=Math.sin((1-n)*v)/C,b=Math.sin(n*v)/C):(w=1-n,b=n),i[0]=w*r+b*d,i[1]=w*s+b*u,i[2]=w*a+b*h,i[3]=w*l+b*g,i}function tu(i,e){var t=e[0],n=e[1],r=e[2],s=e[3],a=t*t+n*n+r*r+s*s,l=a?1/a:0;return i[0]=-t*l,i[1]=-n*l,i[2]=-r*l,i[3]=s*l,i}function nL(i,e){var t=e[0]+e[4]+e[8],n;if(t>0)n=Math.sqrt(t+1),i[3]=.5*n,n=.5/n,i[0]=(e[5]-e[7])*n,i[1]=(e[6]-e[2])*n,i[2]=(e[1]-e[3])*n;else{var r=0;e[4]>e[0]&&(r=1),e[8]>e[r*3+r]&&(r=2);var s=(r+1)%3,a=(r+2)%3;n=Math.sqrt(e[r*3+r]-e[s*3+s]-e[a*3+a]+1),i[r]=.5*n,n=.5/n,i[3]=(e[s*3+a]-e[a*3+s])*n,i[s]=(e[s*3+r]+e[r*3+s])*n,i[a]=(e[a*3+r]+e[r*3+a])*n}return i}var GN=FN,jl=UN;(function(){var i=Ne(),e=lt(1,0,0),t=lt(0,1,0);return function(n,r,s){var a=rv(r,s);return a<-.999999?(df(i,e,r),_N(i)<1e-6&&df(i,t,r),eu(i,i),pg(n,i,Math.PI),n):a>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(df(i,r,s),n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=1+a,jl(n,n))}})();(function(){var i=Pi(),e=Pi();return function(t,n,r,s,a,l){return uf(i,n,a,l),uf(e,r,s,l),uf(t,i,e,2*l*(1-l)),t}})();(function(){var i=uc();return function(e,t,n,r){return i[0]=n[0],i[3]=n[1],i[6]=n[2],i[1]=r[0],i[4]=r[1],i[7]=r[2],i[2]=-t[0],i[5]=-t[1],i[8]=-t[2],jl(e,nL(e,i))}})();function rL(){var i=new mi(2);return mi!=Float32Array&&(i[0]=0,i[1]=0),i}function WN(i,e,t){return i[0]=e,i[1]=t,i}function HN(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i}(function(){var i=rL();return function(e,t,n,r,s,a){var l,d;for(t||(t=2),n||(n=0),r?d=Math.min(r*t+n,e.length):d=e.length,l=n;l<d;l+=t)i[0]=e[l],i[1]=e[l+1],s(i,i,a),e[l]=i[0],e[l+1]=i[1];return e}})();/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const sL=Je(),jN=["x","y","z"],zn=[lt(1,0,0),lt(0,1,0),lt(0,0,1)];lt(0,0,0);const fg=hc(0,0,0,0),aL=lt(1,1,1);lt(1/0,1/0,1/0);Pi();function gg(i){return i[0]*i[1]*i[2]}function mg(i){return`${i[0]},${i[1]},${i[2]}`}function qN(i,e,t){let n=e[0],r=e[1],s=e[2];return i[0]=t[0]*n+t[4]*r+t[8]*s,i[1]=t[1]*n+t[5]*r+t[9]*s,i[2]=t[2]*n+t[6]*r+t[10]*s,i}function oL(i,e,t){let n=e[0],r=e[1],s=e[2];return i[0]=t[0]*n+t[1]*r+t[2]*s,i[1]=t[4]*n+t[5]*r+t[6]*s,i[2]=t[8]*n+t[9]*r+t[10]*s,i}function JN(i,e,t){const n=t.length;let r=0;for(let a=0;a<n;++a)r+=(i[a]-e[a])**2;let s=0;for(let a=0;a<n;++a){const l=i[a];s-=(l-t[a])*(e[a]-l)}return s/Math.max(r,1e-6)}function lL(i,e,t,n){const r=i.length;let s=JN(e,t,n);s=Math.max(0,Math.min(1,s));for(let a=0;a<r;++a){const l=e[a];i[a]=l+s*(t[a]-l)}return i}function th(i,e){const t=e[0],n=e[1],r=e[2],s=e[4],a=e[5],l=e[6],d=e[8],u=e[9],h=e[10];return i[0]=t,i[1]=n,i[2]=r,i[3]=s,i[4]=a,i[5]=l,i[6]=d,i[7]=u,i[8]=h,i}function iu(i,e){const t=e[0],n=e[1],r=e[2],s=e[3],a=e[4],l=e[5],d=e[6],u=e[7],h=e[8],g=e[9],v=e[10],y=e[11],C=e[12],w=e[13],b=e[14],k=e[15];i[0]=s+t,i[1]=u+a,i[2]=y+h,i[3]=k+C,i[4]=s-t,i[5]=u-a,i[6]=y-h,i[7]=k-C,i[8]=s+n,i[9]=u+l,i[10]=y+g,i[11]=k+w,i[12]=s-n,i[13]=u-l,i[14]=y-g,i[15]=k-w;const L=s+r,I=u+d,P=y+v,T=k+b,R=s-r,M=u-d,V=y-v,B=k-b,F=Math.sqrt(L**2+I**2+P**2);i[16]=L/F,i[17]=I/F,i[18]=P/F,i[19]=T/F;const j=Math.sqrt(R**2+M**2+V**2);return i[20]=R/j,i[21]=M/j,i[22]=V/j,i[23]=B/j,i}function cL(i,e,t,n,r,s,a){for(let l=0;l<6;++l){const d=a[l*4],u=a[l*4+1],h=a[l*4+2],g=a[l*4+3];if(Math.max(d*i,d*n)+Math.max(u*e,u*r)+Math.max(h*t,h*s)+g<0)return!1}return!0}function XN(i,e,t,n,r,s,a){for(let l=0;l<4;++l){const d=a[l*4],u=a[l*4+1],h=a[l*4+2],g=a[l*4+3];if(Math.max(d*i,d*n)+Math.max(u*e,u*r)+Math.max(h*t,h*s)+g<0)return!1}{const l=a[20],d=a[21],u=a[22],h=a[23],g=Math.max(l*i,l*n)+Math.max(d*e,d*r)+Math.max(u*t,u*s),v=Math.min(l*i,l*n)+Math.min(d*e,d*r)+Math.min(u*t,u*s),y=Math.abs(h)*1e-6;if(v>-h+y||g<-h-y)return!1}return!0}function ih(i,e,t,n=!1){const r=t.length,s=[],a=n?1:e+1,l=n?e+1:1;for(let d=0;d<r;++d){const u=t[d];for(let h=0;h<e;++h)i[h*a+u*l]!==0&&(s[h]=!0)}return hN(s,!0)}function dL(i,e,t){for(let n=0;n<3;++n){const r=t[n];for(let s=0;s<3;++s)i[n+s*3]=r*e[n+s*3]}return i}function KN(i){if(i[15]===1){const r=2/Math.abs(i[10]),s=2/Math.abs(i[0]),a=2/Math.abs(i[5]);return s*a*r}const e=i[10],t=2*i[14]/(2*e-2),n=(e-1)*t/(e+1);return 4/(i[0]*i[5])/3*(Math.abs(n)**3-Math.abs(t)**3)}function uL(i){if(i[15]===1)return 2/Math.abs(i[10]);const e=i[10],t=2*i[14]/(2*e-2),n=(e-1)*t/(e+1);return Math.abs(n-t)}function YN(i){return i[2]=0,i[6]=0,i[10]=0,i[14]=0,i}const Ua=Ne();function ZN(i,e){e[0]=e[1]=e[2]=Number.POSITIVE_INFINITY,e[3]=e[4]=e[5]=Number.NEGATIVE_INFINITY;for(let t=0;t<8;++t){Ua[0]=2*(t&1)-1,Ua[1]=2*(t>>>1&1)-1,Ua[2]=2*(t>>>2&1)-1,an(Ua,Ua,i);for(let n=0;n<3;++n){const r=Ua[n];e[n]=Math.min(e[n],r),e[n+3]=Math.max(e[n+3],r)}}}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function hL(i){return("0"+i.toString(16)).slice(-2)}function QN(i){return Array.prototype.map.call(i,hL).join("")}function eV(i){if(!/^(?:[0-9a-fA-F]{2})*$/.test(i))throw new Error("Invalid hex-encoded string");const e=i.length/2,t=new Uint8Array(e);for(let n=0;n<e;++n)t[n]=parseInt(i.substr(n*2,2),16);return t}function tV(i){const e=/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/;{const n=i.match(e);if(n!==null)return[parseInt(n[1],10),parseInt(n[2],10),parseInt(n[3],10),parseFloat(n[4])]}const t=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/;{const n=i.match(t);if(n!==null)return[parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16),1]}throw new Error(`Invalid serialized color: ${re(i)}.`)}function pL(i){try{if(typeof i!="string")throw new Error(`Expected string, but received ${re(i)}.`);const e=document.createElement("canvas").getContext("2d");e.fillStyle=i;const t=tV(e.fillStyle);return hc(t[0]/255,t[1]/255,t[2]/255,t[3])}catch(e){throw new Error(`Failed to parse color specification: ${e.message}`)}}function Ao(i){return pL(i).subarray(0,3)}function vg(i){const e=i[3]===void 0?3:4;let t=0;for(let n=0;n<e;n++)t=(t<<8>>>0)+Math.min(255,Math.max(0,Math.round(i[e-1-n]*255)));return t}function eo(i){return lt((i>>>0&255)/255,(i>>>8&255)/255,(i>>>16&255)/255)}function sv(i){return hc((i>>>0&255)/255,(i>>>8&255)/255,(i>>>16&255)/255,(i>>>24&255)/255)}function Ii(i){if(i[3]===void 0||i[3]===1){let e="#";for(let t=0;t<3;++t)e+=hL(Math.min(255,Math.max(0,Math.round(i[t]*255))));return e}else{let e="rgba(";for(let t=0;t<3;++t)t!==0&&(e+=", "),e+=Math.min(255,Math.max(0,Math.round(i[t]*255)));return e+=`, ${LN(i[3])})`,e}}function hf(i){return i<=.03928?i/12.92:((i+.055)/1.055)**2.4}function iV(i){var e=ae(i,3);const t=e[0],n=e[1],r=e[2];return .2126*hf(t)+.7152*hf(n)+.0722*hf(r)}function yg(i){return iV(i)<=.179}class nu extends ct{constructor(e){super(cg(e)),this.defaultValue=e}toString(){return Ii(this.value)}toJSON(){if(!hg(this.value,this.defaultValue))return Ii(this.value)}reset(){this.value=cg(this.defaultValue)}restoreState(e){if(e===void 0){this.reset();return}const t=this.value,n=Ao(e);hg(t,n)||(this.value=n)}}class nV extends ct{constructor(){super(void 0)}toJSON(){const e=this.value;if(e!==void 0)return Ii(e)}reset(){this.value=void 0}restoreState(e){if(e===void 0){this.reset();return}const t=this.value,n=Ao(e);(t===void 0||!hg(t,n))&&(this.value=n)}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var q;(function(i){i[i.UINT8=0]="UINT8",i[i.INT8=1]="INT8",i[i.UINT16=2]="UINT16",i[i.INT16=3]="INT16",i[i.UINT32=4]="UINT32",i[i.INT32=5]="INT32",i[i.UINT64=6]="UINT64",i[i.FLOAT32=7]="FLOAT32"})(q||(q={}));const fL={[q.UINT8]:!1,[q.INT8]:!0,[q.UINT16]:!1,[q.INT16]:!0,[q.UINT32]:!1,[q.INT32]:!0,[q.UINT64]:!1,[q.FLOAT32]:void 0},rV={[q.UINT8]:1,[q.INT8]:1,[q.UINT16]:2,[q.INT16]:2,[q.UINT32]:4,[q.INT32]:4,[q.UINT64]:8,[q.FLOAT32]:4},sV={[q.UINT8]:Uint8Array,[q.INT8]:Int8Array,[q.UINT16]:Uint16Array,[q.INT16]:Int16Array,[q.UINT32]:Uint32Array,[q.INT32]:Int32Array,[q.UINT64]:Uint32Array,[q.FLOAT32]:Float32Array};q.UINT8+"",q.INT8+"",q.UINT16+"",q.INT16+"",q.UINT32+"",q.INT32+"",q.UINT64+"",q.FLOAT32+"";/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var qi;(function(i){i[i.LITTLE=0]="LITTLE",i[i.BIG=1]="BIG"})(qi||(qi={}));function aV(){const i=Uint16Array.of(4386);return new Uint8Array(i.buffer)[0]===17?qi.BIG:qi.LITTLE}const pc=aV();var vw={},pf,yw;function oV(){if(yw)return pf;yw=1;var i=Cs(),e=Math.floor;return pf=function(t){return!i(t)&&isFinite(t)&&e(t)===t},pf}var Sw;function lV(){if(Sw)return vw;Sw=1;var i=Ot();return i(i.S,"Number",{isInteger:oV()}),vw}var bw,ww;function cV(){return ww||(ww=1,lV(),bw=ut().Number.isInteger),bw}var Cw,xw;function dV(){return xw||(xw=1,Cw={default:cV(),__esModule:!0}),Cw}var uV=dV();const Ai=Qe(uV);var kw={},Ew;function hV(){if(Ew)return kw;Ew=1;var i=Ot(),e=Nr().isFinite;return i(i.S,"Number",{isFinite:function(t){return typeof t=="number"&&e(t)}}),kw}var Lw,Tw;function pV(){return Tw||(Tw=1,hV(),Lw=ut().Number.isFinite),Lw}var Dw,Pw;function fV(){return Pw||(Pw=1,Dw={default:pV(),__esModule:!0}),Dw}var gV=fV();const gt=Qe(gV);var Iw={},Rw;function mV(){if(Rw)return Iw;Rw=1;var i=Ot();return i(i.S,"Number",{isNaN:function(e){return e!=e}}),Iw}var Mw,Aw;function vV(){return Aw||(Aw=1,mV(),Mw=ut().Number.isNaN),Mw}var Nw,Vw;function yV(){return Vw||(Vw=1,Nw={default:vV(),__esModule:!0}),Nw}var SV=yV();const Wn=Qe(SV);function fc(i){let e=typeof i;if(e==="number"||e==="string"){let t=parseFloat(""+i);if(!Wn(t))return t}throw new Error(`Expected floating-point number, but received: ${re(i)}.`)}function vt(i){let e=fc(i);if(gt(e))return e;throw new Error(`Expected finite floating-point number, but received: ${e}.`)}function gL(i){let e=fc(i);if(gt(e)&&e>=0)return e;throw new Error(`Expected finite non-negative floating-point number, but received: ${e}.`)}function vi(i){let e=vt(i);if(e>0)return e;throw new Error(`Expected positive finite floating-point number, but received: ${e}.`)}function ru(i,e,t=fc){ge(e),i[0]=i[1]=i[2]=0;for(const n of Qt(e))switch(n){case"x":i[0]=t(e[n]);break;case"y":i[1]=t(e[n]);break;case"z":i[2]=t(e[n]);break;default:throw new Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${re(e)}.`)}return i}function _l(i,e){let t=i.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes");for(let n=0;n<t;++n)if(!gt(parseFloat(e[n])))throw new Error("Non-finite value.");for(let n=0;n<t;++n)i[n]=parseFloat(e[n]);return i}function za(i,e){let t=i.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes.");for(let n=0;n<t;++n){let r=parseInt(e[n],void 0);if(!Ai(r))throw new Error("Non-integer value.")}for(let n=0;n<t;++n)i[n]=parseInt(e[n],void 0);return i}function ln(i){if(typeof i=="object"){if(i===null)return"null";if(Array.isArray(i)){let s="[",a=i.length,l=0;if(l<a)for(s+=ln(i[l]);++l<a;)s+=",",s+=ln(i[l]);return s+="]",s}let e="{",t=Qt(i).sort(),n=0,r=t.length;if(n<r){let s=t[n];for(e+=re(s),e+=":",e+=ln(i[s]);++n<r;)e+=",",s=t[n],e+=re(s),e+=":",e+=ln(i[s])}return e+="}",e}return re(i)}const bV=/('(?:[^'\\]|(?:\\.))*')/,wV=/("(?:[^"\\]|(?:\\.))*")/,CV=new RegExp(`${bV.source}|${wV.source}`),xV=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/;function kV(i,e,t,n){if(i.length>=2&&i.charAt(0)===e&&i.charAt(i.length-1)===e){let r=i.substr(1,i.length-2),s=t;for(;r.length>0;){let a=r.match(n);if(a===null){s+=r;break}s+=a[1],a[2]===t?(s+="\\",s+=t):s+=e,r=r.substr(a.index+a[0].length)}return s+=t,s}return i}function EV(i,e,t){const n=/[&_,]/g;let r,s,a;r="'",s=xV,a=CV;let l="";for(;i.length>0;){let d=i.match(a),u,h;if(d===null)u=i,i="",h="";else{u=i.substr(0,d.index),i=i.substr(d.index+d[0].length);let g=d[1];g!==void 0?h=kV(g,r,t,s):h=d[2]}l+=u.replace(n,e),l+=h}return l}function LV(i){return EV(i,",",'"')}function Sg(i){return JSON.parse(LV(i))}function qn(i,e){if(!Array.isArray(i))throw new Error(`Expected array, but received: ${re(i)}.`);if(e!==void 0&&i.length!==e)throw new Error(`Expected array of length ${e}, but received: ${re(i)}.`);return i}function We(i,e){if(!Array.isArray(i))throw new Error(`Expected array, but received: ${re(i)}.`);return i.map(e)}function rt(i,e,t){const n=i.length;if(!Array.isArray(e)||e.length!==n)throw new Error(`Expected length ${n} array, but received: ${re(e)}.`);for(let r=0;r<n;++r)i[r]=t(e[r],r);return i}function ge(i){if(typeof i!="object"||i==null||Array.isArray(i))throw new Error(`Expected JSON object, but received: ${re(i)}.`);return i}function ui(i){let e=parseInt(i,10);if(!Ai(e))throw new Error(`Expected integer, but received: ${re(i)}.`);return e}function ai(i){let e=ui(i);if(e<=0)throw new Error(`Expected positive integer, but received: ${e}.`);return e}function TV(i){const e=ui(i);if(e<0)throw new Error(`Expected non-negative integer, but received: ${e}.`);return e}function mL(i,e){let t=e.get(i);if(t===void 0)throw new Error(`Expected one of ${re(Ee(e.keys()))}, but received: ${re(i)}.`);return t}function Le(i){if(typeof i!="string")throw new Error(`Expected string, but received: ${re(i)}.`);return i}function Dn(i){if(i!==void 0)return Le(i)}function K(i,e,t){let n=Object.prototype.hasOwnProperty.call(i,e)?i[e]:void 0;try{return t(n)}catch(r){throw new Error(`Error parsing ${re(e)} property: ${r.message}`)}}function ye(i,e,t,n){return K(i,e,r=>r===void 0?n:t(r))}function av(i,e){ge(i);let t=new ce;for(let n of Qt(i))try{t.set(n,e(i[n]))}catch(r){throw new Error(`Error parsing value associated with key ${re(n)}: ${r.message}`)}return t}function vL(i){if(typeof i!="number"||!gt(i)||i<0||i>1)throw new Error(`Expected floating point number in [0,1], but received: ${re(i)}.`);return i}function gc(i){if(i==="")return{};if(i.startsWith("{"))return Sg(i);{let e={},t=i.split(/[&;]/);for(let n of t){let r=n.match(/^([^=&;]+)=([^&;]*)$/);if(r===null)throw new Error(`Invalid query string part: ${re(n)}.`);e[r[1]]=decodeURIComponent(r[2])}return e}}function DV(i){if(i===void 0)return"";const e=Qt(i);return e.length===0?"":e.some(t=>typeof i[t]!="string")?re(i):e.map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(i[t])}`).join("&")}function Ri(i,e){if(typeof i=="string"&&i.match(/^[a-zA-Z]/)!==null&&(i=i.toUpperCase(),e.hasOwnProperty(i)))return e[i];throw new Error(`Invalid enum value: ${re(i)}.`)}function PV(i){return rt(Ne(),i,vt)}function Ln(i){if(!Array.isArray(i))throw new Error(`Expected array, received: ${re(i)}.`);for(let e of i)if(typeof e!="string")throw new Error(`Expected string, received: ${re(e)}.`);return i}function IV(i){if(!Array.isArray(i))throw new Error(`Expected array, received: ${re(i)}.`);for(let e of i)if(!Ai(e))throw new Error(`Expected integer, received: ${re(e)}.`);return i}function oo(i){if(typeof i!="boolean")throw new Error(`Expected boolean, received: ${re(i)}`);return i}function No(i){for(const e in i)return i}/**
* @license
* Copyright 2021 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const RV=2**-1074,bg=new Float64Array(1),ns=new Uint32Array(bg.buffer);function MV(i,e){if(isNaN(i)||isNaN(e))return NaN;if(i===e)return e;if(i===0)return e<0?-5e-324:RV;bg[0]=i;const t=pc===qi.LITTLE?0:1,n=1-t;return e>i==i>0?ns[t]===4294967295?(ns[t]=0,ns[n]+=1):ns[t]+=1:ns[t]===0?(ns[t]=4294967295,ns[n]-=1):ns[t]-=1,bg[0]}var Ow={},Bw;function AV(){if(Bw)return Ow;Bw=1;var i=Ot(),e=Math.imul;return i(i.S+i.F*qm()(function(){return e(4294967295,5)!=-5||e.length!=2}),"Math",{imul:function(t,n){var r=65535,s=+t,a=+n,l=r&s,d=r&a;return 0|l*d+((r&s>>>16)*d+l*(r&a>>>16)<<16>>>0)}}),Ow}var _w,Fw;function NV(){return Fw||(Fw=1,AV(),_w=ut().Math.imul),_w}var Uw,zw;function VV(){return zw||(zw=1,Uw={default:NV(),__esModule:!0}),Uw}var OV=VV();const Hn=Qe(OV);var $w={},Gw;function BV(){if(Gw)return $w;Gw=1;var i=Ot();return i(i.S,"Math",{log2:function(e){return Math.log(e)/Math.LN2}}),$w}var Ww,Hw;function _V(){return Hw||(Hw=1,BV(),Ww=ut().Math.log2),Ww}var jw,qw;function FV(){return qw||(qw=1,jw={default:_V(),__esModule:!0}),jw}var UV=FV();const Fi=Qe(UV);/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const ff=new Uint32Array(2),Ll=4294967296;let wg=[];for(let i=2;i<=36;++i){let e=Math.floor(32/Fi(i)),t=Math.pow(i,e),n=`^[0-${String.fromCharCode(48+Math.min(9,i-1))}`;i>10&&(n+=`a-${String.fromCharCode(97+i-11)}`,n+=`A-${String.fromCharCode(65+i-11)}`);let r=Math.ceil(64/Fi(i));n+=`]{1,${r}}$`;let s=new RegExp(n);wg[i]={lowDigits:e,lowBase:t,pattern:s}}function Jw(i,e){i>>>=0,e>>>=0;const t=i&65535,n=i>>>16,r=e&65535,s=e>>>16;let a=(t*r>>>16)+n*r,l=a>>>16;a=(a&65535)+t*s,l+=a>>>16;let d=l>>>16;return l=(l&65535)+n*s,d+=l>>>16,((d&65535)<<16|l&65535)>>>0}class te{constructor(e=0,t=0){this.low=e,this.high=t}clone(){return new te(this.low,this.high)}assign(e){this.low=e.low,this.high=e.high}toString(e=10){let t=this.low,n=this.high;if(n===0)return t.toString(e);n*=Ll;var r=wg[e];let s=r.lowBase,a=r.lowDigits,l=n%s;n=Math.floor(n/s),t+=l,n+=Math.floor(t/s),t=t%s;let d=t.toString(e);return n.toString(e)+"0".repeat(a-d.length)+d}static less(e,t){return e.high<t.high||e.high===t.high&&e.low<t.low}static compare(e,t){return e.high-t.high||e.low-t.low}static equal(e,t){return e.low===t.low&&e.high===t.high}static min(e,t){return te.less(e,t)?e:t}static max(e,t){return te.less(e,t)?t:e}static random(){return crypto.getRandomValues(ff),new te(ff[0],ff[1])}tryParseString(e,t=10){var n=wg[t];const r=n.lowDigits,s=n.lowBase;if(!n.pattern.test(e))return!1;if(e.length<=r)return this.low=parseInt(e,t),this.high=0,!0;const a=e.length-r,l=parseInt(e.substr(a),t),d=parseInt(e.substr(0,a),t);let u,h;if(s===Ll)u=d,h=l;else{const g=Hn(d,s)>>>0;u=Jw(d,s)+(Hn(Math.floor(d/Ll),s)>>>0),h=l+g,h>=Ll&&(++u,h-=Ll)}return h>>>0!==h||u>>>0!==u?!1:(this.low=h,this.high=u,!0)}parseString(e,t=10){if(!this.tryParseString(e,t))throw new Error(`Failed to parse string as uint64 value: ${re(e)}.`);return this}static parseString(e,t=10){return new te().parseString(e,t)}valid(){let e=this.low,t=this.high;return e>>>0===e&&t>>>0===t}toJSON(){return this.toString()}static lshift(e,t,n){const r=t.low,s=t.high;return n===0?(e.low=r,e.high=s):n<32?(e.low=r<<n,e.high=s<<n|r>>>32-n):(e.low=0,e.high=r<<n-32),e}static rshift(e,t,n){const r=t.low,s=t.high;return n===0?(e.low=r,e.high=s):n<32?(e.low=r>>>n|s<<32-n,e.high=s>>>n):(e.low=s>>>n-32,e.high=0),e}static or(e,t,n){return e.low=t.low|n.low,e.high=t.high|n.high,e}static xor(e,t,n){return e.low=t.low^n.low,e.high=t.high^n.high,e}static and(e,t,n){return e.low=t.low&n.low,e.high=t.high&n.high,e}static add(e,t,n){let r=t.low+n.low,s=t.high+n.high;const a=r>>>0;return a!==r&&(s+=1),e.low=a,e.high=s>>>0,e}static addUint32(e,t,n){let r=t.low+n,s=t.high;const a=r>>>0;return a!==r&&(s+=1),e.low=a,e.high=s>>>0,e}static decrement(e,t){let n=t.low,r=t.high;return n===0&&(r-=1),e.low=n-1>>>0,e.high=r>>>0,e}static increment(e,t){let n=t.low,r=t.high;return n===4294967295&&(r+=1),e.low=n+1>>>0,e.high=r>>>0,e}static subtract(e,t,n){let r=t.low-n.low,s=t.high-n.high;const a=r>>>0;return a!==r&&(s-=1),e.low=a,e.high=s>>>0,e}static absDifference(e,t,n){return te.less(t,n)?te.subtract(e,n,t):te.subtract(e,t,n)}static multiplyUint32(e,t,n){const r=t.low,s=t.high;return e.low=Hn(r,n)>>>0,e.high=Hn(s,n)+Jw(r,n)>>>0,e}static lowMask(e,t){return t===0?e.high=e.low=0:t<=32?(e.high=0,e.low=4294967295>>>32-t):(e.high=4294967295>>>t-32,e.low=4294967295),e}toNumber(){return this.low+this.high*4294967296}setFromNumber(e){e=Math.round(e),e<0?this.low=this.high=0:e>=18446744073709552e3?this.low=this.high=4294967295:(this.low=e%4294967296,this.high=Math.floor(e/4294967296))}}te.ZERO=new te(0,0);te.ONE=new te(1,0);const mc={[q.UINT8]:[0,255],[q.INT8]:[-128,127],[q.UINT16]:[0,65535],[q.INT16]:[-32768,32767],[q.UINT32]:[0,4294967295],[q.INT32]:[-2147483648,2147483647],[q.UINT64]:[te.ZERO,new te(4294967295,4294967295)],[q.FLOAT32]:[0,1]};function tn(i,e){if(typeof e=="number"){const t=i[0],n=i[1];return(e-t)/(n-t)}else{const t=i[0],n=i[1];let r;te.compare(e,t)<0?r=-te.subtract(ji,t,e).toNumber():r=te.subtract(ji,e,t).toNumber();let s=te.absDifference(ji,n,t).toNumber();return te.compare(t,n)>0&&(s*=-1),r/s}}function Cr(i,e,t){if(typeof i[0]=="number"){const r=i[0],s=i[1];let a=r*(1-t)+s*t;if(e!==q.FLOAT32){const l=mc[e];a=Math.round(a),a=Math.max(l[0],a),a=Math.min(l[1],a)}return a}else{let r=i[0],s=i[1];if(te.compare(r,s)>0){var n=[s,r];r=n[0],s=n[1],t=1-t}const a=te.subtract(ji,s,r).toNumber(),l=new te;return t<=0?(ji.setFromNumber(a*-t),te.subtract(l,r,te.min(ji,r))):t>=1?(ji.setFromNumber(a*(t-1)),te.add(l,s,ji),te.less(l,s)&&(l.low=l.high=4294967295)):(ji.setFromNumber(a*t),te.add(l,r,ji),te.less(l,r)&&(l.low=l.high=4294967295)),l}}function ql(i,e){return typeof e=="number"?Math.min(Math.max(i[0],e),i[1]):te.min(te.max(i[0],e),i[1])}function Fl(i,e){return[ql(i,e[0]),ql(i,e[1])]}function yL(i){if(dn(i[0],i[1])<=0)return i;throw new Error(`Invalid interval: [${i[0]}, ${i[1]}]`)}function zV(i){return dn(i[0],i[1])<=0?i:[i[1],i[0]]}function dn(i,e){return typeof i=="number"?i-e:te.compare(i,e)}const ji=new te,$V=new te;function GV(i,e){return typeof e=="number"?Math.abs(e-i[0])<Math.abs(e-i[1])?0:1:te.less(te.absDifference(ji,i[0],e),te.absDifference($V,i[1],e))?0:1}function vc(i,e){let t;switch(typeof e!="string"?t=""+e:t=e,i){case q.UINT64:return te.parseString(t);case q.FLOAT32:{const n=parseFloat(t);if(!gt(n))throw new Error(`Invalid float32 value: ${re(t)}`);return n}default:{const n=parseInt(t),r=mc[i];if(!Ai(n)||n<r[0]||n>r[1])throw new Error(`Invalid ${q[i].toLowerCase()} value: ${re(t)}`);return n}}}function su(i,e){return rt(new Array(2),i,t=>vc(e,t))}function xr(i,e,t){return i===q.UINT64?te.equal(e[0],t[0])&&te.equal(e[1],t[1]):e[0]===t[0]&&e[1]===t[1]}function Xw(i,e,t=mc[e]){if(!xr(e,i,t))return e===q.UINT64?[i[0].toString(),i[1].toString()]:i}function au(i,e,t){switch(i){case q.FLOAT32:return MV(e,t*(1/0));case q.UINT64:const n=e;return t===-1?n.low===0&&n.high===0?n:te.decrement(new te,n):n.low===4294967295&&n.high===4294967295?n:te.increment(new te,n);default:{const r=mc[i];return Math.max(r[0],Math.min(r[1],e+t))}}}function WV(i,e){switch(i){case q.FLOAT32:return 0;case q.UINT64:return .5/te.absDifference(ji,e[0],e[1]).toNumber();default:return .5/Math.abs(e[0]-e[1])}}function ou(i,e){switch(i){case q.FLOAT32:return 1;case q.UINT64:{const t=te.absDifference(ji,e[0],e[1]).toNumber();return t/(t+1)}default:{const t=Math.abs(e[0]-e[1]);return t/(t+1)}}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function lu(i=128){const e=Math.ceil(i/32),t=new Uint32Array(e);crypto.getRandomValues(t);let n="";for(let r=0;r<e;++r)n+=("00000000"+t[r].toString(16)).slice(-8);return n}function HV(i){let e=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);const t=65536;for(let n=0,r=e.length;n<r;n+=t)crypto.getRandomValues(e.subarray(n,Math.min(r,n+t)));return i}function Kw(){const i=new Uint32Array(1);return crypto.getRandomValues(i),i[0]}class Gd extends Y{constructor(e){super(),this.id=e,this.changed=new be}addRef(){return super.addRef()}dispose(){super.dispose()}}var Ie;(function(i){i[i.POINT=0]="POINT",i[i.LINE=1]="LINE",i[i.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",i[i.ELLIPSOID=3]="ELLIPSOID",i[i.SPHERE=4]="SPHERE"})(Ie||(Ie={}));const Tr=[Ie.POINT,Ie.LINE,Ie.AXIS_ALIGNED_BOUNDING_BOX,Ie.ELLIPSOID,Ie.SPHERE],gs={rgb:{serializedBytes(){return 3},alignment(){return 1},serializeCode(i,e){return`dv.setUint16(${e}, ${i}, true);dv.setUint8(${e} + 2, ${i} >>> 16);`},deserializeCode(i,e){return`${i} = dv.getUint16(${e}, true) | (dv.getUint8(${e} + 2) << 16);`},deserializeJson(i){return vg(Ao(i))},serializeJson(i){return Ii(eo(i))}},rgba:{serializedBytes(){return 4},alignment(){return 1},serializeCode(i,e){return`dv.setUint32(${e}, ${i}, true);`},deserializeCode(i,e){return`${i} = dv.getUint32(${e}, true);`},deserializeJson(i){return vg(pL(i))},serializeJson(i){return Ii(sv(i))}},float32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(i,e){return`dv.setFloat32(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getFloat32(${e}, isLittleEndian);`},deserializeJson(i){return fc(i)},serializeJson(i){return i}},uint32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(i,e){return`dv.setUint32(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getUint32(${e}, isLittleEndian);`},deserializeJson(i){return ui(i)},serializeJson(i){return i}},int32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(i,e){return`dv.setInt32(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getInt32(${e}, isLittleEndian);`},deserializeJson(i){return ui(i)},serializeJson(i){return i}},uint16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(i,e){return`dv.setUint16(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getUint16(${e}, isLittleEndian);`},deserializeJson(i){return ui(i)},serializeJson(i){return i}},int16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(i,e){return`dv.setInt16(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getInt16(${e}, isLittleEndian);`},deserializeJson(i){return ui(i)},serializeJson(i){return i}},uint8:{serializedBytes(){return 1},alignment(){return 1},serializeCode(i,e){return`dv.setUint8(${e}, ${i});`},deserializeCode(i,e){return`${i} = dv.getUint8(${e});`},deserializeJson(i){return ui(i)},serializeJson(i){return i}},int8:{serializedBytes(){return 2},alignment(){return 1},serializeCode(i,e){return`dv.setInt8(${e}, ${i});`},deserializeCode(i,e){return`${i} = dv.getInt8(${e});`},deserializeJson(i){return ui(i)},serializeJson(i){return i}}},jV=255;function SL(i,e,t){let n=0;const r=t.length,s=new Array(r),a=[];for(let v=0;v<r;++v)s[v]=v;const l=v=>gs[t[v].type].alignment(i);s.sort((v,y)=>l(y)-l(v));let d=0;const u=new Array(r);let h=e;const g=()=>{h+=(4-h%4)%4,n+=h,a[d]=h,h=0,++d};for(let v=0;v<r;++v){const y=s[v],C=t[y],w=gs[C.type],b=w.serializedBytes(i),k=w.alignment(i),L=(k-h%k)%k,I=h+L+b;I+(4-I%4)%4<=jV?h+=L:g(),u[y]={offset:h,group:d},h+=b}return g(),{serializedBytes:n,offsets:u,propertyGroupBytes:a}}class bL{constructor(e,t,n){if(this.rank=e,this.firstGroupInitialOffset=t,this.propertySpecs=n,n.length===0){this.serializedBytes=t,this.serialize=this.deserialize=()=>{},this.propertyGroupBytes=[t];return}var r=SL(e,t,n);const s=r.serializedBytes,a=r.offsets,l=r.propertyGroupBytes;this.propertyGroupBytes=l;let d="let groupOffset0 = offset;";for(let y=1;y<l.length;++y)d+=`let groupOffset${y} = groupOffset${y-1} + ${l[y-1]}*annotationCount;`;for(let y=0;y<l.length;++y)d+=`groupOffset${y} += ${l[y]}*annotationIndex;`;let u=d,h=d;const g=n.length;for(let y=0;y<g;++y){var v=a[y];const C=v.group,w=v.offset,b=n[y],k=gs[b.type],L=`properties[${y}]`,I=`groupOffset${C} + ${w}`;u+=k.serializeCode(L,I,e),h+=k.deserializeCode(L,I,e)}this.serializedBytes=s,this.serialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",u),this.deserialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",h)}}function ov(i,e){const t=[];for(const n of Tr){const r=Di[n];t[n]=new bL(i,r.serializedBytes(i),e)}return t}function wL(i,e){const t=i.type==="float32"?e.toPrecision(6):e.toString(),n=i.enumValues,r=i.enumLabels;if(n!==void 0){const s=n.indexOf(e);if(s!==-1)return`${r[s]} (${t})`}return t}function qV(i,e){switch(i.type){case"rgb":return Ii(eo(e));case"rgba":return Ii(sv(e));default:return wL(i,e)}}function JV(i){const e=Le(i);if(e.match(/^[a-z][a-zA-Z0-9_]*$/)===null)throw new Error(`Invalid property identifier: ${re(i)}`);return e}function XV(i){if(Le(i),!Object.prototype.hasOwnProperty.call(gs,i))throw new Error("Unsupported property type: $JSON.stringify(obj)}");return i}function KV(i){const e=new $e;for(const t of i){if(e.has(t.identifier))throw new Error(`Duplicate property identifier: ${t.identifier}`);e.add(t.identifier)}}function YV(i){ge(i);const e=K(i,"id",JV),t=K(i,"type",XV),n=ye(i,"description",Le);let r=ye(i,"default",l=>gs[t].deserializeJson(l),0),s,a;switch(t){case"rgb":case"rgba":break;default:{const l=q[t.toUpperCase()];s=ye(i,"enum_values",d=>We(d,u=>vc(l,u))),s!==void 0&&(a=K(i,"enum_labels",d=>rt(new Array(s.length),d,Le)))}}return{type:t,identifier:e,description:n,default:r,enumValues:s,enumLabels:a}}function ZV(i){const e=i.default;return{id:i.identifier,description:i.description,type:i.type,default:e===0?void 0:gs[i.type].serializeJson(e)}}function QV(i){if(!(i===void 0||i.length===0))return i.map(ZV)}function CL(i){if(i===void 0)return[];const e=We(i,YV);return KV(e),e}function Cg(i,e,t,n,r){for(let s=0;s<n;++s)i.setFloat32(e,r[s],t),e+=4;return e}function Ed(i,e,t,n,r,s){return e=Cg(i,e,t,n,r),e=Cg(i,e,t,n,s),e}function xg(i,e,t,n,r){for(let s=0;s<n;++s)r[s]=i.getFloat32(e,t),e+=4;return e}function Ld(i,e,t,n,r,s){return e=xg(i,e,t,n,r),e=xg(i,e,t,n,s),e}const Di={[Ie.LINE]:{icon:"ꕹ",description:"Line",toJSON(i){return{pointA:Ee(i.pointA),pointB:Ee(i.pointB)}},restoreState(i,e,t){i.pointA=K(e,"pointA",n=>rt(new Float32Array(t),n,vt)),i.pointB=K(e,"pointB",n=>rt(new Float32Array(t),n,vt))},serializedBytes(i){return 8*i},serialize(i,e,t,n,r){Ed(i,e,t,n,r.pointA,r.pointB)},deserialize:(i,e,t,n,r)=>{const s=new Float32Array(n),a=new Float32Array(n);return Ld(i,e,t,n,s,a),{type:Ie.LINE,pointA:s,pointB:a,id:r,properties:[]}},visitGeometry(i,e){e(i.pointA,!1),e(i.pointB,!1)}},[Ie.SPHERE]:{icon:"⊖",description:"Sphere",toJSON(i){return{pointA:Ee(i.pointA),pointB:Ee(i.pointB)}},restoreState(i,e,t){i.pointA=K(e,"pointA",n=>rt(new Float32Array(t),n,vt)),i.pointB=K(e,"pointB",n=>rt(new Float32Array(t),n,vt))},serializedBytes(i){return 8*i},serialize(i,e,t,n,r){Ed(i,e,t,n,r.pointA,r.pointB)},deserialize:(i,e,t,n,r)=>{const s=new Float32Array(n),a=new Float32Array(n);return Ld(i,e,t,n,s,a),{type:Ie.SPHERE,pointA:s,pointB:a,id:r,properties:[]}},visitGeometry(i,e){e(i.pointA,!1),e(i.pointB,!1)}},[Ie.POINT]:{icon:"⚬",description:"Point",toJSON:i=>({point:Ee(i.point)}),restoreState:(i,e,t)=>{i.point=K(e,"point",n=>rt(new Float32Array(t),n,vt))},serializedBytes:i=>i*4,serialize:(i,e,t,n,r)=>{Cg(i,e,t,n,r.point)},deserialize:(i,e,t,n,r)=>{const s=new Float32Array(n);return xg(i,e,t,n,s),{type:Ie.POINT,point:s,id:r,properties:[]}},visitGeometry(i,e){e(i.point,!1)}},[Ie.AXIS_ALIGNED_BOUNDING_BOX]:{icon:"❑",description:"Bounding Box",toJSON:i=>({pointA:Ee(i.pointA),pointB:Ee(i.pointB)}),restoreState:(i,e,t)=>{i.pointA=K(e,"pointA",n=>rt(new Float32Array(t),n,vt)),i.pointB=K(e,"pointB",n=>rt(new Float32Array(t),n,vt))},serializedBytes:i=>8*i,serialize(i,e,t,n,r){Ed(i,e,t,n,r.pointA,r.pointB)},deserialize:(i,e,t,n,r)=>{const s=new Float32Array(n),a=new Float32Array(n);return Ld(i,e,t,n,s,a),{type:Ie.AXIS_ALIGNED_BOUNDING_BOX,pointA:s,pointB:a,id:r,properties:[]}},visitGeometry(i,e){e(i.pointA,!1),e(i.pointB,!1)}},[Ie.ELLIPSOID]:{icon:"◎",description:"Ellipsoid",toJSON:i=>({center:Ee(i.center),radii:Ee(i.radii)}),restoreState:(i,e,t)=>{i.center=K(e,"center",n=>rt(new Float32Array(t),n,vt)),i.radii=K(e,"radii",n=>rt(new Float32Array(t),n,gL))},serializedBytes:i=>8*i,serialize(i,e,t,n,r){Ed(i,e,t,n,r.center,r.radii)},deserialize:(i,e,t,n,r)=>{const s=new Float32Array(n),a=new Float32Array(n);return Ld(i,e,t,n,s,a),{type:Ie.ELLIPSOID,center:s,radii:a,id:r,properties:[]}},visitGeometry(i,e){e(i.center,!1),e(i.radii,!0)}}};function kg(i,e){const t=Di[i.type].toJSON(i,e.rank);t.type=Ie[i.type].toLowerCase(),t.id=i.id,t.description=i.description||void 0;const n=i.relatedSegments;if(n!==void 0&&n.some(r=>r.length!==0)&&(t.segments=n.map(r=>r.map(s=>s.toString()))),e.properties.length!==0){const r=e.properties;t.props=i.properties.map((s,a)=>gs[r[a].type].serializeJson(s))}return t}function e3(i,e,t=!1){ge(i);const n=K(i,"type",d=>Ri(d,Ie)),r=K(i,"id",t?Dn:Le)||lv(),s=K(i,"segments",d=>{if(d===void 0)return e.relationships.map(()=>[]);const u=qn(d);return u.length===0?e.relationships.map(()=>[]):e.relationships.length===1&&!Array.isArray(u[0])?[We(u,h=>te.parseString(h))]:We(qn(d,e.relationships.length),h=>We(h,g=>te.parseString(g)))}),a=K(i,"props",d=>{const u=e.properties;return d===void 0?u.map(h=>h.default):We(qn(d,e.properties.length),(h,g)=>gs[u[g].type].deserializeJson(h))}),l={id:r,description:K(i,"description",Dn),relatedSegments:s,properties:a,type:n};return Di[n].restoreState(l,i,e.rank),l}class lo extends Y{constructor(e,t=[],n=[]){super(),this.relationships=t,this.properties=n,this.annotationMap=new ce,this.changed=new be,this.readonly=!1,this.childAdded=new Ze,this.childUpdated=new Ze,this.childDeleted=new Ze,this.childRefreshed=new be,this.pending=new $e,this.references=new ce,this.rank_=e,this.annotationPropertySerializers=ov(e,n)}get rank(){return this.rank_}hasNonSerializedProperties(){return!0}add(e,t=!0){if(this.ensureUpdated(),!e.id)e.id=lv();else if(this.annotationMap.has(e.id))throw new Error(`Annotation id already exists: ${re(e.id)}.`);return this.annotationMap.set(e.id,e),this.changed.dispatch(),this.childAdded.dispatch(e),t||this.pending.add(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();const t=e.id;this.pending.delete(t),this.changed.dispatch()}update(e,t){if(this.ensureUpdated(),e.value===null)throw new Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[Mi](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){e.value!==null&&(e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id))}getReference(e){let t=this.references.get(e);return t!==void 0?t.addRef():(t=new Gd(e),t.value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer(()=>{this.references.delete(e)}),t)}ensureUpdated(){}toJSON(){this.ensureUpdated();const e=[],t=this.pending;for(const n of this)t.has(n.id)||e.push(kg(n,this));return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();const t=this.annotationMap;t.clear(),this.pending.clear(),e!==void 0&&We(e,n=>{const r=e3(n,this);t.set(r.id,r)});for(const n of this.references.values()){const r=n.id,s=t.get(r);n.value=s||null,n.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}}class t3 extends lo{constructor(e,t,n){super(e.value.sourceRank,n,t),this.watchableTransform=e,this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add(()=>this.ensureUpdated()))}get rank(){return this.ensureUpdated(),this.rank_}ensureUpdated(){const e=this.watchableTransform.value,t=this.curCoordinateTransform;if(e===t)return;this.curCoordinateTransform=e;const n=e.sourceRank,r=t.sourceRank;if(r===n&&(t.inputSpace===e.inputSpace||Oe(t.inputSpace.ids.slice(0,n),e.inputSpace.ids.slice(0,n))))return;const s=e.inputSpace.ids,a=t.inputSpace.ids,l=[];for(let u=0;u<n;++u){let h=a.indexOf(s[u]);h>=r&&(h=-1),l.push(h)}const d=u=>{const h=new Float32Array(n);for(let g=0;g<n;++g){const v=l[g];h[g]=v===-1?0:u[g]}return h};for(const u of this.annotationMap.values())switch(u.type){case Ie.POINT:u.point=d(u.point);break;case Ie.LINE:case Ie.SPHERE:case Ie.AXIS_ALIGNED_BOUNDING_BOX:u.pointA=d(u.pointA),u.pointB=d(u.pointB);break;case Ie.ELLIPSOID:u.center=d(u.center),u.radii=d(u.radii);break}this.rank_!==n&&(this.rank_=n,this.annotationPropertySerializers=ov(this.rank_,this.properties)),this.changed.dispatch()}}const i3="Data Bounds";function lv(){return lu(160)}function n3(i){return{type:Ie.AXIS_ALIGNED_BOUNDING_BOX,id:"data-bounds",description:i3,pointA:new Float32Array(i.lowerBounds),pointB:new Float32Array(i.upperBounds),properties:[]}}function yc(i){const e=new lo(i.lowerBounds.length);return e.readonly=!0,e.add(n3(i)),e}function r3(i,e){let t=0;const n=[];for(const u of Tr){const h=e[u].serializedBytes;n[u]=t;const g=i[u].length;t+=h*g}const r=[],s=[],a=new ArrayBuffer(t),l=new DataView(a),d=pc===qi.LITTLE;for(const u of Tr){const h=e[u],g=h.rank,v=h.serialize,y=i[u];r[u]=y.map(k=>k.id),s[u]=new ce(y.map((k,L)=>[k.id,L]));const C=Di[u].serialize,w=n[u],b=h.propertyGroupBytes[0];for(let k=0,L=y.length;k<L;++k){const I=y[k];C(l,w+k*b,d,g,I),v(l,w,k,L,d,I.properties)}}return{data:new Uint8Array(a),typeToIds:r,typeToOffset:n,typeToIdMaps:s}}class s3{constructor(e){this.propertySerializers=e,this.annotations=[[],[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return r3(this.annotations,this.propertySerializers)}}function cv(i){if(i==null)return i;const e=i.relatedSegments;if(e!==void 0)for(let t=0,n=e.length;t<n;++t){const r=e[t];r!==void 0&&(e[t]=r.map(s=>new te(s.low,s.high)))}return i}/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function nh(i,e,t,n,r,s,a,l,d){for(let u=0;u<a;++u)for(let h=0;h<d;++h){let g=0;for(let v=0;v<l;++v)g+=t[u+n*v]*r[v+s*h];i[u+e*h]=g}return i}function a3(i,e,t){for(let n=0;n<t;++n){const r=e*n;i.fill(0,r,r+t),i[r+n]=1}return i}function xs(i,e,t=e){return a3(new i(e*t),e,Math.min(e,t))}function Yw(i,e,t=!0){const n=e.length,r=t?n+1:n,s=new i(r*(n+1));t&&(s[s.length-1]=1);for(let a=0;a<n;++a)s[(r+1)*a]=e[a];return s}function o3(i,e,t){for(let n=0;n<t;++n)for(let r=0;r<t;++r)if(i[n*e+r]!=(n===r?1:0))return!1;return!0}function dv(i,e,t,n,r,s){for(let a=0;a<s;++a){const l=a*n,d=a*e;for(let u=0;u<r;++u)i[d+u]=t[l+u]}return i}function uv(i,e,t,n){dv(i,e+1,t,n+1,n,n);for(let r=0;r<n;++r)i[(e+1)*e+r]=t[(n+1)*n+r];i[i.length-1]=1;for(let r=n;r<e;++r)i[(e+1)*r+r]=1;return i}let Qi;function l3(i,e,t){let n=1;(Qi===void 0||Qi.length<t)&&(Qi=new Uint32Array(t));for(let r=0;r<t;++r)Qi[r]=r;for(let r=0;r<t;++r){const s=e*r;let a=r;{let u=Math.abs(i[s+r]);for(let h=r+1;h<t;++h){const g=Math.abs(i[s+h]);g>u&&(u=g,a=h)}}if(r!==a){n*=-1;for(let u=0;u<t;++u){const h=e*u,g=i[h+r];i[h+r]=i[h+a],i[h+a]=g}{const u=Qi[r];Qi[r]=Qi[a],Qi[a]=u}}const l=i[s+r],d=1/l;n*=l;for(let u=0;u<t;++u)i[e*u+r]*=d;i[s+r]=d;for(let u=0;u<t;++u){if(u===r)continue;const h=-i[e*r+u];for(let g=0;g<t;++g){const v=e*g;i[v+u]+=h*i[v+r]}i[e*r+u]=h*d}}for(let r=0;r<t;++r){let s=Qi[r];for(;s!==r;){const a=e*r,l=e*s;for(let u=0;u<t;++u){const h=a+u,g=l+u,v=i[h];i[h]=i[g],i[g]=v}const d=Qi[r]=Qi[s];Qi[s]=s,s=d}}return n}function hv(i,e,t,n,r){return dv(i,e,t,n,r,r),l3(i,e,r)}function c3(i,e,t,n,r,s){for(let a=0;a<s;++a){const l=e*a,d=n*a;for(let u=0;u<r;++u)if(i[l+u]!==t[d+u])return!1}return!0}function Er(i,e,t,n,r){for(let s=0;s<r;++s){let a=e[t*r+s];for(let l=0;l<r;++l)a+=e[t*l+s]*n[l];i[s]=a}return i}function xL(i,e,t,n,r){for(let s=0;s<r;++s){let a=0;for(let l=0;l<r;++l)a+=e[t*l+s]*n[l];i[s]=a}return i}var Zw={},Qw;function d3(){if(Qw)return Zw;Qw=1;var i=Ot();return i(i.S,"Math",{log10:function(e){return Math.log(e)*Math.LOG10E}}),Zw}var eC,tC;function u3(){return tC||(tC=1,d3(),eC=ut().Math.log10),eC}var iC,nC;function h3(){return nC||(nC=1,iC={default:u3(),__esModule:!0}),iC}var p3=h3();const kL=Qe(p3),Wd=[{prefix:"Y",exponent:24},{prefix:"Z",exponent:21},{prefix:"E",exponent:18},{prefix:"P",exponent:15},{prefix:"T",exponent:12},{prefix:"G",exponent:9},{prefix:"M",exponent:6},{prefix:"k",exponent:3},{prefix:"",exponent:0},{prefix:"m",exponent:-3},{prefix:"µ",exponent:-6},{prefix:"n",exponent:-9},{prefix:"p",exponent:-12},{prefix:"f",exponent:-15},{prefix:"a",exponent:-18},{prefix:"z",exponent:-21},{prefix:"y",exponent:-24}],f3=[{prefix:"c",exponent:-2},{prefix:"u",exponent:-6},...Wd],Sc=new ce;Sc.set("",{unit:"",exponent:0});const g3=new ce;for(const i of f3){const e=i.prefix,t=i.exponent;g3.set(t,e);for(const n of["m","s","Hz","rad/s"])Sc.set(`${e}${n}`,{unit:n,exponent:t})}function EL(i){const e=kL(i),t=Wd.length,n=uN(0,t,r=>Wd[r].exponent<=e);return Wd[Math.min(n,t-1)]}function LL(i,e,t={}){var n=t.precision;const r=n===void 0?6:n;var s=t.elide1;const a=s===void 0?!0:s;let l=i,d="";if(e!==""){const h=EL(i);d=h.prefix,l=pv(i,-h.exponent)}if(a&&l===1)return{scale:"",unit:e,prefix:d};let u;if(r!=0){l<1||l>=1e3?u=l.toPrecision(r):u=l.toFixed(r);const h=u.indexOf("e");let g,v;h!==-1?(g=u.substring(0,h),v=u.substring(h)):(g=u,v="");const y=g.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);y!==null&&(g=g.substring(0,g.length-y[1].length),g.endsWith(".")&&(g=g.substring(0,g.length-1)),u=g+v)}else u=l.toString();return{scale:u,unit:e,prefix:d}}function Qs(i,e,t){var n=LL(i,e,t);const r=n.scale,s=n.unit,a=n.prefix;return`${r}${a}${s}`}function Jl(i){if(i==="")return{scale:1,unit:""};const e=i.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([µa-zA-Z]+)?$/);if(e===null)return;const t=e[1];let n=t===void 0?1:Number(t);if(Wn(n))return;let r="";if(e[2]!==void 0){const s=Sc.get(e[2]);if(s===void 0)return;r=s.unit,s.exponent>0?n*=10**s.exponent:n/=10**-s.exponent}if(!(n<=0||!gt(n)))return{scale:n,unit:r}}function rC(i){const e=Sc.get(i);if(e===void 0)throw new Error(`Invalid unit: ${re(i)}`);return e}function pv(i,e){return e>=0?i*10**e:i/10**-e}/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function TL(i,e,t){const n=i.length;for(let r=0;r<n;++r)i[r]=e[r]+t[r];return i}function Eg(i,e,t){const n=i.length;for(let r=0;r<n;++r)i[r]=e[r]-t[r];return i}function m3(i,e,t,n){const r=i.length;for(let s=0;s<r;++s)i[s]=e[s]+t[s]*n;return i}function v3(i,e,t){const n=i.length;for(let r=0;r<n;++r)i[r]=e[r]*t;return i}function fv(i){let e=1;for(let t=0,n=i.length;t<n;++t)e*=i[t];return e}function y3(i,e,t){const n=i.length;for(let r=0;r<n;++r)i[r]=Math.min(e[r],t[r]);return i}const co=new Float32Array(0),DL=new Float64Array(0);let S3=0;function Xa(){return++S3}function b3(i,e){return Oe(i.lowerBounds,e.lowerBounds)&&Oe(i.upperBounds,e.upperBounds)}function w3(i,e){return i===void 0?e===void 0:e===void 0?!1:i.explicit===e.explicit&&Oe(i.coordinates,e.coordinates)&&Oe(i.labels,e.labels)}function C3(i,e){const t=new ce;for(let n=0,r=i.length;n<r;++n)t.set(i[n],e[n]);return i=Ee(t.keys()),i.sort((n,r)=>n-r),e=Ee(i,n=>t.get(n)),{coordinates:i,labels:e}}function PL(i){if(i.length===1)return i[0];const e=new ce;let t=!1;for(const s of i){s.explicit&&(t=!0);const a=s.coordinates,l=s.labels;for(let d=0,u=a.length;d<u;++d)e.set(a[d],l[d])}const n=Ee(e.keys());n.sort((s,a)=>s-a);const r=Ee(n,s=>e.get(s));return{explicit:t,coordinates:n,labels:r}}function sC(i){if(i=i.filter(e=>e!==void 0),i.length!==0)return PL(i)}function x3(i,e){return Oe(i.transform,e.transform)&&b3(i.box,e.box)}function cu(i,e){return i.valid===e.valid&&i.rank===e.rank&&Oe(i.names,e.names)&&Oe(i.ids,e.ids)&&Oe(i.timestamps,e.timestamps)&&Oe(i.units,e.units)&&Oe(i.scales,e.scales)&&lg(i.boundingBoxes,e.boundingBoxes,x3)&&lg(i.coordinateArrays,e.coordinateArrays,w3)}function st(i){const e=i.names,t=i.units,n=i.scales;var r=i.valid;const s=r===void 0?!0:r;var a=i.rank;const l=a===void 0?e.length:a;var d=i.timestamps;const u=d===void 0?e.map(()=>Number.NEGATIVE_INFINITY):d;var h=i.ids;const g=h===void 0?e.map((L,I)=>-I):h;var v=i.boundingBoxes;const y=v===void 0?[]:v;var C=i.coordinateArrays;const w=C===void 0?new Array(l):C;var b=i.bounds;const k=b===void 0?L3(y,l):b;return{valid:s,rank:l,names:e,timestamps:u,ids:g,units:t,scales:n,boundingBoxes:y,bounds:k,coordinateArrays:w}}const Ir=st({valid:!1,names:[],units:[],scales:DL,boundingBoxes:[]}),uo=st({valid:!0,names:[],units:[],scales:DL,boundingBoxes:[]});function k3(i){var e=qn(i,2),t=ae(e,2);const n=t[0],r=t[1],s=vi(n),a=Le(r),l=Sc.get(a);if(l===void 0)throw new Error(`Invalid unit: ${re(a)}`);return{unit:l.unit,scale:pv(s,l.exponent)}}function du(i,e=!1){if(i===void 0)return Ir;ge(i);const t=yv(Qt(i),e),n=t.length,r=new Array(n),s=new Float64Array(n),a=new Array(n);for(let l=0;l<n;++l)K(i,t[l],d=>{if(Array.isArray(d)){var u=k3(d);const h=u.unit,g=u.scale;r[l]=h,s[l]=g}else{ge(d);let h=K(d,"coordinates",IV),g=K(d,"labels",Ln),v=h.length;if(v!==g.length)throw new Error(`Length of coordinates array (${v}) does not match length of labels array (${g.length})`);r[l]="",s[l]=1,a[l]=H({explicit:!0},C3(h,g))}});return st({valid:!1,names:t,units:r,scales:s,coordinateArrays:a})}function Lg(i){const e=i.rank;if(e===0)return;const t=i.names,n=i.units,r=i.scales,s=i.coordinateArrays,a={};for(let l=0;l<e;++l){const d=t[l],u=s[l];u?.explicit?a[d]={coordinates:Ee(u.coordinates),labels:u.labels}:a[d]=[r[l],n[l]]}return a}class gv extends ct{constructor(){super(Ir)}toJSON(){return Lg(this.value)}reset(){this.value=Ir}restoreState(e){this.value=du(e)}}function IL(i,e){let t=(i+e)/2;return gt(t)||(t=Math.min(Math.max(0,i),e)),t}function E3(i,e){const t=e.lowerBounds,n=e.upperBounds,r=i.length;for(let s=0;s<r;++s)i[s]=IL(t[s],n[s]);return i}function aa(i){const e=i.lowerBounds.length;return{box:i,transform:xs(Float64Array,e,e+1)}}function RL(i,e,t){var n=i.box;const r=n.lowerBounds,s=n.upperBounds,a=i.transform,l=r.length,d=t,u=a[d*l+e];let h=u,g=u,v=!1;for(let y=0;y<l;++y){let C=a[d*y+e];if(C===0)continue;const w=C*r[y],b=C*s[y];h+=Math.min(w,b),g+=Math.max(w,b),v=!0}if(v)return{lower:h,upper:g}}function L3(i,e){const t=new Float64Array(e),n=new Float64Array(e);t.fill(Number.NEGATIVE_INFINITY),n.fill(Number.POSITIVE_INFINITY);for(const r of i)for(let s=0;s<e;++s){const a=RL(r,s,e);if(a===void 0)continue;const l=a.lower,d=a.upper;t[s]=t[s]===Number.NEGATIVE_INFINITY?l:Math.min(t[s],l),n[s]=n[s]===Number.POSITIVE_INFINITY?d:Math.max(n[s],d)}return{lowerBounds:t,upperBounds:n}}function T3(i,e,t){const n=i.transform,r=i.box,s=t.length,a=r.lowerBounds.length,l=new Float64Array((a+1)*e);for(let d=0;d<s;++d){const u=t[d];if(u!==-1)for(let h=0;h<=a;++h)l[h*e+u]=n[h*s+d]}return{transform:l,box:r}}function ML(i,e){const t={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},n=new Float64Array(2*i);return n[e]=1,{transform:n,box:t}}function AL(i,e,t){if(e===t)return i;const n=i.box,r=n.lowerBounds.length,s=new Float64Array((r+1)*t);return dv(s,t,i.transform,e,e,r+1),{box:n,transform:s}}function D3(i,e){const t=i.rank,n=i.sourceRank;if(t!==e.rank||n!==e.sourceRank)return!1;const r=i.inputSpace,s=e.inputSpace;return!Oe(s.scales,r.scales)||!Oe(s.units,r.units)||!Oe(e.outputSpace.names,i.outputSpace.names)?!1:OL(i.transform,t,i.outputSpace.scales,e.transform,t,e.outputSpace.scales)}function zi(i){return{rank:i.rank,sourceRank:i.rank,inputSpace:i,outputSpace:i,transform:xs(Float64Array,i.rank+1)}}function P3(i,e,t,n){let r=i.transform,s=i.box;const a=i.box.lowerBounds.length,l=n.length,d=new Float64Array((a+1)*l);for(let u=0;u<l;++u){const h=n[u];for(let v=0;v<a;++v){let y=0;for(let C=0;C<l;++C){const w=t[C];y+=e[(l+1)*C+u]*r[l*v+C]*(w/h)}d[l*v+u]=y}let g=e[(l+1)*l+u];for(let v=0;v<l;++v){const y=t[v];g+=e[(l+1)*v+u]*r[l*a+v]*(y/h)}d[a*l+u]=g}return{transform:d,box:s}}function NL(i,e,t){return i.boundingBoxes.map(n=>P3(n,e,i.scales,t))}function Tg(i,e,t){const n=st({valid:i.valid,rank:t.rank,ids:t.ids,names:t.names,timestamps:t.timestamps,scales:t.scales,units:t.units,boundingBoxes:NL(i,e,t.scales),coordinateArrays:t.coordinateArrays});return cu(n,t)?t:n}function mv(i,e=!1){if(e){const t=Number(i);if(Ai(t)&&t>=0)return!0}return i.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)!==null}function rh(i,e=!1){const t=new $e;for(const n of i){if(!mv(n,e)||t.has(n))return!1;t.add(n)}return!0}function vv(i){const e=i.length,t=new Array(e);t.fill(!0);for(let n=0;n<e;++n){const r=i[n];if(!mv(r)){t[n]=!1;continue}const s=i.indexOf(r,n+1);s!==-1&&(t[n]=!1,t[s]=!1)}return t}function Ul(i){return i.endsWith("'")}function VL(i){return i.endsWith("'")||i.endsWith("^")}function I3(i){return i.endsWith("^")}function R3(i){return!VL(i)}function M3(i,e,t){const n=new Float64Array(i),r=e.length,s=(r+1)*r;for(let a=0;a<r;++a)n[s+a]*=e[a]/t[a];return n}function OL(i,e,t,n,r,s){if(!c3(i,e+1,n,r+1,e,e))return!1;for(let a=0;a<e;++a){const l=i[(e+1)*e+a],d=n[(r+1)*r+a];if(l*(t[a]/s[a])!==d)return!1}for(let a=e;a<r;++a)if(n[(r+1)*r+a]!==0)return!1;for(let a=e;a<r;++a){for(let l=0;l<e;++l)if(n[(r+1)*l+a]!==0)return!1;for(let l=0;l<r;++l){const d=n[(r+1)*a+l];if(a===l){if(d!==1)return!1}else if(d!==0)return!1}}return!0}function A3(i,e){if(!e.includes(i))return i;var t=i.match(/^([^']*)('?)$/),n=ae(t,3);const r=n[1],s=n[2];for(let a=0;;++a){const l=`${r}${a}${s}`;if(!e.includes(l))return l}}function N3(i,e){const t=i.inputSpace,n=i.transform,r=t.ids,s=t.rank,a=e.rank,l=e.names,d=e.units,u=e.scales,h=new Array(s);h.fill(!0);const g=[],v=e.ids.map(($,_)=>{const se=r.indexOf($);return se!==-1?h[se]=!1:g.push(_),se}),y=i.outputSpace,C=y.names,w=y.units,b=y.scales,k=y.ids,L=y.timestamps,I=y.coordinateArrays,P=h,T=[],R=[],M=new Float64Array(a),V=[],B=[],F=new Array(a);let j=0;const U=new Float64Array((a+1)**2);U[U.length-1]=1;for(let $=0;$<s;++$)if(!P[$]){T[j]=C[$],V[j]=k[$],R[j]=w[$],M[j]=b[$],B[j]=L[$],F[j]=I[$];for(let _=0;_<a;++_){const se=v[_];se!==-1&&(U[_*(a+1)+j]=n[se*(s+1)+$])}U[a*(a+1)+j]=n[s*(s+1)+$],++j}for(const $ of g)V[j]=Xa(),T[j]=A3(l[$],T),M[j]=u[$],R[j]=d[$],U[$*(a+1)+j]=1,++j;const O=st({valid:e.valid,rank:a,names:T,ids:V,timestamps:B,units:R,scales:M,boundingBoxes:NL(e,U,M),coordinateArrays:F});return{rank:a,sourceRank:i.sourceRank,inputSpace:e,outputSpace:O,transform:U}}function aC(i){const e=Tg(i.inputSpace,i.transform,i.outputSpace);return e===i.outputSpace?i:{rank:i.rank,sourceRank:i.sourceRank,inputSpace:i.inputSpace,transform:i.transform,outputSpace:e}}class oC{constructor(e,t=!1){this.mutableSourceRank=t,this.value_=void 0,this.changed=new be,this.inputSpaceChanged=new be,this.defaultTransform=aC(e);const n=this;this.outputSpace={changed:n.changed,get value(){return n.value.outputSpace},set value(r){const s=n.value;if(cu(s.outputSpace,r)||s.rank!==r.rank)return;const a=M3(s.transform,s.outputSpace.scales,r.scales);n.value_={sourceRank:s.sourceRank,rank:s.rank,inputSpace:s.inputSpace,outputSpace:Tg(s.inputSpace,a,r),transform:a},n.changed.dispatch()}},this.inputSpace={changed:n.inputSpaceChanged,get value(){return n.value.inputSpace},set value(r){const s=n.value;cu(s.inputSpace,r)||(n.value_=N3(s,r),n.inputSpaceChanged.dispatch(),n.changed.dispatch())}}}set value(e){const t=this.value;e!==t&&(this.value_=aC(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let e=this.value_;return e===void 0&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){const e=this.value,t=e.rank,n=e.transform,r=e.inputSpace,s=e.outputSpace,a=e.sourceRank,l=this.defaultTransform,d=this.mutableSourceRank,u=l.inputSpace,h=l.rank,g=l.transform,v=l.outputSpace,y=r.units,C=r.scales,w=a===t&&Oe(C,d?s.scales:u.scales)&&Oe(y,d?s.units:u.units),b=OL(g,h,v.scales,n,t,s.scales),k=Oe(v.names,s.names);if(!(b&&k&&w))return{sourceRank:a,transform:b?void 0:n,outputSpace:e.outputSpace,inputSpace:w?void 0:r}}set transform(e){const t=this.value,n=t.inputSpace;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:n,transform:e,outputSpace:Tg(n,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(e===void 0){this.reset();return}if(this.mutableSourceRank){const U=e.inputSpace||e.outputSpace,O=U.rank,$=st({rank:O,names:U.names.map((_,se)=>`${se}`),units:U.units,scales:U.scales,coordinateArrays:U.coordinateArrays});this.value={rank:O,transform:e.transform||xs(Float64Array,O+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:$};return}var t=this.defaultTransform;const n=t.inputSpace,r=t.sourceRank,s=t.outputSpace,a=t.transform,l=t.rank,d=e.inputSpace,u=e.sourceRank,h=e.outputSpace,g=e.transform,v=e.outputSpace.rank,y=n.names,C=d!==void 0?d.names:y,w=new Array(r);for(let U=0;U<r;++U){let O=C.indexOf(y[U]);O>=u&&(O=-1),w[U]=O}const b=v-u+r;for(let U=u;U<v;++U)w[r+U-u]=U;const k=new Float64Array(b),L=new Array(b),I=[];for(let U=0;U<r;++U){const O=w[U];O===-1||d===void 0?(k[U]=n.scales[U],I[U]=n.units[U],L[U]=n.coordinateArrays[U]):(k[U]=d.scales[O],I[U]=d.units[O],L[U]=sC([n.coordinateArrays[U],d.coordinateArrays[O]]))}const P=d||h,T=y.slice(0,r),R=s.names.slice(0,r),M=s.coordinateArrays.slice(0,r),V=new Float64Array(b),B=[];for(let U=0;U<b;++U){const O=w[U];O===-1?(V[U]=s.scales[U],B[U]=s.units[U],M[U]=s.coordinateArrays[U]):(R[U]=h.names[O],B[U]=h.units[O],V[U]=h.scales[O],M[U]=h.coordinateArrays[O])}if(!rh(R)){this.reset();return}for(let U=r;U<b;++U){const O=U-r+u;k[U]=P.scales[O],I[U]=P.units[O],T[U]=`${U}`}const F=new Float64Array((b+1)**2);F[F.length-1]=1;for(let U=0;U<b;++U){const O=w[U];let $;O===-1||g===void 0?U>=r?$=0:$=a[l*(l+1)+U]*(s.scales[U]/V[U]):$=g[v*(v+1)+O],F[b*(b+1)+U]=$;for(let _=0;_<b;++_){const se=w[_];let oe;O===-1!=(se===-1)?oe=0:O===-1||g===void 0?O>=r||se>=r?oe=O===se?1:0:oe=a[_*(l+1)+U]:oe=g[se*(v+1)+O],F[_*(b+1)+U]=oe}}const j=n.boundingBoxes.map(U=>AL(U,l,b));for(let U=r;U<b;++U)j.push(ML(b,U));for(let U=0;U<b;++U){if(F[b*(b+1)+U]!==0)continue;let O;for(let _=0;_<b;++_){const se=F[_*(b+1)+U];if(se!==0)if(se===1)if(O===void 0)O=_;else{O=null;break}else{O=null;break}}if(O==null)continue;let $=L[O];$!==void 0&&($.explicit&&($=H(H({},$),{explicit:!1})),M[U]=sC([$,M[U]]))}this.value={rank:b,transform:F,sourceRank:r,outputSpace:st({rank:b,names:R,scales:V,units:B,coordinateArrays:M}),inputSpace:st({rank:b,names:T,scales:k,units:I,coordinateArrays:L,boundingBoxes:j})}}toJSON(){return FL(this.spec)}restoreState(e){this.spec=_L(e)}}function V3(i,e=!1){const t=Le(i);if(!mv(t,e))throw new Error(`Invalid dimension name: ${re(t)}`);return t}function yv(i,e=!1){const t=We(i,n=>V3(n,e));if(!rh(t,e))throw new Error(`Invalid dimensions: ${re(t)}`);return t}class Sv{constructor(e,t){this.combined=e,this.bindings=new $e,this.retainCount=0,this.prevCombined=this.combined.value,this.dimensionRefCounts=new ce,this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()},this.includeDimensionPredicate_=t}getRenameValidity(e){const t=this.combined.value.names,n=vv(e),r=e.length;for(let s=0;s<r;++s){if(!n[s])continue;const a=e[s];if(t.includes(a))continue;let l=!0;for(const d of this.bindings)if(d.space.value.names.includes(a)){l=!1;break}n[s]=l}return n}get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}update(){const e=this.combined,t=this.bindings,n=this.retainCount>0?1:0;if(t.size===0&&!n){e.value=Ir;return}const r=this.includeDimensionPredicate_,s=e.value;let a=Ee(s.names),l=Ee(s.units),d=Ee(s.scales),u=Ee(s.ids),h=Ee(s.timestamps),g=s.names.map(()=>n?1:0);const v=[];let y=!1;for(const T of t){const R=T.space.value,M=T.prevValue,V=T.mappedDimensionIds;y=y||R.valid;const B=R.names,F=R.units,j=R.scales,U=R.ids,O=R.timestamps,$=[],_=[];v.push(_),T.mappedDimensionIds=$,T.prevValue=R;const se=B.length;for(let oe=0;oe<se;++oe){const Re=B[oe];if(!r(Re))continue;if(M!==void 0){const ie=U[oe],he=M.ids.indexOf(ie);if(he!==-1){const Te=V[he];if(Te!==void 0){const Fe=u.indexOf(Te);if(Fe!==-1){$[oe]=Te,++g[Fe],_[oe]=Fe;const Ge=O[oe];Ge!==void 0&&!(Ge<=h[Fe])&&(a[Fe]=Re,d[Fe]=j[oe],l[Fe]=F[oe],h[Fe]=Ge);continue}}}}let le=a.indexOf(Re);if(le!==-1){$[oe]=u[le],++g[le],_[oe]=le;continue}le=a.length,_[oe]=le,g[le]=1+n,a[le]=Re,l[le]=F[oe],d[le]=j[oe],h[le]=O[oe];const we=Xa();u[le]=we,$[oe]=we}}const C=this.dimensionRefCounts;C.clear();let w=0,b=a.length;for(const T of t){const R=T.space.value,M=v[w++],V=R.rank,B=Ee(R.names),F=Ee(R.timestamps),j=Float64Array.from(R.scales),U=Ee(R.units);for(let O=0;O<V;++O){const $=M[O];$!==void 0&&(U[O]=l[$],j[O]=d[$],F[O]=h[$],B[O]=a[$])}for(const O of B){let $=C.get(O);$===void 0?$=1:++$,C.set(O,$)}if(!Oe(U,R.units)||!Oe(j,R.scales)||!Oe(B,R.names)||!Oe(F,R.timestamps)){const O=st({valid:R.valid,ids:R.ids,scales:j,units:U,names:B,timestamps:F,boundingBoxes:R.boundingBoxes,coordinateArrays:R.coordinateArrays});T.prevValue=O,T.space.value=O}}{for(let R=0;R<b;++R)r(a[R])||(g[R]=0);const T=(R,M)=>g[M]!==0;a=a.filter(T),l=l.filter(T),d=d.filter(T),u=u.filter(T),h=h.filter(T),g=g.filter(T),b=a.length}const k=[],L=new Array(b);for(let T=0,R=s.rank;T<R;++T){const M=s.coordinateArrays[T];if(!M?.explicit)continue;const V=u.indexOf(s.ids[T]);V!==-1&&(L[V]=[M])}for(const T of t){const R=T.space.value,M=R.rank,V=R.boundingBoxes,B=R.coordinateArrays,F=R.names.map(j=>a.indexOf(j));for(const j of V)k.push(T3(j,b,F));for(let j=0;j<M;++j){const U=B[j];if(U===void 0)continue;const O=F[j],$=L[O];$===void 0?L[O]=[U]:$.push(U)}}const I=new Array(b);for(let T=0;T<b;++T){const R=L[T];R!==void 0&&(I[T]=PL(R))}const P=st({valid:y,ids:u,names:a,units:l,scales:new Float64Array(d),boundingBoxes:k,coordinateArrays:I});if(n)for(let T=0;T<b;++T)--g[T];cu(s,P)||(this.prevCombined=P,e.value=P)}retain(){return++this.retainCount,()=>{--this.retainCount===0&&this.update()}}bind(e){const t={space:e,mappedDimensionIds:[],prevValue:void 0},n=this.bindings;n.size===0&&this.combined.changed.add(this.handleCombinedChanged),n.add(t);const r=e.changed.add(()=>{e.value!==t.prevValue&&this.update()}),s=()=>{r();const a=this.bindings;a.delete(t),a.size===0&&this.combined.changed.remove(this.handleCombinedChanged),this.update()};return this.update(),s}}function BL(i,e,t,n,r){const s=r.length,a=new i((s+1)**2);a[a.length-1]=1;for(let l=0;l<s;++l){const d=n[l];a[(s+1)*s+l]=e[(t+1)*t+d];for(let u=0;u<s;++u){const h=r[u];a[(s+1)*u+l]=e[(t+1)*h+d]}}return a}function O3(i){if(i===void 0)return;const e=new Float64Array(16);if(Array.isArray(i))if(i.length===16)for(let t=0;t<4;++t)for(let n=0;n<4;++n)e[t*4+n]=vt(i[n*4+t]);else{qn(i,4);for(let t=0;t<4;++t){const n=qn(i[t],4);for(let r=0;r<4;++r)e[r*4+t]=vt(n[r])}}else{ge(i);const t=Pi(),n=Ne(),r=lt(1,1,1);ye(i,"rotation",a=>{_l(t,a),jl(t,t)}),ye(i,"translation",a=>{_l(n,a)}),ye(i,"scale",a=>{_l(r,a)});const s=Je();MN(s,t,n,r),e.set(s)}return{sourceRank:3,transform:e,outputSpace:st({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function _L(i){if(i===void 0)return;const e=ge(i),t=K(e,"outputDimensions",du),n=t.rank,r=K(e,"sourceRank",a=>{if(a===void 0)return n;if(!Ai(a)||a<0||a>n)throw new Error(`Expected integer in range [0, ${n}] but received: ${re(a)}`);return a}),s=ye(e,"inputDimensions",a=>{const l=du(a,!0);if(l.rank!==n)throw new Error(`Expected rank of ${n}, but received rank of: ${l.rank}`);return l});return{transform:ye(e,"matrix",a=>{const l=new Float64Array((n+1)**2),d=qn(a,n);l[l.length-1]=1;for(let u=0;u<n;++u)try{const h=qn(d[u],n+1);for(let g=0;g<=n;++g)l[(n+1)*g+u]=vt(h[g])}catch(h){throw new Error(`Error in row ${u}: ${h.message}`)}return l}),outputSpace:t,inputSpace:s,sourceRank:r}}function FL(i){if(i===void 0)return;const e=i.transform,t=i.outputSpace,n=i.inputSpace,r=i.sourceRank;let s;const a=t.rank;if(e!==void 0){s=[];for(let l=0;l<a;++l){const d=[];s[l]=d;for(let u=0;u<=a;++u)d[u]=e[(a+1)*u+l]}}return{sourceRank:r===a?void 0:r,matrix:s,outputDimensions:Lg(t),inputDimensions:n===void 0?void 0:Lg(n)}}function B3(i,e,t){const n=i.box,r=i.transform,s=i.box.lowerBounds.length,a=e.length,l=new Float64Array((s+1)*a);for(let d=0;d<a;++d)for(let u=0;u<=s;++u){const h=e[d];l[d+u*a]=r[h+u*t]}if(!l.every(d=>d===0))return{transform:l,box:n}}function Dg(i,e){const t=i.ids,n=i.names,r=i.scales,s=i.units,a=i.timestamps,l=i.coordinateArrays;return st({rank:e.length,valid:i.valid,ids:e.map(d=>t[d]),names:e.map(d=>n[d]),timestamps:e.map(d=>a[d]),scales:Float64Array.from(e,d=>r[d]),units:e.map(d=>s[d]),coordinateArrays:e.map(d=>l[d]),boundingBoxes:i.boundingBoxes.map(d=>B3(d,e,i.rank)).filter(d=>d!==void 0)})}function UL(i,e,t){return e===t?i:Dg(i,pN(i.rank,t,e))}function lC(i,e){const t=i.transform,n=i.rank,r=ih(t,n,[e]);if(r.length!==1)return;var s=ae(r,1);const a=s[0],l=Math.abs(t[(n+1)*a+e]),d=i.inputSpace;return{scale:d.scales[a]*l,unit:d.units[a]}}function cC(i,e){var t=i.defaultInputSpace;const n=t.scales,r=t.units;return e<n.length?{scale:n[e],unit:r[e]}:void 0}function _3(i){const e=i.rank;var t=i.bounds;const n=t.lowerBounds,r=t.upperBounds;if(n.some(d=>d!==0))throw new Error("Lower bounds of channel coordinate space must all be 0");if(r.some(d=>!Ai(d)||d<=0||d>=2**32))throw new Error("Upper bounds of channel coordinate space must all be positive integers");const s=new Uint32Array(r),a=fv(s),l=new Uint32Array(a*e);for(let d=0;d<a;++d){let u=d;for(let h=0;h<e;++h){const g=u%s[h];u=(u-g)/s[h],l[d*e+h]=g}}return{channelCoordinateSpace:i,shape:s,numChannels:a,coordinates:l}}function gf(i,e,t,n,r,s){const a=t.scales,l=r.scales,d=r.rank,u=e+1;for(let h=0;h<d;++h){const g=s[h];if(g===-1)continue;const v=l[h];for(let y=0;y<e;++y){const C=n[y],w=a[C];i[u*y+g]*=w/v}}}function F3(i,e,t,n,r=uo){const s=t.inputSpace,a=t.rank,l=t.sourceRank,d=t.outputSpace,u=t.transform,h=s.names,g=d.names;let v;if(n!==void 0)v=Ee(n.modelSubspaceDimensionIndices);else{v=[];for(let F=0;F<l;++F)v[F]=F}const y=v.length;for(let F=l;F<a;++F)v.push(F);const C=ih(t.transform,a,v,!0),w=v.length,b=v.map(F=>h[F]||`${F}`),k=C.map(F=>g[F]);if(w!==C.length)return{error:"Rank mismatch between model subspace dimensions ("+b.join(", ")+") and corresponding layer/global dimensions ("+k.join(", ")+")"};let L=BL(Float32Array,u,a,C,v);const I=C.map(F=>g[F]),P=e.names.map(F=>I.indexOf(F)),T=i.names.map(F=>I.indexOf(F));gf(L,w,s,v,i,T),gf(L,w,s,v,e,P);const R=r.names.map(F=>I.indexOf(F));gf(L,w,s,v,r,R);const M=[],V=r.rank;if(n!==void 0){let F=n.subsourceToModelSubspaceTransform;y!==w&&(F=uv(new Float32Array((w+1)**2),w,F,y)),L=nh(new Float32Array((w+1)**2),w+1,L,w+1,F,w+1,w+1,w+1,w+1)}const B=new Uint32Array(V);for(let F=0;F<V;++F){const j=r.bounds.lowerBounds[F],U=r.bounds.upperBounds[F];if(j!==0||!Ai(U)||U<=0||U>=2**32)return{error:`Channel dimension ${r.names[F]} must have lower bound of 0 and positive integer upper bound`};B[F]=U;const O=R[F];let $=-1;if(O!==-1)for(let _=0;_<w;++_){const se=L[O+_*(w+1)];if(se!==0){if(se!==1||$!==-1)return{error:`Channel dimension ${k[O]} must map to a single source dimension`};$=_}}M[F]=$}return{rank:w,unpaddedRank:y,modelDimensionNames:b,layerDimensionNames:k,localToRenderLayerDimensions:P,globalToRenderLayerDimensions:T,channelToRenderLayerDimensions:R,modelToRenderLayerTransform:L,channelToModelDimensions:M,channelSpaceShape:B}}function U3(i,e){return i===e?!0:i.error!==void 0||e.error!==void 0?!1:Oe(i.modelDimensionNames,e.modelDimensionNames)&&Oe(i.layerDimensionNames,e.layerDimensionNames)&&Oe(i.globalToRenderLayerDimensions,e.globalToRenderLayerDimensions)&&Oe(i.localToRenderLayerDimensions,e.localToRenderLayerDimensions)&&Oe(i.channelToRenderLayerDimensions,e.channelToRenderLayerDimensions)&&Oe(i.modelToRenderLayerTransform,e.modelToRenderLayerTransform)&&Oe(i.channelSpaceShape,e.channelSpaceShape)}function zL(i,e,t,n,r){return cn((s,a,l,d)=>F3(s,a,l,n,d),[i,e,t,r===void 0?Zs(void 0):r],U3)}function z3(i,e,t,n){const r=t.globalToRenderLayerDimensions;for(let s=0;s<3;++s){let a=0;const l=n[s];if(l!==-1){const d=r[l];d!==-1&&(a=e[d])}i[s]=a}}function $3(i,e,t,n){const r=t.globalToRenderLayerDimensions;for(let s=0;s<3;++s){const a=n[s];if(a!==-1){const l=r[a];l!==-1&&(i[l]=e[s])}}}function $L(i,e){const t=i.rank,n=i.unpaddedRank;let r;n!==t&&e!==void 0&&(e=uv(new Float32Array((t+1)**2),t,e,n)),e!==void 0?(r=new Float32Array((t+1)*(t+1)),nh(r,t+1,i.modelToRenderLayerTransform,t+1,e,t+1,t+1,t+1,t+1)):r=i.modelToRenderLayerTransform;const s=new Float32Array((t+1)*(t+1)),a=hv(s,t+1,r,t+1,t+1);if(a===0)throw new Error("Transform is singular");const l=i.globalToRenderLayerDimensions,d=i.localToRenderLayerDimensions,u=i.channelToRenderLayerDimensions,h=l.length,g=d.length,v=h+g,y=new Float32Array((v+1)*t);for(let T=0;T<t;++T){for(let R=0;R<h;++R){const M=l[R];M!==-1&&(y[T+R*t]=s[T+M*(t+1)])}for(let R=0;R<g;++R){const M=d[R];M!==-1&&(y[T+(h+R)*t]=s[T+M*(t+1)])}y[T+v*t]=s[T+t*(t+1)]}const C=u.length;let w=new Array(C);const b=[];for(let T=0;T<C;++T){const R=u[T];let M=-1;if(R!==-1){for(let V=0;V<t;++V){const B=r[R+V*(t+1)];if(B!==0){if(B!==1||M!==-1)throw new Error(`Channel dimension ${i.layerDimensionNames[R]} must map with stride 1 to a single data chunk dimensions`);M=V}}if(M!==-1){if(r[R+t*(t+1)]!==0)throw new Error(`Channel dimension ${i.layerDimensionNames[R]} must have an offset of 0 in the chunk coordinate space`);b.push(M)}}w[T]=M}const k=i.channelSpaceShape,L=fv(k),I=b.length,P=new Uint32Array(L*I);for(let T=0;T<L;++T){let R=T,M=0;for(let V=0;V<C;++V){const B=R%k[V];R=(R-B)/k[V],w[V]!==-1&&(P[T*I+M]=B,++M)}}return{layerRank:t,modelTransform:i,chunkToLayerTransform:r,layerToChunkTransform:s,chunkToLayerTransformDet:a,combinedGlobalLocalRank:v,combinedGlobalLocalToChunkTransform:y,channelToChunkDimensionIndices:w,chunkChannelDimensionIndices:b,numChannels:L,chunkChannelCoordinates:P,channelSpaceShape:k}}function GL(i,e){const t=i.globalToRenderLayerDimensions,n=[],r=[];for(let s=0;s<3;++s){const a=e[s];if(a==-1)continue;const l=t[a];r.push(l),l!==-1&&n.push(l)}for(let s=r.length;s<3;++s)r[s]=-1;return{layerDisplayDimensionIndices:n,displayToLayerDimensionIndices:r}}function WL(i,e){const t=i.chunkToLayerTransform,n=i.modelTransform,r=n.rank,s=e.layerDisplayDimensionIndices,a=e.displayToLayerDimensionIndices,l=s.length,d=ih(t,r,s);if(d.length!==l){const g=n.modelDimensionNames,v=n.layerDimensionNames;throw new Error(`Rank mismatch between displayed layer dimensions (${Ee(s,y=>v[y]).join(", ")}) and corresponding chunk dimensions (${Ee(d,y=>g[y]).join(", ")})`)}const u=Je();for(let g=0;g<3;++g){const v=a[g];if(v!==-1){for(let y=0;y<l;++y){const C=d[y];u[y*4+g]=t[C*(r+1)+v]}u[12+g]=t[r*(r+1)+v]}}const h=Je();fs(h,u);for(let g=d.length;g<3;++g)d[g]=-1;return{modelTransform:i.modelTransform,chunkTransform:i,displaySubspaceModelMatrix:u,displaySubspaceInvModelMatrix:h,chunkDisplayDimensionIndices:d,numChunkDisplayDims:l}}function Xl(i,e,t,n,r){const s=e.length,a=t.length,l=i.length;let d=!0;for(let u=0;u<n;++u){let h=u,g=0;for(let v=0;v<s;++v)g+=r[h+v*n]*e[v];h+=s*n;for(let v=0;v<a;++v)g+=r[h+v*n]*t[v];g+=r[h+a*n],u<l?i[u]=g:(g<0||g>=1)&&(d=!1)}return d}function G3(i,e,t){i.fill(0),i[15]=1;let n=!0;const r=e.displayDimensionIndices,s=t.globalToRenderLayerDimensions,a=t.modelToRenderLayerTransform,l=t.rank;for(let d=0;d<3;++d){const u=r[d];if(u===-1){n=!1;continue}const h=s[u];if(h===-1){n=!1;continue}i[d+12]=a[h+l*(l+1)];for(let g=0;g<3;++g)i[d+4*g]=a[h+(l+1)*g]}if(!n){const d=e.globalDimensionNames,u=Ee(r.filter(h=>h!==-1),h=>d[h]).join(", ");throw new Error(`Transform from model dimensions (${t.modelDimensionNames.join(", ")}) to display dimensions (${u}) does not have full rank`)}}var dC,uC;function W3(){return uC||(uC=1,PE(),dC=ut().Object.getOwnPropertySymbols),dC}var hC,pC;function H3(){return pC||(pC=1,hC={default:W3(),__esModule:!0}),hC}var j3=H3();const fC=Qe(j3);var q3=yA();const Mn=Qe(q3);var gC={},mC;function J3(){if(mC)return gC;mC=1;var i=Xm(),e=SA().f;return AE()("getOwnPropertyDescriptor",function(){return function(t,n){return e(i(t),n)}}),gC}var mf,vC;function X3(){if(vC)return mf;vC=1,J3();var i=ut().Object;return mf=function(e,t){return i.getOwnPropertyDescriptor(e,t)},mf}var yC,SC;function K3(){return SC||(SC=1,yC={default:X3(),__esModule:!0}),yC}var Y3=K3();const An=Qe(Y3);/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var pt;(function(i){i[i.GPU_MEMORY=0]="GPU_MEMORY",i[i.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",i[i.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",i[i.DOWNLOADING=3]="DOWNLOADING",i[i.QUEUED=4]="QUEUED",i[i.NEW=5]="NEW",i[i.FAILED=6]="FAILED",i[i.EXPIRED=7]="EXPIRED"})(pt||(pt={}));const HL=8;var mr;(function(i){i[i.FIRST_TIER=0]="FIRST_TIER",i[i.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",i[i.VISIBLE=0]="VISIBLE",i[i.PREFETCH=1]="PREFETCH",i[i.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",i[i.RECENT=2]="RECENT",i[i.LAST_TIER=2]="LAST_TIER"})(mr||(mr={}));const jL=3;var uu;(function(i){i[i.totalTime=0]="totalTime",i[i.totalChunks=1]="totalChunks"})(uu||(uu={}));var vr;(function(i){i[i.numChunks=0]="numChunks",i[i.systemMemoryBytes=1]="systemMemoryBytes",i[i.gpuMemoryBytes=2]="gpuMemoryBytes"})(vr||(vr={}));const as=3;function zs(i,e){return i*jL+e}function bC(i){return HL*jL*as+i}const Z3="ChunkQueueManager",Q3="ChunkManager",eO="ChunkSource.invalidate",tO="ChunkQueueManager.requestChunkStatistics",iO="ChunkManager.chunkLayerStatistics";class bv{constructor(){this.numVisibleChunksNeeded=0,this.numVisibleChunksAvailable=0,this.numPrefetchChunksNeeded=0,this.numPrefetchChunksAvailable=0}}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function dt(i){let e=-1;return H(()=>{e===-1&&(e=requestAnimationFrame(()=>{e=-1,i()}))},{flush:()=>{e!==-1&&(e=-1,i())},cancel:()=>{e!==-1&&(cancelAnimationFrame(e),e=-1)}})}class qL{constructor(){this.map=new ce}get(e,t){let n=this.map,r=n.get(e);return r===void 0?(r=t(),r.registerDisposer(()=>{n.delete(e)}),n.set(e,r)):r.addRef(),r}}class JL extends qL{get(e,t){return typeof e!="string"&&(e=ln(e)),super.get(e,t)}getUncounted(e,t){return this.get(e,()=>new HE(t())).value}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function nO(i){let e={antialias:!1,stencil:!0},t=i.getContext("webgl2",e);if(t==null)throw new Error("WebGL not supported.");t.memoize=new qL,t.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),t.max3dTextureSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.maxTextureImageUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.tempTextureUnit=t.maxTextureImageUnits-1;for(const n of["EXT_color_buffer_float"])if(!t.getExtension(n))throw new Error(`${n} extension not available`);for(const n of["EXT_float_blend"])t.getExtension(n);return t}class wv{constructor(){this.width=0,this.height=0,this.logicalWidth=0,this.logicalHeight=0,this.visibleLeftFraction=0,this.visibleTopFraction=0,this.visibleWidthFraction=0,this.visibleHeightFraction=0}}function XL(i,e){const t=1/i.visibleWidthFraction,n=1/i.visibleHeightFraction,r=-1-(-1+2*i.visibleLeftFraction)*t;let s=-1-(-1+2*i.visibleTopFraction)*n;s=-s,e[0]=e[0]*t+e[3]*r,e[4]=e[4]*t+e[7]*r,e[8]=e[8]*t+e[11]*r,e[12]=e[12]*t+e[15]*r,e[1]=e[1]*n+e[3]*s,e[5]=e[5]*n+e[7]*s,e[9]=e[9]*n+e[11]*s,e[13]=e[13]*n+e[15]*s}function KL(i,e){return i.width===e.width&&i.height===e.height&&i.logicalWidth===e.logicalWidth&&i.logicalHeight===e.logicalHeight&&i.visibleLeftFraction===e.visibleLeftFraction&&i.visibleTopFraction===e.visibleTopFraction}class YL extends Y{constructor(e,t,n){super(),this.context=e,this.element=t,this.visibility=n,this.boundsGeneration=-1,this.canvasRelativeClippedLeft=0,this.canvasRelativeClippedTop=0,this.canvasRelativeLogicalLeft=0,this.canvasRelativeLogicalTop=0,this.renderViewport=new wv,this.boundsObserversRegistered=!1,this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){const e=this.context;e.ensureBoundsUpdated();const t=e.boundsGeneration;if(t===this.boundsGeneration)return;this.boundsGeneration=t;const n=this.element;!this.boundsObserversRegistered&&e.monitorPanel(n)&&(this.boundsObserversRegistered=!0);const r=n.getBoundingClientRect(),s=e.container,a=e.canvasRect,l=e.canvas,d=l.width,u=l.height,h=d/a.width,g=u/a.height,v=a.left,y=a.top;let C=this.canvasRelativeLogicalLeft=Math.round((r.left-v)*h+n.clientLeft),w=this.canvasRelativeLogicalTop=Math.round((r.top-y)*g+n.clientTop),b=n.clientWidth,k=n.clientHeight,L=C+b,I=w+k,P=w,T=C,R=L,M=I;for(let j=n.parentElement;j!==null&&j!==s;j=j.parentElement){const U=j.getBoundingClientRect();U.x===0&&U.y===0&&U.width===0&&U.height===0||(T=Math.max(T,(U.left-v)*h),P=Math.max(P,(U.top-y)*g),R=Math.min(R,(U.right-v)*h),M=Math.min(M,(U.bottom-y)*g))}P=this.canvasRelativeClippedTop=Math.round(Math.max(P,0)),T=this.canvasRelativeClippedLeft=Math.round(Math.max(T,0)),R=Math.round(Math.min(R,d)),M=Math.round(Math.min(M,u));const V=this.renderViewport,B=V.width=Math.max(0,R-T),F=V.height=Math.max(0,M-P);V.logicalWidth=b,V.logicalHeight=k,V.visibleLeftFraction=(T-C)/b,V.visibleTopFraction=(P-w)/k,V.visibleWidthFraction=B/b,V.visibleHeightFraction=F/k}setGLClippedViewport(){const e=this.gl,t=this.canvasRelativeClippedTop,n=this.canvasRelativeClippedLeft;var r=this.renderViewport;const s=r.width,a=r.height,l=t+a;e.enable(WebGL2RenderingContext.SCISSOR_TEST);let d=this.context.canvas.height-l;e.viewport(n,d,s,a),e.scissor(n,d,s,a)}setGLLogicalViewport(){const e=this.gl;var t=this.renderViewport;const n=t.width,r=t.height,s=t.logicalWidth,a=t.logicalHeight,l=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,l-(this.canvasRelativeLogicalTop+a),s,a),e.scissor(this.canvasRelativeClippedLeft,l-(this.canvasRelativeClippedTop+r),n,r)}disposed(){this.boundsObserversRegistered&&this.context.unmonitorPanel(this.element),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;const e=this.element;return!(e.clientWidth===0||e.clientHeight===0||e.offsetWidth===0||e.offsetHeight===0)}get drawOrder(){return 0}}class ZL extends YL{constructor(e,t,n){super(e,t,n),this.canvas=document.createElement("canvas"),this.canvasRenderingContext=this.canvas.getContext("2d");const r=this.canvas;t.appendChild(r),t.style.position="relative",r.style.position="absolute",r.style.left="0",r.style.right="0",r.style.top="0",r.style.bottom="0"}draw(){this.drawIndirect();const e=this.renderViewport,t=this.canvas,n=e.logicalWidth,r=e.logicalHeight;t.width=n,t.height=r,this.canvasRenderingContext?.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,n,r,0,0,n,r)}}class rO extends Jt{constructor(){super(Float64Array.of(0,0,1,1),e=>rt(new Float64Array(4),e,vL))}toJSON(){const e=this.value;var t=ae(e,4);const n=t[0],r=t[1],s=t[2],a=t[3];if(!(n===0&&r==0&&s===1&&a===1))return Ee(e)}}class sO extends Y{constructor(e){super(),this.container=e,this.canvas=document.createElement("canvas"),this.updateStarted=new be,this.updateFinished=new be,this.changed=this.updateFinished,this.panels=new $e,this.resizeGeneration=0,this.boundsGeneration=-1,this.orderedPanels=[],this.frameNumber=0,this.panelAncestors=new ce,this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()},this.resizeObserver=new ResizeObserver(this.resizeCallback),this.scheduleRedraw=this.registerCancellable(dt(()=>this.draw()));const t=this.canvas,n=this.resizeObserver;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",n.observe(t),e.appendChild(t),this.registerEventListener(t,"webglcontextlost",r=>{console.log(`Lost WebGL context: ${r.statusMessage}`),r.preventDefault()}),this.registerEventListener(t,"webglcontextrestored",()=>{console.log("WebGL context restored"),window.location.reload()}),this.gl=nO(t)}monitorPanel(e){const t=this.panelAncestors,n=this.container;if(!n.contains(e))return!1;for(;e!==n;){let r=t.get(e);if(r!==void 0){++r.count;break}const s=e.parentElement;r={parent:s,count:1},t.set(e,r),e.addEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.observe(e),e=s}return!0}unmonitorPanel(e){const t=this.panelAncestors,n=this.container;for(;e!==n;){const r=t.get(e);if(r.count!==1){--r.count;break}e.removeEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.unobserve(e),t.delete(e),e=r.parent}}applyWindowedViewportToElement(e,t){var n=ae(t,4);const r=n[0],s=n[1],a=n[2],l=n[3],d=1/a,u=1/l;e.style.position="absolute",e.style.top=`${-u*s*100}%`,e.style.left=`${-d*r*100}%`,e.style.width=`${d*100}%`,e.style.height=`${u*100}%`,++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(const e of this.panels)if(e.visible&&!e.isReady())return!1;return!0}makeCanvasOverlayElement(){const e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}ensureBoundsUpdated(){const e=this.resizeGeneration;if(this.boundsGeneration===e)return;const t=this.canvas;t.width=t.offsetWidth,t.height=t.offsetHeight,this.canvasRect=t.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();let e=this.gl;this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const t=this.orderedPanels,n=this.panels;t.length!==n.size&&(t.push(...n),t.sort((r,s)=>r.drawOrder-s.drawOrder));for(const r of t){if(!r.shouldDraw)continue;r.ensureBoundsUpdated();const s=r.renderViewport;s.width===0||s.height===0||r.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch()}getDepthArray(){var e=this.canvas;const t=e.width,n=e.height,r=new Float32Array(t*n);for(const a of this.panels){if(!a.shouldDraw)continue;const l=a.getDepthArray();if(l===void 0)continue;const d=a.canvasRelativeClippedTop,u=a.canvasRelativeClippedLeft;var s=a.renderViewport;const h=s.width,g=s.height;for(let v=0;v<g;++v){const y=(g-1-v)*h;r.set(l.subarray(y,y+h),(d+v)*h+u)}}return r}}/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class QL extends wv{constructor(){super(...arguments),this.globalPosition=co,this.projectionMat=Je(),this.viewMatrix=Je(),this.invViewMatrix=Je(),this.viewProjectionMat=Je(),this.invViewProjectionMat=Je()}}function aO(i,e){return i.displayDimensionRenderInfo===e.displayDimensionRenderInfo&&KL(i,e)&&Oe(i.globalPosition,e.globalPosition)&&Oe(i.projectionMat,e.projectionMat)&&Oe(i.viewMatrix,e.viewMatrix)}function e2(i){const e=i.viewMatrix,t=i.viewProjectionMat;fs(e,i.invViewMatrix),ei(t,i.projectionMat,e),fs(i.invViewProjectionMat,t)}/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const oO="rendered_view.addLayer",lO="rendered_view.removeLayer",cO="SharedProjectionParameters",dO="SharedProjectionParameters.changed";var Yn;(function(i){i[i.info=0]="info",i[i.warning=1]="warning",i[i.error=2]="error"})(Yn||(Yn={}));class Vo{constructor(){this.changed=new be,this.messages=[],this.children=[]}addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){const e=this.messages;e.length!==0&&(e.length=0,this.changed.dispatch())}isEmpty(){return this.messages.length===0&&!this.children.some(e=>!e.isEmpty())}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),e.isEmpty()||this.changed.dispatch(),()=>{const t=this.children;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),e.isEmpty()||this.changed.dispatch()}}*[Mi](){yield*this.messages;for(const e of this.children)yield*e}}var wC={},vf,CC;function t2(){if(CC)return vf;CC=1;var i=Ro(),e=ju(),t=Vr()("species");return vf=function(n,r){var s=i(n).constructor,a;return s===void 0||(a=i(s)[t])==null?r:e(a)},vf}var xC,kC;function uO(){return kC||(kC=1,xC=function(i,e,t){var n=t===void 0;switch(e.length){case 0:return n?i():i.call(t);case 1:return n?i(e[0]):i.call(t,e[0]);case 2:return n?i(e[0],e[1]):i.call(t,e[0],e[1]);case 3:return n?i(e[0],e[1],e[2]):i.call(t,e[0],e[1],e[2]);case 4:return n?i(e[0],e[1],e[2],e[3]):i.call(t,e[0],e[1],e[2],e[3])}return i.apply(t,e)}),xC}var yf,EC;function i2(){if(EC)return yf;EC=1;var i=sa(),e=uO(),t=mA(),n=vA(),r=Nr(),s=r.process,a=r.setImmediate,l=r.clearImmediate,d=r.MessageChannel,u=r.Dispatch,h=0,g={},v="onreadystatechange",y,C,w,b=function(){var L=+this;if(g.hasOwnProperty(L)){var I=g[L];delete g[L],I()}},k=function(L){b.call(L.data)};return(!a||!l)&&(a=function(L){for(var I=[],P=1;arguments.length>P;)I.push(arguments[P++]);return g[++h]=function(){e(typeof L=="function"?L:Function(L),I)},y(h),h},l=function(L){delete g[L]},Ym()(s)=="process"?y=function(L){s.nextTick(i(b,L,1))}:u&&u.now?y=function(L){u.now(i(b,L,1))}:d?(C=new d,w=C.port2,C.port1.onmessage=k,y=i(w.postMessage,w,1)):r.addEventListener&&typeof postMessage=="function"&&!r.importScripts?(y=function(L){r.postMessage(L+"","*")},r.addEventListener("message",k,!1)):v in n("script")?y=function(L){t.appendChild(n("script"))[v]=function(){t.removeChild(this),b.call(L)}}:y=function(L){setTimeout(i(b,L,1),0)}),yf={set:a,clear:l},yf}var Sf,LC;function hO(){if(LC)return Sf;LC=1;var i=Nr(),e=i2().set,t=i.MutationObserver||i.WebKitMutationObserver,n=i.process,r=i.Promise,s=Ym()(n)=="process";return Sf=function(){var a,l,d,u=function(){var y,C;for(s&&(y=n.domain)&&y.exit();a;){C=a.fn,a=a.next;try{C()}catch(w){throw a?d():l=void 0,w}}l=void 0,y&&y.enter()};if(s)d=function(){n.nextTick(u)};else if(t&&!(i.navigator&&i.navigator.standalone)){var h=!0,g=document.createTextNode("");new t(u).observe(g,{characterData:!0}),d=function(){g.data=h=!h}}else if(r&&r.resolve){var v=r.resolve(void 0);d=function(){v.then(u)}}else d=function(){e.call(i,u)};return function(y){var C={fn:y,next:void 0};l&&(l.next=C),a||(a=C,d()),l=C}},Sf}var bf={},TC;function Cv(){if(TC)return bf;TC=1;var i=ju();function e(t){var n,r;this.promise=new t(function(s,a){if(n!==void 0||r!==void 0)throw TypeError("Bad Promise constructor");n=s,r=a}),this.resolve=i(n),this.reject=i(r)}return bf.f=function(t){return new e(t)},bf}var DC,PC;function n2(){return PC||(PC=1,DC=function(i){try{return{e:!1,v:i()}}catch(e){return{e:!0,v:e}}}),DC}var wf,IC;function pO(){if(IC)return wf;IC=1;var i=Nr(),e=i.navigator;return wf=e&&e.userAgent||"",wf}var Cf,RC;function r2(){if(RC)return Cf;RC=1;var i=Ro(),e=Cs(),t=Cv();return Cf=function(n,r){if(i(n),e(r)&&r.constructor===n)return r;var s=t.f(n),a=s.resolve;return a(r),s.promise},Cf}var MC;function fO(){if(MC)return wC;MC=1;var i=fA(),e=Nr(),t=sa(),n=Ju(),r=Ot(),s=Cs(),a=ju(),l=Ku(),d=Mo(),u=t2(),h=i2().set,g=hO()(),v=Cv(),y=n2(),C=pO(),w=r2(),b="Promise",k=e.TypeError,L=e.process,I=L&&L.versions,P=I&&I.v8||"",T=e[b],R=n(L)=="process",M=function(){},V,B,F,j,U=B=v.f,O=!!(function(){try{var ie=T.resolve(1),he=(ie.constructor={})[Vr()("species")]=function(Te){Te(M,M)};return(R||typeof PromiseRejectionEvent=="function")&&ie.then(M)instanceof he&&P.indexOf("6.6")!==0&&C.indexOf("Chrome/66")===-1}catch{}})(),$=function(ie){var he;return s(ie)&&typeof(he=ie.then)=="function"?he:!1},_=function(ie,he){if(!ie._n){ie._n=!0;var Te=ie._c;g(function(){for(var Fe=ie._v,Ge=ie._s==1,Pe=0,ke=function(Me){var _e=Ge?Me.ok:Me.fail,Ue=Me.resolve,Ce=Me.reject,Xe=Me.domain,Ft,Xt,yi;try{_e?(Ge||(ie._h==2&&Re(ie),ie._h=1),_e===!0?Ft=Fe:(Xe&&Xe.enter(),Ft=_e(Fe),Xe&&(Xe.exit(),yi=!0)),Ft===Me.promise?Ce(k("Promise-chain cycle")):(Xt=$(Ft))?Xt.call(Ft,Ue,Ce):Ue(Ft)):Ce(Fe)}catch(Kt){Xe&&!yi&&Xe.exit(),Ce(Kt)}};Te.length>Pe;)ke(Te[Pe++]);ie._c=[],ie._n=!1,he&&!ie._h&&se(ie)})}},se=function(ie){h.call(e,function(){var he=ie._v,Te=oe(ie),Fe,Ge,Pe;if(Te&&(Fe=y(function(){R?L.emit("unhandledRejection",he,ie):(Ge=e.onunhandledrejection)?Ge({promise:ie,reason:he}):(Pe=e.console)&&Pe.error&&Pe.error("Unhandled promise rejection",he)}),ie._h=R||oe(ie)?2:1),ie._a=void 0,Te&&Fe.e)throw Fe.v})},oe=function(ie){return ie._h!==1&&(ie._a||ie._c).length===0},Re=function(ie){h.call(e,function(){var he;R?L.emit("rejectionHandled",ie):(he=e.onrejectionhandled)&&he({promise:ie,reason:ie._v})})},le=function(ie){var he=this;he._d||(he._d=!0,he=he._w||he,he._v=ie,he._s=2,he._a||(he._a=he._c.slice()),_(he,!0))},we=function(ie){var he=this,Te;if(!he._d){he._d=!0,he=he._w||he;try{if(he===ie)throw k("Promise can't be resolved itself");(Te=$(ie))?g(function(){var Fe={_w:he,_d:!1};try{Te.call(ie,t(we,Fe,1),t(le,Fe,1))}catch(Ge){le.call(Fe,Ge)}}):(he._v=ie,he._s=1,_(he,!1))}catch(Fe){le.call({_w:he,_d:!1},Fe)}}};return O||(T=function(ie){l(this,T,b,"_h"),a(ie),V.call(this);try{ie(t(we,this,1),t(le,this,1))}catch(he){le.call(this,he)}},V=function(ie){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},V.prototype=Xu()(T.prototype,{then:function(ie,he){var Te=U(u(this,T));return Te.ok=typeof ie=="function"?ie:!0,Te.fail=typeof he=="function"&&he,Te.domain=R?L.domain:void 0,this._c.push(Te),this._a&&this._a.push(Te),this._s&&_(this,!1),Te.promise},catch:function(ie){return this.then(void 0,ie)}}),F=function(){var ie=new V;this.promise=ie,this.resolve=t(we,ie,1),this.reject=t(le,ie,1)},v.f=U=function(ie){return ie===T||ie===j?new F(ie):B(ie)}),r(r.G+r.W+r.F*!O,{Promise:T}),RE()(T,b),BE()(b),j=ut()[b],r(r.S+r.F*!O,b,{reject:function(ie){var he=U(this),Te=he.reject;return Te(ie),he.promise}}),r(r.S+r.F*(i||!O),b,{resolve:function(ie){return w(i&&this===j?T:this,ie)}}),r(r.S+r.F*!(O&&UE()(function(ie){T.all(ie).catch(M)})),b,{all:function(ie){var he=this,Te=U(he),Fe=Te.resolve,Ge=Te.reject,Pe=y(function(){var ke=[],Me=0,_e=1;d(ie,!1,function(Ue){var Ce=Me++,Xe=!1;ke.push(void 0),_e++,he.resolve(Ue).then(function(Ft){Xe||(Xe=!0,ke[Ce]=Ft,--_e||Fe(ke))},Ge)}),--_e||Fe(ke)});return Pe.e&&Ge(Pe.v),Te.promise},race:function(ie){var he=this,Te=U(he),Fe=Te.reject,Ge=y(function(){d(ie,!1,function(Pe){he.resolve(Pe).then(Te.resolve,Fe)})});return Ge.e&&Fe(Ge.v),Te.promise}}),wC}var AC={},NC;function gO(){if(NC)return AC;NC=1;var i=Ot(),e=ut(),t=Nr(),n=t2(),r=r2();return i(i.P+i.R,"Promise",{finally:function(s){var a=n(this,e.Promise||t.Promise),l=typeof s=="function";return this.then(l?function(d){return r(a,s()).then(function(){return d})}:s,l?function(d){return r(a,s()).then(function(){throw d})}:s)}}),AC}var VC={},OC;function mO(){if(OC)return VC;OC=1;var i=Ot(),e=Cv(),t=n2();return i(i.S,"Promise",{try:function(n){var r=e.f(this),s=t(n);return(s.e?r.reject:r.resolve)(s.v),r.promise}}),VC}var BC,_C;function vO(){return _C||(_C=1,Io(),ra(),fO(),gO(),mO(),BC=ut().Promise),BC}var FC,UC;function yO(){return UC||(UC=1,FC={default:vO(),__esModule:!0}),FC}var SO=yO();const xt=Qe(SO);/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class bO{constructor(){this.name="CancellationError",this.message="CANCELED"}toString(){return"CANCELED"}}const ms=new bO;function wO(i){if(i.isCanceled===!0)throw ms}const Pg=()=>{},Vt={isCanceled:!1,add:()=>Pg,remove:Pg};class ks{cancel(){const e=this.handlers;if(e!==null&&(this.handlers=null,e!==void 0))for(let t of e)t()}get isCanceled(){return this.handlers===null}add(e){let t=this.handlers;return t===null?(e(),Pg):(t===void 0&&(t=this.handlers=new $e),t.add(e),()=>{this.remove(e)})}remove(e){this.handlers?.delete(e)}}class CO extends ks{constructor(){super(...arguments),this.consumers=new $e}addConsumer(e=Vt){const t=this.consumers;t.has(e)||e.isCanceled||(t.add(e),e.add(()=>{t.delete(e),t.size===0&&this.cancel()}))}}function xO(i,e){return new xt((t,n)=>{if(i===Vt){e(t,n,Vt);return}const r=new ks,s=i.add(()=>{r.cancel()});e(a=>{s(),t(a)},a=>{s(),n(a)},r)})}const s2=!(typeof Window<"u"&&self instanceof Window),Ig="rpc.promise.response",a2="rpc.promise.cancel";var o2=new ce;function Et(i,e){o2.set(i,e)}class kO extends Error{constructor(e,t){super(t),this.name=e,this.message=t}}function l2(i,e){Et(i,function(t){let n=t.id;const r=new ks;let s=e.call(this,t,r);this.set(n,{promise:s,cancellationToken:r}),s.then(({value:a,transfers:l})=>{this.delete(n),this.invoke(Ig,{id:n,value:a},l)},a=>{this.delete(n),this.invoke(Ig,{id:n,error:a.message,errorName:a.name})})})}Et(a2,function(i){let e=i.id;const t=this.get(e);t!==void 0&&t.cancellationToken.cancel()});Et(Ig,function(i){let e=i.id;var t=this.get(e);let n=t.resolve,r=t.reject;this.delete(e),i.hasOwnProperty("value")?n(i.value):i.errorName===ms.name?r(ms):r(new kO(i.errorName,i.error))});const EO=s2?-1:0;class LO{constructor(e){this.target=e,this.objects=new ce,this.nextId=EO,e.onmessage=t=>{let n=t.data;o2.get(n.functionName).call(this,n)}}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,n=this.get(t);return n.referencedGeneration=e.gen,n.addRef(),n}getOptionalRef(e){if(e===void 0)return;let t=e.id,n=this.get(t);return n.referencedGeneration=e.gen,n.addRef(),n}invoke(e,t,n){t.functionName=e,this.target.postMessage(t,n)}promiseInvoke(e,t,n=Vt,r){return xO(n,(s,a,l)=>{const d=t.id=this.newId();this.set(d,{resolve:s,reject:a}),this.invoke(e,t,r),l.add(()=>{this.invoke(a2,{id:d})})})}newId(){return s2?this.nextId--:this.nextId++}}class er extends Y{constructor(){super(...arguments),this.rpc=null,this.rpcId=null}initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){this.isOwner===!0?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():this.isOwner===!1?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){let e=this.rpc,t=this.rpcId;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,this.refCount===0&&e===this.referencedGeneration&&this.ownerDispose()}}function TO(i,e,t={}){e!=null&&i.initializeSharedObject(e,t.id)}class sh extends er{constructor(e,t={}){super(),TO(this,e,t)}}Et("SharedObject.dispose",function(i){let e=this.get(i.id);if(e.refCount!==0)throw new Error("Attempted to dispose object with non-zero reference count.");e.disposed(),this.delete(e.rpcId),e.rpcId=null,e.rpc=null});const DO="Worker";Et(DO,function(i){const e=i.port,t=i.path;new Worker(t).postMessage({port:e},[e])});Et("SharedObject.refCountReachedZero",function(i){let e=this.get(i.id),t=i.gen;e.counterpartRefCountReachedZero(t)});const c2=new ce;function hn(i){return e=>{e.prototype.RPC_TYPE_ID=i}}function ah(i){return e=>{if(i!==void 0)e.prototype.RPC_TYPE_ID=i;else if(i=e.prototype.RPC_TYPE_ID,i===void 0)throw new Error("RPC_TYPE_ID should have already been defined");c2.set(i,e)}}Et("SharedObject.new",function(i){let e=this,t=i.type,n=c2.get(t),r=new n(e,i);--r.refCount});/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var PO=function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=An(e,t):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(a=i[l])&&(s=(r<3?a(s):r>3?a(e,t,s):a(e,t))||s);return r>3&&s&&Mn(e,t,s),s},Hd;const d2="SharedWatchableValue.changed";let gi=Hd=class extends sh{constructor(i,e={}){super(i,e),this.updatingValue_=!1,i!==void 0&&(this.base=new ct(e.value),this.setupChangedHandler())}initializeCounterpart(i,e={}){e.value=this.value,super.initializeCounterpart(i,e)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{const i=this.rpc;i!==null&&i.invoke(d2,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(i,e){let t=new Hd;return t.base=e,t.setupChangedHandler(),t.initializeCounterpart(i),t}static make(i,e){return Hd.makeFromExisting(i,new ct(e))}get value(){return this.base.value}set value(i){this.base.value=i}get changed(){return this.base.changed}};gi=Hd=PO([ah("SharedWatchableValue")],gi);Et(d2,function(i){const e=this.get(i.id);e.updatingValue_=!0,e.base.value=i.value,e.updatingValue_=!1});class Nt extends ct{constructor(e=Number.NEGATIVE_INFINITY){super(e)}get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}}Nt.VISIBLE=Number.POSITIVE_INFINITY;Nt.IGNORED=Number.NEGATIVE_INFINITY;class Kl extends Nt{constructor(){super(...arguments),this.contributors=new ce}add(e){const t=this.contributors,n=e.changed.add(()=>{this.update()}),r=()=>{t.delete(r),n(),this.update()};return t.set(r,e),this.update(),r}update(){let e=Number.NEGATIVE_INFINITY;for(const t of this.contributors.values())e=Math.max(e,t.value);this.value=e}}function oh(i){return class extends i{constructor(){super(...arguments),this.visibility=new Kl}initializeCounterpart(e,t={}){t.visibility=this.registerDisposer(gi.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var IO=function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=An(e,t):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(a=i[l])&&(s=(r<3?a(s):r>3?a(e,t,s):a(e,t))||s);return r>3&&s&&Mn(e,t,s),s},RO=function(i,e){var t={};for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&e.indexOf(n)<0&&(t[n]=i[n]);if(i!=null&&typeof fC=="function")for(var r=0,n=fC(i);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(i,n[r])&&(t[n[r]]=i[n[r]]);return t},un;(function(i){i[i.DATA=0]="DATA",i[i.ANNOTATION=1]="ANNOTATION",i[i.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION"})(un||(un={}));function MO(){return new EN([un.DATA,un.ANNOTATION,un.DEFAULT_ANNOTATION])}class u2 extends Y{constructor(){super(...arguments),this.role=un.DATA,this.messages=new Vo,this.layerChanged=new be,this.redrawNeeded=new be,this.layerChunkProgressInfo=new bv}handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,n,r){}}class h2 extends u2{constructor(){super(...arguments),this.visibility=new Kl}attach(e){}}function hu(i,e,t){let n=t.state;if(n===void 0||n.transform!==i||n.displayDimensionRenderInfo!==e){if(t.messages.clearMessages(),n=t.state={transform:i,displayDimensionRenderInfo:e,modelTransform:void 0},i.error!==void 0){t.messages.addMessage({severity:Yn.error,message:i.error});return}try{const r=Je();G3(r,e,i),n.modelTransform=r}catch(r){t.messages.addMessage({severity:Yn.error,message:r.message})}}return n.modelTransform}class p2 extends Y{constructor(e){super(),this.renderViewport=new wv,this.changed=new Ze;var t=e.parametersConstructor;const n=t===void 0?QL:t,r=e.navigationState,s=e.update;var a=e.isEqual;const l=a===void 0?aO:a;this.oldValue_=new n,this.value_=new n;const d=()=>{const h=this.oldValue_,g=this.value_;h.displayDimensionRenderInfo=r.displayDimensionRenderInfo.value,H(h,this.renderViewport);let v=h.globalPosition;const y=r.position.value,C=y.length;v.length!==C&&(h.globalPosition=v=new Float32Array(C)),v.set(y),s(h,r),!l(h,g)&&(this.value_=h,this.oldValue_=g,this.changed.dispatch(g,h))},u=this.update=this.registerCancellable(nt(d,0));this.registerDisposer(r.changed.add(u)),d()}setViewport(e){KL(e,this.renderViewport)||(H(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}}let pu=class extends er{constructor(i,e,t=10){super(),this.base=e,this.updateInterval=t,this.prevDisplayDimensionRenderInfo=void 0,this.update=this.registerCancellable(nt((n,r)=>{let s;r.displayDimensionRenderInfo!==this.prevDisplayDimensionRenderInfo?(s=r,this.prevDisplayDimensionRenderInfo=r.displayDimensionRenderInfo):(r.displayDimensionRenderInfo,s=RO(r,["displayDimensionRenderInfo"])),this.rpc.invoke(dO,{id:this.rpcId,value:s})},this.updateInterval)),this.initializeCounterpart(i,{value:e.value}),this.registerDisposer(e.changed.add(this.update))}flush(){this.update.flush()}};pu=IO([hn(cO)],pu);/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class _t{constructor(e,t=e){this.value_=e,this.defaultValue=t,this.changed=new be}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}toJSON(){if(this.value_!==this.defaultValue)return this.value_}restoreState(e){if(e===!0||e===!1){this.value=e;return}this.value=this.defaultValue}reset(){this.value=this.defaultValue}}class Es extends Y{constructor(e,t={}){super(),this.model=e,this.element=document.createElement("input");let n=this.element;n.type="checkbox";const r=()=>{var s;const a=this.model.value;this.element.checked=a,(t.enableTitle!==void 0||t.disableTitle!==void 0)&&(this.element.title=(s=a?t.enableTitle:t.disableTitle)!==null&&s!==void 0?s:"")};this.registerDisposer(e.changed.add(r)),r(),this.registerEventListener(n,"change",function(s){e.value=this.checked}),n.addEventListener("mousedown",s=>{s.preventDefault()})}disposed(){let e=this.element,t=e.parentElement;t&&t.removeChild(e),super.disposed()}}class en extends Y{constructor(e,t){super(),this.model=e,this.element=t,this.initialDisplay=this.element.style.display,this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable(nt(()=>this.updateVisibility(),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}}/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function f2(i){try{return i()}catch(e){return{error:e.message}}}function AO(i){if(i.error!==void 0)throw new Error(i.error);return i}class xv extends Y{constructor(e,t){if(super(),this.register=e,this.changed=new be,this.disposerMap=new ce,t===void 0)this.map=new ce;else{const r=this.map=new ce(t),s=this.disposerMap;for(const a of r){var n=ae(a,2);const l=n[0],d=n[1],u=new Y;s.set(l,u),e(u,d,l)}}}get value(){return this.map}set(e,t){const n=this.map,r=this.disposerMap;let s=r.get(e);return s!==void 0&&s.dispose(),s=new Y,r.set(e,s),n.set(e,t),this.register(s,t,e),this.changed.dispatch(),this}delete(e){const t=this.map,n=this.disposerMap,r=n.get(e);return r!==void 0?(r.dispose(),n.delete(e),t.delete(e),this.changed.dispatch(),!0):!1}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[Mi](){return ev(this.map)}clear(){const e=this.map,t=this.disposerMap;if(e.size>0){for(const n of t.values())n.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){const e=this.map,t=this.disposerMap;for(const n of t.values())n.dispose();e.clear(),t.clear(),super.disposed()}}var NO=tA();const Xi=Qe(NO);/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const zC=Xi("objectId");let VO=0;function oi(i){if(i instanceof Object){let e=i[zC];return e===void 0&&(e=i[zC]=VO++),`o${e}`}else return""+re(i)}var Rg;(function(i){i[i.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",i[i.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT"})(Rg||(Rg={}));function OO(i){i=i.replace("\0","");let e=[];for(let t of i.split(`
`)){let n=t.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);n!==null?e.push({message:n[3].trim(),file:parseInt(n[1],10),line:parseInt(n[2],10)}):(n=t.match(/^ERROR:\s*(.+)$/),n!==null?e.push({message:n[1]}):(t=t.trim(),t&&e.push({message:t})))}return e}class BO extends Error{constructor(e,t,n,r){const s=`Error compiling ${Rg[e].toLowerCase()} shader: ${n}`;super(s),this.name="ShaderCompilationError",this.log=n,this.message=s,this.shaderType=e,this.source=t,this.errorMessages=r}}class _O extends Error{constructor(e,t,n){const r=`Error linking shader: ${n}`;super(r),this.name="ShaderLinkError",this.log=n,this.message=r,this.vertexSource=e,this.fragmentSource=t}}function $C(i,e,t){var n=i.createShader(t);if(i.shaderSource(n,e),i.compileShader(n),!i.getShaderParameter(n,i.COMPILE_STATUS)){let r=i.getShaderInfoLog(n)||"";throw new BO(t,e,r,OO(r))}return n}class FO extends Y{constructor(e,t,n,r,s,a){super(),this.gl=e,this.vertexSource=t,this.fragmentSource=n,this.attributes=new ce,this.uniforms=new ce,this.vertexShaderInputBinders={};let l=this.vertexShader=$C(e,t,e.VERTEX_SHADER),d=this.fragmentShader=$C(e,n,e.FRAGMENT_SHADER),u=e.createProgram();if(e.attachShader(u,l),e.attachShader(u,d),e.linkProgram(u),!e.getProgramParameter(u,e.LINK_STATUS)){let v=e.getProgramInfoLog(u)||"";throw new _O(t,n,v)}this.program=u;let h=this.uniforms,g=this.attributes;if(r)for(let v of r)h.set(v,e.getUniformLocation(u,v));if(s)for(let v of s)g.set(v,e.getAttribLocation(u,v))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){this.gl.useProgram(this.program)}disposed(){let e=this.gl;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0}}function UO(i,e,t,n,r){i.drawArraysInstanced(e,t,n,r)}class GC{constructor(){this.code="",this.parts=new $e}add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(Array.isArray(e))for(let t of e)this.add(t);else throw console.log("Invalid code type",e),new Error("Invalid code type")}}toString(){return this.code}}const Mg={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D};class ea{constructor(e){this.gl=e,this.nextSymbolID=0,this.nextTextureUnit=0,this.uniformsCode="",this.attributesCode="",this.varyingsCodeVS="",this.varyingsCodeFS="",this.fragmentExtensionsSet=new $e,this.fragmentExtensions="",this.vertexCode=new GC,this.vertexMain="",this.fragmentCode=new GC,this.outputBufferCode="",this.fragmentMain="",this.required=new $e,this.uniforms=new Array,this.attributes=new Array,this.initializers=[],this.textureUnits=new ce,this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e,t=1){if(this.textureUnits.has(e))throw new Error("Duplicate texture unit symbol: "+e.toString());let n=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,n),n}addTextureSampler(e,t,n,r){let s=this.allocateTextureUnit(n,r);return this.addUniform(`highp ${e}`,t,r),this.addInitializer(a=>{if(r){let l=new Int32Array(r);for(let d=0;d<r;++d)l[d]=d+s;a.gl.uniform1iv(a.uniform(t),l)}else a.gl.uniform1i(a.uniform(t),s)}),s}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,n){return this.attributes.push(t),n!==void 0&&(this.attributesCode+=`layout(location = ${n})`),this.attributesCode+=`in ${e} ${t};
`,t}addVarying(e,t,n=""){this.varyingsCodeVS+=`${n} out ${e} ${t};
`,this.varyingsCodeFS+=`${n} in ${e} ${t};
`}addOutputBuffer(e,t,n){n!==null&&(this.outputBufferCode+=`layout(location = ${n}) `),this.outputBufferCode+=`out ${e} ${t};
`}addUniform(e,t,n){return this.uniforms.push(t),n!=null?this.uniformsCode+=`uniform ${e} ${t}[${n}];
`:this.uniformsCode+=`uniform ${e} ${t};
`,t}addFragmentExtension(e){this.fragmentExtensionsSet.has(e)||(this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require
`)}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {
${e}
}
`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){this.required.has(e)||(this.required.add(e),e(this))}build(){let e=`#version 300 es
precision highp float;
precision highp int;
${this.uniformsCode}
${this.attributesCode}
${this.varyingsCodeVS}
${this.vertexCode}
void main() {
${this.vertexMain}
}
`,t=`#version 300 es
${this.fragmentExtensions}
precision highp float;
precision highp int;
${this.uniformsCode}
${this.varyingsCodeFS}
${this.outputBufferCode}
${this.fragmentCode}
${this.fragmentMain}
`,n=new FO(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);n.textureUnits=this.textureUnits;let r=this.initializers;if(r.length>0){n.bind();for(let s of r)s(n)}return n}}function lh(){return new ct(void 0)}function kv(i){return new Jt(i,Le)}function Ev(i,e,t){const n=new ce,r=t.parameters,s=t.fallbackParameters,a=t.shaderError;var l=t.encodeParameters;const d=l===void 0?P=>P:l;var u=t.extraParameters;const h=u===void 0?Zs(void 0):u;var g=t.encodeExtraParameters;const v=g===void 0?P=>P:g,y=t.getContextKey,C=t.defineShader;a!==void 0&&(a.value=void 0);var w=t.encodeContext;const b=w===void 0?y:w,k=ln(t.memoizeKey);function L(P,T,R){const M=re({id:k,context:b(P),parameters:d(T),extraParameters:v(R)});return e.memoize.get(M,()=>{const V=new ea(e);return C(V,P,T,R),V.build()})}function I(P){const T=y(P);let R=n.get(T);R===void 0&&(R={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:r.value,extraParameters:h.value},n.set(T,R));const M=r.changed.count,V=h.changed.count;if(M===R.parametersGeneration&&V===R.extraParametersGeneration)return R;const B=R.parameters=r.value,F=R.extraParameters=h.value,j=R.shader;R.parametersGeneration=M,R.extraParametersGeneration=V;let U=null;try{U=L(P,B,F),R.fallback=!1,s!==void 0&&(s.value=B),a!==void 0&&(a.value=null)}catch(O){if(a!==void 0&&(a.value=O),s!==void 0)try{const $=s.value;U=L(P,$,F),R.parameters=$,R.fallback=!0}catch{}}return j!==null&&j.dispose(),R.shader=U,R}return i.registerDisposer(()=>{for(const P of n.values()){const T=P.shader;T!==null&&T.dispose()}}),I}function ho(i,e,t){return Ev(i,e,H(H({},t),{getContextKey:n=>n,encodeContext:n=>oi(n),defineShader:(n,r,s,a)=>(n.require(r),t.defineShader(n,s,a))}))}function Yl(i,e=1,t=0){return`
#line ${t} ${e}
`+i}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class Ui{constructor(e,t=WebGL2RenderingContext.ARRAY_BUFFER){this.gl=e,this.bufferType=t,this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t,n=WebGL2RenderingContext.FLOAT,r=!1,s=0,a=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,n,r,s,a)}bindToVertexAttribI(e,t,n=WebGL2RenderingContext.UNSIGNED_INT,r=0,s=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,n,r,s)}setData(e,t=WebGL2RenderingContext.STATIC_DRAW){let n=this.gl;this.bind(),n.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,n,r){let s=new Ui(e,n);return s.setData(t,r),s}}function Zl(i,e,t,...n){return i.memoize.get(ln({id:"getMemoizedBuffer",getter:oi(t),args:n}),()=>{const r=new HE(Ui.fromData(i,t(...n),e,WebGL2RenderingContext.STATIC_DRAW));return r.registerDisposer(r.value),r})}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function zO(i=-1,e=-1,t=1,n=1,r=1,s=1){return og(new Float32Array([i,e,i,n,t,n,t,e]),2,r,s)}function Ql(i,e=-1,t=-1,n=1,r=1,s=1,a=1){return Zl(i,WebGL2RenderingContext.ARRAY_BUFFER,zO,e,t,n,r,s,a).value}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function po(i){i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function $O(i){i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE)}function GO(i,e,t,n,r=WebGL2RenderingContext.RGBA8,s=WebGL2RenderingContext.RGBA,a=WebGL2RenderingContext.UNSIGNED_BYTE){i.activeTexture(WebGL2RenderingContext.TEXTURE0+i.tempTextureUnit),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),po(i),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,r,t,n,0,s,a,null),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function WO(i,e,t){i.activeTexture(WebGL2RenderingContext.TEXTURE0+i.tempTextureUnit),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),i.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,t),i.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function g2(i){i.addOutputBuffer("vec4","v4f_fragColor",null),i.setFragmentMain("v4f_fragColor = getValue0();")}function HO(i,e=g2,t=1){return i.memoize.get(`elementWiseTextureShader:${t}:${oi(e)}`,()=>{let n=new ea(i);n.addVarying("vec2","vTexCoord"),n.addUniform("sampler2D","uSampler",t),n.addInitializer(r=>{let s=[];for(let a=0;a<t;++a)s[a]=a;i.uniform1iv(r.uniform("uSampler"),s)});for(let r=0;r<t;++r)n.addFragmentCode(`
vec4 getValue${r}() {
  return texture(uSampler[${r}], vTexCoord);
}
`);return n.addUniform("mat4","uProjectionMatrix"),n.require(e),n.addAttribute("vec4","aVertexPosition"),n.addAttribute("vec2","aTexCoord"),n.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),n.build()})}function jO(i){return i.memoize.get("trivialColorShader",()=>{let e=new ea(i);return e.addVarying("vec4","vColor"),e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = vColor;"),e.addAttribute("vec4","aVertexPosition"),e.addAttribute("vec4","aColor"),e.addUniform("mat4","uProjectionMatrix"),e.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),e.build()})}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class m2 extends Y{constructor(){super(...arguments),this.width=Number.NaN,this.height=Number.NaN}hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){this.hasSize(e,t)||(this.width=e,this.height=t,this.performResize())}}class qO extends m2{constructor(e,t){super(),this.gl=e,this.internalformat=t,this.renderbuffer=null,this.renderbuffer=e.createRenderbuffer()}performResize(){let e=this.gl;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){let t=this.gl;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}}class JO extends qO{constructor(e,t=!1){super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16),this.gl=e,this.includeStencilBuffer=t}attachToFramebuffer(){let e=this.gl;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}}class XO extends JO{constructor(e){super(e,!0)}}class KO extends Y{constructor(e){super(),this.gl=e,this.framebuffer=this.gl.createFramebuffer()}disposed(){this.gl.deleteFramebuffer(this.framebuffer)}bind(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}}class Xs extends m2{constructor(e,t,n,r){super(),this.gl=e,this.internalFormat=t,this.format=n,this.dataType=r,this.texture=e.createTexture()}performResize(){GO(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){let t=this.gl;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}}class YO extends Xs{constructor(e,t=WebGL2RenderingContext.DEPTH_COMPONENT16,n=WebGL2RenderingContext.DEPTH_COMPONENT,r=WebGL2RenderingContext.UNSIGNED_SHORT){super(e,t,n,r)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}}function fu(i,e,t=WebGL2RenderingContext.RGBA8,n=WebGL2RenderingContext.RGBA,r=WebGL2RenderingContext.UNSIGNED_BYTE){let s=new Array;for(let a=0;a<e;++a)s[a]=new Xs(i,t,n,r);return s}class fo extends Y{constructor(e,t){super(),this.gl=e,this.width=Number.NaN,this.height=Number.NaN,this.fullAttachmentList=new Array,this.attachmentVerified=!1,this.singleAttachmentList=[this.gl.COLOR_ATTACHMENT0];var n=t.framebuffer;let r=n===void 0?new KO(e):n,s=t.colorBuffers,a=t.depthBuffer;this.framebuffer=this.registerDisposer(r),this.colorBuffers=s,this.depthBuffer=a,a!==void 0&&this.registerDisposer(a);let l=this.fullAttachmentList;s.forEach((d,u)=>{this.registerDisposer(d),l[u]=e.COLOR_ATTACHMENT0+u})}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();let n=this.gl,r=this.depthBuffer;r!==void 0?(r.resize(e,t),r.attachToFramebuffer()):n.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach((s,a)=>{s.resize(e,t),s.attachToFramebuffer(n.COLOR_ATTACHMENT0+a)}),n.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),n.viewport(0,0,e,t)}bindSingle(e){let t=this.gl;this.framebuffer.bind(),e!==0&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,n,r,s=1,a=1){let l=this.gl;try{this.bindSingle(e),l.readPixels(t,n,s,a,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,r)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;let e=this.gl,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}}class go extends Y{constructor(e,t){super(),this.gl=e,this.shader=t,this.copyVertexPositionsBuffer=Ql(this.gl),this.copyTexCoordsBuffer=Ql(this.gl,0,0,1,1),this.registerDisposer(t)}draw(...e){let t=this.gl,n=this.shader;n.bind();let r=e.length;for(let l=0;l<r;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,e[l]);t.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,sL);let s=n.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(s,2);let a=n.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(a,2),t.drawArrays(t.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(s),t.disableVertexAttribArray(a);for(let l=0;l<r;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,null)}static get(e,t=g2,n=1){return e.memoize.get(`OffscreenCopyHelper:${n}:${oi(t)}`,()=>new go(e,HO(e,t,n)))}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const ZO=`
float mixLinear(float x, float y, float a) { return mix(x, y, a); }
`;var QO=`
vec3 hueToRgb(float hue) {
  float hue6 = hue * 6.0;
  float r = abs(hue6 - 3.0) - 1.0;
  float g = 2.0 - abs(hue6 - 2.0);
  float b = 2.0 - abs(hue6 - 4.0);
  return clamp(vec3(r, g, b), 0.0, 1.0);
}
vec3 hsvToRgb(vec3 c) {
  vec3 hueRgb = hueToRgb(c.x);
  return c.z * ((hueRgb - 1.0) * c.y + 1.0);
}
`;const Dt=`
struct uint64_t {
  highp uvec2 value;
};
struct uint64x2_t {
  highp uvec4 value;
};
uint64_t mixLinear(uint64_t x, uint64_t y, float a) {
  return x;
}
uint64_t toUint64(uint64_t x) { return x; }
`,eB=[Dt,`
uint64_t unpackUint64leFromUint32(highp uvec2 x) {
  uint64_t result;
  result.value = x;
  return result;
}
uint64x2_t unpackUint64leFromUint32(highp uvec4 x) {
  uint64x2_t result;
  result.value = x;
  return result;
}
`],v2=[Dt,`
bool equals(uint64_t a, uint64_t b) {
  return a.value == b.value;
}
`],ch=[Dt,`
bool compareLessThan(uint64_t a, uint64_t b) {
  return (a.value[1] < b.value[1])||
         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);
}
`],y2=[Dt,`
uint64_t subtract(uint64_t a, uint64_t b) {
  if (a.value[0] < b.value[0]) {
    --a.value[1];
  }
  a.value -= b.value;
  return a;
}
`],tB=[Dt,`
uint64_t add(uint64_t a, uint64_t b) {
  a.value[0] += b.value[0];
  if (a.value[0] < b.value[0]) {
    ++a.value[1];
  }
  a.value[1] += b.value[1];
  return a;
}
`],iB=[tB,ch,`
uint64_t addSaturate(uint64_t a, uint64_t b) {
  a = add(a, b);
  if (compareLessThan(a, b)) {
    a.value = uvec2(0xffffffffu, 0xffffffffu);
  }
  return a;
}
`],nB=[y2,ch,`
uint64_t subtractSaturate(uint64_t a, uint64_t b) {
  b = subtract(a, b);
  if (compareLessThan(a, b)) {
    b.value = uvec2(0u, 0u);
  }
  return b;
}
`],S2=[Dt,`
uint64_t shiftRight(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));
  }
}
`],rB=[Dt,`
uint64_t shiftLeft(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));
  }
}
`],b2=[Dt,`
struct uint8_t {
  highp uint value;
};
struct uint8x2_t {
  highp uvec2 value;
};
struct uint8x3_t {
  highp uvec3 value;
};
struct uint8x4_t {
  highp uvec4 value;
};
uint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {
  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint8_t x) { return x.value; }
highp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }
highp uvec2 toRaw(uint8x2_t x) { return x.value; }
highp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }
highp uvec3 toRaw(uint8x3_t x) { return x.value; }
vec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }
highp uvec4 toRaw(uint8x4_t x) { return x.value; }
vec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }
uint64_t toUint64(uint8_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint8_t uint8FromFloat(highp float x) {
  return uint8_t(uint(clamp(x, 0.0, 255.0)));
}
`],w2=[Dt,`
struct int8_t {
  highp int value;
};
struct int8x2_t {
  highp ivec2 value;
};
struct int8x3_t {
  highp ivec3 value;
};
struct int8x4_t {
  highp ivec4 value;
};
int8_t mixLinear(int8_t x, int8_t y, highp float a) {
  return int8_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int8_t x) { return x.value; }
highp ivec2 toRaw(int8x2_t x) { return x.value; }
highp ivec3 toRaw(int8x3_t x) { return x.value; }
highp ivec4 toRaw(int8x4_t x) { return x.value; }
uint64_t toUint64(int8_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int8_t int8FromFloat(highp float x) {
  return int8_t(int(clamp(x, -128.0, 127.0)));
}
`],Lv=`
highp float toRaw(highp float x) { return x; }
highp float toNormalized(highp float x) { return x; }
vec2 toRaw(vec2 x) { return x; }
vec2 toNormalized(vec2 x) { return x; }
vec3 toRaw(vec3 x) { return x; }
vec3 toNormalized(vec3 x) { return x; }
vec4 toRaw(vec4 x) { return x; }
vec4 toNormalized(vec4 x) { return x; }
`,C2=[Dt,`
struct uint16_t {
  highp uint value;
};
struct uint16x2_t {
  highp uvec2 value;
};
uint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {
  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint16_t x) { return x.value; }
highp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }
highp uvec2 toRaw(uint16x2_t x) { return x.value; }
highp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }
uint64_t toUint64(uint16_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint16_t uint16FromFloat(highp float x) {
  return uint16_t(uint(clamp(x, 0.0, 65535.0)));
}
`],x2=[Dt,`
struct int16_t {
  highp int value;
};
struct int16x2_t {
  highp ivec2 value;
};
int16_t mixLinear(int16_t x, int16_t y, highp float a) {
  return int16_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int16_t x) { return x.value; }
highp ivec2 toRaw(int16x2_t x) { return x.value; }
uint64_t toUint64(int16_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int16_t int16FromFloat(highp float x) {
  return int16_t(int(clamp(x, -32768.0, 32767.0)));
}
`],Tv=[Dt,`
struct uint32_t {
  highp uint value;
};
uint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {
  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }
highp uint toRaw(uint32_t x) { return x.value; }
uint64_t toUint64(uint32_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint32_t uint32FromFloat(highp float x) {
  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));
}
`],k2=[Dt,`
struct int32_t {
  highp int value;
};
int32_t mixLinear(int32_t x, int32_t y, highp float a) {
  return int32_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int32_t x) { return x.value; }
uint64_t toUint64(int32_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int32_t int32FromFloat(highp float x) {
  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));
}
`];var sB=`
highp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {
  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);
}
`;const aB=`
highp uint log2Exact(highp uint i) {
  highp uint r;
  r = uint((i & 0xAAAAAAAAu) != 0u);
  r |= uint((i & 0xFFFF0000u) != 0u) << 4;
  r |= uint((i & 0xFF00FF00u) != 0u) << 3;
  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;
  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;
  return r;
}
`,oB=`
bool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {
  highp float tmin = 0.0, tmax = 1.0;
  highp float k1 = b.w - a.w + a.z - b.z;
  highp float k2 = a.w - b.w + a.z - b.z;
  highp float q1 = (a.z - a.w) / k1;
  highp float q2 = (a.z + a.w) / k2;
  if (k1 > 0.0) tmin = max(tmin, q1);
  else if (k1 < 0.0) tmax = min(tmax, q1);
  if (k2 > 0.0) tmax = min(tmax, q2);
  else if (k2 < 0.0) tmin = max(tmin, q2);
  if (tmin <= tmax) {
    highp vec4 tempA = a;
    highp vec4 tempB = b;
    a = mix(tempA, tempB, tmin);
    b = mix(tempA, tempB, tmax);
    return true;
  }
  return false;
}
`,lB=`
highp float simpleFloatHash(highp vec2 co) {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}
`,cB=`
highp uint shiftLeftSaturate(highp uint x, int shiftAmount) {
  highp uint result = x << shiftAmount;
  if ((result >> shiftAmount) != x) return 0xffffffffu;
  return result;
}
`,Dv=`
highp uint addSaturate(highp uint x, highp uint y) {
  highp uint result = x + y;
  if (result < x) return 0xffffffffu;
  return result;
}
`,dB=`
highp uint subtractSaturate(highp uint x, highp uint y) {
  highp uint result = x - y;
  if (result > x) return 0u;
  return result;
}
`,uB=[Dv,`
highp int addSaturate(highp int x, highp uint y) {
  if (x >= 0) {
    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));
  } else if (y >= uint(-x)) {
    return int(min(y - uint(-x), 0x7fffffffu));
  } else {
    return -int(min(uint(-x) - y, 0x80000000u));
  }
}
`],hB=[Dv,`
highp int subtractSaturate(highp int x, highp uint y) {
  if (x < 0) {
    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));
  } else if (uint(x) >= y) {
    return x - int(y);
  } else {
    return -int(min(y - uint(x), 0x80000000u));
  }
}
`];function si(i,e=1){switch(i){case q.FLOAT32:if(e===1)return"float";if(e>1&&e<=4)return`vec${e}`;break;case q.UINT8:case q.INT8:case q.UINT16:case q.INT16:case q.UINT32:case q.INT32:case q.UINT64:{const t=fL[i]?"":"u",n=rV[i]*8;if(e===1)return`${t}int${n}_t`;if(e>1&&e*n<=32)return`${t}int${n}x${e}_t`;break}}throw new Error(`No shader type for ${q[i]}[${e}].`)}const Oo={[q.UINT8]:b2,[q.INT8]:w2,[q.UINT16]:C2,[q.INT16]:x2,[q.UINT32]:Tv,[q.INT32]:k2,[q.UINT64]:Dt,[q.FLOAT32]:Lv};function pB(i,e){return e===1?i:`vec${e}`}const fB={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function bc(i,e,t,n,r,s,a=1){let l=0,d=s*a;for(;d>0;){const g=Math.min(4,d),v=pB(e,g);d-=g,i.addAttribute("highp "+v,`a${r}${l}`),++l}d=s*a;let u="";for(let g=0;g<a;++g){u+=`highp ${e}[${s}] get${r}${g}() {
  highp ${e}[${s}] result;
`;for(let v=0;v<s;++v){const y=g*s+v,C=Math.floor(y/4),w=y%4;u+=`  result[${v}] = a${r}${C}`,(w!==0||y!==d-1)&&(u+=`[${w}]`),u+=`;
`}u+=`  return result;
`,u+=`}
`}i.addVertexCode(u);const h=fB[t];i.addInitializer(g=>{const v=[];for(let y=0;y<l;++y)v[y]=g.attribute(`a${r}${y}`);g.vertexShaderInputBinders[r]={enable(y){const C=g.gl;for(let w=0;w<l;++w){const b=v[w];C.enableVertexAttribArray(b),C.vertexAttribDivisor(b,y)}},disable(){const y=g.gl;for(let C=0;C<l;++C){const w=v[C];y.vertexAttribDivisor(w,0),y.disableVertexAttribArray(w)}},bind(y,C){const w=g.gl;for(let b=0;b<l;++b){const k=v[b],L=Math.min(4,d-4*b);w.vertexAttribPointer(k,L,t,n,y,C),C+=h*L}}}})}class E2 extends Y{constructor(e,t,n=new Kl){super(),this.channels=e,this.bounds=t,this.visibility=n,this.framebuffers=[],this.producerVisibility=new Kl,this.frameNumber=-1}getFramebuffers(e){const t=this.framebuffers;for(;t.length<this.channels.value.length;){const n=new fo(e,{colorBuffers:fu(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(n)}return t}disposed(){for(const e of this.framebuffers)e.dispose();this.framebuffers.length=0}}const WC=Xi("histogramDataSamplerTextureUnit"),HC=Xi("histogramDepthTextureUnit"),xf=4096,gB=2**14;class Pv extends Y{constructor(e){super(),this.gl=e,this.shader=this.registerDisposer((()=>{const t=new ea(this.gl);return t.addOutputBuffer("vec4","outputValue",0),t.addAttribute("float","aInput1"),t.addTextureSampler("sampler2D","uDataSampler",WC),t.addTextureSampler("sampler2D","uDepthSampler",HC),t.addVertexCode(lB),t.setVertexMain(`
float uRandomSeed = 0.0;
vec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),
              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));
float dataValue = texture(uDataSampler, p).x;
float stencilValue = texture(uDepthSampler, p).x;
if (stencilValue == 1.0) {
  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
} else {
  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
}
gl_PointSize = 1.0;
`),t.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
`),t.build()})()),this.inputIndexBuffer=this.registerDisposer(Zl(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(xf)))}static get(e){return e.memoize.get("textureHistogramGeneration",()=>new Pv(e))}compute(e,t,n,r,s){const a=this.gl,l=this.shader,d=r.getFramebuffers(a);l.bind(),a.enable(WebGL2RenderingContext.BLEND),a.disable(WebGL2RenderingContext.SCISSOR_TEST),a.disable(WebGL2RenderingContext.DEPTH_TEST),a.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(l.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);const u=l.textureUnit(WC),h=l.textureUnit(HC);a.activeTexture(WebGL2RenderingContext.TEXTURE0+h),a.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),po(a),a.activeTexture(WebGL2RenderingContext.TEXTURE0+u);const g=r.frameNumber;r.frameNumber=s;for(let v=0;v<e;++v)a.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n[v].texture),po(a),d[v].bind(256,1),s!==g&&(a.clearColor(0,0,0,0),a.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),a.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,xf,gB/xf);a.disable(WebGL2RenderingContext.BLEND)}}const Iv={[q.UINT8]:"vec2",[q.INT8]:"vec2",[q.UINT16]:"vec2",[q.INT16]:"vec2",[q.FLOAT32]:"vec2",[q.UINT32]:"Uint32LerpParameters",[q.INT32]:"Int32LerpParameters",[q.UINT64]:"Uint64LerpParameters"},wc={[q.UINT8]:"",[q.INT8]:"",[q.UINT16]:"",[q.INT16]:"",[q.FLOAT32]:"",[q.UINT32]:`
struct Uint32LerpParameters {
  uint offset;
  int shift;
  float multiplier;
};
`,[q.INT32]:`
struct Int32LerpParameters {
  int offset;
  int shift;
  float multiplier;
};
`,[q.UINT64]:[Dt,`
struct Uint64LerpParameters {
  uint64_t offset;
  int shift;
  float multiplier;
};
`]};function Tl(i){let e=`
float computeInvlerp(${si(i)} inputValue, vec2 p) {
  float outputValue = float(toRaw(inputValue));
  outputValue = (outputValue - p[0]) * p[1];
  return outputValue;
}
`;return[Oo[i],e]}function jC(i){const e=si(i);let t=i===q.INT32?"int":"uint",n=Iv[i];return[Oo[i],wc[i],`
float computeInvlerp(${e} inputValue, ${n} p) {
  ${t} v = toRaw(inputValue);
  uint x;
  if (v >= p.offset) {
    x = uint(v - p.offset);
  } else {
    x = uint(p.offset - v);
    p.multiplier = -p.multiplier;
  }
  x >>= p.shift;
  return float(x) * p.multiplier;
}
`]}const mB={[q.UINT8]:Tl(q.UINT8),[q.INT8]:Tl(q.INT8),[q.UINT16]:Tl(q.UINT16),[q.INT16]:Tl(q.INT16),[q.FLOAT32]:Tl(q.FLOAT32),[q.UINT32]:jC(q.UINT32),[q.INT32]:jC(q.INT32),[q.UINT64]:[Dt,ch,y2,S2,wc[q.UINT64],`
float computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {
  if (compareLessThan(inputValue, p.offset)) {
    inputValue = subtract(p.offset, inputValue);
    p.multiplier = -p.multiplier;
  } else {
    inputValue = subtract(inputValue, p.offset);
  }
  uint shifted = shiftRight(inputValue, p.shift).value[0];
  return float(shifted) * p.multiplier;
}
`]};function Dl(i){let e=`
${si(i)} computeLerp(float inputValue, vec2 p) {
  inputValue = inputValue / p[1] + p[0];
`;return i===q.FLOAT32?e+=`return inputValue;
`:e+=`return ${q[i].toLowerCase()}FromFloat(round(inputValue));
`,e+=`
}
`,[Oo[i],e]}function qC(i){const e=si(i);let t=Iv[i];return[Oo[i],wc[i],cB,i===q.UINT32?Dv:uB,i===q.UINT32?dB:hB,`
${e} computeLerp(float inputValue, ${t} p) {
  inputValue = inputValue / p.multiplier;
  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));
  uint xShifted = shiftLeftSaturate(x, p.shift);
  if (inputValue >= 0.0) {
    return ${e}(addSaturate(p.offset, xShifted));
  } else {
    return ${e}(subtractSaturate(p.offset, xShifted));
  }
}
`]}const vB={[q.UINT8]:Dl(q.UINT8),[q.INT8]:Dl(q.INT8),[q.UINT16]:Dl(q.UINT16),[q.INT16]:Dl(q.INT16),[q.FLOAT32]:Dl(q.FLOAT32),[q.UINT32]:qC(q.UINT32),[q.INT32]:qC(q.INT32),[q.UINT64]:[Dt,ch,v2,iB,nB,S2,rB,wc[q.UINT64],`
uint64_t computeLerp(float inputValue, Uint64LerpParameters p) {
  inputValue = inputValue / p.multiplier;
  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));
  uint64_t shifted = shiftLeft(x, p.shift);
  if (!equals(shiftRight(shifted, p.shift), x)) {
    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));
  }
  if (inputValue >= 0.0) {
    return addSaturate(p.offset, shifted);
  } else {
    return subtractSaturate(p.offset, shifted);
  }
}
`]};function L2(i,e,t){const n=`uLerpParams_${e}`,r=`uLerpBounds_${e}`,s=`uLerpScalar_${e}`;let a="";switch(t){case q.INT8:case q.UINT8:case q.INT16:case q.UINT16:case q.FLOAT32:i.addUniform("vec2",n);break;case q.INT32:case q.UINT32:{const l=Iv[t];i.addUniform(`${t===q.INT32?"i":"u"}vec2`,r),i.addUniform("float",s),a+=`
#define ${n} ${l}(${r}[0], int(${r}[1]), ${s})
`;break}case q.UINT64:{i.addUniform("uvec3",r),i.addUniform("float",s),a+=`
#define ${n} Uint64LerpParameters(uint64_t(${r}.xy), int(${r}[2]), ${s})
`;break}}return[wc[t],a]}function T2(i,e,t,n=!1){return[Oo[t],L2(i,e,t),mB[t],`
float ${e}(${si(t)} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${e});
  ${n?"v = clamp(v, 0.0, 1.0);":""}
  return v;
}
`]}function yB(i,e,t){return[Oo[t],L2(i,e,t),vB[t],`
${si(t)} ${e}(float inputValue) {
  return computeLerp(inputValue, uLerpParams_${e});
}
`]}const $s=new te;function Rv(i,e,t,n){const r=i.gl;switch(t){case q.INT8:case q.UINT8:case q.INT16:case q.UINT16:case q.FLOAT32:r.uniform2f(i.uniform(`uLerpParams_${e}`),n[0],1/(n[1]-n[0]));break;case q.INT32:case q.UINT32:{const s=n[0],a=n[1]-s,l=Math.max(0,Math.ceil(Fi(Math.abs(a)))-24),d=Math.pow(2,l)/a,u=i.uniform(`uLerpBounds_${e}`);t===q.UINT32?r.uniform2ui(u,s,l):r.uniform2i(u,s,l),r.uniform1f(i.uniform(`uLerpScalar_${e}`),d);break}case q.UINT64:{const s=n[0],a=n[1];te.absDifference($s,a,s);const l=$s.high>0?32+Math.ceil(Fi($s.high)):Math.ceil(Fi($s.low)),d=Math.max(0,l-24);te.rshift($s,$s,d);let u=1/$s.low;te.compare(s,a)>0&&(u*=-1);const h=i.uniform(`uLerpBounds_${e}`);r.uniform3ui(h,s.low,s.high,d),r.uniform1f(i.uniform(`uLerpScalar_${e}`),u)}}}function SB(i){const e=/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/mg;return i.replace(e,t=>t.startsWith("/")?t.replace(/[^\s]/g," "):t)}function bB(i){const e=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/;let t=0,n=i;e:for(;i.length;){const r=i.match(e);if(r===null)break;const s=r[0];switch(s.charAt(0)){case"[":case"{":++t;break;case"]":case"}":if(--t<0)return-1;break;case",":if(t===0)break e;break;default:if(t===0){i=i.substring(s.length);break e}break}i=i.substring(s.length)}return t!==0?-1:n.length-i.length}function wB(i){let e=[],t=new ce;if(i===void 0)return{errors:e,parameters:t};const n=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;i=i.trim(),i.length!=0;){const r=i.match(n);if(r===null){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}const s=r[1];i=i.substring(r[0].length);let a=bB(i);if(a<=0){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let l;try{l=JSON.parse(i.substring(0,a))}catch{e.push(`Invalid #uicontrol parameter value for ${s}: ${l}`);break}t.has(s)?e.push(`Duplicate #uicontrol parameter: ${s}`):t.set(s,l),i=i.substring(a),i=i.trim(),i.length>0&&!i.startsWith(",")&&e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),i=i.substring(1)}return{parameters:t,errors:e}}function CB(i,e){let t,n,r,s,a=[];i!=="float"&&i!=="uint"&&i!=="int"&&a.push("type must be float, int, or uint");for(const d of e){var l=ae(d,2);const u=l[0],h=l[1],g=()=>{if(typeof h!="number"){a.push(`Expected ${u} argument to be a number`);return}return(i==="int"||i==="uint")&&(Ai(h)||a.push(`Expected ${u} argument to be an integer`),i==="uint"&&h<0&&a.push(`Expected ${u} argument to be an unsigned integer`)),h};u==="min"?t=g():u==="max"?n=g():u==="default"?s=g():u==="step"?r=g():a.push(`Invalid parameter: ${u}`)}return t===void 0&&a.push("min must be specified"),n===void 0&&a.push("max must be specified"),t!==void 0&&n!==void 0&&(t>n&&a.push("min must be less than max"),r===void 0&&(i==="float"?r=(n-t)/100:r=1),s!==void 0?(s<t||s>n)&&a.push("default must be within valid range"):i==="float"?s=(t+n)/2:s=t),a.length>0?{errors:a}:{control:{type:"slider",valueType:i,min:t,max:n,step:r,default:s},errors:void 0}}function xB(i,e){let t=!1,n=[];i!=="bool"&&n.push("type must be bool");for(const s of e){var r=ae(s,2);const a=r[0],l=r[1];if(a==="default"){if(typeof l!="boolean"){n.push(`Expected ${a} argument to be a boolean`);continue}t=l}else n.push(`Invalid parameter: ${a}`)}return n.length>0?{errors:n}:{control:{type:"checkbox",valueType:i,default:t},errors:void 0}}function kB(i,e){let t="white",n=[];i!=="vec3"&&n.push("type must be vec3");for(const s of e){var r=ae(s,2);const a=r[0],l=r[1];a==="default"?typeof l!="string"?n.push("Expected default argument to be a string"):t=l:n.push(`Invalid parameter: ${a}`)}return n.length>0?{errors:n}:{control:{type:"color",valueType:i,defaultString:t,default:Ao(t)},errors:void 0}}function D2(i,e){typeof i=="number"&&(i=[i]);const t=new Array(e);return rt(t,i,n=>{if(!Ai(n)||n<0)throw new Error(`Expected non-negative integer, but received: ${re(n)}`);return n}),t}function EB(i,e,t){let n=[];const r=t.imageData;if(r===void 0)return n.push("invlerp control not supported"),{errors:n};i!=="invlerp"&&n.push("type must be invlerp");let s=new Array(r.channelRank).fill(0);const a=r.dataType;let l=!0,d=mc[a],u;for(let g of e){var h=ae(g,2);let v=h[0],y=h[1];try{switch(v){case"range":{d=su(y,a);break}case"window":{u=yL(su(y,a));break}case"clamp":{typeof y!="boolean"?n.push(`Invalid clamp value: ${re(y)}`):l=y;break}case"channel":{s=D2(y,s.length);break}default:n.push(`Invalid parameter: ${v}`);break}}catch(C){n.push(`Invalid ${v} value: ${C.message}`)}}return n.length>0?{errors:n}:{control:{type:"invlerp",dataType:a,clamp:l,default:{range:d,window:u??zV(d),channel:s}},errors:void 0}}const LB=new ce([["slider",CB],["color",kB],["invlerp",EB],["checkbox",xB]]);function dh(i,e={}){i=SB(i);const t=/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/mg,n=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/;let r=[];const s=new ce,a=i.replace(t,(l,d,u)=>{var h;const g=d.match(n),v=()=>Math.max(0,i.substring(0,u).split(`
`).length-1);if(g===null)return r.push({line:v(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";const y=g[1],C=g[2],w=(h=g[3])!==null&&h!==void 0?h:y,b=g[4];var k=wB(b);const L=k.parameters,I=k.errors;for(const R of I)r.push({line:v(),message:R});if(s.has(C)&&r.push({line:v(),message:`Duplicate definition for control ${C}`}),I.length>0)return"";const P=LB.get(w);if(P===void 0)return r.push({line:v(),message:`Invalid control type ${w}`}),"";const T=P(y,L,e);if(T.errors!==void 0){for(const R of T.errors)r.push({line:v(),message:R});return""}return s.set(C,T.control),""});return{source:i,code:a,errors:r,controls:s}}function P2(i){return`u_shaderControl_${i}`}function ec(i,e){const t=i.builderValues;for(const r of i.parseResult.controls){var n=ae(r,2);const s=n[0],a=n[1],l=P2(s),d=t[s];switch(a.type){case"invlerp":{const u=[T2(e,l,a.dataType,a.clamp),`
float ${l}() {
  return ${l}(getDataValue(${d.channel.join(",")}));
}
`];e.addFragmentCode(u),e.addFragmentCode(`#define ${s} ${l}
`);break}case"checkbox":{const u=`#define ${s} ${d.value}
`;e.addFragmentCode(u),e.addVertexCode(u);break}default:{e.addUniform(`highp ${a.valueType}`,l),e.addVertexCode(`#define ${s} ${l}
`),e.addFragmentCode(`#define ${s} ${l}
`);break}}}}function TB(i){const e={};for(const n of i){var t=ae(n,2);const r=t[0],s=t[1];e[r]=s}return e}function JC(i){if(i!==void 0)return re(TB(i))}class DB{constructor(){this.changed=new be,this.controls=void 0}get value(){return this.controls}set value(e){JC(e)!==JC(this.controls)&&(this.controls=e,this.changed.dispatch())}}function PB(i,e,t){return i===void 0?t:(ge(i),{range:ye(i,"range",n=>su(n,e),t.range),window:ye(i,"window",n=>yL(su(n,e)),t.window),channel:ye(i,"channel",n=>D2(n,t.channel.length),t.channel)})}class IB extends Jt{constructor(e,t){super(t,n=>PB(n,e,t)),this.dataType=e,this.defaultValue=t}toJSON(){var e=this.value;const t=e.range,n=e.window,r=e.channel,s=this.dataType,a=this.defaultValue,l=Xw(t,s,a.range),d=Xw(n,s,a.window),u=Oe(a.channel,r)?void 0:r;if(!(l===void 0&&d===void 0&&u===void 0))return{range:l,window:d,channel:u}}}function I2(i){switch(i.type){case"slider":return{trackable:new Jt(i.default,e=>{let t;if(i.valueType==="float"?t=vt(e):t=ui(e),t<i.min||t>i.max)throw new Error(`${re(e)} is outside valid range [${i.min}, ${i.max}]`);return t}),getBuilderValue:()=>null};case"color":return{trackable:new nu(i.default),getBuilderValue:()=>null};case"invlerp":return{trackable:new IB(i.dataType,i.default),getBuilderValue:e=>({channel:e.channel,dataType:i.dataType})};case"checkbox":return{trackable:new _t(i.default),getBuilderValue:e=>({value:e})}}}function R2(i,e){return re(i)+"\0"+e.source}function Mv(i){const e={};for(const r of i.controls){var t=ae(r,2);const s=t[0],a=t[1];var n=I2(a);const l=n.trackable,d=n.getBuilderValue;e[s]=d(l.value)}return{builderValues:e,parseResult:i,key:R2(e,i)}}class Av extends Y{constructor(e,t=Zs({}),n){super(),this.fragmentMain=e,this.dataContext=t,this.channelCoordinateSpaceCombiner=n,this.changed=new be,this.controls=new DB,this.fragmentMainGeneration=-1,this.dataContextGeneration=-1,this.parseErrors_=[],this.processedFragmentMain_="",this.controlsGeneration=-1,this.parseResultChanged=new be,this.state_=new ce,this.unparsedJson=void 0,this.registerDisposer(e.changed.add(()=>this.handleFragmentMainChanged())),this.registerDisposer(this.controls.changed.add(()=>this.handleControlsChanged())),this.registerDisposer(this.dataContext.changed.add(()=>this.handleFragmentMainChanged())),this.handleFragmentMainChanged();const r=this;this.parseErrors={changed:this.parseResultChanged,get value(){return r.handleFragmentMainChanged(),r.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return r.handleFragmentMainChanged(),r.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return r.parseResult_}},this.builderState=cn((l,d)=>{const u={};for(const v of d){var h=ae(v,2);const y=h[0];var g=h[1];const C=g.trackable,w=g.getBuilderValue,b=w(C.value);u[y]=b}return{key:R2(u,l),parseResult:l,builderValues:u}},[this.parseResult,this],(l,d)=>l.key===d.key);const s=cn(l=>{const d=[];for(const u of l.values()){const h=u.control,g=u.trackable;h.type==="invlerp"&&d.push({channel:g.value.channel})}return d},[this],(l,d)=>lg(l,d,(u,h)=>Oe(u.channel,h.channel))),a=jn(l=>{const d=[];for(const u of l.values()){const h=u.control,g=u.trackable;h.type==="invlerp"&&d.push(g.value.window)}return d},this);this.histogramSpecifications=this.registerDisposer(new E2(s,a))}handleFragmentMainChanged(){const e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;const n=this.dataContext.value;if(n===null)this.parseResult_={source:"",code:"",controls:new ce,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{const r=this.parseResult_=dh(this.fragmentMain.value,n);this.parseErrors_=r.errors,this.processedFragmentMain_=r.code,r.errors.length===0&&(this.controls.value=r.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){const e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;const t=this.controls.value;if(t===void 0)return;let n=!1;const r=this.state_,s=this.unparsedJson;for(const u of r){var a=ae(u,2);const h=a[0],g=a[1];if(t.get(h)===void 0){g.trackable.changed.remove(this.changed.dispatch),r.delete(h),n=!0;continue}}for(const u of t){var l=ae(u,2);const h=l[0],g=l[1];let v=r.get(h);if(v!==void 0&&re(v.control)!==re(g)&&(v.trackable.changed.remove(this.changed.dispatch),v=void 0),v===void 0){var d=I2(g);const y=d.trackable,C=d.getBuilderValue;v={control:g,trackable:y,getBuilderValue:C},v.trackable.changed.add(this.changed.dispatch),r.set(h,v),n=!0}if(s!==void 0&&s.hasOwnProperty(h)){n=!0;try{v.trackable.restoreState(s[h])}catch{}}}s!==void 0&&(n=!0),this.unparsedJson=void 0,n&&this.changed.dispatch()}get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}restoreState(e){if(e===void 0)return;const t=this.state;if(ge(e),this.controls.value===void 0){this.unparsedJson=e,this.changed.dispatch();return}for(const r of t){var n=ae(r,2);const s=n[0],a=n[1].trackable;if(a.reset(),e.hasOwnProperty(s))try{a.restoreState(e[s])}catch{}}this.unparsedJson=void 0}reset(){for(const e of this.state.values())e.trackable.reset();this.unparsedJson!==void 0&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){const e=this.state,t=this.unparsedJson;if(t!==void 0)return t;const n={};let r=!0;for(const a of e){var s=ae(a,2);const l=s[0],d=s[1].trackable.toJSON();d!==void 0&&(n[l]=d,r=!1)}if(!r)return n}}function XC(i,e,t,n,r){const s=P2(t),a=e.uniform(s);switch(n.type){case"slider":switch(n.valueType){case"int":case"uint":i.uniform1i(a,r);break;case"float":i.uniform1f(a,r)}break;case"color":i.uniform3fv(a,r);break;case"invlerp":Rv(e,s,n.dataType,r.range);break}}function mo(i,e,t,n){const r=t.state;if(t.controls.value===n)for(const l of r){var s=ae(l,2);const d=s[0],u=s[1];XC(i,e,d,u.control,u.trackable.value)}else for(const l of n){var a=ae(l,2);const d=a[0],u=a[1],h=r.get(d),g=h!==void 0&&re(h.control)===re(u)?h.trackable.value:u.default;XC(i,e,d,u,g)}}/**
* @license
* Copyright 2018 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class RB extends ct{}class MB extends xv{constructor(){super((e,{showMatches:t,segmentationState:n})=>{e.registerDisposer(t.changed.add(this.changed.dispatch)),e.registerDisposer(n.changed.add(this.changed.dispatch)),e.registerDisposer(Pr((r,s)=>{if(s==null)return;const a=s.segmentationGroupState;r.registerDisposer(a.changed.add(this.changed.dispatch)),r.registerDisposer(Pr((l,d)=>{const u=d.visibleSegments;let h=u.size===0;l.registerDisposer(u.changed.add(()=>{const g=u.size===0;g!==h&&(h=g,this.changed.dispatch())}))},a))},n))})}get(e){let t=super.get(e);return t===void 0&&(t={segmentationState:new ct(void 0),showMatches:new _t(!1)},super.set(e,t)),t}}const KC=`
void main() {
  setColor(defaultColor());
}
`;class AB extends Y{constructor(){super(...arguments),this.shader=kv(KC),this.shaderControls=new Av(this.shader),this.fallbackShaderControls=new ct(Mv(dh(KC))),this.shaderError=lh(),this.color=new nu(lt(1,1,0)),this.relationshipStates=this.registerDisposer(new MB),this.ignoreNullSegmentFilter=new _t(!0),this.displayUnfiltered=jn((e,t)=>{for(const n of e.values())if(n.showMatches.value){if(!t)return!1;const r=n.segmentationState.value;if(r!=null&&r.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0},this.relationshipStates,this.ignoreNullSegmentFilter),this.hoverState=new RB(void 0)}}class Ag extends Y{constructor(e){super();const t=e.transform,n=e.localPosition,r=e.source;var s=e.role;const a=s===void 0?un.ANNOTATION:s;this.transform=t,this.localPosition=n,this.source=this.registerDisposer(r),this.role=a,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer(jn(l=>f2(()=>$L(AO(l))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex}get sourceIndex(){const e=this.dataSource;return e.layer.dataSources.indexOf(e)}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class uh{constructor(e,t,n){this.size=cg(e),this.transform=PN(t),this.finiteRank=n;const r=Je(),s=hv(r,4,t,4,4);if(s===0)throw new Error("Transform is singular");this.invTransform=r,this.detTransform=s}toObject(){return{size:this.size,transform:this.transform,finiteRank:this.finiteRank}}static fromObject(e){return new uh(e.size,e.transform,e.finiteRank)}globalToLocalSpatial(e,t){return an(e,t,this.invTransform)}localSpatialVectorToGlobal(e,t){return qN(e,t,this.transform)}globalToLocalNormal(e,t){return oL(e,t,this.transform)}}const NB=Je();function VB(i,e){let t=0,n=Math.abs(i.detTransform);const r=i.transform,s=i.size;for(let a=0;a<3;++a){let l=0;for(let u=0;u<3;++u)l+=e[u*4+2]*r[4*a+u];const d=s[a];t+=Math.abs(l)*d,n*=d}return n/t}function M2(i,e,t){const n=i.curPositionInChunks,r=i.fixedPositionWithinChunk,s=i.nonDisplayLowerClipBound,a=i.nonDisplayUpperClipBound;var l=i.source.spec;const d=l.rank,u=l.chunkDataSize;if(!Xl(n,e,t,i.layerRank,i.fixedLayerToChunkTransform))return!1;for(let h=0;h<d;++h){const g=n[h];if(g<s[h]||g>=a[h])return!1;const v=u[h],y=n[h]=Math.floor(g/v);r[h]=g-y*v}return!0}function OB(i,e){let t=e.length,n=0;if(t>1){let r=0;for(let s=0;s<t;++s){const a=e[s].chunkLayout;let l=VB(a,i);l>r&&(r=l,n=s)}}return n}const $a=new uh(Ne(),Je(),0);class BB extends QL{constructor(){super(...arguments),this.viewportNormalInGlobalCoordinates=Ne(),this.viewportNormalInCanonicalCoordinates=Ne(),this.centerDataPosition=Ne(),this.pixelSize=0}}function _B(i,e){if(i.displayDimensionRenderInfo!==e.displayDimensionRenderInfo||i.pixelSize!==e.pixelSize)return!0;const t=i.viewMatrix,n=e.viewMatrix;for(let r=0;r<12;++r)if(t[r]!==n[r])return!0;return!1}class FB extends er{constructor(e){super(),this.projectionParameters=e,this.visibleLayers=new ce,this.visibleSourcesStale=!0,this.registerDisposer(e.changed.add((t,n)=>{_B(t,n)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;const e=this.projectionParameters.value.displayDimensionRenderInfo,t=this.visibleLayers;for(const s of t){var n=ae(s,2);const a=n[0];var r=n[1];const l=r.allSources,d=r.visibleSources,u=r.displayDimensionRenderInfo;if(d.length=0,u!==e||l.length===0)continue;const h=OB(this.projectionParameters.value.viewMatrix,l.map(v=>v[0])),g=l[h];for(const v of a.filterVisibleSources(this,g))d.push(v);d.reverse()}}}const UB=18;function gu(i){let e=i.rank,t=i.upperVoxelBound;var n=i.maxVoxelsPerChunkLog2;let r=n===void 0?UB:n,s=i.chunkToViewTransform,a=i.displayRank,l=i.minBlockSize,d=i.maxBlockSize;var u=i.lowerVoxelBound;const h=u===void 0?new Uint32Array(e):u,g=new Float32Array(e);for(let w=0;w<e;++w){let b=0;for(let k=0;k<a;++k){const L=s[w*a+k];b+=L*L}g[w]=Math.sqrt(b)}const v=new Uint32Array(e);l!==void 0?v.set(l):v.fill(1);const y=new Array(e);for(let w=0;w<e;++w){let b=Number.POSITIVE_INFINITY;g[w]===0?b=v[w]:(t!==void 0&&(b=Math.pow(2,Math.floor(Fi(t[w]-h[w])))),d!==void 0&&(b=Math.min(b,d[w]))),y[w]=b}function C(){let w=1/0,b=-1;for(let k=0;k<e;++k){if(v[k]>=y[k])continue;let L=v[k]*g[k];L<w&&(w=L,b=k)}return b}r-=Fi(fv(v));for(let w=0;w<r;++w){let b=C();if(b===-1)break;v[b]*=2}return v}function zB(i){const e=[],t=i.displayRank,n=i.chunkToViewTransform,r=i.rank;if(t>3)throw new Error("Unsupported view transform");if(t<3)return[gu(i)];for(let s=0;s<3;++s){const a=(s+2)%3,l=new Float32Array(n);for(let d=0;d<r;++d)l[d*t+a]=0;e[s]=gu(H(H({},i),{chunkToViewTransform:l}))}return e}var to;(function(i){i[i.ISOTROPIC=0]="ISOTROPIC",i[i.FLAT=1]="FLAT"})(to||(to={}));function $B(i){if(i.chunkDataSizes!==void 0)return i.chunkDataSizes;var e=i.chunkLayoutPreference;switch(e===void 0?to.ISOTROPIC:e){case to.ISOTROPIC:return[gu(i)];case to.FLAT:return zB(i)}}function Cc(i){const e=i.rank,t=i.chunkDataSize,n=i.upperVoxelBound;var r=i.lowerVoxelBound;const s=r===void 0?new Float32Array(e):r,a=new Float32Array(e),l=new Float32Array(e);for(let d=0;d<e;++d)a[d]=Math.floor(s[d]/t[d]),l[d]=Math.floor((n[d]-1)/t[d]+1);return{rank:e,chunkDataSize:t,lowerChunkBound:a,upperChunkBound:l,lowerVoxelBound:s,upperVoxelBound:n}}function*GB(i,e,t){const n=i.projectionParameters.value.pixelSize*1.1,r=t[0].effectiveVoxelSize,s=e.renderScaleTarget.value,a=h=>{const g=n*s;for(let v=0;v<3;++v){const y=h[v];if(y>g&&y>1.01*r[v])return!0}return!1},l=(h,g)=>{const v=n*s;for(let y=0;y<3;++y){const C=h[y],w=g[y];if(Math.abs(v-C)<Math.abs(v-w)&&C<1.01*w)return!0}return!1};let d=t.length-1,u;for(;;){const h=t[d];if(u!==void 0&&!l(h.effectiveVoxelSize,u)||(yield h,d===0||!a(h.effectiveVoxelSize)))break;u=h.effectiveVoxelSize,--d}}const WB="SliceView",HB="sliceview/RenderLayer",jB="SliceView.addVisibleLayer",qB="SliceView.removeVisibleLayer",Nv=new Float32Array(3),Vv=new Float32Array(3),A2=Je(),N2=new Float32Array(24);function V2(i,e,t,n){const r=Nv,s=Vv,a=e.lowerChunkDisplayBound,l=e.upperChunkDisplayBound;for(let g=0;g<3;++g)r[g]=Math.max(r[g],a[g]),s[g]=Math.min(s[g],l[g]);const d=e.curPositionInChunks,u=e.chunkDisplayDimensionIndices;function h(){if(!n(r[0],r[1],r[2],s[0],s[1],s[2],i))return;let g=0,v=Math.max(0,s[0]-r[0]),y=v;for(let k=1;k<3;++k){const L=Math.max(0,s[k]-r[k]);y*=L,L>v&&(v=L,g=k)}if(y===0)return;if(y===1){d[u[0]]=r[0],d[u[1]]=r[1],d[u[2]]=r[2],t(r,i);return}const C=r[g],w=s[g],b=Math.floor(.5*(C+w));s[g]=b,h(),s[g]=w,r[g]=b,h(),r[g]=C}h()}function O2(i,e,t,n){if(!M2(t,i.globalPosition,e))return;const r=t.chunkLayout.size,s=ei(A2,i.viewProjectionMat,t.chunkLayout.transform);for(let u=0;u<3;++u){const h=r[u];for(let g=0;g<4;++g)s[4*u+g]*=h}const a=N2;iu(a,s);const l=Nv,d=Vv;l.fill(Number.NEGATIVE_INFINITY),d.fill(Number.POSITIVE_INFINITY),V2(a,t,n,cL)}function JB(i,e,t,n,r){if(!M2(t,i.globalPosition,e))return;const s=n.size,a=ei(A2,i.viewProjectionMat,n.transform);for(let v=0;v<3;++v){const y=s[v];for(let C=0;C<4;++C)a[4*v+C]*=y}const l=NB;fs(l,a);const d=Nv,u=Vv,h=.001;for(let v=0;v<3;++v){const y=l[12+v]+h/s[v],C=Math.abs(l[v]),w=Math.abs(l[4+v]);d[v]=Math.floor(y-C-w),u[v]=Math.floor(y+C+w+1)}const g=N2;for(let v=0;v<3;++v){const y=a[4*v],C=a[4*v+1],w=a[4*v+2];g[v]=y,g[4+v]=-y,g[8+v]=+C,g[12+v]=-C,g[16+v]=+w,g[20+v]=-w}{const v=a[12],y=a[13],C=a[14];g[3]=1+v,g[7]=1-v,g[11]=1+y,g[15]=1-y,g[19]=C,g[23]=-C}V2(g,t,r,XN)}function Ov(i,e){const t=e.finiteRank;if(t===3)return e;$a.finiteRank=t,ON($a.size,e.size);const n=Qd($a.transform,e.transform),r=Qd($a.invTransform,e.invTransform);$a.detTransform=e.detTransform;const s=i.invViewMatrix,a=i.width,l=i.height,d=uL(i.projectionMat);for(let u=t;u<3;++u){const h=s[12+u];let g=h,v=h;const y=Math.abs(s[u]*a);g-=y,v+=y;const C=Math.abs(s[u+4]*l);g-=C,v+=C;const w=Math.abs(s[u+8]*d);g-=w,v+=w;const b=Math.max(1,v-g);n[12+u]=g,n[5*u]=b}return fs(r,n),$a}const XB="annotation.MetadataChunkSource",KB="annotation.GeometryChunkSource",YB="annotation.SubsetGeometryChunkSource",ZB="annotation.reference.add",QB="annotation.reference.delete",e_="annotation.commit",t_="annotation.commit",i_="annotation/SpatiallyIndexedRenderLayer",n_="annotation/PerspectiveRenderLayer:updateSources",r_="annotation/RenderLayer",s_="annotation/RenderLayer.updateSegmentation",a_=uc();function o_(i,e,t,n,r,s){const a=i.displayDimensionRenderInfo,l=i.viewMatrix,d=i.projectionMat,u=i.width,h=i.height,g=a.voxelPhysicalScales,v=Math.abs(tv(th(a_,l))),y=gg(g),C=KN(d)/v*y;if(n.length===0)return;const w=n[0];let b=Math.abs(w.chunkLayout.detTransform)*y;const k=w.lowerClipDisplayBound,L=w.upperClipDisplayBound;for(let M=0;M<3;++M)b*=L[M]-k[M];const I=Math.min(b,C),P=u*h,T=P/t**2/I;let R=0;for(let M=n.length-1;M>=0&&R<T;--M){const V=n[M],B=V.source.spec,F=V.chunkLayout,j=gg(F.size)*Math.abs(F.detTransform)*y,U=B.limit,O=B.rank,$=V.nonDisplayLowerClipBound,_=V.nonDisplayUpperClipBound;let se=1;for(let Te=0;Te<O;++Te){const Fe=_[Te]-$[Te];gt(Fe)&&(se/=Fe)}const oe=U*se/j,Re=R+oe,le=Math.pow(1/Re,1/3),we=Math.sqrt(P/(Re*I)),ie=(T-R)*j/se,he=Math.min(1,ie/B.limit);O2(i,e,V,()=>{s(V,M,he,le,we)}),R=Re}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const tc=`vec3 colormapJet(float x) {
  vec3 result;
  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);
  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);
  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);
  return clamp(result, 0.0, 1.0);
}
vec3 colormapCubehelix(float x) {
  float xclamp = clamp(x, 0.0, 1.0);
  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);
  float amp = xclamp * (1.0 - xclamp) / 2.0;
  vec3 result;
  float cosangle = cos(angle);
  float sinangle = sin(angle);
  result.r = -0.14861 * cosangle + 1.78277 * sinangle;
  result.g = -0.29227 * cosangle + -0.90649 * sinangle;
  result.b = 1.97294 * cosangle;
  result = clamp(xclamp + amp * result, 0.0, 1.0);
  return result;
}
`;function B2(i,e){return{defineShader(t,n){const r=`prop_${n}`,s=`a_${r}`;t.addAttribute(`${i}`,s),t.addVertexCode(`${i} ${r}() { return ${s}; }`),t.addInitializer(a=>{const l=a.attribute(s),d=a.gl;a.vertexShaderInputBinders[r]=l===-1?{enable(){},disable(){},bind(){}}:{enable(u){d.enableVertexAttribArray(l),d.vertexAttribDivisor(l,u)},disable(){d.vertexAttribDivisor(l,0),d.disableVertexAttribArray(l)},bind(u,h){e(d,l,u,h)}}})}}}function kf(i,e,t,n){return B2(i,(r,s,a,l)=>{r.vertexAttribPointer(s,e,t,n,a,l)})}function Ga(i,e,t){return B2(i,(n,r,s,a)=>{n.vertexAttribIPointer(r,e,t,s,a)})}const l_={rgb:kf("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:kf("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:kf("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:Ga("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:Ga("highp int",1,WebGL2RenderingContext.INT),uint16:Ga("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:Ga("highp int",1,WebGL2RenderingContext.SHORT),uint8:Ga("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:Ga("highp int",1,WebGL2RenderingContext.BYTE)};class xc extends Y{constructor(e,t,n,r,s,a,l){super(),this.gl=e,this.annotationType=t,this.rank=n,this.properties=r,this.shaderControlState=s,this.fallbackShaderParameters=a,this.shaderError=l;const d=this.serializedGeometryBytesPerAnnotation=Di[t].serializedBytes(n);var u=SL(n,d,r);const h=u.offsets,g=u.serializedBytes,v=u.propertyGroupBytes;this.serializedBytesPerAnnotation=g,this.propertyOffsets=h,this.propertyGroupBytes=v,this.geometryDataStride=v[0]}getDependentShader(e,t){return ho(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(n,r)=>{const s=this.rank,a=this.properties,l=[],d=r.parseResult.code;for(let C=0,w=a.length;C<w;++C){const b=a[C],k=`prop_${b.identifier}`;d.match(new RegExp(`\\b${k}\\b`))&&(l.push(C),l_[b.type].defineShader(n,b.identifier,s))}const u=this.propertyOffsets,h=this.propertyGroupBytes,g=new Array(h.length);g[0]=0;for(let C=1;C<h.length;++C)g[C]=g[C-1]+h[C-1];n.addInitializer(C=>{const w=l.map(k=>C.vertexShaderInputBinders[`prop_${a[k].identifier}`]),b=w.length;C.vertexShaderInputBinders.properties={enable(k){for(let L=0;L<b;++L)w[L].enable(k)},bind(k,L){for(let P=0;P<b;++P){var I=u[l[P]];let T=I.group,R=I.offset;w[P].bind(h[T],L+R+g[T]*k)}},disable(){for(let k=0;k<b;++k)w[k].disable()}}}),n.addUniform("highp vec3","uColor"),n.addUniform("highp uint","uSelectedIndex"),n.addVarying("highp vec4","vColor"),n.addUniform("highp vec3","uSubspaceMatrix",s),n.addUniform("highp mat4","uModelViewProjection"),n.addUniform("highp float","uModelClipBounds",s*2),n.addUniform("highp uint","uPickID"),n.addVarying("highp uint","vPickID","flat"),n.addVertexCode(tc),n.addVertexCode(`
vec3 defaultColor() { return uColor; }
highp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }
`),n.addFragmentCode(`
void emitAnnotation(vec4 color) {
  emit(color, vPickID);
}
`);const v=`
float getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${s}; ++i) {
    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${s} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}
`;n.addVertexCode(v),n.addFragmentCode(v),n.addVertexCode(`
vec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {
  vec3 result = vec3(0.0, 0.0, 0.0);
  for (int i = 0; i < ${s}; ++i) {
    result += uSubspaceMatrix[i] * modelPoint[i];
  }
  return result;
}

float getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${s}; ++i) {
    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${s} + i];
    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${s} + i];
    coefficient *= max(0.0, 1.0 - min(dA, dB));
  }
  return coefficient;
}

float getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${s}; ++i) {
    float a = modelPointA[i];
    float b = modelPointB[i];
    float c = uModelClipBounds[i];
    float x = clamp(c, min(a, b), max(a, b));
    float d = abs(x - c) * uModelClipBounds[${s} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}

`),ec(r,n),n.addVertexCode(`
const bool PROJECTION_VIEW = ${!this.targetIsSliceView};
bool ng_discardValue;
#define discard ng_discard()
void ng_discard() {
  ng_discardValue = true;
}
void setLineColor(vec4 startColor, vec4 endColor);
void setLineWidth(float width);

void setAxisColor(vec4 startColor, vec4 endColor);
void setAxisWidth(float width);
void setSphereColor(vec4 color);

void setEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerSize(float startSize, float endSize);
void setEndpointMarkerBorderWidth(float startSize, float endSize);

void setPointMarkerColor(vec4 color);
void setPointMarkerBorderColor(vec4 color);
void setPointMarkerSize(float size);
void setPointMarkerBorderWidth(float size);
void setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }

void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setAxisEndpointMarkerSize(float startSize, float endSize);
void setAxisEndpointMarkerBorderWidth(float startSize, float endSize);

void setAxisPointMarkerColor(vec4 color);
void setAxisPointMarkerBorderColor(vec4 color);
void setAxisPointMarkerSize(float size);
void setAxisPointMarkerBorderWidth(float size);

void setEllipsoidFillColor(vec4 color);

void setBoundingBoxBorderColor(vec4 color);
void setBoundingBoxBorderWidth(float size);
void setBoundingBoxFillColor(vec4 color);

void setEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }
void setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }
void setLineColor(vec4 color) { setLineColor(color, color); }
void setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }
void setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setAxisColor(vec4 color) { setAxisColor(color, color); }
void setAxisColor(vec3 color) { setAxisColor(vec4(color, 1.0)); }
void setAxisColor(vec3 startColor, vec3 endColor) { setAxisColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setAxisEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setAxisEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setAxisEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setAxisEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setAxisEndpointMarkerColor(vec3 color) { setAxisEndpointMarkerColor(color, color); }
void setAxisEndpointMarkerColor(vec4 color) { setAxisEndpointMarkerColor(color, color); }
void setAxisEndpointMarkerBorderColor(vec3 color) { setAxisEndpointMarkerBorderColor(color, color); }
void setAxisEndpointMarkerBorderColor(vec4 color) { setAxisEndpointMarkerBorderColor(color, color); }
void setAxisEndpointMarkerSize(float size) { setAxisEndpointMarkerSize(size, size); }
void setAxisEndpointMarkerBorderWidth(float size) { setAxisEndpointMarkerBorderWidth(size, size); }
void setColor(vec4 color) {
  setPointMarkerColor(color);
  setLineColor(color);
  setEndpointMarkerColor(color);
  setBoundingBoxBorderColor(color);
  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));
  setAxisColor(color);
  setAxisEndpointMarkerColor(color);
  setSphereColor(color);
}
void setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }

void setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }
void setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }

void setColor(vec3 color) { setColor(vec4(color, 1.0)); }
void userMain();
`);for(const C of Bv){var y=ae(C,2);const w=y[0],b=y[1];w!==this.annotationType&&b.defineShaderNoOpSetters(n)}t(n),n.addVertexCode(`
#define main userMain
`+Yl(r.parseResult.code)+`
#undef main
`)}})}setPartIndex(e,...t){let n=`
void setPartIndex(${t.map((r,s)=>`highp uint partIndex${s}`).join()}) {
  highp uint pickID = uPickID;
  highp uint pickBaseOffset = getPickBaseOffset();
${t.map((r,s)=>`highp uint pickOffset${s} = pickBaseOffset + partIndex${s};`).join(`
`)}
`;return t.length===0&&(n+=`
  highp uint pickOffset0 = pickBaseOffset;
`),n+=`
  vPickID = pickID + pickOffset0;
  highp uint selectedIndex = uSelectedIndex;
if (selectedIndex == pickBaseOffset${t.map((r,s)=>` || selectedIndex == pickOffset${s}`).join("")}) {
    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);
  }
}
`,e.addVertexCode(n),`setPartIndex(${t.join()})`}get invokeUserMain(){return`
ng_discardValue = false;
userMain();
if (ng_discardValue) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
`}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,n){var r=e(t.renderContext.emitter);const s=r.shader,a=r.parameters;if(s===null)return;s.bind();const l=this.gl,d=t.renderContext,u=t.annotationLayer;if(mo(l,s,this.shaderControlState,a.parseResult.controls),l.uniform3fv(s.uniform("uSubspaceMatrix"),t.subspaceMatrix),l.uniform1fv(s.uniform("uModelClipBounds"),t.modelClipBounds),l.uniformMatrix4fv(s.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),d.emitPickID&&l.uniform1ui(s.uniform("uPickID"),t.basePickId),d.emitColor){const g=u.state.displayState.color.value;l.uniform3f(s.uniform("uColor"),g[0],g[1],g[2]),l.uniform1ui(s.uniform("uSelectedIndex"),t.selectedIndex)}const h=s.vertexShaderInputBinders.properties;h.enable(1),l.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),h.bind(t.count,t.bufferOffset),n(s),h.disable()}}const Bv=new ce;function kc(i,e){Bv.set(i,e)}function zl(i){return Bv.get(i)}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var _v=function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=An(e,t):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(a=i[l])&&(s=(r<3?a(s):r>3?a(e,t,s):a(e,t))||s);return r>3&&s&&Mn(e,t,s),s};class Ls{constructor(e){this.source=e,this.state=pt.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=pt.GPU_MEMORY}freeGPUMemory(e){this.state=pt.SYSTEM_MEMORY}}function YC(i){if(typeof i!="number"||i<0)throw new Error(`Expected non-negative number as limit, but received: ${re(i)}`);return i}class Td{constructor({defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}={}){this.sizeLimit=new Jt(t,YC),this.itemLimit=new Jt(e,YC)}}let Ng=class extends er{constructor(i,e,t,n){super(),this.gl=e,this.frameNumberCounter=t,this.capacities=n,this.visibleChunksChanged=new be,this.pendingChunkUpdates=null,this.pendingChunkUpdatesTail=null,this.chunkUpdateDeadline=null,this.chunkUpdateDelay=30,this.enablePrefetch=new _t(!0,!0);const r=s=>({itemLimit:this.registerDisposer(gi.makeFromExisting(i,s.itemLimit)).rpcId,sizeLimit:this.registerDisposer(gi.makeFromExisting(i,s.sizeLimit)).rpcId});this.initializeCounterpart(i,{gpuMemoryCapacity:r(n.gpuMemory),systemMemoryCapacity:r(n.systemMemory),downloadCapacity:r(n.download),computeCapacity:r(n.compute),enablePrefetch:this.registerDisposer(gi.makeFromExisting(i,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){let i=this.chunkUpdateDeadline,e;i===null||Date.now()<i?e=0:e=this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),e)}processPendingChunkUpdates(i=!1){let e=this.chunkUpdateDeadline;!i&&e===null&&(e=Date.now()+30);let t=!1,n=0;for(;;){if(!i&&Date.now()>e){this.chunkUpdateDeadline=null,setTimeout(()=>this.processPendingChunkUpdates(),this.chunkUpdateDelay);break}let r=this.pendingChunkUpdates;if(r==null)break;if(this.applyChunkUpdate(r)&&(t=!0),++n,(this.pendingChunkUpdates=r.nextUpdate)==null){this.pendingChunkUpdatesTail=null;break}}return t&&this.visibleChunksChanged.dispatch(),n}handleFetch_(i,e){var t=e.promise;const n=t.resolve,r=t.reject;if(t.cancellationToken.isCanceled){r(ms);return}const s=e.key,a=i.chunks.get(s);if(!a){r(new Error(`No chunk found at ${s} for source ${i.constructor.name}`));return}const l=a.data;if(!l){r(new Error(`At ${s} for source ${i.constructor.name}: chunk has no data`));return}n({value:l})}applyChunkUpdate(i){let e=!1;const t=this.rpc.get(i.source);if(i.promise!==void 0)this.handleFetch_(t,i);else if(i.id===void 0){for(const n of t.chunks.keys())t.deleteChunk(n);e=!0}else{let n=i.state;if(n===pt.EXPIRED)t.deleteChunk(i.id);else{let r,s=i.id;i.new?(r=t.getChunk(i),t.addChunk(s,r)):r=t.chunks.get(s);let a=r.state;if(n!==a)switch(n){case pt.GPU_MEMORY:r.copyToGPU(this.gl),e=!0;break;case pt.SYSTEM_MEMORY:r.freeGPUMemory(this.gl);break;default:throw new Error(`INTERNAL ERROR: Invalid chunk state: ${pt[n]}`)}}}return e}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){const i=this.rpc,e=await i.promiseInvoke(tO,{queue:this.rpcId}),t=new ce;for(const r of e){var n=ae(r,2);const s=n[0],a=n[1],l=i.get(s);l!==void 0&&t.set(l,a)}return t}};Ng=_v([hn(Z3)],Ng);function _2(i,e){let t=i.get(e.source),n=t.chunkManager.chunkQueueManager;if(t.immediateChunkUpdates){n.applyChunkUpdate(e)&&n.visibleChunksChanged.dispatch();return}let r=n.pendingChunkUpdatesTail;r==null?(n.pendingChunkUpdates=e,n.pendingChunkUpdatesTail=e,n.scheduleChunkUpdate()):(r.nextUpdate=e,n.pendingChunkUpdatesTail=e)}Et("Chunk.update",function(i){_2(this,i)});l2("Chunk.retrieve",function(i,e){return new xt((t,n)=>{i.promise={resolve:t,reject:n,cancellationToken:e},_2(this,i)})});Et(iO,function(i){const e=this.get(i.id);for(const t of e.prevStatisticsLayers)t.numVisibleChunksNeeded=0,t.numVisibleChunksAvailable=0,t.numPrefetchChunksNeeded=0,t.numPrefetchChunksAvailable=0;e.prevStatisticsLayers.length=0;for(const t of i.layers){const n=this.get(t.id);if(n===void 0)continue;const r=n.layerChunkProgressInfo;r.numVisibleChunksAvailable=t.numVisibleChunksAvailable,r.numVisibleChunksNeeded=t.numVisibleChunksNeeded,r.numPrefetchChunksAvailable=t.numPrefetchChunksAvailable,r.numPrefetchChunksNeeded=t.numPrefetchChunksNeeded,e.prevStatisticsLayers.push(r)}e.layerChunkStatisticsUpdated.dispatch()});let Vg=class extends er{constructor(i){super(),this.chunkQueueManager=i,this.memoize=new JL,this.prevStatisticsLayers=[],this.layerChunkStatisticsUpdated=new be,this.registerDisposer(i.addRef()),this.initializeCounterpart(i.rpc,{chunkQueueManager:i.rpcId})}get gl(){return this.chunkQueueManager.gl}getChunkSource(i,e){const t=i.encodeOptions(e);t.constructorId=oi(i);const n=ln(t);return this.memoize.get(n,()=>{const r=new i(this,e);return r.initializeCounterpart(this.rpc,{}),r.key=t,r})}};Vg=_v([hn(Q3)],Vg);class Or extends er{constructor(e,t={}){super(),this.chunkManager=e,this.chunks=new ce,this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){const t=this.chunks.get(e);t.state===pt.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw new Error("Not implemented.")}invalidateCache(){this.rpc.invoke(eO,{id:this.rpcId})}static encodeOptions(e){return{}}}function Pt(i,e){let t=class extends i{constructor(...n){super(...n);const r=n[1];this.parameters=r.parameters}initializeCounterpart(n,r){r.parameters=this.parameters,super.initializeCounterpart(n,r)}static encodeOptions(n){return H({parameters:n.parameters},super.encodeOptions(n))}};return t=_v([hn(e.RPC_ID)],t),t}class Ec extends er{constructor(e){super(),this.layerChunkProgressInfo=e}}/**
* @license
* Copyright 2020 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var Pn;(function(i){i[i.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",i[i.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",i[i.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",i[i.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED"})(Pn||(Pn={}));class c_{}class d_ extends Y{constructor(e,t,n){super(),this.graph=e,this.segmentsState=t,this.transform=n}createRenderLayers(e,t,n){return[]}}function u_(i){return!(i.high>>>31)}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const h_=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function p_(i,e,t){i.registerDisposer(e.visibleSegments.changed.add(t)),i.registerDisposer(e.segmentEquivalences.changed.add(t))}function f_(i,e,t){i.registerDisposer(e.temporaryVisibleSegments.changed.add(t)),i.registerDisposer(e.temporarySegmentEquivalences.changed.add(t)),i.registerDisposer(e.useTemporaryVisibleSegments.changed.add(t)),i.registerDisposer(e.useTemporarySegmentEquivalences.changed.add(t))}function Jn(i){return`${i.low},${i.high}`}function g_(i){return!!(i.high>>>31)}function F2(i){return i.useTemporaryVisibleSegments.value?i.temporaryVisibleSegments:i.visibleSegments}function m_(i){return i.useTemporarySegmentEquivalences.value?i.temporarySegmentEquivalences:i.segmentEquivalences}function Bo(i,e){const t=F2(i),n=m_(i);if(n.disjointSets){const r=n.disjointSets.visibleSegmentEquivalencePolicy.value;for(let s of t.unsafeKeys())if(r&Pn.NONREPRESENTATIVE_EXCLUDED){const a=n.get(s);e(s,a)}else{if(n.disjointSets===void 0||!n.disjointSets.isMinElement(s))continue;for(let a of n.setElements(s))r&Pn.REPRESENTATIVE_EXCLUDED&&r&Pn.MAX_REPRESENTATIVE&&g_(a)||e(a,s)}}}const jt=40,U2=.5,z2=-4;function jd(i){return(Fi(i)-z2)/U2}function v_(i){return 2**(i*U2+z2)}function ta(i){return new Jt(i,vi)}class vo{constructor(){this.visibility=new Kl,this.changed=new be,this.frameNumber=-1,this.spatialScales=new ce,this.numHistogramRows=1,this.value=new Uint32Array(jt*this.numHistogramRows*2)}begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.changed.dispatch())}add(e,t,n,r){let s=this.spatialScales,a=this.numHistogramRows,l=this.value,d=s.get(e);if(d===void 0&&(d=s.size,s.set(e,d)),d>=a){this.numHistogramRows=a*=2;const h=new Uint32Array(a*jt*2);h.set(l),this.value=l=h}const u=d*jt*2+Math.min(Math.max(0,Math.round(jd(t))),jt-1);l[u]+=n,l[u+jt]+=r}}class Fv extends u2{constructor(e,t,n){var r;super(),this.chunkManager=e,this.multiscaleSource=t,this.rpcId=null,this.rpcTransfer={},this.visibleSources=new ce,this.visibleSourcesList_=[];var s=n.renderScaleTarget;const a=s===void 0?ta(1):s;this.renderScaleTarget=a,this.renderScaleHistogram=n.renderScaleHistogram,this.transform=n.transform,this.localPosition=n.localPosition,this.rpcTransfer=n.rpcTransfer||{},this.dataHistogramSpecifications=this.registerDisposer((r=n.dataHistogramSpecifications)!==null&&r!==void 0?r:new E2(Zs([]),Zs([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}getDataHistogramCount(){const e=this.dataHistogramSpecifications;return e.visibility.visible?e.bounds.value.length:0}getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){const n=this.visibleSources,r=n.get(e);r!==void 0?(++r.refCount,r.chunkTransform=t):(n.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){const t=this.visibleSources,n=t.get(e);n.refCount!==1?--n.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){const e=this.visibleSources,t=this.visibleSourcesList_;if(t.length===0&&e.size!==0){for(const n of e.values())t.push(n);t.sort((n,r)=>n.chunkTransform.chunkToLayerTransformDet-r.chunkTransform.chunkToLayerTransformDet)}return t}initializeCounterpart(){const e=this.registerDisposer(new Ec(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,H({localPosition:this.registerDisposer(gi.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(gi.makeFromExisting(t,this.renderScaleTarget)).rpcId},this.rpcTransfer)),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return GB(e,this,t)}}Fv.prototype.RPC_TYPE_ID=HB;class yo extends h2{draw(e,t){}isReady(e,t){return!0}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var y_=function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=An(e,t):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(a=i[l])&&(s=(r<3?a(s):r>3?a(e,t,s):a(e,t))||s);return r>3&&s&&Mn(e,t,s),s};class S_ extends FB{}const b_=oh(S_);function w_(i){return{source:i.source.addCounterpartRef(),effectiveVoxelSize:i.effectiveVoxelSize,layerRank:i.layerRank,nonDisplayLowerClipBound:i.nonDisplayLowerClipBound,nonDisplayUpperClipBound:i.nonDisplayUpperClipBound,lowerClipBound:i.lowerClipBound,upperClipBound:i.upperClipBound,lowerClipDisplayBound:i.lowerClipDisplayBound,upperClipDisplayBound:i.upperClipDisplayBound,chunkDisplayDimensionIndices:i.chunkDisplayDimensionIndices,lowerChunkDisplayBound:i.lowerChunkDisplayBound,upperChunkDisplayBound:i.upperChunkDisplayBound,fixedLayerToChunkTransform:i.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:i.combinedGlobalLocalToChunkTransform,chunkLayout:i.chunkLayout.toObject()}}function Uv(i){return i.map(e=>e.map(w_))}function Ef(i,e){for(const t of e)for(const n of t){const r=n.source;i.removeSource(r),r.dispose()}}let mu=class extends b_{constructor(i,e,t,n){super(new p2({parametersConstructor:BB,navigationState:t,update:(a,l)=>{const d=a.invViewMatrix,u=a.centerDataPosition;l.toMat4(d);var h=a.displayDimensionRenderInfo;const g=h.canonicalVoxelFactors,v=h.voxelPhysicalScales;for(let T=0;T<3;++T)u[T]=d[12+T];const y=a.logicalWidth,C=a.logicalHeight,w=a.projectionMat,b=a.viewportNormalInGlobalCoordinates,k=a.viewportNormalInCanonicalCoordinates,L=l.relativeDepthRange;QE(w,-y/2,y/2,C/2,-C/2,-L,L),XL(a,w),e2(a);const I=a.viewMatrix;for(let T=0;T<3;++T){const R=b[T]=I[T*4+2];k[T]=R/g[T]}eu(b,b),eu(k,k);let P=0;for(let T=0;T<3;++T){const R=v[T],M=d[T];P+=(R*M)**2}P=Math.sqrt(P),a.pixelSize=P}})),this.chunkManager=i,this.layerManager=e,this.navigationState=t,this.wireFrame=n,this.gl=this.chunkManager.gl,this.viewChanged=new be,this.renderingStale=!0,this.visibleChunksStale=!0,this.visibleLayerList=new Array,this.offscreenFramebuffer=this.registerDisposer(new fo(this.gl,{colorBuffers:fu(this.gl,1),depthBuffer:new YO(this.gl)})),this.histogramInputTextures=[],this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer],this.histogramGenerator=Pv.get(this.gl),this.updateVisibleLayers=this.registerCancellable(nt(()=>{this.updateVisibleLayersNow()},0)),this.registerDisposer(t),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add((a,l)=>{a.displayDimensionRenderInfo!==l.displayDimensionRenderInfo&&this.updateVisibleLayers()}));const r=this.chunkManager.rpc,s=this.sharedProjectionParameters=this.registerDisposer(new pu(r,this.projectionParameters));this.initializeCounterpart(r,{chunkManager:i.rpcId,projectionParameters:s.rpcId}),this.registerDisposer(e.layersChanged.add(()=>{this.updateVisibleLayers()})),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add(()=>{this.renderingStale=!0}),this.registerDisposer(i.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}computeHistograms(i,e){this.histogramGenerator.compute(i,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,e,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}forEachVisibleChunk(i,e,t){JB(this.projectionParameters.value,i.renderLayer.localPosition.value,i,e,()=>{t(i.curPositionInChunks.join())})}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let i=0,e=0;for(const t of this.visibleLayers.values()){const n=t.visibleSources;for(const r of n){const s=Ov(this.projectionParameters.value,r.chunkLayout),a=r.source.chunks;this.forEachVisibleChunk(r,s,l=>{const d=a.get(l);++e,d&&d.state===pt.GPU_MEMORY&&++i})}}return i===e}invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(i,e){e.push(i.localPosition.changed.add(()=>this.invalidateVisibleChunks())),e.push(i.redrawNeeded.add(this.viewChanged.dispatch)),e.push(i.transform.changed.add(this.updateVisibleLayers)),e.push(i.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()));const t=i.renderScaleHistogram;t!==void 0&&e.push(t.visibility.add(this.visibility)),e.push(i.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;const i=Date.now(),e=this.visibleLayers,t=this.visibleLayerList,n=this.projectionParameters.value.displayDimensionRenderInfo;let r=this.rpc,s={id:this.rpcId},a=!1;t.length=0;for(let d of this.layerManager.readyRenderLayers())if(d instanceof Fv){t.push(d);let u=e.get(d);if(u===void 0){const h=[],g=new Vo;u={messages:g,allSources:this.getTransformedSources(d,g),transformGeneration:d.transform.changed.count,visibleSources:[],disposers:h,lastSeenGeneration:i,displayDimensionRenderInfo:n},h.push(d.messages.addChild(u.messages)),e.set(d.addRef(),u),this.bindVisibleRenderLayer(d,h)}else{u.lastSeenGeneration=i;const h=d.transform.changed.count;if(u.transformGeneration===h&&u.displayDimensionRenderInfo===n)continue;const g=u.allSources;u.allSources=this.getTransformedSources(d,u.messages),Ef(d,g),u.visibleSources.length=0,u.displayDimensionRenderInfo=n,u.transformGeneration=h}s.layerId=d.rpcId,s.sources=Uv(u.allSources),this.flushBackendProjectionParameters(),r.invoke(jB,s),a=!0}for(const d of e){var l=ae(d,2);const u=l[0],h=l[1];h.lastSeenGeneration!==i&&(s.layerId=u.rpcId,r.invoke(qB,s),e.delete(u),Ef(u,h.allSources),so(h.disposers),u.dispose(),a=!0)}return a&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),a}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(i){const e=this.offscreenFramebuffersWithHistograms;let t=e[i];if(t===void 0){const n=this.gl,r=this.histogramInputTextures,s=this.offscreenFramebuffer;r.length<i&&r.push(...fu(n,i-r.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));let a=[s.colorBuffers[0].addRef()];for(let l=0;l<i;++l)a.push(r[l].addRef());t=this.registerDisposer(new fo(n,{colorBuffers:a,depthBuffer:s.depthBuffer.addRef()})),e[i]=t}return t}updateRendering(){const i=this.projectionParameters.value,e=i.width,t=i.height;if(!this.renderingStale||!this.valid||e===0||t===0)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();let n=this.gl,r=this.offscreenFramebuffer;r.bind(e,t),n.disable(n.SCISSOR_TEST),n.clearColor(0,0,0,0),n.colorMask(!0,!0,!0,!0),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let s=0;const a=this.wireFrame.value,l={sliceView:this,projectionParameters:i,wireFrame:a};for(let d of this.visibleLayerList){const u=a?0:d.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(u).bind(e,t);for(let h=0;h<u;++h)n.clearBufferfv(WebGL2RenderingContext.COLOR,1+h,fg);n.enable(WebGL2RenderingContext.DEPTH_TEST),n.depthFunc(WebGL2RenderingContext.LESS),n.clearDepth(1),n.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),d.setGLBlendMode(n,s),d.draw(l),++s}n.disable(WebGL2RenderingContext.BLEND),n.disable(WebGL2RenderingContext.DEPTH_TEST),r.unbind()}disposed(){for(const e of this.visibleLayers){var i=ae(e,2);const t=i[0],n=i[1];Ef(t,n.allSources),so(n.disposers),t.dispose()}this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(i,e){const t=zv(this.projectionParameters.value.displayDimensionRenderInfo,i.transform.value,n=>i.getSources(n),e,i);for(const n of t)for(const r of n)i.addSource(r.source,r.chunkTransform);return t}};mu=y_([hn(WB)],mu);class $2 extends Or{constructor(e,t){super(e,t),this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:Ee(e.chunkDataSize),lowerVoxelBound:Ee(e.lowerVoxelBound),upperVoxelBound:Ee(e.upperVoxelBound)}}static encodeOptions(e){const t=super.encodeOptions(e);return t.spec=this.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}}class G2 extends Ls{constructor(e,t){super(e),this.chunkGridPosition=t.chunkGridPosition,this.state=pt.SYSTEM_MEMORY}}let W2=class H2 extends Y{constructor(e,t){super(),this.gl=e,this.copyVertexPositionsBuffer=Ql(this.gl),this.textureCoordinateAdjustment=new Float32Array(4);let n=new ea(e);n.addVarying("vec2","vTexCoord"),n.addUniform("sampler2D","uSampler"),n.addInitializer(r=>{e.uniform1i(r.uniform("uSampler"),0)}),n.addUniform("vec4","uColorFactor"),n.addUniform("vec4","uBackgroundColor"),n.addUniform("mat4","uProjectionMatrix"),n.addUniform("vec4","uTextureCoordinateAdjustment"),n.require(t),n.setFragmentMain(`
vec4 sampledColor = texture(uSampler, vTexCoord);
if (sampledColor.a == 0.0) {
  sampledColor = uBackgroundColor;
}
emit(sampledColor * uColorFactor, 0u);
`),n.addAttribute("vec4","aVertexPosition"),n.setVertexMain(`
vTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;
gl_Position = uProjectionMatrix * aVertexPosition;
`),this.shader=this.registerDisposer(n.build())}draw(e,t,n,r,s,a,l,d){let u=this.gl,h=this.shader,g=this.textureCoordinateAdjustment;g[0]=s,g[1]=a,g[2]=l-s,g[3]=d-a,h.bind(),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,e),u.disable(WebGL2RenderingContext.BLEND),u.uniformMatrix4fv(h.uniform("uProjectionMatrix"),!1,t),u.uniform4fv(h.uniform("uColorFactor"),n),u.uniform4fv(h.uniform("uBackgroundColor"),r),u.uniform4fv(h.uniform("uTextureCoordinateAdjustment"),g);let v=h.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(v,2),u.drawArrays(u.TRIANGLE_FAN,0,4),u.disableVertexAttribArray(v),u.bindTexture(u.TEXTURE_2D,null)}static get(e,t){return e.memoize.get(`sliceview/SliceViewRenderHelper:${oi(t)}`,()=>new H2(e,t))}};class C_{constructor(e){this.chunkManager=e}}function zv(i,e,t,n,r){n.clearMessages();const s=k=>(n.addMessage({severity:Yn.error,message:k}),[]);if(e.error!==void 0)return s(e.error);const a=e.rank,l=e.unpaddedRank,d=i.displayDimensionIndices,u=i.displayRank,h=i.canonicalVoxelFactors,g=GL(e,d),v=g.displayToLayerDimensionIndices,y=new Float32Array(u*l),C=e.modelToRenderLayerTransform;for(let k=0;k<u;++k){const L=v[k];if(L===-1)continue;const I=h[k];for(let P=0;P<l;++P)y[u*P+k]=C[(a+1)*P+L]*I}const w=t({displayRank:u,multiscaleToViewTransform:y,modelChannelDimensionIndices:e.channelToRenderLayerDimensions}),b=i.voxelPhysicalScales;try{const k=L=>{const I=L.chunkSource,P=I.spec;var T=L.lowerClipBound;const R=T===void 0?P.lowerVoxelBound:T;var M=L.upperClipBound;const V=M===void 0?P.upperVoxelBound:M,B=$L(e,L.chunkToMultiscaleTransform),F=P.chunkDataSize,j=B.channelToChunkDimensionIndices,U=new Float32Array(l),O=new Float32Array(l);U.set(R),O.set(V);const $=j.length,_=e.channelSpaceShape;for(let Ue=0;Ue<$;++Ue){const Ce=j[Ue];if(Ce===-1)continue;const Xe=_[Ue];if(F[Ce]!==Xe)throw new Error("Channel dimension "+e.layerDimensionNames[e.channelToRenderLayerDimensions[Ue]]+` has extent ${Xe} but corresponding chunk dimension has extent ${F[Ce]}`);U[Ce]=Number.NEGATIVE_INFINITY,O[Ce]=Number.POSITIVE_INFINITY}const se=WL(B,g),oe=Ne(),Re=Ne(),le=Ne(),we=Ne(),ie=Ne(),he=se.numChunkDisplayDims,Te=se.chunkDisplayDimensionIndices,Fe=B.combinedGlobalLocalToChunkTransform,Ge=B.layerRank,Pe=B.combinedGlobalLocalRank,ke=new Float32Array(Fe);for(let Ue=0;Ue<he;++Ue){const Ce=Te[Ue];for(let Xe=0;Xe<=Pe;++Xe)ke[Ce+Xe*Ge]=0;Ce<l?(ie[Ue]=P.chunkDataSize[Ce],oe[Ue]=P.lowerChunkBound[Ce],Re[Ue]=P.upperChunkBound[Ce],le[Ue]=R[Ce],we[Ue]=V[Ce],U[Ce]=Number.NEGATIVE_INFINITY,O[Ce]=Number.POSITIVE_INFINITY):(ie[Ue]=1,oe[Ue]=0,Re[Ue]=1,le[Ue]=0,we[Ue]=1)}ie.fill(1,he),oe.fill(0,he),Re.fill(1,he),le.fill(0,he),we.fill(1,he);const Me=new uh(ie,se.displaySubspaceModelMatrix,he),_e=Me.localSpatialVectorToGlobal(Ne(),aL);for(let Ue=0;Ue<u;++Ue)_e[Ue]=Math.abs(_e[Ue]*b[Ue]);return _e.fill(1,u),{layerRank:Ge,lowerClipBound:R,upperClipBound:V,nonDisplayLowerClipBound:U,nonDisplayUpperClipBound:O,renderLayer:r,source:I,lowerChunkDisplayBound:oe,upperChunkDisplayBound:Re,lowerClipDisplayBound:le,upperClipDisplayBound:we,effectiveVoxelSize:_e,chunkLayout:Me,chunkDisplayDimensionIndices:Te,fixedLayerToChunkTransform:ke,curPositionInChunks:new Float32Array(l),combinedGlobalLocalToChunkTransform:B.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(l),chunkTransform:B,chunkDisplayTransform:se}};return w.map(L=>L.map(I=>k(I)))}catch(k){for(const P of w)for(const T of P)T.chunkSource.dispose();const L=i.globalDimensionNames,I=`Cannot render (${Ee(i.displayDimensionIndices.filter(P=>P!==-1),P=>L[P]).join(", ")}) cross section: ${k.message}`;return s(I)}}let Gs=null;/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var x_=200;class Ye{constructor(e=!1){if(Gs===null){Gs=document.createElement("ul"),Gs.id="statusContainer";const n=document.getElementById("neuroglancer-container");n?n.appendChild(Gs):document.body.appendChild(Gs)}let t=document.createElement("li");this.element=t,e===!0&&(e=x_),e!==!1?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null,Gs.appendChild(t)}dispose(){Gs.removeChild(this.element),this.element=void 0,this.timer!==null&&clearTimeout(this.timer)}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setVisible(e){this.timer!==null&&(clearTimeout(this.timer),this.timer=null),this.element.style.display=e?"block":"none"}static forPromise(e,t){let n=new Ye(t.delay);n.setText(t.initialMessage);let r=n.dispose.bind(n);return e.then(r,s=>{let a;s instanceof Error?a=s.message:a=""+s;var l=t.errorPrefix;let d=l===void 0?"":l;n.setErrorMessage(d+a),n.setVisible(!0)}),e}setErrorMessage(e){this.element.textContent=e+" ";let t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",()=>{this.dispose()}),this.element.appendChild(t)}static showMessage(e){const t=new Ye;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e,t=2e3){const n=this.showMessage(e);return window.setTimeout(()=>n.dispose(),t),n}}/**
* @license
* Copyright 2018 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var $v=function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=An(e,t):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(a=i[l])&&(s=(r<3?a(s):r>3?a(e,t,s):a(e,t))||s);return r>3&&s&&Mn(e,t,s),s};function j2(i){let e=0;const t=i.typeToIds;for(const n of Tr)e+=zl(n).pickIdsPerInstance*t[n].length;return e}class q2{constructor(e){this.bufferValid=!1,this.numPickIds=0,this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){const t=this.buffer;t!==void 0&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}}class k_ extends Ls{constructor(e,t){super(e),t.data!==void 0&&(this.data=new q2(t))}freeGPUMemory(e){super.freeGPUMemory(e);const t=this.data;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}class J2 extends G2{constructor(e,t){super(e,t),t.data!==void 0&&(this.data=new q2(t))}freeGPUMemory(e){super.freeGPUMemory(e);const t=this.data;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}let So=class extends $2{constructor(i,e){super(i,e),this.immediateChunkUpdates=!0,(this.parent=e.parent).spatiallyIndexedSources.add(this);var t=this.spec;const n=t.rank,r=t.chunkDataSize,s=this.multiscaleToChunkTransform=new Float32Array((n+1)**2);hv(s,n+1,this.spec.chunkToMultiscaleTransform,n+1,n+1);for(let a=0;a<n;++a)for(let l=0;l<n+1;++l)s[(n+1)*l+a]/=r[a]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(i,e){e.parent=this.parent.rpcId,super.initializeCounterpart(i,e)}addChunk(i,e){super.addChunk(i,e)}getChunk(i){return new J2(this,i)}};So=$v([hn(KB)],So);let Og=class extends Or{constructor(i,e,t){super(i,{}),this.parent=e,this.relationshipIndex=t,this.immediateChunkUpdates=!0}addChunk(i,e){super.addChunk(i,e)}getChunk(i){return new k_(this,i)}};Og=$v([hn(YB)],Og);class E_ extends Ls{constructor(e,t){super(e),this.annotation=cv(t.annotation)}}let Bg=class extends Or{constructor(i,e){super(i),this.parent=e}getChunk(i){return new E_(this,i)}addChunk(i,e){super.addChunk(i,e);const t=this.parent.references.get(i);t!==void 0&&(t.value=e.annotation,t.changed.dispatch())}deleteChunk(i){const e=this.parent.references.get(i);e!==void 0&&(e.value=void 0,e.changed.dispatch())}};Bg=$v([hn(XB)],Bg);function X2(i,e,t,n){const r=new Uint8Array(i.data.length+n);for(const s of Tr){if(s===t)continue;let a=i.typeToOffset[s],l=a;s>t&&(l+=n,i.typeToOffset[s]=l),r.set(i.data.subarray(a,a+i.typeToIds[s].length*e[s].serializedBytes),l)}return r}function _g(i,e,t,n,r,s,a,l){const d=i.typeToOffset[t];let u=d,h=d;const g=e[t].propertyGroupBytes,v=g.length,y=i.typeToIds[t].length;for(let C=0;C<v;++C){const w=g[C];n.set(i.data.subarray(u+r*w,u+s*w),h+a*w),u+=w*y,h+=w*l}}function Dd(i,e,t){const n=e.type,r=t[n].rank,s=i.serializedAnnotations,a=s.typeToIds[n],l=s.typeToIdMaps[n],d=Di[n],u=t[n].serializedBytes;let h=l.get(e.id);if(h===void 0){h=l.size,l.set(e.id,h);const w=X2(s,t,n,u);_g(s,t,n,w,0,h,0,h+1),a.push(e.id),s.data=w}const g=s.typeToOffset[n],v=new DataView(s.data.buffer,s.data.byteOffset,s.data.byteLength),y=pc===qi.LITTLE,C=t[n];d.serialize(v,g+C.propertyGroupBytes[0]*h,y,r,e),C.serialize(v,g,h,a.length,y,e.properties),i.bufferValid=!1}function Pd(i,e,t,n){const r=i.serializedAnnotations,s=r.typeToIdMaps[e],a=s.get(t);if(a===void 0)return!1;const l=r.typeToIds[e],d=n[e].serializedBytes,u=X2(r,n,e,-d);_g(r,n,e,u,0,a,0,l.length-1),_g(r,n,e,u,a+1,l.length,a,l.length-1),l.splice(a,1),s.delete(t);for(let h=a,g=l.length;h<g;++h)s.set(l[h],h);return r.data=u,i.bufferValid=!1,!0}function L_(){const i=[],e=[],t=[];for(const n of Tr)i[n]=[],e[n]=0,t[n]=new ce;return new J2(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:e,typeToIds:i,typeToIdMaps:t})}class In extends er{constructor(e,t){super(),this.chunkManager=e,this.metadataChunkSource=this.registerDisposer(new Bg(this.chunkManager,this)),this.spatiallyIndexedSources=new $e,this.temporary=L_(),this.references=new ce,this.localUpdates=new ce,this.numCommitsInProgress=0,this.changed=new be,this.referencesChanged=new Ze,this.readonly=!1,this.childRefreshed=new be,this.rank=t.rank,this.properties=t.properties,this.annotationPropertySerializers=ov(this.rank,this.properties);const n=this.segmentFilteredSources=[],r=t.relationships;this.relationships=r;for(let s=0,a=r.length;s<a;++s)n.push(this.registerDisposer(new Og(e,this,s)))}hasNonSerializedProperties(){return this.relationships.length>0}getSources(e){throw new Error("not implemented")}initializeCounterpart(e,t){this.metadataChunkSource.initializeCounterpart(e,{});for(const n of this.segmentFilteredSources)n.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map(n=>n.addCounterpartRef()),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e,t=!0){e.id=lv();const n=new Gd(e.id);return n.value=e,this.references.set(n.id,n),this.referencesChanged.dispatch({action:"adding",id:n.id}),n.registerDisposer(()=>{this.references.delete(n.id),this.referencesChanged.dispatch({action:"deref",id:n.id})}),this.applyLocalUpdate(n,!1,t,e),n}applyLocalUpdate(e,t,n,r){const s=this.localUpdates,a=e.id;let l=this.localUpdates.get(a);const d=e.value;if(d==null)throw new Error("Cannot create local update from null annotation");if(l===void 0?(l={type:d.type,reference:e.addRef(),existingAnnotation:t?d:void 0,pendingCommit:void 0,commitInProgress:void 0},s.set(a,l),this.forEachPossibleChunk(d,u=>{const h=u.data;if(h===void 0)return;const g=d.type;Pd(h,g,a,this.annotationPropertySerializers)}),r!==null&&Dd(this.temporary.data,r,this.annotationPropertySerializers)):(r===null?Pd(this.temporary.data,d.type,d.id,this.annotationPropertySerializers):Dd(this.temporary.data,r,this.annotationPropertySerializers),e.value=r),n)if(l.commitInProgress!==void 0)l.pendingCommit=r;else{if(r===null&&l.existingAnnotation===void 0){s.delete(a),l.reference.dispose();return}this.sendCommitRequest(l,r)}this.notifyChanged(e.id,r||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke(e_,{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){const n=this.references.get(e),r=this.metadataChunkSource.chunks.get(e);r!==void 0&&(r.annotation=t||null),n!==void 0&&(n.value=t||null,n.changed.dispatch(),this.referencesChanged.dispatch({action:"changed",id:e})),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}updateReference(e){let t=this.references.get(e.id);if(t!==void 0)t.value=e;else{let n=new Gd(e.id);this.references.set(e.id,n),n.value=e,this.referencesChanged.dispatch({action:"update",id:n.id}),n.registerDisposer(()=>{this.references.delete(n.id),this.referencesChanged.dispatch({action:"deref",id:n.id})})}}hasReference(e){return this.references.has(e)}getReference(e){let t=this.references.get(e);if(t!==void 0)return t.addRef();t=new Gd(e),this.references.set(e,t),this.referencesChanged.dispatch({action:"get",id:e}),this.rpc.invoke(ZB,{id:this.rpcId,annotation:e}),t.registerDisposer(()=>{this.references.delete(e),this.referencesChanged.dispatch({action:"deref",id:e}),this.rpc.invoke(QB,{id:this.rpcId,annotation:e})});const n=this.metadataChunkSource.chunks.get(e);return n!==void 0&&n.annotation!==null&&(t.value=n.annotation),t}forEachPossibleChunk(e,t){const n=e.relatedSegments;if(n!==void 0){const d=n.length,u=this.segmentFilteredSources;for(let h=0;h<d;++h){const g=n[h];if(g===void 0)return;const v=u[h];for(const y of g){const C=v.chunks.get(Jn(y));C!==void 0&&t(C)}}}const r=this.rank,s=new Float32Array(r),a=new Float32Array(r),l=new Float32Array(r);for(const d of this.spatiallyIndexedSources){switch(e.type){case Ie.POINT:Er(s,d.multiscaleToChunkTransform,r+1,e.point,r),a.set(s);break;case Ie.LINE:case Ie.SPHERE:case Ie.AXIS_ALIGNED_BOUNDING_BOX:Er(s,d.multiscaleToChunkTransform,r+1,e.pointA,r),Er(a,d.multiscaleToChunkTransform,r+1,e.pointB,r);break;case Ie.ELLIPSOID:Er(s,d.multiscaleToChunkTransform,r+1,e.center,r),xL(a,d.multiscaleToChunkTransform,r+1,e.radii,r);for(let g=0;g<r;++g){const v=s[g],y=a[g];s[g]=v-y,a[g]=v+y}break}let u=1;for(let g=0;g<r;++g){const v=s[g],y=a[g],C=Math.min(v,y),w=Math.max(v,y);s[g]=Math.ceil(C-1),a[g]=Math.floor(w+1),u*=a[g]-s[g]}const h=d.chunks;for(let g=0;g<u;++g){let v=g;for(let C=0;C<r;++C){const w=s[C],b=a[C]-w,k=l[C]=v%b;v=(v-k)/b}const y=h.get(l.join());y!==void 0&&t(y)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){const n=this.localUpdates.get(e);if(n===void 0||n.commitInProgress===void 0)throw new Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),t!==null&&n.reference.id!==t.id){if(n.commitInProgress===null)throw new Error("Received invalid successful update notification");n.reference.id=t.id,this.references.delete(e),this.references.set(t.id,n.reference.addRef()),this.localUpdates.delete(e),this.localUpdates.set(t.id,n),n.reference.value!==null&&(n.reference.value.id=t.id,Pd(this.temporary.data,n.type,e,this.annotationPropertySerializers),Dd(this.temporary.data,n.reference.value,this.annotationPropertySerializers)),n.reference.changed.dispatch()}let r=n.existingAnnotation===void 0;n.existingAnnotation=t||void 0,n.commitInProgress=void 0;let s=n.pendingCommit;n.pendingCommit=void 0,t===null&&(s=void 0),s!==void 0?(s!==null&&(s.id=t.id),this.sendCommitRequest(n,s)):(this.revertLocalUpdate(n),r?(this.childAdded.dispatch(t),this.referencesChanged.dispatch({action:"added",id:t.id})):t===null?(this.references.get(e).dispose(),this.childDeleted.dispatch(e),this.referencesChanged.dispatch({action:"deleted",id:e})):(this.childUpdated.dispatch(t),this.referencesChanged.dispatch({action:"updated",id:t.id})))}disposed(){const e=this.commitStatus;e!==void 0&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,this.numCommitsInProgress===0?this.commitStatus!==void 0&&(this.commitStatus.dispose(),this.commitStatus=void 0):this.commitStatus===void 0&&(this.commitStatus=new Ye(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){const n=this.localUpdates.get(e);if(n===void 0||n.commitInProgress===void 0)throw new Error("Received invalid update notification");new Ye().setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(n),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){Pd(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializers);const t=e.existingAnnotation;t!==void 0&&this.forEachPossibleChunk(t,s=>{const a=s.data;a!==void 0&&Dd(a,t,this.annotationPropertySerializers)});const n=e.reference,r=n.id;n.value=t||null,n.changed.dispatch(),n.dispose(),this.localUpdates.delete(r)}*[Mi](){}}Et(t_,function(i){const e=this.get(i.id),t=i.annotationId,n=i.error;if(n!==void 0)e.handleFailedUpdate(t,n);else{const r=cv(i.newAnnotation);e.handleSuccessfulUpdate(t,r)}});/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function Lc(i,e){return i<e?-1:i>e?1:0}const K2={offset:0,completions:[]};function _o(i,e){return e.offset+=i,e}function Lf(i,e){let t=[];for(let n of e)n.startsWith(i)&&t.push({value:n});return t.sort((n,r)=>Lc(n.value,r.value)),t}function Fo(i,e,t,n){let r=[];for(let s of e){let a=t(s);a.startsWith(i)&&r.push({value:a,description:n(s)})}return r.sort((s,a)=>Lc(s.value,a.value)),r}async function T_(i,e,t){if(i.startsWith("{"))return K2;const n=i.match(/^(?:(.*)[&;])?([^&;]*)$/)[2];let r=i.length-n.length;const s=n.indexOf("=");if(s===-1){const a=await e(n);return{offset:a.offset+r,completions:a.completions.map(l=>H(H({},l),{value:`${l.value}=`}))}}return _o(r+s+1,await t(n.substring(0,s),n.substring(s+1)))}async function Y2(i,e){return T_(i,async t=>{const n=[];for(const r of e){const s=r.key;s.value.startsWith(t)&&n.push(s)}return{offset:0,completions:n}},async(t,n)=>{for(const r of e)if(r.key.value===t)return{offset:0,completions:r.values.filter(s=>s.value.startsWith(n))};return K2})}class Z2 extends Error{constructor(e){super(`Redirected to: ${e}`),this.redirectTarget=e}}function Q2(i,e){e===void 0&&(i.indexOf("/")===-1?e=":":e="/");let t=i.lastIndexOf(e);return t===-1?0:t+1}function D_(i,e){let t=Q2(i,e);return i.substring(t)}var Rr;(function(i){i[i.annotations=0]="annotations",i[i.equivalences=1]="equivalences"})(Rr||(Rr={}));function eT(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new ce}}class oa extends Y{normalizeUrl(e){return e.url}convertLegacyUrl(e){return e.url}async completeUrl(e){throw null}}const tT="local://annotations",Fg="local://equivalences";class P_ extends oa{get description(){return"Local in-memory"}async get(e){switch(e.url){case tT:{const t=e.transform;let n;if(t===void 0){const r=e.globalCoordinateSpace.value,s=r.rank,a=r.names,l=r.scales,d=r.units,u=st({rank:s,scales:l,units:d,names:a.map((g,v)=>`${v}`)}),h=st({rank:s,scales:l,units:d,names:a});n={rank:s,sourceRank:s,inputSpace:u,outputSpace:h,transform:xs(Float64Array,s+1)}}else n=zi(uo);return{modelTransform:n,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:Rr.annotations}}]}}case Fg:return{modelTransform:zi(uo),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:Rr.equivalences}}]}}throw new Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:Fo(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],t=>t.value,t=>t.description)}}}const ZC=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/;class I_ extends Y{constructor(e){super(),this.credentialsManager=e,this.dataSources=new ce([["local",new P_]])}register(e,t){this.dataSources.set(e,this.registerDisposer(t))}getProvider(e){const t=e.match(ZC);if(t===null||t[1]===void 0)throw new Error('Data source URL must have the form "<protocol>://<path>".');var n=ae(t,3);const r=n[1],s=n[2],a=this.dataSources.get(r);if(a===void 0)throw new Error(`Unsupported data source: ${re(r)}.`);return[a,s,r]}async get(e){const t=new $e;var n=e.cancellationToken;const r=n===void 0?Vt:n;let s=e.url;for(;;){var a=this.getProvider(e.url),l=ae(a,3);const d=l[0],u=l[1],h=l[2];t.add(e.url);try{return d.get(H(H({},e),{url:s,providerProtocol:h,providerUrl:u,registry:this,cancellationToken:r,credentialsManager:this.credentialsManager}))}catch(g){if(g instanceof Z2){const v=g.redirectTarget;if(t.has(v))throw Error(`Layer source redirection contains loop: ${re(Ee(t))}`);if(t.size>=10)throw Error(`Too many layer source redirections: ${re(Ee(t))}`);s=v;continue}throw g}}}convertLegacyUrl(e){try{var t=this.getProvider(e.url),n=ae(t,3);const r=n[0],s=n[1],a=n[2];return r.convertLegacyUrl(H(H({},e),{providerUrl:s,providerProtocol:a,registry:this}))}catch{return e.url}}normalizeUrl(e){try{var t=this.getProvider(e.url),n=ae(t,3);const r=n[0],s=n[1],a=n[2];return r.normalizeUrl(H(H({},e),{providerUrl:s,providerProtocol:a,registry:this}))}catch{return e.url}}async completeUrl(e){const t=e.url;var n=e.cancellationToken;const r=n===void 0?Vt:n;let s=t.match(ZC),a=s[1];if(a===void 0)return xt.resolve({offset:0,completions:Fo(t,this.dataSources,([l])=>`${l}://`,([,l])=>l.description)});{const l=this.dataSources.get(a);if(l!==void 0){const d=await l.completeUrl({registry:this,url:t,providerUrl:s[2],chunkManager:e.chunkManager,cancellationToken:r,credentialsManager:this.credentialsManager});return _o(a.length+3,d)}throw null}}suggestLayerName(e){var t=this.getProvider(e),n=ae(t,2);let r=n[0],s=n[1];s.endsWith("/")&&(s=s.substring(0,s.length-1));let a=r.suggestLayerName;return a!==void 0?a(s):D_(s)}findSourceGroup(e){var t=this.getProvider(e),n=ae(t,3);let r=n[0],s=n[1],a=n[2];return(r.findSourceGroup||Q2)(s)+a.length+3}}var QC={},Tf,ex;function iT(){if(ex)return Tf;ex=1;var i=Wu(),e=ME(),t=Xm(),n=pA().f;return Tf=function(r){return function(s){for(var a=t(s),l=e(a),d=l.length,u=0,h=[],g;d>u;)g=l[u++],(!i||n.call(a,g))&&h.push(r?[g,a[g]]:a[g]);return h}},Tf}var tx;function R_(){if(tx)return QC;tx=1;var i=Ot(),e=iT()(!0);return i(i.S,"Object",{entries:function(t){return e(t)}}),QC}var ix,nx;function M_(){return nx||(nx=1,R_(),ix=ut().Object.entries),ix}var rx,sx;function A_(){return sx||(sx=1,rx={default:M_(),__esModule:!0}),rx}var N_=A_();const Tc=Qe(N_);var ax={},Df,ox;function nT(){if(ox)return Df;ox=1;var i=Xu(),e=Hu().getWeak,t=Ro(),n=Cs(),r=Ku(),s=Mo(),a=Qm(),l=hA(),d=Ys(),u=a(5),h=a(6),g=0,v=function(w){return w._l||(w._l=new y)},y=function(){this.a=[]},C=function(w,b){return u(w.a,function(k){return k[0]===b})};return y.prototype={get:function(w){var b=C(this,w);if(b)return b[1]},has:function(w){return!!C(this,w)},set:function(w,b){var k=C(this,w);k?k[1]=b:this.a.push([w,b])},delete:function(w){var b=h(this.a,function(k){return k[0]===w});return~b&&this.a.splice(b,1),!!~b}},Df={getConstructor:function(w,b,k,L){var I=w(function(P,T){r(P,I,b,"_i"),P._t=b,P._i=g++,P._l=void 0,T!=null&&s(T,k,P[L],P)});return i(I.prototype,{delete:function(P){if(!n(P))return!1;var T=e(P);return T===!0?v(d(this,b)).delete(P):T&&l(T,this._i)&&delete T[this._i]},has:function(P){if(!n(P))return!1;var T=e(P);return T===!0?v(d(this,b)).has(P):T&&l(T,this._i)}}),I},def:function(w,b,k){var L=e(t(b),!0);return L===!0?v(w).set(b,k):L[w._i]=k,w},ufstore:v},Df}var lx;function V_(){if(lx)return ax;lx=1;var i=nT(),e=Ys(),t="WeakSet";return Yu()(t,function(n){return function(){return n(this,arguments.length>0?arguments[0]:void 0)}},{add:function(n){return i.def(e(this,t),n,!0)}},i,!1,!0),ax}var O_={},cx;function B_(){return cx||(cx=1,Zu()("WeakSet")),O_}var __={},dx;function F_(){return dx||(dx=1,Qu()("WeakSet")),__}var ux,hx;function U_(){return hx||(hx=1,ra(),V_(),B_(),F_(),ux=ut().WeakSet),ux}var px,fx;function z_(){return fx||(fx=1,px={default:U_(),__esModule:!0}),px}var $_=z_();const G_=Qe($_);var Pf,gx;function W_(){if(gx)return Pf;gx=1;var i=GE(),e=jm(),t="Expected a function";function n(r,s,a){var l=!0,d=!0;if(typeof r!="function")throw new TypeError(t);return e(a)&&(l="leading"in a?!!a.leading:l,d="trailing"in a?!!a.trailing:d),i(r,s,{leading:l,maxWait:s,trailing:d})}return Pf=n,Pf}var H_=W_();const hh=Qe(H_);function j_(i){return typeof i=="boolean"?{enabled:i}:(ge(i),{enabled:ye(i,"enabled",oo)})}function $l(i,e=void 0){return typeof i=="string"?{url:i,transform:e,enableDefaultSubsources:!0,subsources:new ce}:(ge(i),{url:K(i,"url",Le),transform:K(i,"transform",_L)||e,enableDefaultSubsources:ye(i,"enableDefaultSubsources",oo,!0),subsources:ye(i,"subsources",t=>av(t,j_),new ce)})}function q_(i){return i.enabled}function mx(i){const e=FL(i.transform),t={};let n=!0;for(const s of i.subsources){var r=ae(s,2);const a=r[0],l=r[1],d=q_(l);d!==void 0&&(t[a]=d,n=!1)}return e===void 0&&n&&i.enableDefaultSubsources===!0?i.url:{url:i.url,transform:e,subsources:n?void 0:t,enableDefaultSubsources:i.enableDefaultSubsources===!0?void 0:!1}}class J_{constructor(e,t,n,r,s){this.loadedDataSource=e,this.subsourceEntry=t,this.subsourceSpec=n,this.subsourceIndex=r,this.activated=void 0,this.guardValues=[],this.messages=new Vo,this.isActiveChanged=new be;let a;n===void 0||n.enabled===void 0?a=t.default&&s:a=n.enabled;const l=e.dataSource.modelTransform.sourceRank;let d=t.modelSubspaceDimensionIndices;if(d===void 0){d=new Array(l);for(let g=0;g<l;++g)d[g]=g}var u=t.subsourceToModelSubspaceTransform;const h=u===void 0?xs(Float32Array,d.length+1):u;this.enabled=a,this.subsourceToModelSubspaceTransform=h,this.modelSubspaceDimensionIndices=d,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e,...t){if(this.messages.clearMessages(),this.activated!==void 0){if(Oe(t,this.guardValues))return;this.activated.dispose()}this.guardValues=t;const n=this.activated=new Y;e(n),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:Yn.error,message:e});const t=this.activated;t!==void 0&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){const t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){const t=this.activated;var n=this.loadedDataSource;const r=n.layer,s=n.transform;return t.registerDisposer(zL(r.manager.root.coordinateSpace,r.localPosition.coordinateSpace,s,this,e))}}class Gv extends Y{constructor(e,t,n){super(),this.layerDataSource=e,this.dataSource=t,this.error=void 0,this.enabledSubsourcesChanged=new be,this.activatedSubsourcesChanged=new be,this.messages=new Vo,t.canChangeModelSpaceRank?(this.transform=new oC(zi(st({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new oC(t.modelTransform),n.transform!==void 0&&(this.transform.spec=n.transform);const r=n.subsources;this.enableDefaultSubsources=n.enableDefaultSubsources,this.subsources=t.subsources.map((s,a)=>new J_(this,s,r.get(s.id),a,this.enableDefaultSubsources))}get enabledSubsources(){return this.subsources.filter(e=>e.enabled)}get layer(){return this.layerDataSource.layer}disposed(){for(const e of this.subsources){const t=e.activated;t!==void 0&&(e.activated=void 0,t.dispose())}}}class X_ extends Y{constructor(e,t=void 0){super(),this.layer=e,this.changed=new be,this.messages=new Vo,this.loadState_=void 0,this.specGeneration=-1,this.refCounted_=void 0,this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),t===void 0?this.spec_=eT():this.spec=t}get spec(){const e=this.loadState;if(e!==void 0&&e.error===void 0){const t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new ce(Ee(e.subsources,n=>{const r=e.enableDefaultSubsources&&n.subsourceEntry.default;return[n.subsourceEntry.id,{enabled:n.enabled!==r?n.enabled:void 0}]}))})}return this.spec_}get loadState(){return this.loadState_}set spec(e){const t=this.layer;if(this.messages.clearMessages(),e.url.length===0){if(t.dataSources.length!==1){const d=t.dataSources.indexOf(this);if(d!==-1){t.dataSources.splice(d,1),t.dataSourcesChanged.dispatch(),this.dispose();return}}this.spec_=e,this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch());return}const n=new Y,r=n.registerDisposer(jE(t.markLoading()));this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=n,this.spec_=e;const s=t.manager.chunkManager,a=t.manager.dataSourceProviderRegistry,l=new ks;this.messages.addMessage({severity:Yn.info,message:"Loading data source"}),a.get({chunkManager:s,url:e.url,cancellationToken:l,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform}).then(d=>{if(n.wasDisposed)return;this.messages.clearMessages();const u=n.registerDisposer(new Gv(this,d,e));u.registerDisposer(t.addCoordinateSpace(u.transform.outputSpace)),u.registerDisposer(u.transform.changed.add(this.changed.dispatch)),this.loadState_=u,u.registerDisposer(u.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),r()}).catch(d=>{this.wasDisposed||(this.loadState_={error:d},this.messages.clearMessages(),this.messages.addMessage({severity:Yn.error,message:d.message}),this.changed.dispatch())}),n.registerDisposer(()=>{l.cancel()}),this.changed.dispatch()}disposed(){const e=this.refCounted_;e!==void 0&&e.dispose()}toJSON(){const e=this.loadState;return e===void 0||e.error!==void 0?mx(this.spec):mx({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new ce(Ee(e.subsources,t=>{const n=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==n?t.enabled:void 0}]}))})}}var vx={},yx,Sx;function K_(){return Sx||(Sx=1,yx=Object.is||function(i,e){return i===e?i!==0||1/i===1/e:i!=i&&e!=e}),yx}var bx;function Y_(){if(bx)return vx;bx=1;var i=Ot();return i(i.S,"Object",{is:K_()}),vx}var wx,Cx;function Z_(){return Cx||(Cx=1,Y_(),wx=ut().Object.is),wx}var xx,kx;function Q_(){return kx||(kx=1,xx={default:Z_(),__esModule:!0}),xx}var eF=Q_();const Ex=Qe(eF);var Lx={},Tx,Dx;function tF(){return Dx||(Dx=1,Tx=Math.sign||function(i){return(i=+i)==0||i!=i?i:i<0?-1:1}),Tx}var Px;function iF(){if(Px)return Lx;Px=1;var i=Ot();return i(i.S,"Math",{sign:tF()}),Lx}var Ix,Rx;function nF(){return Rx||(Rx=1,iF(),Ix=ut().Math.sign),Ix}var Mx,Ax;function rF(){return Ax||(Ax=1,Mx={default:nF(),__esModule:!0}),Mx}var sF=rF();const ic=Qe(sF);var If={exports:{}},Nx;function aF(){if(Nx)return If.exports;Nx=1;var i=Nr(),e=Qm()(0),t=lA(),n=Hu(),r=cA(),s=nT(),a=Cs(),l=Ys(),d=Ys(),u=!i.ActiveXObject&&"ActiveXObject"in i,h="WeakMap",g=n.getWeak,v=Object.isExtensible,y=s.ufstore,C,w=function(L){return function(){return L(this,arguments.length>0?arguments[0]:void 0)}},b={get:function(L){if(a(L)){var I=g(L);return I===!0?y(l(this,h)).get(L):I?I[this._i]:void 0}},set:function(L,I){return s.def(l(this,h),L,I)}},k=If.exports=Yu()(h,w,b,s,!0,!0);return d&&u&&(C=s.getConstructor(w,h),r(C.prototype,b),n.NEED=!0,e(["delete","has","get","set"],function(L){var I=k.prototype,P=I[L];t(I,L,function(T,R){if(a(T)&&!v(T)){this._f||(this._f=new C);var M=this._f[L](T,R);return L=="set"?this:M}return P.call(this,T,R)})})),If.exports}var oF={},Vx;function lF(){return Vx||(Vx=1,Zu()("WeakMap")),oF}var cF={},Ox;function dF(){return Ox||(Ox=1,Qu()("WeakMap")),cF}var Bx,_x;function uF(){return _x||(_x=1,ra(),aF(),lF(),dF(),Bx=ut().WeakMap),Bx}var Fx,Ux;function hF(){return Ux||(Ux=1,Fx={default:uF(),__esModule:!0}),Fx}var pF=hF();const rT=Qe(pF);function hi(i,e,t){ye(i,e,n=>t.restoreState(n))}class ph extends Y{constructor(){super(...arguments),this.children=new ce,this.changed=new be}add(e,t){if(this.children.has(e))throw new Error(`Key ${re(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){const t=this.children;if(t.has(e))throw new Error(`Key ${re(e)} not registered.`);const n=t.get(e);this.children.delete(e),n.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){const e=this.changed;for(let t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){const e=this.baseJSON();for(let n of this.children){var t=ae(n,2);let r=t[0],s=t[1];e[r]=s.toJSON()}return e}baseJSON(){return{}}reset(){for(let e of this.children.values())e.reset()}restoreState(e){ge(e);for(let n of this.children){var t=ae(n,2);let r=t[0],s=t[1];try{if(e.hasOwnProperty(r)){const a=e[r];if(a===void 0)continue;s.restoreState(a)}}catch(a){throw new Error(`Error restoring property ${re(r)}: ${a.message}`)}}}}const zx=new rT;function Wv(i){let e=zx.get(i);const t=i.changed.count;if(e!==void 0&&e.generation===t)return e;let n;if(i instanceof ph){n=i.baseJSON();for(let s of i.children){var r=ae(s,2);let a=r[0],l=r[1];n[a]=Wv(l).value}}else n=i.toJSON();return e===void 0?(e={generation:t,value:n},zx.set(i,e)):(e.generation=t,e.value=n),e}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class fh{constructor(e,t,n=t){this.enumType=e,this.value_=t,this.defaultValue=n,this.changed=new be}set value(e){this.value_!==e&&(this.value_=e,this.changed.dispatch())}get value(){return this.value_}reset(){this.value=this.defaultValue}restoreState(e){this.value=Ri(e,this.enumType)}toJSON(){if(this.value_!==this.defaultValue)return this.enumType[this.value_].toLowerCase()}}var Tt;(function(i){i[i.LINKED=0]="LINKED",i[i.RELATIVE=1]="RELATIVE",i[i.UNLINKED=2]="UNLINKED"})(Tt||(Tt={}));var vu;(function(i){i[i.LINKED=0]="LINKED",i[i.UNLINKED=2]="UNLINKED"})(vu||(vu={}));class fF extends fh{constructor(e=Tt.LINKED){super(Tt,e)}}class gF extends fh{constructor(e=vu.LINKED){super(vu,e)}}const Id=Ne(),sT=Pi();function Dc(i,e,t,n){let r=!1,s;i.registerDisposer(e);const a=()=>{switch(r=!0,t.value){case Tt.UNLINKED:if(n.isValid(i))break;case Tt.LINKED:n.assign(i,e);break;case Tt.RELATIVE:n.add(i,e,s);break}r=!1},l=()=>{if(!r)switch(t.value){case Tt.UNLINKED:break;case Tt.LINKED:n.assign(e,i);break;case Tt.RELATIVE:n.subtract(e,i,s);break}};let d=Tt.UNLINKED;const u=()=>{const h=t.value;if(h!==d)switch(h){case Tt.UNLINKED:s=void 0;break;case Tt.LINKED:s=void 0,n.assign(i,e);break;case Tt.RELATIVE:s=n.difference(i,e);break}d=h,i.changed.dispatch()};return i.registerDisposer(i.changed.add(l)),i.registerDisposer(e.changed.add(a)),i.registerDisposer(t.changed.add(u)),u(),i}function aT(i,e,t,n){return Dc(i,e,t,n)}class js extends Y{constructor(e){super(),this.coordinateSpace=e,this.coordinates_=co,this.changed=new be,this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=co,this.changed.dispatch()}set value(e){const t=this.curCoordinateSpace;t===void 0||!t.valid||t.rank!==e.length||(this.coordinates_.set(e),this.changed.dispatch())}handleCoordinateSpaceChanged(){const e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;const n=e.rank;if(!e.valid)return;if(t===void 0||!t.valid){let h=this.coordinates_;if(!(h!==void 0&&h.length===n)){h=this.coordinates_=new Float32Array(n),E3(h,e.bounds);for(let g=0;g<n;++g)h[g]=Math.floor(h[g])+.5}this.changed.dispatch();return}const r=new Float32Array(n),s=this.coordinates_,a=e.ids,l=e.scales,d=t.ids,u=t.scales;for(let h=0;h<n;++h){const g=a[h],v=d.indexOf(g);v===-1?r[h]=IL(e.bounds.lowerBounds[h],e.bounds.upperBounds[h]):r[h]=s[v]*(u[v]/l[h])}this.coordinates_=r,this.changed.dispatch()}toJSON(){if(!this.valid&&this.coordinates_.length===0)return;this.handleCoordinateSpaceChanged();const e=this.value;if(e.length!==0)return Ee(e)}restoreState(e){if(e===void 0){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from(We(e,vt)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();const e=this.coordinates_,t=e.length;for(let n=0;n<t;++n)e[n]=Math.floor(e[n])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();const t=e.curCoordinateSpace,n=e.coordinates_;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(n),this.changed.dispatch()}static getOffset(e,t){const n=e.coordinates_,r=t.coordinates_;if(n.length===r.length)return Eg(new Float32Array(n.length),n,r)}static addOffset(e,t,n,r=1){e.handleCoordinateSpaceChanged();const s=t.value;n!==void 0&&s.length===n.length&&(m3(e.value,s,n,r),e.changed.dispatch())}get legacyJsonView(){const e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){e.reset()},restoreState(t){if(t===void 0||Array.isArray(t)){e.restoreState(t);return}ge(t),hi(t,"voxelCoordinates",e)}}}}function oT(i,e,t){if(t===void 0||Qt(t).length===0){i.value=Tt.LINKED;return}ge(t),i.value=Tt.UNLINKED,K(t,"value",n=>{n!==void 0&&e.restoreState(n)}),K(t,"link",n=>i.restoreState(n))}class Pc{constructor(e,t=new fF){this.peer=e,this.link=t}get changed(){return this.value.changed}toJSON(){const e=this.link;if(e.value!==Tt.LINKED)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=Tt.LINKED}restoreState(e){oT(this.link,this.value,e)}copyToPeer(){this.link.value!==Tt.LINKED&&(this.link.value=Tt.UNLINKED,this.peer.assign(this.value),this.link.value=Tt.LINKED)}}class lT extends Pc{constructor(e,t=new gF){super(e,t)}}class cT extends Pc{constructor(){super(...arguments),this.value=Dc(new js(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:js.getOffset,add:js.addOffset,subtract:(e,t,n)=>{js.addOffset(e,t,n,-1)}})}}function mF(i){return i[0]===0&&i[1]===0&&i[2]===0&&i[3]===1}class bo extends Y{constructor(e){super(),this.changed=new be,e==null&&(e=Pi()),this.orientation=e}toJSON(){let e=this.orientation;if(jl(this.orientation,this.orientation),!mF(e))return Array.prototype.slice.call(this.orientation)}restoreState(e){try{_l(this.orientation,e),jl(this.orientation,this.orientation)}catch{mw(this.orientation)}this.changed.dispatch()}reset(){mw(this.orientation),this.changed.dispatch()}snap(){let e=uc();YE(e,this.orientation);let t=[!1,!1,!1];for(let n=0;n<3;++n){let r=0,s=0;for(let a=0;a<3;++a){let l=e[n*3+a];e[n*3+a]=0,!t[a]&&Math.abs(l)>Math.abs(r)&&(r=l,s=a)}e[n*3+s]=ic(r),t[s]=!0}nL(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let n=new bo(ds(Pi(),e.orientation,t)),r=!1;n.registerDisposer(e.changed.add(()=>{r||(s=!0,ds(n.orientation,e.orientation,t),n.changed.dispatch(),s=!1)}));let s=!1;const a=tu(Pi(),t);return n.registerDisposer(n.changed.add(()=>{s||(r=!0,ds(e.orientation,n.orientation,a),e.changed.dispatch(),r=!1)})),n}assign(e){GN(this.orientation,e.orientation),this.changed.dispatch()}}class Ug extends Pc{constructor(){super(...arguments),this.value=Dc(new bo,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{const n=Pi();return ds(n,tu(n,t.orientation),e.orientation)},add:(e,t,n)=>{ds(e.orientation,t.orientation,n),e.changed.dispatch()},subtract:(e,t,n)=>{ds(e.orientation,t.orientation,tu(sT,n)),e.changed.dispatch()}})}}class dT extends Y{constructor(e){super(),this.coordinateSpace=e,this.changed=new be,this.curCoordinateSpace=Ir,this.value_={factors:new Float64Array(0)},this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=Ir,this.changed.dispatch()}toJSON(){const e={};let t=!1;const n=this.value.factors;var r=this.curCoordinateSpace;const s=r.names,a=r.rank;for(let l=0;l<a;++l){const d=n[l];d!==1&&(e[s[l]]=d,t=!0)}if(t)return e}restoreState(e){const t=this.coordinateSpace.value,n=t.names,r=t.rank,s=new Float64Array(r);if(s.fill(-1),e!==void 0){const a=ge(e);for(let l=0;l<r;++l)s[l]=K(a,n[l],d=>d===void 0?1:vi(d))}this.value_={factors:s},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){const t=this.coordinateSpace.value;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){const e=this.coordinateSpace.value;let t=this.value_;const n=this.curCoordinateSpace;if(n===e)return t;const r=n.ids,s=e.ids,a=e.rank,l=t.factors,d=new Float64Array(a);d.fill(1);for(let u=0;u<a;++u){const h=s[u],g=r.indexOf(h);g!==-1&&(d[u]=l[g])}return Oe(d,l)||(t=this.value_={factors:d},this.curCoordinateSpace=e,this.changed.dispatch()),t}assign(e){this.setFactors(e.value.factors)}}function $x(i,e,t,n,r){if(t===n)return e;const s=t.ids,a=n.rank,l=n.ids,d=new i(a);for(let u=0;u<a;++u){const h=l[u],g=s.indexOf(h);d[u]=g===-1?r(u):e[g]}return d}class vF extends Pc{constructor(){super(...arguments),this.value=Dc(new dT(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{const n=e.value.factors,r=e.coordinateSpace.value,s=t.value.factors;return{coordinateSpace:r,offsets:Eg(new Float64Array(n.length),n,s)}},add:(e,t,n)=>{const r=$x(Float64Array,n.offsets,n.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(TL(new Float64Array(r.length),r,t.value.factors))},subtract:(e,t,n)=>{const r=$x(Float64Array,n.offsets,n.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(Eg(new Float64Array(r.length),t.value.factors,r))},isValid:()=>!0})}}function Gx(i,e,t){const n=i.rank,r=i.names,s=i.units,a=e.displayRank,l=e.displayDimensionIndices,d=new Float64Array(3);let u=new Float64Array(3),h;const g=t.factors,v=new Array(3),y=new Float64Array(3);if(d.fill(1),u.fill(1),y.fill(1),v.fill(""),a===0)h=1;else{h=Number.POSITIVE_INFINITY;const C=i.scales;for(let w=0;w<a;++w){const b=l[w],k=u[w]=g[b]*C[b];h=Math.min(h,k),v[w]=s[b],y[w]=C[b]}for(let w=0;w<a;++w)d[w]=u[w]/h}return{globalRank:n,globalDimensionNames:r,displayRank:a,displayDimensionIndices:l,displayDimensionUnits:v,displayDimensionScales:y,canonicalVoxelFactors:d,voxelPhysicalScales:u,canonicalVoxelPhysicalSize:h}}function yF(i,e){return Oe(i.globalDimensionNames,e.globalDimensionNames)&&Oe(i.displayDimensionIndices,e.displayDimensionIndices)&&Oe(i.canonicalVoxelFactors,e.canonicalVoxelFactors)&&Oe(i.voxelPhysicalScales,e.voxelPhysicalScales)&&i.canonicalVoxelPhysicalSize===e.canonicalVoxelPhysicalSize&&Oe(i.displayDimensionUnits,e.displayDimensionUnits)&&Oe(i.displayDimensionScales,e.displayDimensionScales)}class uT extends Y{constructor(e,t){super(),this.relativeDisplayScales=e,this.displayDimensions=t,this.changed=new be,this.curRelativeDisplayScales=this.relativeDisplayScales.value,this.curDisplayDimensions=this.displayDimensions.value,this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value,this.value_=Gx(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales),this.registerDisposer(e),this.registerDisposer(t);const n=()=>{this.value};this.registerDisposer(e.changed.add(n)),this.registerDisposer(t.changed.add(n))}get value(){var e=this.relativeDisplayScales;const t=e.value,n=e.coordinateSpace.value,r=this.displayDimensions.value,s=this.curRelativeDisplayScales,a=this.curDisplayDimensions,l=this.curCoordinateSpace;let d=this.value_;if(s!==t||a!==r||l!==n){this.curRelativeDisplayScales=t,this.curDisplayDimensions=r,this.curCoordinateSpace=n;const u=Gx(n,r,t);yF(d,u)||(this.value_=d=u,this.changed.dispatch())}return d}}class hT extends Y{constructor(e){super(),this.coordinateSpace=e,this.changed=new be,this.default_=!0,this.value_=void 0,this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){const e=this.coordinateSpace.value,t=this.value_;if(t!==void 0&&t.coordinateSpace===e)return;if(t===void 0||this.default_){this.setToDefault(e);return}const n=new Int32Array(3),r=t.coordinateSpace.ids,s=e.ids,a=t.displayDimensionIndices,l=t.displayRank;let d=0;for(let u=0;u<l;++u){const h=s.indexOf(r[a[u]]);h!==-1&&(n[d]=h,++d)}if(n.fill(-1,d),d===0){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,d,n),this.changed.dispatch()}setToDefault(e){const t=Math.min(e.rank,3),n=new Int32Array(3);n.fill(-1);for(let r=0;r<t;++r)n[r]=r;this.assignValue(e,t,n)}assignValue(e,t,n){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:n},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(e===void 0){this.reset();return}const t=yv(e);if(t.length>3)throw new Error("Number of spatial dimensions must be <= 3");const n=this.coordinateSpace.value,r=new Int32Array(3);r.fill(-1);const s=n.names;let a=0;for(const l of t){const d=s.indexOf(l);d!==-1&&(r[a++]=d)}if(a===0){this.reset();return}this.default_=!1,this.assignValue(n,a,r)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;const e=this.value,t=[],n=e.displayRank,r=e.displayDimensionIndices,s=e.coordinateSpace.names;if(n!==0){for(let a=0;a<n;++a)t[a]=s[r[a]];return t}}assign(e){if(e.default)this.default=!0;else{var t=e.value;const n=t.displayRank,r=t.displayDimensionIndices;this.setDimensionIndices(n,r)}}}class SF extends lT{constructor(e){super(e),this.value=aT(new hT(this.peer.coordinateSpace),this.peer,this.link,{assign:(t,n)=>t.assign(n),isValid:()=>!0})}}class wo extends Y{constructor(e,t,n){super(),this.position=e,this.displayDimensionRenderInfo=t,this.orientation=n,this.changed=new be,this.registerDisposer(e),this.registerDisposer(n),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(n.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e,t=Id){var n=this.position;const r=n.coordinateSpace.value,s=n.value;var a=this.displayDimensions.value;const l=a.displayDimensionIndices,d=a.displayRank;if(r===void 0)return!1;t.fill(0);for(let u=0;u<d;++u){const h=l[u];t[u]=s[h]}if(e(t)!==!1){for(let u=0;u<d;++u){const h=l[u];s[h]=t[u]}return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){AN(e,this.orientation.orientation);const n=this.position.value;var r=this.displayDimensionRenderInfo.value;const s=r.canonicalVoxelFactors,a=r.displayDimensionIndices;for(let l=0;l<3;++l){const d=a[l],u=t/s[l];e[l]*=u,e[4+l]*=u,e[8+l]*=u,e[12+l]=n[d]||0}}toMat3(e,t){YE(e,this.orientation.orientation);var n=this.displayDimensionRenderInfo.value;const r=n.canonicalVoxelFactors,s=n.displayRank;for(let a=0;a<s;++a){const l=t/r[a];e[a]*=l,e[3+a]*=l,e[6+a]*=l}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;const n=this.position,r=n.value;var s=n.coordinateSpace.value.bounds;const a=s.lowerBounds,l=s.upperBounds;let d=r[e]+t;if(t>0){const u=l[e];gt(u)&&(d=Math.min(d,Math.ceil(u-1)))}else{const u=a[e];gt(u)&&(d=Math.max(d,Math.floor(u)))}r[e]=d,n.changed.dispatch()}translateVoxelsRelative(e,t=!1){if(!this.valid)return;const n=Qa(Id,e,this.orientation.orientation),r=this.position,s=r.value;var a=this.displayDimensions.value;const l=a.displayDimensionIndices,d=a.displayRank;var u=r.coordinateSpace.value.bounds;const h=u.lowerBounds,g=u.upperBounds;for(let v=0;v<d;++v){const y=l[v],C=n[v];if(C===0)continue;let w=s[y]+C;if(C>0){const b=g[y];gt(b)&&(w=Math.min(w,Math.ceil(b-1)))}else{const b=h[y];gt(b)&&(w=Math.max(w,Math.floor(b)))}t&&(w=Math.floor(w)+.5),s[y]=w}this.position.changed.dispatch()}rotateRelative(e,t){var n=Pi();pg(n,e,t);var r=this.orientation.orientation;ds(r,r,n),this.orientation.changed.dispatch()}rotateAbsolute(e,t,n){var r=this.position;const s=r.coordinateSpace.value,a=r.value;if(s===void 0)return;const l=this.relativeDisplayScales.value.factors;var d=this.displayDimensions.value;const u=d.displayDimensionIndices,h=d.displayRank,g=s.scales,v=Pi();pg(v,e,t);const y=this.orientation.orientation,C=Id;Id.fill(0);for(let b=0;b<h;++b){const k=u[b],L=n[k]-a[k];C[b]=L*g[k]*l[k]}const w=tu(sT,y);Qa(C,C,w),ds(y,v,y),Qa(C,C,y);for(let b=0;b<h;++b){const k=u[b];a[k]=n[k]-C[b]/(g[k]*l[k])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;const n=this.displayDimensions.value.displayDimensionIndices,r=this.position.coordinateSpace.value.rank;for(let s=0;s<r;++s)if(n.indexOf(s)===-1&&e--===0){this.translateDimensionRelative(s,t);return}}}class zg extends Pc{constructor(e,t){super(e),this.value=(()=>{const n=new e.constructor(t),r=(u,h)=>{u.assign(h)},s=(u,h)=>u.value/h.value*(u.canonicalVoxelPhysicalSize/h.canonicalVoxelPhysicalSize),a=(u,h,g)=>{u.setPhysicalScale(h.value*g,h.canonicalVoxelPhysicalSize)},l=(u,h,g)=>{u.setPhysicalScale(h.value/g,h.canonicalVoxelPhysicalSize)},d=u=>u.coordinateSpaceValue.valid&&u.canonicalVoxelPhysicalSize!==0;return Dc(n,this.peer,this.link,{assign:r,isValid:d,difference:s,add:a,subtract:l}),n})()}}function nc(i){return{changed:i.changed,toJSON(){return i.toJSON()},restoreState(e){oT(i.link,i.value.legacyJsonView,e)},reset(){i.reset()}}}class pT extends Y{constructor(e){super(),this.displayDimensionRenderInfo=e,this.changed=new be,this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.registerDisposer(e),this.registerDisposer(e.changed.add(()=>this.handleCoordinateSpaceChanged())),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add(()=>this.handleCoordinateSpaceChanged())),this.handleCoordinateSpaceChanged()}get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){const t=this.canonicalVoxelPhysicalSize;Ex(e,this.value_)&&t===this.curCanonicalVoxelPhysicalSize||(this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch())}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){Ex(e,this.legacyValue_)||(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}handleCoordinateSpaceChanged(){const e=this.value_;var t=this.displayDimensionRenderInfo;const n=t.value.canonicalVoxelPhysicalSize,r=t.relativeDisplayScales.coordinateSpace.value,s=this.curCanonicalVoxelPhysicalSize;if(!(!Wn(e)&&n===s)){if(!Wn(e)){s!==0&&(this.value_=e*(s/n),this.curCanonicalVoxelPhysicalSize=n,this.changed.dispatch());return}!r.valid||n===0||(this.curCanonicalVoxelPhysicalSize=n,this.value_=this.getDefaultValue(),this.changed.dispatch())}}toJSON(){const e=this.value;return Wn(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,e===void 0?this.value_=Number.NaN:this.value_=vi(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){const e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){return e.reset()},restoreState(t){e.legacyValue=vi(t)}}}setPhysicalScale(e,t){const n=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=e*(t/n)}assign(e){const t=e.legacyValue;Wn(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}}class bF extends pT{getDefaultValue(){const e=this.legacyValue_;if(Wn(e))return 1;const t=this.canonicalVoxelPhysicalSize;return this.legacyValue_*1e-9/t}}class wF extends pT{getDefaultValue(){const e=this.legacyValue_;if(!Wn(e)){this.legacyValue_=Number.NaN;const u=this.canonicalVoxelPhysicalSize;return 200*Math.tan(Math.PI/8)*1e-9*e/u}var t=this.coordinateSpaceValue.bounds;const n=t.lowerBounds,r=t.upperBounds;var s=this.displayDimensionRenderInfo.value;const a=s.canonicalVoxelFactors,l=s.displayDimensionIndices;let d=a.reduce((u,h,g)=>{const v=l[g],y=(r[v]-n[v])*h;return Math.max(u,y)},0);return gt(d)?d=2**Math.ceil(Fi(d)):d=1024,d}}class $g extends Y{constructor(e,t){super(),this.defaultValue=e,this.displayDimensionRenderInfo=t,this.changed=new be,this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add(()=>{this.value}))}get value(){let e=this.value_;if(e>0){const t=this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize,n=this.canonicalVoxelPhysicalSize;t!==n&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=n/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;const t=this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){const e=this.value;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){typeof e!="number"||!gt(e)||e===0?this.value=this.defaultValue:this.value=e}setValueAbsolute(e,t){if(e>0){const n=this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize;e=e*(t/n)}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}}class Wx extends lT{constructor(e,t){super(e),this.value=aT(new $g(e.defaultValue,t),this.peer,this.link,{assign:(n,r)=>n.assign(r),isValid:()=>!0})}}class Co extends Y{constructor(e,t,n){super(),this.pose=e,this.zoomFactor=t,this.depthRange=n,this.changed=new be,this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(n),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!Wn(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const CF="mesh/MeshLayer",xF="mesh/MultiscaleMeshLayer",kF="mesh/FragmentSource",EF="mesh/MultiscaleFragmentSource";var Dr;(function(i){i[i.float32=0]="float32",i[i.uint10=1]="uint10",i[i.uint16=2]="uint16"})(Dr||(Dr={}));/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function LF(i,e,t){return i&1|e<<1&2|t<<2&4}function TF(i,e,t,n,r,s,a){const l=i.octree,d=i.lodScales,u=i.chunkGridSpatialOrigin,h=i.chunkShape,g=d.length-1,v=e[0],y=e[4],C=e[8],w=e[1],b=e[5],k=e[9],L=e[3],I=e[7],P=e[11],T=e[15],R=L>0?0:1,M=I>0?0:1,V=P>0?0:1,B=t[16],F=t[17],j=t[18],U=t[19];function O(ke,Me,_e){return L*ke+I*Me+P*_e+T}function $(ke,Me,_e,Ue,Ce,Xe){return O(ke+R*(Ue-ke),Me+M*(Ce-Me),_e+V*(Xe-_e))}const _=O(-U*B,-U*F,-U*j),se=i.clipLowerBound[0],oe=i.clipLowerBound[1],Re=i.clipLowerBound[2],le=i.clipUpperBound[0],we=i.clipUpperBound[1],ie=i.clipUpperBound[2],he=Math.sqrt((v*r)**2+(w*s)**2),Te=Math.sqrt((y*r)**2+(b*s)**2),Fe=Math.sqrt((C*r)**2+(k*s)**2),Ge=Math.max(he,Te,Fe);function Pe(ke,Me,_e){const Ue=1<<ke,Ce=Me*5,Xe=l[Ce],Ft=l[Ce+1],Xt=l[Ce+2],yi=l[Ce+3],Kt=l[Ce+4];let li=Xe*Ue*h[0]+u[0],Si=Ft*Ue*h[1]+u[1],pn=Xt*Ue*h[2]+u[2],je=li+Ue*h[0],Ki=Si+Ue*h[1],Fr=pn+Ue*h[2];if(li=Math.max(li,se),Si=Math.max(Si,oe),pn=Math.max(pn,Re),je=Math.min(je,le),Ki=Math.min(Ki,we),Fr=Math.min(Fr,ie),cL(li,Si,pn,je,Ki,Fr,t)){const Ur=Math.max(_,$(li,Si,pn,je,Ki,Fr))/Ge;if(_e===0||Ur*n<_e){const fn=d[ke];if(fn!==0&&a(ke,Me,fn/Ur,Kt>>>31),ke>0&&(fn===0||Ur*n<fn)){const Jo=fn===0?_e:fn,Ps=(Kt&2147483647)>>>0;for(let $i=yi;$i<Ps;++$i)Pe(ke-1,$i,Jo)}}}}Pe(g,l.length/5-1,0)}function Hx(i,e,t,n,r,s,a,l){const d=i.lodScales;let u=0;for(;u+1<d.length&&d[u+1]!==0;)++u;const h=3,g=[];let v=0,y=0;function C(k,L){for(;;){if(v===0)return;const I=v-1,P=u-I,T=g[I*h],R=P===0?1:8,M=g[I*h+1],V=g[I*h+2];if(k===v){const B=L&R-1;y!==B&&T!==-1&&l(P,T,y,B,V),y=B+1;return}y!==R&&T!==-1&&l(P,T,y,R,V),y=M+1,--v}}let w=0;const b=i.octree;TF(i,e,t,n,r,s,(k,L,I,P)=>{if(!P&&!a(k,L,I)){w=Math.max(k,w);return}if(k<w)return;w=0;const T=L*5,R=b[T],M=b[T+1],V=b[T+2],B=LF(R,M,V),F=u-k;C(F,B);const j=F*h;g[j]=P?-1:L,g[j+1]=B,g[j+2]=I,y=0,v=F+1}),C(0,0)}function fT(i,e,t){return`${i}/${e}:${t}`}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class Uo extends h2{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const DF=3432918353,PF=461845907;function yu(i,e){return e>>>=0,i>>>=0,e=Hn(e,DF)>>>0,e=(e<<15|e>>>17)>>>0,e=Hn(e,PF)>>>0,i=(i^e)>>>0,i=(i<<13|i>>>19)>>>0,i=i*5+3864292196>>>0,i}var jx,qx;function IF(){return qx||(qx=1,PE(),jx=ut().Symbol.for),jx}var Jx,Xx;function RF(){return Xx||(Xx=1,Jx={default:IF(),__esModule:!0}),Jx}var MF=RF();const AF=Qe(MF),Gg=3,NF=.8;let yr=0,Sr=0,Kx=0,Yx=0;class rc{constructor(e=rc.generateHashSeeds(Gg)){this.hashSeeds=e,this.loadFactor=NF,this.size=0,this.emptyLow=4294967295,this.emptyHigh=4294967295,this.maxRehashAttempts=5,this.maxAttempts=5,this.generation=0,this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=rc.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){const t=this.hashSeeds.length,n=new Array(t);for(let d=0;d<t;++d)n[d]=this.getHash(d,this.emptyLow,this.emptyHigh);let r=this.mungedEmptyKey;if(r===-1)e:for(;;){r=Math.random()*16777216>>>0;for(let d=0;d<t;++d){let u=this.getHash(d,r,r);for(let h=0;h<t;++h)if(n[h]===u)continue e}this.mungedEmptyKey=r;break}let s=this.table,a=this.emptyLow,l=this.emptyHigh;for(let d=0;d<t;++d){let u=n[d];s[u]===a&&s[u+1]===l&&(s[u]=r,s[u+1]=r)}try{e(s)}finally{for(let d=0;d<t;++d){let u=n[d];s[u]===r&&s[u+1]===r&&(s[u]=a,s[u+1]=l)}}}static generateHashSeeds(e=Gg){return HV(new Uint32Array(e))}getHash(e,t,n){let r=this.hashSeeds[e];return r=yu(r,t),r=yu(r,n),this.entryStride*(r&this.tableSize-1)}*keys(){let e=this.emptyLow,t=this.emptyHigh,n=this.entryStride,r=this.table;for(let s=0,a=r.length;s<a;s+=n){let l=r[s],d=r[s+1];(l!==e||d!==t)&&(yield new te(l,d))}}*unsafeKeys(e=new te){let t=this.emptyLow,n=this.emptyHigh,r=this.entryStride,s=this.table;for(let a=0,l=s.length;a<l;a+=r){let d=s[a],u=s[a+1];(d!==t||u!==n)&&(e.low=d,e.high=u,yield e)}}indexOfPair(e,t){let n=this.table,r=this.emptyLow,s=this.emptyHigh;if(e===r&&t===s)return-1;for(let a=0,l=this.hashSeeds.length;a<l;++a){let d=this.getHash(a,e,t);if(n[d]===e&&n[d+1]===t)return d}return-1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){let e=this.emptyLow,t=this.emptyHigh,n=this.table,r=this.entryStride,s,a;for(;s=Math.random()*4294967296>>>0,a=Math.random()*4294967296>>>0,!(!(s===e&&a===t)&&!this.hasPair(s,a)););this.emptyLow=s,this.emptyHigh=a;for(let l=0,d=n.length;l<d;l+=r)n[l]===e&&n[l+1]===t&&(n[l]=s,n[l+1]=a)}has(e){return this.indexOf(e)!==-1}hasPair(e,t){return this.indexOfPair(e,t)!==-1}delete(e){let t=this.indexOf(e);if(t!==-1){let n=this.table;return n[t]=this.emptyLow,n[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){let e=this.table,t=this.entryStride,n=this.emptyLow,r=this.emptyHigh,s=e.length;for(let a=0;a<s;a+=t)e[a]=n,e[a+1]=r}clear(){return this.size===0?!1:(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return e>this.capacity?(this.backupPending(),this.grow(e),this.restorePending(),!0):!1}swapPending(e,t){let n=yr,r=Sr;this.storePending(e,t),e[t]=n,e[t+1]=r}storePending(e,t){yr=e[t],Sr=e[t+1]}backupPending(){Kx=yr,Yx=Sr}restorePending(){yr=Kx,Sr=Yx}tryToInsert(){let e=0,t=this.emptyLow,n=this.emptyHigh,r=this.maxAttempts,s=this.table,a=this.hashSeeds.length,l=Math.floor(Math.random()*a);for(;;){let d=this.getHash(l,yr,Sr);if(this.swapPending(s,d),yr===t&&Sr===n)return!0;if(++e===r)break;l=(l+Math.floor(Math.random()*(a-1))+1)%a}return!1}allocate(e){this.tableSize=e;let t=this.entryStride;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let n=this.emptyLow,r=this.emptyHigh,s=this.entryStride;for(let a=0,l=e.length;a<l;a+=s){let d=e[a],u=e[a+1];if((d!==n||u!==r)&&(this.storePending(e,a),!this.tryToInsert()))return!1}return!0}grow(e){let t=this.table,n=this.tableSize;for(;n<e;)n*=2;for(;;){for(let r=0;r<this.maxRehashAttempts;++r)if(this.rehash(t,n))return;n*=2}}insertInternal(){for(++this.generation,yr===this.emptyLow&&Sr===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(this.tableSize*2),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}}class gT extends rc{add(e){let t=e.low,n=e.high;return this.hasPair(t,n)?!1:(yr=t,Sr=n,this.insertInternal(),!0)}[Mi](){return this.unsafeKeys()}}gT.prototype.entryStride=2;let Pl=0,Il=0,Zx=0,Qx=0;class Hv extends rc{set(e,t){let n=e.low,r=e.high;return this.hasPair(n,r)?!1:(yr=n,Sr=r,Pl=t.low,Il=t.high,this.insertInternal(),!0)}get(e,t){let n=this.indexOf(e);if(n===-1)return!1;let r=this.table;return t.low=r[n+2],t.high=r[n+3],!0}swapPending(e,t){let n=Pl,r=Il;super.swapPending(e,t),e[t+2]=n,e[t+3]=r}storePending(e,t){super.storePending(e,t),Pl=e[t+2],Il=e[t+3]}backupPending(){super.backupPending(),Zx=Pl,Qx=Il}restorePending(){super.restorePending(),Pl=Zx,Il=Qx}[Mi](){return this.unsafeEntries()}*entries(){let e=this.emptyLow,t=this.emptyHigh,n=this.entryStride,r=this.table;for(let s=0,a=r.length;s<a;s+=n){let l=r[s],d=r[s+1];if(l!==e||d!==t){let u=new te(l,d),h=new te(r[s+2],r[s+3]);yield[u,h]}}}*unsafeEntries(e=[new te,new te]){let t=this.emptyLow,n=this.emptyHigh,r=this.entryStride,s=this.table;var a=ae(e,2);let l=a[0],d=a[1];for(let u=0,h=s.length;u<h;u+=r){let g=s[u],v=s[u+1];(g!==t||v!==n)&&(l.low=g,l.high=v,d.low=s[u+2],d.high=s[u+3],yield e)}}}Hv.prototype.entryStride=4;class gh{}const Ws=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],VF=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],Rd=["","r","rg","rgb","rgba"],OF=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],BF=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],_F=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],FF=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],e1=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],UF=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],zF=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function jv(i){return i===q.FLOAT32?"":fL[i]?"i":"u"}function Ic(i,e,t=1){switch(e){case q.UINT8:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=OF[t],i.textureFormat=Ws[t],i.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,i.arrayElementsPerTexel=t,i.arrayConstructor=Uint8Array,i.samplerPrefix="u",i;case q.INT8:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=BF[t],i.textureFormat=Ws[t],i.texelType=WebGL2RenderingContext.BYTE,i.arrayElementsPerTexel=t,i.arrayConstructor=Int8Array,i.samplerPrefix="i",i;case q.UINT16:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=_F[t],i.textureFormat=Ws[t],i.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,i.arrayElementsPerTexel=t,i.arrayConstructor=Uint16Array,i.samplerPrefix="u",i;case q.INT16:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=FF[t],i.textureFormat=Ws[t],i.texelType=WebGL2RenderingContext.SHORT,i.arrayElementsPerTexel=t,i.arrayConstructor=Int16Array,i.samplerPrefix="i",i;case q.UINT32:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=e1[t],i.textureFormat=Ws[t],i.texelType=WebGL2RenderingContext.UNSIGNED_INT,i.arrayElementsPerTexel=1,i.arrayConstructor=Uint32Array,i.samplerPrefix="u",i;case q.INT32:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=UF[t],i.textureFormat=Ws[t],i.texelType=WebGL2RenderingContext.INT,i.arrayElementsPerTexel=1,i.arrayConstructor=Int32Array,i.samplerPrefix="i",i;case q.UINT64:if(t<1||t>2)break;return i.texelsPerElement=1,i.textureInternalFormat=e1[t*2],i.textureFormat=Ws[t*2],i.texelType=WebGL2RenderingContext.UNSIGNED_INT,i.arrayElementsPerTexel=2*t,i.arrayConstructor=Uint32Array,i.samplerPrefix="u",i;case q.FLOAT32:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=zF[t],i.textureFormat=VF[t],i.texelType=WebGL2RenderingContext.FLOAT,i.arrayElementsPerTexel=t,i.arrayConstructor=Float32Array,i.samplerPrefix="",i}throw new Error(`No supported texture format for ${q[e]}[${t}].`)}function qv(i,e,t){const n=e.arrayConstructor,r=e.arrayElementsPerTexel,s=e.textureInternalFormat,a=e.textureFormat,l=e.texelsPerElement,d=i.maxTextureSize,u=t.length/r;if(u*l>d*d)throw new Error("Number of elements exceeds maximum texture size: "+l+" * "+u);const h=Math.ceil(u/d),g=Math.ceil(Fi(h)),v=(1<<g)*l,y=Math.ceil(u/(1<<g)),C=v*y*r;t.constructor!==n&&(t=new n(t.buffer,t.byteOffset,t.byteLength/n.BYTES_PER_ELEMENT));let w=cN(t,C);i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),po(i),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,s,v,y,0,a,e.texelType,w)}function $F(i,e,t,n,r){const s=e.arrayConstructor,a=e.textureInternalFormat,l=e.textureFormat,d=e.texelsPerElement;t.constructor!==s&&(t=new s(t.buffer,t.byteOffset,t.byteLength/s.BYTES_PER_ELEMENT)),i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),po(i),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,a,n*d,r,0,l,e.texelType,t)}function GF(i,e,t,n,r,s){const a=e.arrayConstructor,l=e.textureInternalFormat,d=e.textureFormat,u=e.texelsPerElement;t.constructor!==a&&(t=new a(t.buffer,t.byteOffset,t.byteLength/a.BYTES_PER_ELEMENT)),i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),$O(i),i.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,l,n*u,r,s,0,d,e.texelType,t)}function WF(i){switch(i){case q.UINT8:return b2;case q.INT8:return w2;case q.UINT16:return C2;case q.INT16:return x2;case q.UINT32:return Tv;case q.INT32:return k2;case q.UINT64:return Dt;case q.FLOAT32:return Lv}}function mT(i,e,t,n,r,s){const a=si(r,s);let l=[WF(r)],d=`
${a} ${i}(${n} index) {
`;switch(r){case q.UINT8:case q.UINT16:case q.UINT32:d+=`
  ${a} result;
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${Rd[s]};
  return result;
`;break;case q.INT8:case q.INT16:case q.INT32:d+=`
  ${a} result;
  highp ivec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${Rd[s]};
  return result;
`;break;case q.UINT64:l.push(eB),d+=`
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  return unpackUint64leFromUint32(temp.${Rd[s*2]});
`;break;case q.FLOAT32:l.push(Lv),d+=`
  highp vec4 temp;
  ${e}(${t}, index, temp);
  return temp.${Rd[s]};
`;break}return d+=`
}
`,l.push(d),l}class Jv{constructor(e){this.key=e,this.readTextureValue=`readTextureValue_${this.key}`}defineShader(e){}getReadTextureValueCode(e,t){let n=`
void ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let r=0;r<e;++r)n+=`, out ${t}vec4 output${r}`;n+=`) {
  highp int width = textureSize(sampler, 0).x / ${e};
  highp uint log2width = log2Exact(uint(width));
  highp int y = int(index >> log2width);
  highp int x = int((index - (uint(y) << log2width)) * ${e}u);
`;for(let r=0;r<e;++r)n+=`
  output${r} = texelFetch(sampler, ivec2(x + ${r}, y), 0);
`;return n+=`
}
`,[aB,n]}getAccessor(e,t,n,r=1){const s=jv(n);return[this.getReadTextureValueCode(1,s),...mT(e,this.readTextureValue,t,"highp uint",n,r)]}}class HF{constructor(e,t){this.key=e,this.textureDims=t,this.readTextureValue=`readTextureValue_${this.key}`}getReadTextureValueCode(e,t){const n=this.textureDims;let r=`
void ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${n} p`;for(let s=0;s<e;++s)r+=`, out ${t}vec4 output${s}`;r+=`) {
`;for(let s=0;s<e;++s)r+=`
  output${s} = texelFetch(sampler, ivec${n}(p.x * ${e} + ${s}, p.y
                                         ${n===3?", p.z":""}), 0);
`;return r+=`
}
`,r}getAccessor(e,t,n,r=1){const s=jv(n);return[this.getReadTextureValueCode(1,s),...mT(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,n,r)]}}const vT=[Dt,`
highp uint hashCombine(highp uint state, highp uint value) {
  value *= 0xcc9e2d51u;
  value = (value << 15u) | (value >> 17u);
  value *= 0x1b873593u;
  state ^= value;
  state = (state << 13u) | (state >> 19u);
  state = (state * 5u) + 0xe6546b64u;
  return state;
}
highp uint hashCombine(highp uint state, uint64_t x) {
  state = hashCombine(state, x.value[0]);
  return hashCombine(state, x.value[1]);
}
`],jF=Ic(new gh,q.UINT64,1);class Rl extends Y{constructor(e,t){super(),this.gl=e,this.hashTable=t,this.generation=-1,this.texture=null,this.texture=e.createTexture()}copyToGPU(){let e=this.hashTable,t=e.generation;if(this.generation===t)return;const n=this.gl,r=this.texture;this.generation=t,n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r),e.tableWithMungedEmptyKey(s=>{qv(this.gl,jF,s)}),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,()=>new this(e,t))}}class yT{constructor(e,t=Gg){this.prefix=e,this.numAlternatives=t,this.textureUnitSymbol=AF(`gpuhashtable:${this.prefix}`),this.accessHelper=new Jv(`gpuhashtable_${this.prefix}`),this.samplerName=this.prefix+"_sampler",this.hashSeedsName=this.prefix+"_seeds",this.hashKeyMask=this.prefix+"_keyMask",this.readTable=this.prefix+"_readTable"}defineShader(e){let t=this.hashSeedsName,n=this.samplerName,r=this.numAlternatives,s=this.hashKeyMask;e.addUniform("highp uint",t,r),e.addUniform("highp uint",s),e.addTextureSampler("usampler2D",n,this.textureUnitSymbol),e.addFragmentCode(vT),e.addFragmentCode(Dt),e.addFragmentCode(v2),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,q.UINT64,1));let a="";a+=`
bool ${this.hasFunctionName}(uint64_t x) {
`;for(let l=0;l<r;++l)a+=`
  {
    uint h = hashCombine(${t}[${l}], x) & ${s};
    uint64_t key = ${this.readTable}(h);
    if (equals(key, x)) {
      return true;
    }
  }
`;a+=`
  return false;
}
`,e.addFragmentCode(a)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,n){n.copyToGPU();const r=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n.texture),e.uniform1ui(t.uniform(this.hashKeyMask),n.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),n.hashTable.hashSeeds)}disable(e,t){const n=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}}class ST extends yT{defineShader(e){super.defineShader(e);let t=this.numAlternatives,n=this.hashSeedsName,r=this.hashKeyMask,s=`
bool ${this.getFunctionName}(uint64_t x, out uint64_t value) {
`;for(let a=0;a<t;++a)s+=`
  {
    uint h = hashCombine(${n}[${a}], x) & ${r};
    uint64_t key = ${this.readTable}(h * 2u);
    if (equals(key, x)) {
      value = ${this.readTable}(h * 2u + 1u);
      return true;
    }
  }
`;s+=`
  return false;
}
`,e.addFragmentCode(s)}get getFunctionName(){return`${this.prefix}_get`}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function Su(i,e,t,n){e*=6;let r=Math.floor(e),s=e-r,a=n*(1-t),l=n*(1-t*s),d=n*(1-t*(1-s));switch(r%6){case 0:i[0]=n,i[1]=d,i[2]=a;break;case 1:i[0]=l,i[1]=n,i[2]=a;break;case 2:i[0]=a,i[1]=n,i[2]=d;break;case 3:i[0]=a,i[1]=l,i[2]=n;break;case 4:i[0]=d,i[1]=a,i[2]=n;break;case 5:i[0]=n,i[1]=a,i[2]=l;break}return i}function qF(i,e,t,n){const r=Math.max(Math.max(e,t),n),s=Math.min(Math.min(e,t),n);if(i[2]=r,s===r)i[0]=0,i[1]=0;else{const a=r-s;i[1]=a/r,e===r?i[0]=(t-n)/a:t===r?i[0]=2+(n-e)/a:i[0]=4+(e-t)/a,i[0]/=6,i[0]<0&&(i[0]+=1),i[0]>1&&(i[0]-=1)}return i}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const t1=2;class JF{constructor(e){this.prefix=e,this.seedName=this.prefix+"_seed"}defineShader(e){const t=this.seedName;e.addUniform("highp uint",t),e.addFragmentCode(Dt),e.addFragmentCode(vT),e.addFragmentCode(QO);let n=`
vec3 ${this.prefix}(uint64_t x) {
  uint h = hashCombine(${t}, x);
  vec${t1} v;
`;for(let r=0;r<t1;++r)n+=`
  v[${r}] = float(h & 0xFFu) / 255.0;
  h >>= 8u;
`;n+=`
  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);
  return hsvToRgb(hsv);
}
`,e.addFragmentCode(n)}enable(e,t,n){e.uniform1ui(t.uniform(this.seedName),n)}}let i1=new Float32Array(3);function bT(i){return`rgb(${i[0]*100}%,${i[1]*100}%,${i[2]*100}%)`}class Xv{constructor(e=Kw()){this.hashSeed=e,this.changed=new be}static getDefault(){return new Xv(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let n=yu(this.hashSeed,t.low);n=yu(n,t.high);const r=(n&255)/255,s=(n>>8&255)/255;return Su(e,r,.5+.5*s,1),e}computeCssColor(e){return this.compute(i1,e),bT(i1)}randomize(){this.hashSeed=Kw(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return this.hashSeed===0?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){const t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}}class XF{constructor(e){this.prefix=e,this.hashMapShaderManager=new ST("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);let t=`
bool ${this.getFunctionName}(uint64_t x, out vec3 value) {
  uint64_t uint64Value;
  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {
    uint uintValue = uint64Value.value[0];
    value.r = float((uintValue & 0x0000ffu))       / 255.0;
    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;
    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;
    return true;
  }
  return false;
}
`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,n){this.hashMapShaderManager.enable(e,t,n)}disable(e,t){this.hashMapShaderManager.disable(e,t)}}const wT="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='arrowLeftIconTitle'%3e%3ctitle%20id='arrowLeftIconTitle'%3eArrow%20Left%3c/title%3e%3cpath%20d='M9%206l-6%206%206%206'/%3e%3cpath%20d='M21%2012H4'/%3e%3cpath%20stroke-linecap='round'%20d='M3%2012h1'/%3e%3c/svg%3e",CT="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='arrowRightIconTitle'%3e%3ctitle%20id='arrowRightIconTitle'%3eArrow%20Right%3c/title%3e%3cpath%20d='M15%2018l6-6-6-6'/%3e%3cpath%20d='M3%2012h17'/%3e%3cpath%20stroke-linecap='round'%20d='M21%2012h-1'/%3e%3c/svg%3e";/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class KF{constructor(e){if(this.parents=new Array,this.parentPriorities=new Array,this.bindings=new ce,e!==void 0){this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities);for(const n of e.bindings){var t=ae(n,2);const r=t[0],s=t[1];this.bindings.set(r,s)}}}addParent(e,t){const n=this.parents,r=this.parentPriorities;let s=0;const a=n.length;for(;s<a&&t<r[s];)++s;return n.splice(s,0,e),r.splice(s,0,t),()=>{this.removeParent(e)}}removeParent(e){const t=this.parents.indexOf(e);if(t===-1)throw new Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){const t=this.parents,n=this.parentPriorities,r=n.length;let s=0,a;for(;s<r&&n[s]>0;++s)if(a=t[s].get(e),a!==void 0)return a;if(a=this.bindings.get(e),a!==void 0)return a;for(;s<r;++s)if(a=t[s].get(e),a!==void 0)return a}*getAll(e){const t=this.parents,n=this.parentPriorities,r=n.length;let s=0,a;for(;s<r&&n[s]>0;)a=t[s].get(e),a!==void 0&&(yield a);for(a=this.bindings.get(e),a!==void 0&&(yield a);s<r;)a=t[s].get(e),a!==void 0&&(yield a)}*entries(){const e=this.parents,t=this.parentPriorities,n=t.length;let r=0;for(;r<n&&t[r]>0;++r)yield*e[r].entries();for(yield*this.bindings.entries();r<n;++r)yield*e[r].entries()}}var n1;(function(i){i[i.CONTROL=1]="CONTROL",i[i.ALT=2]="ALT",i[i.META=4]="META",i[i.SHIFT=8]="SHIFT"})(n1||(n1={}));function Kv(i){return(i.ctrlKey?1:0)|(i.altKey?2:0)|(i.metaKey?4:0)|(i.shiftKey?8:0)}function Wg(i,e){let t="";return e&1&&(t+="control+"),e&2&&(t+="alt+"),e&4&&(t+="meta+"),e&8&&(t+="shift+"),t+=i,t}function YF(i,e,t){let n="";return e&1&&(n+="control+"),t&1&&(n+="control?+"),e&2&&(n+="alt+"),t&2&&(n+="alt?+"),e&4&&(n+="meta+"),t&4&&(n+="meta?+"),e&8&&(n+="shift+"),t&8&&(n+="shift?+"),n+=i,n}function r1(i){const e=i.indexOf(":");let t;if(e!==-1&&(t=i.substring(0,e),t!=="at"&&t!=="bubble"))throw new Error(`Invalid event phase: ${re(t)}`);const n=i.substring(e+1).split("+");let r,s=0,a=0;e:for(let l of n)switch(l){case"control":s|=1;break;case"control?":a|=1;break;case"alt":s|=2;break;case"alt?":a|=2;break;case"meta":s|=4;break;case"meta?":a|=4;break;case"shift":s|=8;break;case"shift?":a|=8;break;default:if(r===void 0)r=l;else{r=void 0;break e}}if(r===void 0||s&a)throw new Error(`Invalid event identifier: ${re(i)}`);return{phase:t,keyName:r,modifiers:s,optionalModifiers:a}}function*ZF(i,e,t){t===0&&(yield Wg(i,e));for(let n=0;n<16;++n)(n&(e|t))===n&&(n&e)===e&&(yield Wg(i,n))}function*s1(i){const e=i.phase,t=ZF(i.keyName,i.modifiers,i.optionalModifiers);if(e===void 0)for(const n of t)yield`at:${n}`,yield`bubble:${n}`;else for(const n of t)yield`${e}:${n}`}function QF(i,e){const t=YF(i.keyName,i.modifiers,i.optionalModifiers);return typeof e=="string"?{action:e,originalEventIdentifier:t}:H(H({},e),{originalEventIdentifier:t})}class at extends KF{static fromObject(e,t={}){const n=new at;if(n.label=t.label,t.parents!==void 0)for(const s of t.parents){var r=ae(s,2);const a=r[0],l=r[1];n.addParent(a,l)}for(const s of Qt(e))n.set(s,e[s]);return n}setFromObject(e){for(const t of Qt(e))this.set(t,e[t])}set(e,t){const n=r1(e),r=QF(n,t);for(const s of s1(n))super.set(s,r)}delete(e){for(const t of s1(r1(e)))super.delete(t)}describe(){const e=[],t=new ce;for(const s of this.entries()){var n=ae(s,2);const a=n[1];t.set(a.originalEventIdentifier,a.action)}for(const s of t){var r=ae(s,2);const a=r[0],l=r[1];e.push(`${a}→${l}`)}return e.join(", ")}}function xT(i,e,t){if(t===void 0)return;t.stopPropagation!==!1&&i.stopPropagation();const n=new CustomEvent("action:"+t.action,{bubbles:!0,detail:e,cancelable:!0}),r=!i.target.dispatchEvent(n);(t.preventDefault!==!1||r)&&i.preventDefault()}const mh=[];mh[Event.AT_TARGET]="at";mh[Event.CAPTURING_PHASE]="capture";mh[Event.BUBBLING_PHASE]="bubble";function kT(i,e,t,n,r){const s=mh[t]+":"+i,a=r.get(s);xT(e,n,a)}function ET(i,e,t,n){kT(Wg(i,Kv(e)),e,e.eventPhase,t,n)}function ve(i,e,t,n){return Tn(i,`action:${e}`,t,n)}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/let Rf;function eU(){if(Rf===void 0){const i=new at;i.set("keyl","recolor"),i.set("keyx","clear-segments"),i.set("keys","toggle-show-slices"),i.set("keyb","toggle-scale-bar"),i.set("keyv","toggle-default-annotations"),i.set("keya","toggle-axis-lines"),i.set("keyo","toggle-orthographic-projection");for(let e=1;e<=9;++e)i.set("digit"+e,"toggle-layer-"+e),i.set("control+digit"+e,"select-layer-"+e),i.set("alt+digit"+e,"toggle-pick-layer-"+e);for(let e=0;e<26;++e){const t=String.fromCharCode(97+e),n=String.fromCharCode(65+e);i.set(`alt?+control?+shift+key${t}`,`tool-${n}`)}i.set("keyn","add-layer"),i.set("keyh","help"),i.set("space","toggle-layout"),i.set("shift+space","toggle-layout-alternative"),i.set("backslash","toggle-show-statistics"),Rf=i}return Rf}let Mf;function vh(){return Mf===void 0&&(Mf=at.fromObject({"control+mousedown2":"select-position"})),Mf}let Af;function tU(){return Af===void 0&&(Af=at.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[vh(),0]]})),Af}let Nf;function LT(){return Nf===void 0&&(Nf=at.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:alt+mousedown2":"copy-segment-id","at:alt+shift+mousedown2":"add-copy-segment-id","at:dblclick0":"select","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[vh(),0]]})),Nf}let Vf;function iU(){return Vf===void 0&&(Vf=at.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[LT(),Number.NEGATIVE_INFINITY]]})),Vf}let Of;function nU(){return Of===void 0&&(Of=at.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[LT(),Number.NEGATIVE_INFINITY]]})),Of}function rU(i){i.global.addParent(eU(),Number.NEGATIVE_INFINITY),i.sliceView.addParent(nU(),Number.NEGATIVE_INFINITY),i.perspectiveView.addParent(iU(),Number.NEGATIVE_INFINITY)}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function Ke(i){for(;;){let e=i.firstChild;if(!e)break;i.removeChild(e)}}function kt(i){let e=i.parentElement;return e?(e.removeChild(i),!0):!1}function _i(i,e=Math.max(1,i.value.length)){const t=`${e}ch`;i.style.width!==t&&(i.style.width="0px",i.offsetWidth,i.style.width=t)}function Xn(i,e){let t=i.firstElementChild;for(const n of e)n!==t&&i.insertBefore(n,t),t=n.nextElementSibling;for(;t!==null;){let n=t.nextElementSibling;i.removeChild(t),t=n}}function Yv(i){return i instanceof HTMLElement?!!(i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement||i.isContentEditable):!1}function sU(i){const e=i.cloneNode(!0);return e.style.position="absolute",document.body.appendChild(e),e.getBoundingClientRect()}let io,Gl=[];function aU(){if(io===void 0){const i=io=document.createElement("div");i.classList.add("neuroglancer-drag-status"),document.body.appendChild(i)}return io}function oU(){io!==void 0&&(Ke(io),io.style.display="none")}function TT(i){const e=aU();Ke(e),typeof i=="string"?e.appendChild(document.createTextNode(i)):e.appendChild(i()),e.style.display=""}function DT(i,e){$E(Gl,t=>!(t.target===i&&t.operation===e))}function Kn(i,e,t){DT(i,e),Gl.push({target:i,operation:e,status:t}),TT(t)}function pi(i,e){DT(i,e);const t=Gl.length===0?void 0:Gl[Gl.length-1];t===void 0?oU():TT(t.status)}const lU=300,cU=100,la={side:"right",col:0,row:1/0,flex:1,size:lU,minSize:cU,visible:!1};class Ts{constructor(e=la,t=e){this.defaultValue=e,this.value=t,this.changed=new Ze,this.locationChanged=new Ze,this.locationChanged.add(this.changed.dispatch);const n=this;this.watchableVisible={get value(){return n.visible},set value(r){n.visible=r},changed:n.locationChanged}}toJSON(e=this.defaultValue){const t={},n=this.value;for(const r in n)n[r]!==e[r]&&(t[r]=n[r]);return t}get visible(){return this.value.visible}set visible(e){const t=this.value;t.visible!==e&&(this.value=H(H({},t),{visible:e}),this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e,t=this.defaultValue){if(e===void 0)return;ge(e);const n={side:ye(e,"side",r=>{if(r!=="left"&&r!=="right"&&r!=="top"&&r!=="bottom")throw new Error(`Expected "left", "right", "top", or "bottom", but received: ${re(r)}`);return r},t.side),col:ye(e,"col",vt,t.col),row:ye(e,"row",vt,t.row),flex:ye(e,"flex",vt,t.flex),size:ye(e,"size",ai,t.size),visible:ye(e,"visible",oo,t.visible),minSize:t.minSize};this.value=n,this.locationChanged.dispatch()}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function Rn(i,e,t){const n=i.view.document;let r=i.clientX,s=i.clientY;const a=h=>{const g=h.clientX-r,v=h.clientY-s;r=h.clientX,s=h.clientY,e(h,g,v)},l=i.button,d=h=>{n.removeEventListener("pointermove",a,!0),n.removeEventListener("pointerup",u,!1),t!==void 0&&t(h,h.clientX-r,h.clientY-s)},u=h=>{h.button===l&&d(h)};n.addEventListener("pointermove",a,!0),n.addEventListener("pointerup",u,!1),n.addEventListener("pointercancel",d,!1)}const dU="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='closeIconTitle'%3e%3ctitle%20id='closeIconTitle'%3eClose%3c/title%3e%3cpath%20d='M6.34314575%206.34314575L17.6568542%2017.6568542M6.34314575%2017.6568542L17.6568542%206.34314575'/%3e%3c/svg%3e",uU="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='refreshIconTitle'%3e%3ctitle%20id='refreshIconTitle'%3eRefresh%3c/title%3e%3cpolyline%20points='22%2012%2019%2015%2016%2012'/%3e%3cpath%20d='M11,20%20C6.581722,20%203,16.418278%203,12%20C3,7.581722%206.581722,4%2011,4%20C15.418278,4%2019,7.581722%2019,12%20L19,14'/%3e%3c/svg%3e";function ft(i){const e=i.title,t=i.onClick,n=i.href;let r;n!==void 0?(r=document.createElement("a"),r.href=n,r.target="_blank"):r=document.createElement("div"),e!==void 0&&(r.title=e),t!==void 0&&r.addEventListener("click",t);const s=i.svg;return r.className="neuroglancer-icon",s!==void 0&&(r.innerHTML=s),i.text!==void 0&&r.appendChild(document.createTextNode(i.text)),r}/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function Zv(i={}){return ft(H({svg:dU},i))}function hU(i={}){return ft(H({svg:uU},i))}const no="neuroglancer-drag-over",a1={row:"row",column:"col"},pU={left:"right",right:"left",top:"bottom",bottom:"top"},rs={left:"column",right:"column",top:"row",bottom:"row"},Md={left:"row",right:"row",top:"column",bottom:"column"},Wa={row:"width",column:"height"},o1={row:"left",column:"top"},fU={row:"right",column:"bottom"},l1={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},Ad={left:-1,right:1,top:-1,bottom:1};class ca extends Y{constructor(e,t=new Ts){super(),this.sidePanelManager=e,this.location=t,this.element=document.createElement("div"),this.visibility=new Nt(Nt.VISIBLE);const n=this.element;n.classList.add("neuroglancer-side-panel"),n.draggable=!0,n.addEventListener("dragstart",r=>{this.sidePanelManager.startDrag(this.makeDragSource(),r),n.style.backgroundColor="black",setTimeout(()=>{n.style.backgroundColor=""},0),Kn(n,"drag",()=>document.createTextNode("Drag side panel to move it to the left/right/top/bottom of another panel"))}),n.addEventListener("dragend",r=>{this.sidePanelManager.endDrag(),pi(n,"drag")})}makeDragSource(){return{dropAsNewPanel:e=>{const t=this.location.value;this.location.value=H(H({},t),e),this.location.locationChanged.dispatch()}}}close(){this.location.visible=!1}addTitleBar(e){const t=document.createElement("div");t.classList.add("neuroglancer-side-panel-titlebar");const n=e.title;let r;n!==void 0&&(r=document.createElement("div"),r.classList.add("neuroglancer-side-panel-title"),r.textContent=n,t.appendChild(r));const s=Zv({title:"Close panel",onClick:()=>{this.close()}});return s.style.order="100",t.appendChild(s),this.element.appendChild(t),{titleBar:t,titleElement:r,closeButton:s}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",t=>{t.preventDefault(),t.stopPropagation()}),this.element.appendChild(e)}}class gU extends Y{constructor(e,t,n=new Nt(Nt.VISIBLE)){super(),this.display=e,this.center=t,this.visibility=n,this.element=document.createElement("div"),this.centerColumn=document.createElement("div"),this.beforeRender=new Ze,this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")},this.registeredPanels=new $e,this.layoutNeedsUpdate=!1,this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};const r=this.element,s=this.centerColumn;r.style.display="flex",r.style.flex="1",r.style.flexDirection="row",s.style.display="flex",s.style.flex="1",s.style.flexDirection="column",s.style.flexBasis="0px",s.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add(()=>{this.beforeRender.dispatch(),this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)})),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}get visible(){return this.visibility.visible}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,Ad[e]*(1/0),0,e,!1)}}hasDroppablePanel(){return this.dragSource!==void 0}startDrag(e,t){setTimeout(()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")},0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,n,r,s=!1){const a=document.createElement("div");a.className="neuroglancer-side-panel-drop-zone";const l=10,d=rs[r],u=Md[r];return a.style[Wa[u]]=`${l}px`,a.style[Wa[d]]="100%",s?(a.style.position="absolute",a.style[r]="50%",a.style[l1[r]]="-${size/2}px"):(a.style.position="relative",a.style[l1[pU[r]]]=`-${l}px`),a.addEventListener("dragenter",h=>{this.hasDroppablePanel()&&(a.classList.add(no),h.preventDefault(),Kn(a,"drop",()=>document.createTextNode(`Drop side panel as new ${d}`)))}),a.addEventListener("dragleave",()=>{pi(a,"drop"),a.classList.remove(no)}),a.addEventListener("dragover",h=>{this.hasDroppablePanel()&&h.preventDefault()}),a.addEventListener("drop",h=>{const g=this.dragSource;if(g===void 0)return;pi(a,"drop"),a.classList.remove(no);const v=rs[e];g.dropAsNewPanel({side:e,row:v==="column"?n:t,col:v==="row"?n:t}),this.dragSource=void 0,h.preventDefault(),h.stopPropagation()}),a}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){var t;this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),(t=e.panel)===null||t===void 0||t.dispose(),this.invalidateLayout()}disposed(){for(const e of this.registeredPanels)e.panel?.dispose();super.disposed()}render(){this.layoutNeedsUpdate=!1;const e={left:[],right:[],top:[],bottom:[]};for(const a of this.registeredPanels)e[a.location.value.side].push(a);const t=a=>this.renderSide(a,this.sides[a].flexGroups,e[a]),n=this;function*r(){yield n.sides.left.outerDropZoneElement,yield*t("left"),yield n.centerColumn,yield*t("right"),yield n.sides.right.outerDropZoneElement}Xn(this.element,r());function*s(){yield n.sides.top.outerDropZoneElement,yield*t("top"),yield n.center,yield*t("bottom"),yield n.sides.bottom.outerDropZoneElement}Xn(this.centerColumn,s())}makeCrossGutter(e,t){const n=document.createElement("div");n.style.position="relative";const r=Md[e];n.className=`neuroglancer-resize-gutter-${r==="row"?"horizontal":"vertical"}`,n.addEventListener("pointerdown",a=>{if("button"in a&&a.button!==0)return;a.preventDefault();const l=this.sides[e].flexGroups[t];if(l===void 0||!l.visible)return;let d=l.element.getBoundingClientRect()[Wa[r]];const u=l.minSize,h=()=>{Kn(n,"drag",`Drag to resize, current ${Wa[r]} is ${l.crossSize}px`)};h(),Rn(a,(g,v,y)=>{const C=r==="row"?v:y;d-=Ad[e]*C,l.crossSize=Math.max(u,Math.round(d)),h(),this.invalidateLayout()},()=>{pi(n,"drag")})});const s=this.makeDropZone(e,t-Ad[e]*.5,0,e,!0);return n.appendChild(s),n}makeFlexGutter(e,t,n){const r=document.createElement("div");r.style.position="relative";const s=rs[e];r.className=`neuroglancer-resize-gutter-${s==="row"?"horizontal":"vertical"}`,r.addEventListener("pointerdown",l=>{if("button"in l&&l.button!==0)return;l.preventDefault();const d=this.sides[e].flexGroups[t];if(d===void 0||!d.visible)return;const u=d.cells,h=u[n];if(h===void 0||!h.registeredPanel.location.visible)return;let g=n+1;for(;g<u.length&&!u[g].registeredPanel.location.visible;)++g;if(g===u.length)return;const v=u[g],y=()=>{Kn(r,"drag",`Drag to resize, current ${Wa[s]} ratio is ${h.registeredPanel.location.value.flex} : ${v.registeredPanel.location.value.flex}`)};y(),Rn(l,C=>{const w=h.registeredPanel.panel,b=v.registeredPanel.panel;if(w===void 0||b===void 0)return;const k=w.element.getBoundingClientRect(),L=b.element.getBoundingClientRect(),I=Math.max(.1,Math.min(.9,s==="column"?(C.clientY-k.top)/(L.bottom-k.top):(C.clientX-k.left)/(L.right-k.left))),P=h.registeredPanel.location.value,T=v.registeredPanel.location.value,R=P.flex+T.flex;h.registeredPanel.location.value=H(H({},P),{flex:Math.round(I*R*100)/100}),v.registeredPanel.location.value=H(H({},T),{flex:Math.round((1-I)*R*100)/100}),y(),h.registeredPanel.location.locationChanged.dispatch(),v.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()},()=>{pi(r,"drag")})});const a=this.makeDropZone(e,t,n+.5,o1[rs[e]],!0);return r.appendChild(a),r}renderSide(e,t,n){const r=a1[Md[e]],s=a1[rs[e]];n.sort((d,u)=>{const h=d.location.value,g=u.location.value,v=h[s]-g[s];return v!==0?v:h[r]-g[r]});const a=this;function*l(){let d=0,u=n.length,h=0;for(;d<u;){const g=n[d].location.value[s];let v=d,y=0,C=0;do{const L=n[v].location.value;if(L[s]!==g)break;L.visible&&(++y,C=Math.max(C,L.minSize)),++v}while(v<u);const w=y>0;let b=t[h];if(b===void 0){const L=a.makeCrossGutter(e,h),I=document.createElement("div");I.className=`neuroglancer-side-panel-${rs[e]}`,b=t[h]={element:I,gutterElement:L,cells:[],crossSize:-1,minSize:C,visible:w,beginDropZone:a.makeDropZone(e,h,-1/0,o1[rs[e]]),endDropZone:a.makeDropZone(e,h,1/0,fU[rs[e]])}}else b.visible=w,b.minSize=C,b.crossSize=Math.max(b.crossSize,C);function*k(){yield b.beginDropZone;let L=0;for(let I=d,P=0;I<v;++I,++P){const T=n[I];let R=b.cells[P];R===void 0?R=b.cells[P]={registeredPanel:T,gutterElement:void 0}:R.registeredPanel=T;const M=R.registeredPanel.location.value;b.crossSize==-1&&(b.crossSize=Math.max(C,M.size)),(M[s]!==h||M[r]!==P||M.visible&&M.size!==b.crossSize)&&(R.registeredPanel.location.value=H(H({},M),{[s]:h,[r]:P,size:M.visible?b.crossSize:M.size}),R.registeredPanel.location.changed.dispatch());const V=M.visible&&a.visibility.visible;let B=T.panel;if(!V){B!==void 0&&(B.dispose(),T.panel=void 0);continue}++L,B===void 0&&(B=T.panel=T.makePanel()),B.element.style.flex=y>1?`${M.flex}`:"1",yield B.element,L===y?R.gutterElement=void 0:(R.gutterElement===void 0&&(R.gutterElement=a.makeFlexGutter(e,h,P)),yield R.gutterElement)}yield b.endDropZone}Xn(b.element,k()),b.cells.length=v-d,w&&(b.element.style[Wa[Md[e]]]=`${b.crossSize}px`,Ad[e]>0?(yield b.gutterElement,yield b.element):(yield b.element,yield b.gutterElement)),d=v,++h}t.length=h}return l()}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function Ji(i,e="text/plain"){let t=!1;const n=Tn(document,"copy",r=>{const s=r.clipboardData;s!==null&&(s.setData(e,i),t=!0),r.stopPropagation(),r.preventDefault()},!0);try{document.execCommand("copy")}finally{n()}return t}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class Br extends Y{constructor(e,t,n){super(),this.target=e,this.eventMap=t,this.registerEventListener(e,"wheel",r=>{n!==void 0&&n(r),this.dispatch("wheel",r)}),this.registerEventListener(e,"click",r=>{n!==void 0&&n(r),this.dispatch(`click${r.button}`,r)}),this.registerEventListener(e,"dblclick",r=>{n!==void 0&&n(r),this.dispatch(`dblclick${r.button}`,r)}),this.registerEventListener(e,"mousedown",r=>{n!==void 0&&n(r);let s=r.button;s===2&&(r.buttons&3)===1&&(s=0),this.dispatch(`mousedown${s}`,r)}),this.registerEventListener(e,"mouseup",r=>{n!==void 0&&n(r),this.dispatch(`mouseup${r.button}`,r)})}dispatch(e,t){ET(e,t,t,this.eventMap)}}class Gn extends Y{constructor(e,t){super(),this.element=ft(H(H({},t),{onClick:()=>{e.value=!e.value}})),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add(t.backgroundScheme==="dark"?"dark-background":"light-background");const n=()=>{const r=e.value;this.element.dataset.checked=r?"true":"false",this.element.title=(r?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(n)),n()}}const mU="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='copyIconTitle'%3e%3ctitle%20id='copyIconTitle'%3eCopy%3c/title%3e%3crect%20width='12'%20height='14'%20x='8'%20y='7'/%3e%3cpolyline%20points='16%203%204%203%204%2017'/%3e%3c/svg%3e";function Zn(i={}){return ft(H({svg:mU},i))}/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class vU extends Y{constructor(e){super(),this.redraw=e}}class Qn extends Y{constructor(e,t,n=new Nt(Nt.VISIBLE)){super(),this.model=e,this.render=t,this.visibility=n,this.element=document.createElement("div"),this.generation=-1,this.currentViewDisposer=void 0,this.debouncedUpdateView=this.registerCancellable(dt(()=>this.updateView())),this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(n.changed.add(()=>{this.visible&&this.debouncedUpdateView()})),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;const e=this.model;if(e.changed.count===this.generation)return;this.disposeCurrentView();const t=this.currentViewDisposer=new vU(this.debouncedUpdateView);this.render(e.value,this.element,t)}disposeCurrentView(){let e=this.currentViewDisposer;e!==void 0&&e.dispose(),Ke(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}}function PT(i={}){return ft(H({text:"↗"},i))}function c1(i){return i.closest(".neuroglancer-selection-details")}class d1 extends ca{constructor(e,t,n,r){super(e,t.location),this.sidePanelManager=e,this.state=t,this.manager=n,this.selectedLayer=r,this.body=document.createElement("div");const s=this.element,a=this.body;s.classList.add("neuroglancer-selection-details"),this.registerDisposer(new Br(this.element,vh()));var l=this.addTitleBar({title:"Selection"});const d=l.titleBar,u=ft({svg:wT,title:"Previous selection",onClick:()=>{this.state.goBack()}}),h=ft({svg:CT,title:"Next selection",onClick:()=>{this.state.goForward()}});d.appendChild(u),d.appendChild(h),d.appendChild(this.registerDisposer(new Gn(t.pin,{text:"📌︎",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),a.classList.add("neuroglancer-selection-details-body"),this.addBody(a),a.appendChild(this.registerDisposer(new Qn(t,(g,v,y)=>{if(!(!t.location.visible||(u.style.visibility=t.canGoBack()?"visible":"hidden",h.style.visibility=t.canGoForward()?"visible":"hidden",g===void 0))){if(g.position!==void 0){const w=document.createElement("div");w.classList.add("neuroglancer-selection-details-position");const b=Zn({title:"Copy position",onClick:()=>{Ji(I.map(T=>Math.floor(T)).join(", "))}});w.appendChild(b);var C=g.coordinateSpace;const k=C.rank,L=C.names,I=g.position;for(let T=0;T<k;++T){const R=document.createElement("span");R.classList.add("neuroglancer-selection-details-position-dimension");const M=document.createElement("span");M.classList.add("neuroglancer-selection-details-position-dimension-name"),M.textContent=L[T];const V=document.createElement("span");V.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),V.textContent=Math.floor(I[T]).toString(),R.appendChild(M),R.appendChild(V),w.appendChild(R)}const P=PT({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=I}});w.appendChild(P),v.appendChild(w)}for(const w of g.layers){const b=w.layer;v.appendChild(y.registerDisposer(new Qn({value:void 0,changed:b.managedLayer.layerChanged},(k,L,I)=>{if(b.wasDisposed||!b.isReady)return;const P=document.createElement("div");if(P.classList.add("neuroglancer-selection-details-layer-body"),!b.displaySelectionState(w.state,P,I))return;const T=document.createElement("div");L.appendChild(T),T.classList.add("neuroglancer-selection-details-layer");const R=document.createElement("div");R.classList.add("neuroglancer-selection-details-layer-title"),R.textContent=b.managedLayer.name,R.addEventListener("click",()=>{this.selectedLayer.layer=b.managedLayer,this.selectedLayer.visible=!0}),R.title="Click to show layer side panel",T.appendChild(R),T.appendChild(P)})).element)}}})).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}}const yU="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='filterIconTitle'%3e%3ctitle%20id='filterIconTitle'%3eFilter%3c/title%3e%3cpath%20d='M10%2012.261L4.028%203.972h16L14%2012.329V17l-4%203z'/%3e%3c/svg%3e";function SU(i={}){return ft(H({svg:yU},i))}class vs{constructor(e,t,n){this.key=e,this.value=t,this.label=n}toString(){const e=this.key,t=this.value,n=this.label;let r;return t===void 0?r=`${e}`:r=`${e}→${t}`,n===void 0?r:`${r} ${n}`}}class bU extends Y{constructor(){super(...arguments),this.selectedSegment=new te,this.baseSelectedSegment=new te,this.hasSelectedSegment=!1,this.changed=new be}get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e,t=!1){const n=this.selectedSegment,r=this.baseSelectedSegment;let s=0,a=0,l=0,d=0,u;if(e==null)u=!1;else if(typeof e=="number")s=l=e>>>0,a=d=e<0?4294967295:0,u=!0;else if(e instanceof vs){const h=e.value||e.key;s=h.low,a=h.high,l=e.key.low,d=e.key.high,u=!0}else e instanceof te?(s=l=e.low,a=d=e.high,u=!0):u=!1;t&&s===0&&a===0&&(u=!1),u?u&&(!this.hasSelectedSegment||n.low!==s||n.high!==a||r.low!==l||r.high!==d)&&(n.low=s,n.high=a,r.low=l,r.high=d,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&te.equal(e,this.selectedSegment)}bindTo(e,t){this.registerDisposer(e.changed.add(()=>{const n=e.get(t);let r;n!==void 0&&(r=n.value),this.set(r,t.displayState.segmentationGroupState.value.hideSegmentZero.value)}))}}function bu(i){i.useTemporarySegmentEquivalences.value=!1,i.useTemporaryVisibleSegments.value=!1,i.temporaryVisibleSegments.clear(),i.temporarySegmentEquivalences.clear()}function IT(i,e,t=!1){let n,r,s,a;if(typeof e=="number"?n=new te(e>>>0,e<0?4294967295:0):typeof e=="string"?n=te.parseString(e):n=t?e.clone():e,i==null)return n;var l=i.segmentationGroupState.value;const d=l.segmentEquivalences,u=l.segmentPropertyMap.value;return d.size!==0?(r=d.get(n),te.equal(r,n)?s=void 0:s=r):r=n,a=u?.getSegmentLabel(r),a===void 0&&s==null?n:new vs(n,s,a)}function xo(i,e){if(e instanceof vs)return e;let t=IT(i,e);return t instanceof te?new vs(t):t}function u1(i,e){const t=e.length;i.value<t&&(i.value=t)}function sc(i,e){return Lr(t=>e.style.setProperty("--neuroglancer-segment-list-width",`${t}ch`),i.segmentationGroupState.value.maxIdLength)}const Qv=(()=>{const i=document.createElement("div");i.classList.add("neuroglancer-segment-list-entry");const e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-sticky"),i.appendChild(e);const t=Zn({title:"Copy segment ID"});t.classList.add("neuroglancer-segment-list-entry-copy");const n=document.createElement("div");n.classList.add("neuroglancer-segment-list-entry-copy-container");const r=n.childElementCount;n.appendChild(t);const s=e.childElementCount;e.appendChild(n);const a=e.childElementCount,l=document.createElement("input");l.type="checkbox",l.title="Toggle segment visibility",l.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.appendChild(l);const d=document.createElement("div");d.classList.add("neuroglancer-segment-list-entry-id-container");const u=e.childElementCount;e.appendChild(d);const h=document.createElement("div");h.classList.add("neuroglancer-segment-list-entry-id");const g=d.childElementCount;d.appendChild(h);const v=document.createElement("span");v.classList.add("neuroglancer-segment-list-entry-name");const y=i.childElementCount;i.appendChild(v);const C=SU({title:"Filter by label"});C.classList.add("neuroglancer-segment-list-entry-filter");const w=i.childElementCount;return i.appendChild(C),{template:i,copyContainerIndex:s,copyIndex:r,visibleIndex:a,idContainerIndex:u,idIndex:g,labelIndex:y,filterIndex:w,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),wU=(()=>{const i=Qv,e=i.template.cloneNode(!0),t=e.children[0],n=t.children[i.idContainerIndex],r=n.childElementCount,s=n.children[i.idIndex].cloneNode(!0);s.classList.add("neuroglancer-segment-list-entry-unmapped-id"),n.appendChild(s);const a=t.children[i.copyContainerIndex],l=a.childElementCount;return a.appendChild(a.children[i.copyIndex].cloneNode(!0)),H(H({},i),{template:e,unmappedIdIndex:r,unmappedCopyIndex:l})})();function CU(i){let e=Qv;const t=e.template.cloneNode(!0),n=[];for(let r=0;r<i;++r){n.push(t.childElementCount);const s=document.createElement("div");s.classList.add("neuroglancer-segment-list-entry-extra-property"),s.style.width=`max(var(--neuroglancer-column-${r}-width), var(--neuroglancer-column-${r}-label-width))`,t.appendChild(s)}return H(H({},e),{template:t,numericalPropertyIndices:n})}const h1=new rT;function xU(i){const e=h=>{const g=h.currentTarget,v=g.dataset.id,y=En;y.tryParseString(v),i.segmentSelectionState.set(y),c1(g)||i.selectSegment(y,!1)},t=h=>{const g=h.currentTarget,v=g.dataset.id,y=En;y.tryParseString(v),i.selectSegment(y,c1(g)?"toggle":!0)},n=()=>{i.segmentSelectionState.set(null)},r=h=>h.currentTarget.closest(".neuroglancer-segment-list-entry"),s=h=>{const g=r(h);Ji(g.dataset.id),h.stopPropagation()},a=h=>{const g=r(h);Ji(g.dataset.unmappedId),h.stopPropagation()},l=h=>{const g=r(h).dataset.id,v=En;v.tryParseString(g);const y=i.segmentationGroupState.value.visibleSegments;y.set(v,!y.has(v)),h.stopPropagation()},d=h=>{const g=r(h).dataset.id,v=En;v.tryParseString(g),i.filterBySegmentLabel(v),h.stopPropagation()},u=h=>{if(h.button!==2||h.ctrlKey||h.altKey||h.metaKey||h.shiftKey)return;const g=h.currentTarget.dataset.id,v=En;v.tryParseString(g),i.moveToSegment(v)};return(h,g)=>{const v=h.children,y=v[0].children;h.addEventListener("mousedown",u);const C=y[g.copyContainerIndex];g.unmappedCopyIndex!==-1&&C.children[g.unmappedCopyIndex].addEventListener("click",a),C.children[g.copyIndex].addEventListener("click",s),h.addEventListener("mouseenter",e),h.addEventListener("mouseleave",n),y[g.visibleIndex].addEventListener("click",l),v[g.filterIndex].addEventListener("click",d),h.addEventListener("action:select-position",t)}}class Rc{constructor(e,t){if(this.displayState=e,this.template=t,e!==void 0){let n=h1.get(e);n===void 0&&(n=xU(e),h1.set(e,n)),this.registerEventHandlers=n}}static make(e,t){return new Rc(e,t?wU:Qv)}get(e){const t=this.displayState;return this.getWithNormalizedId(xo(t,e))}getWithNormalizedId(e){var t,n;const r=this.displayState,s=this.template,a=s.template.cloneNode(!0),l=e.key,d=(t=e.value)!==null&&t!==void 0?t:l,u=d.toString();a.dataset.id=u;const h=a.children,g=h[0].children,v=g[s.idContainerIndex];v.children[s.idIndex].textContent=u;const y=s.unmappedIdIndex;if(r!==void 0?this.registerEventHandlers(a,s):g[s.visibleIndex].style.display="none",y!==-1){const C=v.children[y];if(te.equal(l,d)){C.style.display="none";const w=g[s.copyContainerIndex];w.children[s.unmappedCopyIndex].style.display="none"}else{const w=l.toString();a.dataset.unmappedId=w,C.textContent=w,r!==void 0&&u1(r.segmentationGroupState.value.maxIdLength,w)}}return h[s.labelIndex].textContent=(n=e.label)!==null&&n!==void 0?n:"",r!==void 0&&(this.updateWithId(a,d),u1(r.segmentationGroupState.value.maxIdLength,u)),a}update(e){const t=En,n=e.dataset.id;n!==void 0&&(t.parseString(n),this.updateWithId(e,t))}updateWithId(e,t){const n=e.children[0].children,r=this.template,s=this.displayState,a=s.segmentSelectionState,l=s.segmentationGroupState.value.visibleSegments;n[r.visibleIndex].checked=l.has(t),e.dataset.selected=(a.hasSelectedSegment&&te.equal(a.selectedSegment,t)).toString();const d=n[r.idContainerIndex];p1(d.children[r.idIndex],Hg(this.displayState,t));const u=r.unmappedIdIndex;if(u!==-1){let h,g;if(s.baseSegmentColoring.value&&(h=e.dataset.unmappedId)!==void 0){const v=En;v.parseString(h),g=Hg(this.displayState,v)}else g=aL;p1(d.children[u],g)}}}function p1(i,e){i.style.backgroundColor=bT(e),i.style.color=yg(e)?"white":"black"}class kU extends Rc{constructor(e,t,n){var r;const s=e.segmentationGroupState.value.segmentPropertyMap.value,a=((r=s?.numericalProperties)!==null&&r!==void 0?r:[]).filter(n),l=CU(a.length);super(e,l),this.parentElement=t,this.segmentPropertyMap=s,this.numericalProperties=a,(this.numericalPropertyWidths=new Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){var t,n,r;const s=super.getWithNormalizedId(e),a=this.numericalProperties,l=this.template.numericalPropertyIndices;if(l.length>0){const d=(r=(t=this.segmentPropertyMap)===null||t===void 0?void 0:t.getSegmentInlineIndex((n=e.value)!==null&&n!==void 0?n:e.key))!==null&&r!==void 0?r:-1;if(d!==-1){const u=this.numericalPropertyWidths;for(let h=0,g=l.length;h<g;++h){const v=a[h].values[d];if(!isNaN(v)){const y=v.toString(),C=y.length;C>u[h]&&(u[h]=C,this.parentElement.style.setProperty(`--neuroglancer-column-${h}-width`,`${C}ch`)),s.children[l[h]].textContent=y}}}}return s}makeHeaderLabel(e,t,n){const r=document.createElement("span");r.textContent=e,r.classList.add("neuroglancer-segment-list-header-label"),r.classList.add("neuroglancer-segment-list-header-label"),e==="label"&&(n.style.textAlign="left");const s=document.createElement("span");s.classList.add("neuroglancer-segment-list-header-label-sort"),r.appendChild(s),s.textContent="▲";const a=sU(r).width;return this.parentElement.style.setProperty(t,`${a}px`),n.appendChild(r),{id:e,label:r,sortIcon:s}}getHeader(){const e=this.template,t=e.template.cloneNode(!0),n=t.children,r=n[0].children,s=r[e.copyContainerIndex];s.style.visibility="hidden",r[e.visibleIndex].style.visibility="hidden",n[e.filterIndex].style.visibility="hidden";const a=r[e.idContainerIndex],l=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",a.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",n[e.labelIndex])],d=this.numericalProperties,u=this.template.numericalPropertyIndices;for(let h=0,g=u.length;h<g;++h){const v=d[h],y=this.makeHeaderLabel(v.id,`--neuroglancer-column-${h}-label-width`,t.children[u[h]]),C=v.description;C&&(y.label.title=C),l.push(y)}return{container:t,propertyLabels:l}}}function ey(i,e){return Rc.make(i??void 0,!0).getWithNormalizedId(e)}function Mc(i,e,t){e.registerDisposer(ao((n,r)=>{p_(n,r,t)},i.segmentationGroupState)),e.registerDisposer(ao((n,r)=>{n.registerDisposer(r.segmentColorHash.changed.add(t)),n.registerDisposer(r.segmentDefaultColor.changed.add(t))},i.segmentationColorGroupState)),e.registerDisposer(i.saturation.changed.add(t)),e.registerDisposer(i.segmentSelectionState.changed.add(t)),e.registerDisposer(i.baseSegmentColoring.changed.add(t))}function RT(i,e){const t=e.redrawNeeded.dispatch;Mc(i,e,t),e.registerDisposer(ao((n,r)=>{f_(n,r,t)},i.segmentationGroupState))}function EU(i,e){RT(i,e),e.registerDisposer(i.objectAlpha.changed.add(e.redrawNeeded.dispatch))}function ty(i,e){EU(i,e),e.registerDisposer(i.transform.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(i.renderScaleTarget.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(i.transparentPickEnabled.changed.add(e.redrawNeeded.dispatch))}const MT=eh(),En=new te;function Hg(i,e,t=MT){if(i==null)return t.fill(1),t;const n=i.segmentationColorGroupState.value;if(n.segmentStatedColors.size!==0&&n.segmentStatedColors.get(e,En))return t[0]=(En.low&255)/255,t[1]=((En.low&65280)>>>8)/255,t[2]=((En.low&16711680)>>>16)/255,t;const r=n.segmentDefaultColor.value;return r!==void 0?(t[0]=r[0],t[1]=r[1],t[2]=r[2],t):(n.segmentColorHash.compute(t,e),t)}function AT(i,e,t=1){const n=MT;n[3]=t,Hg(i,e,n);let r=i.saturation.value;i.segmentSelectionState.isSelected(e)&&(r>.5?r=r-=.5:r+=.5);for(let s=0;s<3;++s)n[s]=n[s]*r+(1-r);return n[0]*=t,n[1]*=t,n[2]*=t,n}function NT(i,e={}){for(const t of h_)e[t]=i[t].rpcId;return e}const LU=oh(Ec);class iy extends LU{constructor(e,t,n){super(n),this.chunkManager=e,this.displayState=t}initializeCounterpartWithChunkManager(e){let t=this.displayState;e.chunkManager=this.chunkManager.rpcId,NT(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(gi.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(gi.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}}function ny(i,e,t,n,r){const s=Math.min(1,i.objectAlpha.value),a=i.baseSegmentColoring.value;Bo(i.segmentationGroupState.value,(l,d)=>{let u=n?.registerUint64(e,l),h=t?AT(i,a?l:d,s):void 0;r(l,h,u,d)})}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var VT=function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=An(e,t):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(a=i[l])&&(s=(r<3?a(s):r>3?a(e,t,s):a(e,t))||s);return r>3&&s&&Mn(e,t,s),s};const TU=Je(),nn=uc();function OT(i,e){e.vertexBuffer=Ui.fromData(i,e.meshData.vertexPositions,i.ARRAY_BUFFER,i.STATIC_DRAW),e.indexBuffer=Ui.fromData(i,e.meshData.indices,i.ELEMENT_ARRAY_BUFFER,i.STATIC_DRAW),e.normalBuffer=Ui.fromData(i,e.meshData.vertexNormals,i.ARRAY_BUFFER,i.STATIC_DRAW)}function BT(i){i.vertexBuffer.dispose(),i.indexBuffer.dispose(),i.normalBuffer.dispose()}const DU=`
highp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {
  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));
  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);
  return normalize(v);
}
`;function f1(i){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(e,t,n){n.vertexBuffer.bindToVertexAttrib(t.attribute("aVertexPosition"),3,i,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}const PU={[Dr.float32]:f1(WebGL2RenderingContext.FLOAT),[Dr.uint16]:f1(WebGL2RenderingContext.UNSIGNED_SHORT),[Dr.uint10]:{defineShader:i=>{i.addAttribute("highp uint","aVertexPosition"),i.addVertexCode(`
highp vec3 getVertexPosition() {
  return vec3(float(aVertexPosition & 1023u),
              float((aVertexPosition >> 10) & 1023u),
              float((aVertexPosition >> 20) & 1023u)) / 1023.0;
}
`)},bind(i,e,t){t.vertexBuffer.bindToVertexAttribI(e.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(i,e)=>{i.disableVertexAttribArray(e.attribute("aVertexPosition"))}}};class _T{constructor(e,t){this.fragmentRelativeVertices=e,this.vertexPositionFormat=t,this.tempLightVec=new Float32Array(4),this.vertexPositionHandler=PU[this.vertexPositionFormat]}beginLayer(e,t,n,r){let s=n.lightDirection,a=n.ambientLighting,l=n.directionalLighting,d=this.tempLightVec;nv(d,s,l),d[3]=a,e.uniform4fv(t.uniform("uLightDirection"),d);const u=r.silhouetteRendering.value;u>0&&e.uniform1f(t.uniform("uSilhouettePower"),u)}setColor(e,t,n){e.uniform4fv(t.uniform("uColor"),n)}setPickID(e,t,n){e.uniform1ui(t.uniform("uPickID"),n)}beginModel(e,t,n,r){const s=n.projectionParameters;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,ei(TU,s.viewProjectionMat,r)),th(nn,r),dL(nn,nn,s.displayDimensionRenderInfo.canonicalVoxelFactors),DN(nn,nn),TN(nn,nn),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,nn)}drawFragmentHelper(e,t,n,r,s){this.vertexPositionHandler.bind(e,t,n);const a=n.meshData;n.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),n.indexBuffer.bind();const l=a.indices;e.drawElements(a.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,s-r,l.BYTES_PER_ELEMENT===2?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,r*l.BYTES_PER_ELEMENT)}drawFragment(e,t,n){const r=n.meshData.indices;this.drawFragmentHelper(e,t,n,0,r.length)}drawMultiscaleFragment(e,t,n,r,s){const a=n.meshData.subChunkOffsets[r],l=n.meshData.subChunkOffsets[s];this.drawFragmentHelper(e,t,n,a,l)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){const t=e.registerDisposer(cn(n=>n>0,[e.displayState.silhouetteRendering]));return ho(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(n,r)=>{this.vertexPositionHandler.defineShader(n),n.addAttribute("highp vec2","aVertexNormal"),n.addVarying("highp vec4","vColor"),n.addUniform("highp vec4","uLightDirection"),n.addUniform("highp vec4","uColor"),n.addUniform("highp mat3","uNormalMatrix"),n.addUniform("highp mat4","uModelViewProjection"),n.addUniform("highp uint","uPickID"),r&&n.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(n.addUniform("highp vec3","uFragmentOrigin"),n.addUniform("highp vec3","uFragmentShape")),n.addVertexCode(DU);let s="";this.fragmentRelativeVertices?s+=`
highp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();
highp vec3 normalMultiplier = 1.0 / uFragmentShape;
`:s+=`
highp vec3 vertexPosition = getVertexPosition();
highp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);
`,s+=`
gl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);
vec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);
vec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));
float absCosAngle = abs(dot(normal, uLightDirection.xyz));
float lightingFactor = absCosAngle + uLightDirection.w;
vColor = vec4(lightingFactor * uColor.rgb, uColor.a);
`,r&&(s+=`
vColor *= pow(1.0 - absCosAngle, uSilhouettePower);
`),n.setVertexMain(s),n.setFragmentMain("emit(vColor, uPickID);")}})}}class g1 extends Uo{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.meshShaderManager=new _T(!1,Dr.float32),this.getShader=this.meshShaderManager.makeGetter(this),ty(n,this),this.registerDisposer(n.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let r=this.backend=this.registerDisposer(new iy(e,n,this.layerChunkProgressInfo));r.RPC_TYPE_ID=CF,r.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),r.visibility.add(this.visibility),this.registerDisposer(n.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){const e=this.displayState;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const n=this.gl,r=this.displayState,s=this.meshShaderManager;if(r.objectAlpha.value<=0)return;const a=hu(r.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(a===void 0)return;var l=this.getShader(e.emitter);const d=l.shader;if(d===null)return;d.bind(),s.beginLayer(n,d,e,this.displayState),s.beginModel(n,d,e,a);const u=this.source.chunks;let h=0,g=0;const v=this.displayState.renderScaleHistogram,y=this.source.fragmentSource.chunks;ny(r,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(C,w,b)=>{const k=Jn(C),L=u.get(k);if(++h,L!==void 0){++g,e.emitColor&&s.setColor(n,d,w),e.emitPickID&&s.setPickID(n,d,b),h+=L.fragmentIds.length;for(const P of L.fragmentIds){var I=this.source.getFragmentKey(k,P);const T=I.key,R=y.get(T);R!==void 0&&R.state===pt.GPU_MEMORY&&(s.drawFragment(n,d,R),++g)}}}),e.emitColor&&(v.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),v.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,g,h-g)),s.endLayer(n,d)}isReady(){const e=this.displayState,t=this.source;let n=!0;const r=t.fragmentSource.chunks;return Bo(e.segmentationGroupState.value,s=>{const a=Jn(s),l=t.chunks.get(a);if(l===void 0){n=!1;return}for(const u of l.fragmentIds){var d=this.source.getFragmentKey(a,u);const h=d.key,g=r.get(h);if(g===void 0||g.state!==pt.GPU_MEMORY){n=!1;return}}}),n}}class IU extends Ls{constructor(e,t){super(e),this.fragmentIds=t.fragmentIds}}class RU extends Ls{constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),OT(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),BT(this)}}class Ac extends Or{constructor(e,t){super(e,t),this.fragmentSource=this.registerDisposer(new jg(this.chunkManager,this))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new IU(this,e)}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}}let jg=class extends Or{constructor(i,e){super(i),this.meshSource=e}get key(){return this.meshSource.key}getChunk(i){return new RU(this,i)}};jg=VT([hn(kF)],jg);function m1(i,e,t,n){const r=i.get(fT(e,t,n));return r!==void 0&&r.state===pt.GPU_MEMORY}class Bf extends Uo{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.meshShaderManager=new _T(this.source.format.fragmentRelativeVertices,this.source.format.vertexPositionFormat),this.getShader=this.meshShaderManager.makeGetter(this),ty(n,this),this.registerDisposer(n.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let r=this.backend=this.registerDisposer(new iy(e,n,this.layerChunkProgressInfo));r.RPC_TYPE_ID=xF,r.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),r.visibility.add(this.visibility),this.registerDisposer(n.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){const e=this.displayState;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const n=this.gl,r=this.displayState,s=this.meshShaderManager;if(r.objectAlpha.value<=0)return;const a=hu(r.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(a===void 0)return;var l=this.getShader(e.emitter);const d=l.shader;if(d===null)return;d.bind(),s.beginLayer(n,d,e,this.displayState);const u=this.displayState.renderScaleHistogram;e.emitColor&&u.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),th(nn,a),dL(nn,nn,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);const h=Math.pow(Math.abs(tv(nn)),1/3),g=this.source.chunks,v=this.source.fragmentSource.chunks,y=e.projectionParameters,C=ei(Je(),y.viewProjectionMat,a),w=iu(new Float32Array(24),C),b=this.displayState.renderScaleTarget.value,k=this.source.format.fragmentRelativeVertices;s.beginModel(n,d,e,a);let L=0,I=0;ny(r,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(P,T,R)=>{const M=Jn(P),V=g.get(M);if(++L,V===void 0)return;++I;const B=V.manifest,F=B.octree,j=B.chunkShape,U=B.chunkGridSpatialOrigin,O=B.vertexOffsets;e.emitColor&&s.setColor(n,d,T),e.emitPickID&&s.setPickID(n,d,R),Hx(B,C,w,b,y.width,y.height,($,_,se)=>{const oe=m1(v,M,$,_);return e.emitColor&&u.add(B.lodScales[$]*h,se,oe?1:0,oe?0:1),oe},($,_,se,oe)=>{const Re=fT(M,$,_),le=v.get(Re),we=F[5*_],ie=F[5*_+1],he=F[5*_+2],Te=1<<$;k&&(n.uniform3f(d.uniform("uFragmentOrigin"),U[0]+we*j[0]*Te+O[$*3+0],U[1]+ie*j[1]*Te+O[$*3+1],U[2]+he*j[2]*Te+O[$*3+2]),n.uniform3f(d.uniform("uFragmentShape"),j[0]*Te,j[1]*Te,j[2]*Te)),s.drawMultiscaleFragment(n,d,le,se,oe)})}),u.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,I,L-I),s.endLayer(n,d)}isReady(e,t){let n=this.displayState;if(n.objectAlpha.value<=0)return!0;const r=hu(n.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(r===void 0)return!1;const s=this.source.chunks,a=this.source.fragmentSource.chunks,l=e.projectionParameters,d=ei(Je(),l.viewProjectionMat,r),u=iu(new Float32Array(24),d),h=this.displayState.renderScaleTarget.value;let g=!0;return Bo(n.segmentationGroupState.value,v=>{if(!g)return;const y=Jn(v),C=s.get(y);if(C===void 0){g=!1;return}const w=C.manifest;Hx(w,d,u,h,l.width,l.height,(b,k)=>(g=g&&m1(a,y,b,k),g),()=>{})}),g}getObjectPosition(e){const t=this.displayState.transform.value;if(t.error!==void 0)return;const n=this.source.chunks.get(Jn(e));if(n===void 0)return;const r=n.manifest,s=r.clipLowerBound,a=r.clipUpperBound,l=t.rank,d=new Float32Array(l);for(let h=0;h<3;++h)d[h]=(s[h]+a[h])/2;const u=new Float32Array(l);return Er(u,t.modelToRenderLayerTransform,l+1,d,l),u}}class MU extends Ls{constructor(e,t){super(e),this.manifest=t.manifest}}class AU extends Ls{constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),OT(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),BT(this)}}class yh extends Or{constructor(e,t){super(e,t),this.fragmentSource=this.registerDisposer(new qg(this.chunkManager,this)),this.format=t.format}static encodeOptions(e){return H({format:e.format},super.encodeOptions(e))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new MU(this,e)}}let qg=class extends Or{constructor(i,e){super(i),this.meshSource=e}get key(){return this.meshSource.key}getChunk(i){return new AU(this,i)}};qg=VT([hn(EF)],qg);var v1={},y1;function NU(){if(y1)return v1;y1=1;var i=Ot(),e=iT()(!1);return i(i.S,"Object",{values:function(t){return e(t)}}),v1}var S1,b1;function VU(){return b1||(b1=1,NU(),S1=ut().Object.values),S1}var w1,C1;function OU(){return C1||(C1=1,w1={default:VU(),__esModule:!0}),w1}var BU=OU();const Jg=Qe(BU);/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const _U="skeleton/SkeletonLayer";/**
* @license
* Copyright 2018 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const ry=6,sy=`
vec2 getQuadVertexPosition(vec2 lower, vec2 upper) {
  const vec2 coeffs[] = vec2[](
    vec2(0.0, 0.0),
    vec2(0.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 0.0),
    vec2(0.0, 0.0)
  );
  int v = gl_VertexID % 6;
  return mix(lower, upper, coeffs[v]);
}
`;function ay(i,e,t){i.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,ry*e,t)}/**
* @license
* Copyright 2018 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function FU(i,e){const t=new Float32Array((i+1)*(e+1)*3);let n=0;for(let r=0;r<=i;++r){const s=r*Math.PI/i,a=Math.sin(s),l=Math.cos(s);for(let d=0;d<=e;++d){const u=d*2*Math.PI/e,h=Math.sin(u),g=Math.cos(u);t[n++]=g*a,t[n++]=l,t[n++]=h*a}}return t}function UU(i,e){const t=new Uint16Array(i*e*6);let n=0;for(let r=0;r<i;r++)for(let s=0;s<e;s++){const a=r*(e+1)+s,l=a+e+1;t[n++]=a,t[n++]=l,t[n++]=a+1,t[n++]=l,t[n++]=l+1,t[n++]=a+1}return t}class FT extends Y{constructor(e,t,n){super(),this.vertexBuffer=this.registerDisposer(Zl(e,WebGL2RenderingContext.ARRAY_BUFFER,FU,t,n)).value,this.indexBuffer=this.registerDisposer(Zl(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,UU,t,n)).value,this.numIndices=t*n*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode(`
void emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {
  vec3 vertexPosition = aSphereVertex * radii + centerPosition;
  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);
  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);
  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
}
`)}draw(e,t){const n=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(n,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(n)}}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const oy=ry;function Nc(i,e){i.addVertexCode(sy),i.addUniform("highp vec3","uCircleParams"),i.addVarying("highp vec4","vCircleCoord"),i.addVertexCode(`
void emitCircle(vec4 position, float diameter, float borderWidth) {
  gl_Position = position;
  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);
  if (diameter == 0.0) totalDiameter = 0.0;
  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;
  vCircleCoord.xy = circleCornerOffset;
  if (borderWidth == 0.0) {
    vCircleCoord.z = totalDiameter;
    vCircleCoord.w = 1e-6;
  } else {
    vCircleCoord.z = diameter / totalDiameter;
    vCircleCoord.w = uCircleParams.z / totalDiameter;
  }
}
`),e?i.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);
}
`):i.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0;
}
`),i.addFragmentCode(`
vec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {
  float radius = length(vCircleCoord.xy);
  if (radius > 1.0) {
    discard;
  }

  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);

  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());
}
`)}function Vc(i,e,t){i.gl.uniform3f(i.uniform("uCircleParams"),1/e.width,1/e.height,Math.max(1e-6,t.featherWidthInPixels))}function Oc(i,e,t){ay(i,e,t)}class zU extends Y{constructor(e){super(),this.lightDirection=new Float32Array([1,0,0,0]),this.sphereHelper=this.registerDisposer(new FT(e,20,20))}defineShader(e){e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVertexCode(`
float getRadiusAdjustment(vec3 vertex, float r) {
  float radiusAdjustment = 1.0;
  for (int i = 0; i < 3; ++i) {
    if (r != 0.0) {
      float d = vertex[i] - uModelClipBounds[i];
      radiusAdjustment -= d * d / (r * r);
    }
  }

  return sqrt(max(0.1, radiusAdjustment));
}
    `),this.sphereHelper.defineShader(e)}draw(e,t,n){const r=e.gl;r.uniformMatrix4fv(e.uniform("uNormalTransform"),!1,iv(Je(),t.renderSubspaceInvModelMatrix)),r.uniform4f(e.uniform("uLightDirection"),this.lightDirection[0],this.lightDirection[1],this.lightDirection[2],this.lightDirection[3]),this.sphereHelper.draw(e,n)}}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const us=ry;function tr(i,e=!1){i.addVertexCode(sy),i.addUniform("highp vec3","uLineParams"),i.addVarying("highp float","vLineCoord"),i.addVarying("highp float","vLineFeatherFraction"),e&&(i.addVarying("highp float","vEndpointFraction"),i.addVarying("highp float","vLineCoordT"),i.addVarying("highp float","vLineBorderStartFraction")),i.addVertexCode(oB),i.addVertexCode(`
vec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }
float getLineEndpointCoefficient() { return getLineOffset().x; }
uint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }
void emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
    return;
  }
  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;
  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;

  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;
  vec2 lineDirection;
  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);

  if (linePixelLength < 1e-3) {
    lineDirection = vec2(1.0, 0.0);
    vertexADevice.z = vertexBDevice.z = 0.0;
  } else {
    lineDirection = normalize(lineDirectionUnnormalized);
  }
  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);

  vec2 lineOffset = getLineOffset();
  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);
  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${e?" + 2.0 * borderWidth":""};
  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;
  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;
  gl_Position.xy += (lineOffset.y * lineNormal
                     ${e?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})
                  * totalLineWidth * uLineParams.xy;
  vLineCoord = lineOffset.y;
  ${e?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}
  ${e?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}
}
void emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),
           lineWidthInPixels
           ${e?", borderWidth":""});
}
`),e&&i.addFragmentCode(`
vec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {
  float radius;
  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {
    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,
                         vLineCoord));
    if (radius > 1.0) {
      discard;
    }
  } else {
    radius = abs(vLineCoord);
  }
  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);
  return vec4(color.rgb, color.a * feather);
}
`),i.addFragmentCode(`
float getLineAlpha() {
  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);
}
`)}function ir(i,e,t){ay(i,e,t)}function nr(i,e,t){i.gl.uniform3f(i.uniform("uLineParams"),1/e.width,1/e.height,t)}/**
* @license
* Copyright 2020 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function Mr(i){i.addAttribute("int","aDummyVertexId",0),i.addVertexCode(`
int getVertexId () {
  return aDummyVertexId + gl_VertexID;
}
#define gl_VertexID (getVertexId())
`)}class rr extends Y{constructor(e){super(),this.buffer=new Ui(e),this.size=0}disposed(){this.buffer.dispose()}enable(e=256){const t=this.buffer,n=t.gl;t.bind(),e>this.size&&(this.size=e,n.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),n.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),n.vertexAttribDivisor(0,0),n.enableVertexAttribArray(0)}disable(){this.buffer.gl.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",()=>new rr(e))}}const $U=Je(),UT=`void main() {
  emitDefault();
}
`,Ml=[],GU=Ic(new gh,q.FLOAT32,3);let zT=class extends Y{constructor(i,e){super(),this.base=i,this.targetIsSliceView=e,this.textureAccessHelper=new Jv("vertexData"),this.vertexIdHelper=this.registerDisposer(rr.get(this.gl)),this.edgeShaderGetter=ho(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(t,n)=>{if(n.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(t),this.defineAttributeAccess(t),tr(t),t.addAttribute("highp uvec2","aVertexIndex"),t.addUniform("highp float","uLineWidth");let r=`
highp vec3 vertexA = readAttribute0(aVertexIndex.x);
highp vec3 vertexB = readAttribute0(aVertexIndex.y);
emitLine(uProjection, vertexA, vertexB, uLineWidth);
highp uint lineEndpointIndex = getLineEndpointIndex();
highp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);
`;t.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGB(vec3 color) {
  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
void emitDefault() {
  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
`),t.addFragmentCode(tc);const s=this.vertexAttributes,a=s.length;for(let l=1;l<a;++l){const d=s[l];t.addVarying(`highp ${d.glslDataType}`,`vCustom${l}`),r+=`vCustom${l} = readAttribute${l}(vertexIndex);
`,t.addFragmentCode(`#define ${d.name} vCustom${l}
`)}t.setVertexMain(r),ec(n,t),t.setFragmentMainFunction(Yl(n.parseResult.code))}}),this.nodeShaderGetter=ho(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(t,n)=>{if(n.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(t),this.defineAttributeAccess(t),Nc(t,this.targetIsSliceView),t.addUniform("highp float","uNodeDiameter");let r=`
highp uint vertexIndex = uint(gl_InstanceID);
highp vec3 vertexPosition = readAttribute0(vertexIndex);
emitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);
`;t.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGBA(vec4 color) {
  vec4 borderColor = color;
  emit(getCircleColor(color, borderColor), uPickID);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitDefault() {
  emitRGBA(uColor);
}
`),t.addFragmentCode(tc);const s=this.vertexAttributes,a=s.length;for(let l=1;l<a;++l){const d=s[l];t.addVarying(`highp ${d.glslDataType}`,`vCustom${l}`),r+=`vCustom${l} = readAttribute${l}(vertexIndex);
`,t.addFragmentCode(`#define ${d.name} vCustom${l}
`)}t.setVertexMain(r),ec(n,t),t.setFragmentMainFunction(Yl(n.parseResult.code))}})}get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(i){Mr(i),i.addUniform("highp vec4","uColor"),i.addUniform("highp mat4","uProjection"),i.addUniform("highp uint","uPickID")}get gl(){return this.base.gl}defineAttributeAccess(i){const e=this.textureAccessHelper;e.defineShader(i);const t=this.vertexAttributes.length;for(let n=Ml.length;n<t;++n)Ml[n]=Xi(`SkeletonShader.vertexAttributeTextureUnit${n}`);this.vertexAttributes.forEach((n,r)=>{i.addTextureSampler(`${jv(n.dataType)}sampler2D`,`uVertexAttributeSampler${r}`,Ml[r]),i.addVertexCode(e.getAccessor(`readAttribute${r}`,`uVertexAttributeSampler${r}`,n.dataType,n.numComponents))})}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(i,e,t,n){const r=t.projectionParameters.viewProjectionMat;let s=ei($U,r,n);i.uniformMatrix4fv(e.uniform("uProjection"),!1,s),this.vertexIdHelper.enable()}setColor(i,e,t){i.uniform4fv(e.uniform("uColor"),t)}setPickID(i,e,t){i.uniform1ui(e.uniform("uPickID"),t)}drawSkeleton(i,e,t,n,r){const s=this.vertexAttributes.length,a=n.vertexAttributeTextures;for(let l=0;l<s;++l){const d=WebGL2RenderingContext.TEXTURE0+e.textureUnit(Ml[l]);i.activeTexture(d),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,a[l])}{e.bind();const l=e.attribute("aVertexIndex");n.indexBuffer.bindToVertexAttribI(l,2,WebGL2RenderingContext.UNSIGNED_INT),i.vertexAttribDivisor(l,1),nr(e,r,this.targetIsSliceView?1:0),ir(i,1,n.numIndices/2),i.vertexAttribDivisor(l,0),i.disableVertexAttribArray(l)}t!==null&&(t.bind(),Vc(t,r,{featherWidthInPixels:this.targetIsSliceView?1:0}),Oc(t.gl,2,n.numVertices))}endLayer(i,e){const t=this.vertexAttributes.length;for(let n=0;n<t;++n){let r=e.textureUnit(Ml[n])+WebGL2RenderingContext.TEXTURE0;i.activeTexture(r),i.bindTexture(i.TEXTURE_2D,null)}this.vertexIdHelper.disable()}};var ko;(function(i){i[i.LINES=0]="LINES",i[i.LINES_AND_POINTS=1]="LINES_AND_POINTS"})(ko||(ko={}));class x1 extends fh{constructor(e,t=e){super(ko,e,t)}}class k1 extends Jt{constructor(e,t=e){super(e,vi,t)}}class WU{constructor(){this.compound=new ph,this.shader=kv(UT),this.shaderControlState=new Av(this.shader),this.params2d={mode:new x1(ko.LINES_AND_POINTS),lineWidth:new k1(2)},this.params3d={mode:new x1(ko.LINES),lineWidth:new k1(1)};const e=this.compound;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}get changed(){return this.compound.changed}reset(){this.compound.reset()}restoreState(e){e!==void 0&&this.compound.restoreState(e)}toJSON(){const e=this.compound.toJSON();for(const t of Jg(e))if(t!==void 0)return e}}class HU extends Y{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.layerChunkProgressInfo=new bv,this.redrawNeeded=new be,this.fallbackShaderParameters=new ct(Mv(dh(UT))),ty(n,this),this.displayState.shaderError.value=void 0;const r=n.skeletonRenderingOptions;this.registerDisposer(r.shader.changed.add(()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()}));let s=this.sharedObject=this.registerDisposer(new iy(e,n,this.layerChunkProgressInfo));s.RPC_TYPE_ID=_U,s.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});const a=this.vertexAttributes=[qU];for(let d of t.vertexAttributes){var l=ae(d,2);let u=l[0],h=l[1];a.push({name:u,dataType:h.dataType,numComponents:h.numComponents,webglDataType:jU(h.dataType),glslDataType:h.numComponents>1?`vec${h.numComponents}`:"float"})}}get visibility(){return this.sharedObject.visibility}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,n,r,s){let a=r.lineWidth.value;const l=this.gl,d=this.source,u=this.displayState;if(u.objectAlpha.value<=0)return;const h=hu(u.transform.value,e.projectionParameters.displayDimensionRenderInfo,s);if(h===void 0)return;let g;r.mode.value===ko.LINES_AND_POINTS?g=Math.max(5,a*2):g=a;const v=n.edgeShaderGetter(e.emitter),y=n.nodeShaderGetter(e.emitter),C=v.shader,w=v.parameters,b=y.shader,k=y.parameters;if(C===null||b===null)return;const L=this.displayState.skeletonRenderingOptions.shaderControlState;C.bind(),n.beginLayer(l,C,e,h),mo(l,C,L,w.parseResult.controls),l.uniform1f(C.uniform("uLineWidth"),a),b.bind(),n.beginLayer(l,b,e,h),l.uniform1f(b.uniform("uNodeDiameter"),g),mo(l,b,L,k.parseResult.controls);const I=d.chunks;ny(u,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,(P,T,R)=>{const M=Jn(P),V=I.get(M);V===void 0||V.state!==pt.GPU_MEMORY||(T!==void 0&&(C.bind(),n.setColor(l,C,T),b.bind(),n.setColor(l,b,T)),R!==void 0&&(C.bind(),n.setPickID(l,C,R),b.bind(),n.setPickID(l,b,R)),n.drawSkeleton(l,C,b,V,e.projectionParameters))}),n.endLayer(l,C)}isReady(){const e=this.source,t=this.displayState;if(t.objectAlpha.value<=0)return!0;const n=e.chunks;let r=!0;return Bo(t.segmentationGroupState.value,s=>{const a=Jn(s),l=n.get(a);if(l===void 0||l.state!==pt.GPU_MEMORY){r=!1;return}}),r}}class _f extends Uo{constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new zT(this.base,!1)),this.renderOptions=this.base.displayState.skeletonRenderingOptions.params3d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));const t=this.renderOptions;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){!e.emitColor&&e.alreadyEmittedPickID||this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}class E1 extends yo{constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new zT(this.base,!0)),this.renderOptions=this.base.displayState.skeletonRenderingOptions.params2d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);const t=this.renderOptions;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}function jU(i){switch(i){case q.FLOAT32:return WebGL2RenderingContext.FLOAT;default:throw new Error(`Data type not supported by WebGL: ${q[i]}`)}}const qU={dataType:q.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"};class JU extends Ls{constructor(e,t){super(e),this.vertexAttributes=t.vertexAttributes;let n=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=n.length}copyToGPU(e){super.copyToGPU(e);const t=this.source.attributeTextureFormats,n=this.vertexAttributes,r=this.vertexAttributeOffsets,s=this.vertexAttributeTextures=[];for(let a=0,l=r.length;a<l;++a){const d=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,d),qv(e,t[a],n.subarray(r[a],a+1!==l?r[a+1]:n.length)),s[a]=d}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=Ui.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);const t=this.vertexAttributeTextures;for(const n of t)e.deleteTexture(n);t.length=0,this.indexBuffer.dispose()}}const XU=new ce;function KU(i){const e=[GU];for(const t of i.values())e.push(Ic(new gh,t.dataType,t.numComponents));return e}class Sh extends Or{constructor(e,t){super(e,t)}get attributeTextureFormats(){let e=this.attributeTextureFormats_;return e===void 0&&(e=this.attributeTextureFormats_=KU(this.vertexAttributes)),e}getChunk(e){return new JU(this,e)}get vertexAttributes(){return XU}}function $T(i,e,t,n){const r=e.dataType;e.defineShader(i,t);let s="",a="";if(t===0)s+="highp int ignoredChannelIndex";else for(let d=0;d<t;++d)d!==0&&(s+=", "),s+=`highp int channelIndex${d}`,a+=`, channelIndex${d}`;i.addFragmentCode(ZO);let l=`
${si(r)} getDataValue(${s}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${n}), uChunkDataSize - 1.0)));
  return getDataValueAt(p${a});
}
${si(r)} getInterpolatedDataValue(${s}) {
  highp vec3 positionWithinChunk = ${n};
  highp ivec3[2] points;
  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);
  ${si(r)} xvalues[2];
  for (int ix = 0; ix < 2; ++ix) {
    ${si(r)} yvalues[2];
    for (int iy = 0; iy < 2; ++iy) {
      ${si(r)} zvalues[2];
      for (int iz = 0; iz < 2; ++iz) {
        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)
                                     ${a});
      }
      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);
    }
    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);
  }
  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);
}
`;i.addFragmentCode(l),t<=1&&i.addFragmentCode(`
${si(r)} getDataValue() { return getDataValue(0); }
${si(r)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }
`)}var GT=new Array;function WT(i){GT.push(i)}function YU(i,e){for(let t of GT){let n=t(i,e);if(n!=null)return n}throw new Error("No chunk format handler found.")}class Bc extends $2{constructor(e,t){super(e,t),this.chunkFormatHandler=this.registerDisposer(YU(e.chunkQueueManager.gl,this.spec));const n=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(n),this.tempPositionWithinChunk=new Uint32Array(n)}static encodeSpec(e){const t=e;return H(H({},super.encodeSpec(e)),{dataType:t.dataType,compressedSegmentationBlockSize:t.compressedSegmentationBlockSize&&Ee(t.compressedSegmentationBlockSize),baseVoxelOffset:Ee(t.baseVoxelOffset)})}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){const n=this.spec.rank,r=this.tempChunkGridPosition,s=this.tempPositionWithinChunk,a=this.spec;{const w=a.chunkDataSize;for(let b=0;b<n;++b){const k=e[b],L=w[b],I=Math.floor(k/L);r[b]=I,s[b]=Math.floor(k-L*I)}}const l=this.chunks.get(r.join());if(l===void 0)return null;const d=l.chunkDataSize;for(let w=0;w<3;++w)if(s[w]>=d[w])return;if(t.channelSpaceShape.length===0)return l.getValueAt(s);const u=t.numChannels,h=t.chunkChannelCoordinates,g=t.chunkChannelDimensionIndices,v=g.length;let y=0;const C=new Array(u);for(let w=0;w<u;++w){for(let b=0;b<v;++b)s[g[b]]=h[y++];C[w]=l.getValueAt(s)}return C}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}}class ZU extends G2{constructor(e,t){super(e,t),this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}get chunkFormat(){return this.source.chunkFormat}}let Ds=class extends C_{};const wu="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='plusIconTitle'%3e%3ctitle%20id='plusIconTitle'%3ePlus%3c/title%3e%3cpath%20d='M20%2012L4%2012M12%204L12%2020'/%3e%3c/svg%3e";function HT(i={}){return ft(H({svg:wu},i))}const QU="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='arrowUpIconTitle'%3e%3ctitle%20id='arrowUpIconTitle'%3eArrow%20Up%3c/title%3e%3cpath%20d='M18%209l-6-6-6%206'/%3e%3cpath%20d='M12%2021V4'/%3e%3cpath%20stroke-linecap='round'%20d='M12%203v1'/%3e%3c/svg%3e",Cu=new ct(0);window.addEventListener("keydown",i=>{Cu.value=Kv(i)});window.addEventListener("keyup",i=>{Cu.value=Kv(i)});const ez=new $e(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),tz=new $e(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]);class Nn extends Y{constructor(e,t){super(),this.target=e,this.eventMap=t,this.modifierShortcutsAreGlobal=!0,this.allShortcutsAreGlobal=!1,this.allowSpaceKeyOnButtons=!1,this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){var n=t.target;let r=n.tagName;if(n===this.target)return!1;var s=r==="TEXTAREA"||r==="INPUT"||r==="BUTTON"||r==="SELECT",a=!s&&(n.isContentEditable||n.ownerDocument&&n.ownerDocument.designMode==="on");return!s&&!a||this.allShortcutsAreGlobal||ez.has(e)?!1:a||this.modifierShortcutsAreGlobal&&(t.altKey||t.ctrlKey||t.metaKey)?!0:r==="INPUT"&&tz.has(n.type)?e!=="enter":r==="INPUT"||r==="BUTTON"?this.allowSpaceKeyOnButtons?!1:e==="space":!0}handleKeyDown(e){const t=iz(e);this.shouldIgnoreEvent(t,e)||ET(t,e,e,this.eventMap)}}function iz(i){return i.code.toLowerCase()}function Al(i,e=i.value){i.style.minWidth=e.length+1+"ch"}const L1="neuroglancer-coordinate-space-transform-singleton";function T1(i,e){let t;i===Number.NEGATIVE_INFINITY?t="(-∞,":t=`[${Math.floor(i)},`;let n;return e===Number.POSITIVE_INFINITY?n="+∞)":n=`${Math.floor(e)})`,{lower:t,upper:n}}const D1=at.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function P1(){const i=document.createElement("div"),e=document.createElement("input");i.classList.add("neuroglancer-coordinate-space-transform-scale-container"),e.spellcheck=!1,e.autocomplete="off",e.size=1,e.classList.add("neuroglancer-coordinate-space-transform-scale"),i.appendChild(e);const t=document.createElement("div"),n=document.createElement("span");n.innerHTML=QU,t.appendChild(n);const r=document.createTextNode("");return t.appendChild(r),t.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),i.appendChild(t),{cellElement:i,inputElement:e,suggestionElement:t}}function I1(i,e,t,n,r){if(e===void 0||e.scale===t&&e.unit===n)i.style.display="none";else{i.style.display="";const s=Qs(e.scale,e.unit,{elide1:!1});i.lastChild.textContent=s,i.title=`${r}${s}`}}function R1(){const i=document.createElement("input");return i.spellcheck=!1,i.autocomplete="off",i.size=1,i.placeholder=" ",i.classList.add("neuroglancer-coordinate-space-transform-output-name"),i}function M1(i,e,t){const n=i.map(v=>Jl(v.value));if(n.includes(void 0))return!1;const r=Float64Array.from(n,v=>v.scale),s=Ee(n,v=>v.unit),a=t.value,l=a.scales,d=a.units,u=a.rank;for(let v=0;v<u;++v)e[v]||(r[v]=l[v],s[v]=d[v]);if(Oe(l,r)&&Oe(d,s))return!1;const h=a.timestamps.map((v,y)=>r[y]===l[y]&&s[y]===d[y]?v:Date.now()),g=st({valid:a.valid,rank:a.rank,scales:r,units:s,timestamps:h,ids:a.ids,names:a.names,boundingBoxes:a.boundingBoxes,coordinateArrays:a.coordinateArrays});return t.value=g,!0}function A1(i,e,t,n){const r=new Float64Array(i.scales),s=Ee(i.units);if(r[e]===t&&s[e]===n)return i;const a=Ee(i.timestamps);return r[e]=t,s[e]=n,a[e]=Date.now(),H(H({},i),{scales:r,units:s,timestamps:a})}class nz extends Y{constructor(e,t,n){super(),this.transform=e,this.localCombiner=t,this.globalCombiner=n,this.element=document.createElement("div"),this.coefficientContainer=document.createElement("div"),this.translationContainer=document.createElement("div"),this.outputNameContainer=document.createElement("div"),this.outputScaleContainer=document.createElement("div"),this.inputNameContainer=document.createElement("div"),this.inputScaleContainer=document.createElement("div"),this.inputLowerBoundsContainer=document.createElement("div"),this.inputUpperBoundsContainer=document.createElement("div"),this.coefficientElements=[],this.inputNameElements=[],this.outputNameElements=[],this.outputScaleElements=[],this.outputScaleSuggestionElements=[],this.inputScaleSuggestionElements=[],this.inputScaleElements=[],this.inputBoundsElements=[],this.outputBoundsElements=[],this.addSourceDimensionIcon=ft({svg:wu,text:"S"}),this.addOutputDimensionIcon=ft({svg:wu,text:"V"}),this.addOutputDimensionCell=document.createElement("div"),this.addOutputDimensionInput=R1(),this.inputScaleModified=[],this.outputScaleModified=[],this.curSourceRank=-1,this.curRank=-1,this.curTransform=void 0,this.addingSourceDimension=!1,this.resetToIdentityButton=ft({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{const F=this.transform,j=F.value.rank;F.transform=xs(Float64Array,j+1)}}),this.resetToDefaultButton=ft({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{const F=this.transform;if(F.mutableSourceRank)return;const j=F.defaultTransform;let U=j.outputSpace;const O=U.ids.map(()=>Xa());F.value=H(H({},j),{outputSpace:H(H({},U),{ids:O})})}});const r=this.element,s=this.registerDisposer(new Nn(r,D1));s.allShortcutsAreGlobal=!0,r.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new Br(r,D1));const a=dt(()=>this.updateView());this.registerDisposer(e.changed.add(a));const l=this.coefficientContainer,d=this.translationContainer,u=this.outputNameContainer,h=this.inputNameContainer,g=this.inputScaleContainer,v=this.inputLowerBoundsContainer,y=this.inputUpperBoundsContainer,C=this.outputScaleContainer,w=this.addOutputDimensionCell,b=this.addOutputDimensionIcon,k=this.addSourceDimensionIcon,L=this.resetToIdentityButton,I=this.resetToDefaultButton;l.style.display="contents",d.style.display="contents",u.style.display="contents",h.style.display="contents",g.style.display="contents",C.style.display="contents",v.style.display="contents",y.style.display="contents";const P=document.createElement("div");P.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),L.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),I.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),P.appendChild(L),P.appendChild(I),r.appendChild(P);for(const F of[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]]){var T=ae(F,2);const j=T[0],U=T[1],O=document.createElement("div");O.classList.add(`neuroglancer-coordinate-space-transform-${j}-label`),O.classList.add("neuroglancer-coordinate-space-transform-label"),O.textContent=U,r.appendChild(O)}e.mutableSourceRank&&w.appendChild(k),w.appendChild(b),w.classList.add("neuroglancer-coordinate-space-transform-output-extend");const R="Embed in additional output dimension",M="Extend to additional source dimension";b.title=R,k.title=M,w.appendChild(this.addOutputDimensionInput),w.dataset.isActive="false",b.addEventListener("click",()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=R,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),k.addEventListener("click",()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=M,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),this.addOutputDimensionInput.addEventListener("blur",()=>{this.updateAddOutputDimensionCellStyle()}),r.appendChild(l),r.appendChild(u),r.appendChild(h),r.appendChild(g),r.appendChild(C),r.appendChild(v),r.appendChild(y),l.appendChild(d),r.addEventListener("input",F=>{const j=F.target;if(j instanceof HTMLInputElement){Al(j);let U=this.inputScaleElements.indexOf(j);if(U!==-1){this.inputScaleModified[U]=!0,this.updateScaleValidity(j);return}if(U=this.outputScaleElements.indexOf(j),U!==-1){this.outputScaleModified[U]=!0,this.updateScaleValidity(j);return}if(U=this.outputNameElements.indexOf(j),U!==-1){this.updateOutputNameValidity();return}if(this.coefficientContainer.contains(j)){this.updateCoefficientValidity(j);return}}});const V=(F,j,U)=>{ve(r,F,O=>{O.stopPropagation();const $=O.target;if(!($ instanceof HTMLInputElement)||U!==0&&($.selectionStart!==$.selectionEnd||$.selectionStart!==(U===1?$.value.length:0)))return;const _=this.getElementGridPosition($);if(_===void 0)return;const se=this.getElementByGridPosition(_.row+j,_.col+U);se!==null&&(se.focus(),O.preventDefault())})};V("move-up",-1,0),V("move-down",1,0),V("move-left",0,-1),V("move-right",0,1);const B=(F,j)=>{F.addEventListener("focusout",U=>{const O=U.relatedTarget;O instanceof Node&&F.contains(O)||j(U)})};B(l,()=>{this.updateModelTransform()||this.updateViewTransformCoefficients()}),B(u,()=>{this.updateModelOutputNames()||this.updateViewOutputNames()}),B(g,()=>{this.updateModelInputScales()||this.updateViewInputScales()}),B(C,()=>{this.updateModelOutputScales()||this.updateViewOutputScales()}),ve(r,"cancel",F=>{this.curTransform=void 0,this.updateView(),F.target.blur()}),ve(l,"commit",()=>{this.updateModelTransform()}),ve(u,"commit",()=>{this.updateModelOutputNames()}),ve(g,"commit",()=>{this.updateModelInputScales()}),ve(C,"commit",()=>{this.updateModelOutputScales()}),r.addEventListener("focusin",F=>{const j=F.target;j instanceof HTMLInputElement&&j.select()}),this.updateView()}updateWillBeDeletedAttributes(e){const t=this.transform.value.rank;e===void 0&&(e=new Array(t),e.fill(!1));const n=this.coefficientElements,r=this.inputBoundsElements,s=this.inputScaleElements;for(let l=0;l<t;++l){const d=e[l];for(let g=0;g<=t;++g){const v=n[t*g+l],y=g<t&&e[g];v.dataset.willBeDeleted=(d||y).toString()}s[l].dataset.willBeDeleted=d.toString();var a=r[l];const u=a.lower,h=a.upper;u.dataset.willBeDeleted=d.toString(),h.dataset.willBeDeleted=d.toString()}}updateAddOutputDimensionCellStyle(){const e=this.addOutputDimensionInput;this.addOutputDimensionCell.dataset.isActive=(e.value.length!==0||document.activeElement===e).toString()}updateOutputNameValidity(){const e=this.outputNameElements,t=e.map(h=>h.value);var n=this.transform,r=n.value;const s=r.sourceRank,a=r.rank,l=n.mutableSourceRank;if(e.length!==a+1)return;const d=vv(t);let u=new Array(a);u.fill(!1);for(let h=0;h<=a;++h){let g=d[h];t[h].length===0&&(l||h>=s)&&(g=!0,u[h]=!0),e[h].dataset.isValid=g.toString()}this.updateWillBeDeletedAttributes(u),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){const t=Jl(e.value)!==void 0;e.dataset.isValid=t.toString()}updateCoefficientValidity(e){const t=gt(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{const t=this.outputNameElements.indexOf(e);if(t!==-1)return{row:t,col:-2}}{const t=this.inputScaleElements.indexOf(e);if(t!==-1)return{row:-1,col:t}}{const t=this.coefficientElements.indexOf(e),n=this.transform.value.rank;if(t!==-1)return{row:t%n,col:Math.floor(t/n)}}{const t=this.outputScaleElements.indexOf(e);if(t!==-1)return{row:t,col:-1}}}getElementByGridPosition(e,t){const n=this.transform.value.rank;return e===-1?t<0||t>=n?null:this.inputScaleElements[t]:t===-2?e<0||e>n?null:this.outputNameElements[e]:t===-1?e<0||e>=n?null:this.outputScaleElements[e]:e<0||e>=n||t<0||t>n?null:this.coefficientElements[t*n+e]}dimensionRefCount(e){return(Ul(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return M1(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return M1(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){const e=this.outputNameElements.map(I=>I.value);var t=this.transform;const n=t.value,r=t.mutableSourceRank,s=n.outputSpace,a=n.rank,l=n.sourceRank;if(e.length!==a+1)return;const d=[],u=[],h=e[a].length!==0;let g=l;for(let I=0;I<=a;++I){const P=e[I];if(P.length===0){if(I<l){if(!r)return!1;--g}continue}u.push(P),d.push(I)}if(!rh(u))return!1;const v=s.names;if(!h&&Oe(v,u))return!0;let y=n.inputSpace,C=n.outputSpace,w=n.transform;if(h){this.addingSourceDimension&&++g;const I=e[a],P=(Ul(I)?this.localCombiner:this.globalCombiner).combined.value,T=P.names.indexOf(I);let R,M;T!==-1?(R=P.units[T],M=P.scales[T]):(R="",M=1);const V=y.boundingBoxes.map(B=>AL(B,a,a+1));this.addingSourceDimension||V.push(ML(a+1,a)),y=st({valid:y.valid,rank:a+1,names:[...y.names,""],ids:[...y.ids,Xa()],timestamps:[...y.timestamps,Date.now()],scales:Float64Array.from([...y.scales,M]),units:[...y.units,R],boundingBoxes:V,coordinateArrays:[...y.coordinateArrays,void 0]}),C=st({valid:s.valid,rank:a+1,names:[...s.names,I],ids:[...s.ids,Xa()],timestamps:[...s.timestamps,Date.now()],scales:Float64Array.from([...s.scales,M]),units:[...s.units,R],coordinateArrays:[...s.coordinateArrays,void 0]}),w=uv(new Float64Array((a+2)**2),a+1,w,a)}w=BL(Float64Array,w,y.rank,d,d),y=Dg(y,d),C=Dg(C,d);const b=C.ids.map((I,P)=>{const T=d[P];if(T===a)return I;const R=u[P],M=v[T];return R===M||this.dimensionRefCount(M)===1&&this.dimensionRefCount(R)===(v.includes(R)?1:0)?I:Xa()}),k=C.timestamps.map((I,P)=>{const T=d[P];return T===a||u[P]===v[T]?I:Date.now()});C=H(H({},C),{names:u,ids:b,timestamps:k});let L={rank:C.rank,sourceRank:g,outputSpace:C,inputSpace:y,transform:w};return this.transform.value=L,!0}updateModelTransform(){const e=this.coefficientElements,t=this.transform.value.rank,n=new Float64Array((t+1)**2);n[n.length-1]=1;for(let r=0;r<t;++r)for(let s=0;s<=t;++s){const a=e[s*t+r],l=parseFloat(a.value);if(!gt(l))return!1;n[s*(t+1)+r]=l}return this.transform.transform=n,!0}updateViewOutputNames(){var e=this.transform.value;const t=e.outputSpace,n=e.rank;if(n!==this.curRank)return;const r=this.outputNameElements,s=t.names;for(let a=0;a<n;++a){const l=r[a];l.value=s[a],l.dataset.isValid="true",Al(l)}r[n].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){var e=this.transform.value;const t=e.transform,n=e.rank,r=this.coefficientElements;for(let s=0;s<n;++s)for(let a=0;a<=n;++a){const l=r[a*n+s];l.value=t[a*(n+1)+s].toString(),l.dataset.isValid="true",Al(l)}}ensureViewRankUpdated(){const e=this.transform.value,t=e.rank,n=e.sourceRank;if(this.curSourceRank===n&&this.curRank===t)return;const r=this.inputBoundsElements,s=this.inputNameElements,a=this.inputScaleElements,l=this.element,d=this.coefficientElements,u=this.outputNameElements,h=this.outputScaleElements,g=this.outputScaleSuggestionElements,v=this.inputScaleSuggestionElements,y=this.outputBoundsElements,C=this.coefficientContainer,w=this.translationContainer,b=this.outputNameContainer,k=this.inputNameContainer,L=this.inputScaleContainer,I=this.inputLowerBoundsContainer,P=this.inputUpperBoundsContainer,T=this.outputScaleContainer;l.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,l.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,Ke(C),Ke(w),C.appendChild(w),Ke(b),Ke(k),Ke(L),Ke(I),Ke(P),Ke(T),s.length=0,a.length=0,r.length=0,h.length=0,g.length=0,v.length=0,d.length=0,u.length=0,y.length=0;for(let V=0;V<t;++V){const B=F=>{F.classList.add("neuroglancer-coordinate-space-transform-input"),V>=n&&F.classList.add(L1)};{const F=document.createElement("div");F.classList.add("neuroglancer-coordinate-space-transform-input-name"),B(F),F.style.gridRowStart="sourceNames",F.style.gridColumnStart=`sourceDim ${V+1}`,k.appendChild(F),s.push(F)}{var R=P1();const F=R.cellElement,j=R.inputElement,U=R.suggestionElement;F.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),B(F),F.style.gridRowStart="sourceScales",F.style.gridColumnStart=`sourceDim ${V+1}`,L.appendChild(F),a.push(j),v.push(U);const O=V;U.addEventListener("click",()=>{const $=cC(this.transform,O);$!==void 0&&(this.transform.inputSpace.value=A1(this.transform.inputSpace.value,O,$.scale,$.unit))})}{const F=document.createElement("div");B(F),F.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),F.style.gridRowStart="sourceLower",F.style.gridColumnStart=`sourceDim ${V+1}`,I.appendChild(F);const j=document.createElement("div");B(j),j.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),j.style.gridRowStart="sourceUpper",j.style.gridColumnStart=`sourceDim ${V+1}`,P.appendChild(j),r.push({lower:F,upper:j})}}for(let V=0;V<t;++V){for(let B=0;B<=t;++B){const F=document.createElement("input");F.classList.add("neuroglancer-coordinate-space-transform-coeff"),F.spellcheck=!1,F.autocomplete="off",F.size=1,F.style.gridRowStart=`outputDim ${V+1}`,F.placeholder=" ",F.style.gridColumnStart=`sourceDim ${B+1}`,d[B*t+V]=F,B===t?F.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):B==n&&F.classList.add(L1),(B===t?w:C).appendChild(F)}{var M=P1();const B=M.cellElement,F=M.suggestionElement,j=M.inputElement;B.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),B.style.gridRowStart=`outputDim ${V+1}`,B.style.gridColumnStart="outputScales";const U=V;F.addEventListener("click",()=>{const O=this.transform.value,$=lC(O,U);$!==void 0&&(this.transform.outputSpace.value=A1(O.outputSpace,U,$.scale,$.unit))}),g.push(F),T.appendChild(B),h.push(j)}{const B=document.createElement("div");B.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),B.style.gridRowStart=`outputDim ${V+1}`,B.style.gridColumnStart="outputNames";const F=R1();F.title="Rebind to a different dimension",V>=n?F.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(F.title+=", or delete to remove source dimension"),F.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",u.push(F),b.appendChild(B),B.appendChild(F);const j=document.createElement("div");j.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),B.appendChild(j);const U=document.createElement("div");U.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),B.appendChild(U),y.push({lower:j,upper:U}),B.addEventListener("mousedown",O=>{O.target!==F&&(F.focus(),O.preventDefault())})}}u.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",b.appendChild(this.addOutputDimensionCell),this.curSourceRank=n,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;var e=this.transform.value;const t=e.inputSpace,n=e.rank,r=e.sourceRank,s=this.inputBoundsElements,a=this.inputNameElements,l=this.inputScaleElements,d=this.inputScaleSuggestionElements,u=t.names,h=t.scales,g=t.units;var v=t.bounds;const y=v.lowerBounds,C=v.upperBounds;for(let b=0;b<n;++b){const k=l[b],L=h[b],I=g[b];k.value=Qs(L,I,{elide1:!1}),k.dataset.isValid="true",Al(k);let P;if(b<r){let V=u[b];V||(V=`${b}`),a[b].textContent=V,P=`source dimension ${V}`,k.title=`Override scale of ${P}`}else P="singleton dimension",k.title=`Set extent of ${P}`;var w=T1(y[b],C[b]);const T=w.lower,R=w.upper,M=s[b];M.lower.textContent=T,M.lower.title=`Lower bound of ${P}`,M.upper.title=`Upper bound of ${P}`,M.upper.textContent=R,I1(d[b],cC(this.transform,b),L,I,`Revert scale of ${P} to `)}}updateViewOutputScales(){const e=this.transform.value;var t=e.outputSpace;const n=t.rank,r=t.names,s=t.units,a=t.scales;var l=t.bounds;const d=l.lowerBounds,u=l.upperBounds,h=this.outputScaleElements,g=this.outputBoundsElements,v=this.outputScaleSuggestionElements;for(let C=0;C<n;++C){const w=h[C],b=a[C],k=s[C];w.value=Qs(b,k,{elide1:!1}),Al(w);const L=r[C];w.dataset.isValid="true";const I=`Change coordinates of ${Ul(L)?"local":"global"} dimension ${L}`;w.title=`${I} (does not rescale the source)`;var y=T1(d[C],u[C]);const P=y.lower,T=y.upper,R=g[C];R.lower.textContent=P,R.upper.textContent=T,I1(v[C],lC(e,C),b,k,`${I} to inferred scale of `)}}updateResetButtonVisibility(e=!1,t=!1){var n=this.transform;const r=n.value,s=n.mutableSourceRank,a=n.defaultTransform,l=r.rank;this.resetToIdentityButton.style.visibility=e||!o3(r.transform,l+1,l+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=!s&&(e||t||!D3(a,r))?"visible":"hidden"}updateView(){const e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){kt(this.element),super.disposed()}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function rz(i,e,{horizontal:t=!1,vertical:n=!0,topMargin:r=6,bottomMargin:s=6,leftMargin:a=6,rightMargin:l=6,maxHeight:d=!0,maxWidth:u=!0}={}){const h=e.getBoundingClientRect();if(t){const g=i.ownerDocument.documentElement.clientWidth;let v=h.right,y=g-h.left;v>y?(i.style.left="",i.style.right=`${g-h.right}px`,u&&(i.style.maxWidth=v-a+"px")):(i.style.right="",i.style.left=`${h.left}px`,u&&(i.style.maxWidth=y-l+"px"))}if(n){const g=i.ownerDocument.documentElement.clientHeight;let v=h.top-r,y=g-h.bottom-s;i.style.left=`${h.left}px`,i.style.width=`${h.width}px`,v>y*3?(i.style.top="",i.style.bottom=`${g-h.top}px`,d&&(i.style.maxHeight=v+"px")):(i.style.top=`${h.bottom}px`,i.style.bottom="",d&&(i.style.maxHeight=y+"px"))}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function sz(i){let e=ev(i);var t=e.next();let n=t.value;if(t.done)return"";let r=n.length;for(;r>0;){var s=e.next();let a=s.value;if(s.done)break;let l=0;for(;l<r&&n.charCodeAt(l)===a.charCodeAt(l);++l);r=l}return n.substring(0,r)}/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const N1=10,Nd=.5;class az{constructor(){this.anchorIndex=0,this.anchorClientOffset=0}splice(e){let t=this.anchorIndex,n=0;for(const r of e){if(n+=r.retainCount,t<n)break;const s=r.deleteCount;if(t<n+s){t=n;break}const a=r.insertCount;t=t-s+a,n+=a-a}this.anchorIndex=t}}class V1{constructor(){this.startIndex=0,this.endIndex=0,this.anchorIndex=0,this.anchorOffset=0,this.scrollOffset=0}}class oz{constructor(){this.itemSize=[],this.totalKnownSize=0,this.numItemsInTotalKnownSize=0}get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){var t;return(t=this.itemSize[e])!==null&&t!==void 0?t:this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e,t=0,n=0){for(;t<e;++t)n+=this.getEstimatedSize(t);for(;t>e;--t)n-=this.getEstimatedSize(t-1);return n}getRangeSize(e,t){var n;let r=0;const s=this.itemSize,a=this.averageSize;for(let l=e;l<t;++l)r+=(n=s[l])!==null&&n!==void 0?n:a;return r}splice(e){let t=this.itemSize;t=this.itemSize=fN(t,e),this.totalKnownSize=t.reduce((n,r)=>n+r,0),this.numItemsInTotalKnownSize=t.reduce(n=>n+1,0)}}function lz(i,e,t,n,r,s){let a=s.anchorIndex,l=s.anchorClientOffset,d=r.getEstimatedOffset(a),u,h,g,v,y;if(n===0||r.totalKnownSize===0)u=Math.max(0,a-N1/2),h=Math.min(t,u+N1),y=a,g=0,v=l;else{const C=r.getEstimatedTotalSize(),w=Math.max(0,C-n);v=d-l,v=Math.max(0,Math.min(w,v));const b=v-2*Nd*n,k=v-Nd*n,L=v+n+Nd*n,I=d-l+n+2*Nd*n;u=Math.min(t,e.startIndex);let P=r.getEstimatedOffset(u,a,d);if(P<b)for(;u+1<t;++u){const R=r.getEstimatedSize(u);if(P+R>=k)break;P+=R}if(P>=k)for(;P>b&&u>0;--u){const R=r.getEstimatedSize(u-1);P-=R}h=Math.min(t,e.endIndex);let T=r.getEstimatedOffset(h,a,d);if(T<L)for(;T<=I&&h+1<=t;++h){const R=r.getEstimatedSize(h);T+=R}else if(T>=I)for(;h>u;--h){const R=r.getEstimatedSize(h-1);if(T-R<L)break;T-=R}for(y=a,g=d;y<u;++y){const R=r.getEstimatedSize(y);g+=R}for(;y>h;--y){const R=r.getEstimatedSize(y-1);g-=R}}i.startIndex=u,i.endIndex=h,i.anchorIndex=y,i.anchorOffset=g,i.scrollOffset=v}function cz(i,e){const t=e.getEstimatedOffset(i.anchorIndex),n=i.anchorOffset;i.anchorOffset=t,i.scrollOffset+=t-n}function dz(i,e){return i.startIndex<e.startIndex||i.endIndex>e.endIndex}class ly extends Y{constructor(e){super(),this.element=document.createElement("div"),this.scrollContent=document.createElement("div"),this.header=document.createElement("div"),this.body=document.createElement("div"),this.topItems=document.createElement("div"),this.bottomItems=document.createElement("div"),this.renderedItems=[],this.renderGeneration=-1,this.listGeneration=-1,this.newRenderedItems=[],this.state=new az,this.renderParams=new V1,this.newRenderParams=new V1,this.sizes=new oz,this.debouncedUpdateView=this.registerCancellable(dt(()=>this.updateView())),this.resizeObserver=new ResizeObserver(()=>this.updateView());const t=e.selectedIndex;t!==void 0&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);const n=this.source=e.source;this.sizes.itemSize.length=n.length;const r=this.element,s=this.header,a=this.body,l=this.scrollContent,d=this.topItems,u=this.bottomItems;this.resizeObserver.observe(r),this.registerDisposer(()=>this.resizeObserver.disconnect()),r.appendChild(l),r.style.overflowAnchor="none",l.appendChild(s),l.appendChild(a),s.style.position="sticky",s.style.zIndex="1",s.style.top="0",e.horizontalScroll?(l.style.width="min-content",l.style.minWidth="100%",s.style.width="min-content",s.style.minWidth="100%",u.style.width="min-content",u.style.minWidth="100%"):(l.style.width="100%",s.style.width="100%",u.style.width="100%"),a.appendChild(d),a.appendChild(u),d.style.width="min-content",d.style.position="relative",d.style.height="0",d.style.minWidth="100%",u.style.height="0",u.style.position="relative",r.addEventListener("scroll",()=>{const h=r.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-h,this.renderParams.scrollOffset=h,this.debouncedUpdateView()}),n.changed!==void 0&&this.registerDisposer(n.changed.add(h=>{this.sizes.splice(h),this.state.splice(h),this.renderedItems.length=0,this.debouncedUpdateView()})),n.renderChanged!==void 0&&this.registerDisposer(n.renderChanged.add(this.debouncedUpdateView))}updateView(){const e=this.element;if(e.offsetHeight===0)return;const t=e.clientHeight-this.header.offsetHeight,n=this.source,r=this.state,s=this.sizes,a=n.length,l=this.body,d=this.topItems,u=this.bottomItems,h=n.changed,g=n.renderChanged;let v;for(;;){v=this.newRenderParams;const b=this.renderParams;lz(v,b,a,t,s,r);let k;if(g!==void 0&&g.count!==this.renderGeneration||h!==void 0&&h.count!==this.listGeneration?(this.renderGeneration=g===void 0?-1:g.count,this.listGeneration=h===void 0?-1:h.count,k=!0,this.renderedItems.length=0):k=!1,!k&&!dz(v,b)){b.scrollOffset=v.scrollOffset,v=b;break}this.renderParams=v,this.newRenderParams=b;const L=this.renderedItems,I=this.newRenderedItems;I.length=0,this.renderedItems=I,this.newRenderedItems=L;const P=this.source,T=P.render;var y=v;const R=y.startIndex,M=y.endIndex,V=y.anchorIndex;function*B(F,j){for(let U=F;U<j;++U){let O=L[U];O===void 0&&(O=T.call(P,U)),I[U]=O,yield O}}Xn(d,B(R,V)),Xn(u,B(V,M));for(let F=R;F<M;++F){const j=I[F].getBoundingClientRect().height,U=s.itemSize[F];U!==void 0&&(s.totalKnownSize-=U,--s.numItemsInTotalKnownSize),s.itemSize[F]=j,s.totalKnownSize+=j,++s.numItemsInTotalKnownSize}}cz(v,s),r.anchorIndex=v.anchorIndex,r.anchorClientOffset=v.anchorOffset-v.scrollOffset;const C=s.getRangeSize(v.startIndex,v.anchorIndex),w=s.getEstimatedTotalSize();l.style.height=`${w}px`,d.style.top=`${v.anchorOffset-C}px`,u.style.top=`${v.anchorOffset}px`,e.scrollTop=v.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){var t=this.renderParams;const n=t.startIndex,r=t.endIndex,s=this.renderedItems;for(let a=n;a<r;++a){const l=s[a];l!==void 0&&e(l,a)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){const t=this.sizes.getEstimatedOffset(e),n=t+this.sizes.getEstimatedSize(e),r=this.element.scrollTop;if(t<r)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else if(t>r&&n>r+this.element.offsetHeight)this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight;else return;this.debouncedUpdateView()}disposed(){kt(this.element)}}const Ff="neuroglancer-multiline-autocomplete-completion-active";function uz(i){let e=document.createElement("div");return e.textContent=i.value,e}function*O1(i){for(;i.length>0;){const e=i.match(/[:/_]+/);if(e===null){yield i;return}const t=e.index+e[0].length;yield i.substring(0,t),i=i.substring(t)}}function hz(i){let e=document.createElement("div");e.className="neuroglancer-multiline-autocomplete-completion-with-description",e.textContent=i.value;let t=document.createElement("div");return t.className="neuroglancer-multiline-autocomplete-completion-description",t.textContent=i.description||"",e.appendChild(t),e}const pz=at.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}}),fz=200;class gz extends Y{constructor(e){super(),this.element=document.createElement("div"),this.inputElement=document.createElement("span"),this.hintElement=document.createElement("span"),this.completionsVirtualList=void 0,this.onCommit=new Ze,this.onInput=new Ze,this.prevInputValue="",this.completionsVisible=!1,this.activeCompletionPromise=null,this.activeCompletionCancellationToken=void 0,this.hasFocus=!1,this.completionResult=null,this.dropdownContentsStale=!0,this.hasResultForDropdown=!1,this.commonPrefix="",this.completionDisabled=-1,this.activeIndex=-1,this.dropdownStyleStale=!0,this.resizeHandler=()=>{this.completionsVisible&&this.updateDropdownStyle()},this.resizeObserver=new ResizeObserver(this.resizeHandler),this.debouncedUpdateHintState=this.registerCancellable(nt(()=>this.updateHintState(),0)),this.completer=e.completer;var t=e.delay;const n=t===void 0?fz:t;let r=this.scheduleUpdateCompletions=nt(()=>{const u=this.activeCompletionCancellationToken=new ks;let h=this.activeCompletionPromise=this.completer(this.value,u);h!==null&&h.then(g=>{this.activeCompletionPromise===h&&(this.setCompletions(g),this.activeCompletionPromise=null)})},n);this.registerDisposer(()=>{r.cancel()});const s=this.element,a=this.inputElement,l=this.hintElement;s.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(s),this.registerDisposer(()=>this.resizeObserver.unobserve(a)),a.contentEditable="true",a.spellcheck=!1,s.appendChild(document.createTextNode("​")),s.appendChild(a),s.appendChild(l),a.classList.add("neuroglancer-multiline-autocomplete-input"),l.classList.add("neuroglancer-multiline-autocomplete-hint"),a.addEventListener("input",()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()}),a.addEventListener("copy",u=>{const h=u.clipboardData;if(h!==null){const g=window.getSelection();g!==null&&!g.isCollapsed&&g.containsNode(a,!0)&&h.setData("text/plain",g.toString())}u.preventDefault(),u.stopPropagation()}),this.registerEventListener(document,"selectionchange",()=>{const u=this.getSelectionRange(),h=this.completionDisabled;u!==void 0&&u.begin===h&&u.end===h||(this.completionDisabled=-1,this.debouncedUpdateHintState())}),this.setValueAndSelection(""),this.updateHintState(),s.addEventListener("pointerdown",u=>{const h=u.target;if(h instanceof Node){if(a.contains(h))return;const g=this.completionsVirtualList;if(g!==void 0&&g.element.contains(h))return}a===document.activeElement&&(this.moveCaretToEndOfInput(),u.stopPropagation(),u.preventDefault())}),s.addEventListener("click",()=>{a.focus()}),this.registerEventListener(this.inputElement,"focus",()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();const u=document.createRange(),h=a.childNodes;u.setStart(a,0),h.length===0?u.setEnd(a,0):u.setEndAfter(h[h.length-1]);const g=window.getSelection();g!==null&&(g.removeAllRanges(),g.addRange(u)),this.debouncedUpdateHintState()}}),this.registerEventListener(this.inputElement,"blur",()=>{this.hasFocus&&(this.hasFocus=!1,this.updateDropdown()),this.debouncedUpdateHintState();const u=window.getSelection();u!==null&&u.containsNode(this.inputElement,!0)&&u.removeAllRanges(),this.onCommit.dispatch(this.value,!1)}),this.registerEventListener(window,"resize",()=>{this.dropdownStyleStale=!0}),this.registerEventListener(window,"scroll",()=>{this.dropdownStyleStale=!0});const d=this.registerDisposer(new Nn(a,pz));d.allShortcutsAreGlobal=!0,ve(a,"cycle-next-active-completion",()=>{this.cycleActiveCompletion(1)}),ve(a,"cycle-prev-active-completion",()=>{this.cycleActiveCompletion(-1)}),ve(a,"home",()=>{this.moveCaretToBeginningOfInput()}),ve(a,"end",()=>{this.moveCaretToEndOfInput()}),ve(a,"choose-active-completion-or-prefix",u=>{this.selectActiveCompletion(!0)&&u.preventDefault()}),ve(a,"commit",u=>{if(this.selectActiveCompletion(!1))u.stopPropagation();else{let h=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,h)}}),ve(a,"cancel",u=>{u.stopPropagation(),this.cancel()&&(u.detail.preventDefault(),u.detail.stopPropagation())})}disableCompletion(){const e=this.getSelectionRange();this.completionDisabled=e!==void 0&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){const e=window.getSelection();if(e===null||e.rangeCount===0)return;const t=e.getRangeAt(0),n=this.inputElement,r=document.createRange();r.setStart(n,0),r.setEnd(t.startContainer,t.startOffset);const s=r.toString().length,a=e.toString().length;return{begin:s,end:s+a}}setValueAndSelection(e,t=void 0){const n=this.completionDisabled!==-1;this.onInput.dispatch(e);const r=this.inputElement;Ke(r);let s=0;const a=t!==void 0?document.createRange():void 0;let l=!0;for(const d of O1(e)){l||r.appendChild(document.createElement("wbr")),l=!1;const u=s+d.length,h=document.createTextNode(d);if(r.appendChild(h),a!==void 0){const g=t.begin,v=t.end;g>=s&&g<=u&&a.setStart(h,g-s),v>=s&&v<=u&&a.setEnd(h,v-s)}s=u}if(a!==void 0){l&&(a.setStart(r,0),a.setEnd(r,0));const d=window.getSelection();d!==null&&(d.removeAllRanges(),d.addRange(a))}this.completionDisabled=n&&t!==void 0&&t.end===t.begin?t.end:-1}shouldAttemptCompletion(){const e=this.inputElement;if(document.activeElement!==e)return!1;const t=this.getSelectionRange();return t!==void 0&&t.end===t.begin&&t.end!=this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}updateHintState(){if(this.debouncedUpdateHintState.cancel(),this.shouldAttemptCompletion()){const e=this.value;if(e===this.prevInputValue)return;this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions()}else{this.hideCompletions();return}}handleDropdownClick(e){let t=this.completionsVirtualList;if(t===void 0)return;const n=t.element;for(let r=e.target;r instanceof HTMLElement&&r!==n;r=r.parentElement){const s=r.dataset.completionIndex;if(s!==void 0){this.selectCompletion(Number(s));break}}}cycleActiveCompletion(e){if(this.completionResult===null)return;let t=this.activeIndex,n=this.completionResult.completions.length;t===-1?e>0?t=0:t=n-1:t=(t+e+n)%n,this.setActiveIndex(t)}shouldShowDropdown(){return this.completionResult===null||!this.hasFocus?!1:this.hasResultForDropdown}updateDropdownStyle(){const e=this.completionsVirtualList,t=this.element;e!==void 0&&rz(e.element,t,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let e=this.completionsVirtualList;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){e!==void 0&&e.dispose();const r=this.completionResult;var t=r.makeElement;const s=t===void 0?uz:t;e=this.completionsVirtualList=new ly({source:{length:r.completions.length,render:a=>{const l=r.completions[a],d=s.call(r,l);return d.classList.add("neuroglancer-multiline-autocomplete-completion"),d.dataset.completionIndex=`${a}`,this.activeIndex===a&&d.classList.add(Ff),d}},selectedIndex:this.activeIndex===-1?void 0:this.activeIndex}),e.element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",a=>{this.inputElement.focus(),a.preventDefault()}),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),this.completionsVisible||(this.completionsVisible=!0);const n=this.activeIndex;n!==-1&&this.completionsVirtualList.scrollItemIntoView(n)}else this.completionsVisible&&(e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();let t=e.completions;if(t.length===0)return;const n=this.prevInputValue;if(n!==void 0){if(this.completionResult=e,t.length===1){let r=t[0];e.showSingleResult?this.hasResultForDropdown=!0:r.value.startsWith(n)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;let r=sz((function*(){for(let a of e.completions)yield a.value})()),s=this.getCompletedValue(r);s.startsWith(n)&&(this.commonPrefix=s,this.setHintValue(s))}this.updateDropdown()}}setHintValue(e){const t=this.prevInputValue;if(t===void 0)return;(e===t||!e.startsWith(t))&&(e=""),e=e.substring(t.length);const n=this.hintElement;Ke(n);let r=!0;for(const s of O1(e)){r||n.appendChild(document.createElement("wbr")),r=!1;const a=document.createTextNode(s);n.appendChild(a)}}setActiveIndex(e){if(!this.dropdownContentsStale){let t=this.activeIndex;const n=this.completionsVirtualList;if(n!==void 0){if(t!==-1){const r=n.getItemElement(t);r!==void 0&&r.classList.remove(Ff)}if(e!==-1){let r=n.getItemElement(e);r!==void 0&&r.classList.add(Ff),n.scrollItemIntoView(e)}}}e!==-1&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){let t=this.completionResult,n=this.prevInputValue;return n===void 0?"":n.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){const e=document.createRange(),t=this.inputElement;e.setStart(t,0),e.setEnd(t,0);const n=window.getSelection();n!==null&&(n.removeAllRanges(),n.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){const e=document.createRange(),t=this.inputElement,n=t.childNodes,r=n[n.length-1];r===void 0?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(r),e.setEndAfter(r));const s=window.getSelection();s!==null&&(s.removeAllRanges(),s.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let t=this.activeIndex;if(t===-1){if(!e)return!1;let r=this.completionResult;if(r!==null&&r.completions.length===1)t=0;else{let s=this.commonPrefix;return s.length>this.value.length?(this.value=s,this.moveCaretToEndOfInput(),!0):!1}}let n=this.getCompletedValueByIndex(t);return this.value===n?!1:(this.value=n,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0;const e=this.activeCompletionCancellationToken;e!==void 0&&e.cancel(),this.activeCompletionCancellationToken=void 0,this.activeCompletionPromise=null}clearCompletions(){if(this.completionResult!==null){this.activeIndex=-1,this.completionResult=null,this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,this.commonPrefix="";const e=this.completionsVirtualList;e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){const e=this.completionsVirtualList;e!==void 0&&e.dispose(),kt(this.element),this.cancelActiveCompletion(),super.disposed()}}class _r extends Y{constructor(e=new Nt(Nt.VISIBLE)){super(),this.visibility=e,this.element=document.createElement("div"),this.element.classList.add("neuroglancer-tab-content")}get visible(){return this.visibility.visible}disposed(){kt(this.element),super.disposed()}}class mz extends Y{constructor(){super(...arguments),this.changed=new be,this.options=new ce,this.optionsChanged=new be,this.selectedValue=void 0,this.defaultValue=void 0,this.ready_=!0}get value(){const e=this.selectedValue;return e!==void 0?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){e!==void 0&&this.ready_&&!this.options.has(e)&&(e=void 0),this.selectedValue!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){const e=this.selectedValue;return e===void 0||!this.options.has(e)?this.defaultValue:e}add(e,t){const n=this.options;if(n.has(e))throw new Error(`Option already defined: ${re(e)}.`);n.set(e,t),this.optionsChanged.dispatch(),this.defaultValue===void 0&&(this.default=e)}toJSON(){const e=this.value,t=this.defaultValue;if(e!==t)return e}reset(){this.value=void 0}get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){typeof e!="string"&&(e=void 0),this.value=e}}class vz extends Y{constructor(e,t,n=new Nt(Nt.VISIBLE),r=!1){super(),this.getter=e,this.selected=t,this.visibility=n,this.invalidateByDefault=r,this.element=document.createElement("div"),this.tabs=new ce,this.tabVisibilityChanged=new Ze,this.debouncedUpdateSelectedTab=this.registerCancellable(dt(()=>this.updateSelectedTab()));const s=this.element;s.className="neuroglancer-stack-view",this.registerDisposer(n.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}get visible(){return this.visibility.visible}flush(){this.debouncedUpdateSelectedTab.flush()}invalidate(e){const t=this.tabs,n=t.get(e);n!==void 0&&(n.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab()))}hideTab(e){const t=this.tabs.get(e);t!==void 0&&(t.visibility.value=Nt.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){const t=this.tabs;let n=t.get(e);n===void 0&&(n=this.getter(e),this.element.appendChild(n.element),t.set(e,n)),n.element.style.display="",n.visibility.value=Nt.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){const e=this.displayedTab,t=this.visible?this.selected.value:void 0;t===e&&(t===void 0||this.tabs.has(t))||(e!==void 0&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,t!==void 0&&this.showTab(t))}invalidateAll(e=void 0){const t=this.tabs;for(const r of t){var n=ae(r,2);const s=n[0],a=n[1];e!==void 0&&e(s)||(t.delete(s),a.dispose())}this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),kt(this.element),super.disposed()}}class yz extends mz{}function Sz(i,e){const t="neuroglancer-selected-tab-label";e?i.classList.add(t):i.classList.remove(t)}class bz extends Y{constructor(e,t=new Nt(Nt.VISIBLE)){super(),this.visibility=t,this.element=document.createElement("div"),this.tabBar=document.createElement("div"),this.tabLabels=new ce,this.tabsGeneration=-1,this.debouncedUpdateView=this.registerCancellable(dt(()=>this.updateTabs())),this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;const n=this.element,r=this.tabBar;n.className="neuroglancer-tab-view",r.className="neuroglancer-tab-view-bar",n.appendChild(r),this.registerDisposer(t.changed.add(this.debouncedUpdateView));const s=this.stack=this.registerDisposer(new vz(e.makeTab,e.selectedTab,this.visibility));n.appendChild(s.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView)),this.registerDisposer(e.selectedTab.changed.add(()=>this.updateTabLabelStyles())),this.updateTabs()}get visible(){return this.visibility.visible}updateTabLabelStyles(){const e=this.selectedTab.value;for(const n of this.tabLabels){var t=ae(n,2);const r=t[0],s=t[1];Sz(s,r===e)}}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(this.tabsGeneration!==-1){if(this.tabLabels.clear(),!this.visible)this.stack.invalidateAll();else{const e=this.tabs.value;this.stack.invalidateAll(t=>e.find(({id:n})=>n===t)!==void 0)}Ke(this.tabBar),this.tabsGeneration=-1}}makeTabs(){const e=this.tabBar,t=this.tabLabels,n=this.handleTabElement;for(const r of this.tabs.value){const s=r.id,a=r.label,l=document.createElement("div");l.classList.add("neuroglancer-tab-label"),l.textContent=a,l.addEventListener("click",()=>{this.selectedTab.value=s}),n!==void 0&&n(s,l),t.set(s,l),e.appendChild(l)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){Ke(this.tabBar),this.tabLabels.clear(),kt(this.element),super.disposed()}}class wz extends gz{constructor(e){const t=e.source.layer.manager,n=(s,a)=>t.dataSourceProviderRegistry.completeUrl({url:s,chunkManager:t.chunkManager,cancellationToken:a}).then(l=>({completions:l.completions,makeElement:hz,offset:l.offset,showSingleResult:!0}));super({completer:n,delay:0}),this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new ct(!1);const r=s=>{s!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};r(""),this.onInput.add(r)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}}class jT extends Y{constructor(e){super(),this.model=e,this.element=document.createElement("ul"),this.generation=-1,this.element.classList.add("neuroglancer-layer-data-sources-source-messages");const t=this.registerCancellable(dt(()=>this.updateView()));this.registerDisposer(e.changed.add(t)),this.registerDisposer(()=>kt(this.element)),this.updateView()}updateView(){const e=this.model,t=e.changed.count;if(t===this.generation)return;this.generation=t;const n=this.element;Ke(n);const r=new $e;for(const s of e){const a=`${s.severity} ${s.message}`;if(r.has(a))continue;r.add(a);const l=document.createElement("li");n.appendChild(l),l.classList.add("neuroglancer-message"),l.classList.add(`neuroglancer-message-${Yn[s.severity]}`),l.textContent=s.message}}}class Cz extends Y{constructor(e,t){super(),this.loadedSubsource=t,this.element=document.createElement("div");const n=this.element;n.classList.add("neuroglancer-layer-data-source-subsource");const r=document.createElement("label"),s=document.createElement("span"),a=()=>{r.dataset.isActive=(t.activated!==void 0||!t.enabled).toString()};a(),this.registerDisposer(t.isActiveChanged.add(a)),this.registerDisposer(e.enabledSubsourcesChanged.add(a));const l=this.registerDisposer(new Es({get value(){return t.enabled},set value(C){t.enabled=C,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));r.classList.add("neuroglancer-layer-data-sources-info-line"),r.appendChild(l.element);const d=document.createElement("span");d.classList.add("neuroglancer-layer-data-sources-source-id");const u=t.subsourceEntry.id;u!=="default"&&(d.textContent=u),r.appendChild(d),s.classList.add("neuroglancer-layer-data-sources-source-type");const h=this.registerDisposer(new jT(this.loadedSubsource.messages));n.appendChild(r),r.appendChild(s),n.appendChild(h.element);let g="";const v=t.subsourceEntry.subsource,y=v.volume;if(y instanceof Ds)g=`${q[y.dataType].toLowerCase()} volume`;else if(v.mesh instanceof Ac)g="meshes (single-res.)";else if(v.mesh instanceof yh)g="meshes (multi-res.)";else if(v.mesh instanceof Sh)g="skeletons";else if(v.segmentPropertyMap!==void 0)g="segment property map";else if(v.local!==void 0)switch(v.local){case Rr.annotations:g="Local annotations";break;case Rr.equivalences:g="local segmentation graph";break}else v.staticAnnotations!==void 0?g="default annotations":v.annotation!==void 0?g="annotations":v.singleMesh!==void 0?g="single mesh":v.segmentationGraph!==void 0&&(g="segmentation graph");s.textContent=g}}class xz extends Y{constructor(e){super(),this.source=e,this.element=document.createElement("div");const t=this.element,n=document.createElement("label");n.classList.add("neuroglancer-layer-data-sources-source-default"),n.appendChild(this.registerDisposer(new Es({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(s){if(e.enableDefaultSubsources!==s){if(e.enableDefaultSubsources=s,s)for(const a of e.subsources)a.enabled=a.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}}})).element),n.appendChild(document.createTextNode("Enable default subsource set")),n.title="Enable the default set of subsources for this data source.",t.appendChild(n);for(const s of e.subsources)t.appendChild(this.registerDisposer(new Cz(e,s)).element);const r=e.transform;if(r.mutableSourceRank||r.value.sourceRank!==0){const s=this.registerDisposer(new nz(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(s.element)}this.registerDisposer(()=>kt(this.element))}}class kz extends Y{constructor(e,t){super(),this.tab=e,this.source=t,this.element=document.createElement("div"),this.seenGeneration=0,this.generation=-1;const n=this.urlInput=this.registerDisposer(new wz(this)),r=(a,l)=>{const d=this.source,u=d.spec,h=this.source.layer;if(a=h.manager.dataSourceProviderRegistry.normalizeUrl({url:a}),a!==n.value&&(n.disableCompletion(),n.setValueAndSelection(a,{begin:a.length,end:a.length})),n.dirty.value=!1,a&&a===u.url){l&&e.detectedLayerConstructor!==void 0&&qT(d.layer);return}if(h instanceof Ar)try{const g=h.manager.dataSourceProviderRegistry.suggestLayerName(a);WD(h.managedLayer,g)}catch{}d.spec=H(H({},u),{url:a})};n.onCommit.add(r);const s=this.element;s.classList.add("neuroglancer-layer-data-source"),s.appendChild(n.element),s.appendChild(this.registerDisposer(new jT(t.messages)).element),this.updateView()}updateView(){const e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;const t=this.source.loadState;let n=this.loadedView;if(n!==void 0){if(n.source===t)return;n.dispose(),n=this.loadedView=void 0}t instanceof Gv&&(n=this.loadedView=new xz(t),this.element.appendChild(n.element))}disposed(){const e=this.loadedView;e!==void 0&&e.dispose(),kt(this.element),super.disposed()}}function qT(i){if(i instanceof Ar){const e=i.detectedLayerConstructor;if(e!==void 0)return by(i.managedLayer,e),!0}return!1}class Ez extends _r{constructor(e){super(),this.layer=e,this.generation=-1,this.sourceViews=new ce,this.addDataSourceIcon=HT({title:"Add additional data source"}),this.layerTypeDetection=document.createElement("div"),this.layerTypeElement=document.createElement("span"),this.dataSourcesContainer=document.createElement("div"),this.detectedLayerConstructor=void 0;const t=this.element,n=this.dataSourcesContainer;t.classList.add("neuroglancer-layer-data-sources-tab"),n.classList.add("neuroglancer-layer-data-sources-container");const r=this.addDataSourceIcon;if(r.style.alignSelf="start",r.addEventListener("click",()=>{const a=this.layer.addDataSource(void 0);this.updateView();const l=this.sourceViews.get(a);l!==void 0&&l.urlInput.inputElement.focus()}),t.appendChild(this.dataSourcesContainer),e instanceof Ar){const a=this.layerTypeDetection,l=this.layerTypeElement;a.style.display="none",l.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),a.appendChild(document.createTextNode("Create as ")),a.appendChild(l),a.appendChild(document.createTextNode(" layer")),t.appendChild(a),a.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),a.addEventListener("click",()=>{qT(e)})}const s=this.reRender=dt(()=>this.updateView());this.registerDisposer(e.dataSourcesChanged.add(s)),this.registerDisposer(this.visibility.changed.add(s)),this.updateView()}updateLayerTypeDetection(){const e=(()=>{const n=this.layer;if(!(n instanceof Ar))return;const r=n.detectedLayerConstructor;if(r!==void 0){for(const s of this.sourceViews.values())if(s.urlInput.dirty.value)return;return r}})();if(e===this.detectedLayerConstructor)return;const t=this.layerTypeDetection;if(this.detectedLayerConstructor=e,e!==void 0){const n=this.layerTypeElement;n.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){const e=this.sourceViews;for(const t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;const e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;const n=Date.now(),r=this.sourceViews,s=this.layer;function*a(){let l=!0;const d=s.dataSources;for(const u of d){let h=r.get(u);h===void 0&&(h=new kz(this,u),h.registerDisposer(h.urlInput.dirty.changed.add(this.reRender)),r.set(u,h)),h.seenGeneration=n,h.updateView();const g=u.spec.url;d.length===1&&g===""&&setTimeout(()=>{h.urlInput.inputElement.focus()},0),l=u.spec.url.length===0,yield h.element}l||(yield this.addDataSourceIcon)}Xn(this.dataSourcesContainer,a.call(this));for(const l of r){var t=ae(l,2);const d=t[0],u=t[1];u.seenGeneration!==n&&(u.dispose(),r.delete(d))}}this.updateLayerTypeDetection()}}const Vd="tab",B1="tabs",_1="panels",Lz=H(H({},la),{row:0}),JT=H(H({},la),{visible:!0,row:0});class ac extends Y{constructor(e){super(),this.panels=e,this.layer=this.panels.layer,this.location=new Ts(JT),this.tabsChanged=new Ze,this.selectedTab=new ct(void 0),this.tabs=[]}initialize(){const e=this.panels;this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add(()=>{var t;e.specificationChanged.dispatch();const n=this.layer,r=n.manager.root.selectedLayer;if(((t=r.layer)===null||t===void 0?void 0:t.layer)!==n||this!==n.panels.panels[0])return;const s=this.location.value;r.location.value!==s&&(r.location.value=s,r.location.locationChanged.dispatch())}),this.location.locationChanged.add(()=>{this.location.visible||this!==this.panels.panels[0]&&this.panels.removePanel(this)})}normalizeTabs(){const e=this.tabs;if(e.length===0){this.selectedTab.value=void 0;return}const t=this.layer.tabs.options,n=a=>{var l;return(l=t.get(a).order)!==null&&l!==void 0?l:0};e.sort((a,l)=>n(a)-n(l));const r=this.selectedTab,s=r.value;(s===void 0||!e.includes(s))&&(r.value=e[0])}pin(){var e;const t=this.layer,n=t.manager.root.selectedLayer;if(((e=n.layer)===null||e===void 0?void 0:e.layer)!==t||this!==t.panels.panels[0]||this.tabs.length===0)return;const r=this.panels,s=t.registerDisposer(new ac(r));r.panels.splice(0,1,s),r.panels.push(this),r.updateTabs(),s.initialize(),n.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){var e;const t=this.panels,n=t.panels.indexOf(this);if(n===-1||n===0)return;const r=this.layer,s=r.manager.root.selectedLayer,a=(e=s.layer)===null||e===void 0?void 0:e.layer;s.visible&&a!=null&&a!=r&&a.panels.panels[0].pin(),t.panels.splice(n,1);var l=t.panels.splice(0,1,this),d=ae(l,1);const u=d[0];if(this.explicitTabs===void 0)r.unregisterDisposer(u);else{t.panels.push(u);for(let h=1,g=t.panels.length;h<g;++h){const v=t.panels[h];v.explicitTabs===void 0&&(v.explicitTabs=new $e(v.tabs))}}this.explicitTabs=void 0,t.updateTabs(),s.layer=r.managedLayer,s.location.value=this.location.value,s.location.locationChanged.dispatch(),s.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;const n=this.panels;{const a=this.explicitTabs;a!==void 0&&a.delete(e)}const r=this.layer,s=r.registerDisposer(new ac(n));s.location.value=t,s.explicitTabs=new $e([e]),n.panels.splice(1,0,s),n.updateTabs(),s.initialize(),r.manager.root.layerManager.layersChanged.dispatch(),n.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{const r=this.explicitTabs;r!==void 0&&r.delete(e)}{const r=t.explicitTabs;r!==void 0&&r.add(e)}const n=this.panels;n.updateTabs(),t.selectedTab.value=e,n.specificationChanged.dispatch()}mergeInto(e){const t=e.explicitTabs;if(t!==void 0)for(const n of this.tabs)t.add(n);this.panels.removePanel(this)}}class Tz{constructor(e){this.layer=e,this.specificationChanged=new Ze,this.updating=!1,this.panels=[e.registerDisposer(new ac(this))]}restoreState(e){const t=this.panels;t[0].selectedTab.value=ye(e,Vd,Le);const n=this.layer,r=n.tabs,s=new $e(r.options.keys());ye(e,_1,a=>We(a,l=>{ge(l);const d=new ac(this);d.location.restoreState(l),d.location.visible&&(d.selectedTab.value=ye(l,Vd,Le),d.explicitTabs=ye(l,B1,u=>{const h=new $e;for(const g of Ln(u))s.has(g)&&(s.delete(g),h.add(g));return h}),d.explicitTabs===void 0?(d.tabs=Ee(s),s.clear()):d.tabs=Ee(d.explicitTabs),d.tabs.length!==0&&(d.normalizeTabs(),n.registerDisposer(d),d.initialize(),t.push(d)))})),t[0].tabs=Ee(s),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;const t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){var e;const t=this.layer,n=t.tabs,r=new $e(n.options.keys()),s=this.panels;this.updating=!0;const a=l=>{const d=l.tabs;if(l.explicitTabs===void 0)l.tabs=Ee(r),r.clear();else{l.tabs=Ee(l.explicitTabs);for(const u of l.tabs)r.delete(u)}Oe(d,l.tabs)||(l.normalizeTabs(),l.tabsChanged.dispatch())};for(let l=1;l<s.length;){const d=s[l];if(d.location.visible&&(a(d),d.tabs.length!==0)){++l;continue}s.splice(l,1),t.unregisterDisposer(d)}if(a(s[0]),s[0].tabs.length===0){const l=this.layer.manager.root.selectedLayer;((e=l.layer)===null||e===void 0?void 0:e.layer)===this.layer&&(l.location.visible=!1)}this.updating=!1}toJSON(){var e;const t=this.panels,n={};if(n[Vd]=t[0].selectedTab.value,t.length>1){const r=[];for(let s=1,a=t.length;s<a;++s){const l=t[s],d=(e=l.location.toJSON())!==null&&e!==void 0?e:{};d[Vd]=l.selectedTab.value;const u=l.explicitTabs;u!==void 0&&(d[B1]=Ee(u)),r.push(d)}n[_1]=r}return n}}const Dz=/^[A-Z]$/;class F1 extends Y{constructor(e,t){super(),this.tool=e,this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(ve(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}cancel(){this==this.tool.layer.manager.root.toolBinder.activeTool_&&this.tool.layer.manager.root.toolBinder.deactivate_()}}class Eo extends Y{constructor(e,t=!1){super(),this.layer=e,this.toggle=t,this.changed=new Ze,this.keyBinding=void 0}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}unbind(){const e=this.layer,t=this.keyBinding;t!==void 0&&e.toolBinder.set(t,void 0)}}class XT extends Y{constructor(e){super(),this.layer=e,this.changed=new Ze}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){const e=this.layer;e.tool.value===this&&(e.tool.value=void 0)}}function U1(i,e){var t;if(e===void 0)return;typeof e=="string"&&(e={type:e}),ge(e);const n=K(e,"type",Le);let r=(t=Xg.get(i.constructor))===null||t===void 0?void 0:t.get(n);if(r===void 0&&(r=Iz.get(n)),r===void 0)throw new Error(`Invalid tool type: ${re(e)}.`);return r(i,e)}function Pz(i,e){if(e===void 0)return;typeof e=="string"&&(e={type:e}),ge(e);const t=K(e,"type",Le),n=KT.get(t);if(n===void 0)throw new Error(`Invalid tool type: ${re(e)}.`);return n(i,e)}const KT=new ce,Iz=new ce,Xg=new ce;function _c(i,e){KT.set(i,e)}function oc(i,e,t){let n=Xg.get(i);n===void 0&&(n=new ce,Xg.set(i,n)),n.set(e,t)}class Rz extends Y{constructor(e){super(),this.layer=e,this.changed=new Ze}get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),e!==void 0&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){const e=this.value_;e!==void 0&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=Pz(this.layer,e)}reset(){this.value=void 0}toJSON(){const e=this.value_;if(e!==void 0)return e.toJSON()}}class Mz extends Y{constructor(e){super(),this.inputEventMapBinder=e,this.bindings=new ce,this.changed=new Ze,this.debounceDeactivate=this.registerCancellable(nt(()=>this.deactivate_(),100)),this.debounceReactivate=this.registerCancellable(nt(()=>this.reactivateQueuedTool(),100))}get(e){return this.bindings.get(e)}set(e,t){const n=this.bindings,r=n.get(e);if(r!==void 0){r.keyBinding=void 0,n.delete(e);const s=r.layer.toolBinder;s.bindings.delete(e),s.jsonToKey.delete(re(r.toJSON())),this.destroyTool(r),s.changed.dispatch()}if(t!==void 0){const s=t.layer.toolBinder,a=re(t.toJSON()),l=s.jsonToKey.get(a);if(l!==void 0){const d=s.bindings.get(l);d.keyBinding=void 0,n.delete(l),s.bindings.delete(l),s.jsonToKey.delete(a),this.destroyTool(d)}s.bindings.set(e,t),t.keyBinding=e,s.jsonToKey.set(a,e),n.set(e,t),s.changed.dispatch()}this.changed.dispatch()}activate(e){const t=this.get(e);if(t===void 0){this.deactivate_();return}this.debounceDeactivate.cancel(),this.debounceReactivate.cancel();const n=this.activeTool_;if(t===n?.tool){t.toggle&&this.deactivate_();return}else n!==void 0&&(n.tool.toggle&&!t.toggle&&(this.queuedTool=n.tool),this.deactivate_());const r=new F1(t,this.inputEventMapBinder);if(this.activeTool_=r,!t.toggle){const s=`Key${e}`;r.registerEventListener(window,"keyup",a=>{a.code===s&&(this.debounceDeactivate(),this.debounceReactivate())}),r.registerEventListener(window,"blur",()=>{this.debounceDeactivate(),this.debounceReactivate()})}return t.activate(r),t}reactivateQueuedTool(){if(this.queuedTool){const e=new F1(this.queuedTool,this.inputEventMapBinder);this.activeTool_=e,this.queuedTool.activate(e),this.queuedTool=void 0}}destroyTool(e){var t;this.queuedTool===e&&(this.queuedTool=void 0),((t=this.activeTool_)===null||t===void 0?void 0:t.tool)===e&&this.deactivate_(),e.dispose()}disposed(){this.deactivate_(),super.disposed()}deactivate_(){this.debounceDeactivate.cancel();const e=this.activeTool_;e!==void 0&&(this.activeTool_=void 0,e.dispose())}}class Az{constructor(e){this.layer=e,this.bindings=new ce,this.jsonToKey=new ce,this.changed=new Ze,e.registerDisposer(()=>this.clear())}get globalBinder(){return this.layer.manager.root.toolBinder}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){const n=U1(this.layer,t);n!==void 0&&this.set(e,n)}removeJsonString(e){const t=this.jsonToKey.get(e);t!==void 0&&this.set(t,void 0)}toJSON(){const e=this.bindings;if(e.size===0)return;const t={};for(const r of e){var n=ae(r,2);const s=n[0],a=n[1];t[s]=a.toJSON()}return t}clear(){const e=this.globalBinder,t=this.bindings;if(t.size!==0){for(const r of t){var n=ae(r,2);const s=n[0],a=n[1];a.keyBinding=void 0,e.bindings.delete(s),e.destroyTool(a)}t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(e!==void 0){ge(e);for(const n of Tc(e)){var t=ae(n,2);const r=t[0],s=t[1];if(!r.match(Dz))throw new Error(`Invalid tool key: ${re(r)}`);const a=U1(this.layer,s);if(a===void 0)return;this.set(r,a)}}}}class YT extends Y{constructor(e,t){super(),this.layer=e,this.toolJson=t,this.element=document.createElement("div"),this.toolJsonString=re(this.toolJson);const n=this.element;n.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.toolBinder.changed.add(this.registerCancellable(dt(()=>this.updateView())))),this.updateView(),n.title="click → bind key, dbclick → unbind",n.addEventListener("dblclick",()=>{this.layer.toolBinder.removeJsonString(this.toolJsonString)}),ZT(this,n,r=>this.layer.toolBinder.setJson(r,this.toolJson))}updateView(){const e=this.layer.toolBinder.jsonToKey.get(this.toolJsonString);this.element.textContent=e??" "}}function ZT(i,e,t){let n;e.addEventListener("mousedown",r=>{r.button!==0||n!==void 0||(r.preventDefault(),r.stopPropagation(),n=new Y,i.registerDisposer(n),n.registerDisposer(new Ye(!1)).setText("Press A-Z to bind key"),n.registerEventListener(window,"keydown",s=>{const a=s.code.match(/^Key([A-Z])$/);if(a===null)return;s.stopPropagation(),s.preventDefault();const l=a[1];t(l)},{capture:!0}),n.registerEventListener(window,"mouseup",s=>{s.button!==0||n===void 0||(s.preventDefault(),s.stopPropagation(),i.unregisterDisposer(n),n.dispose(),n=void 0)}))}),e.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation()})}function Uf(i,e,t){const n=document.createElement("div");n.classList.add("neuroglancer-tool-button"),n.appendChild(i.registerDisposer(new YT(e,t.toolJson)).element);const r=document.createElement("div");return r.classList.add("neuroglancer-tool-button-label"),r.textContent=t.label,t.title&&(r.title=t.title),n.appendChild(r),n}function Nz(i){const e=i.registerDisposer(new Ye(!1));e.element.classList.add("neuroglancer-tool-status");const t=document.createElement("div");t.classList.add("neuroglancer-tool-status-content"),e.element.appendChild(t);const n=i.inputEventMapBinder;return i.inputEventMapBinder=(r,s)=>{const a=document.createElement("div");a.textContent=r.describe(),a.classList.add("neuroglancer-tool-status-bindings"),e.element.appendChild(a),n(r,s)},{message:e,content:t}}function bh(i){var e=Nz(i);const t=e.message,n=e.content,r=document.createElement("div");r.classList.add("neuroglancer-tool-status-header");const s=document.createElement("div");s.classList.add("neuroglancer-tool-status-header-container"),s.appendChild(r),n.appendChild(s);const a=document.createElement("div");return a.classList.add("neuroglancer-tool-status-body"),n.appendChild(a),{message:t,body:a,header:r}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function Vz(i,e){i.remove(e)}function Oz(i,e){i.add(e)}const QT="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%20aria-labelledby='controlsAltIconTitle'%3e%3ctitle%20id='controlsAltIconTitle'%3eControls%3c/title%3e%3ccircle%20cx='9'%20cy='6'%20r='2'/%3e%3cpath%20d='M4%206H7'/%3e%3cpath%20d='M11%206H20'/%3e%3ccircle%20cx='9'%20cy='18'%20r='2'/%3e%3cpath%20d='M4%2018H7'/%3e%3cpath%20d='M11%2018H20'/%3e%3ccircle%20cx='15'%20cy='12'%20r='2'/%3e%3cpath%20d='M4%2012H13'/%3e%3cpath%20d='M17%2012L20%2012'/%3e%3c/svg%3e",Bz="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%20aria-labelledby='layersIconTitle'%3e%3ctitle%20id='layersIconTitle'%3eLayers%3c/title%3e%3cpath%20d='M12%204L20%208.00004L12%2012L4%208.00004L12%204Z'/%3e%3cpath%20d='M20%2012L12%2016L4%2012'/%3e%3cpath%20d='M20%2016L12%2020L4%2016'/%3e%3c/svg%3e",_z="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='listIconTitle'%3e%3ctitle%20id='listIconTitle'/%3e%3cpath%20d='M10%207L18%207M10%2012L18%2012M10%2017L18%2017'/%3e%3cline%20x1='7'%20y1='7'%20x2='7'%20y2='7'/%3e%3cline%20x1='7'%20y1='12'%20x2='7'%20y2='12'/%3e%3cline%20x1='7'%20y1='17'%20x2='7'%20y2='17'/%3e%3c/svg%3e",Fz="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='settingsIconTitle'%3e%3ctitle%20id='settingsIconTitle'%3eSettings%3c/title%3e%3cpath%20d='M5.03506429,12.7050339%20C5.01187484,12.4731696%205,12.2379716%205,12%20C5,11.7620284%205.01187484,11.5268304%205.03506429,11.2949661%20L3.20577137,9.23205081%20L5.20577137,5.76794919%20L7.9069713,6.32070904%20C8.28729123,6.0461342%208.69629298,5.80882212%209.12862533,5.61412402%20L10,3%20L14,3%20L14.8713747,5.61412402%20C15.303707,5.80882212%2015.7127088,6.0461342%2016.0930287,6.32070904%20L18.7942286,5.76794919%20L20.7942286,9.23205081%20L18.9649357,11.2949661%20C18.9881252,11.5268304%2019,11.7620284%2019,12%20C19,12.2379716%2018.9881252,12.4731696%2018.9649357,12.7050339%20L20.7942286,14.7679492%20L18.7942286,18.2320508%20L16.0930287,17.679291%20C15.7127088,17.9538658%2015.303707,18.1911779%2014.8713747,18.385876%20L14,21%20L10,21%20L9.12862533,18.385876%20C8.69629298,18.1911779%208.28729123,17.9538658%207.9069713,17.679291%20L5.20577137,18.2320508%20L3.20577137,14.7679492%20L5.03506429,12.7050339%20Z'/%3e%3ccircle%20cx='12'%20cy='12'%20r='1'/%3e%3c/svg%3e";class Fc extends Y{}function eD(i){let e,t,n;return(r,s)=>t!==void 0&&(e===void 0||r===void 0||e.generation!==r.generation)?(e===void 0&&n.addConsumer(s),t):(e=void 0,n=new CO,t=i(r,n).then(a=>(e=a,n=void 0,a),a=>{throw n.isCanceled&&(n=void 0,t=void 0),a}),t)}function wh(i){let e=0;return eD((t,n)=>i(n).then(r=>({generation:++e,credentials:r})))}class Uz{constructor(){this.providers=new ce,this.topLevelManager=this}register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){const n=this.providers.get(e);if(n===void 0)throw new Error(`No registered credentials provider: ${re(e)}`);return n(t,this.topLevelManager)}}class zz extends Y{constructor(e){super(),this.base=e,this.memoize=new JL}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}}class tD extends zz{constructor(){super(new Uz),this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}}class $z extends Fc{constructor(e,t){super(),this.baseProvider=e,this.anonymousCredentials=t,this.anonymous=!0,this.get=eD(n=>this.anonymous&&n===void 0?xt.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(n)))}}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const zo=new tD;/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function rn(i,e){return t=>{t.style.flex=i,e(t)}}function qs(i,e){return t=>{t.style.display="flex",t.style.flexDirection=i;for(let n of e){let r=t.ownerDocument.createElement("div");t.appendChild(r),n(r)}}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const Gz=Je();function iD(i,e){const t=ZE(Gz),n=i.globalPosition;var r=i.displayDimensionRenderInfo;const s=r.canonicalVoxelFactors,a=r.displayDimensionIndices;for(let l=0;l<3;++l){const d=a[l];t[12+l]=d===-1?0:n[d],t[5*l]=e/s[l]}return ei(t,i.viewProjectionMat,t),t}class Ch extends Y{constructor(e){super(),this.gl=e,this.vertexBuffer=this.registerDisposer(Ui.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW));let t=.5;this.colorBuffer=this.registerDisposer(Ui.fromData(e,new Float32Array([1,0,0,t,1,0,0,t,0,1,0,t,0,1,0,t,0,0,1,t,0,0,1,t]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer(jO(e))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",()=>new Ch(e))}draw(e,t=!0){let n=this.trivialColorShader,r=this.gl;n.bind(),r.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,e);let s=n.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(s,4);let a=n.attribute("aColor");this.colorBuffer.bindToVertexAttrib(a,4),t&&(r.colorMask(!1,!1,!1,!0),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),r.colorMask(!0,!0,!0,!0),r.enable(r.BLEND),r.blendFunc(r.ONE_MINUS_DST_ALPHA,r.DST_ALPHA)),r.lineWidth(1),r.drawArrays(r.LINES,0,6),t&&r.disable(r.BLEND),r.disableVertexAttribArray(s),r.disableVertexAttribArray(a)}}/**
* @license
* Copyright 2018 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const Wz="perspective_view/PerspectiveView";/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class nD{constructor(){this.renderLayers=[null],this.pickData=[null],this.values=[0,0,0],this.nextPickID=1}clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t,n=1,r=null){return this.register(e,n,t.low,t.high,r)}register(e,t=1,n=0,r=0,s=null){let a=this.renderLayers,l=this.values,d=this.nextPickID;this.nextPickID+=t;let u=a.length;a[u]=e;let h=u*3;return l[h]=d,l[h+1]=n,l[h+2]=r,this.pickData[u]=s,d}setMouseState(e,t){const n=this.renderLayers,r=this.values;let s=0,a=n.length-1;for(;s<a;){const v=Math.ceil(s+(a-s)/2);r[v*3]>t?a=v-1:s=v}const l=e.pickedRenderLayer=n[s],d=s*3,u=e.pickedOffset=t-r[d];let h=e.pickedValue;h.low=r[d+1],h.high=r[d+2],e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferBaseOffset=void 0,e.pickedAnnotationIndex=void 0,e.pickedAnnotationCount=void 0,e.pickedAnnotationType=void 0;const g=this.pickData[s];l!==null&&l.updateMouseState(e,h,u,g)}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class Ka{static insertAfter(e,t){let n=e.next0;t.next0=n,t.prev0=e,e.next0=t,n.prev0=t}static insertBefore(e,t){let n=e.prev0;t.prev0=n,t.next0=e,e.prev0=t,n.next0=t}static front(e){let t=e.next0;return t===e?null:t}static back(e){let t=e.prev0;return t===e?null:t}static pop(e){let t=e.next0,n=e.prev0;return t.prev0=n,n.next0=t,e.next0=null,e.prev0=null,e}static*iterator(e){for(let t=e.next0;t!==e;t=t.next0)yield t}static*reverseIterator(e){for(let t=e.prev0;t!==e;t=t.prev0)yield t}static initializeHead(e){e.next0=e.prev0=e}}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class Hz{constructor(){Ka.initializeHead(this)}}const Kg=new Hz,jz=window.top===window,cy=nt(()=>{if(!jz)return;var i=document;const e=i.activeElement;if(e===null||e===document.body){const t=Ka.front(Kg);t!==null&&t.element.focus({preventScroll:!0})}});window.addEventListener("focus",()=>{cy()},!0);window.addEventListener("blur",()=>{cy()},!0);class xh extends Y{constructor(e){super(),this.element=e,this.prev0=null,this.next0=null,this.lastFocusedElement=null,this.scheduleUpdateFocus=this.registerCancellable(nt(()=>{var t=document;const n=t.activeElement,r=this.element;r.contains(n)||Yv(n)||(n!=null&&(n===this.lastFocusedElement||n.contains(r))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null)},0)),e.tabIndex=-1,this.registerEventListener(e,"pointerdown",t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))}),this.registerEventListener(e,"mouseenter",()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()}),this.registerEventListener(e,"mouseleave",()=>{this.scheduleUpdateFocus.cancel()}),Ka.insertBefore(Kg,this),this.registerEventListener(e,"focus",()=>{Ka.pop(this),Ka.insertAfter(Kg,this)}),cy()}disposed(){Ka.pop(this),super.disposed()}}const z1=10,qz=1e3,Jz=400,Xz=500,Kz=Math.PI/20,Yz=20,Zz=10;function rD(i,e){return Math.sqrt(i*i+e*e)}function $1(i){var e=ae(i,2);let t=e[0],n=e[1];if(t.identifier>n.identifier){var r=[t,n];n=r[0],t=r[1]}const s=t.clientX-n.clientX,a=t.clientY-n.clientY,l=rD(s,a),d=Math.atan2(s,a);return{distance:l,angle:d}}function Qz(i,e){const t=Math.PI*2,n=Math.abs(i-e)%t;return Math.min(n,t-n)}class e4 extends Y{constructor(e,t){super(),this.target=e,this.eventMap=t,this.prevTouches=new ce,this.moved=!1,this.prevAngle=0,this.rotated=!1,this.prevDistance=0,this.pinched=!1,this.prevCenterX=0,this.prevCenterY=0,this.translated=!1,this.startHold=this.registerCancellable(hh((n,r,s,a)=>{const l={event:n,centerX:s,centerY:a};this.dispatch(`touchhold${n.targetTouches.length}`,n,l,r)},qz,{leading:!1,trailing:!0})),this.numPriorTaps=0,this.priorTapNumTouches=0,this.tapStartTime=0,this.tapEndTime=0,this.curTapNumTouches=0,this.registerEventListener(e,"touchstart",n=>{this.handleTouchEvent(n)}),this.registerEventListener(e,"touchmove",n=>{this.handleTouchEvent(n)}),this.registerEventListener(e,"touchend",n=>{this.handleTouchEvent(n)})}dispatch(e,t,n,r=t.eventPhase){kT(e,t,r,n,this.eventMap)}handleTouchEvent(e){if(e.target===this.target)e.preventDefault();else return;const t=new ce,n=this.prevTouches,r=this.prevEvent;let s=0,a=0;for(const w of e.targetTouches)t.set(w.identifier,w),s+=w.clientX,a+=w.clientY;s/=t.size,a/=t.size;for(const w of n.entries()){var l=ae(w,2);const b=l[0],k=l[1],L=t.get(b);if(L===void 0)n.delete(b);else{const I=L.clientX-k.clientX,P=L.clientY-k.clientY;(Math.abs(I)>=z1||Math.abs(P)>=z1)&&(this.moved=!0)}}if(r===void 0||r.targetTouches.length!==t.size||t.size==0){if(this.moved=!1,e.type==="touchstart")this.startHold(e,e.eventPhase,s,a),(r===void 0||r.targetTouches.length===0)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if(e.type=="touchend"){const w=Date.now();if(e.targetTouches.length===0&&w-this.tapStartTime<Jz){(this.curTapNumTouches!==this.priorTapNumTouches||w-this.tapEndTime>=Xz)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=w,this.priorTapNumTouches=this.curTapNumTouches;const b={event:e,centerX:s,centerY:a};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,b)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=s,this.prevCenterY=a,this.translated=!1,t.size===2){var d=$1(t.values());const w=d.distance,b=d.angle;this.prevDistance=w,this.prevAngle=b,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let u=this.prevCenterX,h=this.prevCenterY,g=this.translated;const v=s-u,y=a-h;if(g===!1&&rD(v,y)>=Zz&&(g=this.translated=!0),g===!0&&(v!==0||y!==0)){this.prevCenterX=s,this.prevCenterY=a;const w={event:e,deltaX:v,deltaY:y,centerX:s,centerY:a};this.dispatch(`touchtranslate${t.size}`,e,w)}if(t.size===2){var C=$1(t.values());const w=C.distance,b=C.angle;let k=this.pinched,L=this.rotated,I=this.prevDistance,P=this.prevAngle;k===!1&&Math.abs(w-I)>=Yz&&(this.pinched=k=!0);const T=Qz(b,P);if(L===!1&&T>=Kz&&(this.rotated=L=!0),k===!0&&w!=I){this.prevDistance=w;const R={event:e,distance:w,prevDistance:I,centerX:s,centerY:a};this.dispatch("touchpinch",e,R)}L===!0&&b!==P&&(this.prevAngle=b,this.dispatch("touchrotate",e,{event:e,centerX:s,centerY:a,angle:b,prevAngle:P}))}}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const t4=0,i4=1,n4=2;function xu(i){let e=0;switch(i.deltaMode){case t4:e=1/200;break;case i4:e=1/10;break;case n4:e=2;break}return Math.exp(i.deltaY*e)}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const zf=Ne();class G1{constructor(){this.pickIDs=new nD,this.viewportWidth=0,this.viewportHeight=0,this.invTransform=Je(),this.frameNumber=-1}}class W1{constructor(){this.buffer=null,this.glWindowX=0,this.glWindowY=0}}const r4=30,Zt=5,it=1+Zt*2,ku=(()=>{const i=Zt**2,e=(r,s)=>(r-Zt)**2+(s-Zt)**2;let t=new Uint32Array(it*it),n=0;for(let r=0;r<it;++r)for(let s=0;s<it;++s)e(r,s)>i||(t[n++]=s*it+r);return t=t.subarray(0,n),t.sort((r,s)=>{const a=r%it,l=(r-a)/it,d=s%it,u=(s-d)/it;return e(a,l)-e(d,u)}),t})();function sD(i,e,t,n,r,s,a){const l=n-Zt,d=r-Zt;if(!(l>=0&&d>=0&&l+it<=s&&d+it<=a))for(let u=0;u<it;++u)for(let h=0;h<it;++h){const g=l+h,v=d+u;(g<0||v<0||g>=s||v>=a)&&(i[e+(v*it+g)*t]=0)}}class aD extends YL{constructor(e,t,n){super(e,t,n.visibility),this.viewer=n,this.mouseX=-1,this.mouseY=-1,this.pickRequestPending=!1,this.mouseStateForcer=()=>this.blockOnPickRequest(),this.pickingData=[new G1,new G1],this.pickRequests=[new W1,new W1],this.pickBufferContents=new Float32Array(8*it*it),this.pickTimerId=-1,this.nextPickRequestTime=0,this.pendingPickRequestTimerId=-1,this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,this.pickRequestPending&&this.attemptToIssuePickRequest()},this.inputEventMap=n.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP<"u"&&NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP===!0&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new xh(t)),this.registerDisposer(new Nn(t,this.inputEventMap)),this.registerDisposer(new Br(t,this.inputEventMap,r=>{this.onMousemove(r)})),this.registerDisposer(new e4(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",()=>this.onMouseout()),this.registerEventListener(t,"mouseover",r=>{r.target!==t&&this.onMouseout()},!0),ve(t,"select-position",()=>{this.viewer.selectionDetailsState.select(!1)}),ve(t,"snap",()=>{this.navigationState.pose.snap()}),ve(t,"zoom-in",()=>{this.navigationState.zoomBy(.5)}),ve(t,"zoom-out",()=>{this.navigationState.zoomBy(2)}),ve(t,"depth-range-decrease",()=>{this.navigationState.depthRange.value*=.5}),ve(t,"depth-range-increase",()=>{this.navigationState.depthRange.value*=2});for(let r=0;r<3;++r){let s=jN[r];for(let a of[-1,1]){let l=a<0?"-":"+";ve(t,`rotate-relative-${s}${l}`,()=>{this.navigationState.pose.rotateRelative(zn[r],a*.1)});let d=Ne();ve(t,`${s}${l}`,()=>{let u=this.navigationState,h=d;h[0]=0,h[1]=0,h[2]=0,h[r]=a,u.pose.translateVoxelsRelative(h,!0)})}}ve(t,"zoom-via-wheel",r=>{const s=r.detail;this.onMousemove(s,!1),this.zoomByMouse(xu(s))}),ve(t,"adjust-depth-range-via-wheel",r=>{const s=r.detail;this.navigationState.depthRange.value*=xu(s)}),ve(t,"translate-via-mouse-drag",r=>{Rn(r.detail,(s,a,l)=>{this.translateByViewportPixels(a,l)})}),ve(t,"translate-in-plane-via-touchtranslate",r=>{const s=r.detail;this.translateByViewportPixels(s.deltaX,s.deltaY)}),ve(t,"translate-z-via-touchtranslate",r=>{const s=r.detail;let a=this.navigationState,l=zf;l[0]=0,l[1]=0,l[2]=s.deltaY+s.deltaX,a.pose.translateVoxelsRelative(l,!0)});for(const r of[1,10])ve(t,`z+${r}-via-wheel`,s=>{const a=s.detail;let l=this.navigationState,d=zf,u=a.deltaY!==0?a.deltaY:a.deltaX;d[0]=0,d[1]=0,d[2]=(u>0?-1:1)*r,l.pose.translateVoxelsRelative(d,!0)});ve(t,"move-to-mouse-position",()=>{const r=this.viewer.mouseState;r.updateUnconditionally()&&(this.navigationState.position.value=r.position)}),ve(t,"snap",()=>this.navigationState.pose.snap()),ve(t,"move-annotation",r=>{const s=this.viewer.mouseState,a=s.pickedAnnotationId,l=s.pickedAnnotationLayer;if(l!==void 0&&a!==void 0){r.stopPropagation();let d=l.source.getReference(a),u=d.value;const h=zl(u.type),g=s.pickedOffset,v=l.chunkTransform.value;if(v.error!==void 0)return;const y=v.layerRank,C=new Float32Array(y);h.getRepresentativePoint(C,u,s.pickedOffset);let w=WN(rL(),0,0);s.updateUnconditionally()&&Rn(r.detail,(b,k,L)=>{HN(w,w,[k,L]);const I=new Float32Array(y);Er(I,v.chunkToLayerTransform,y+1,C,y);const P=zf,T=this.navigationState.pose.displayDimensions.value.displayDimensionIndices;z3(P,I,v.modelTransform,T),this.translateDataPointByViewportPixels(P,P,w[0],w[1]),$3(I,P,v.modelTransform,T);const R=new Float32Array(y);Er(R,v.layerToChunkTransform,y+1,I,y);let M=h.updateViaRepresentativePoint(u,R,g);l.source.update(d,M)},b=>{l.source.commit(d),d.dispose()})}}),ve(t,"delete-annotation",()=>{const r=this.viewer.mouseState,s=r.pickedAnnotationId,a=r.pickedAnnotationLayer;if(a!==void 0&&!a.source.readonly&&s!==void 0){const l=a.source.getReference(s);try{a.source.delete(l)}finally{l.dispose()}}}),ve(t,"zoom-via-touchpinch",r=>{const s=r.detail;this.handleMouseMove(s.centerX,s.centerY);const a=s.prevDistance/s.distance;a>.1&&a<10&&this.zoomByMouse(a)})}cancelPickRequests(){const e=this.gl;for(const t of this.pickRequests){const n=t.sync;n!==null&&e.deleteSync(n),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){const t=this.gl;let n=e.buffer;n===null?(n=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,n),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,32*it*it,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,n);const r=this.renderViewport;let s=this.mouseX-r.visibleLeftFraction*r.logicalWidth,a=r.height-(this.mouseY-r.visibleTopFraction*r.logicalHeight);this.issuePickRequest(s,a),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=s,e.glWindowY=a,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),this.pickTimerId===-1&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;const l=this.pickRequests;e!==l[0]&&(l[1]=l[0],l[0]=e),this.nextPickRequestTime=Date.now()+r4}completePickInternal(e){const t=this.gl,n=this.pickBufferContents;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,n),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);const r=this.pickingData,s=e.frameNumber;this.completePickRequest(e.glWindowX,e.glWindowY,n,r[0].frameNumber===s?r[0]:r[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout(()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()},0)}checkForPickRequestCompletion(e=!1,t=!1){let n=this.context.frameNumber,r=-1;e&&(--n,r=n-1);const s=this.pickRequests,a=this.gl;let l=!1,d=!1,u;for(const g of s){const v=g.sync;if(v===null)continue;const y=g.frameNumber;if(!d&&y>=n-1){if(t||a.getSyncParameter(v,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(g),d=!0;else if(y!==r){l=!0;continue}}a.deleteSync(v),g.sync=null,u=g}const h=this.pickTimerId;l&&h===-1?this.scheduleCheckForPickRequestCompletion():!l&&h!==-1&&(window.clearTimeout(h),this.pickTimerId=-1),!e&&u!==void 0&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(u)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){var e=this.renderViewport;const t=e.width,n=e.height;this.checkForPickRequestCompletion(!0);const r=this.pickingData;r[0]=r[1];const s=this.context.frameNumber,a=r[1];if(a.frameNumber=s,a.viewportWidth=t,a.viewportHeight=n,a.pickIDs.clear(),!this.drawWithPicking(a)){a.frameNumber=-1;return}this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()}canIssuePickRequest(){const e=Date.now(),t=this.nextPickRequestTime,n=this.pendingPickRequestTimerId;return e<t?(n==-1&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1):!0}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;const e=this.context.frameNumber,t=this.gl,n=this.pickRequests;for(const r of n){let s=r.sync;if(s!==null)if(r.frameNumber<e-1)t.deleteSync(s);else continue;this.issuePickRequestInternal(r);return}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0){this.pickRequestPending=!1,this.cancelPickRequests();return}const n=this.context.frameNumber,r=this.pickingData[1];r.frameNumber!==n||this.renderViewport.width!==r.viewportWidth||this.renderViewport.height!==r.viewportHeight||(this.pickRequestPending=!0,this.attemptToIssuePickRequest())}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){const n=this.element,r=n.getBoundingClientRect(),s=e-(r.left+n.clientLeft),a=t-(r.top+n.clientTop),l=this.viewer.mouseState;l.pageX=e+window.scrollX,l.pageY=t+window.scrollY,l.setForcer(this.mouseStateForcer),this.updateMousePosition(s,a)}onMousemove(e,t=!0){const n=this.element;t&&e.target!==n||this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){let t=this.element;if(e.target!==t||e.targetTouches.length!==1)return;var n=e.targetTouches[0];const r=n.clientX,s=n.clientY;this.handleMouseMove(r,s)}disposed(){this.viewer.mouseState.removeForcer(this.mouseStateForcer);const e=this.gl;this.cancelPickRequests();const t=this.pendingPickRequestTimerId;t!==-1&&window.clearTimeout(t);for(const n of this.pickRequests)e.deleteBuffer(n.buffer);super.disposed()}}const s4=[1.5,2,3,5,7.5,10];class a4{constructor(){this.allowedSignificands=s4,this.targetLengthInPixels=0,this.physicalSizePerPixel=0,this.prevPhysicalSizePerPixel=0,this.prevTargetLengthInPixels=0,this.prevPhysicalUnit="\0"}update(){let e=this.physicalSizePerPixel,t=this.targetLengthInPixels;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;const n=t*e,r=Math.floor(kL(n)),s=10**r,a=n/s;let l=1;for(let h of this.allowedSignificands)if(Math.abs(h-a)<Math.abs(l-a))l=h;else break;const d=l*s,u=EL(d);return this.lengthInPixels=Math.round(d/e),this.physicalUnit=`${u.prefix}${this.physicalBaseUnit}`,this.physicalLength=l*10**(r-u.exponent),!0}}function o4(i,e,t,n,r){const s=document.createElement("canvas"),a=s.getContext("2d"),l=r.textHeightInPixels*r.scaleFactor,d=`bold ${l}px ${r.fontName}`;a.font=d,a.fillStyle="white";const u=`${n}${i.physicalLength} ${i.physicalUnit}`,h=a.measureText(u),g=Math.max(i.lengthInPixels,h.width),v=r.barHeightInPixels*r.scaleFactor,y=r.barTopMarginInPixels*r.scaleFactor,C=v+y+l,w=r.paddingInPixels*r.scaleFactor,b=C+2*w,k=g+2*w;return s.width=k,s.height=b,a.font=d,a.textAlign="center",a.fillStyle="rgba(0, 0, 0, 0.3)",a.fillRect(0,0,k,b),a.fillStyle="white",a.fillText(u,k/2,b-w-v-y),a.fillRect(w,b-w-v,i.lengthInPixels,v),WO(e,t,s),{width:k,height:b}}class l4 extends Y{constructor(e,t=new a4){super(),this.gl=e,this.dimensions=t,this.texture=null,this.width=0,this.height=0,this.label="",this.factor=1,this.priorOptions=void 0,this.prevLabel=""}update(e){const t=this.dimensions,n=this.label;let r=this.texture;if(!t.update()&&r!==null&&e===this.priorOptions&&n==this.prevLabel)return;r===null&&(r=this.texture=this.gl.createTexture());var s=o4(t,this.gl,r,n,e);const a=s.width,l=s.height;this.priorOptions=e,this.prevLabel=n,this.width=a,this.height=l}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}}class oD extends Y{constructor(e){super(),this.gl=e,this.scaleBarCopyHelper=this.registerDisposer(go.get(this.gl)),this.scaleBars=[];for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new l4(e)))}draw(e,t,n,r,s){const a=this.scaleBars,l=t.displayRank,d=t.displayDimensionIndices,u=t.canonicalVoxelFactors,h=t.globalDimensionNames,g=t.displayDimensionUnits,v=t.displayDimensionScales,y=n.factors,C=Math.min(s.maxWidthFraction*e.logicalWidth,s.maxWidthInPixels*s.scaleFactor);let w=0;for(let I=0;I<l;++I){const P=d[I],T=g[I],R=y[P];let M,V,B;for(M=0;M<w&&(V=a[M],B=V.dimensions,!(B.physicalBaseUnit===T&&V.factor===R));++M);M===w&&(++w,V=a[M],V.label="",B=V.dimensions,V.factor=R,B.physicalBaseUnit=T,B.targetLengthInPixels=C,B.physicalSizePerPixel=v[I]*r/u[I]),V.label+=`${h[P]} `}const b=this.gl,k=this.scaleBarCopyHelper;let L=s.bottomPixelOffset*s.scaleFactor;for(let I=w-1;I>=0;--I){const P=a[I];w===1?P.label="":P.label+=": ",P.update(s),b.viewport(s.leftPixelOffset*s.scaleFactor-e.visibleLeftFraction*e.logicalWidth,L-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,P.width,P.height),k.draw(P.texture),L+=P.height+s.marginPixelsBetweenScaleBars*s.scaleFactor}}}const c4={scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2},lD=H(H({},c4),{maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5});function d4(i){const e=H({},lD);for(const t of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])K(i,t,n=>{n!==void 0&&(e[t]=fc(n))});return K(i,"fontName",t=>{t!==void 0&&(e.fontName=Le(t))}),e}class u4 extends Jt{constructor(){super(lD,d4)}}var Hi;(function(i){i[i.COLOR=0]="COLOR",i[i.Z=1]="Z",i[i.PICK=2]="PICK",i[i.NUM_TEXTURES=3]="NUM_TEXTURES"})(Hi||(Hi={}));const h4=`
void emit(vec4 color, highp uint pickId) {
  out_color = color;
  float zValue = 1.0 - gl_FragCoord.z;
  out_z = vec4(zValue, zValue, zValue, 1.0);
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`,p4=`
float computeOITWeight(float alpha) {
  float a = min(1.0, alpha) * 8.0 + 0.01;
  float b = -gl_FragCoord.z * 0.95 + 1.0;
  return a * a * a * b * b * b;
}
`,f4=[p4,`
void emit(vec4 color, highp uint pickId) {
  float weight = computeOITWeight(color.a);
  vec4 accum = color * weight;
  v4f_fragData0 = vec4(accum.rgb, color.a);
  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);
}
`];function $f(i){i.addOutputBuffer("vec4","out_color",Hi.COLOR),i.addOutputBuffer("highp vec4","out_z",Hi.Z),i.addOutputBuffer("highp vec4","out_pickId",Hi.PICK),i.addFragmentCode(h4)}function g4(i){i.addOutputBuffer("vec4","v4f_fragData0",0),i.addOutputBuffer("vec4","v4f_fragData1",1),i.addFragmentCode(f4)}const gr=Ne(),H1=eh(),m4=Je();function v4(i){i.addOutputBuffer("vec4","v4f_fragColor",null),i.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

v4f_fragColor = vec4(accum.rgb / accum.a, revealage);
`)}const y4=oh(er);class S4 extends y4{constructor(e){super(),this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new pu(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}}class dy extends aD{constructor(e,t,n){super(e,t,n),this.sliceViews=this.registerDisposer(new xv((s,a,l)=>{s.registerDisposer(l),s.registerDisposer(l.visibility.add(this.visibility))})),this.axesLineHelper=this.registerDisposer(Ch.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(W2.get(this.gl,$f)),this.offscreenFramebuffer=this.registerDisposer(new fo(this.gl,{colorBuffers:[new Xs(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new Xs(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new Xs(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new XO(this.gl)})),this.offscreenCopyHelper=this.registerDisposer(go.get(this.gl)),this.transparencyCopyHelper=this.registerDisposer(go.get(this.gl,v4,2)),this.scaleBars=this.registerDisposer(new oD(this.gl)),this.projectionParameters=this.registerDisposer(new p2({navigationState:this.navigationState,update:(s,a)=>{const l=s.invViewMatrix,d=s.projectionMat,u=s.logicalWidth,h=s.logicalHeight,g=u/h,v=Math.PI/4;let y=a.relativeDepthRange,C=a.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){const w=Math.max(.1,1-y),b=1+y;QE(d,-g,g,-1,1,w,b)}else{const w=1/Math.tan(v/2);y/=w;const b=Math.max(.1,1-y),k=1+y;C*=w,NN(d,v,g,b,k)}XL(s,d),a.pose.toMat4(l,C),RN(l,l,dg(gr,1,-1,-1)),IN(l,l,zn[2]),e2(s)}})),this.projectionParameters.changed.add(()=>this.context.scheduleRedraw());const r=this.sharedObject=this.registerDisposer(new S4(this));if(r.RPC_TYPE_ID=Wz,r.initializeCounterpart(n.rpc,{}),r.visibility.add(this.visibility),this.visibleLayerTracker=VD(this.viewer.layerManager,Uo,this.viewer.visibleLayerRoles,this),ve(t,"rotate-via-mouse-drag",s=>{Rn(s.detail,(a,l,d)=>{this.navigationState.pose.rotateRelative(zn[1],l/4*Math.PI/180),this.navigationState.pose.rotateRelative(zn[0],-d/4*Math.PI/180)})}),ve(t,"rotate-in-plane-via-touchrotate",s=>{const a=s.detail;this.navigationState.pose.rotateRelative(zn[2],a.angle-a.prevAngle)}),ve(t,"rotate-out-of-plane-via-touchtranslate",s=>{const a=s.detail;this.navigationState.pose.rotateRelative(zn[1],a.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative(zn[0],-a.deltaY/4*Math.PI/180)}),n.showSliceViewsCheckbox){let s=this.registerDisposer(new Es(n.showSliceViews));s.element.className="perspective-panel-show-slice-views neuroglancer-noselect";let a=document.createElement("label");a.className="perspective-panel-show-slice-views neuroglancer-noselect",a.appendChild(document.createTextNode("Sections")),a.appendChild(s.element),this.element.appendChild(a)}this.registerDisposer(n.orthographicProjection.changed.add(()=>{this.projectionParameters.update(),this.scheduleRedraw()})),this.registerDisposer(n.showScaleBar.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.scaleBarOptions.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.showSliceViews.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.showAxisLines.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.perspectiveViewBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.wireFrame.changed.add(()=>this.scheduleRedraw())),this.sliceViews.changed.add(()=>this.scheduleRedraw())}get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}translateByViewportPixels(e,t){const n=gr;var r=this.projectionParameters.value;const s=r.viewProjectionMat,a=r.invViewProjectionMat,l=r.logicalWidth,d=r.logicalHeight;this.viewer.navigationState.pose.updateDisplayPosition(u=>{an(n,u,s),n[0]+=-2*e/l,n[1]+=2*t/d,an(u,n,a)})}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(const d of this.sliceViews){var e=ae(d,2);const u=e[0];if((e[1]||this.viewer.showSliceViews.value)&&!u.isReady())return!1}this.ensureBoundsUpdated();var t=this.renderViewport;const n=t.width,r=t.height;if(n===0||r===0)return!0;const s={projectionParameters:this.projectionParameters.value},a=this.visibleLayerTracker.visibleLayers;for(const d of a){var l=ae(d,2);const u=l[0],h=l[1];if(!u.isReady(s,h))return!1}return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;const e=this.offscreenFramebuffer;var t=this.renderViewport;const n=t.width,r=t.height,s=n*r,a=new Float32Array(s*4);try{e.bindSingle(Hi.Z),this.gl.readPixels(0,0,n,r,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,a)}finally{e.framebuffer.unbind()}const l=new Float32Array(s);for(let d=0;d<s;++d)l[d]=a[d*4];return l}issuePickRequest(e,t){const n=this.offscreenFramebuffer;n.readPixelFloat32IntoBuffer(Hi.Z,e-Zt,t-Zt,0,it,it),n.readPixelFloat32IntoBuffer(Hi.PICK,e-Zt,t-Zt,16*it*it,it,it)}completePickRequest(e,t,n,r){const s=this.viewer.mouseState;s.pickedRenderLayer=null,sD(n,0,4,e,t,r.viewportWidth,r.viewportHeight);const a=ku.length;for(let l=0;l<a;++l){const d=ku[l];let u=n[4*d];if(u===0)continue;const h=d%it,g=(d-h)/it;let v=1-u;gr[0]=2*(e+h-Zt)/r.viewportWidth-1,gr[1]=2*(t+g-Zt)/r.viewportHeight-1,gr[2]=2*v-1,an(gr,gr,r.invTransform);let y=s.position,C=s.unsnappedPosition;const w=this.navigationState.position.value,b=w.length;y.length!==b&&(y=s.position=new Float32Array(b)),C.length!==b&&(C=s.unsnappedPosition=new Float32Array(b)),y.set(w),s.coordinateSpace=this.navigationState.coordinateSpace.value;const k=this.navigationState.pose.displayDimensions.value,L=k.displayDimensionIndices;for(let P=0,T=L.length;P<T;++P)y[L[P]]=gr[P];C.set(y);const I=n[4*it*it+4*d];r.pickIDs.setMouseState(s,I),s.displayDimensions=k,s.setActive(!0);return}s.setActive(!1)}translateDataPointByViewportPixels(e,t,n,r){const s=gr;var a=this.projectionParameters.value;const l=a.viewProjectionMat,d=a.invViewProjectionMat,u=a.width,h=a.height;return an(s,t,l),s[0]+=2*n/u,s[1]+=-2*r/h,an(e,s,d)}get transparentConfiguration(){let e=this.transparentConfiguration_;return e===void 0&&(e=this.transparentConfiguration_=this.registerDisposer(new fo(this.gl,{colorBuffers:fu(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;var t=this.renderViewport;const n=t.width,r=t.height,s=this.viewer.showSliceViews.value;for(const R of this.sliceViews){var a=ae(R,2);const M=a[0];(a[1]||s)&&M.updateRendering()}let l=this.gl;this.offscreenFramebuffer.bind(n,r),l.disable(l.SCISSOR_TEST),l.enable(WebGL2RenderingContext.STENCIL_TEST),l.stencilMask(4294967295),l.clearStencil(0),l.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),l.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),l.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);const d=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(d[0],d[1],d[2],0),l.clear(l.DEPTH_BUFFER_BIT),l.clearBufferfv(WebGL2RenderingContext.COLOR,Hi.COLOR,[d[0],d[1],d[2],0]),l.clearBufferfv(WebGL2RenderingContext.COLOR,Hi.Z,fg),l.clearBufferfv(WebGL2RenderingContext.COLOR,Hi.PICK,fg),l.enable(l.DEPTH_TEST);const u=this.projectionParameters.value;let h=Ne();Qa(h,zn[2],this.navigationState.pose.orientation.orientation),nv(h,h,-1);let g=.2,v=1-g;const y={wireFrame:this.viewer.wireFrame.value,projectionParameters:u,lightDirection:h,ambientLighting:g,directionalLighting:v,pickIDs:e.pickIDs,emitter:$f,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1};Qd(e.invTransform,u.invViewProjectionMat);const C=this.visibleLayerTracker.visibleLayers;let w=!1,b=!1;for(const R of C){var k=ae(R,2);const M=k[0],V=k[1];M.isTransparent?w=!0:M.isAnnotation?b=!0:M.draw(y,V)}if(this.drawSliceViews(y),b){l.enable(WebGL2RenderingContext.BLEND),l.depthFunc(WebGL2RenderingContext.LEQUAL),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(const R of C){var L=ae(R,2);const M=L[0],V=L[1];M.isAnnotation&&M.draw(y,V)}l.depthFunc(WebGL2RenderingContext.LESS),l.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),l.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),w){l.depthMask(!1),l.enable(WebGL2RenderingContext.BLEND);const R=this.transparentConfiguration;R.bind(n,r),this.gl.clearColor(0,0,0,1),l.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),y.emitter=g4,l.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),y.emitPickID=!1;for(const M of C){var I=ae(M,2);const V=I[0],B=I[1];V.isTransparent&&V.draw(y,B)}l.disable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bindSingle(Hi.COLOR),l.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.transparencyCopyHelper.draw(R.colorBuffers[0].texture,R.colorBuffers[1].texture),l.depthMask(!0),l.disable(WebGL2RenderingContext.BLEND),l.enable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bind(n,r),l.enable(WebGL2RenderingContext.STENCIL_TEST),l.drawBuffers([l.NONE,l.COLOR_ATTACHMENT1,l.COLOR_ATTACHMENT2]),y.emitter=$f,y.emitPickID=!0,y.emitColor=!1,l.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),l.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),l.stencilMask(2);for(const M of C){var P=ae(M,2);const V=P[0],B=P[1];!V.isTransparent||!V.transparentPickEnabled||V.draw(y,B)}l.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),l.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),l.stencilMask(0);for(const M of C){var T=ae(M,2);const V=T[0],B=T[1];!V.isTransparent||V.transparentPickEnabled||V.draw(y,B)}}if(l.stencilMask(4294967295),l.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){l.drawBuffers([l.COLOR_ATTACHMENT0]),l.disable(WebGL2RenderingContext.DEPTH_TEST),l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);const R=this.scaleBars,M=this.viewer.scaleBarOptions.value;R.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,M),l.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[Hi.COLOR].texture),!0}drawSliceViews(e){let t=this.sliceViewRenderHelper,n=e.lightDirection,r=e.ambientLighting,s=e.directionalLighting,a=e.projectionParameters.viewProjectionMat;const l=this.viewer.showSliceViews.value;for(const h of this.sliceViews){var d=ae(h,2);const g=d[0];if(!d[1]&&!l)continue;var u=g.projectionParameters.value;const v=u.width,y=u.height,C=u.invViewMatrix,w=u.viewportNormalInCanonicalCoordinates;if(v===0||y===0||!g.valid)continue;let b=Math.abs(rv(n,w)),k=r+b*s,L=m4;ZE(L),L[0]=v/2,L[5]=-y/2,ei(L,C,L),ei(L,a,L);const I=H1,P=this.viewer.crossSectionBackgroundColor.value;I[0]=P[0],I[1]=P[1],I[2]=P[2],I[3]=1,t.draw(g.offscreenFramebuffer.colorBuffers[0].texture,L,hc(k,k,k,1),H1,0,0,1,1)}}drawAxisLines(){const e=this.viewer.navigationState.zoomFactor.value,t=this.projectionParameters.value,n=Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4,r=e*n,s=this.gl;s.drawBuffers([s.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(iD(t,r),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}}var Ya;(function(i){i[i.COLOR=0]="COLOR",i[i.PICK=1]="PICK",i[i.NUM_TEXTURES=2]="NUM_TEXTURES"})(Ya||(Ya={}));function b4(i){i.addOutputBuffer("vec4","out_fragColor",0),i.addOutputBuffer("highp vec4","out_pickId",1),i.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`)}function w4(i){i.addOutputBuffer("vec4","out_fragColor",null),i.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
}
`)}const Hs=Ne(),C4=Ne(),x4=eh();class kh extends aD{constructor(e,t,n,r){super(e,t,r),this.sliceView=n,this.axesLineHelper=this.registerDisposer(Ch.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(W2.get(this.gl,w4)),this.colorFactor=hc(1,1,1,1),this.pickIDs=new nD,this.offscreenFramebuffer=this.registerDisposer(new fo(this.gl,{colorBuffers:[new Xs(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new Xs(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]})),this.offscreenCopyHelper=this.registerDisposer(go.get(this.gl)),this.scaleBars=this.registerDisposer(new oD(this.gl)),r.wireFrame.changed.add(()=>this.scheduleRedraw()),ve(t,"rotate-via-mouse-drag",s=>{const a=this.viewer.mouseState;if(a.updateUnconditionally()){const l=Float32Array.from(a.position);Rn(s.detail,(d,u,h)=>{const g=this.navigationState.pose,v=Qa(Hs,zn[0],g.orientation.orientation),y=Qa(C4,zn[1],g.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(y,-u/4*Math.PI/180,l),this.viewer.navigationState.pose.rotateAbsolute(v,-h/4*Math.PI/180,l)})}}),ve(t,"rotate-in-plane-via-touchrotate",s=>{const a=s.detail,l=this.viewer.mouseState;this.handleMouseMove(a.centerX,a.centerY),l.updateUnconditionally()&&this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,a.angle-a.prevAngle,l.position)}),this.registerDisposer(n),this.visibleLayerTracker=VD(this.viewer.layerManager,yo,this.viewer.visibleLayerRoles,this),this.registerDisposer(r.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.visibility.add(this.visibility)),this.registerDisposer(n.viewChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.registerDisposer(r.showAxisLines.changed.add(()=>{this.visible&&this.scheduleRedraw()})),this.registerDisposer(r.showScaleBar.changed.add(()=>{this.visible&&this.context.scheduleRedraw()})),this.registerDisposer(r.scaleBarOptions.changed.add(()=>{this.visible&&this.context.scheduleRedraw()}))}flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}get navigationState(){return this.sliceView.navigationState}translateByViewportPixels(e,t){this.viewer.navigationState.pose.updateDisplayPosition(n=>{dg(n,-e,-t,0),an(n,n,this.sliceView.projectionParameters.value.invViewMatrix)})}translateDataPointByViewportPixels(e,t,n,r){const s=this.sliceView.projectionParameters.value;return an(e,t,s.viewMatrix),dg(e,e[0]+n,e[1]+r,e[2]),an(e,e,s.invViewMatrix),e}isReady(){if(!this.visible)return!1;const e=this.sliceView;if(this.ensureBoundsUpdated(),!e.isReady())return!1;const t={projectionParameters:e.projectionParameters.value,sliceView:e};for(const r of this.visibleLayerTracker.visibleLayers){var n=ae(r,2);const s=n[0],a=n[1];if(!s.isReady(t,a))return!1}return!0}drawWithPicking(e){const t=this.sliceView;if(!t.valid)return!1;t.updateRendering();const n=t.projectionParameters.value,r=n.width,s=n.height,a=n.invViewProjectionMat;Qd(e.invTransform,a);const l=this.gl;this.offscreenFramebuffer.bind(r,s),l.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),l.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);const d=x4,u=this.viewer.crossSectionBackgroundColor.value;d[0]=u[0],d[1]=u[1],d[2]=u[2],d[3]=1,this.offscreenFramebuffer.bindSingle(Ya.COLOR),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,sL,this.colorFactor,d,0,0,1,1);const h=this.visibleLayerTracker.visibleLayers;let g=this.pickIDs;g.clear();const v={wireFrame:this.viewer.wireFrame.value,projectionParameters:n,pickIDs:g,emitter:b4,emitColor:!0,emitPickID:!0,sliceView:t};this.offscreenFramebuffer.bind(r,s),l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(const C of h){var y=ae(C,2);const w=y[0],b=y[1];w.draw(v,b)}if(l.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(Ya.COLOR),this.viewer.showAxisLines.value){const C=Math.min(n.logicalWidth,n.logicalHeight)/4*1.5,w=this.viewer.navigationState.zoomFactor.value;this.axesLineHelper.draw(YN(iD(n,C*w)))}this.viewer.showScaleBar.value&&(l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(n,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),l.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[Ya.COLOR].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){this.offscreenFramebuffer.readPixelFloat32IntoBuffer(Ya.PICK,e-Zt,t-Zt,0,it,it)}completePickRequest(e,t,n,r){const s=this.viewer.mouseState;s.pickedRenderLayer=null,sD(n,0,4,e,t,r.viewportWidth,r.viewportHeight);const a=r.viewportWidth,l=r.viewportHeight,d=ku.length,u=this.navigationState.position.value,h=u.length,g=this.navigationState.pose.displayDimensions.value,v=g.displayRank,y=g.displayDimensionIndices,C=(k,L,I)=>{const P=e+k,T=t+L;Hs[0]=2*P/a-1,Hs[1]=2*T/l-1,Hs[2]=0,an(Hs,Hs,r.invTransform),I.set(u);for(let R=0;R<v;++R)I[y[R]]=Hs[R]};let w=s.unsnappedPosition;w.length!==h&&(w=s.unsnappedPosition=new Float32Array(h)),s.coordinateSpace=this.navigationState.coordinateSpace.value,s.displayDimensions=g,C(0,0,w);const b=(k,L,I)=>{let P=s.position;P.length!==h&&(P=s.position=new Float32Array(h)),C(k-Zt,L-Zt,P),this.pickIDs.setMouseState(s,I),s.setActive(!0)};for(let k=0;k<d;++k){const L=ku[k],I=n[4*k];if(I===0)continue;const P=L%it,T=(L-P)/it;b(P,T,I);return}b(Zt,Zt,0)}zoomByMouse(e){const t=this.navigationState;if(!t.valid)return;var n=this.sliceView.projectionParameters.value;const r=n.width,s=n.height,a=n.invViewMatrix;var l=n.displayDimensionRenderInfo;const d=l.displayDimensionIndices,u=l.displayRank;let h=this.mouseX,g=this.mouseY;h-=r/2,g-=s/2;const v=this.navigationState.position.value;for(let y=0;y<u;++y){const C=d[y],w=a[y]*h+a[4+y]*g;v[C]+=w*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}}/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function cD(i,e){let t="";for(let n=0;n<=e&&(t=i.toFixed(n),parseFloat(t)!==i);++n);return t}const k4=["#f00","#0f0","#00f"],j1=at.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}});function E4(i){if(i<1||i>1024){const e=Fi(i)|0,t=i/2**e;return`${cD(t,1)}p${e}`}return i.toString()}const L4=[i=>i.name,i=>i.scaleFactor],T4=2e3;class D4 extends Y{constructor(e,t,n,r="px"){super(),this.displayDimensionRenderInfo=e,this.zoom=t,this.depthRange=n,this.displayUnit=r,this.element=document.createElement("div"),this.dimensionGridContainer=document.createElement("div"),this.depthGridContainer=document.createElement("div"),this.defaultCheckbox=document.createElement("input"),this.dimensionElements=Ee(Array(3),(w,b)=>{const k=document.createElement("div");k.classList.add("neuroglancer-display-dimensions-widget-dimension"),k.style.display="contents",ve(k,"adjust-via-wheel",M=>{const V=M.detail.deltaY;V!==0&&this.zoomDimension(b,ic(V))});const L=document.createElement("input");L.classList.add("neuroglancer-display-dimensions-widget-name"),L.title="Change display dimensions",L.spellcheck=!1,L.autocomplete="off",L.style.color=k4[b],L.style.gridColumn="1",L.style.gridRow=`${b+1}`,L.addEventListener("focus",()=>{L.select()}),k.appendChild(L);const I=document.createElement("span");I.classList.add("neuroglancer-display-dimensions-widget-scale-factor");const P=document.createElement("input");P.spellcheck=!1,P.title="Change relative scale at which dimension is displayed",P.autocomplete="off",I.style.gridColumn="2",I.style.gridRow=`${b+1}`,P.addEventListener("focus",()=>{P.select()}),I.appendChild(P),k.appendChild(I);const T=document.createElement("span");T.classList.add("neuroglancer-display-dimensions-widget-scale"),T.style.gridColumn="3",T.style.gridRow=`${b+1}`,k.appendChild(T),this.dimensionGridContainer.appendChild(k);const R={name:L,container:k,scaleFactor:P,scale:T,scaleFactorModified:!1};L.addEventListener("input",()=>{_i(L),this.updateNameValidity()}),ve(L,"commit",()=>{this.updateNames()}),L.addEventListener("blur",M=>{const V=M.relatedTarget;this.dimensionElements.some(B=>B.name===V)||this.updateNames()||this.updateView()}),I.addEventListener("click",M=>{M.target!==P&&(P.focus(),M.preventDefault())}),P.addEventListener("input",()=>{_i(P),R.scaleFactorModified=!0}),ve(P,"commit",()=>{this.updateScaleFactors()}),P.addEventListener("blur",()=>{this.updateScaleFactors()||this.updateView()});for(const M of L4)ve(M(R),"move-up",()=>{b!==0&&M(this.dimensionElements[b-1]).focus()}),ve(M(R),"move-down",()=>{b!==2&&M(this.dimensionElements[b+1]).focus()});return R}),this.scheduleUpdateView=dt(()=>this.updateView());const s=this.element,a=this.dimensionGridContainer,l=this.defaultCheckbox,d=document.createElement("label"),u=this.registerCancellable(nt(()=>{s.dataset.active="false"},T4)),h=()=>{s.dataset.active="true",u()};this.registerDisposer(t.changed.add(h)),this.registerDisposer(e.relativeDisplayScales.changed.add(h)),this.registerDisposer(n.changed.add(h)),s.classList.add("neuroglancer-display-dimensions-widget"),s.appendChild(a),a.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),s.addEventListener("pointerleave",()=>{const w=document.activeElement;w instanceof HTMLElement&&s.contains(w)&&w.blur()}),l.type="checkbox",d.appendChild(l),d.appendChild(document.createTextNode("Default")),d.title="Display first 3 dimensions",d.classList.add("neuroglancer-display-dimensions-widget-default"),l.addEventListener("change",()=>{this.updateDefault()}),a.appendChild(d),this.registerDisposer(e),this.registerDisposer(n),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView));const g=this.registerDisposer(new Nn(s,j1));g.allShortcutsAreGlobal=!0,this.registerDisposer(new Br(s,j1)),ve(a,"cancel",()=>{this.updateView();const w=document.activeElement;w instanceof HTMLElement&&s.contains(w)&&w.blur()});const v=this.depthGridContainer;v.classList.add("neuroglancer-depth-range-widget-grid"),s.appendChild(v);const y=document.createElement("label"),C=document.createElement("input");C.type="checkbox",y.classList.add("neuroglancer-depth-range-relative-checkbox-label"),C.classList.add("neuroglancer-depth-range-relative-checkbox"),y.appendChild(C),y.appendChild(document.createTextNode("Zoom-relative")),C.addEventListener("change",()=>{const w=C.checked;let b=this.depthRange.value;w!==b<0&&(w?b=-b/this.zoom.value:b=-b*this.zoom.value,this.depthRange.value=b)}),y.title="Depth range is multiplied by scale",s.appendChild(y),ve(v,"adjust-via-wheel",w=>{const b=w.detail.deltaY;if(b===0)return;const k=this.depthRange.value;this.depthRange.value=k*2**ic(b)}),this.registerDisposer(Pr((w,b,{factors:k})=>{Ke(v);const L=b.displayRank,I=b.globalDimensionNames,P=b.displayDimensionIndices,T=b.displayDimensionUnits,R=b.displayDimensionScales,M=b.canonicalVoxelFactors,V=[],B=()=>{C.checked=this.depthRange.value<0;let U=this.depthRange.value;U<0&&(U*=-this.zoom.value);for(const O of V){const $=O.input;$.value=Qs(U*O.scale,O.unit,{precision:2,elide1:!1}),_i($)}},F=U=>{const O=Jl(U.input.value);if(O===void 0||O.unit!==U.unit)return!1;let $=O.scale/U.scale;return this.depthRange.value<0&&($=-$/this.zoom.value),this.depthRange.value=$,!0};for(let U=0;U<L;++U){const O=P[U],$=I[O],_=T[U],se=k[O];let oe=V.find(Re=>Re.unit===_&&Re.factor===se);if(oe===void 0){const Re=document.createElement("div");Re.title="Visible depth range",Re.style.display="contents",v.appendChild(Re);const le=document.createElement("span");le.textContent="±",Re.appendChild(le);const we=document.createElement("input");we.spellcheck=!1,we.autocomplete="off",we.addEventListener("focus",()=>{we.select()}),ve(we,"commit",()=>{F(oe)}),we.addEventListener("change",()=>{F(oe)||B()}),we.addEventListener("input",()=>{_i(we)}),Re.appendChild(we);const ie=document.createElement("span");ie.classList.add("neuroglancer-depth-range-widget-dimension-names"),Re.appendChild(ie),oe={unit:_,factor:se,dimensionNames:[],input:we,label:ie,scale:R[U]/M[U]},V.push(oe)}oe.dimensionNames.push($)}for(const U of V)U.dimensionNames.length!==L&&(U.label.textContent=U.dimensionNames.join(" "));w.registerDisposer(ve(v,"cancel",()=>{B();const U=document.activeElement;U instanceof HTMLElement&&v.contains(U)&&U.blur()}));const j=w.registerCancellable(dt(B));w.registerDisposer(this.depthRange.changed.add(j)),w.registerDisposer(this.zoom.changed.add(j)),B()},e,this.relativeDisplayScales)),this.updateView()}zoomDimension(e,t){this.updateScaleFactors();const n=this.displayDimensions,r=this.relativeDisplayScales,s=n.value.displayDimensionIndices[e];if(s===-1)return;const a=r.value.factors,l=new Float64Array(a);l[s]*=2**-t,r.setFactors(l)}updateNameValidity(){const e=this.dimensionElements,t=this.displayDimensions.value.displayDimensionIndices,n=e.map(l=>l.name.value),r=vv(n),s=this.displayDimensions.coordinateSpace.value.names,a=n.length;for(let l=0;l<a;++l){let d=r[l];const u=n[l];let h=-1;u.length===0?d=!0:(h=s.indexOf(u),h===-1&&(d=!1));const g=e[l];g.name.dataset.isValid=d.toString(),g.container.dataset.isModified=(h!==t[l]).toString()}}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}updateNames(){const e=this.dimensionElements.map(a=>a.name.value).filter(a=>a.length>0);if(!rh(e))return!1;const t=this.displayDimensionRenderInfo.displayDimensions;if(e.length===0)return t.reset(),!0;const n=new Int32Array(3);n.fill(-1);const r=t.coordinateSpace.value.names,s=e.length;for(let a=0;a<s;++a){const l=r.indexOf(e[a]);if(l===-1)return!1;n[a]=l}return Oe(n,t.value.displayDimensionIndices)||t.setDimensionIndices(s,n),!0}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){const e=this.displayDimensions,t=this.relativeDisplayScales;var n=e.value;const r=n.displayDimensionIndices,s=n.displayRank,a=t.value.factors,l=this.dimensionElements,d=new Float64Array(a);for(let u=0;u<s;++u){const h=l[u];if(!h.scaleFactorModified)continue;const g=Number(h.scaleFactor.value),v=r[u];!gt(g)||g<=0||(d[v]=g)}return Oe(d,a)||t.setFactors(d),!0}updateView(){const e=this.dimensionElements,t=this.displayDimensions.default;var n=this.displayDimensionRenderInfo.value;const r=n.displayDimensionIndices,s=n.canonicalVoxelFactors,a=n.displayDimensionUnits,l=n.displayDimensionScales,d=n.globalDimensionNames,u=this.relativeDisplayScales.value.factors;this.defaultCheckbox.checked=t;const h=this.zoom.value,g=r[0];let v=!0;if(g!==-1){const y=a[0],C=u[g];for(let w=1;w<3;++w){const b=r[w];if(b!==-1&&(a[w]!==y||u[b]!==C)){v=!1;break}}}for(let y=0;y<3;++y){const C=r[y],w=e[y];if(delete w.name.dataset.isValid,w.container.dataset.isModified=(C===-1).toString(),C===-1)w.name.value="",w.scale.textContent="",w.scaleFactor.value="";else{w.name.value=d[C];const b=l[y]*h/s[y];if(y===0||!v){const k=Qs(b,a[y],{precision:2,elide1:!1});w.scale.textContent=`${k}/${this.displayUnit}`}else w.scale.textContent="";w.scaleFactor.value=E4(u[C])}_i(w.name),_i(w.scaleFactor)}}disposed(){kt(this.element),super.disposed()}}const dD=new ce([["xy",void 0],["xz",zN(Pi(),Pi(),Math.PI/2)],["yz",$N(Pi(),Pi(),Math.PI/2)]]),uD="◻",Yg=new ce([["4panel","◱"],["3d",uD]]);function P4(i,e){let t;return e===void 0?t=i.navigationState.addRef():t=new Co(new wo(i.navigationState.pose.position.addRef(),i.navigationState.pose.displayDimensionRenderInfo.addRef(),bo.makeRelative(i.navigationState.pose.orientation,e)),i.navigationState.zoomFactor.addRef(),i.navigationState.depthRange.addRef()),new mu(i.chunkManager,i.layerManager,t,i.wireFrame)}function Wl(i,e){return P4(i,dD.get(e))}function I4(i){return new ce([["xy",Wl(i,"xy")],["xz",Wl(i,"xz")],["yz",Wl(i,"yz")]])}function hD(i){return{crossSectionBackgroundColor:i.crossSectionBackgroundColor,perspectiveViewBackgroundColor:i.perspectiveViewBackgroundColor,selectionDetailsState:i.selectionDetailsState,mouseState:i.mouseState,layerManager:i.layerManager,showAxisLines:i.showAxisLines,wireFrame:i.wireFrame,visibleLayerRoles:i.visibleLayerRoles,selectedLayer:i.selectedLayer,visibility:i.visibility,scaleBarOptions:i.scaleBarOptions}}function uy(i){const e=i.viewer;return H(H({},hD(e)),{navigationState:e.perspectiveNavigationState,inputEventMap:e.inputEventBindings.perspectiveView,orthographicProjection:i.specification.orthographicProjection,showScaleBar:e.showScaleBar,rpc:e.chunkManager.rpc})}function Eu(i){return H(H({},hD(i)),{navigationState:i.navigationState,inputEventMap:i.inputEventBindings.sliceView})}function Lo(i,e){const t=e.navigationState;e.element.appendChild(i.registerDisposer(new D4(t.pose.displayDimensionRenderInfo.addRef(),t.zoomFactor,t.depthRange.addRef(),e instanceof kh?"px":"vh")).element)}function To(i,e,t){const n=document.createElement("div");n.className="neuroglancer-data-panel-layout-controls",i.registerDisposer(()=>kt(n));for(let r=0;r<2;++r){const s=t[Math.min(t.length-1,r)];i.registerDisposer(ve(e.element,r===0?"toggle-layout":"toggle-layout-alternative",a=>{i.container.name=s,a.stopPropagation()}))}for(const r of t){const s=document.createElement("button"),a=document.createElement("div");s.appendChild(a),a.textContent=Yg.get(r),s.title=`Switch to ${r} layout.`,s.addEventListener("click",()=>{i.container.name=r}),n.appendChild(s)}e.element.appendChild(n)}function R4(i,e){const t=new mu(i.chunkManager,i.layerManager,e.navigationState.addRef(),i.wireFrame),n=()=>{const r=e.width.value,s=e.height.value;t.projectionParameters.setViewport({width:r,height:s,logicalWidth:r,logicalHeight:s,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return t.registerDisposer(e.width.changed.add(n)),t.registerDisposer(e.height.changed.add(n)),n(),t}function hy(i,e,t){const n=new ce;(()=>{const r=new $e;for(const a of t.values()){if(r.add(a),n.has(a))continue;const l=R4(i,a);e.sliceViews.set(l,!0),n.set(a,l)}for(const a of n){var s=ae(a,2);const l=s[0],d=s[1];r.has(l)||e.sliceViews.delete(d)}})()}class M4 extends Y{constructor(e,t,n,r){super(),this.container=e,this.rootElement=t,this.viewer=n;let s=I4(n),a=n.display;const l=H(H({},uy(e)),{showSliceViews:n.showPerspectiveSliceViews,showSliceViewsCheckbox:!0}),d=H(H({},Eu(n)),{showScaleBar:n.showScaleBar}),u=H(H({},Eu(n)),{showScaleBar:new _t(!1,!1)}),h=(v,y,C,w)=>{const b=this.registerDisposer(new kh(a,y,s.get(v),C));return w&&Lo(this,b),To(this,b,[v,`${v}-3d`]),b};let g=[rn(1,qs("column",[rn(1,qs("row",[rn(1,v=>{h("xy",v,d,!0)}),rn(1,v=>{h("xz",v,u,!1)})])),rn(1,qs("row",[rn(1,v=>{let y=this.registerDisposer(new dy(a,v,l));for(let C of s.values())y.sliceViews.set(C.addRef(),!1);Lo(this,y),hy(n,y,r),To(this,y,["3d"])}),rn(1,v=>{h("yz",v,u,!1)})]))]))];qs("row",g)(t)}disposed(){Ke(this.rootElement),super.disposed()}}class A4 extends Y{constructor(e,t,n,r,s,a){super(),this.container=e,this.rootElement=t,this.viewer=n,this.direction=r;let l=Wl(n,s),d=n.display;const u=H(H({},uy(e)),{showSliceViews:n.showPerspectiveSliceViews,showSliceViewsCheckbox:!0}),h=H(H({},Eu(n)),{showScaleBar:n.showScaleBar});rn(1,qs(r,[rn(1,g=>{const v=this.registerDisposer(new kh(d,g,l,h));Lo(this,v),To(this,v,[s,"4panel"])}),rn(1,g=>{let v=this.registerDisposer(new dy(d,g,u));v.sliceViews.set(l.addRef(),!1),hy(n,v,a),Lo(this,v),To(this,v,["3d","4panel"])})]))(t)}disposed(){Ke(this.rootElement),super.disposed()}}class N4 extends Y{constructor(e,t,n,r){super(),this.container=e,this.rootElement=t,this.viewer=n;let s=Wl(n,r);const a=H(H({},Eu(n)),{showScaleBar:n.showScaleBar});qs("row",[rn(1,l=>{const d=this.registerDisposer(new kh(n.display,l,s,a));Lo(this,d),To(this,d,["4panel",`${r}-3d`])})])(t)}disposed(){Ke(this.rootElement),super.disposed()}}class V4 extends Y{constructor(e,t,n,r){super(),this.container=e,this.rootElement=t,this.viewer=n;let s=H(H({},uy(e)),{showSliceViews:new _t(!1,!1)});qs("row",[rn(1,a=>{const l=this.registerDisposer(new dy(n.display,a,s));hy(n,l,r),Lo(this,l),To(this,l,["4panel"])})])(t)}disposed(){Ke(this.rootElement),super.disposed()}}const Zg=new ce([["4panel",{factory:(i,e,t,n)=>new M4(i,e,t,n)}],["3d",{factory:(i,e,t,n)=>new V4(i,e,t,n)}]]);for(const i of dD.keys()){Zg.set(i,{factory:(t,n,r)=>new N4(t,n,r,i)});const e=`${i}-3d`;Yg.set(i,uD),Yg.set(e,"◫"),Zg.set(e,{factory:(t,n,r,s)=>new A4(t,n,r,"row",i,s)})}function pD(i){let e=Zg.get(i);if(e===void 0)throw new Error(`Invalid layout name: ${re(i)}.`);return e}function O4(i){return pD(i),i}class B4 extends Y{constructor(e){super(),this.width=new Jt(1e3,ai),this.height=new Jt(1e3,ai),this.changed=new be,this.position=new cT(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new Ug(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new zg(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new Co(new wo(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){ge(e),hi(e,"width",this.width),hi(e,"height",this.height),hi(e,"position",nc(this.position)),hi(e,"orientation",this.orientation),hi(e,"scale",this.scale),hi(e,"zoom",nc(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}}class _4 extends xv{constructor(e){super((t,n)=>t.registerDisposer(t.registerDisposer(n).changed.add(this.changed.dispatch))),this.parentNavigationState=e,this.registerDisposer(e)}restoreState(e){ge(e);for(const t of Qt(e)){const n=new B4(this.parentNavigationState);try{this.set(t,n.addRef()),n.restoreState(e[t])}finally{n.dispose()}}}reset(){this.clear()}toJSON(){if(this.size===0)return;const e={};for(const n of this){var t=ae(n,2);const r=t[0],s=t[1];e[r]=s.toJSON()}return e}}class F4 extends Y{constructor(e,t){super(),this.changed=new be,this.orthographicProjection=new _t(!1),this.type=new Jt(t,O4),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new _4(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),typeof e=="string"?this.type.restoreState(e):(ge(e),K(e,"type",t=>this.type.restoreState(t)),K(e,"orthographicProjection",t=>this.orthographicProjection.restoreState(t)),K(e,"crossSections",t=>t!==void 0&&this.crossSections.restoreState(t)))}toJSON(){const e=this.type,t=this.crossSections,n=this.orthographicProjection.toJSON();return t.size===0&&n===void 0?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:n}}}class U4 extends Y{constructor(e,t){super(),this.viewer=e,this.element=document.createElement("div"),this.specification=this.registerDisposer(new F4(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";const n=this.registerCancellable(nt(()=>this.updateLayout(),0));this.specification.type.changed.add(n),ve(this.element,"toggle-orthographic-projection",()=>this.specification.orthographicProjection.toggle()),this.registerDisposer(this.viewer.display.updateStarted.add(()=>n.flush())),n()}get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){let e=this.layout;e!==void 0&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=pD(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}}const fD=new ce;function da(i,e){fD.set(i,e)}function z4(i){const e=new I_(i.credentialsManager);for(const n of fD){var t=ae(n,2);const r=t[0],s=t[1];e.register(r,s(i))}return e}class ia extends Error{constructor(e,t,n,r){let s=`Fetching ${re(e)} resulted in HTTP error ${t}`;n&&(s+=`: ${n}`),s+=".",super(s),this.name="HttpError",this.message=s,this.url=e,this.status=t,this.statusText=n,r&&(this.response=r)}static fromResponse(e){return new ia(e.url,e.status,e.statusText,e)}static fromRequestError(e,t){if(t instanceof TypeError){let n;return typeof e=="string"?n=e:n=e.url,new ia(n,0,"Network or CORS error")}return t}}async function q1(i,e){let t;try{t=await fetch(i,e)}catch(n){throw ia.fromRequestError(i,n)}if(!t.ok)throw ia.fromResponse(t);return t}function $4(i){return i.arrayBuffer()}function sr(i){return i.json()}async function ys(i,e,t,n=Vt){if(n===Vt){const a=await q1(i,e);return await t(a)}const r=new AbortController,s=n.add(()=>r.abort());try{const a=await q1(i,H(H({},e),{signal:r.signal}));return await t(a)}finally{s()}}function Do(i){const e=/^([^:\/]+):\/\/([^\/]+)((?:\/.*)?)$/;let t=i.match(e);if(t===null)throw new Error(`Invalid URL: ${re(i)}`);return{protocol:t[1],host:t[2],path:t[3]}}function Eh(i){return i instanceof ia?i.status===0||i.status===403||i.status===404:!1}const G4=32,W4=3,H4=500,j4=1e4;function J1(i){return Math.min(2**i*H4,j4/2)*(1+Math.random())}async function py(i,e,t,n,r,s,a=Vt){let l;e:for(let d=0;;){wO(a),d>1&&await new xt(u=>setTimeout(u,J1(d-2))),l=await i.get(l,a);t:for(let u=0;;)try{return await ys(typeof e=="function"?e(l.credentials):e,r(l.credentials,t),n,a)}catch(h){if(h instanceof ia){if(s(h,l.credentials)==="refresh"){if(++d===W4)throw h;continue e}if(++u===G4)throw h;await new xt(g=>setTimeout(g,J1(u-1)));continue t}throw h}}}function Js(i,e,t,n,r=Vt){return i===void 0?ys(e,t,n,r):py(i,e,t,n,(s,a)=>{if(!s.accessToken)return a;const l=new Headers(a.headers);return l.set("Authorization",`${s.tokenType} ${s.accessToken}`),H(H({},a),{headers:l})},(s,a)=>{const l=s.status;if(l===401)return"refresh";if(l===504||l===503)return"retry";if(l===403&&!a.accessToken)return"refresh";throw s},r)}/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/async function q4(i,e,t,n,r){const s=await Js(i,`${e}?prefix=${encodeURIComponent(t)}&delimiter=${encodeURIComponent(n)}`,{},h=>h.text(),r),a=new DOMParser().parseFromString(s,"application/xml"),l=a.evaluate('//*[name()="CommonPrefixes"]/*[name()="Prefix"]',a,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),d=[];for(let h=0,g=l.snapshotLength;h<g;++h)d.push(l.snapshotItem(h).textContent||"");const u=a.evaluate('//*[name()="Contents"]/*[name()="Key"]',a,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let h=0,g=u.snapshotLength;h<g;++h)d.push(u.snapshotItem(h).textContent||"");return d}async function Qg(i,e,t,n,r){if(!n.startsWith("/"))throw null;const s=await q4(i,t,n.substring(1),"/",r);let a=n.lastIndexOf("/");return{offset:a+e.length+1,completions:s.map(l=>({value:l.substring(a)}))}}/**
* @license
* Copyright 2021 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class J4 extends Fc{constructor(e){super(),this.bucket=e,this.get=wh(async()=>{var t;const n=this.bucket,r=await ys(`https://s3.amazonaws.com/${n}?location`,{},a=>a.text()),s=new DOMParser().parseFromString(r,"application/xml").querySelector("LocationConstraint");if(s===null)throw new Error(`Unable to determine location of S3 bucket: ${n}`);return{region:((t=s.textContent)===null||t===void 0?void 0:t.trim())||"us-east-1"}})}}let Od;function gD(i){return Od===void 0&&(Od=new tD,Od.register("s3",e=>new J4(e))),Od.getCredentialsProvider("s3",i)}async function X4(i,e,t,n,r,s=Vt){const a=(await i.get()).credentials.region;return await ys(`https://${e}.s3.${a}.amazonaws.com${t}`,n,r,s)}async function K4(i,e,t){const n=(await gD(i).get()).credentials.region;return await Qg(void 0,`s3://${i}`,`https://${i}.s3.${n}.amazonaws.com`,e,t)}/**
* @license
* Copyright 2020 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function Y4(i,e){return i.getCredentialsProvider("middleauthapp",new URL(e).origin)}function Bd(i,e,t){const n=/^\/([^\/]+)/,r=t.match(n);if(r!==null)return typeof NEUROGLANCER_PYTHON_INTEGRATION<"u"?i.getCredentialsProvider("gcs",{bucket:r[1]}):i.getCredentialsProvider("ngauth_gcs",{authServer:e,bucket:r[1]})}function Uc(i,e){const t=Do(i);switch(t.protocol){case"gs":case"gs+json":case"gs+xml":return{credentialsProvider:typeof NEUROGLANCER_PYTHON_INTEGRATION<"u"?e.getCredentialsProvider("gcs",{bucket:t.host}):void 0,url:i};case"gs+ngauth+http":return{credentialsProvider:Bd(e,`http://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+ngauth+https":return{credentialsProvider:Bd(e,`https://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+xml+ngauth+http":return{credentialsProvider:Bd(e,`http://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"gs+xml+ngauth+https":return{credentialsProvider:Bd(e,`https://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"middleauth+https":return i=i.substr(11),{credentialsProvider:Y4(e,i),url:i};case"s3":return{credentialsProvider:gD(t.host),url:i};default:return{credentialsProvider:void 0,url:i}}}async function $o(i,e,t,n,r=Vt){const s=Do(e);switch(s.protocol){case"gs":return Js(i,`https://www.googleapis.com/storage/v1/b/${s.host}/o/${encodeURIComponent(s.path.substring(1))}?alt=media&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,t,n,r);case"gs+json":return Js(i,`https://storage.googleapis.com/storage/v1/b/${s.host}/o/${encodeURIComponent(s.path.substring(1))}?alt=media`,t,n,r);case"gs+xml":return Js(i,`https://storage.googleapis.com/${s.host}${s.path}`,t,n,r);case"s3":return X4(i,s.host,s.path,t,n,r);default:return Js(i,e,t,n,r)}}const Z4=typeof STATE_SERVERS<"u"&&Qt(STATE_SERVERS).length>0;class Q4 extends Y{constructor(e){if(super(),this.element=document.createElement("div"),this.button=ft({text:"Share",title:"Share State"}),typeof STATE_SERVERS>"u")throw new Error("Cannot construct StateSare without defining STATE_SERVERS");if(Qt(STATE_SERVERS).length>1){const n=document.createElement("select");n.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add(()=>{const r=e.selectedStateServer.value;Jg(STATE_SERVERS).map(s=>s.url).includes(r)&&(n.value=r)})),this.registerEventListener(n,"change",()=>{e.selectedStateServer.value=n.value});for(let r of Tc(STATE_SERVERS)){var t=ae(r,2);let s=t[0],a=t[1];const l=document.createElement("option");l.textContent=s,l.value=a.url,l.selected=!!a.default,n.appendChild(l)}this.element.appendChild(n),this.selectStateServerElement=n}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",()=>{const n=this.selectStateServerElement?this.selectStateServerElement.value:Jg(STATE_SERVERS)[0].url,r=new URL(n).protocol;var s=Uc(n,zo);const a=s.url,l=s.credentialsProvider;Ye.forPromise($o(l,a,{method:"POST",headers:{"Content-Type":"application/json"},body:re(e.state.toJSON())},sr).then(d=>{const u=new URL(d);u.protocol=r;const h=`${window.location.origin}/#!${u}`;navigator.clipboard.writeText(h).then(()=>{Ye.showTemporaryMessage("Share link copied to clipboard")})}).catch(()=>{Ye.showTemporaryMessage("Could not access state server.",4e3)}),{initialMessage:`Posting state to ${n}.`,delay:!0,errorPrefix:""})})}disposed(){this.element.remove(),super.disposed()}}function e$(i){return i.startsWith("key")?i.substring(3):i.startsWith("digit")||i.startsWith("arrow")?i.substring(5):i}function t$(i){return i.split("+").map(e$).join("+")}const i$=H(H({},la),{side:"left",row:1});class n${constructor(){this.location=new Ts(i$)}get changed(){return this.location.changed}toJSON(){return No(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class r$ extends ca{constructor(e,t,n,r,s){super(e,t.location),this.bindings=n,this.toolBinder=s,this.scroll=document.createElement("div"),this.addTitleBar({title:"Help"});const a=document.createElement("div");a.classList.add("neuroglancer-help-body");const l=this.scroll;l.classList.add("neuroglancer-help-scroll-container"),a.appendChild(l),this.addBody(a);const d=this.registerCancellable(dt(()=>this.updateView()));this.registerDisposer(s.changed.add(d)),this.registerDisposer(r.layersChanged.add(d)),this.updateView()}updateView(){const e=this.scroll,t=this.bindings,n=this.toolBinder;Ke(e);const r=new ce;function s(y,C){for(const b of y.parents)b.label!==void 0?a(b.label,b):s(b,C);for(const b of y.bindings.entries()){var w=ae(b,2);const k=w[0],L=w[1],I=k.indexOf(":"),P=k.substring(I+1);C.set(P,L.action)}}function a(y,C){if(r.has(C))return;const w={label:y,entries:new ce};s(C,w.entries),r.set(C,w)}for(const y of t){var l=ae(y,2);const C=l[0],w=l[1];a(C,w)}const d=(y,C)=>{let w=document.createElement("h2");w.textContent=y,e.appendChild(w);for(const k of C){var b=ae(k,2);const L=b[0],I=b[1];let P=document.createElement("div");P.className="dt",P.textContent=t$(L);let T=document.createElement("div");T.className="dd",T.textContent=I,e.appendChild(P),e.appendChild(T)}},u=new ce;for(const y of n.bindings){var h=ae(y,2);const C=h[0],w=h[1];let b=u.get(w.layer);b===void 0&&(b=[],u.set(w.layer,b)),b.push([`shift+key${C.toLowerCase()}`,w.description])}const g=Ee(u.entries());g.length>0&&(g[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),g.sort((y,C)=>y[0].managedLayer.nonArchivedLayerIndex-C[0].managedLayer.nonArchivedLayerIndex));for(const y of g){var v=ae(y,2);const C=v[0],w=v[1];w.sort(),d(`Tool bindings for layer ${C.managedLayer.nonArchivedLayerIndex+1}: ${C.managedLayer.name}`,w)}for(const y of r.values())d(y.label,y.entries)}}function s$(i,e){i.style.display="block";const t=i.offsetWidth,n=i.offsetHeight,r=document.documentElement.clientWidth,s=document.documentElement.clientHeight,a=document.documentElement.scrollLeft+Math.min(r-t,e.clientX),l=document.documentElement.scrollTop+Math.min(s-n,e.clientY);i.style.left=a+"px",i.style.top=l+"px"}class a$ extends Y{constructor(e){super(),this.element=document.createElement("div"),this.parentDisposers=new ce,this.disabledValue=!1,this.opened=new be,this.closed=new be;const t=this.element;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),e!==void 0&&this.registerParent(e)}get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}get open(){return this.menuDisposer!==void 0}registerParent(e){const t=this.parentDisposers;t.has(e)||t.set(e,Tn(e,"contextmenu",n=>{this.show(n),n.stopPropagation(),n.preventDefault()}))}show(e){if(this.disabledValue)return;this.hide();const t=this.element,n=Tn(document,"mousedown",a=>{a.target instanceof Node&&!t.contains(a.target)&&this.hide()},!0),r=Tn(document,"keydown",a=>{a.code==="Escape"&&this.hide()},!0),s=()=>{r(),n(),t.style.display="none"};this.opened.dispatch(),s$(t,e),this.menuDisposer=s}unregisterParent(e){const t=this.parentDisposers,n=t.get(e);n!==void 0&&(n(),t.delete(e))}disposed(){const e=this.parentDisposers;for(const t of e.values())t();e.clear(),kt(this.element)}hide(){this.menuDisposer!==void 0&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}}function o$(i){return QN(new TextEncoder().encode(i))}function l$(i){return new TextDecoder().decode(eV(i))}function c$(i,e){if(i.startsWith(e))try{const t=l$(i.substring(e.length));return JSON.parse(t)}catch{return}}function d$(i,e){return i+o$(re(e))}function u$(i,e){for(const t of i){const n=c$(t,e);if(n!==void 0)return{parameters:n,dragType:t}}}let mD;function fy(i,e){return i.dataTransfer.dropEffect=e,mD=e,e}function em(){return mD}function h$(i){return i.draggable=!0,Tn(i,"dragstart",e=>{e.stopPropagation(),e.preventDefault()})}const vD="neuroglancer-layer\0";let on;function yD(i,e){var t;i.dataTransfer.setData(d$(vD,e.layers.map(s=>({name:s.name,visible:s.visible}))),re({layers:e.layers.map(s=>s.toJSON()),layout:e.layoutSpec})),on!==void 0&&on.disposer();let n,r=()=>{e.manager.unregisterDisposer(r);for(const s of e.layers)s.dispose();e.manager.dispose(),on===n&&(on=void 0)};on=n={manager:e.manager.addRef(),layers:e.layers.map(s=>s.addRef()),layoutSpec:e.layoutSpec,isLayerListPanel:(t=e.isLayerListPanel)!==null&&t!==void 0?t:!1,disposer:r}}function Lh(i="none"){if(on!==void 0){if(i==="move"){const e=new $e(on.layers);on.manager.layerManager.filter(t=>!e.has(t))}on.disposer()}}function Lu(i){return u$(i.dataTransfer.types,vD)}function SD(i){if(on!==void 0&&on.manager.rootLayers===i.rootLayers)return on}class X1{initializeExternalLayers(e){const t=this.dragType;if(t!==void 0)try{var n=JSON.parse(e.dataTransfer.getData(t));const s=n.layers,a=n.layout;if(!Array.isArray(s)||this.numSourceLayers!==s.length)throw new Error("Invalid layer drop data");this.layoutSpec=a;for(const l of this.layers){var r=ae(l,2);const d=r[0],u=r[1];UG(d,s[u])}}catch{return!1}return!0}updateArchiveStates(e){const t=this.targetIsLayerListPanel,n=e.dataTransfer.dropEffect;for(const r of this.layers.keys()){let s=t;t&&!r.archived&&n!=="copy"&&this.sourceIsLayerListPanel&&(s=!1),(r.archived!==s||s&&r.visible)&&(r.archived=s,s&&(r.visible=!1),r.layerChanged.dispatch())}}get method(){return this.sourceManager!==void 0?this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link":"copy"}compatibleWithMethod(e){return this.method===e?!0:this.forceCopy&&e!=="copy"?!1:!this.moveSupported&&e==="move"}}function bD(i,e,t){let n;i.shiftKey?n="copy":i.ctrlKey&&t?n="move":n=e;let r="";const s=a=>{r!==""&&(r+=", "),r+=a};return e!=="none"&&n!==e&&(i.shiftKey?s(`release SHIFT to ${e}`):s(`release CONTROL to ${e}`)),n!=="copy"&&s("hold SHIFT to copy"),n!=="move"&&t&&e!=="move"&&s("hold CONTROL to move"),{dropEffect:n,dropEffectMessage:r}}function wD(i,e,t,n){const r=SD(e);let s=!1,a;return r===void 0?a="copy":n?(r.isLayerListPanel||(s=!0),a="link"):r.manager===e&&r.isLayerListPanel===t?(a="move",s=!0):t?a="none":(r.isLayerListPanel||(s=!0),a="link"),bD(i,a,s)}function p$(i,e,t,n){const r=wD(i,e,t,n);return fy(i,r.dropEffect),r}function tm(i,e,t){const n=t.forceCopy,r=t.newTarget;var s=t.isLayerListPanel;const a=s===void 0?!1:s,l=SD(e);if(!n&&l!==void 0){const u=!r&&l.manager===e&&(l.isLayerListPanel===a||l.isLayerListPanel),h=new X1;return h.manager=e,h.numSourceLayers=l.layers.length,h.sourceManager=l.manager,h.targetIsLayerListPanel=a,h.sourceIsLayerListPanel=l.isLayerListPanel,h.moveSupported=u,h.layers=new ce,h.forceCopy=!1,h.layoutSpec=l.layoutSpec,u?l.layers.forEach((g,v)=>{h.layers.set(g,v)}):l.layers.forEach((g,v)=>{(r||!e.layerManager.has(g))&&h.layers.set(g.addRef(),v)}),h}const d=Lu(i);if(d!==void 0)try{const u=We(d.parameters,(g,v)=>{const y=K(g,"name",Le);let C=K(g,"visible",oo);const w=new vy(y,e);return a&&(C=!1),w.visible=C,w.archived=a,[w,v]}),h=new X1;return h.numSourceLayers=u.length,h.targetIsLayerListPanel=a,h.sourceIsLayerListPanel=!1,h.sourceManager=void 0,h.moveSupported=!1,h.forceCopy=l!==void 0,h.manager=e,h.dragType=d.dragType,h.layers=new ce(u),h}catch{}}function im(i,e){return i.moveSupported?!1:(i.manager.layerManager.filter(t=>!i.layers.has(t)),e!==void 0&&i.layers.has(e))}function Th(i,e,t,n=!1){function r(s,a){let l=i.dropLayers;var d=a?wD(s,i.manager,n,!1):{dropEffect:em(),dropEffectMessage:""};const u=d.dropEffect,h=d.dropEffectMessage;if(u===void 0)return;fy(s,u);let g=!0;if(!(l!==void 0&&!l.compatibleWithMethod(u)&&(i.dropLayers=void 0,im(l,t)))){if(l===void 0){if(l=i.dropLayers=tm(s,i.manager,{forceCopy:u==="copy",newTarget:!1,isLayerListPanel:n}),l===void 0)return;g=l.method==="move"}if(t!==void 0&&l.layers.has(t))return{dropLayers:l,dropEffect:u,dropEffectMessage:h};if(g){const v=i.manager.layerManager,y=new $e;let C=Number.POSITIVE_INFINITY;const w=v.managedLayers=v.managedLayers.filter((k,L)=>l.layers.has(k)?(C===Number.POSITIVE_INFINITY&&(C=L),y.add(k),!1):!0);let b;t!==void 0?(b=w.indexOf(t),C<=b&&++b):b=w.length;for(const k of l.layers.keys())y.has(k)||l.layers.delete(k);w.splice(b,0,...l.layers.keys()),v.layersChanged.dispatch()}else{let v;t!==void 0&&(v=i.manager.layerManager.managedLayers.indexOf(t));for(const y of l.layers.keys())i.manager.add(y,v)}return{dropLayers:l,dropEffect:u,dropEffectMessage:h}}}e.addEventListener("dragenter",s=>{r(s,!0)!==void 0?s.preventDefault():pi(i.element,"drop")}),e.addEventListener("drop",s=>{var a;s.preventDefault(),i.dragEnterCount=0,pi(i.element,"drop");const l=(a=r(s,!1))===null||a===void 0?void 0:a.dropLayers;if(i.dropLayers=void 0,l!==void 0){if(!l.initializeExternalLayers(s)){im(l);return}l.updateArchiveStates(s),Lh(l.method==="move"?void 0:s.dataTransfer.dropEffect)}}),e.addEventListener("dragover",s=>{const a=r(s,!0);if(a===void 0){pi(i.element,"drop");return}const l=a.dropLayers,d=a.dropEffect,u=a.dropEffectMessage,h=l.layers.size;let g="";const v=l.numSourceLayers===1?"":"s",y=l.numSourceLayers;if(d==="none")g=`Cannot link dragged layer${v} here`;else{const C=y===h?`${y}`:`${h}/${y}`;g=`Drop to ${d} ${C} layer${v}`}u&&(g+=` (${u})`),Kn(i.element,"drop",g),s.preventDefault(),s.stopPropagation()})}function CD(i,e,t,n){e.draggable=!0,e.addEventListener("dragstart",r=>{Kn(e,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),yD(r,{manager:i.manager,layers:[t],layoutSpec:n.getLayoutSpec(),isLayerListPanel:n.isLayerListPanel}),r.stopPropagation()}),e.addEventListener("dragend",()=>{pi(e,"drag"),Lh()})}function xD(i){i.element.addEventListener("dragenter",()=>{++i.dragEnterCount}),i.element.addEventListener("dragleave",()=>{if(--i.dragEnterCount!==0)return;pi(i.element,"drop");const e=i.dropLayers;e!==void 0&&(im(e),i.manager.layerManager.layersChanged.dispatch(),i.dropLayers=void 0)})}const f$="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='binIconTitle'%3e%3ctitle%20id='binIconTitle'%3eBin%3c/title%3e%3cpath%20d='M19%206L5%206M14%205L10%205M6%2010L6%2020C6%2020.6666667%206.33333333%2021%207%2021%207.66666667%2021%2011%2021%2017%2021%2017.6666667%2021%2018%2020.6666667%2018%2020%2018%2019.3333333%2018%2016%2018%2010'/%3e%3c/svg%3e";function hs(i={}){const e=ft(H({svg:f$},i)),t=e.firstElementChild;return t&&(t.style.fill="white"),e}var K1={},Y1;function g$(){if(Y1)return K1;Y1=1;var i=Ot(),e=Xm(),t=qu();return i(i.S,"String",{raw:function(n){for(var r=e(n.raw),s=t(r.length),a=arguments.length,l=[],d=0;s>d;)l.push(String(r[d++])),d<a&&l.push(String(arguments[d]));return l.join("")}}),K1}var Z1,Q1;function m$(){return Q1||(Q1=1,g$(),Z1=ut().String.raw),Z1}var ek,tk;function v$(){return tk||(tk=1,ek={default:m$(),__esModule:!0}),ek}var y$=v$();const Vl=Qe(y$),qd="neuroglancer-position",ik=at.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),S$=[i=>i.nameElement,i=>i.coordinate,i=>i.scaleElement];function Jd(i,e){const t=i.coordinateArrays[e];return t===void 0?t:i.units[e]!=""||i.scales[e]!==1?null:t}let b$=class{constructor(i,e){this.coordinateSpace=i,this.container=document.createElement("div"),this.nameContainer=document.createElement("span"),this.nameElement=document.createElement("input"),this.scaleContainer=document.createElement("span"),this.scaleElement=document.createElement("input"),this.coordinate=document.createElement("input"),this.coordinateLabel=document.createElement("span"),this.coordinateLabelWidth=0,this.dropdownOwner=void 0,this.modified=!1,this.draggingPosition=!1,this.hasFocus=!1;const t=this.container,n=this.scaleElement,r=this.scaleContainer,s=this.coordinate,a=this.nameElement,l=this.nameContainer,d=this.coordinateLabel;t.title="",t.classList.add("neuroglancer-position-dimension"),t.draggable=!0,t.tabIndex=-1,t.appendChild(l),t.appendChild(n),l.appendChild(a),l.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",r.appendChild(n),a.classList.add("neuroglancer-position-dimension-name"),a.disabled=!0,a.spellcheck=!1,a.autocomplete="off",a.required=!0,a.placeholder=" ",r.classList.add("neuroglancer-position-dimension-scale-container"),n.classList.add("neuroglancer-position-dimension-scale"),n.disabled=!0,n.spellcheck=!1,n.autocomplete="off",t.appendChild(r),t.appendChild(s),s.type="text",s.classList.add("neuroglancer-position-dimension-coordinate"),s.spellcheck=!1,s.autocomplete="off",s.pattern=Vl`(-?\d+(?:\.(?:\d+)?)?)`;const u=Jd(i,e);if(u!=null){let h=0;for(const g of u.labels)h=Math.max(h,g.length);this.coordinateLabelWidth=h,d.style.width=`${h+2}ch`,t.appendChild(d)}s.required=!0,s.placeholder=" ",d.classList.add("neuroglancer-position-dimension-coordinate-label")}};function nm(i,e,t,n){return Math.floor((i-e)*(n-1)/(t-e))}function w$(i,e,t){const n=i.boundingBoxes,r=i.bounds,s=Math.floor(r.lowerBounds[e]),a=Math.ceil(r.upperBounds[e]-1);if(!gt(s)||!gt(a))return;const l=[],d=h=>nm(h,s,a,t),u=i.rank;for(const h of n){const g=RL(h,e,u);g!==void 0&&(g.lower=d(g.lower),g.upper=d(Math.ceil(g.upper-1)),l.push(g))}return l.sort((h,g)=>{const v=h.lower-g.lower;return v!==0?v:g.upper-g.upper}),$E(l,(h,g)=>{if(g===0)return!0;const v=l[g-1];return v.lower!==h.lower||v.upper!==h.upper}),{lowerBound:s,upperBound:a,normalizedBounds:l}}const rm=10,sm=15,C$=10,Gf=rm+sm+C$;function x$(i,e,t){e.clearRect(0,0,i.width,i.height);const n=t.normalizedBounds;function r(l){e.fillRect(0,l,rm,1)}e.fillStyle="#fff";for(const l of n){const d=l.lower,u=l.upper;r(d),r(u)}const s=n.length;e.fillStyle="#ccc";for(let l=0;l<s;++l){var a=n[l];const d=a.lower,u=a.upper,h=Math.floor(l*sm/s),g=Math.max(1,sm/s);e.fillRect(h+rm,d,g,u+1-d)}}function nk(i,e){_i(i,e.length+1)}function rk(i){const e=i.value;_i(i),i.parentElement.dataset.isEmpty=e===""?"true":"false"}class Dh extends Y{constructor(e,t,{copyButton:n=!0}={}){super(),this.position=e,this.combiner=t,this.element=document.createElement("div"),this.dimensionContainer=document.createElement("div"),this.coordinateSpace=void 0,this.dimensionWidgets=new ce,this.dimensionWidgetList=[],this.dragSource=void 0;const r=this.element,s=this.dimensionContainer;if(this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable(dt(()=>this.updateDimensions())))),r.className="neuroglancer-position-widget",s.style.display="contents",r.appendChild(s),n){const l=Zn({title:"Copy position to clipboard",onClick:()=>{const d=Ji(this.getPositionText());Ye.showTemporaryMessage(d?"Position copied to clipboard":"Failed to copy position to clipboard")}});l.addEventListener("dragstart",d=>{d.dataTransfer.setData(qd,re({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),d.dataTransfer.setData("text",this.getPositionText()),d.stopPropagation()}),l.draggable=!0,r.appendChild(l)}this.registerDisposer(e.changed.add(this.registerCancellable(dt(()=>this.updateView()))));const a=this.registerDisposer(new Nn(r,ik));a.allShortcutsAreGlobal=!0,this.registerDisposer(new Br(r,ik)),this.registerDisposer(ve(r,"cancel",l=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();const d=l.target;d instanceof HTMLElement&&d.blur()})),this.updateView()}openRegularDropdown(e,t){t.classList.add("neuroglancer-position-dimension-dropdown");const n=document.createElement("canvas"),r=n.getContext("2d"),s=document.createElement("div"),a=document.createElement("div");a.appendChild(s);const l=document.createTextNode("");s.appendChild(l);const d=document.createElement("div"),u=document.createElement("div");a.classList.add("neuroglancer-position-dimension-dropdown-lowerbound"),d.classList.add("neuroglancer-position-dimension-dropdown-upperbound"),u.classList.add("neuroglancer-position-dimension-dropdown-hoverposition"),t.appendChild(a),t.appendChild(d),t.appendChild(u),t.appendChild(n);const h=100;n.width=Gf,n.height=h,d.style.marginTop=`${h-1}px`;let g,v,y;const C=()=>{const I=this.dimensionWidgetList.indexOf(e);if(I===-1)return;const P=e.coordinateSpace,T=w$(P,I,h);if(T===void 0||P.bounds.lowerBounds[I]+1===P.bounds.upperBounds[I]){t.style.display="none",e.container.dataset.dropdownVisible=void 0;return}e.container.dataset.dropdownVisible="true",t.style.display="";const R=T.lowerBound,M=T.upperBound;g=R,v=M,l.textContent=R.toString(),d.textContent=M.toString(),x$(n,r,T);const V=this.position.value[I];if(V>=R&&V<=M&&(r.fillStyle="#f66",r.fillRect(0,nm(V,R,M,h),Gf,1)),y!==void 0&&y>=R&&y<=M){r.fillStyle="#66f";const B=nm(y,R,M,h);r.fillRect(0,B,Gf,1),u.textContent=y.toString();const F=s.clientHeight;s.style.visibility=B>F?"":"hidden",d.style.visibility=B<h-F?"":"hidden",u.style.display="",u.style.visibility="visible",u.style.marginTop=`${B}px`}else s.style.visibility="",u.style.display="none",d.style.visibility=""},w=e.dropdownOwner,b=w.registerCancellable(dt(C));w.registerDisposer(this.position.changed.add(b));const k=I=>{if(g===void 0||v===void 0)return;const P=n.getBoundingClientRect();let T=(I.clientY-P.top)/P.height;return T=Math.max(0,T),T=Math.min(1,T),Math.round(T*(v-g))+g},L=I=>{const P=this.dimensionWidgetList.indexOf(e);if(P===-1)return;const T=k(I);if(T===void 0)return;const R=this.position,M=R.value;M[P]=T+.5,e.modified=!1,R.value=M};n.addEventListener("pointermove",I=>{y=k(I),b()}),n.addEventListener("pointerleave",()=>{y=void 0,b()}),n.addEventListener("pointerdown",I=>{I.preventDefault(),I.stopPropagation(),!(I.ctrlKey||I.altKey||I.shiftKey||I.metaKey)&&(Rn(I,P=>{e.dropdownOwner!==void 0&&(y=void 0,L(P),b(),e.draggingPosition=!0)},()=>{e.draggingPosition=!1,this.updateDropdownVisibility(e)}),L(I))}),C()}openCoordinateArrayDropdown(e,t,n){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");const r=n.coordinates,s=n.labels,a=r.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let l=0;l<a;++l){const d=document.createElement("div");d.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");const u=document.createElement("div");u.classList.add("neuroglancer-dimension-dropdown-coordinate");const h=document.createElement("div");h.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),h.textContent=s[l],u.textContent=r[l].toString(),d.appendChild(u),d.appendChild(h),d.addEventListener("click",()=>{const g=this.dimensionWidgetList.indexOf(e);if(g===-1)return;const v=this.position,y=v.value;y[g]=r[l]+.5,e.modified=!1,v.value=y}),t.appendChild(d)}}openDropdown(e){if(e.dropdownOwner!==void 0)return;const t=this.dimensionWidgetList.indexOf(e);if(t===-1)return;this.closeDropdown();const n=e.dropdownOwner=new Y,r=document.createElement("div");r.draggable=!0,r.addEventListener("dragstart",a=>{a.stopPropagation(),a.preventDefault()}),r.addEventListener("pointerenter",()=>{e.hasFocus=!0}),r.tabIndex=-1,e.container.appendChild(r);const s=Jd(e.coordinateSpace,t);s==null?this.openRegularDropdown(e,r):this.openCoordinateArrayDropdown(e,r,s),this.widgetWithOpenDropdown=e,n.registerDisposer(()=>{kt(r),e.dropdownOwner=void 0,delete e.container.dataset.dropdownVisible,this.widgetWithOpenDropdown=void 0}),n.registerEventListener(document,"pointerdown",a=>{const l=a.target;l instanceof Node&&e.container.contains(l)||this.closeDropdown(e)},{capture:!0})}closeDropdown(e=this.widgetWithOpenDropdown){if(e===void 0)return;const t=e.dropdownOwner;t!==void 0&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();const n=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(n===null)break;if(n[1]!==void 0&&document.execCommand("insertText",void 0,n[1]),n[2]!==void 0){const r=this.dimensionWidgetList,s=r.indexOf(e);if(s===-1||s+1===r.length)break;const a=t.substring(n[0].length);e=r[s+1],t=a;continue}break}}reorderDimensionTo(e,t){if(e===t)return;const n=this.position.coordinateSpace;n.value=UL(n.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t){const n=new b$(e,t);n.container.addEventListener("dragstart",r=>{this.dragSource=n,r.stopPropagation(),r.dataTransfer.setData("neuroglancer-dimension","")}),n.container.addEventListener("dragenter",r=>{const s=this.dragSource;if(s===void 0||s===n)return;const a=this.dimensionWidgetList,l=a.indexOf(s),d=a.indexOf(n);l===-1||d===-1||(r.preventDefault(),this.reorderDimensionTo(d,l))}),n.container.addEventListener("dragend",r=>{this.dragSource===n&&(this.dragSource=void 0)}),n.nameContainer.addEventListener("dblclick",()=>{n.nameElement.disabled=!1,n.nameElement.focus(),n.nameElement.select()}),n.scaleContainer.addEventListener("dblclick",()=>{n.scaleElement.disabled=!1,n.scaleElement.focus(),n.scaleElement.select()}),n.coordinate.addEventListener("focus",()=>{n.coordinate.select()}),n.container.addEventListener("focusin",()=>{n.hasFocus=!0,this.updateDropdownVisibility(n)}),n.container.addEventListener("focusout",r=>{const s=r.relatedTarget;s instanceof Node&&n.container.contains(s)||(n.hasFocus=!1,this.updateDropdownVisibility(n))}),n.container.addEventListener("click",r=>{(!(r.target instanceof HTMLInputElement)||r.target.disabled)&&n.coordinate.focus()}),n.coordinate.addEventListener("paste",r=>{const s=n.coordinate,a=s.value,l=r.clipboardData;if(l===null)return;let d=l.getData("text"),u=s.selectionEnd,h=s.selectionStart;if(h!==0||u!==a.length){h==null&&(h=0),u==null&&(u=0);const g=d.match(/[^\-0-9\.]/);g!==null&&(d=d.substring(0,g.index)),d.length>0&&document.execCommand("insertText",void 0,d)}else this.pasteString(n,d);r.preventDefault(),r.stopPropagation()}),n.coordinate.addEventListener("input",()=>{n.modified=!0;const r=n.coordinate,s=r.value;let a=r.selectionDirection,l=r.selectionEnd,d=r.selectionStart;d===null&&(d=0),l===null&&(l=d);let u="";const h=/[^\-0-9\.]/g;u+=s.substring(0,d).replace(h,"");const g=u.length;u+=s.substring(d,l).replace(h,"");const v=u.length;u+=s.substring(l).replace(h,""),r.value=u,r.selectionStart=g,r.selectionEnd=v,r.selectionDirection=a,nk(r,u),l===d&&l===s.length&&s.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(n,1)}),n.nameElement.addEventListener("input",()=>{const r=n.nameElement;_i(r),this.updateNameValidity()}),n.scaleElement.addEventListener("input",()=>{const r=n.scaleElement;rk(r),this.updateScaleValidity(n)}),n.coordinate.addEventListener("blur",r=>{const s=r.relatedTarget;this.dimensionWidgetList.some(a=>a.coordinate===s)||n.modified&&this.updatePosition()}),n.nameElement.addEventListener("blur",r=>{n.nameElement.disabled=!0;const s=r.relatedTarget;this.dimensionWidgetList.some(a=>a.nameElement===s)||this.updateNames()||this.forceUpdateDimensions()}),n.scaleElement.addEventListener("blur",r=>{n.scaleElement.disabled=!0;const s=r.relatedTarget;this.dimensionWidgetList.some(a=>a.scaleElement===s)||this.updateScales()||this.forceUpdateDimensions()}),ve(n.container,"adjust-via-wheel",r=>{const s=r.detail.deltaY;s!==0&&this.adjustDimension(n,ic(s))}),ve(n.container,"adjust-up",()=>{this.adjustDimension(n,-1)}),ve(n.container,"adjust-down",()=>{this.adjustDimension(n,1)});for(const r of S$){const s=r(n);ve(s,"maybe-tab-forward",a=>{this.handleLeftRightMovement(a,n,1,r)}),ve(s,"maybe-tab-backward",a=>{this.handleLeftRightMovement(a,n,-1,r)}),ve(s,"tab-forward",()=>{this.selectAdjacentField(n,1,r)}),ve(s,"tab-backward",()=>{this.selectAdjacentField(n,-1,r)})}return ve(n.coordinate,"commit",()=>{this.updatePosition()}),ve(n.nameElement,"commit",()=>{this.updateNames()}),ve(n.scaleElement,"commit",()=>{this.updateScales()}),ve(n.coordinate,"delete-backward",r=>{r.stopPropagation();const s=n.coordinate;s.selectionStart===s.selectionEnd&&s.selectionStart===0&&(r.preventDefault(),this.selectAdjacentCoordinate(n,-1))}),n}forceUpdateDimensions(){let e=this.position.coordinateSpace.value;e.valid||(e=Ir),this.coordinateSpace=e;const t=this.dimensionWidgets,n=this.dimensionWidgetList;n.length=0;var r=e;const s=r.names,a=r.ids,l=r.scales,d=r.units;Xn(this.dimensionContainer,a.map((h,g)=>{let v=t.get(h);v===void 0?(v=this.newDimension(e,g),t.set(h,v)):v.coordinateSpace=e;const y=s[g];v.nameElement.value=y,delete v.nameElement.dataset.isValid,_i(v.nameElement);const C=Jd(e,g);C===void 0?v.container.dataset.coordinateArray="none":C===null?v.container.dataset.coordinateArray="invalid":v.container.dataset.coordinateArray="valid",v.scaleContainer.title="Drag to reorder, double click to change scale",C===null&&(v.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");var w=LL(l[g],d[g]);const b=w.scale,k=w.prefix,L=w.unit,I=`${b}${k}${L}`;return v.scaleElement.value=I,delete v.scaleElement.dataset.isValid,rk(v.scaleElement),n.push(v),v.container}));for(const h of t){var u=ae(h,2);const g=u[0],v=u[1];v.coordinateSpace!==e&&(this.closeDropdown(v),t.delete(g))}}updateDimensions(){this.position.coordinateSpace.value!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,n){const r=this.dimensionWidgetList;let s=r.indexOf(e);if(s!==-1)for(;;){if(s+=t,s<0||s>=r.length)return!1;const a=r[s],l=n(a);if(l.style.display!=="none")return l.disabled=!1,l.focus(),l.selectionStart=0,l.selectionEnd=l.value.length,l.selectionDirection=t===1?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,n=>n.coordinate)}handleLeftRightMovement(e,t,n,r){e.stopPropagation();const s=r(t);s.selectionStart!==s.selectionEnd||s.selectionStart!==(n===1?s.value.length:0)||this.selectAdjacentField(t,n,r)&&e.preventDefault()}updateNameValidity(){const e=this.dimensionWidgetList,t=e.map(s=>s.nameElement.value),n=t.length,r=this.combiner.getRenameValidity(t);for(let s=0;s<n;++s)e[s].nameElement.dataset.isValid=r[s]===!1?"false":"true"}updateScaleValidity(e){const t=Jl(e.scaleElement.value)!==void 0;e.scaleElement.dataset.isValid=t.toString()}adjustDimension(e,t){const n=this.dimensionWidgetList.indexOf(e);if(n===-1)return;this.updatePosition();const r=this.position;if(!r.valid)return;const s=r.coordinateSpace.value.bounds,a=Float32Array.from(r.value);let l=Math.floor(a[n]+t);if(t>0){const d=s.upperBounds[n];gt(d)&&(l=Math.min(l,Math.ceil(d-1)))}else{const d=s.lowerBounds[n];gt(d)&&(l=Math.max(l,Math.floor(d)))}a[n]=l+.5,this.position.value=a,this.updateView()}updatePosition(){const e=this.dimensionWidgetList,t=this.position,n=t.value;if(n===void 0)return;const r=e.length;for(let s=0;s<r;++s){const a=e[s];a.modified=!1;const l=Number(a.coordinate.value);gt(l)&&(n[s]=l+(Ai(l)?.5:0))}t.value=n}updateNames(){const e=this.dimensionWidgetList,t=this.position.coordinateSpace,n=t.value,r=e.map(d=>d.nameElement.value);if(this.combiner.getRenameValidity(r).includes(!1))return!1;const s=n.names;if(Oe(s,r))return!1;const a=n.timestamps.map((d,u)=>s[u]===r[u]?d:Date.now()),l=H(H({},n),{names:r,timestamps:a});return t.value=l,!0}updateScales(){const e=this.dimensionWidgetList,t=this.position.coordinateSpace,n=t.value,r=e.map(g=>Jl(g.scaleElement.value));if(r.includes(void 0))return!1;const s=Float64Array.from(r,g=>g.scale),a=Ee(r,g=>g.unit),l=n.scales,d=n.units;if(Oe(l,s)&&Oe(d,a))return!1;const u=n.timestamps.map((g,v)=>s[v]===l[v]&&a[v]===d[v]?g:Date.now()),h=st({valid:n.valid,rank:n.rank,scales:s,units:a,timestamps:u,ids:n.ids,names:n.names,boundingBoxes:n.boundingBoxes,coordinateArrays:n.coordinateArrays});return t.value=h,!0}getPositionText(){const e=this.position;return e.valid?e.value.map(t=>Math.floor(t)).join(", "):""}updateView(){this.updateDimensions();const e=this.position.value,t=this.dimensionWidgetList,n=t.length;if(e===void 0)return;const r=this.coordinateSpace;for(let s=0;s<n;++s){const a=t[s],l=a.coordinate,d=Math.floor(e[s]),u=d.toString();nk(l,u),l.value=u;const h=Jd(r,s);let g="";if(h!=null){const y=h.coordinates,C=dN(y,d,(w,b)=>w-b);C!==y.length&&(g=h.labels[C])}const v=a.coordinateLabel;v.textContent=g}}disposed(){this.closeDropdown(),kt(this.element),super.disposed()}}class k$ extends Y{constructor(e,t,n){super(),this.element=e,this.mouseState=t,this.coordinateSpace=n,this.tempPosition=Ne(),e.className="neuroglancer-mouse-position-widget";const r=this.registerCancellable(dt(()=>this.updateView()));this.registerDisposer(t.changed.add(r)),this.registerDisposer(n.changed.add(r))}updateView(){let e="";const t=this.mouseState,n=this.coordinateSpace.value;if(t.active&&n!==void 0){const r=t.position,s=n.rank,a=n.names;for(let l=0;l<s;++l)l!==0&&(e+="  "),e+=`${a[l]} ${Math.floor(r[l])}`}this.element.textContent=e}disposed(){kt(this.element),super.disposed()}}class E$ extends Y{constructor(e,t){var n;super(),this.layer=e,this.panel=t,this.element=document.createElement("div"),this.layerNumberElement=document.createElement("div"),this.labelElement=document.createElement("div"),this.visibleProgress=document.createElement("div"),this.prefetchProgress=document.createElement("div"),this.labelElementText=document.createTextNode(""),this.valueElement=document.createElement("div"),this.maxLength=0,this.prevValueText="";const r=this.element,s=this.labelElement,a=this.layerNumberElement,l=this.valueElement,d=this.visibleProgress,u=this.prefetchProgress,h=this.labelElementText;r.className="neuroglancer-layer-item neuroglancer-noselect",r.appendChild(d),r.appendChild(u),s.className="neuroglancer-layer-item-label",s.appendChild(h),d.className="neuroglancer-layer-item-visible-progress",u.className="neuroglancer-layer-item-prefetch-progress",a.className="neuroglancer-layer-item-number",l.className="neuroglancer-layer-item-value";const g=document.createElement("div");g.className="neuroglancer-layer-item-value-container";const v=document.createElement("div");v.className="neuroglancer-layer-item-button-container";const y=Zv();y.title="Remove layer from this layer group";const C=hU();C.title="Refresh data",this.registerEventListener(C,"click",k=>{k.stopPropagation();const L=this.layer.layer;if(L&&L.dataSources&&L.dataSources[0].loadState){const I=L.dataSources[0].loadState;if(I instanceof Gv){const P=I.dataSource;if(P&&P.subsources[0]&&P.subsources[0].subsource){const T=P.subsources[0].subsource.annotation;T?.invalidateCache&&T.invalidateCache()}}}}),y.addEventListener("click",k=>{this.panel.layerManager===this.panel.manager.rootLayers?this.layer.setArchived(!0):this.layer.containers.size>2?this.panel.layerManager.removeManagedLayer(this.layer):this.layer.setArchived(!0),k.stopPropagation()});const w=hs();w.title="Delete this layer",w.addEventListener("click",k=>{jo(this.layer),k.stopPropagation()}),r.appendChild(a),g.appendChild(l),g.appendChild(v),v.appendChild(y),v.appendChild(w),r.appendChild(s),!((n=e.layer)===null||n===void 0)&&n.allowingRefresh&&r.appendChild(C),r.appendChild(g);const b=this.registerDisposer(new Dh(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1}));r.appendChild(b.element),b.element.addEventListener("click",k=>{k.stopPropagation()}),b.element.addEventListener("dblclick",k=>{k.stopPropagation()}),r.addEventListener("click",k=>{k.ctrlKey?t.selectedLayer.toggle(e):k.altKey?e.pickEnabled=!e.pickEnabled:e.setVisible(!e.visible)}),r.addEventListener("contextmenu",k=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,k.stopPropagation(),k.preventDefault()}),CD(t,r,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),Th(this.panel,r,this.layer)}update(){const e=this.layer,t=this.element;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let n=`Click to ${e.visible?"hide":"show"}, control+click to show side panel`;e.supportsPickOption&&(n+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),n+=", drag to move, shift+drag to copy",t.title=n}disposed(){this.element.remove(),super.disposed()}}class L$ extends Y{constructor(e,t,n,r,s,a){super(),this.display=e,this.manager=t,this.viewerNavigationState=n,this.selectedLayer=r,this.getLayoutSpecForDrag=s,this.showLayerHoverValues=a,this.layerWidgets=new ce,this.element=document.createElement("div"),this.layerUpdateNeeded=!0,this.valueUpdateNeeded=!1,this.layerWidgetInsertionPoint=document.createElement("div"),this.positionWidget=this.registerDisposer(new Dh(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner)),this.dragEnterCount=0,this.scheduleUpdate=this.registerCancellable(dt(()=>this.update())),this.registerDisposer(r);const l=this.element;l.className="neuroglancer-layer-panel",this.registerDisposer(t.layerSelectedValues.changed.add(()=>{this.handleLayerValuesChanged()})),this.registerDisposer(t.layerManager.layersChanged.add(()=>{this.handleLayersChanged()})),this.registerDisposer(r.changed.add(()=>{this.handleLayersChanged()})),this.registerDisposer(a.changed.add(()=>{this.handleLayerItemValueChanged()})),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);let d=ft({svg:wu,title:"Click to add layer, control+click/right click/⌘+click to add local annotation layer."});d.classList.add("neuroglancer-layer-add-button");let u=this.dropZone=document.createElement("div");u.className="neuroglancer-layer-panel-drop-zone";const h=v=>{if(v.ctrlKey||v.metaKey||v.type==="contextmenu"){const y=FD(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(y),this.selectedLayer.layer=y,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(d,"click",h),this.registerEventListener(d,"contextmenu",h),l.appendChild(d),l.appendChild(u),this.registerDisposer(h$(d)),l.appendChild(this.positionWidget.element);const g=()=>{const v=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=v===Tt.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(g)),g(),this.update(),this.updateChunkStatistics(),xD(this),Th(this,u,void 0),this.registerDisposer(e.updateStarted.add(()=>this.updateLayers())),this.registerDisposer(t.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable(dt(()=>this.updateChunkStatistics()))))}get layerManager(){return this.manager.layerManager}disposed(){this.layerWidgets.forEach(e=>e.dispose()),this.layerWidgets=void 0,kt(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){this.valueUpdateNeeded||(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),this.showLayerHoverValues.value===!1)return;let e=this.manager.layerSelectedValues;for(let n of this.layerWidgets){var t=ae(n,2);let r=t[0],s=t[1],a=r.layer,l="";if(a!==null){let d=e.get(a);if(d!==void 0){const u=d.value;u!==void 0&&(l=""+u)}}if(l!==s.prevValueText){if(s.prevValueText=l,l.length>s.maxLength){const d=s.maxLength=l.length;s.valueElement.style.width=`${d}ch`}s.valueElement.textContent=l}}}updateChunkStatistics(){for(const t of this.layerWidgets){var e=ae(t,2);const n=e[0],r=e[1];let s=0,a=0,l=0,d=0;const u=n.layer;if(u!==null)for(const h of u.renderLayers){const g=h.layerChunkProgressInfo;s+=g.numVisibleChunksNeeded,a+=g.numVisibleChunksAvailable,l+=g.numPrefetchChunksNeeded,d+=g.numPrefetchChunksAvailable}r.visibleProgress.style.width=`${a/Math.max(1,s)*100}%`,r.prefetchProgress.style.width=`${d/Math.max(1,l)*100}%`}}updateLayers(){var e;if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;let t=this.element,n=new $e,r=this.layerWidgetInsertionPoint.nextElementSibling;this.manager.rootLayers.updateNonArchivedLayerIndices();for(const l of this.manager.layerManager.managedLayers){if(l.archived&&!(!((e=this.dropLayers)===null||e===void 0)&&e.layers.has(l)))continue;n.add(l);let d=this.layerWidgets.get(l);const u=l.nonArchivedLayerIndex;d===void 0&&(d=new E$(l,this),this.layerWidgets.set(l,d)),d.layerNumberElement.textContent=""+(1+u),d.update();var s=d;let h=s.element;h!==r&&t.insertBefore(d.element,r),r=h.nextElementSibling}for(let l of this.layerWidgets){var a=ae(l,2);let d=a[0],u=a[1];n.has(d)||(this.layerWidgets.delete(d),u.dispose())}}addLayerMenu(){jD(this.manager,this.selectedLayer)}}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function kD(i,e){const t=Tn(i,"drop",a=>{if(a.preventDefault(),a.dataTransfer.types.indexOf(qd)!==-1){a.stopPropagation();const l=ge(JSON.parse(a.dataTransfer.getData(qd))),d=K(l,"dimensions",yv),u=K(l,"position",y=>We(y,vt));if(u.length!==d.length)throw new Error("length mismatch between position and dimensions");const h=u.length,g=e.coordinateSpace.value.names,v=e.value;for(let y=0;y<h;++y){const C=g.indexOf(d[y]);C!==-1&&(v[C]=u[y])}e.changed.dispatch()}}),n=a=>{a.dataTransfer.types.indexOf(qd)!==-1&&(a.dataTransfer.dropEffect="link",a.preventDefault(),a.stopPropagation())},r=Tn(i,"dragenter",n),s=Tn(i,"dragover",n);return()=>{r(),s(),t()}}class ED extends Y{constructor(e){super(),this.model=e,this.element=document.createElement("select"),this.valueIndexMap=new ce;const t=this.element,n=this.valueIndexMap;let r=0;for(const s of Qt(e.enumType))if(isNaN(Number(s))){const a=document.createElement("option");a.textContent=a.value=s.toLowerCase(),t.appendChild(a),n.set(e.enumType[s],r),++r}this.registerDisposer(e.changed.add(()=>this.updateView())),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"wheel",s=>{s.preventDefault(),s.stopPropagation(),this.adjustViaWheel(s)}),this.updateView()}adjustViaWheel(e){const t=this.element;let n=e.deltaY;n>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):n<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){const e=this.element;e.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}}const gy="neuroglancer-layer-group-viewer";function sk(i){return i.dataTransfer.types.indexOf(gy)!==-1}let $n;function T$(i){if($n&&$n.viewer.layerSpecification.rootLayers===i.rootLayers)return $n.viewer}function D$(i,e){const t=T$(e);let n,r=!1;return t===void 0||t.layerSpecification===t.layerSpecification.root?n="copy":(r=!0,n="move"),bD(i,n,r)}class P$ extends Y{constructor(e){super(),this.relativeDisplayScales=new vF(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new SF(e.navigationState.pose.displayDimensions.addRef()),this.position=new cT(e.navigationState.position.addRef()),this.crossSectionOrientation=new Ug(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new uT(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new zg(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new Wx(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new Wx(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new Co(new wo(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new Ug(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new zg(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new Co(new wo(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(const e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",nc(this.position)),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}}function I$(i,e){const t=new a$(i),n=t.element;n.classList.add("neuroglancer-layer-group-viewer-context-menu");const r=document.createElement("button");r.textContent="Remove layer group",n.appendChild(r),t.registerEventListener(r,"click",()=>{e.layerSpecification.layerManager.clear()});const s=e.viewerNavigationState;for(const l of[["Render scale factors",s.relativeDisplayScales.link],["Render dimensions",s.displayDimensions.link],["Position",s.position.link],["Cross-section orientation",s.crossSectionOrientation.link],["Cross-section zoom",s.crossSectionScale.link],["Cross-section depth range",s.crossSectionDepthRange.link],["3-D projection orientation",s.projectionOrientation.link],["3-D projection zoom",s.projectionScale.link],["3-D projection depth range",s.projectionDepthRange.link]]){var a=ae(l,2);const d=a[0],u=a[1],h=t.registerDisposer(new ED(u)),g=document.createElement("label");g.style.display="flex",g.style.flexDirection="row",g.style.whiteSpace="nowrap",g.textContent=d,g.appendChild(h.element),n.appendChild(g)}return t}class Tu extends Y{constructor(e,t,n={}){super(),this.element=e,this.viewerState=t,this.state=new ph,this.options=H({showLayerPanel:new _t(!0),showViewerMenu:!1,showLayerHoverValues:new _t(!0)},n),this.layerSpecification=this.registerDisposer(t.layerSpecification),this.viewerNavigationState=this.registerDisposer(new P$(t)),this.viewerNavigationState.register(this.state),this.layerSpecification instanceof zD?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map(r=>r.name),reset:()=>{throw new Error("not implemented")},restoreState:()=>{throw new Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new xh(e)),this.layout=this.registerDisposer(new U4(this,"xy")),this.state.add("layout",this.layout),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(kD(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable(nt(()=>this.updateUI(),0)))),this.makeUI()}get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}get changed(){return this.state.changed}bindAction(e,t){this.registerDisposer(ve(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",()=>{this.layerPanel&&this.layerPanel.addLayerMenu()}),this.bindAction("t-",()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)}),this.bindAction("t+",()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)})}toJSON(){return H({type:"viewer"},this.state.toJSON())}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),hi(e,"crossSectionZoom",nc(this.viewerNavigationState.crossSectionScale)),hi(e,"perspectiveZoom",nc(this.viewerNavigationState.projectionScale)),hi(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){const e=this.options,t=e.showLayerPanel.value;if(this.layerPanel!==void 0&&!t){this.layerPanel.dispose(),this.layerPanel=void 0;return}if(t&&this.layerPanel===void 0){const n=this.layerPanel=new L$(this.display,this.layerSpecification,this.viewerNavigationState,this.viewerState.selectedLayer.addRef(),()=>this.layout.toJSON(),this.options.showLayerHoverValues);if(e.showViewerMenu?(n.registerDisposer(I$(n.element,this)),n.element.title="Right click for options, drag to move/copy layer group."):n.element.title="Drag to move/copy layer group.",typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS<"u"&&NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS===!0){{const s=document.createElement("button");s.textContent="Clear segments",s.title='De-select all objects ("x")',s.addEventListener("click",a=>{xT(a,a,{action:"clear-segments"})}),n.element.appendChild(s)}for(const s of["3d","xy","xz","yz"]){const a=document.createElement("button");a.textContent=s,a.title=`Switch to ${s} layout`,a.addEventListener("click",()=>{let l;this.layout.name===s?s!=="3d"?l=`${s}-3d`:l="4panel":l=s,this.layout.name=l}),n.element.appendChild(a)}}n.element.draggable=!0;const r=n.element;r.addEventListener("dragstart",s=>{Kn(n.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),yD(s,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});const a=()=>{$n&&$n.viewer===this&&($n=void 0),this.unregisterDisposer(a)};$n={viewer:this,disposer:a},this.registerDisposer(a);const l=this.toJSON();delete l.layers,s.dataTransfer.setData(gy,re(l)),n.element.style.backgroundColor="black",setTimeout(()=>{n.element.style.backgroundColor=""},0)}),n.element.addEventListener("dragend",()=>{pi(r,"drag"),Lh(),$n!==void 0&&$n.viewer===this&&$n.disposer()}),this.element.insertBefore(r,this.element.firstChild)}}disposed(){Ke(this.element);const e=this.layerPanel;e!==void 0&&(e.dispose(),this.layerPanel=void 0),super.disposed()}}const ak=Xi("layoutComponentContainer");class Xd extends Y{constructor(e,t,n){super(),this.viewer=e,this.parent=n,this.changed=new be,this.element=document.createElement("div");const r=this.element;r.style.display="flex",r.style.flex="1",r.style.position="relative",r.style.alignItems="stretch",r[ak]=this,this.setSpecification(t);const s=[],a=d=>{const u=document.createElement("div");u.className="neuroglancer-layout-split-drop-zone";let h;switch(u.style[d]="0",d){case"left":case"right":h="row",u.style.width="10px",u.style.height="100%";break;case"top":case"bottom":h="column",u.style.height="10px",u.style.width="100%";break}u.style.display="none",s.push({element:u,direction:h,orientation:d}),r.appendChild(u),TD(u,this.viewer.layerSpecification,()=>this.split(d).newContainer.component,h==="row"?"column":"row")};a("left"),a("right"),a("top"),a("bottom");let l=!1;r.addEventListener("dragenter",d=>{if(!l&&Lu(d)!==void 0){l=!0;for(const u of s){const h=u.element,g=u.direction,v=u.orientation;if(n!==void 0&&g===n.direction&&((v==="left"||v==="top")&&n.get(0)!==this||(v==="bottom"||v==="right")&&n.get(n.length-1)!==this))continue;const y=this.component;y instanceof om&&y.direction===g||(h.style.display="block")}}},!0),r.addEventListener("drop",d=>{if(l){l=!1;for(const u of s){const h=u.element;h.style.display="none"}}},!0),r.addEventListener("dragleave",d=>{const u=d.relatedTarget;if(l&&!(u instanceof HTMLElement&&this.element.contains(u))){l=!1;for(const h of s){const g=h.element;g.style.display="none"}}},!0)}unsetComponent(){const e=this.componentValue;e!==void 0&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof Tu){const t=e.layerManager,n=e.registerCancellable(nt(()=>{t.managedLayers.length===0&&this.dispose()},0));e.registerDisposer(t.layersChanged.add(()=>{t.managedLayers.length===0&&n()})),n()}else if(e instanceof om){const t=e.registerCancellable(nt(()=>{const n=e.length;if(n===0&&this.parent!==void 0)this.dispose();else if(n===1){const r=e.get(0).component;let s;if(this.parent===void 0&&r instanceof Tu){s=r.layout.specification.toJSON(),r.viewerNavigationState.copyToParent();const a=r.layerManager.managedLayers,l=new $e(a),d=r.layerSpecification;d.rootLayers.filter(g=>l.has(g)||g.archived);const u=[],h=d.rootLayers.managedLayers;for(let g=0,v=h.length;g<v;++g)l.has(h[g])&&u.push(g);for(let g=0,v=a.length;g<v;++g)h[u[g]]=a[g];d.rootLayers.layersChanged.dispatch()}else s=r.toJSON();this.setSpecification(s)}},0));e.registerDisposer(e.changed.add(()=>{e.length<2&&t()})),t()}this.changed.dispatch()}toJSON(){return this.component.toJSON()}setSpecification(e){this.setComponent(R$(this,e))}static getFromElement(e){return e[ak]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){const t={type:"viewer"},n=this.parent;if(n!==void 0){if(e==="left"&&n.direction==="row"||e==="top"&&n.direction==="column")return{newContainer:n.insertChild(t,this),existingContainer:this};if(e==="right"&&n.direction==="row"||e==="bottom"&&n.direction==="column")return{newContainer:n.insertChild(t),existingContainer:this}}let r;const s=this.component;s instanceof am?r=s.layerGroupViewer.toJSON():r=s.toJSON();let a,l;const d=e==="left"||e==="right"?"row":"column";switch(e){case"left":case"top":a={type:d,children:[t,r]},l=0;break;case"right":case"bottom":a={type:d,children:[r,t]},l=1;break}this.setSpecification(a);const u=this.component;return{newContainer:u.get(l),existingContainer:u.get(1-l)}}}function LD(i){return{mouseState:i.mouseState,showAxisLines:i.showAxisLines,wireFrame:i.wireFrame,showScaleBar:i.showScaleBar,scaleBarOptions:i.scaleBarOptions,showPerspectiveSliceViews:i.showPerspectiveSliceViews,inputEventBindings:i.inputEventBindings,visibility:i.visibility,selectedLayer:i.selectedLayer,visibleLayerRoles:i.visibleLayerRoles,navigationState:i.navigationState.addRef(),perspectiveNavigationState:i.perspectiveNavigationState.addRef(),crossSectionBackgroundColor:i.crossSectionBackgroundColor,perspectiveViewBackgroundColor:i.perspectiveViewBackgroundColor}}class am extends Y{constructor(e,t,n){super(),this.element=e,this.layerGroupViewer=this.registerDisposer(new Tu(e,H({display:n.display,layerSpecification:n.layerSpecification.addRef()},LD(n)),{showLayerPanel:n.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:n.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}}function TD(i,e,t,n){i.addEventListener("dragenter",r=>{Lu(r)!==void 0&&i.classList.add("neuroglancer-drag-over")}),i.addEventListener("dragleave",()=>{pi(i,"drop"),i.classList.remove("neuroglancer-drag-over")}),i.addEventListener("dragover",r=>{const s=(a,l)=>{a.dropEffectMessage&&(l+=` (${a.dropEffectMessage})`),Kn(i,"drop",l),r.stopPropagation(),r.preventDefault()};if(sk(r)){const a=D$(r,e);fy(r,a.dropEffect),s(a,`Drop to ${a.dropEffect} layer group as new ${n}`);return}if(Lu(r)!==void 0){const a=p$(r,e,!1,!0);s(a,`Drop to ${a.dropEffect} layer as new ${n}`);return}}),i.addEventListener("drop",r=>{i.classList.remove("neuroglancer-drag-over"),pi(i,"drop");let s,a;if(sk(r)){r.stopPropagation();try{a=JSON.parse(r.dataTransfer.getData(gy))}catch{return}if(s=tm(r,e,{forceCopy:!1,newTarget:!0}),s===void 0)return}else{if(s=tm(r,e,{forceCopy:em()==="copy",newTarget:!0}),s===void 0)return;a=s.layoutSpec}if(!s.initializeExternalLayers(r)){if(!s.moveSupported)for(const u of s.layers.keys())u.dispose();return}r.preventDefault();const l=r.dataTransfer.dropEffect=em();Lh(l);const d=t();s.updateArchiveStates(r);for(const u of s.layers.keys())d.layerSpecification.add(u);try{d.restoreState(a)}catch{d.layout.reset()}})}class om extends Y{constructor(e,t,n,r){super(),this.element=e,this.direction=t,this.container=r,this.changed=new be,e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this));for(const s of n)this.insertChild(s)}get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){const t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",TD(t,this.viewer.layerSpecification,()=>{const n=t.nextElementSibling;let r;return n!==null&&(r=Xd.getFromElement(n)),this.insertChild({type:"viewer",layers:[]},r).component},this.direction==="row"?"column":"row"),e.registerDisposer(()=>{kt(t)}),t}get viewer(){return this.container.viewer}get(e){return Xd.getFromElement(this.element.children[e*2+1])}insertChild(e,t){const n=new Xd(this.viewer,e,this),r=this.makeDropPlaceholder(n);n.element.classList.add("neuroglancer-stack-layout-child"),n.registerDisposer(n.changed.add(this.changed.dispatch)),n.registerDisposer(()=>{this.element.removeChild(n.element),this.changed.dispatch()});const s=t!==void 0?t.element:null;return this.element.insertBefore(n.element,s),this.element.insertBefore(r,s),this.changed.dispatch(),n}disposed(){this.clear(),super.disposed()}clear(){for(;this.length!==0;)this.get(0).dispose()}*[Mi](){const e=this.length;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:Ee(this).map(e=>e.toJSON())}}}function R$(i,e){const t=document.createElement("div");if(t.style.flex="1",t.style.width="0px",typeof e=="string"){if(i.parent!==void 0)throw new Error(`Invalid layout component specification: ${re(e)}`);return new am(t,e,i.viewer)}ge(e);const n=K(e,"type",Le);switch(n){case"row":case"column":return new om(t,n,K(e,"children",r=>{const s=We(r,a=>a);if(i.parent===void 0&&s.length===0)throw new Error("Stack layout requires at least one child.");return s}),i);case"viewer":{const r=i.viewer,s=new zD(r.layerSpecification.addRef()),a=new Tu(t,H({display:r.display,layerSpecification:s},LD(r)),{showLayerPanel:r.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:r.uiControlVisibility.showLayerHoverValues});try{a.restoreState(e)}catch(l){throw a.dispose(),l}return a}default:return new am(t,e,i.viewer)}}class M$ extends Y{constructor(e,t){super(),this.viewer=e,this.defaultSpecification=t,this.container=this.registerDisposer(new Xd(this.viewer,this.defaultSpecification,void 0))}get changed(){return this.container.changed}get element(){return this.container.element}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/let lm=0;const A$=at.fromObject({escape:{action:"close"}});class Ph extends Y{constructor(){super(),this.keyMap=new at,this.keyMap.addParent(A$,Number.NEGATIVE_INFINITY),++lm;let e=this.container=document.createElement("div");e.className="overlay";let t=this.content=document.createElement("div");this.registerDisposer(new xh(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new Nn(this.container,this.keyMap)),this.registerEventListener(e,"action:close",()=>{this.dispose()}),t.focus()}disposed(){--lm,document.body.removeChild(this.container),super.disposed()}}const N$="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20xmlns='http://www.w3.org/2000/svg'%20aria-labelledby='eyeCrossedIconTitle'%3e%3ctitle%20id='eyeCrossedIconTitle'%3eHidden%20(crossed%20eye)%3c/title%3e%3cpath%20d='M22%2012C22%2012%2019%2018%2012%2018C5%2018%202%2012%202%2012C2%2012%205%206%2012%206C19%206%2022%2012%2022%2012Z'/%3e%3ccircle%20cx='12'%20cy='12'%20r='3'/%3e%3cpath%20d='M3%2021L20%204'/%3e%3c/svg%3e",V$="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20xmlns='http://www.w3.org/2000/svg'%20aria-labelledby='eyeIconTitle'%3e%3ctitle%20id='eyeIconTitle'%3eVisible%20(eye)%3c/title%3e%3cpath%20d='M22%2012C22%2012%2019%2018%2012%2018C5%2018%202%2012%202%2012C2%2012%205%206%2012%206C19%206%2022%2012%2022%2012Z'/%3e%3ccircle%20cx='12'%20cy='12'%20r='3'/%3e%3c/svg%3e",O$="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='cursorIconTitle'%3e%3ctitle%20id='cursorIconTitle'%3eCursor%3c/title%3e%3cpolygon%20points='7%2020%207%204%2019%2016%2012%2016%207%2021'/%3e%3c/svg%3e",B$=at.fromObject({escape:{action:"cancel"}});class DD extends Y{constructor(e){super(),this.layer=e,this.element=document.createElement("input");const t=this.element;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off";const n=this.registerDisposer(new Nn(t,B$));n.allShortcutsAreGlobal=!0,ve(t,"cancel",r=>{this.updateView(),t.blur(),r.stopPropagation(),r.preventDefault()}),t.title="Rename layer",this.registerDisposer(e.layerChanged.add(()=>this.updateView())),t.addEventListener("change",()=>this.updateModel()),t.addEventListener("blur",()=>this.updateModel()),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){WD(this.layer,this.element.value)}}class _$ extends Y{constructor(e){super(),this.layer=e,this.element=document.createElement("select"),this.measureElement=document.createElement("div");const t=this.element,n=this.measureElement;t.classList.add("neuroglancer-layer-side-panel-type"),n.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(n);for(const s of Pu){var r=ae(s,2);const a=r[0],l=r[1];if(l.type!==a)continue;const d=document.createElement("option");d.textContent=l.typeAbbreviation,d.value=a,t.appendChild(d)}t.addEventListener("change",()=>{const s=t.value,a=Pu.get(s);by(this.layer.managedLayer,a)}),this.updateView()}updateView(){const e=this.layer.type,t=this.element,n=this.measureElement;n.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${n.offsetWidth}px`}disposed(){this.measureElement.remove()}}class Du extends ca{constructor(e,t){super(e,t.location),this.panelState=t;const n=this.layer=t.layer,r=this.element;var s=this.addTitleBar({});const a=s.titleBar;a.classList.add("neuroglancer-layer-side-panel-title"),a.appendChild(this.registerDisposer(new _$(n)).element),a.appendChild(this.registerDisposer(new DD(n.managedLayer)).element),this.registerDisposer(Lr(u=>{r.dataset.neuroglancerLayerVisible=u.toString()},{get value(){return n.managedLayer.visible},changed:n.managedLayer.layerChanged}));const l=this.registerDisposer(new Gn({get value(){return n.managedLayer.pickEnabled},set value(u){n.managedLayer.pickEnabled=u},changed:n.managedLayer.layerChanged},{svg:O$,enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new en({get value(){return n.managedLayer.supportsPickOption},changed:n.managedLayer.layerChanged},l.element)),a.appendChild(l.element);const d={get value(){return t!==n.panels.panels[0]},set value(u){u?t.pin():t.unpin()},changed:n.manager.root.layerManager.layersChanged};a.appendChild(this.registerDisposer(new Gn(d,{text:"📌︎",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer(Lr(u=>{r.dataset.neuroglancerLayerPanelPinned=u.toString()},d)),a.appendChild(hs({title:"Delete layer",onClick:()=>{jo(this.layer.managedLayer)}})),this.tabView=new bz({makeTab:u=>n.tabs.options.get(u).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new XE({get value(){return t.tabs.map(u=>({id:u,label:n.tabs.options.get(u).label}))},changed:t.tabsChanged})),handleTabElement:(u,h)=>{h.draggable=!0,h.addEventListener("dragstart",g=>{g.stopPropagation(),g.dataTransfer.setData("neuroglancer-side-panel","");let v="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find(y=>y!==t&&y.location.visible)&&(v+=`, or move tab to other ${re(n.managedLayer.name)} panel`),Kn(h,"drag",v),this.sidePanelManager.startDrag({dropAsNewPanel:y=>{this.panelState.splitOffTab(u,H(H({},JT),y))},canDropAsTabs:y=>y instanceof Du&&y.layer===this.layer&&y!==this?1:0,dropAsTab:y=>{this.panelState.moveTabTo(u,y.panelState)}},g)}),h.addEventListener("dragend",g=>{pi(h,"drag"),this.sidePanelManager.endDrag()})}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add(()=>{t.tabs.length===0&&(this.location.visible=!1)}))}makeDragSource(){return H(H({},super.makeDragSource()),{canDropAsTabs:e=>e instanceof Du&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}})}makeTabDropZone(){const e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",t=>{var n;const r=this.sidePanelManager.dragSource,s=(n=r?.canDropAsTabs)===null||n===void 0?void 0:n.call(r,this);s&&(e.classList.add(no),Kn(e,"drop",`Move ${s} ${s===1?"tab":"tabs"} to this panel`),t.preventDefault())}),e.addEventListener("dragleave",()=>{pi(e,"drop"),e.classList.remove(no)}),e.addEventListener("dragover",t=>{var n;const r=this.sidePanelManager.dragSource;!((n=r?.canDropAsTabs)===null||n===void 0)&&n.call(r,this)&&t.preventDefault()}),e.addEventListener("drop",t=>{var n;pi(e,"drop");const r=this.sidePanelManager.dragSource;!((n=r?.canDropAsTabs)===null||n===void 0)&&n.call(r,this)&&(e.classList.remove(no),r.dropAsTab(this),t.preventDefault(),t.stopPropagation())}),e}}class F$ extends Y{constructor(e,t){super(),this.sidePanelManager=e,this.selectedLayerState=t,this.layerSidePanels=new ce,this.generation=0,this.layersNeedUpdate=!0;const n=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(n)),this.registerDisposer(t.layerManager.layersChanged.add(n)),this.registerDisposer(e.beforeRender.add(()=>this.update()))}getSelectedUserLayer(){var e,t;return(t=(e=this.selectedLayerState.layer)===null||e===void 0?void 0:e.layer)!==null&&t!==void 0?t:void 0}update(){var e;if(!this.layersNeedUpdate)return;const t=this.selectedLayerState.layerManager;let n=++this.generation;this.layersNeedUpdate=!1;const r=this.layerSidePanels,s=l=>{let d=r.get(l);d===void 0?(d={generation:n,unregister:this.sidePanelManager.registerPanel({location:l.location,makePanel:()=>new Du(this.sidePanelManager,l)})},r.set(l,d)):d.generation=n};{const l=this.getSelectedUserLayer(),d=this.selectedLayerState.location;if(l===void 0||!d.visible)this.placeholderSelectedLayerPanel===void 0&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:d,makePanel:()=>new ca(this.sidePanelManager,d)}));else{(e=this.placeholderSelectedLayerPanel)===null||e===void 0||e.call(this),this.placeholderSelectedLayerPanel=void 0;const u=l.panels.panels[0];u.location.value=d.value,s(u)}}for(const l of t.managedLayers){const d=l.layer;if(d===null)continue;const u=d.panels.panels;for(let h=1,g=u.length;h<g;++h)s(u[h])}for(const l of r){var a=ae(l,2);const d=a[0],u=a[1];u.generation!==n&&(u.unregister(),r.delete(d))}}disposed(){var e;(e=this.placeholderSelectedLayerPanel)===null||e===void 0||e.call(this);for(const t of this.layerSidePanels.values()){const n=t.unregister;n()}}}const U$=H(H({},la),{side:"left",row:0});class z${constructor(){this.location=new Ts(U$)}get changed(){return this.location.changed}restoreState(e){e!==void 0&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return No(this.location.toJSON())}}class $$ extends Y{constructor(e){super(),this.layer=e,this.element=document.createElement("div");const t=this.element,n=ft({svg:V$,title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),r=ft({svg:N$,title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});t.appendChild(r),t.appendChild(n);const s=()=>{const a=this.layer.visible;n.style.display=a?"":"none",r.style.display=a?"none":""};s(),this.registerDisposer(e.layerChanged.add(s))}}function G$(i){const e=i.manager.root.selectedLayer,t=new Gn({get value(){return e.layer===i&&e.visible},set value(n){n?(e.layer=i,e.visible=!0):e.visible=!1},changed:e.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:QT});return t.element.classList.add("neuroglancer-layer-list-panel-item-controls"),t}class W$ extends Y{constructor(e,t){super(),this.panel=e,this.layer=t,this.element=document.createElement("div"),this.numberElement=document.createElement("div"),this.generation=-1;const n=this.element,r=this.numberElement;n.classList.add("neuroglancer-layer-list-panel-item"),r.classList.add("neuroglancer-layer-list-panel-item-number"),n.appendChild(this.registerDisposer(new Es({get value(){return!t.archived},set value(a){t.setArchived(!a)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),n.appendChild(r),n.appendChild(this.registerDisposer(new $$(t)).element),n.appendChild(this.registerDisposer(new DD(t)).element),n.appendChild(this.registerDisposer(G$(t)).element);const s=hs({title:"Delete layer",onClick:()=>{jo(this.layer)}});s.classList.add("neuroglancer-layer-list-panel-item-delete"),n.appendChild(s),CD(e,n,t,{isLayerListPanel:!0,getLayoutSpec:()=>{}}),Th(e,n,t,!0),n.addEventListener("click",a=>{a.ctrlKey?(e.selectedLayer.toggle(t),a.preventDefault()):a.altKey&&(t.pickEnabled=!t.pickEnabled,a.preventDefault())}),n.addEventListener("contextmenu",a=>{e.selectedLayer.toggle(t),a.stopPropagation(),a.preventDefault()})}}class H$ extends ca{constructor(e,t,n){super(e,n.location),this.manager=t,this.state=n,this.items=new ce,this.itemContainer=document.createElement("div"),this.layerDropZone=document.createElement("div"),this.dragEnterCount=0,this.generation=-1;const r=this.itemContainer,s=this.layerDropZone;var a=this.addTitleBar({title:""});const l=a.titleElement;this.titleElement=l,r.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(r),s.style.flex="1";const d=this.registerCancellable(dt(()=>this.render()));this.visibility.changed.add(d),this.registerDisposer(this.layerManager.layersChanged.add(d)),this.registerDisposer(this.selectedLayer.changed.add(d)),xD(this),Th(this,s,void 0,!0),this.render()}get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}render(){const e=this,t=this.selectedLayer.layer,n=++this.generation;let r=0,s=0,a=0;this.layerManager.updateNonArchivedLayerIndices();function*l(){const u=e.items;let h=0;for(const y of e.layerManager.managedLayers)y.archived||++h;const g=`${(h+1).toString().length}ch`;for(const y of e.layerManager.managedLayers){y.visible?++r:y.archived?++a:++s;let C=u.get(y);C===void 0&&(C=e.registerDisposer(new W$(e,y)),u.set(y,C)),C.generation=n;const w=y.nonArchivedLayerIndex;C.numberElement.style.width=g,w===-1?C.numberElement.style.visibility="hidden":(C.numberElement.style.visibility="",C.numberElement.textContent=`${w+1}`),C.element.dataset.selected=(y===t).toString(),C.element.dataset.archived=y.archived.toString(),yield C.element}for(const y of u){var v=ae(y,2);const C=v[0],w=v[1];n!==w.generation&&(u.delete(C),e.unregisterDisposer(w),w.dispose())}yield e.layerDropZone}Xn(this.itemContainer,l());let d="Layers";if(r||s||a){d+=" (";let u="";r+s&&(d+=`${r}/${s+r} visible`,u=", "),a&&(d+=`${u}${a} archived`),d+=")"}this.titleElement.textContent=d}}class j$ extends Y{constructor(e){super(),this.layerManager=e,this.element=document.createElement("div");const t=this.registerCancellable(dt(()=>this.render()));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0;const t=this.layerManager.managedLayers;for(const r of t)r.archived&&++e;const n=this.element;if(e!==0){const r=t.length;n.textContent=`${r-e}/${r}`}else n.textContent=""}}var q$={exports:{}},cm={exports:{}},J$=cm.exports,ok;function Go(){return ok||(ok=1,(function(i,e){(function(t,n){i.exports=n()})(J$,function(){var t=navigator.userAgent,n=navigator.platform,r=/gecko\/\d/i.test(t),s=/MSIE \d/.test(t),a=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(t),l=/Edge\/(\d+)/.exec(t),d=s||a||l,u=d&&(s?document.documentMode||6:+(l||a)[1]),h=!l&&/WebKit\//.test(t),g=h&&/Qt\/\d+\.\d+/.test(t),v=!l&&/Chrome\/(\d+)/.exec(t),y=v&&+v[1],C=/Opera\//.test(t),w=/Apple Computer/.test(navigator.vendor),b=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(t),k=/PhantomJS/.test(t),L=w&&(/Mobile\/\w+/.test(t)||navigator.maxTouchPoints>2),I=/Android/.test(t),P=L||I||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(t),T=L||/Mac/.test(n),R=/\bCrOS\b/.test(t),M=/win/i.test(n),V=C&&t.match(/Version\/(\d*\.\d*)/);V&&(V=Number(V[1])),V&&V>=15&&(C=!1,h=!0);var B=T&&(g||C&&(V==null||V<12.11)),F=r||d&&u>=9;function j(o){return new RegExp("(^|\\s)"+o+"(?:$|\\s)\\s*")}var U=function(o,c){var f=o.className,p=j(c).exec(f);if(p){var m=f.slice(p.index+p[0].length);o.className=f.slice(0,p.index)+(m?p[1]+m:"")}};function O(o){for(var c=o.childNodes.length;c>0;--c)o.removeChild(o.firstChild);return o}function $(o,c){return O(o).appendChild(c)}function _(o,c,f,p){var m=document.createElement(o);if(f&&(m.className=f),p&&(m.style.cssText=p),typeof c=="string")m.appendChild(document.createTextNode(c));else if(c)for(var S=0;S<c.length;++S)m.appendChild(c[S]);return m}function se(o,c,f,p){var m=_(o,c,f,p);return m.setAttribute("role","presentation"),m}var oe;document.createRange?oe=function(o,c,f,p){var m=document.createRange();return m.setEnd(p||o,f),m.setStart(o,c),m}:oe=function(o,c,f){var p=document.body.createTextRange();try{p.moveToElementText(o.parentNode)}catch{return p}return p.collapse(!0),p.moveEnd("character",f),p.moveStart("character",c),p};function Re(o,c){if(c.nodeType==3&&(c=c.parentNode),o.contains)return o.contains(c);do if(c.nodeType==11&&(c=c.host),c==o)return!0;while(c=c.parentNode)}function le(o){var c=o.ownerDocument||o,f;try{f=o.activeElement}catch{f=c.body||null}for(;f&&f.shadowRoot&&f.shadowRoot.activeElement;)f=f.shadowRoot.activeElement;return f}function we(o,c){var f=o.className;j(c).test(f)||(o.className+=(f?" ":"")+c)}function ie(o,c){for(var f=o.split(" "),p=0;p<f.length;p++)f[p]&&!j(f[p]).test(c)&&(c+=" "+f[p]);return c}var he=function(o){o.select()};L?he=function(o){o.selectionStart=0,o.selectionEnd=o.value.length}:d&&(he=function(o){try{o.select()}catch{}});function Te(o){return o.display.wrapper.ownerDocument}function Fe(o){return Ge(o.display.wrapper)}function Ge(o){return o.getRootNode?o.getRootNode():o.ownerDocument}function Pe(o){return Te(o).defaultView}function ke(o){var c=Array.prototype.slice.call(arguments,1);return function(){return o.apply(null,c)}}function Me(o,c,f){c||(c={});for(var p in o)o.hasOwnProperty(p)&&(f!==!1||!c.hasOwnProperty(p))&&(c[p]=o[p]);return c}function _e(o,c,f,p,m){c==null&&(c=o.search(/[^\s\u00a0]/),c==-1&&(c=o.length));for(var S=p||0,x=m||0;;){var E=o.indexOf("	",S);if(E<0||E>=c)return x+(c-S);x+=E-S,x+=f-x%f,S=E+1}}var Ue=function(){this.id=null,this.f=null,this.time=0,this.handler=ke(this.onTimeout,this)};Ue.prototype.onTimeout=function(o){o.id=0,o.time<=+new Date?o.f():setTimeout(o.handler,o.time-+new Date)},Ue.prototype.set=function(o,c){this.f=c;var f=+new Date+o;(!this.id||f<this.time)&&(clearTimeout(this.id),this.id=setTimeout(this.handler,o),this.time=f)};function Ce(o,c){for(var f=0;f<o.length;++f)if(o[f]==c)return f;return-1}var Xe=50,Ft={toString:function(){return"CodeMirror.Pass"}},Xt={scroll:!1},yi={origin:"*mouse"},Kt={origin:"+move"};function li(o,c,f){for(var p=0,m=0;;){var S=o.indexOf("	",p);S==-1&&(S=o.length);var x=S-p;if(S==o.length||m+x>=c)return p+Math.min(x,c-m);if(m+=S-p,m+=f-m%f,p=S+1,m>=c)return p}}var Si=[""];function pn(o){for(;Si.length<=o;)Si.push(je(Si)+" ");return Si[o]}function je(o){return o[o.length-1]}function Ki(o,c){for(var f=[],p=0;p<o.length;p++)f[p]=c(o[p],p);return f}function Fr(o,c,f){for(var p=0,m=f(c);p<o.length&&f(o[p])<=m;)p++;o.splice(p,0,c)}function Ur(){}function fn(o,c){var f;return Object.create?f=Object.create(o):(Ur.prototype=o,f=new Ur),c&&Me(c,f),f}var Jo=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;function Ps(o){return/\w/.test(o)||o>""&&(o.toUpperCase()!=o.toLowerCase()||Jo.test(o))}function $i(o,c){return c?c.source.indexOf("\\w")>-1&&Ps(o)?!0:c.test(o):Ps(o)}function Gc(o){for(var c in o)if(o.hasOwnProperty(c)&&o[c])return!1;return!0}var ar=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function Rt(o){return o.charCodeAt(0)>=768&&ar.test(o)}function zr(o,c,f){for(;(f<0?c>0:c<o.length)&&Rt(o.charAt(c));)c+=f;return c}function Vn(o,c,f){for(var p=c>f?-1:1;;){if(c==f)return c;var m=(c+f)/2,S=p<0?Math.ceil(m):Math.floor(m);if(S==c)return o(S)?c:f;o(S)?f=S:c=S+p}}function $r(o,c,f,p){if(!o)return p(c,f,"ltr",0);for(var m=!1,S=0;S<o.length;++S){var x=o[S];(x.from<f&&x.to>c||c==f&&x.to==c)&&(p(Math.max(x.from,c),Math.min(x.to,f),x.level==1?"rtl":"ltr",S),m=!0)}m||p(c,f,"ltr")}var Is=null;function Gr(o,c,f){var p;Is=null;for(var m=0;m<o.length;++m){var S=o[m];if(S.from<c&&S.to>c)return m;S.to==c&&(S.from!=S.to&&f=="before"?p=m:Is=m),S.from==c&&(S.from!=S.to&&f!="before"?p=m:Is=m)}return p??Is}var Vh=(function(){var o="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",c="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";function f(A){return A<=247?o.charAt(A):1424<=A&&A<=1524?"R":1536<=A&&A<=1785?c.charAt(A-1536):1774<=A&&A<=2220?"r":8192<=A&&A<=8203?"w":A==8204?"b":"L"}var p=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,m=/[stwN]/,S=/[LRr]/,x=/[Lb1n]/,E=/[1n]/;function D(A,z,W){this.level=A,this.from=z,this.to=W}return function(A,z){var W=z=="ltr"?"L":"R";if(A.length==0||z=="ltr"&&!p.test(A))return!1;for(var X=A.length,J=[],Q=0;Q<X;++Q)J.push(f(A.charCodeAt(Q)));for(var ne=0,ue=W;ne<X;++ne){var pe=J[ne];pe=="m"?J[ne]=ue:ue=pe}for(var Se=0,fe=W;Se<X;++Se){var xe=J[Se];xe=="1"&&fe=="r"?J[Se]="n":S.test(xe)&&(fe=xe,xe=="r"&&(J[Se]="R"))}for(var Be=1,Ae=J[0];Be<X-1;++Be){var He=J[Be];He=="+"&&Ae=="1"&&J[Be+1]=="1"?J[Be]="1":He==","&&Ae==J[Be+1]&&(Ae=="1"||Ae=="n")&&(J[Be]=Ae),Ae=He}for(var ht=0;ht<X;++ht){var Wt=J[ht];if(Wt==",")J[ht]="N";else if(Wt=="%"){var yt=void 0;for(yt=ht+1;yt<X&&J[yt]=="%";++yt);for(var Oi=ht&&J[ht-1]=="!"||yt<X&&J[yt]=="1"?"1":"N",ki=ht;ki<yt;++ki)J[ki]=Oi;ht=yt-1}}for(var Mt=0,Ei=W;Mt<X;++Mt){var Yt=J[Mt];Ei=="L"&&Yt=="1"?J[Mt]="L":S.test(Yt)&&(Ei=Yt)}for(var Bt=0;Bt<X;++Bt)if(m.test(J[Bt])){var At=void 0;for(At=Bt+1;At<X&&m.test(J[At]);++At);for(var Ct=(Bt?J[Bt-1]:W)=="L",Li=(At<X?J[At]:W)=="L",_a=Ct==Li?Ct?"L":"R":W,is=Bt;is<At;++is)J[is]=_a;Bt=At-1}for(var ri=[],Un,Ht=0;Ht<X;)if(x.test(J[Ht])){var Pp=Ht;for(++Ht;Ht<X&&x.test(J[Ht]);++Ht);ri.push(new D(0,Pp,Ht))}else{var fr=Ht,Fs=ri.length,Us=z=="rtl"?1:0;for(++Ht;Ht<X&&J[Ht]!="L";++Ht);for(var di=fr;di<Ht;)if(E.test(J[di])){fr<di&&(ri.splice(Fs,0,new D(1,fr,di)),Fs+=Us);var Fa=di;for(++di;di<Ht&&E.test(J[di]);++di);ri.splice(Fs,0,new D(2,Fa,di)),Fs+=Us,fr=di}else++di;fr<Ht&&ri.splice(Fs,0,new D(1,fr,Ht))}return z=="ltr"&&(ri[0].level==1&&(Un=A.match(/^\s+/))&&(ri[0].from=Un[0].length,ri.unshift(new D(0,0,Un[0].length))),je(ri).level==1&&(Un=A.match(/\s+$/))&&(je(ri).to-=Un[0].length,ri.push(new D(0,X-Un[0].length,X)))),z=="rtl"?ri.reverse():ri}})();function qe(o,c){var f=o.order;return f==null&&(f=o.order=Vh(o.text,c)),f}var Wc=[],Ve=function(o,c,f){if(o.addEventListener)o.addEventListener(c,f,!1);else if(o.attachEvent)o.attachEvent("on"+c,f);else{var p=o._handlers||(o._handlers={});p[c]=(p[c]||Wc).concat(f)}};function or(o,c){return o._handlers&&o._handlers[c]||Wc}function ti(o,c,f){if(o.removeEventListener)o.removeEventListener(c,f,!1);else if(o.detachEvent)o.detachEvent("on"+c,f);else{var p=o._handlers,m=p&&p[c];if(m){var S=Ce(m,f);S>-1&&(p[c]=m.slice(0,S).concat(m.slice(S+1)))}}}function St(o,c){var f=or(o,c);if(f.length)for(var p=Array.prototype.slice.call(arguments,2),m=0;m<f.length;++m)f[m].apply(null,p)}function bt(o,c,f){return typeof c=="string"&&(c={type:c,preventDefault:function(){this.defaultPrevented=!0}}),St(o,f||c.type,o,c),bi(c)||c.codemirrorIgnore}function Yi(o){var c=o._handlers&&o._handlers.cursorActivity;if(c)for(var f=o.curOp.cursorActivityHandlers||(o.curOp.cursorActivityHandlers=[]),p=0;p<c.length;++p)Ce(f,c[p])==-1&&f.push(c[p])}function Ni(o,c){return or(o,c).length>0}function gn(o){o.prototype.on=function(c,f){Ve(this,c,f)},o.prototype.off=function(c,f){ti(this,c,f)}}function ii(o){o.preventDefault?o.preventDefault():o.returnValue=!1}function ha(o){o.stopPropagation?o.stopPropagation():o.cancelBubble=!0}function bi(o){return o.defaultPrevented!=null?o.defaultPrevented:o.returnValue==!1}function Wr(o){ii(o),ha(o)}function Xo(o){return o.target||o.srcElement}function mn(o){var c=o.which;return c==null&&(o.button&1?c=1:o.button&2?c=3:o.button&4&&(c=2)),T&&o.ctrlKey&&c==1&&(c=3),c}var Oh=(function(){if(d&&u<9)return!1;var o=_("div");return"draggable"in o||"dragDrop"in o})(),pa;function Hc(o){if(pa==null){var c=_("span","​");$(o,_("span",[c,document.createTextNode("x")])),o.firstChild.offsetHeight!=0&&(pa=c.offsetWidth<=1&&c.offsetHeight>2&&!(d&&u<8))}var f=pa?_("span","​"):_("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return f.setAttribute("cm-text",""),f}var Ko;function Hr(o){if(Ko!=null)return Ko;var c=$(o,document.createTextNode("AخA")),f=oe(c,0,1).getBoundingClientRect(),p=oe(c,1,2).getBoundingClientRect();return O(o),!f||f.left==f.right?!1:Ko=p.right-f.right<3}var Zi=`

b`.split(/\n/).length!=3?function(o){for(var c=0,f=[],p=o.length;c<=p;){var m=o.indexOf(`
`,c);m==-1&&(m=o.length);var S=o.slice(c,o.charAt(m-1)=="\r"?m-1:m),x=S.indexOf("\r");x!=-1?(f.push(S.slice(0,x)),c+=x+1):(f.push(S),c=m+1)}return f}:function(o){return o.split(/\r\n?|\n/)},jr=window.getSelection?function(o){try{return o.selectionStart!=o.selectionEnd}catch{return!1}}:function(o){var c;try{c=o.ownerDocument.selection.createRange()}catch{}return!c||c.parentElement()!=o?!1:c.compareEndPoints("StartToEnd",c)!=0},jc=(function(){var o=_("div");return"oncopy"in o?!0:(o.setAttribute("oncopy","return;"),typeof o.oncopy=="function")})(),vn=null;function Bh(o){if(vn!=null)return vn;var c=$(o,_("span","x")),f=c.getBoundingClientRect(),p=oe(c,0,1).getBoundingClientRect();return vn=Math.abs(f.left-p.left)>1}var fa={},yn={};function Sn(o,c){arguments.length>2&&(c.dependencies=Array.prototype.slice.call(arguments,2)),fa[o]=c}function ga(o,c){yn[o]=c}function ma(o){if(typeof o=="string"&&yn.hasOwnProperty(o))o=yn[o];else if(o&&typeof o.name=="string"&&yn.hasOwnProperty(o.name)){var c=yn[o.name];typeof c=="string"&&(c={name:c}),o=fn(c,o),o.name=c.name}else{if(typeof o=="string"&&/^[\w\-]+\/[\w\-]+\+xml$/.test(o))return ma("application/xml");if(typeof o=="string"&&/^[\w\-]+\/[\w\-]+\+json$/.test(o))return ma("application/json")}return typeof o=="string"?{name:o}:o||{name:"null"}}function va(o,c){c=ma(c);var f=fa[c.name];if(!f)return va(o,"text/plain");var p=f(o,c);if(qr.hasOwnProperty(c.name)){var m=qr[c.name];for(var S in m)m.hasOwnProperty(S)&&(p.hasOwnProperty(S)&&(p["_"+S]=p[S]),p[S]=m[S])}if(p.name=c.name,c.helperType&&(p.helperType=c.helperType),c.modeProps)for(var x in c.modeProps)p[x]=c.modeProps[x];return p}var qr={};function ya(o,c){var f=qr.hasOwnProperty(o)?qr[o]:qr[o]={};Me(c,f)}function On(o,c){if(c===!0)return c;if(o.copyState)return o.copyState(c);var f={};for(var p in c){var m=c[p];m instanceof Array&&(m=m.concat([])),f[p]=m}return f}function Yo(o,c){for(var f;o.innerMode&&(f=o.innerMode(c),!(!f||f.mode==o));)c=f.state,o=f.mode;return f||{mode:o,state:c}}function Sa(o,c,f){return o.startState?o.startState(c,f):!0}var wt=function(o,c,f){this.pos=this.start=0,this.string=o,this.tabSize=c||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=f};wt.prototype.eol=function(){return this.pos>=this.string.length},wt.prototype.sol=function(){return this.pos==this.lineStart},wt.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},wt.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},wt.prototype.eat=function(o){var c=this.string.charAt(this.pos),f;if(typeof o=="string"?f=c==o:f=c&&(o.test?o.test(c):o(c)),f)return++this.pos,c},wt.prototype.eatWhile=function(o){for(var c=this.pos;this.eat(o););return this.pos>c},wt.prototype.eatSpace=function(){for(var o=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>o},wt.prototype.skipToEnd=function(){this.pos=this.string.length},wt.prototype.skipTo=function(o){var c=this.string.indexOf(o,this.pos);if(c>-1)return this.pos=c,!0},wt.prototype.backUp=function(o){this.pos-=o},wt.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=_e(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?_e(this.string,this.lineStart,this.tabSize):0)},wt.prototype.indentation=function(){return _e(this.string,null,this.tabSize)-(this.lineStart?_e(this.string,this.lineStart,this.tabSize):0)},wt.prototype.match=function(o,c,f){if(typeof o=="string"){var p=function(x){return f?x.toLowerCase():x},m=this.string.substr(this.pos,o.length);if(p(m)==p(o))return c!==!1&&(this.pos+=o.length),!0}else{var S=this.string.slice(this.pos).match(o);return S&&S.index>0?null:(S&&c!==!1&&(this.pos+=S[0].length),S)}},wt.prototype.current=function(){return this.string.slice(this.start,this.pos)},wt.prototype.hideFirstChars=function(o,c){this.lineStart+=o;try{return c()}finally{this.lineStart-=o}},wt.prototype.lookAhead=function(o){var c=this.lineOracle;return c&&c.lookAhead(o)},wt.prototype.baseToken=function(){var o=this.lineOracle;return o&&o.baseToken(this.pos)};function De(o,c){if(c-=o.first,c<0||c>=o.size)throw new Error("There is no line "+(c+o.first)+" in the document.");for(var f=o;!f.lines;)for(var p=0;;++p){var m=f.children[p],S=m.chunkSize();if(c<S){f=m;break}c-=S}return f.lines[c]}function lr(o,c,f){var p=[],m=c.line;return o.iter(c.line,f.line+1,function(S){var x=S.text;m==f.line&&(x=x.slice(0,f.ch)),m==c.line&&(x=x.slice(c.ch)),p.push(x),++m}),p}function Zo(o,c,f){var p=[];return o.iter(c,f,function(m){p.push(m.text)}),p}function Gi(o,c){var f=c-o.height;if(f)for(var p=o;p;p=p.parent)p.height+=f}function N(o){if(o.parent==null)return null;for(var c=o.parent,f=Ce(c.lines,o),p=c.parent;p;c=p,p=p.parent)for(var m=0;p.children[m]!=c;++m)f+=p.children[m].chunkSize();return f+c.first}function G(o,c){var f=o.first;e:do{for(var p=0;p<o.children.length;++p){var m=o.children[p],S=m.height;if(c<S){o=m;continue e}c-=S,f+=m.chunkSize()}return f}while(!o.lines);for(var x=0;x<o.lines.length;++x){var E=o.lines[x],D=E.height;if(c<D)break;c-=D}return f+x}function ee(o,c){return c>=o.first&&c<o.first+o.size}function de(o,c){return String(o.lineNumberFormatter(c+o.firstLineNumber))}function Z(o,c,f){if(f===void 0&&(f=null),!(this instanceof Z))return new Z(o,c,f);this.line=o,this.ch=c,this.sticky=f}function me(o,c){return o.line-c.line||o.ch-c.ch}function et(o,c){return o.sticky==c.sticky&&me(o,c)==0}function Ut(o){return Z(o.line,o.ch)}function wi(o,c){return me(o,c)<0?c:o}function ba(o,c){return me(o,c)<0?o:c}function Jy(o,c){return Math.max(o.first,Math.min(c,o.first+o.size-1))}function ze(o,c){if(c.line<o.first)return Z(o.first,0);var f=o.first+o.size-1;return c.line>f?Z(f,De(o,f).text.length):QI(c,De(o,c.line).text.length)}function QI(o,c){var f=o.ch;return f==null||f>c?Z(o.line,c):f<0?Z(o.line,0):o}function Xy(o,c){for(var f=[],p=0;p<c.length;p++)f[p]=ze(o,c[p]);return f}var qc=function(o,c){this.state=o,this.lookAhead=c},Bn=function(o,c,f,p){this.state=c,this.doc=o,this.line=f,this.maxLookAhead=p||0,this.baseTokens=null,this.baseTokenPos=1};Bn.prototype.lookAhead=function(o){var c=this.doc.getLine(this.line+o);return c!=null&&o>this.maxLookAhead&&(this.maxLookAhead=o),c},Bn.prototype.baseToken=function(o){if(!this.baseTokens)return null;for(;this.baseTokens[this.baseTokenPos]<=o;)this.baseTokenPos+=2;var c=this.baseTokens[this.baseTokenPos+1];return{type:c&&c.replace(/( |^)overlay .*/,""),size:this.baseTokens[this.baseTokenPos]-o}},Bn.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},Bn.fromSaved=function(o,c,f){return c instanceof qc?new Bn(o,On(o.mode,c.state),f,c.lookAhead):new Bn(o,On(o.mode,c),f)},Bn.prototype.save=function(o){var c=o!==!1?On(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new qc(c,this.maxLookAhead):c};function Ky(o,c,f,p){var m=[o.state.modeGen],S={};i0(o,c.text,o.doc.mode,f,function(A,z){return m.push(A,z)},S,p);for(var x=f.state,E=function(A){f.baseTokens=m;var z=o.state.overlays[A],W=1,X=0;f.state=!0,i0(o,c.text,z.mode,f,function(J,Q){for(var ne=W;X<J;){var ue=m[W];ue>J&&m.splice(W,1,J,m[W+1],ue),W+=2,X=Math.min(J,ue)}if(Q)if(z.opaque)m.splice(ne,W-ne,J,"overlay "+Q),W=ne+2;else for(;ne<W;ne+=2){var pe=m[ne+1];m[ne+1]=(pe?pe+" ":"")+"overlay "+Q}},S),f.state=x,f.baseTokens=null,f.baseTokenPos=1},D=0;D<o.state.overlays.length;++D)E(D);return{styles:m,classes:S.bgClass||S.textClass?S:null}}function Yy(o,c,f){if(!c.styles||c.styles[0]!=o.state.modeGen){var p=Qo(o,N(c)),m=c.text.length>o.options.maxHighlightLength&&On(o.doc.mode,p.state),S=Ky(o,c,p);m&&(p.state=m),c.stateAfter=p.save(!m),c.styles=S.styles,S.classes?c.styleClasses=S.classes:c.styleClasses&&(c.styleClasses=null),f===o.doc.highlightFrontier&&(o.doc.modeFrontier=Math.max(o.doc.modeFrontier,++o.doc.highlightFrontier))}return c.styles}function Qo(o,c,f){var p=o.doc,m=o.display;if(!p.mode.startState)return new Bn(p,!0,c);var S=eR(o,c,f),x=S>p.first&&De(p,S-1).stateAfter,E=x?Bn.fromSaved(p,x,S):new Bn(p,Sa(p.mode),S);return p.iter(S,c,function(D){_h(o,D.text,E);var A=E.line;D.stateAfter=A==c-1||A%5==0||A>=m.viewFrom&&A<m.viewTo?E.save():null,E.nextLine()}),f&&(p.modeFrontier=E.line),E}function _h(o,c,f,p){var m=o.doc.mode,S=new wt(c,o.options.tabSize,f);for(S.start=S.pos=p||0,c==""&&Zy(m,f.state);!S.eol();)Fh(m,S,f.state),S.start=S.pos}function Zy(o,c){if(o.blankLine)return o.blankLine(c);if(o.innerMode){var f=Yo(o,c);if(f.mode.blankLine)return f.mode.blankLine(f.state)}}function Fh(o,c,f,p){for(var m=0;m<10;m++){p&&(p[0]=Yo(o,f).mode);var S=o.token(c,f);if(c.pos>c.start)return S}throw new Error("Mode "+o.name+" failed to advance stream.")}var Qy=function(o,c,f){this.start=o.start,this.end=o.pos,this.string=o.current(),this.type=c||null,this.state=f};function e0(o,c,f,p){var m=o.doc,S=m.mode,x;c=ze(m,c);var E=De(m,c.line),D=Qo(o,c.line,f),A=new wt(E.text,o.options.tabSize,D),z;for(p&&(z=[]);(p||A.pos<c.ch)&&!A.eol();)A.start=A.pos,x=Fh(S,A,D.state),p&&z.push(new Qy(A,x,On(m.mode,D.state)));return p?z:new Qy(A,x,D.state)}function t0(o,c){if(o)for(;;){var f=o.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!f)break;o=o.slice(0,f.index)+o.slice(f.index+f[0].length);var p=f[1]?"bgClass":"textClass";c[p]==null?c[p]=f[2]:new RegExp("(?:^|\\s)"+f[2]+"(?:$|\\s)").test(c[p])||(c[p]+=" "+f[2])}return o}function i0(o,c,f,p,m,S,x){var E=f.flattenSpans;E==null&&(E=o.options.flattenSpans);var D=0,A=null,z=new wt(c,o.options.tabSize,p),W,X=o.options.addModeClass&&[null];for(c==""&&t0(Zy(f,p.state),S);!z.eol();){if(z.pos>o.options.maxHighlightLength?(E=!1,x&&_h(o,c,p,z.pos),z.pos=c.length,W=null):W=t0(Fh(f,z,p.state,X),S),X){var J=X[0].name;J&&(W="m-"+(W?J+" "+W:J))}if(!E||A!=W){for(;D<z.start;)D=Math.min(z.start,D+5e3),m(D,A);A=W}z.start=z.pos}for(;D<z.pos;){var Q=Math.min(z.pos,D+5e3);m(Q,A),D=Q}}function eR(o,c,f){for(var p,m,S=o.doc,x=f?-1:c-(o.doc.mode.innerMode?1e3:100),E=c;E>x;--E){if(E<=S.first)return S.first;var D=De(S,E-1),A=D.stateAfter;if(A&&(!f||E+(A instanceof qc?A.lookAhead:0)<=S.modeFrontier))return E;var z=_e(D.text,null,o.options.tabSize);(m==null||p>z)&&(m=E-1,p=z)}return m}function tR(o,c){if(o.modeFrontier=Math.min(o.modeFrontier,c),!(o.highlightFrontier<c-10)){for(var f=o.first,p=c-1;p>f;p--){var m=De(o,p).stateAfter;if(m&&(!(m instanceof qc)||p+m.lookAhead<c)){f=p+1;break}}o.highlightFrontier=Math.min(o.highlightFrontier,f)}}var n0=!1,cr=!1;function iR(){n0=!0}function nR(){cr=!0}function Jc(o,c,f){this.marker=o,this.from=c,this.to=f}function el(o,c){if(o)for(var f=0;f<o.length;++f){var p=o[f];if(p.marker==c)return p}}function rR(o,c){for(var f,p=0;p<o.length;++p)o[p]!=c&&(f||(f=[])).push(o[p]);return f}function sR(o,c,f){var p=f&&window.WeakSet&&(f.markedSpans||(f.markedSpans=new WeakSet));p&&o.markedSpans&&p.has(o.markedSpans)?o.markedSpans.push(c):(o.markedSpans=o.markedSpans?o.markedSpans.concat([c]):[c],p&&p.add(o.markedSpans)),c.marker.attachLine(o)}function aR(o,c,f){var p;if(o)for(var m=0;m<o.length;++m){var S=o[m],x=S.marker,E=S.from==null||(x.inclusiveLeft?S.from<=c:S.from<c);if(E||S.from==c&&x.type=="bookmark"&&(!f||!S.marker.insertLeft)){var D=S.to==null||(x.inclusiveRight?S.to>=c:S.to>c);(p||(p=[])).push(new Jc(x,S.from,D?null:S.to))}}return p}function oR(o,c,f){var p;if(o)for(var m=0;m<o.length;++m){var S=o[m],x=S.marker,E=S.to==null||(x.inclusiveRight?S.to>=c:S.to>c);if(E||S.from==c&&x.type=="bookmark"&&(!f||S.marker.insertLeft)){var D=S.from==null||(x.inclusiveLeft?S.from<=c:S.from<c);(p||(p=[])).push(new Jc(x,D?null:S.from-c,S.to==null?null:S.to-c))}}return p}function Uh(o,c){if(c.full)return null;var f=ee(o,c.from.line)&&De(o,c.from.line).markedSpans,p=ee(o,c.to.line)&&De(o,c.to.line).markedSpans;if(!f&&!p)return null;var m=c.from.ch,S=c.to.ch,x=me(c.from,c.to)==0,E=aR(f,m,x),D=oR(p,S,x),A=c.text.length==1,z=je(c.text).length+(A?m:0);if(E)for(var W=0;W<E.length;++W){var X=E[W];if(X.to==null){var J=el(D,X.marker);J?A&&(X.to=J.to==null?null:J.to+z):X.to=m}}if(D)for(var Q=0;Q<D.length;++Q){var ne=D[Q];if(ne.to!=null&&(ne.to+=z),ne.from==null){var ue=el(E,ne.marker);ue||(ne.from=z,A&&(E||(E=[])).push(ne))}else ne.from+=z,A&&(E||(E=[])).push(ne)}E&&(E=r0(E)),D&&D!=E&&(D=r0(D));var pe=[E];if(!A){var Se=c.text.length-2,fe;if(Se>0&&E)for(var xe=0;xe<E.length;++xe)E[xe].to==null&&(fe||(fe=[])).push(new Jc(E[xe].marker,null,null));for(var Be=0;Be<Se;++Be)pe.push(fe);pe.push(D)}return pe}function r0(o){for(var c=0;c<o.length;++c){var f=o[c];f.from!=null&&f.from==f.to&&f.marker.clearWhenEmpty!==!1&&o.splice(c--,1)}return o.length?o:null}function lR(o,c,f){var p=null;if(o.iter(c.line,f.line+1,function(J){if(J.markedSpans)for(var Q=0;Q<J.markedSpans.length;++Q){var ne=J.markedSpans[Q].marker;ne.readOnly&&(!p||Ce(p,ne)==-1)&&(p||(p=[])).push(ne)}}),!p)return null;for(var m=[{from:c,to:f}],S=0;S<p.length;++S)for(var x=p[S],E=x.find(0),D=0;D<m.length;++D){var A=m[D];if(!(me(A.to,E.from)<0||me(A.from,E.to)>0)){var z=[D,1],W=me(A.from,E.from),X=me(A.to,E.to);(W<0||!x.inclusiveLeft&&!W)&&z.push({from:A.from,to:E.from}),(X>0||!x.inclusiveRight&&!X)&&z.push({from:E.to,to:A.to}),m.splice.apply(m,z),D+=z.length-3}}return m}function s0(o){var c=o.markedSpans;if(c){for(var f=0;f<c.length;++f)c[f].marker.detachLine(o);o.markedSpans=null}}function a0(o,c){if(c){for(var f=0;f<c.length;++f)c[f].marker.attachLine(o);o.markedSpans=c}}function Xc(o){return o.inclusiveLeft?-1:0}function Kc(o){return o.inclusiveRight?1:0}function zh(o,c){var f=o.lines.length-c.lines.length;if(f!=0)return f;var p=o.find(),m=c.find(),S=me(p.from,m.from)||Xc(o)-Xc(c);if(S)return-S;var x=me(p.to,m.to)||Kc(o)-Kc(c);return x||c.id-o.id}function o0(o,c){var f=cr&&o.markedSpans,p;if(f)for(var m=void 0,S=0;S<f.length;++S)m=f[S],m.marker.collapsed&&(c?m.from:m.to)==null&&(!p||zh(p,m.marker)<0)&&(p=m.marker);return p}function l0(o){return o0(o,!0)}function Yc(o){return o0(o,!1)}function cR(o,c){var f=cr&&o.markedSpans,p;if(f)for(var m=0;m<f.length;++m){var S=f[m];S.marker.collapsed&&(S.from==null||S.from<c)&&(S.to==null||S.to>c)&&(!p||zh(p,S.marker)<0)&&(p=S.marker)}return p}function c0(o,c,f,p,m){var S=De(o,c),x=cr&&S.markedSpans;if(x)for(var E=0;E<x.length;++E){var D=x[E];if(D.marker.collapsed){var A=D.marker.find(0),z=me(A.from,f)||Xc(D.marker)-Xc(m),W=me(A.to,p)||Kc(D.marker)-Kc(m);if(!(z>=0&&W<=0||z<=0&&W>=0)&&(z<=0&&(D.marker.inclusiveRight&&m.inclusiveLeft?me(A.to,f)>=0:me(A.to,f)>0)||z>=0&&(D.marker.inclusiveRight&&m.inclusiveLeft?me(A.from,p)<=0:me(A.from,p)<0)))return!0}}}function bn(o){for(var c;c=l0(o);)o=c.find(-1,!0).line;return o}function dR(o){for(var c;c=Yc(o);)o=c.find(1,!0).line;return o}function uR(o){for(var c,f;c=Yc(o);)o=c.find(1,!0).line,(f||(f=[])).push(o);return f}function $h(o,c){var f=De(o,c),p=bn(f);return f==p?c:N(p)}function d0(o,c){if(c>o.lastLine())return c;var f=De(o,c),p;if(!Jr(o,f))return c;for(;p=Yc(f);)f=p.find(1,!0).line;return N(f)+1}function Jr(o,c){var f=cr&&c.markedSpans;if(f){for(var p=void 0,m=0;m<f.length;++m)if(p=f[m],!!p.marker.collapsed&&(p.from==null||!p.marker.widgetNode&&p.from==0&&p.marker.inclusiveLeft&&Gh(o,c,p)))return!0}}function Gh(o,c,f){if(f.to==null){var p=f.marker.find(1,!0);return Gh(o,p.line,el(p.line.markedSpans,f.marker))}if(f.marker.inclusiveRight&&f.to==c.text.length)return!0;for(var m=void 0,S=0;S<c.markedSpans.length;++S)if(m=c.markedSpans[S],m.marker.collapsed&&!m.marker.widgetNode&&m.from==f.to&&(m.to==null||m.to!=f.from)&&(m.marker.inclusiveLeft||f.marker.inclusiveRight)&&Gh(o,c,m))return!0}function dr(o){o=bn(o);for(var c=0,f=o.parent,p=0;p<f.lines.length;++p){var m=f.lines[p];if(m==o)break;c+=m.height}for(var S=f.parent;S;f=S,S=f.parent)for(var x=0;x<S.children.length;++x){var E=S.children[x];if(E==f)break;c+=E.height}return c}function Zc(o){if(o.height==0)return 0;for(var c=o.text.length,f,p=o;f=l0(p);){var m=f.find(0,!0);p=m.from.line,c+=m.from.ch-m.to.ch}for(p=o;f=Yc(p);){var S=f.find(0,!0);c-=p.text.length-S.from.ch,p=S.to.line,c+=p.text.length-S.to.ch}return c}function Wh(o){var c=o.display,f=o.doc;c.maxLine=De(f,f.first),c.maxLineLength=Zc(c.maxLine),c.maxLineChanged=!0,f.iter(function(p){var m=Zc(p);m>c.maxLineLength&&(c.maxLineLength=m,c.maxLine=p)})}var wa=function(o,c,f){this.text=o,a0(this,c),this.height=f?f(this):1};wa.prototype.lineNo=function(){return N(this)},gn(wa);function hR(o,c,f,p){o.text=c,o.stateAfter&&(o.stateAfter=null),o.styles&&(o.styles=null),o.order!=null&&(o.order=null),s0(o),a0(o,f);var m=p?p(o):1;m!=o.height&&Gi(o,m)}function pR(o){o.parent=null,s0(o)}var fR={},gR={};function u0(o,c){if(!o||/^\s*$/.test(o))return null;var f=c.addModeClass?gR:fR;return f[o]||(f[o]=o.replace(/\S+/g,"cm-$&"))}function h0(o,c){var f=se("span",null,null,h?"padding-right: .1px":null),p={pre:se("pre",[f],"CodeMirror-line"),content:f,col:0,pos:0,cm:o,trailingSpace:!1,splitSpaces:o.getOption("lineWrapping")};c.measure={};for(var m=0;m<=(c.rest?c.rest.length:0);m++){var S=m?c.rest[m-1]:c.line,x=void 0;p.pos=0,p.addToken=vR,Hr(o.display.measure)&&(x=qe(S,o.doc.direction))&&(p.addToken=SR(p.addToken,x)),p.map=[];var E=c!=o.display.externalMeasured&&N(S);bR(S,p,Yy(o,S,E)),S.styleClasses&&(S.styleClasses.bgClass&&(p.bgClass=ie(S.styleClasses.bgClass,p.bgClass||"")),S.styleClasses.textClass&&(p.textClass=ie(S.styleClasses.textClass,p.textClass||""))),p.map.length==0&&p.map.push(0,0,p.content.appendChild(Hc(o.display.measure))),m==0?(c.measure.map=p.map,c.measure.cache={}):((c.measure.maps||(c.measure.maps=[])).push(p.map),(c.measure.caches||(c.measure.caches=[])).push({}))}if(h){var D=p.content.lastChild;(/\bcm-tab\b/.test(D.className)||D.querySelector&&D.querySelector(".cm-tab"))&&(p.content.className="cm-tab-wrap-hack")}return St(o,"renderLine",o,c.line,p.pre),p.pre.className&&(p.textClass=ie(p.pre.className,p.textClass||"")),p}function mR(o){var c=_("span","•","cm-invalidchar");return c.title="\\u"+o.charCodeAt(0).toString(16),c.setAttribute("aria-label",c.title),c}function vR(o,c,f,p,m,S,x){if(c){var E=o.splitSpaces?yR(c,o.trailingSpace):c,D=o.cm.state.specialChars,A=!1,z;if(!D.test(c))o.col+=c.length,z=document.createTextNode(E),o.map.push(o.pos,o.pos+c.length,z),d&&u<9&&(A=!0),o.pos+=c.length;else{z=document.createDocumentFragment();for(var W=0;;){D.lastIndex=W;var X=D.exec(c),J=X?X.index-W:c.length-W;if(J){var Q=document.createTextNode(E.slice(W,W+J));d&&u<9?z.appendChild(_("span",[Q])):z.appendChild(Q),o.map.push(o.pos,o.pos+J,Q),o.col+=J,o.pos+=J}if(!X)break;W+=J+1;var ne=void 0;if(X[0]=="	"){var ue=o.cm.options.tabSize,pe=ue-o.col%ue;ne=z.appendChild(_("span",pn(pe),"cm-tab")),ne.setAttribute("role","presentation"),ne.setAttribute("cm-text","	"),o.col+=pe}else X[0]=="\r"||X[0]==`
`?(ne=z.appendChild(_("span",X[0]=="\r"?"␍":"␤","cm-invalidchar")),ne.setAttribute("cm-text",X[0]),o.col+=1):(ne=o.cm.options.specialCharPlaceholder(X[0]),ne.setAttribute("cm-text",X[0]),d&&u<9?z.appendChild(_("span",[ne])):z.appendChild(ne),o.col+=1);o.map.push(o.pos,o.pos+1,ne),o.pos++}}if(o.trailingSpace=E.charCodeAt(c.length-1)==32,f||p||m||A||S||x){var Se=f||"";p&&(Se+=p),m&&(Se+=m);var fe=_("span",[z],Se,S);if(x)for(var xe in x)x.hasOwnProperty(xe)&&xe!="style"&&xe!="class"&&fe.setAttribute(xe,x[xe]);return o.content.appendChild(fe)}o.content.appendChild(z)}}function yR(o,c){if(o.length>1&&!/  /.test(o))return o;for(var f=c,p="",m=0;m<o.length;m++){var S=o.charAt(m);S==" "&&f&&(m==o.length-1||o.charCodeAt(m+1)==32)&&(S=" "),p+=S,f=S==" "}return p}function SR(o,c){return function(f,p,m,S,x,E,D){m=m?m+" cm-force-border":"cm-force-border";for(var A=f.pos,z=A+p.length;;){for(var W=void 0,X=0;X<c.length&&(W=c[X],!(W.to>A&&W.from<=A));X++);if(W.to>=z)return o(f,p,m,S,x,E,D);o(f,p.slice(0,W.to-A),m,S,null,E,D),S=null,p=p.slice(W.to-A),A=W.to}}}function p0(o,c,f,p){var m=!p&&f.widgetNode;m&&o.map.push(o.pos,o.pos+c,m),!p&&o.cm.display.input.needsContentAttribute&&(m||(m=o.content.appendChild(document.createElement("span"))),m.setAttribute("cm-marker",f.id)),m&&(o.cm.display.input.setUneditable(m),o.content.appendChild(m)),o.pos+=c,o.trailingSpace=!1}function bR(o,c,f){var p=o.markedSpans,m=o.text,S=0;if(!p){for(var x=1;x<f.length;x+=2)c.addToken(c,m.slice(S,S=f[x]),u0(f[x+1],c.cm.options));return}for(var E=m.length,D=0,A=1,z="",W,X,J=0,Q,ne,ue,pe,Se;;){if(J==D){Q=ne=ue=X="",Se=null,pe=null,J=1/0;for(var fe=[],xe=void 0,Be=0;Be<p.length;++Be){var Ae=p[Be],He=Ae.marker;if(He.type=="bookmark"&&Ae.from==D&&He.widgetNode)fe.push(He);else if(Ae.from<=D&&(Ae.to==null||Ae.to>D||He.collapsed&&Ae.to==D&&Ae.from==D)){if(Ae.to!=null&&Ae.to!=D&&J>Ae.to&&(J=Ae.to,ne=""),He.className&&(Q+=" "+He.className),He.css&&(X=(X?X+";":"")+He.css),He.startStyle&&Ae.from==D&&(ue+=" "+He.startStyle),He.endStyle&&Ae.to==J&&(xe||(xe=[])).push(He.endStyle,Ae.to),He.title&&((Se||(Se={})).title=He.title),He.attributes)for(var ht in He.attributes)(Se||(Se={}))[ht]=He.attributes[ht];He.collapsed&&(!pe||zh(pe.marker,He)<0)&&(pe=Ae)}else Ae.from>D&&J>Ae.from&&(J=Ae.from)}if(xe)for(var Wt=0;Wt<xe.length;Wt+=2)xe[Wt+1]==J&&(ne+=" "+xe[Wt]);if(!pe||pe.from==D)for(var yt=0;yt<fe.length;++yt)p0(c,0,fe[yt]);if(pe&&(pe.from||0)==D){if(p0(c,(pe.to==null?E+1:pe.to)-D,pe.marker,pe.from==null),pe.to==null)return;pe.to==D&&(pe=!1)}}if(D>=E)break;for(var Oi=Math.min(E,J);;){if(z){var ki=D+z.length;if(!pe){var Mt=ki>Oi?z.slice(0,Oi-D):z;c.addToken(c,Mt,W?W+Q:Q,ue,D+Mt.length==J?ne:"",X,Se)}if(ki>=Oi){z=z.slice(Oi-D),D=Oi;break}D=ki,ue=""}z=m.slice(S,S=f[A++]),W=u0(f[A++],c.cm.options)}}}function f0(o,c,f){this.line=c,this.rest=uR(c),this.size=this.rest?N(je(this.rest))-f+1:1,this.node=this.text=null,this.hidden=Jr(o,c)}function Qc(o,c,f){for(var p=[],m,S=c;S<f;S=m){var x=new f0(o.doc,De(o.doc,S),S);m=S+x.size,p.push(x)}return p}var Ca=null;function wR(o){Ca?Ca.ops.push(o):o.ownsGroup=Ca={ops:[o],delayedCallbacks:[]}}function CR(o){var c=o.delayedCallbacks,f=0;do{for(;f<c.length;f++)c[f].call(null);for(var p=0;p<o.ops.length;p++){var m=o.ops[p];if(m.cursorActivityHandlers)for(;m.cursorActivityCalled<m.cursorActivityHandlers.length;)m.cursorActivityHandlers[m.cursorActivityCalled++].call(null,m.cm)}}while(f<c.length)}function xR(o,c){var f=o.ownsGroup;if(f)try{CR(f)}finally{Ca=null,c(f)}}var tl=null;function zt(o,c){var f=or(o,c);if(f.length){var p=Array.prototype.slice.call(arguments,2),m;Ca?m=Ca.delayedCallbacks:tl?m=tl:(m=tl=[],setTimeout(kR,0));for(var S=function(E){m.push(function(){return f[E].apply(null,p)})},x=0;x<f.length;++x)S(x)}}function kR(){var o=tl;tl=null;for(var c=0;c<o.length;++c)o[c]()}function g0(o,c,f,p){for(var m=0;m<c.changes.length;m++){var S=c.changes[m];S=="text"?LR(o,c):S=="gutter"?v0(o,c,f,p):S=="class"?Hh(o,c):S=="widget"&&TR(o,c,p)}c.changes=null}function il(o){return o.node==o.text&&(o.node=_("div",null,null,"position: relative"),o.text.parentNode&&o.text.parentNode.replaceChild(o.node,o.text),o.node.appendChild(o.text),d&&u<8&&(o.node.style.zIndex=2)),o.node}function ER(o,c){var f=c.bgClass?c.bgClass+" "+(c.line.bgClass||""):c.line.bgClass;if(f&&(f+=" CodeMirror-linebackground"),c.background)f?c.background.className=f:(c.background.parentNode.removeChild(c.background),c.background=null);else if(f){var p=il(c);c.background=p.insertBefore(_("div",null,f),p.firstChild),o.display.input.setUneditable(c.background)}}function m0(o,c){var f=o.display.externalMeasured;return f&&f.line==c.line?(o.display.externalMeasured=null,c.measure=f.measure,f.built):h0(o,c)}function LR(o,c){var f=c.text.className,p=m0(o,c);c.text==c.node&&(c.node=p.pre),c.text.parentNode.replaceChild(p.pre,c.text),c.text=p.pre,p.bgClass!=c.bgClass||p.textClass!=c.textClass?(c.bgClass=p.bgClass,c.textClass=p.textClass,Hh(o,c)):f&&(c.text.className=f)}function Hh(o,c){ER(o,c),c.line.wrapClass?il(c).className=c.line.wrapClass:c.node!=c.text&&(c.node.className="");var f=c.textClass?c.textClass+" "+(c.line.textClass||""):c.line.textClass;c.text.className=f||""}function v0(o,c,f,p){if(c.gutter&&(c.node.removeChild(c.gutter),c.gutter=null),c.gutterBackground&&(c.node.removeChild(c.gutterBackground),c.gutterBackground=null),c.line.gutterClass){var m=il(c);c.gutterBackground=_("div",null,"CodeMirror-gutter-background "+c.line.gutterClass,"left: "+(o.options.fixedGutter?p.fixedPos:-p.gutterTotalWidth)+"px; width: "+p.gutterTotalWidth+"px"),o.display.input.setUneditable(c.gutterBackground),m.insertBefore(c.gutterBackground,c.text)}var S=c.line.gutterMarkers;if(o.options.lineNumbers||S){var x=il(c),E=c.gutter=_("div",null,"CodeMirror-gutter-wrapper","left: "+(o.options.fixedGutter?p.fixedPos:-p.gutterTotalWidth)+"px");if(E.setAttribute("aria-hidden","true"),o.display.input.setUneditable(E),x.insertBefore(E,c.text),c.line.gutterClass&&(E.className+=" "+c.line.gutterClass),o.options.lineNumbers&&(!S||!S["CodeMirror-linenumbers"])&&(c.lineNumber=E.appendChild(_("div",de(o.options,f),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+p.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+o.display.lineNumInnerWidth+"px"))),S)for(var D=0;D<o.display.gutterSpecs.length;++D){var A=o.display.gutterSpecs[D].className,z=S.hasOwnProperty(A)&&S[A];z&&E.appendChild(_("div",[z],"CodeMirror-gutter-elt","left: "+p.gutterLeft[A]+"px; width: "+p.gutterWidth[A]+"px"))}}}function TR(o,c,f){c.alignable&&(c.alignable=null);for(var p=j("CodeMirror-linewidget"),m=c.node.firstChild,S=void 0;m;m=S)S=m.nextSibling,p.test(m.className)&&c.node.removeChild(m);y0(o,c,f)}function DR(o,c,f,p){var m=m0(o,c);return c.text=c.node=m.pre,m.bgClass&&(c.bgClass=m.bgClass),m.textClass&&(c.textClass=m.textClass),Hh(o,c),v0(o,c,f,p),y0(o,c,p),c.node}function y0(o,c,f){if(S0(o,c.line,c,f,!0),c.rest)for(var p=0;p<c.rest.length;p++)S0(o,c.rest[p],c,f,!1)}function S0(o,c,f,p,m){if(c.widgets)for(var S=il(f),x=0,E=c.widgets;x<E.length;++x){var D=E[x],A=_("div",[D.node],"CodeMirror-linewidget"+(D.className?" "+D.className:""));D.handleMouseEvents||A.setAttribute("cm-ignore-events","true"),PR(D,A,f,p),o.display.input.setUneditable(A),m&&D.above?S.insertBefore(A,f.gutter||f.text):S.appendChild(A),zt(D,"redraw")}}function PR(o,c,f,p){if(o.noHScroll){(f.alignable||(f.alignable=[])).push(c);var m=p.wrapperWidth;c.style.left=p.fixedPos+"px",o.coverGutter||(m-=p.gutterTotalWidth,c.style.paddingLeft=p.gutterTotalWidth+"px"),c.style.width=m+"px"}o.coverGutter&&(c.style.zIndex=5,c.style.position="relative",o.noHScroll||(c.style.marginLeft=-p.gutterTotalWidth+"px"))}function nl(o){if(o.height!=null)return o.height;var c=o.doc.cm;if(!c)return 0;if(!Re(document.body,o.node)){var f="position: relative;";o.coverGutter&&(f+="margin-left: -"+c.display.gutters.offsetWidth+"px;"),o.noHScroll&&(f+="width: "+c.display.wrapper.clientWidth+"px;"),$(c.display.measure,_("div",[o.node],null,f))}return o.height=o.node.parentNode.offsetHeight}function ur(o,c){for(var f=Xo(c);f!=o.wrapper;f=f.parentNode)if(!f||f.nodeType==1&&f.getAttribute("cm-ignore-events")=="true"||f.parentNode==o.sizer&&f!=o.mover)return!0}function ed(o){return o.lineSpace.offsetTop}function jh(o){return o.mover.offsetHeight-o.lineSpace.offsetHeight}function b0(o){if(o.cachedPaddingH)return o.cachedPaddingH;var c=$(o.measure,_("pre","x","CodeMirror-line-like")),f=window.getComputedStyle?window.getComputedStyle(c):c.currentStyle,p={left:parseInt(f.paddingLeft),right:parseInt(f.paddingRight)};return!isNaN(p.left)&&!isNaN(p.right)&&(o.cachedPaddingH=p),p}function _n(o){return Xe-o.display.nativeBarWidth}function Rs(o){return o.display.scroller.clientWidth-_n(o)-o.display.barWidth}function qh(o){return o.display.scroller.clientHeight-_n(o)-o.display.barHeight}function IR(o,c,f){var p=o.options.lineWrapping,m=p&&Rs(o);if(!c.measure.heights||p&&c.measure.width!=m){var S=c.measure.heights=[];if(p){c.measure.width=m;for(var x=c.text.firstChild.getClientRects(),E=0;E<x.length-1;E++){var D=x[E],A=x[E+1];Math.abs(D.bottom-A.bottom)>2&&S.push((D.bottom+A.top)/2-f.top)}}S.push(f.bottom-f.top)}}function w0(o,c,f){if(o.line==c)return{map:o.measure.map,cache:o.measure.cache};if(o.rest){for(var p=0;p<o.rest.length;p++)if(o.rest[p]==c)return{map:o.measure.maps[p],cache:o.measure.caches[p]};for(var m=0;m<o.rest.length;m++)if(N(o.rest[m])>f)return{map:o.measure.maps[m],cache:o.measure.caches[m],before:!0}}}function RR(o,c){c=bn(c);var f=N(c),p=o.display.externalMeasured=new f0(o.doc,c,f);p.lineN=f;var m=p.built=h0(o,p);return p.text=m.pre,$(o.display.lineMeasure,m.pre),p}function C0(o,c,f,p){return Fn(o,xa(o,c),f,p)}function Jh(o,c){if(c>=o.display.viewFrom&&c<o.display.viewTo)return o.display.view[Ns(o,c)];var f=o.display.externalMeasured;if(f&&c>=f.lineN&&c<f.lineN+f.size)return f}function xa(o,c){var f=N(c),p=Jh(o,f);p&&!p.text?p=null:p&&p.changes&&(g0(o,p,f,Qh(o)),o.curOp.forceUpdate=!0),p||(p=RR(o,c));var m=w0(p,c,f);return{line:c,view:p,rect:null,map:m.map,cache:m.cache,before:m.before,hasHeights:!1}}function Fn(o,c,f,p,m){c.before&&(f=-1);var S=f+(p||""),x;return c.cache.hasOwnProperty(S)?x=c.cache[S]:(c.rect||(c.rect=c.view.text.getBoundingClientRect()),c.hasHeights||(IR(o,c.view,c.rect),c.hasHeights=!0),x=AR(o,c,f,p),x.bogus||(c.cache[S]=x)),{left:x.left,right:x.right,top:m?x.rtop:x.top,bottom:m?x.rbottom:x.bottom}}var x0={left:0,right:0,top:0,bottom:0};function k0(o,c,f){for(var p,m,S,x,E,D,A=0;A<o.length;A+=3)if(E=o[A],D=o[A+1],c<E?(m=0,S=1,x="left"):c<D?(m=c-E,S=m+1):(A==o.length-3||c==D&&o[A+3]>c)&&(S=D-E,m=S-1,c>=D&&(x="right")),m!=null){if(p=o[A+2],E==D&&f==(p.insertLeft?"left":"right")&&(x=f),f=="left"&&m==0)for(;A&&o[A-2]==o[A-3]&&o[A-1].insertLeft;)p=o[(A-=3)+2],x="left";if(f=="right"&&m==D-E)for(;A<o.length-3&&o[A+3]==o[A+4]&&!o[A+5].insertLeft;)p=o[(A+=3)+2],x="right";break}return{node:p,start:m,end:S,collapse:x,coverStart:E,coverEnd:D}}function MR(o,c){var f=x0;if(c=="left")for(var p=0;p<o.length&&(f=o[p]).left==f.right;p++);else for(var m=o.length-1;m>=0&&(f=o[m]).left==f.right;m--);return f}function AR(o,c,f,p){var m=k0(c.map,f,p),S=m.node,x=m.start,E=m.end,D=m.collapse,A;if(S.nodeType==3){for(var z=0;z<4;z++){for(;x&&Rt(c.line.text.charAt(m.coverStart+x));)--x;for(;m.coverStart+E<m.coverEnd&&Rt(c.line.text.charAt(m.coverStart+E));)++E;if(d&&u<9&&x==0&&E==m.coverEnd-m.coverStart?A=S.parentNode.getBoundingClientRect():A=MR(oe(S,x,E).getClientRects(),p),A.left||A.right||x==0)break;E=x,x=x-1,D="right"}d&&u<11&&(A=NR(o.display.measure,A))}else{x>0&&(D=p="right");var W;o.options.lineWrapping&&(W=S.getClientRects()).length>1?A=W[p=="right"?W.length-1:0]:A=S.getBoundingClientRect()}if(d&&u<9&&!x&&(!A||!A.left&&!A.right)){var X=S.parentNode.getClientRects()[0];X?A={left:X.left,right:X.left+Ea(o.display),top:X.top,bottom:X.bottom}:A=x0}for(var J=A.top-c.rect.top,Q=A.bottom-c.rect.top,ne=(J+Q)/2,ue=c.view.measure.heights,pe=0;pe<ue.length-1&&!(ne<ue[pe]);pe++);var Se=pe?ue[pe-1]:0,fe=ue[pe],xe={left:(D=="right"?A.right:A.left)-c.rect.left,right:(D=="left"?A.left:A.right)-c.rect.left,top:Se,bottom:fe};return!A.left&&!A.right&&(xe.bogus=!0),o.options.singleCursorHeightPerLine||(xe.rtop=J,xe.rbottom=Q),xe}function NR(o,c){if(!window.screen||screen.logicalXDPI==null||screen.logicalXDPI==screen.deviceXDPI||!Bh(o))return c;var f=screen.logicalXDPI/screen.deviceXDPI,p=screen.logicalYDPI/screen.deviceYDPI;return{left:c.left*f,right:c.right*f,top:c.top*p,bottom:c.bottom*p}}function E0(o){if(o.measure&&(o.measure.cache={},o.measure.heights=null,o.rest))for(var c=0;c<o.rest.length;c++)o.measure.caches[c]={}}function L0(o){o.display.externalMeasure=null,O(o.display.lineMeasure);for(var c=0;c<o.display.view.length;c++)E0(o.display.view[c])}function rl(o){L0(o),o.display.cachedCharWidth=o.display.cachedTextHeight=o.display.cachedPaddingH=null,o.options.lineWrapping||(o.display.maxLineChanged=!0),o.display.lineNumChars=null}function T0(o){return v&&I?-(o.body.getBoundingClientRect().left-parseInt(getComputedStyle(o.body).marginLeft)):o.defaultView.pageXOffset||(o.documentElement||o.body).scrollLeft}function D0(o){return v&&I?-(o.body.getBoundingClientRect().top-parseInt(getComputedStyle(o.body).marginTop)):o.defaultView.pageYOffset||(o.documentElement||o.body).scrollTop}function Xh(o){var c=bn(o),f=c.widgets,p=0;if(f)for(var m=0;m<f.length;++m)f[m].above&&(p+=nl(f[m]));return p}function td(o,c,f,p,m){if(!m){var S=Xh(c);f.top+=S,f.bottom+=S}if(p=="line")return f;p||(p="local");var x=dr(c);if(p=="local"?x+=ed(o.display):x-=o.display.viewOffset,p=="page"||p=="window"){var E=o.display.lineSpace.getBoundingClientRect();x+=E.top+(p=="window"?0:D0(Te(o)));var D=E.left+(p=="window"?0:T0(Te(o)));f.left+=D,f.right+=D}return f.top+=x,f.bottom+=x,f}function P0(o,c,f){if(f=="div")return c;var p=c.left,m=c.top;if(f=="page")p-=T0(Te(o)),m-=D0(Te(o));else if(f=="local"||!f){var S=o.display.sizer.getBoundingClientRect();p+=S.left,m+=S.top}var x=o.display.lineSpace.getBoundingClientRect();return{left:p-x.left,top:m-x.top}}function id(o,c,f,p,m){return p||(p=De(o.doc,c.line)),td(o,p,C0(o,p,c.ch,m),f)}function wn(o,c,f,p,m,S){p=p||De(o.doc,c.line),m||(m=xa(o,p));function x(Q,ne){var ue=Fn(o,m,Q,ne?"right":"left",S);return ne?ue.left=ue.right:ue.right=ue.left,td(o,p,ue,f)}var E=qe(p,o.doc.direction),D=c.ch,A=c.sticky;if(D>=p.text.length?(D=p.text.length,A="before"):D<=0&&(D=0,A="after"),!E)return x(A=="before"?D-1:D,A=="before");function z(Q,ne,ue){var pe=E[ne],Se=pe.level==1;return x(ue?Q-1:Q,Se!=ue)}var W=Gr(E,D,A),X=Is,J=z(D,W,A=="before");return X!=null&&(J.other=z(D,X,A!="before")),J}function I0(o,c){var f=0;c=ze(o.doc,c),o.options.lineWrapping||(f=Ea(o.display)*c.ch);var p=De(o.doc,c.line),m=dr(p)+ed(o.display);return{left:f,right:f,top:m,bottom:m+p.height}}function Kh(o,c,f,p,m){var S=Z(o,c,f);return S.xRel=m,p&&(S.outside=p),S}function Yh(o,c,f){var p=o.doc;if(f+=o.display.viewOffset,f<0)return Kh(p.first,0,null,-1,-1);var m=G(p,f),S=p.first+p.size-1;if(m>S)return Kh(p.first+p.size-1,De(p,S).text.length,null,1,1);c<0&&(c=0);for(var x=De(p,m);;){var E=VR(o,x,m,c,f),D=cR(x,E.ch+(E.xRel>0||E.outside>0?1:0));if(!D)return E;var A=D.find(1);if(A.line==m)return A;x=De(p,m=A.line)}}function R0(o,c,f,p){p-=Xh(c);var m=c.text.length,S=Vn(function(x){return Fn(o,f,x-1).bottom<=p},m,0);return m=Vn(function(x){return Fn(o,f,x).top>p},S,m),{begin:S,end:m}}function M0(o,c,f,p){f||(f=xa(o,c));var m=td(o,c,Fn(o,f,p),"line").top;return R0(o,c,f,m)}function Zh(o,c,f,p){return o.bottom<=f?!1:o.top>f?!0:(p?o.left:o.right)>c}function VR(o,c,f,p,m){m-=dr(c);var S=xa(o,c),x=Xh(c),E=0,D=c.text.length,A=!0,z=qe(c,o.doc.direction);if(z){var W=(o.options.lineWrapping?BR:OR)(o,c,f,S,z,p,m);A=W.level!=1,E=A?W.from:W.to-1,D=A?W.to:W.from-1}var X=null,J=null,Q=Vn(function(Be){var Ae=Fn(o,S,Be);return Ae.top+=x,Ae.bottom+=x,Zh(Ae,p,m,!1)?(Ae.top<=m&&Ae.left<=p&&(X=Be,J=Ae),!0):!1},E,D),ne,ue,pe=!1;if(J){var Se=p-J.left<J.right-p,fe=Se==A;Q=X+(fe?0:1),ue=fe?"after":"before",ne=Se?J.left:J.right}else{!A&&(Q==D||Q==E)&&Q++,ue=Q==0?"after":Q==c.text.length?"before":Fn(o,S,Q-(A?1:0)).bottom+x<=m==A?"after":"before";var xe=wn(o,Z(f,Q,ue),"line",c,S);ne=xe.left,pe=m<xe.top?-1:m>=xe.bottom?1:0}return Q=zr(c.text,Q,1),Kh(f,Q,ue,pe,p-ne)}function OR(o,c,f,p,m,S,x){var E=Vn(function(W){var X=m[W],J=X.level!=1;return Zh(wn(o,Z(f,J?X.to:X.from,J?"before":"after"),"line",c,p),S,x,!0)},0,m.length-1),D=m[E];if(E>0){var A=D.level!=1,z=wn(o,Z(f,A?D.from:D.to,A?"after":"before"),"line",c,p);Zh(z,S,x,!0)&&z.top>x&&(D=m[E-1])}return D}function BR(o,c,f,p,m,S,x){var E=R0(o,c,p,x),D=E.begin,A=E.end;/\s/.test(c.text.charAt(A-1))&&A--;for(var z=null,W=null,X=0;X<m.length;X++){var J=m[X];if(!(J.from>=A||J.to<=D)){var Q=J.level!=1,ne=Fn(o,p,Q?Math.min(A,J.to)-1:Math.max(D,J.from)).right,ue=ne<S?S-ne+1e9:ne-S;(!z||W>ue)&&(z=J,W=ue)}}return z||(z=m[m.length-1]),z.from<D&&(z={from:D,to:z.to,level:z.level}),z.to>A&&(z={from:z.from,to:A,level:z.level}),z}var Ms;function ka(o){if(o.cachedTextHeight!=null)return o.cachedTextHeight;if(Ms==null){Ms=_("pre",null,"CodeMirror-line-like");for(var c=0;c<49;++c)Ms.appendChild(document.createTextNode("x")),Ms.appendChild(_("br"));Ms.appendChild(document.createTextNode("x"))}$(o.measure,Ms);var f=Ms.offsetHeight/50;return f>3&&(o.cachedTextHeight=f),O(o.measure),f||1}function Ea(o){if(o.cachedCharWidth!=null)return o.cachedCharWidth;var c=_("span","xxxxxxxxxx"),f=_("pre",[c],"CodeMirror-line-like");$(o.measure,f);var p=c.getBoundingClientRect(),m=(p.right-p.left)/10;return m>2&&(o.cachedCharWidth=m),m||10}function Qh(o){for(var c=o.display,f={},p={},m=c.gutters.clientLeft,S=c.gutters.firstChild,x=0;S;S=S.nextSibling,++x){var E=o.display.gutterSpecs[x].className;f[E]=S.offsetLeft+S.clientLeft+m,p[E]=S.clientWidth}return{fixedPos:ep(c),gutterTotalWidth:c.gutters.offsetWidth,gutterLeft:f,gutterWidth:p,wrapperWidth:c.wrapper.clientWidth}}function ep(o){return o.scroller.getBoundingClientRect().left-o.sizer.getBoundingClientRect().left}function A0(o){var c=ka(o.display),f=o.options.lineWrapping,p=f&&Math.max(5,o.display.scroller.clientWidth/Ea(o.display)-3);return function(m){if(Jr(o.doc,m))return 0;var S=0;if(m.widgets)for(var x=0;x<m.widgets.length;x++)m.widgets[x].height&&(S+=m.widgets[x].height);return f?S+(Math.ceil(m.text.length/p)||1)*c:S+c}}function tp(o){var c=o.doc,f=A0(o);c.iter(function(p){var m=f(p);m!=p.height&&Gi(p,m)})}function As(o,c,f,p){var m=o.display;if(!f&&Xo(c).getAttribute("cm-not-content")=="true")return null;var S,x,E=m.lineSpace.getBoundingClientRect();try{S=c.clientX-E.left,x=c.clientY-E.top}catch{return null}var D=Yh(o,S,x),A;if(p&&D.xRel>0&&(A=De(o.doc,D.line).text).length==D.ch){var z=_e(A,A.length,o.options.tabSize)-A.length;D=Z(D.line,Math.max(0,Math.round((S-b0(o.display).left)/Ea(o.display))-z))}return D}function Ns(o,c){if(c>=o.display.viewTo||(c-=o.display.viewFrom,c<0))return null;for(var f=o.display.view,p=0;p<f.length;p++)if(c-=f[p].size,c<0)return p}function Ci(o,c,f,p){c==null&&(c=o.doc.first),f==null&&(f=o.doc.first+o.doc.size),p||(p=0);var m=o.display;if(p&&f<m.viewTo&&(m.updateLineNumbers==null||m.updateLineNumbers>c)&&(m.updateLineNumbers=c),o.curOp.viewChanged=!0,c>=m.viewTo)cr&&$h(o.doc,c)<m.viewTo&&Kr(o);else if(f<=m.viewFrom)cr&&d0(o.doc,f+p)>m.viewFrom?Kr(o):(m.viewFrom+=p,m.viewTo+=p);else if(c<=m.viewFrom&&f>=m.viewTo)Kr(o);else if(c<=m.viewFrom){var S=nd(o,f,f+p,1);S?(m.view=m.view.slice(S.index),m.viewFrom=S.lineN,m.viewTo+=p):Kr(o)}else if(f>=m.viewTo){var x=nd(o,c,c,-1);x?(m.view=m.view.slice(0,x.index),m.viewTo=x.lineN):Kr(o)}else{var E=nd(o,c,c,-1),D=nd(o,f,f+p,1);E&&D?(m.view=m.view.slice(0,E.index).concat(Qc(o,E.lineN,D.lineN)).concat(m.view.slice(D.index)),m.viewTo+=p):Kr(o)}var A=m.externalMeasured;A&&(f<A.lineN?A.lineN+=p:c<A.lineN+A.size&&(m.externalMeasured=null))}function Xr(o,c,f){o.curOp.viewChanged=!0;var p=o.display,m=o.display.externalMeasured;if(m&&c>=m.lineN&&c<m.lineN+m.size&&(p.externalMeasured=null),!(c<p.viewFrom||c>=p.viewTo)){var S=p.view[Ns(o,c)];if(S.node!=null){var x=S.changes||(S.changes=[]);Ce(x,f)==-1&&x.push(f)}}}function Kr(o){o.display.viewFrom=o.display.viewTo=o.doc.first,o.display.view=[],o.display.viewOffset=0}function nd(o,c,f,p){var m=Ns(o,c),S,x=o.display.view;if(!cr||f==o.doc.first+o.doc.size)return{index:m,lineN:f};for(var E=o.display.viewFrom,D=0;D<m;D++)E+=x[D].size;if(E!=c){if(p>0){if(m==x.length-1)return null;S=E+x[m].size-c,m++}else S=E-c;c+=S,f+=S}for(;$h(o.doc,f)!=f;){if(m==(p<0?0:x.length-1))return null;f+=p*x[m-(p<0?1:0)].size,m+=p}return{index:m,lineN:f}}function _R(o,c,f){var p=o.display,m=p.view;m.length==0||c>=p.viewTo||f<=p.viewFrom?(p.view=Qc(o,c,f),p.viewFrom=c):(p.viewFrom>c?p.view=Qc(o,c,p.viewFrom).concat(p.view):p.viewFrom<c&&(p.view=p.view.slice(Ns(o,c))),p.viewFrom=c,p.viewTo<f?p.view=p.view.concat(Qc(o,p.viewTo,f)):p.viewTo>f&&(p.view=p.view.slice(0,Ns(o,f)))),p.viewTo=f}function N0(o){for(var c=o.display.view,f=0,p=0;p<c.length;p++){var m=c[p];!m.hidden&&(!m.node||m.changes)&&++f}return f}function sl(o){o.display.input.showSelection(o.display.input.prepareSelection())}function V0(o,c){c===void 0&&(c=!0);var f=o.doc,p={},m=p.cursors=document.createDocumentFragment(),S=p.selection=document.createDocumentFragment(),x=o.options.$customCursor;x&&(c=!0);for(var E=0;E<f.sel.ranges.length;E++)if(!(!c&&E==f.sel.primIndex)){var D=f.sel.ranges[E];if(!(D.from().line>=o.display.viewTo||D.to().line<o.display.viewFrom)){var A=D.empty();if(x){var z=x(o,D);z&&ip(o,z,m)}else(A||o.options.showCursorWhenSelecting)&&ip(o,D.head,m);A||FR(o,D,S)}}return p}function ip(o,c,f){var p=wn(o,c,"div",null,null,!o.options.singleCursorHeightPerLine),m=f.appendChild(_("div"," ","CodeMirror-cursor"));if(m.style.left=p.left+"px",m.style.top=p.top+"px",m.style.height=Math.max(0,p.bottom-p.top)*o.options.cursorHeight+"px",/\bcm-fat-cursor\b/.test(o.getWrapperElement().className)){var S=id(o,c,"div",null,null),x=S.right-S.left;m.style.width=(x>0?x:o.defaultCharWidth())+"px"}if(p.other){var E=f.appendChild(_("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));E.style.display="",E.style.left=p.other.left+"px",E.style.top=p.other.top+"px",E.style.height=(p.other.bottom-p.other.top)*.85+"px"}}function rd(o,c){return o.top-c.top||o.left-c.left}function FR(o,c,f){var p=o.display,m=o.doc,S=document.createDocumentFragment(),x=b0(o.display),E=x.left,D=Math.max(p.sizerWidth,Rs(o)-p.sizer.offsetLeft)-x.right,A=m.direction=="ltr";function z(fe,xe,Be,Ae){xe<0&&(xe=0),xe=Math.round(xe),Ae=Math.round(Ae),S.appendChild(_("div",null,"CodeMirror-selected","position: absolute; left: "+fe+`px;
                             top: `+xe+"px; width: "+(Be??D-fe)+`px;
                             height: `+(Ae-xe)+"px"))}function W(fe,xe,Be){var Ae=De(m,fe),He=Ae.text.length,ht,Wt;function yt(Mt,Ei){return id(o,Z(fe,Mt),"div",Ae,Ei)}function Oi(Mt,Ei,Yt){var Bt=M0(o,Ae,null,Mt),At=Ei=="ltr"==(Yt=="after")?"left":"right",Ct=Yt=="after"?Bt.begin:Bt.end-(/\s/.test(Ae.text.charAt(Bt.end-1))?2:1);return yt(Ct,At)[At]}var ki=qe(Ae,m.direction);return $r(ki,xe||0,Be??He,function(Mt,Ei,Yt,Bt){var At=Yt=="ltr",Ct=yt(Mt,At?"left":"right"),Li=yt(Ei-1,At?"right":"left"),_a=xe==null&&Mt==0,is=Be==null&&Ei==He,ri=Bt==0,Un=!ki||Bt==ki.length-1;if(Li.top-Ct.top<=3){var Ht=(A?_a:is)&&ri,Pp=(A?is:_a)&&Un,fr=Ht?E:(At?Ct:Li).left,Fs=Pp?D:(At?Li:Ct).right;z(fr,Ct.top,Fs-fr,Ct.bottom)}else{var Us,di,Fa,Ip;At?(Us=A&&_a&&ri?E:Ct.left,di=A?D:Oi(Mt,Yt,"before"),Fa=A?E:Oi(Ei,Yt,"after"),Ip=A&&is&&Un?D:Li.right):(Us=A?Oi(Mt,Yt,"before"):E,di=!A&&_a&&ri?D:Ct.right,Fa=!A&&is&&Un?E:Li.left,Ip=A?Oi(Ei,Yt,"after"):D),z(Us,Ct.top,di-Us,Ct.bottom),Ct.bottom<Li.top&&z(E,Ct.bottom,null,Li.top),z(Fa,Li.top,Ip-Fa,Li.bottom)}(!ht||rd(Ct,ht)<0)&&(ht=Ct),rd(Li,ht)<0&&(ht=Li),(!Wt||rd(Ct,Wt)<0)&&(Wt=Ct),rd(Li,Wt)<0&&(Wt=Li)}),{start:ht,end:Wt}}var X=c.from(),J=c.to();if(X.line==J.line)W(X.line,X.ch,J.ch);else{var Q=De(m,X.line),ne=De(m,J.line),ue=bn(Q)==bn(ne),pe=W(X.line,X.ch,ue?Q.text.length+1:null).end,Se=W(J.line,ue?0:null,J.ch).start;ue&&(pe.top<Se.top-2?(z(pe.right,pe.top,null,pe.bottom),z(E,Se.top,Se.left,Se.bottom)):z(pe.right,pe.top,Se.left-pe.right,pe.bottom)),pe.bottom<Se.top&&z(E,pe.bottom,null,Se.top)}f.appendChild(S)}function np(o){if(o.state.focused){var c=o.display;clearInterval(c.blinker);var f=!0;c.cursorDiv.style.visibility="",o.options.cursorBlinkRate>0?c.blinker=setInterval(function(){o.hasFocus()||La(o),c.cursorDiv.style.visibility=(f=!f)?"":"hidden"},o.options.cursorBlinkRate):o.options.cursorBlinkRate<0&&(c.cursorDiv.style.visibility="hidden")}}function O0(o){o.hasFocus()||(o.display.input.focus(),o.state.focused||sp(o))}function rp(o){o.state.delayingBlurEvent=!0,setTimeout(function(){o.state.delayingBlurEvent&&(o.state.delayingBlurEvent=!1,o.state.focused&&La(o))},100)}function sp(o,c){o.state.delayingBlurEvent&&!o.state.draggingText&&(o.state.delayingBlurEvent=!1),o.options.readOnly!="nocursor"&&(o.state.focused||(St(o,"focus",o,c),o.state.focused=!0,we(o.display.wrapper,"CodeMirror-focused"),!o.curOp&&o.display.selForContextMenu!=o.doc.sel&&(o.display.input.reset(),h&&setTimeout(function(){return o.display.input.reset(!0)},20)),o.display.input.receivedFocus()),np(o))}function La(o,c){o.state.delayingBlurEvent||(o.state.focused&&(St(o,"blur",o,c),o.state.focused=!1,U(o.display.wrapper,"CodeMirror-focused")),clearInterval(o.display.blinker),setTimeout(function(){o.state.focused||(o.display.shift=!1)},150))}function sd(o){for(var c=o.display,f=c.lineDiv.offsetTop,p=Math.max(0,c.scroller.getBoundingClientRect().top),m=c.lineDiv.getBoundingClientRect().top,S=0,x=0;x<c.view.length;x++){var E=c.view[x],D=o.options.lineWrapping,A=void 0,z=0;if(!E.hidden){if(m+=E.line.height,d&&u<8){var W=E.node.offsetTop+E.node.offsetHeight;A=W-f,f=W}else{var X=E.node.getBoundingClientRect();A=X.bottom-X.top,!D&&E.text.firstChild&&(z=E.text.firstChild.getBoundingClientRect().right-X.left-1)}var J=E.line.height-A;if((J>.005||J<-.005)&&(m<p&&(S-=J),Gi(E.line,A),B0(E.line),E.rest))for(var Q=0;Q<E.rest.length;Q++)B0(E.rest[Q]);if(z>o.display.sizerWidth){var ne=Math.ceil(z/Ea(o.display));ne>o.display.maxLineLength&&(o.display.maxLineLength=ne,o.display.maxLine=E.line,o.display.maxLineChanged=!0)}}}Math.abs(S)>2&&(c.scroller.scrollTop+=S)}function B0(o){if(o.widgets)for(var c=0;c<o.widgets.length;++c){var f=o.widgets[c],p=f.node.parentNode;p&&(f.height=p.offsetHeight)}}function ad(o,c,f){var p=f&&f.top!=null?Math.max(0,f.top):o.scroller.scrollTop;p=Math.floor(p-ed(o));var m=f&&f.bottom!=null?f.bottom:p+o.wrapper.clientHeight,S=G(c,p),x=G(c,m);if(f&&f.ensure){var E=f.ensure.from.line,D=f.ensure.to.line;E<S?(S=E,x=G(c,dr(De(c,E))+o.wrapper.clientHeight)):Math.min(D,c.lastLine())>=x&&(S=G(c,dr(De(c,D))-o.wrapper.clientHeight),x=D)}return{from:S,to:Math.max(x,S+1)}}function UR(o,c){if(!bt(o,"scrollCursorIntoView")){var f=o.display,p=f.sizer.getBoundingClientRect(),m=null,S=f.wrapper.ownerDocument;if(c.top+p.top<0?m=!0:c.bottom+p.top>(S.defaultView.innerHeight||S.documentElement.clientHeight)&&(m=!1),m!=null&&!k){var x=_("div","​",null,`position: absolute;
                         top: `+(c.top-f.viewOffset-ed(o.display))+`px;
                         height: `+(c.bottom-c.top+_n(o)+f.barHeight)+`px;
                         left: `+c.left+"px; width: "+Math.max(2,c.right-c.left)+"px;");o.display.lineSpace.appendChild(x),x.scrollIntoView(m),o.display.lineSpace.removeChild(x)}}}function zR(o,c,f,p){p==null&&(p=0);var m;!o.options.lineWrapping&&c==f&&(f=c.sticky=="before"?Z(c.line,c.ch+1,"before"):c,c=c.ch?Z(c.line,c.sticky=="before"?c.ch-1:c.ch,"after"):c);for(var S=0;S<5;S++){var x=!1,E=wn(o,c),D=!f||f==c?E:wn(o,f);m={left:Math.min(E.left,D.left),top:Math.min(E.top,D.top)-p,right:Math.max(E.left,D.left),bottom:Math.max(E.bottom,D.bottom)+p};var A=ap(o,m),z=o.doc.scrollTop,W=o.doc.scrollLeft;if(A.scrollTop!=null&&(ol(o,A.scrollTop),Math.abs(o.doc.scrollTop-z)>1&&(x=!0)),A.scrollLeft!=null&&(Vs(o,A.scrollLeft),Math.abs(o.doc.scrollLeft-W)>1&&(x=!0)),!x)break}return m}function $R(o,c){var f=ap(o,c);f.scrollTop!=null&&ol(o,f.scrollTop),f.scrollLeft!=null&&Vs(o,f.scrollLeft)}function ap(o,c){var f=o.display,p=ka(o.display);c.top<0&&(c.top=0);var m=o.curOp&&o.curOp.scrollTop!=null?o.curOp.scrollTop:f.scroller.scrollTop,S=qh(o),x={};c.bottom-c.top>S&&(c.bottom=c.top+S);var E=o.doc.height+jh(f),D=c.top<p,A=c.bottom>E-p;if(c.top<m)x.scrollTop=D?0:c.top;else if(c.bottom>m+S){var z=Math.min(c.top,(A?E:c.bottom)-S);z!=m&&(x.scrollTop=z)}var W=o.options.fixedGutter?0:f.gutters.offsetWidth,X=o.curOp&&o.curOp.scrollLeft!=null?o.curOp.scrollLeft:f.scroller.scrollLeft-W,J=Rs(o)-f.gutters.offsetWidth,Q=c.right-c.left>J;return Q&&(c.right=c.left+J),c.left<10?x.scrollLeft=0:c.left<X?x.scrollLeft=Math.max(0,c.left+W-(Q?0:10)):c.right>J+X-3&&(x.scrollLeft=c.right+(Q?0:10)-J),x}function op(o,c){c!=null&&(od(o),o.curOp.scrollTop=(o.curOp.scrollTop==null?o.doc.scrollTop:o.curOp.scrollTop)+c)}function Ta(o){od(o);var c=o.getCursor();o.curOp.scrollToPos={from:c,to:c,margin:o.options.cursorScrollMargin}}function al(o,c,f){(c!=null||f!=null)&&od(o),c!=null&&(o.curOp.scrollLeft=c),f!=null&&(o.curOp.scrollTop=f)}function GR(o,c){od(o),o.curOp.scrollToPos=c}function od(o){var c=o.curOp.scrollToPos;if(c){o.curOp.scrollToPos=null;var f=I0(o,c.from),p=I0(o,c.to);_0(o,f,p,c.margin)}}function _0(o,c,f,p){var m=ap(o,{left:Math.min(c.left,f.left),top:Math.min(c.top,f.top)-p,right:Math.max(c.right,f.right),bottom:Math.max(c.bottom,f.bottom)+p});al(o,m.scrollLeft,m.scrollTop)}function ol(o,c){Math.abs(o.doc.scrollTop-c)<2||(r||cp(o,{top:c}),F0(o,c,!0),r&&cp(o),dl(o,100))}function F0(o,c,f){c=Math.max(0,Math.min(o.display.scroller.scrollHeight-o.display.scroller.clientHeight,c)),!(o.display.scroller.scrollTop==c&&!f)&&(o.doc.scrollTop=c,o.display.scrollbars.setScrollTop(c),o.display.scroller.scrollTop!=c&&(o.display.scroller.scrollTop=c))}function Vs(o,c,f,p){c=Math.max(0,Math.min(c,o.display.scroller.scrollWidth-o.display.scroller.clientWidth)),!((f?c==o.doc.scrollLeft:Math.abs(o.doc.scrollLeft-c)<2)&&!p)&&(o.doc.scrollLeft=c,W0(o),o.display.scroller.scrollLeft!=c&&(o.display.scroller.scrollLeft=c),o.display.scrollbars.setScrollLeft(c))}function ll(o){var c=o.display,f=c.gutters.offsetWidth,p=Math.round(o.doc.height+jh(o.display));return{clientHeight:c.scroller.clientHeight,viewHeight:c.wrapper.clientHeight,scrollWidth:c.scroller.scrollWidth,clientWidth:c.scroller.clientWidth,viewWidth:c.wrapper.clientWidth,barLeft:o.options.fixedGutter?f:0,docHeight:p,scrollHeight:p+_n(o)+c.barHeight,nativeBarWidth:c.nativeBarWidth,gutterWidth:f}}var Os=function(o,c,f){this.cm=f;var p=this.vert=_("div",[_("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),m=this.horiz=_("div",[_("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");p.tabIndex=m.tabIndex=-1,o(p),o(m),Ve(p,"scroll",function(){p.clientHeight&&c(p.scrollTop,"vertical")}),Ve(m,"scroll",function(){m.clientWidth&&c(m.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,d&&u<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};Os.prototype.update=function(o){var c=o.scrollWidth>o.clientWidth+1,f=o.scrollHeight>o.clientHeight+1,p=o.nativeBarWidth;if(f){this.vert.style.display="block",this.vert.style.bottom=c?p+"px":"0";var m=o.viewHeight-(c?p:0);this.vert.firstChild.style.height=Math.max(0,o.scrollHeight-o.clientHeight+m)+"px"}else this.vert.scrollTop=0,this.vert.style.display="",this.vert.firstChild.style.height="0";if(c){this.horiz.style.display="block",this.horiz.style.right=f?p+"px":"0",this.horiz.style.left=o.barLeft+"px";var S=o.viewWidth-o.barLeft-(f?p:0);this.horiz.firstChild.style.width=Math.max(0,o.scrollWidth-o.clientWidth+S)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&o.clientHeight>0&&(p==0&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:f?p:0,bottom:c?p:0}},Os.prototype.setScrollLeft=function(o){this.horiz.scrollLeft!=o&&(this.horiz.scrollLeft=o),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},Os.prototype.setScrollTop=function(o){this.vert.scrollTop!=o&&(this.vert.scrollTop=o),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},Os.prototype.zeroWidthHack=function(){var o=T&&!b?"12px":"18px";this.horiz.style.height=this.vert.style.width=o,this.horiz.style.visibility=this.vert.style.visibility="hidden",this.disableHoriz=new Ue,this.disableVert=new Ue},Os.prototype.enableZeroWidthBar=function(o,c,f){o.style.visibility="";function p(){var m=o.getBoundingClientRect(),S=f=="vert"?document.elementFromPoint(m.right-1,(m.top+m.bottom)/2):document.elementFromPoint((m.right+m.left)/2,m.bottom-1);S!=o?o.style.visibility="hidden":c.set(1e3,p)}c.set(1e3,p)},Os.prototype.clear=function(){var o=this.horiz.parentNode;o.removeChild(this.horiz),o.removeChild(this.vert)};var cl=function(){};cl.prototype.update=function(){return{bottom:0,right:0}},cl.prototype.setScrollLeft=function(){},cl.prototype.setScrollTop=function(){},cl.prototype.clear=function(){};function Da(o,c){c||(c=ll(o));var f=o.display.barWidth,p=o.display.barHeight;U0(o,c);for(var m=0;m<4&&f!=o.display.barWidth||p!=o.display.barHeight;m++)f!=o.display.barWidth&&o.options.lineWrapping&&sd(o),U0(o,ll(o)),f=o.display.barWidth,p=o.display.barHeight}function U0(o,c){var f=o.display,p=f.scrollbars.update(c);f.sizer.style.paddingRight=(f.barWidth=p.right)+"px",f.sizer.style.paddingBottom=(f.barHeight=p.bottom)+"px",f.heightForcer.style.borderBottom=p.bottom+"px solid transparent",p.right&&p.bottom?(f.scrollbarFiller.style.display="block",f.scrollbarFiller.style.height=p.bottom+"px",f.scrollbarFiller.style.width=p.right+"px"):f.scrollbarFiller.style.display="",p.bottom&&o.options.coverGutterNextToScrollbar&&o.options.fixedGutter?(f.gutterFiller.style.display="block",f.gutterFiller.style.height=p.bottom+"px",f.gutterFiller.style.width=c.gutterWidth+"px"):f.gutterFiller.style.display=""}var z0={native:Os,null:cl};function $0(o){o.display.scrollbars&&(o.display.scrollbars.clear(),o.display.scrollbars.addClass&&U(o.display.wrapper,o.display.scrollbars.addClass)),o.display.scrollbars=new z0[o.options.scrollbarStyle](function(c){o.display.wrapper.insertBefore(c,o.display.scrollbarFiller),Ve(c,"mousedown",function(){o.state.focused&&setTimeout(function(){return o.display.input.focus()},0)}),c.setAttribute("cm-not-content","true")},function(c,f){f=="horizontal"?Vs(o,c):ol(o,c)},o),o.display.scrollbars.addClass&&we(o.display.wrapper,o.display.scrollbars.addClass)}var WR=0;function Bs(o){o.curOp={cm:o,viewChanged:!1,startHeight:o.doc.height,forceUpdate:!1,updateInput:0,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++WR,markArrays:null},wR(o.curOp)}function _s(o){var c=o.curOp;c&&xR(c,function(f){for(var p=0;p<f.ops.length;p++)f.ops[p].cm.curOp=null;HR(f)})}function HR(o){for(var c=o.ops,f=0;f<c.length;f++)jR(c[f]);for(var p=0;p<c.length;p++)qR(c[p]);for(var m=0;m<c.length;m++)JR(c[m]);for(var S=0;S<c.length;S++)XR(c[S]);for(var x=0;x<c.length;x++)KR(c[x])}function jR(o){var c=o.cm,f=c.display;ZR(c),o.updateMaxLine&&Wh(c),o.mustUpdate=o.viewChanged||o.forceUpdate||o.scrollTop!=null||o.scrollToPos&&(o.scrollToPos.from.line<f.viewFrom||o.scrollToPos.to.line>=f.viewTo)||f.maxLineChanged&&c.options.lineWrapping,o.update=o.mustUpdate&&new ld(c,o.mustUpdate&&{top:o.scrollTop,ensure:o.scrollToPos},o.forceUpdate)}function qR(o){o.updatedDisplay=o.mustUpdate&&lp(o.cm,o.update)}function JR(o){var c=o.cm,f=c.display;o.updatedDisplay&&sd(c),o.barMeasure=ll(c),f.maxLineChanged&&!c.options.lineWrapping&&(o.adjustWidthTo=C0(c,f.maxLine,f.maxLine.text.length).left+3,c.display.sizerWidth=o.adjustWidthTo,o.barMeasure.scrollWidth=Math.max(f.scroller.clientWidth,f.sizer.offsetLeft+o.adjustWidthTo+_n(c)+c.display.barWidth),o.maxScrollLeft=Math.max(0,f.sizer.offsetLeft+o.adjustWidthTo-Rs(c))),(o.updatedDisplay||o.selectionChanged)&&(o.preparedSelection=f.input.prepareSelection())}function XR(o){var c=o.cm;o.adjustWidthTo!=null&&(c.display.sizer.style.minWidth=o.adjustWidthTo+"px",o.maxScrollLeft<c.doc.scrollLeft&&Vs(c,Math.min(c.display.scroller.scrollLeft,o.maxScrollLeft),!0),c.display.maxLineChanged=!1);var f=o.focus&&o.focus==le(Fe(c));o.preparedSelection&&c.display.input.showSelection(o.preparedSelection,f),(o.updatedDisplay||o.startHeight!=c.doc.height)&&Da(c,o.barMeasure),o.updatedDisplay&&up(c,o.barMeasure),o.selectionChanged&&np(c),c.state.focused&&o.updateInput&&c.display.input.reset(o.typing),f&&O0(o.cm)}function KR(o){var c=o.cm,f=c.display,p=c.doc;if(o.updatedDisplay&&G0(c,o.update),f.wheelStartX!=null&&(o.scrollTop!=null||o.scrollLeft!=null||o.scrollToPos)&&(f.wheelStartX=f.wheelStartY=null),o.scrollTop!=null&&F0(c,o.scrollTop,o.forceScroll),o.scrollLeft!=null&&Vs(c,o.scrollLeft,!0,!0),o.scrollToPos){var m=zR(c,ze(p,o.scrollToPos.from),ze(p,o.scrollToPos.to),o.scrollToPos.margin);UR(c,m)}var S=o.maybeHiddenMarkers,x=o.maybeUnhiddenMarkers;if(S)for(var E=0;E<S.length;++E)S[E].lines.length||St(S[E],"hide");if(x)for(var D=0;D<x.length;++D)x[D].lines.length&&St(x[D],"unhide");f.wrapper.offsetHeight&&(p.scrollTop=c.display.scroller.scrollTop),o.changeObjs&&St(c,"changes",c,o.changeObjs),o.update&&o.update.finish()}function Vi(o,c){if(o.curOp)return c();Bs(o);try{return c()}finally{_s(o)}}function $t(o,c){return function(){if(o.curOp)return c.apply(o,arguments);Bs(o);try{return c.apply(o,arguments)}finally{_s(o)}}}function ci(o){return function(){if(this.curOp)return o.apply(this,arguments);Bs(this);try{return o.apply(this,arguments)}finally{_s(this)}}}function Gt(o){return function(){var c=this.cm;if(!c||c.curOp)return o.apply(this,arguments);Bs(c);try{return o.apply(this,arguments)}finally{_s(c)}}}function dl(o,c){o.doc.highlightFrontier<o.display.viewTo&&o.state.highlight.set(c,ke(YR,o))}function YR(o){var c=o.doc;if(!(c.highlightFrontier>=o.display.viewTo)){var f=+new Date+o.options.workTime,p=Qo(o,c.highlightFrontier),m=[];c.iter(p.line,Math.min(c.first+c.size,o.display.viewTo+500),function(S){if(p.line>=o.display.viewFrom){var x=S.styles,E=S.text.length>o.options.maxHighlightLength?On(c.mode,p.state):null,D=Ky(o,S,p,!0);E&&(p.state=E),S.styles=D.styles;var A=S.styleClasses,z=D.classes;z?S.styleClasses=z:A&&(S.styleClasses=null);for(var W=!x||x.length!=S.styles.length||A!=z&&(!A||!z||A.bgClass!=z.bgClass||A.textClass!=z.textClass),X=0;!W&&X<x.length;++X)W=x[X]!=S.styles[X];W&&m.push(p.line),S.stateAfter=p.save(),p.nextLine()}else S.text.length<=o.options.maxHighlightLength&&_h(o,S.text,p),S.stateAfter=p.line%5==0?p.save():null,p.nextLine();if(+new Date>f)return dl(o,o.options.workDelay),!0}),c.highlightFrontier=p.line,c.modeFrontier=Math.max(c.modeFrontier,p.line),m.length&&Vi(o,function(){for(var S=0;S<m.length;S++)Xr(o,m[S],"text")})}}var ld=function(o,c,f){var p=o.display;this.viewport=c,this.visible=ad(p,o.doc,c),this.editorIsHidden=!p.wrapper.offsetWidth,this.wrapperHeight=p.wrapper.clientHeight,this.wrapperWidth=p.wrapper.clientWidth,this.oldDisplayWidth=Rs(o),this.force=f,this.dims=Qh(o),this.events=[]};ld.prototype.signal=function(o,c){Ni(o,c)&&this.events.push(arguments)},ld.prototype.finish=function(){for(var o=0;o<this.events.length;o++)St.apply(null,this.events[o])};function ZR(o){var c=o.display;!c.scrollbarsClipped&&c.scroller.offsetWidth&&(c.nativeBarWidth=c.scroller.offsetWidth-c.scroller.clientWidth,c.heightForcer.style.height=_n(o)+"px",c.sizer.style.marginBottom=-c.nativeBarWidth+"px",c.sizer.style.borderRightWidth=_n(o)+"px",c.scrollbarsClipped=!0)}function QR(o){if(o.hasFocus())return null;var c=le(Fe(o));if(!c||!Re(o.display.lineDiv,c))return null;var f={activeElt:c};if(window.getSelection){var p=Pe(o).getSelection();p.anchorNode&&p.extend&&Re(o.display.lineDiv,p.anchorNode)&&(f.anchorNode=p.anchorNode,f.anchorOffset=p.anchorOffset,f.focusNode=p.focusNode,f.focusOffset=p.focusOffset)}return f}function eM(o){if(!(!o||!o.activeElt||o.activeElt==le(Ge(o.activeElt)))&&(o.activeElt.focus(),!/^(INPUT|TEXTAREA)$/.test(o.activeElt.nodeName)&&o.anchorNode&&Re(document.body,o.anchorNode)&&Re(document.body,o.focusNode))){var c=o.activeElt.ownerDocument,f=c.defaultView.getSelection(),p=c.createRange();p.setEnd(o.anchorNode,o.anchorOffset),p.collapse(!1),f.removeAllRanges(),f.addRange(p),f.extend(o.focusNode,o.focusOffset)}}function lp(o,c){var f=o.display,p=o.doc;if(c.editorIsHidden)return Kr(o),!1;if(!c.force&&c.visible.from>=f.viewFrom&&c.visible.to<=f.viewTo&&(f.updateLineNumbers==null||f.updateLineNumbers>=f.viewTo)&&f.renderedView==f.view&&N0(o)==0)return!1;H0(o)&&(Kr(o),c.dims=Qh(o));var m=p.first+p.size,S=Math.max(c.visible.from-o.options.viewportMargin,p.first),x=Math.min(m,c.visible.to+o.options.viewportMargin);f.viewFrom<S&&S-f.viewFrom<20&&(S=Math.max(p.first,f.viewFrom)),f.viewTo>x&&f.viewTo-x<20&&(x=Math.min(m,f.viewTo)),cr&&(S=$h(o.doc,S),x=d0(o.doc,x));var E=S!=f.viewFrom||x!=f.viewTo||f.lastWrapHeight!=c.wrapperHeight||f.lastWrapWidth!=c.wrapperWidth;_R(o,S,x),f.viewOffset=dr(De(o.doc,f.viewFrom)),o.display.mover.style.top=f.viewOffset+"px";var D=N0(o);if(!E&&D==0&&!c.force&&f.renderedView==f.view&&(f.updateLineNumbers==null||f.updateLineNumbers>=f.viewTo))return!1;var A=QR(o);return D>4&&(f.lineDiv.style.display="none"),tM(o,f.updateLineNumbers,c.dims),D>4&&(f.lineDiv.style.display=""),f.renderedView=f.view,eM(A),O(f.cursorDiv),O(f.selectionDiv),f.gutters.style.height=f.sizer.style.minHeight=0,E&&(f.lastWrapHeight=c.wrapperHeight,f.lastWrapWidth=c.wrapperWidth,dl(o,400)),f.updateLineNumbers=null,!0}function G0(o,c){for(var f=c.viewport,p=!0;;p=!1){if(!p||!o.options.lineWrapping||c.oldDisplayWidth==Rs(o)){if(f&&f.top!=null&&(f={top:Math.min(o.doc.height+jh(o.display)-qh(o),f.top)}),c.visible=ad(o.display,o.doc,f),c.visible.from>=o.display.viewFrom&&c.visible.to<=o.display.viewTo)break}else p&&(c.visible=ad(o.display,o.doc,f));if(!lp(o,c))break;sd(o);var m=ll(o);sl(o),Da(o,m),up(o,m),c.force=!1}c.signal(o,"update",o),(o.display.viewFrom!=o.display.reportedViewFrom||o.display.viewTo!=o.display.reportedViewTo)&&(c.signal(o,"viewportChange",o,o.display.viewFrom,o.display.viewTo),o.display.reportedViewFrom=o.display.viewFrom,o.display.reportedViewTo=o.display.viewTo)}function cp(o,c){var f=new ld(o,c);if(lp(o,f)){sd(o),G0(o,f);var p=ll(o);sl(o),Da(o,p),up(o,p),f.finish()}}function tM(o,c,f){var p=o.display,m=o.options.lineNumbers,S=p.lineDiv,x=S.firstChild;function E(Q){var ne=Q.nextSibling;return h&&T&&o.display.currentWheelTarget==Q?Q.style.display="none":Q.parentNode.removeChild(Q),ne}for(var D=p.view,A=p.viewFrom,z=0;z<D.length;z++){var W=D[z];if(!W.hidden)if(!W.node||W.node.parentNode!=S){var X=DR(o,W,A,f);S.insertBefore(X,x)}else{for(;x!=W.node;)x=E(x);var J=m&&c!=null&&c<=A&&W.lineNumber;W.changes&&(Ce(W.changes,"gutter")>-1&&(J=!1),g0(o,W,A,f)),J&&(O(W.lineNumber),W.lineNumber.appendChild(document.createTextNode(de(o.options,A)))),x=W.node.nextSibling}A+=W.size}for(;x;)x=E(x)}function dp(o){var c=o.gutters.offsetWidth;o.sizer.style.marginLeft=c+"px",zt(o,"gutterChanged",o)}function up(o,c){o.display.sizer.style.minHeight=c.docHeight+"px",o.display.heightForcer.style.top=c.docHeight+"px",o.display.gutters.style.height=c.docHeight+o.display.barHeight+_n(o)+"px"}function W0(o){var c=o.display,f=c.view;if(!(!c.alignWidgets&&(!c.gutters.firstChild||!o.options.fixedGutter))){for(var p=ep(c)-c.scroller.scrollLeft+o.doc.scrollLeft,m=c.gutters.offsetWidth,S=p+"px",x=0;x<f.length;x++)if(!f[x].hidden){o.options.fixedGutter&&(f[x].gutter&&(f[x].gutter.style.left=S),f[x].gutterBackground&&(f[x].gutterBackground.style.left=S));var E=f[x].alignable;if(E)for(var D=0;D<E.length;D++)E[D].style.left=S}o.options.fixedGutter&&(c.gutters.style.left=p+m+"px")}}function H0(o){if(!o.options.lineNumbers)return!1;var c=o.doc,f=de(o.options,c.first+c.size-1),p=o.display;if(f.length!=p.lineNumChars){var m=p.measure.appendChild(_("div",[_("div",f)],"CodeMirror-linenumber CodeMirror-gutter-elt")),S=m.firstChild.offsetWidth,x=m.offsetWidth-S;return p.lineGutter.style.width="",p.lineNumInnerWidth=Math.max(S,p.lineGutter.offsetWidth-x)+1,p.lineNumWidth=p.lineNumInnerWidth+x,p.lineNumChars=p.lineNumInnerWidth?f.length:-1,p.lineGutter.style.width=p.lineNumWidth+"px",dp(o.display),!0}return!1}function hp(o,c){for(var f=[],p=!1,m=0;m<o.length;m++){var S=o[m],x=null;if(typeof S!="string"&&(x=S.style,S=S.className),S=="CodeMirror-linenumbers")if(c)p=!0;else continue;f.push({className:S,style:x})}return c&&!p&&f.push({className:"CodeMirror-linenumbers",style:null}),f}function j0(o){var c=o.gutters,f=o.gutterSpecs;O(c),o.lineGutter=null;for(var p=0;p<f.length;++p){var m=f[p],S=m.className,x=m.style,E=c.appendChild(_("div",null,"CodeMirror-gutter "+S));x&&(E.style.cssText=x),S=="CodeMirror-linenumbers"&&(o.lineGutter=E,E.style.width=(o.lineNumWidth||1)+"px")}c.style.display=f.length?"":"none",dp(o)}function ul(o){j0(o.display),Ci(o),W0(o)}function iM(o,c,f,p){var m=this;this.input=f,m.scrollbarFiller=_("div",null,"CodeMirror-scrollbar-filler"),m.scrollbarFiller.setAttribute("cm-not-content","true"),m.gutterFiller=_("div",null,"CodeMirror-gutter-filler"),m.gutterFiller.setAttribute("cm-not-content","true"),m.lineDiv=se("div",null,"CodeMirror-code"),m.selectionDiv=_("div",null,null,"position: relative; z-index: 1"),m.cursorDiv=_("div",null,"CodeMirror-cursors"),m.measure=_("div",null,"CodeMirror-measure"),m.lineMeasure=_("div",null,"CodeMirror-measure"),m.lineSpace=se("div",[m.measure,m.lineMeasure,m.selectionDiv,m.cursorDiv,m.lineDiv],null,"position: relative; outline: none");var S=se("div",[m.lineSpace],"CodeMirror-lines");m.mover=_("div",[S],null,"position: relative"),m.sizer=_("div",[m.mover],"CodeMirror-sizer"),m.sizerWidth=null,m.heightForcer=_("div",null,null,"position: absolute; height: "+Xe+"px; width: 1px;"),m.gutters=_("div",null,"CodeMirror-gutters"),m.lineGutter=null,m.scroller=_("div",[m.sizer,m.heightForcer,m.gutters],"CodeMirror-scroll"),m.scroller.setAttribute("tabIndex","-1"),m.wrapper=_("div",[m.scrollbarFiller,m.gutterFiller,m.scroller],"CodeMirror"),v&&y>=105&&(m.wrapper.style.clipPath="inset(0px)"),m.wrapper.setAttribute("translate","no"),d&&u<8&&(m.gutters.style.zIndex=-1,m.scroller.style.paddingRight=0),!h&&!(r&&P)&&(m.scroller.draggable=!0),o&&(o.appendChild?o.appendChild(m.wrapper):o(m.wrapper)),m.viewFrom=m.viewTo=c.first,m.reportedViewFrom=m.reportedViewTo=c.first,m.view=[],m.renderedView=null,m.externalMeasured=null,m.viewOffset=0,m.lastWrapHeight=m.lastWrapWidth=0,m.updateLineNumbers=null,m.nativeBarWidth=m.barHeight=m.barWidth=0,m.scrollbarsClipped=!1,m.lineNumWidth=m.lineNumInnerWidth=m.lineNumChars=null,m.alignWidgets=!1,m.cachedCharWidth=m.cachedTextHeight=m.cachedPaddingH=null,m.maxLine=null,m.maxLineLength=0,m.maxLineChanged=!1,m.wheelDX=m.wheelDY=m.wheelStartX=m.wheelStartY=null,m.shift=!1,m.selForContextMenu=null,m.activeTouch=null,m.gutterSpecs=hp(p.gutters,p.lineNumbers),j0(m),f.init(m)}var cd=0,hr=null;d?hr=-.53:r?hr=15:v?hr=-.7:w&&(hr=-1/3);function q0(o){var c=o.wheelDeltaX,f=o.wheelDeltaY;return c==null&&o.detail&&o.axis==o.HORIZONTAL_AXIS&&(c=o.detail),f==null&&o.detail&&o.axis==o.VERTICAL_AXIS?f=o.detail:f==null&&(f=o.wheelDelta),{x:c,y:f}}function nM(o){var c=q0(o);return c.x*=hr,c.y*=hr,c}function J0(o,c){v&&y==102&&(o.display.chromeScrollHack==null?o.display.sizer.style.pointerEvents="none":clearTimeout(o.display.chromeScrollHack),o.display.chromeScrollHack=setTimeout(function(){o.display.chromeScrollHack=null,o.display.sizer.style.pointerEvents=""},100));var f=q0(c),p=f.x,m=f.y,S=hr;c.deltaMode===0&&(p=c.deltaX,m=c.deltaY,S=1);var x=o.display,E=x.scroller,D=E.scrollWidth>E.clientWidth,A=E.scrollHeight>E.clientHeight;if(p&&D||m&&A){if(m&&T&&h){e:for(var z=c.target,W=x.view;z!=E;z=z.parentNode)for(var X=0;X<W.length;X++)if(W[X].node==z){o.display.currentWheelTarget=z;break e}}if(p&&!r&&!C&&S!=null){m&&A&&ol(o,Math.max(0,E.scrollTop+m*S)),Vs(o,Math.max(0,E.scrollLeft+p*S)),(!m||m&&A)&&ii(c),x.wheelStartX=null;return}if(m&&S!=null){var J=m*S,Q=o.doc.scrollTop,ne=Q+x.wrapper.clientHeight;J<0?Q=Math.max(0,Q+J-50):ne=Math.min(o.doc.height,ne+J+50),cp(o,{top:Q,bottom:ne})}cd<20&&c.deltaMode!==0&&(x.wheelStartX==null?(x.wheelStartX=E.scrollLeft,x.wheelStartY=E.scrollTop,x.wheelDX=p,x.wheelDY=m,setTimeout(function(){if(x.wheelStartX!=null){var ue=E.scrollLeft-x.wheelStartX,pe=E.scrollTop-x.wheelStartY,Se=pe&&x.wheelDY&&pe/x.wheelDY||ue&&x.wheelDX&&ue/x.wheelDX;x.wheelStartX=x.wheelStartY=null,Se&&(hr=(hr*cd+Se)/(cd+1),++cd)}},200)):(x.wheelDX+=p,x.wheelDY+=m))}}var Wi=function(o,c){this.ranges=o,this.primIndex=c};Wi.prototype.primary=function(){return this.ranges[this.primIndex]},Wi.prototype.equals=function(o){if(o==this)return!0;if(o.primIndex!=this.primIndex||o.ranges.length!=this.ranges.length)return!1;for(var c=0;c<this.ranges.length;c++){var f=this.ranges[c],p=o.ranges[c];if(!et(f.anchor,p.anchor)||!et(f.head,p.head))return!1}return!0},Wi.prototype.deepCopy=function(){for(var o=[],c=0;c<this.ranges.length;c++)o[c]=new tt(Ut(this.ranges[c].anchor),Ut(this.ranges[c].head));return new Wi(o,this.primIndex)},Wi.prototype.somethingSelected=function(){for(var o=0;o<this.ranges.length;o++)if(!this.ranges[o].empty())return!0;return!1},Wi.prototype.contains=function(o,c){c||(c=o);for(var f=0;f<this.ranges.length;f++){var p=this.ranges[f];if(me(c,p.from())>=0&&me(o,p.to())<=0)return f}return-1};var tt=function(o,c){this.anchor=o,this.head=c};tt.prototype.from=function(){return ba(this.anchor,this.head)},tt.prototype.to=function(){return wi(this.anchor,this.head)},tt.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch};function Cn(o,c,f){var p=o&&o.options.selectionsMayTouch,m=c[f];c.sort(function(X,J){return me(X.from(),J.from())}),f=Ce(c,m);for(var S=1;S<c.length;S++){var x=c[S],E=c[S-1],D=me(E.to(),x.from());if(p&&!x.empty()?D>0:D>=0){var A=ba(E.from(),x.from()),z=wi(E.to(),x.to()),W=E.empty()?x.from()==x.head:E.from()==E.head;S<=f&&--f,c.splice(--S,2,new tt(W?z:A,W?A:z))}}return new Wi(c,f)}function Yr(o,c){return new Wi([new tt(o,c||o)],0)}function Zr(o){return o.text?Z(o.from.line+o.text.length-1,je(o.text).length+(o.text.length==1?o.from.ch:0)):o.to}function X0(o,c){if(me(o,c.from)<0)return o;if(me(o,c.to)<=0)return Zr(c);var f=o.line+c.text.length-(c.to.line-c.from.line)-1,p=o.ch;return o.line==c.to.line&&(p+=Zr(c).ch-c.to.ch),Z(f,p)}function pp(o,c){for(var f=[],p=0;p<o.sel.ranges.length;p++){var m=o.sel.ranges[p];f.push(new tt(X0(m.anchor,c),X0(m.head,c)))}return Cn(o.cm,f,o.sel.primIndex)}function K0(o,c,f){return o.line==c.line?Z(f.line,o.ch-c.ch+f.ch):Z(f.line+(o.line-c.line),o.ch)}function rM(o,c,f){for(var p=[],m=Z(o.first,0),S=m,x=0;x<c.length;x++){var E=c[x],D=K0(E.from,m,S),A=K0(Zr(E),m,S);if(m=E.to,S=A,f=="around"){var z=o.sel.ranges[x],W=me(z.head,z.anchor)<0;p[x]=new tt(W?A:D,W?D:A)}else p[x]=new tt(D,D)}return new Wi(p,o.sel.primIndex)}function fp(o){o.doc.mode=va(o.options,o.doc.modeOption),hl(o)}function hl(o){o.doc.iter(function(c){c.stateAfter&&(c.stateAfter=null),c.styles&&(c.styles=null)}),o.doc.modeFrontier=o.doc.highlightFrontier=o.doc.first,dl(o,100),o.state.modeGen++,o.curOp&&Ci(o)}function Y0(o,c){return c.from.ch==0&&c.to.ch==0&&je(c.text)==""&&(!o.cm||o.cm.options.wholeLineUpdateBefore)}function gp(o,c,f,p){function m(Se){return f?f[Se]:null}function S(Se,fe,xe){hR(Se,fe,xe,p),zt(Se,"change",Se,c)}function x(Se,fe){for(var xe=[],Be=Se;Be<fe;++Be)xe.push(new wa(A[Be],m(Be),p));return xe}var E=c.from,D=c.to,A=c.text,z=De(o,E.line),W=De(o,D.line),X=je(A),J=m(A.length-1),Q=D.line-E.line;if(c.full)o.insert(0,x(0,A.length)),o.remove(A.length,o.size-A.length);else if(Y0(o,c)){var ne=x(0,A.length-1);S(W,W.text,J),Q&&o.remove(E.line,Q),ne.length&&o.insert(E.line,ne)}else if(z==W)if(A.length==1)S(z,z.text.slice(0,E.ch)+X+z.text.slice(D.ch),J);else{var ue=x(1,A.length-1);ue.push(new wa(X+z.text.slice(D.ch),J,p)),S(z,z.text.slice(0,E.ch)+A[0],m(0)),o.insert(E.line+1,ue)}else if(A.length==1)S(z,z.text.slice(0,E.ch)+A[0]+W.text.slice(D.ch),m(0)),o.remove(E.line+1,Q);else{S(z,z.text.slice(0,E.ch)+A[0],m(0)),S(W,X+W.text.slice(D.ch),J);var pe=x(1,A.length-1);Q>1&&o.remove(E.line+1,Q-1),o.insert(E.line+1,pe)}zt(o,"change",o,c)}function Qr(o,c,f){function p(m,S,x){if(m.linked)for(var E=0;E<m.linked.length;++E){var D=m.linked[E];if(D.doc!=S){var A=x&&D.sharedHist;f&&!A||(c(D.doc,A),p(D.doc,m,A))}}}p(o,null,!0)}function Z0(o,c){if(c.cm)throw new Error("This document is already in use.");o.doc=c,c.cm=o,tp(o),fp(o),Q0(o),o.options.direction=c.direction,o.options.lineWrapping||Wh(o),o.options.mode=c.modeOption,Ci(o)}function Q0(o){(o.doc.direction=="rtl"?we:U)(o.display.lineDiv,"CodeMirror-rtl")}function sM(o){Vi(o,function(){Q0(o),Ci(o)})}function dd(o){this.done=[],this.undone=[],this.undoDepth=o?o.undoDepth:1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=o?o.maxGeneration:1}function mp(o,c){var f={from:Ut(c.from),to:Zr(c),text:lr(o,c.from,c.to)};return iS(o,f,c.from.line,c.to.line+1),Qr(o,function(p){return iS(p,f,c.from.line,c.to.line+1)},!0),f}function eS(o){for(;o.length;){var c=je(o);if(c.ranges)o.pop();else break}}function aM(o,c){if(c)return eS(o.done),je(o.done);if(o.done.length&&!je(o.done).ranges)return je(o.done);if(o.done.length>1&&!o.done[o.done.length-2].ranges)return o.done.pop(),je(o.done)}function tS(o,c,f,p){var m=o.history;m.undone.length=0;var S=+new Date,x,E;if((m.lastOp==p||m.lastOrigin==c.origin&&c.origin&&(c.origin.charAt(0)=="+"&&m.lastModTime>S-(o.cm?o.cm.options.historyEventDelay:500)||c.origin.charAt(0)=="*"))&&(x=aM(m,m.lastOp==p)))E=je(x.changes),me(c.from,c.to)==0&&me(c.from,E.to)==0?E.to=Zr(c):x.changes.push(mp(o,c));else{var D=je(m.done);for((!D||!D.ranges)&&ud(o.sel,m.done),x={changes:[mp(o,c)],generation:m.generation},m.done.push(x);m.done.length>m.undoDepth;)m.done.shift(),m.done[0].ranges||m.done.shift()}m.done.push(f),m.generation=++m.maxGeneration,m.lastModTime=m.lastSelTime=S,m.lastOp=m.lastSelOp=p,m.lastOrigin=m.lastSelOrigin=c.origin,E||St(o,"historyAdded")}function oM(o,c,f,p){var m=c.charAt(0);return m=="*"||m=="+"&&f.ranges.length==p.ranges.length&&f.somethingSelected()==p.somethingSelected()&&new Date-o.history.lastSelTime<=(o.cm?o.cm.options.historyEventDelay:500)}function lM(o,c,f,p){var m=o.history,S=p&&p.origin;f==m.lastSelOp||S&&m.lastSelOrigin==S&&(m.lastModTime==m.lastSelTime&&m.lastOrigin==S||oM(o,S,je(m.done),c))?m.done[m.done.length-1]=c:ud(c,m.done),m.lastSelTime=+new Date,m.lastSelOrigin=S,m.lastSelOp=f,p&&p.clearRedo!==!1&&eS(m.undone)}function ud(o,c){var f=je(c);f&&f.ranges&&f.equals(o)||c.push(o)}function iS(o,c,f,p){var m=c["spans_"+o.id],S=0;o.iter(Math.max(o.first,f),Math.min(o.first+o.size,p),function(x){x.markedSpans&&((m||(m=c["spans_"+o.id]={}))[S]=x.markedSpans),++S})}function cM(o){if(!o)return null;for(var c,f=0;f<o.length;++f)o[f].marker.explicitlyCleared?c||(c=o.slice(0,f)):c&&c.push(o[f]);return c?c.length?c:null:o}function dM(o,c){var f=c["spans_"+o.id];if(!f)return null;for(var p=[],m=0;m<c.text.length;++m)p.push(cM(f[m]));return p}function nS(o,c){var f=dM(o,c),p=Uh(o,c);if(!f)return p;if(!p)return f;for(var m=0;m<f.length;++m){var S=f[m],x=p[m];if(S&&x)e:for(var E=0;E<x.length;++E){for(var D=x[E],A=0;A<S.length;++A)if(S[A].marker==D.marker)continue e;S.push(D)}else x&&(f[m]=x)}return f}function Pa(o,c,f){for(var p=[],m=0;m<o.length;++m){var S=o[m];if(S.ranges){p.push(f?Wi.prototype.deepCopy.call(S):S);continue}var x=S.changes,E=[];p.push({changes:E});for(var D=0;D<x.length;++D){var A=x[D],z=void 0;if(E.push({from:A.from,to:A.to,text:A.text}),c)for(var W in A)(z=W.match(/^spans_(\d+)$/))&&Ce(c,Number(z[1]))>-1&&(je(E)[W]=A[W],delete A[W])}}return p}function vp(o,c,f,p){if(p){var m=o.anchor;if(f){var S=me(c,m)<0;S!=me(f,m)<0?(m=c,c=f):S!=me(c,f)<0&&(c=f)}return new tt(m,c)}else return new tt(f||c,c)}function hd(o,c,f,p,m){m==null&&(m=o.cm&&(o.cm.display.shift||o.extend)),ni(o,new Wi([vp(o.sel.primary(),c,f,m)],0),p)}function rS(o,c,f){for(var p=[],m=o.cm&&(o.cm.display.shift||o.extend),S=0;S<o.sel.ranges.length;S++)p[S]=vp(o.sel.ranges[S],c[S],null,m);var x=Cn(o.cm,p,o.sel.primIndex);ni(o,x,f)}function yp(o,c,f,p){var m=o.sel.ranges.slice(0);m[c]=f,ni(o,Cn(o.cm,m,o.sel.primIndex),p)}function sS(o,c,f,p){ni(o,Yr(c,f),p)}function uM(o,c,f){var p={ranges:c.ranges,update:function(m){this.ranges=[];for(var S=0;S<m.length;S++)this.ranges[S]=new tt(ze(o,m[S].anchor),ze(o,m[S].head))},origin:f&&f.origin};return St(o,"beforeSelectionChange",o,p),o.cm&&St(o.cm,"beforeSelectionChange",o.cm,p),p.ranges!=c.ranges?Cn(o.cm,p.ranges,p.ranges.length-1):c}function aS(o,c,f){var p=o.history.done,m=je(p);m&&m.ranges?(p[p.length-1]=c,pd(o,c,f)):ni(o,c,f)}function ni(o,c,f){pd(o,c,f),lM(o,o.sel,o.cm?o.cm.curOp.id:NaN,f)}function pd(o,c,f){(Ni(o,"beforeSelectionChange")||o.cm&&Ni(o.cm,"beforeSelectionChange"))&&(c=uM(o,c,f));var p=f&&f.bias||(me(c.primary().head,o.sel.primary().head)<0?-1:1);oS(o,cS(o,c,p,!0)),!(f&&f.scroll===!1)&&o.cm&&o.cm.getOption("readOnly")!="nocursor"&&Ta(o.cm)}function oS(o,c){c.equals(o.sel)||(o.sel=c,o.cm&&(o.cm.curOp.updateInput=1,o.cm.curOp.selectionChanged=!0,Yi(o.cm)),zt(o,"cursorActivity",o))}function lS(o){oS(o,cS(o,o.sel,null,!1))}function cS(o,c,f,p){for(var m,S=0;S<c.ranges.length;S++){var x=c.ranges[S],E=c.ranges.length==o.sel.ranges.length&&o.sel.ranges[S],D=fd(o,x.anchor,E&&E.anchor,f,p),A=x.head==x.anchor?D:fd(o,x.head,E&&E.head,f,p);(m||D!=x.anchor||A!=x.head)&&(m||(m=c.ranges.slice(0,S)),m[S]=new tt(D,A))}return m?Cn(o.cm,m,c.primIndex):c}function Ia(o,c,f,p,m){var S=De(o,c.line);if(S.markedSpans)for(var x=0;x<S.markedSpans.length;++x){var E=S.markedSpans[x],D=E.marker,A="selectLeft"in D?!D.selectLeft:D.inclusiveLeft,z="selectRight"in D?!D.selectRight:D.inclusiveRight;if((E.from==null||(A?E.from<=c.ch:E.from<c.ch))&&(E.to==null||(z?E.to>=c.ch:E.to>c.ch))){if(m&&(St(D,"beforeCursorEnter"),D.explicitlyCleared))if(S.markedSpans){--x;continue}else break;if(!D.atomic)continue;if(f){var W=D.find(p<0?1:-1),X=void 0;if((p<0?z:A)&&(W=dS(o,W,-p,W&&W.line==c.line?S:null)),W&&W.line==c.line&&(X=me(W,f))&&(p<0?X<0:X>0))return Ia(o,W,c,p,m)}var J=D.find(p<0?-1:1);return(p<0?A:z)&&(J=dS(o,J,p,J.line==c.line?S:null)),J?Ia(o,J,c,p,m):null}}return c}function fd(o,c,f,p,m){var S=p||1,x=Ia(o,c,f,S,m)||!m&&Ia(o,c,f,S,!0)||Ia(o,c,f,-S,m)||!m&&Ia(o,c,f,-S,!0);return x||(o.cantEdit=!0,Z(o.first,0))}function dS(o,c,f,p){return f<0&&c.ch==0?c.line>o.first?ze(o,Z(c.line-1)):null:f>0&&c.ch==(p||De(o,c.line)).text.length?c.line<o.first+o.size-1?Z(c.line+1,0):null:new Z(c.line,c.ch+f)}function uS(o){o.setSelection(Z(o.firstLine(),0),Z(o.lastLine()),Xt)}function hS(o,c,f){var p={canceled:!1,from:c.from,to:c.to,text:c.text,origin:c.origin,cancel:function(){return p.canceled=!0}};return f&&(p.update=function(m,S,x,E){m&&(p.from=ze(o,m)),S&&(p.to=ze(o,S)),x&&(p.text=x),E!==void 0&&(p.origin=E)}),St(o,"beforeChange",o,p),o.cm&&St(o.cm,"beforeChange",o.cm,p),p.canceled?(o.cm&&(o.cm.curOp.updateInput=2),null):{from:p.from,to:p.to,text:p.text,origin:p.origin}}function Ra(o,c,f){if(o.cm){if(!o.cm.curOp)return $t(o.cm,Ra)(o,c,f);if(o.cm.state.suppressEdits)return}if(!((Ni(o,"beforeChange")||o.cm&&Ni(o.cm,"beforeChange"))&&(c=hS(o,c,!0),!c))){var p=n0&&!f&&lR(o,c.from,c.to);if(p)for(var m=p.length-1;m>=0;--m)pS(o,{from:p[m].from,to:p[m].to,text:m?[""]:c.text,origin:c.origin});else pS(o,c)}}function pS(o,c){if(!(c.text.length==1&&c.text[0]==""&&me(c.from,c.to)==0)){var f=pp(o,c);tS(o,c,f,o.cm?o.cm.curOp.id:NaN),pl(o,c,f,Uh(o,c));var p=[];Qr(o,function(m,S){!S&&Ce(p,m.history)==-1&&(vS(m.history,c),p.push(m.history)),pl(m,c,null,Uh(m,c))})}}function gd(o,c,f){var p=o.cm&&o.cm.state.suppressEdits;if(!(p&&!f)){for(var m=o.history,S,x=o.sel,E=c=="undo"?m.done:m.undone,D=c=="undo"?m.undone:m.done,A=0;A<E.length&&(S=E[A],!(f?S.ranges&&!S.equals(o.sel):!S.ranges));A++);if(A!=E.length){for(m.lastOrigin=m.lastSelOrigin=null;;)if(S=E.pop(),S.ranges){if(ud(S,D),f&&!S.equals(o.sel)){ni(o,S,{clearRedo:!1});return}x=S}else if(p){E.push(S);return}else break;var z=[];ud(x,D),D.push({changes:z,generation:m.generation}),m.generation=S.generation||++m.maxGeneration;for(var W=Ni(o,"beforeChange")||o.cm&&Ni(o.cm,"beforeChange"),X=function(ne){var ue=S.changes[ne];if(ue.origin=c,W&&!hS(o,ue,!1))return E.length=0,{};z.push(mp(o,ue));var pe=ne?pp(o,ue):je(E);pl(o,ue,pe,nS(o,ue)),!ne&&o.cm&&o.cm.scrollIntoView({from:ue.from,to:Zr(ue)});var Se=[];Qr(o,function(fe,xe){!xe&&Ce(Se,fe.history)==-1&&(vS(fe.history,ue),Se.push(fe.history)),pl(fe,ue,null,nS(fe,ue))})},J=S.changes.length-1;J>=0;--J){var Q=X(J);if(Q)return Q.v}}}}function fS(o,c){if(c!=0&&(o.first+=c,o.sel=new Wi(Ki(o.sel.ranges,function(m){return new tt(Z(m.anchor.line+c,m.anchor.ch),Z(m.head.line+c,m.head.ch))}),o.sel.primIndex),o.cm)){Ci(o.cm,o.first,o.first-c,c);for(var f=o.cm.display,p=f.viewFrom;p<f.viewTo;p++)Xr(o.cm,p,"gutter")}}function pl(o,c,f,p){if(o.cm&&!o.cm.curOp)return $t(o.cm,pl)(o,c,f,p);if(c.to.line<o.first){fS(o,c.text.length-1-(c.to.line-c.from.line));return}if(!(c.from.line>o.lastLine())){if(c.from.line<o.first){var m=c.text.length-1-(o.first-c.from.line);fS(o,m),c={from:Z(o.first,0),to:Z(c.to.line+m,c.to.ch),text:[je(c.text)],origin:c.origin}}var S=o.lastLine();c.to.line>S&&(c={from:c.from,to:Z(S,De(o,S).text.length),text:[c.text[0]],origin:c.origin}),c.removed=lr(o,c.from,c.to),f||(f=pp(o,c)),o.cm?hM(o.cm,c,p):gp(o,c,p),pd(o,f,Xt),o.cantEdit&&fd(o,Z(o.firstLine(),0))&&(o.cantEdit=!1)}}function hM(o,c,f){var p=o.doc,m=o.display,S=c.from,x=c.to,E=!1,D=S.line;o.options.lineWrapping||(D=N(bn(De(p,S.line))),p.iter(D,x.line+1,function(J){if(J==m.maxLine)return E=!0,!0})),p.sel.contains(c.from,c.to)>-1&&Yi(o),gp(p,c,f,A0(o)),o.options.lineWrapping||(p.iter(D,S.line+c.text.length,function(J){var Q=Zc(J);Q>m.maxLineLength&&(m.maxLine=J,m.maxLineLength=Q,m.maxLineChanged=!0,E=!1)}),E&&(o.curOp.updateMaxLine=!0)),tR(p,S.line),dl(o,400);var A=c.text.length-(x.line-S.line)-1;c.full?Ci(o):S.line==x.line&&c.text.length==1&&!Y0(o.doc,c)?Xr(o,S.line,"text"):Ci(o,S.line,x.line+1,A);var z=Ni(o,"changes"),W=Ni(o,"change");if(W||z){var X={from:S,to:x,text:c.text,removed:c.removed,origin:c.origin};W&&zt(o,"change",o,X),z&&(o.curOp.changeObjs||(o.curOp.changeObjs=[])).push(X)}o.display.selForContextMenu=null}function Ma(o,c,f,p,m){var S;p||(p=f),me(p,f)<0&&(S=[p,f],f=S[0],p=S[1]),typeof c=="string"&&(c=o.splitLines(c)),Ra(o,{from:f,to:p,text:c,origin:m})}function gS(o,c,f,p){f<o.line?o.line+=p:c<o.line&&(o.line=c,o.ch=0)}function mS(o,c,f,p){for(var m=0;m<o.length;++m){var S=o[m],x=!0;if(S.ranges){S.copied||(S=o[m]=S.deepCopy(),S.copied=!0);for(var E=0;E<S.ranges.length;E++)gS(S.ranges[E].anchor,c,f,p),gS(S.ranges[E].head,c,f,p);continue}for(var D=0;D<S.changes.length;++D){var A=S.changes[D];if(f<A.from.line)A.from=Z(A.from.line+p,A.from.ch),A.to=Z(A.to.line+p,A.to.ch);else if(c<=A.to.line){x=!1;break}}x||(o.splice(0,m+1),m=0)}}function vS(o,c){var f=c.from.line,p=c.to.line,m=c.text.length-(p-f)-1;mS(o.done,f,p,m),mS(o.undone,f,p,m)}function fl(o,c,f,p){var m=c,S=c;return typeof c=="number"?S=De(o,Jy(o,c)):m=N(c),m==null?null:(p(S,m)&&o.cm&&Xr(o.cm,m,f),S)}function gl(o){this.lines=o,this.parent=null;for(var c=0,f=0;f<o.length;++f)o[f].parent=this,c+=o[f].height;this.height=c}gl.prototype={chunkSize:function(){return this.lines.length},removeInner:function(o,c){for(var f=o,p=o+c;f<p;++f){var m=this.lines[f];this.height-=m.height,pR(m),zt(m,"delete")}this.lines.splice(o,c)},collapse:function(o){o.push.apply(o,this.lines)},insertInner:function(o,c,f){this.height+=f,this.lines=this.lines.slice(0,o).concat(c).concat(this.lines.slice(o));for(var p=0;p<c.length;++p)c[p].parent=this},iterN:function(o,c,f){for(var p=o+c;o<p;++o)if(f(this.lines[o]))return!0}};function ml(o){this.children=o;for(var c=0,f=0,p=0;p<o.length;++p){var m=o[p];c+=m.chunkSize(),f+=m.height,m.parent=this}this.size=c,this.height=f,this.parent=null}ml.prototype={chunkSize:function(){return this.size},removeInner:function(o,c){this.size-=c;for(var f=0;f<this.children.length;++f){var p=this.children[f],m=p.chunkSize();if(o<m){var S=Math.min(c,m-o),x=p.height;if(p.removeInner(o,S),this.height-=x-p.height,m==S&&(this.children.splice(f--,1),p.parent=null),(c-=S)==0)break;o=0}else o-=m}if(this.size-c<25&&(this.children.length>1||!(this.children[0]instanceof gl))){var E=[];this.collapse(E),this.children=[new gl(E)],this.children[0].parent=this}},collapse:function(o){for(var c=0;c<this.children.length;++c)this.children[c].collapse(o)},insertInner:function(o,c,f){this.size+=c.length,this.height+=f;for(var p=0;p<this.children.length;++p){var m=this.children[p],S=m.chunkSize();if(o<=S){if(m.insertInner(o,c,f),m.lines&&m.lines.length>50){for(var x=m.lines.length%25+25,E=x;E<m.lines.length;){var D=new gl(m.lines.slice(E,E+=25));m.height-=D.height,this.children.splice(++p,0,D),D.parent=this}m.lines=m.lines.slice(0,x),this.maybeSpill()}break}o-=S}},maybeSpill:function(){if(!(this.children.length<=10)){var o=this;do{var c=o.children.splice(o.children.length-5,5),f=new ml(c);if(o.parent){o.size-=f.size,o.height-=f.height;var p=Ce(o.parent.children,o);o.parent.children.splice(p+1,0,f)}else{var m=new ml(o.children);m.parent=o,o.children=[m,f],o=m}f.parent=o.parent}while(o.children.length>10);o.parent.maybeSpill()}},iterN:function(o,c,f){for(var p=0;p<this.children.length;++p){var m=this.children[p],S=m.chunkSize();if(o<S){var x=Math.min(c,S-o);if(m.iterN(o,x,f))return!0;if((c-=x)==0)break;o=0}else o-=S}}};var vl=function(o,c,f){if(f)for(var p in f)f.hasOwnProperty(p)&&(this[p]=f[p]);this.doc=o,this.node=c};vl.prototype.clear=function(){var o=this.doc.cm,c=this.line.widgets,f=this.line,p=N(f);if(!(p==null||!c)){for(var m=0;m<c.length;++m)c[m]==this&&c.splice(m--,1);c.length||(f.widgets=null);var S=nl(this);Gi(f,Math.max(0,f.height-S)),o&&(Vi(o,function(){yS(o,f,-S),Xr(o,p,"widget")}),zt(o,"lineWidgetCleared",o,this,p))}},vl.prototype.changed=function(){var o=this,c=this.height,f=this.doc.cm,p=this.line;this.height=null;var m=nl(this)-c;m&&(Jr(this.doc,p)||Gi(p,p.height+m),f&&Vi(f,function(){f.curOp.forceUpdate=!0,yS(f,p,m),zt(f,"lineWidgetChanged",f,o,N(p))}))},gn(vl);function yS(o,c,f){dr(c)<(o.curOp&&o.curOp.scrollTop||o.doc.scrollTop)&&op(o,f)}function pM(o,c,f,p){var m=new vl(o,f,p),S=o.cm;return S&&m.noHScroll&&(S.display.alignWidgets=!0),fl(o,c,"widget",function(x){var E=x.widgets||(x.widgets=[]);if(m.insertAt==null?E.push(m):E.splice(Math.min(E.length,Math.max(0,m.insertAt)),0,m),m.line=x,S&&!Jr(o,x)){var D=dr(x)<o.scrollTop;Gi(x,x.height+nl(m)),D&&op(S,m.height),S.curOp.forceUpdate=!0}return!0}),S&&zt(S,"lineWidgetAdded",S,m,typeof c=="number"?c:N(c)),m}var SS=0,es=function(o,c){this.lines=[],this.type=c,this.doc=o,this.id=++SS};es.prototype.clear=function(){if(!this.explicitlyCleared){var o=this.doc.cm,c=o&&!o.curOp;if(c&&Bs(o),Ni(this,"clear")){var f=this.find();f&&zt(this,"clear",f.from,f.to)}for(var p=null,m=null,S=0;S<this.lines.length;++S){var x=this.lines[S],E=el(x.markedSpans,this);o&&!this.collapsed?Xr(o,N(x),"text"):o&&(E.to!=null&&(m=N(x)),E.from!=null&&(p=N(x))),x.markedSpans=rR(x.markedSpans,E),E.from==null&&this.collapsed&&!Jr(this.doc,x)&&o&&Gi(x,ka(o.display))}if(o&&this.collapsed&&!o.options.lineWrapping)for(var D=0;D<this.lines.length;++D){var A=bn(this.lines[D]),z=Zc(A);z>o.display.maxLineLength&&(o.display.maxLine=A,o.display.maxLineLength=z,o.display.maxLineChanged=!0)}p!=null&&o&&this.collapsed&&Ci(o,p,m+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,o&&lS(o.doc)),o&&zt(o,"markerCleared",o,this,p,m),c&&_s(o),this.parent&&this.parent.clear()}},es.prototype.find=function(o,c){o==null&&this.type=="bookmark"&&(o=1);for(var f,p,m=0;m<this.lines.length;++m){var S=this.lines[m],x=el(S.markedSpans,this);if(x.from!=null&&(f=Z(c?S:N(S),x.from),o==-1))return f;if(x.to!=null&&(p=Z(c?S:N(S),x.to),o==1))return p}return f&&{from:f,to:p}},es.prototype.changed=function(){var o=this,c=this.find(-1,!0),f=this,p=this.doc.cm;!c||!p||Vi(p,function(){var m=c.line,S=N(c.line),x=Jh(p,S);if(x&&(E0(x),p.curOp.selectionChanged=p.curOp.forceUpdate=!0),p.curOp.updateMaxLine=!0,!Jr(f.doc,m)&&f.height!=null){var E=f.height;f.height=null;var D=nl(f)-E;D&&Gi(m,m.height+D)}zt(p,"markerChanged",p,o)})},es.prototype.attachLine=function(o){if(!this.lines.length&&this.doc.cm){var c=this.doc.cm.curOp;(!c.maybeHiddenMarkers||Ce(c.maybeHiddenMarkers,this)==-1)&&(c.maybeUnhiddenMarkers||(c.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(o)},es.prototype.detachLine=function(o){if(this.lines.splice(Ce(this.lines,o),1),!this.lines.length&&this.doc.cm){var c=this.doc.cm.curOp;(c.maybeHiddenMarkers||(c.maybeHiddenMarkers=[])).push(this)}},gn(es);function Aa(o,c,f,p,m){if(p&&p.shared)return fM(o,c,f,p,m);if(o.cm&&!o.cm.curOp)return $t(o.cm,Aa)(o,c,f,p,m);var S=new es(o,m),x=me(c,f);if(p&&Me(p,S,!1),x>0||x==0&&S.clearWhenEmpty!==!1)return S;if(S.replacedWith&&(S.collapsed=!0,S.widgetNode=se("span",[S.replacedWith],"CodeMirror-widget"),p.handleMouseEvents||S.widgetNode.setAttribute("cm-ignore-events","true"),p.insertLeft&&(S.widgetNode.insertLeft=!0)),S.collapsed){if(c0(o,c.line,c,f,S)||c.line!=f.line&&c0(o,f.line,c,f,S))throw new Error("Inserting collapsed marker partially overlapping an existing one");nR()}S.addToHistory&&tS(o,{from:c,to:f,origin:"markText"},o.sel,NaN);var E=c.line,D=o.cm,A;if(o.iter(E,f.line+1,function(W){D&&S.collapsed&&!D.options.lineWrapping&&bn(W)==D.display.maxLine&&(A=!0),S.collapsed&&E!=c.line&&Gi(W,0),sR(W,new Jc(S,E==c.line?c.ch:null,E==f.line?f.ch:null),o.cm&&o.cm.curOp),++E}),S.collapsed&&o.iter(c.line,f.line+1,function(W){Jr(o,W)&&Gi(W,0)}),S.clearOnEnter&&Ve(S,"beforeCursorEnter",function(){return S.clear()}),S.readOnly&&(iR(),(o.history.done.length||o.history.undone.length)&&o.clearHistory()),S.collapsed&&(S.id=++SS,S.atomic=!0),D){if(A&&(D.curOp.updateMaxLine=!0),S.collapsed)Ci(D,c.line,f.line+1);else if(S.className||S.startStyle||S.endStyle||S.css||S.attributes||S.title)for(var z=c.line;z<=f.line;z++)Xr(D,z,"text");S.atomic&&lS(D.doc),zt(D,"markerAdded",D,S)}return S}var yl=function(o,c){this.markers=o,this.primary=c;for(var f=0;f<o.length;++f)o[f].parent=this};yl.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var o=0;o<this.markers.length;++o)this.markers[o].clear();zt(this,"clear")}},yl.prototype.find=function(o,c){return this.primary.find(o,c)},gn(yl);function fM(o,c,f,p,m){p=Me(p),p.shared=!1;var S=[Aa(o,c,f,p,m)],x=S[0],E=p.widgetNode;return Qr(o,function(D){E&&(p.widgetNode=E.cloneNode(!0)),S.push(Aa(D,ze(D,c),ze(D,f),p,m));for(var A=0;A<D.linked.length;++A)if(D.linked[A].isParent)return;x=je(S)}),new yl(S,x)}function bS(o){return o.findMarks(Z(o.first,0),o.clipPos(Z(o.lastLine())),function(c){return c.parent})}function gM(o,c){for(var f=0;f<c.length;f++){var p=c[f],m=p.find(),S=o.clipPos(m.from),x=o.clipPos(m.to);if(me(S,x)){var E=Aa(o,S,x,p.primary,p.primary.type);p.markers.push(E),E.parent=p}}}function mM(o){for(var c=function(p){var m=o[p],S=[m.primary.doc];Qr(m.primary.doc,function(D){return S.push(D)});for(var x=0;x<m.markers.length;x++){var E=m.markers[x];Ce(S,E.doc)==-1&&(E.parent=null,m.markers.splice(x--,1))}},f=0;f<o.length;f++)c(f)}var vM=0,xi=function(o,c,f,p,m){if(!(this instanceof xi))return new xi(o,c,f,p,m);f==null&&(f=0),ml.call(this,[new gl([new wa("",null)])]),this.first=f,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=f;var S=Z(f,0);this.sel=Yr(S),this.history=new dd(null),this.id=++vM,this.modeOption=c,this.lineSep=p,this.direction=m=="rtl"?"rtl":"ltr",this.extend=!1,typeof o=="string"&&(o=this.splitLines(o)),gp(this,{from:S,to:S,text:o}),ni(this,Yr(S),Xt)};xi.prototype=fn(ml.prototype,{constructor:xi,iter:function(o,c,f){f?this.iterN(o-this.first,c-o,f):this.iterN(this.first,this.first+this.size,o)},insert:function(o,c){for(var f=0,p=0;p<c.length;++p)f+=c[p].height;this.insertInner(o-this.first,c,f)},remove:function(o,c){this.removeInner(o-this.first,c)},getValue:function(o){var c=Zo(this,this.first,this.first+this.size);return o===!1?c:c.join(o||this.lineSeparator())},setValue:Gt(function(o){var c=Z(this.first,0),f=this.first+this.size-1;Ra(this,{from:c,to:Z(f,De(this,f).text.length),text:this.splitLines(o),origin:"setValue",full:!0},!0),this.cm&&al(this.cm,0,0),ni(this,Yr(c),Xt)}),replaceRange:function(o,c,f,p){c=ze(this,c),f=f?ze(this,f):c,Ma(this,o,c,f,p)},getRange:function(o,c,f){var p=lr(this,ze(this,o),ze(this,c));return f===!1?p:f===""?p.join(""):p.join(f||this.lineSeparator())},getLine:function(o){var c=this.getLineHandle(o);return c&&c.text},getLineHandle:function(o){if(ee(this,o))return De(this,o)},getLineNumber:function(o){return N(o)},getLineHandleVisualStart:function(o){return typeof o=="number"&&(o=De(this,o)),bn(o)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(o){return ze(this,o)},getCursor:function(o){var c=this.sel.primary(),f;return o==null||o=="head"?f=c.head:o=="anchor"?f=c.anchor:o=="end"||o=="to"||o===!1?f=c.to():f=c.from(),f},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:Gt(function(o,c,f){sS(this,ze(this,typeof o=="number"?Z(o,c||0):o),null,f)}),setSelection:Gt(function(o,c,f){sS(this,ze(this,o),ze(this,c||o),f)}),extendSelection:Gt(function(o,c,f){hd(this,ze(this,o),c&&ze(this,c),f)}),extendSelections:Gt(function(o,c){rS(this,Xy(this,o),c)}),extendSelectionsBy:Gt(function(o,c){var f=Ki(this.sel.ranges,o);rS(this,Xy(this,f),c)}),setSelections:Gt(function(o,c,f){if(o.length){for(var p=[],m=0;m<o.length;m++)p[m]=new tt(ze(this,o[m].anchor),ze(this,o[m].head||o[m].anchor));c==null&&(c=Math.min(o.length-1,this.sel.primIndex)),ni(this,Cn(this.cm,p,c),f)}}),addSelection:Gt(function(o,c,f){var p=this.sel.ranges.slice(0);p.push(new tt(ze(this,o),ze(this,c||o))),ni(this,Cn(this.cm,p,p.length-1),f)}),getSelection:function(o){for(var c=this.sel.ranges,f,p=0;p<c.length;p++){var m=lr(this,c[p].from(),c[p].to());f=f?f.concat(m):m}return o===!1?f:f.join(o||this.lineSeparator())},getSelections:function(o){for(var c=[],f=this.sel.ranges,p=0;p<f.length;p++){var m=lr(this,f[p].from(),f[p].to());o!==!1&&(m=m.join(o||this.lineSeparator())),c[p]=m}return c},replaceSelection:function(o,c,f){for(var p=[],m=0;m<this.sel.ranges.length;m++)p[m]=o;this.replaceSelections(p,c,f||"+input")},replaceSelections:Gt(function(o,c,f){for(var p=[],m=this.sel,S=0;S<m.ranges.length;S++){var x=m.ranges[S];p[S]={from:x.from(),to:x.to(),text:this.splitLines(o[S]),origin:f}}for(var E=c&&c!="end"&&rM(this,p,c),D=p.length-1;D>=0;D--)Ra(this,p[D]);E?aS(this,E):this.cm&&Ta(this.cm)}),undo:Gt(function(){gd(this,"undo")}),redo:Gt(function(){gd(this,"redo")}),undoSelection:Gt(function(){gd(this,"undo",!0)}),redoSelection:Gt(function(){gd(this,"redo",!0)}),setExtending:function(o){this.extend=o},getExtending:function(){return this.extend},historySize:function(){for(var o=this.history,c=0,f=0,p=0;p<o.done.length;p++)o.done[p].ranges||++c;for(var m=0;m<o.undone.length;m++)o.undone[m].ranges||++f;return{undo:c,redo:f}},clearHistory:function(){var o=this;this.history=new dd(this.history),Qr(this,function(c){return c.history=o.history},!0)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(o){return o&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(o){return this.history.generation==(o||this.cleanGeneration)},getHistory:function(){return{done:Pa(this.history.done),undone:Pa(this.history.undone)}},setHistory:function(o){var c=this.history=new dd(this.history);c.done=Pa(o.done.slice(0),null,!0),c.undone=Pa(o.undone.slice(0),null,!0)},setGutterMarker:Gt(function(o,c,f){return fl(this,o,"gutter",function(p){var m=p.gutterMarkers||(p.gutterMarkers={});return m[c]=f,!f&&Gc(m)&&(p.gutterMarkers=null),!0})}),clearGutter:Gt(function(o){var c=this;this.iter(function(f){f.gutterMarkers&&f.gutterMarkers[o]&&fl(c,f,"gutter",function(){return f.gutterMarkers[o]=null,Gc(f.gutterMarkers)&&(f.gutterMarkers=null),!0})})}),lineInfo:function(o){var c;if(typeof o=="number"){if(!ee(this,o)||(c=o,o=De(this,o),!o))return null}else if(c=N(o),c==null)return null;return{line:c,handle:o,text:o.text,gutterMarkers:o.gutterMarkers,textClass:o.textClass,bgClass:o.bgClass,wrapClass:o.wrapClass,widgets:o.widgets}},addLineClass:Gt(function(o,c,f){return fl(this,o,c=="gutter"?"gutter":"class",function(p){var m=c=="text"?"textClass":c=="background"?"bgClass":c=="gutter"?"gutterClass":"wrapClass";if(!p[m])p[m]=f;else{if(j(f).test(p[m]))return!1;p[m]+=" "+f}return!0})}),removeLineClass:Gt(function(o,c,f){return fl(this,o,c=="gutter"?"gutter":"class",function(p){var m=c=="text"?"textClass":c=="background"?"bgClass":c=="gutter"?"gutterClass":"wrapClass",S=p[m];if(S)if(f==null)p[m]=null;else{var x=S.match(j(f));if(!x)return!1;var E=x.index+x[0].length;p[m]=S.slice(0,x.index)+(!x.index||E==S.length?"":" ")+S.slice(E)||null}else return!1;return!0})}),addLineWidget:Gt(function(o,c,f){return pM(this,o,c,f)}),removeLineWidget:function(o){o.clear()},markText:function(o,c,f){return Aa(this,ze(this,o),ze(this,c),f,f&&f.type||"range")},setBookmark:function(o,c){var f={replacedWith:c&&(c.nodeType==null?c.widget:c),insertLeft:c&&c.insertLeft,clearWhenEmpty:!1,shared:c&&c.shared,handleMouseEvents:c&&c.handleMouseEvents};return o=ze(this,o),Aa(this,o,o,f,"bookmark")},findMarksAt:function(o){o=ze(this,o);var c=[],f=De(this,o.line).markedSpans;if(f)for(var p=0;p<f.length;++p){var m=f[p];(m.from==null||m.from<=o.ch)&&(m.to==null||m.to>=o.ch)&&c.push(m.marker.parent||m.marker)}return c},findMarks:function(o,c,f){o=ze(this,o),c=ze(this,c);var p=[],m=o.line;return this.iter(o.line,c.line+1,function(S){var x=S.markedSpans;if(x)for(var E=0;E<x.length;E++){var D=x[E];!(D.to!=null&&m==o.line&&o.ch>=D.to||D.from==null&&m!=o.line||D.from!=null&&m==c.line&&D.from>=c.ch)&&(!f||f(D.marker))&&p.push(D.marker.parent||D.marker)}++m}),p},getAllMarks:function(){var o=[];return this.iter(function(c){var f=c.markedSpans;if(f)for(var p=0;p<f.length;++p)f[p].from!=null&&o.push(f[p].marker)}),o},posFromIndex:function(o){var c,f=this.first,p=this.lineSeparator().length;return this.iter(function(m){var S=m.text.length+p;if(S>o)return c=o,!0;o-=S,++f}),ze(this,Z(f,c))},indexFromPos:function(o){o=ze(this,o);var c=o.ch;if(o.line<this.first||o.ch<0)return 0;var f=this.lineSeparator().length;return this.iter(this.first,o.line,function(p){c+=p.text.length+f}),c},copy:function(o){var c=new xi(Zo(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return c.scrollTop=this.scrollTop,c.scrollLeft=this.scrollLeft,c.sel=this.sel,c.extend=!1,o&&(c.history.undoDepth=this.history.undoDepth,c.setHistory(this.getHistory())),c},linkedDoc:function(o){o||(o={});var c=this.first,f=this.first+this.size;o.from!=null&&o.from>c&&(c=o.from),o.to!=null&&o.to<f&&(f=o.to);var p=new xi(Zo(this,c,f),o.mode||this.modeOption,c,this.lineSep,this.direction);return o.sharedHist&&(p.history=this.history),(this.linked||(this.linked=[])).push({doc:p,sharedHist:o.sharedHist}),p.linked=[{doc:this,isParent:!0,sharedHist:o.sharedHist}],gM(p,bS(this)),p},unlinkDoc:function(o){if(o instanceof mt&&(o=o.doc),this.linked)for(var c=0;c<this.linked.length;++c){var f=this.linked[c];if(f.doc==o){this.linked.splice(c,1),o.unlinkDoc(this),mM(bS(this));break}}if(o.history==this.history){var p=[o.id];Qr(o,function(m){return p.push(m.id)},!0),o.history=new dd(null),o.history.done=Pa(this.history.done,p),o.history.undone=Pa(this.history.undone,p)}},iterLinkedDocs:function(o){Qr(this,o)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(o){return this.lineSep?o.split(this.lineSep):Zi(o)},lineSeparator:function(){return this.lineSep||`
`},setDirection:Gt(function(o){o!="rtl"&&(o="ltr"),o!=this.direction&&(this.direction=o,this.iter(function(c){return c.order=null}),this.cm&&sM(this.cm))})}),xi.prototype.eachLine=xi.prototype.iter;var wS=0;function yM(o){var c=this;if(CS(c),!(bt(c,o)||ur(c.display,o))){ii(o),d&&(wS=+new Date);var f=As(c,o,!0),p=o.dataTransfer.files;if(!(!f||c.isReadOnly()))if(p&&p.length&&window.FileReader&&window.File)for(var m=p.length,S=Array(m),x=0,E=function(){++x==m&&$t(c,function(){f=ze(c.doc,f);var J={from:f,to:f,text:c.doc.splitLines(S.filter(function(Q){return Q!=null}).join(c.doc.lineSeparator())),origin:"paste"};Ra(c.doc,J),aS(c.doc,Yr(ze(c.doc,f),ze(c.doc,Zr(J))))})()},D=function(J,Q){if(c.options.allowDropFileTypes&&Ce(c.options.allowDropFileTypes,J.type)==-1){E();return}var ne=new FileReader;ne.onerror=function(){return E()},ne.onload=function(){var ue=ne.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(ue)){E();return}S[Q]=ue,E()},ne.readAsText(J)},A=0;A<p.length;A++)D(p[A],A);else{if(c.state.draggingText&&c.doc.sel.contains(f)>-1){c.state.draggingText(o),setTimeout(function(){return c.display.input.focus()},20);return}try{var z=o.dataTransfer.getData("Text");if(z){var W;if(c.state.draggingText&&!c.state.draggingText.copy&&(W=c.listSelections()),pd(c.doc,Yr(f,f)),W)for(var X=0;X<W.length;++X)Ma(c.doc,"",W[X].anchor,W[X].head,"drag");c.replaceSelection(z,"around","paste"),c.display.input.focus()}}catch{}}}}function SM(o,c){if(d&&(!o.state.draggingText||+new Date-wS<100)){Wr(c);return}if(!(bt(o,c)||ur(o.display,c))&&(c.dataTransfer.setData("Text",o.getSelection()),c.dataTransfer.effectAllowed="copyMove",c.dataTransfer.setDragImage&&!w)){var f=_("img",null,null,"position: fixed; left: 0; top: 0;");f.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",C&&(f.width=f.height=1,o.display.wrapper.appendChild(f),f._top=f.offsetTop),c.dataTransfer.setDragImage(f,0,0),C&&f.parentNode.removeChild(f)}}function bM(o,c){var f=As(o,c);if(f){var p=document.createDocumentFragment();ip(o,f,p),o.display.dragCursor||(o.display.dragCursor=_("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),o.display.lineSpace.insertBefore(o.display.dragCursor,o.display.cursorDiv)),$(o.display.dragCursor,p)}}function CS(o){o.display.dragCursor&&(o.display.lineSpace.removeChild(o.display.dragCursor),o.display.dragCursor=null)}function xS(o){if(document.getElementsByClassName){for(var c=document.getElementsByClassName("CodeMirror"),f=[],p=0;p<c.length;p++){var m=c[p].CodeMirror;m&&f.push(m)}f.length&&f[0].operation(function(){for(var S=0;S<f.length;S++)o(f[S])})}}var kS=!1;function wM(){kS||(CM(),kS=!0)}function CM(){var o;Ve(window,"resize",function(){o==null&&(o=setTimeout(function(){o=null,xS(xM)},100))}),Ve(window,"blur",function(){return xS(La)})}function xM(o){var c=o.display;c.cachedCharWidth=c.cachedTextHeight=c.cachedPaddingH=null,c.scrollbarsClipped=!1,o.setSize()}for(var ts={3:"Pause",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",145:"ScrollLock",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",224:"Mod",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Sl=0;Sl<10;Sl++)ts[Sl+48]=ts[Sl+96]=String(Sl);for(var md=65;md<=90;md++)ts[md]=String.fromCharCode(md);for(var bl=1;bl<=12;bl++)ts[bl+111]=ts[bl+63235]="F"+bl;var pr={};pr.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},pr.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},pr.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},pr.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},pr.default=T?pr.macDefault:pr.pcDefault;function kM(o){var c=o.split(/-(?!$)/);o=c[c.length-1];for(var f,p,m,S,x=0;x<c.length-1;x++){var E=c[x];if(/^(cmd|meta|m)$/i.test(E))S=!0;else if(/^a(lt)?$/i.test(E))f=!0;else if(/^(c|ctrl|control)$/i.test(E))p=!0;else if(/^s(hift)?$/i.test(E))m=!0;else throw new Error("Unrecognized modifier name: "+E)}return f&&(o="Alt-"+o),p&&(o="Ctrl-"+o),S&&(o="Cmd-"+o),m&&(o="Shift-"+o),o}function EM(o){var c={};for(var f in o)if(o.hasOwnProperty(f)){var p=o[f];if(/^(name|fallthrough|(de|at)tach)$/.test(f))continue;if(p=="..."){delete o[f];continue}for(var m=Ki(f.split(" "),kM),S=0;S<m.length;S++){var x=void 0,E=void 0;S==m.length-1?(E=m.join(" "),x=p):(E=m.slice(0,S+1).join(" "),x="...");var D=c[E];if(!D)c[E]=x;else if(D!=x)throw new Error("Inconsistent bindings for "+E)}delete o[f]}for(var A in c)o[A]=c[A];return o}function Na(o,c,f,p){c=vd(c);var m=c.call?c.call(o,p):c[o];if(m===!1)return"nothing";if(m==="...")return"multi";if(m!=null&&f(m))return"handled";if(c.fallthrough){if(Object.prototype.toString.call(c.fallthrough)!="[object Array]")return Na(o,c.fallthrough,f,p);for(var S=0;S<c.fallthrough.length;S++){var x=Na(o,c.fallthrough[S],f,p);if(x)return x}}}function ES(o){var c=typeof o=="string"?o:ts[o.keyCode];return c=="Ctrl"||c=="Alt"||c=="Shift"||c=="Mod"}function LS(o,c,f){var p=o;return c.altKey&&p!="Alt"&&(o="Alt-"+o),(B?c.metaKey:c.ctrlKey)&&p!="Ctrl"&&(o="Ctrl-"+o),(B?c.ctrlKey:c.metaKey)&&p!="Mod"&&(o="Cmd-"+o),!f&&c.shiftKey&&p!="Shift"&&(o="Shift-"+o),o}function TS(o,c){if(C&&o.keyCode==34&&o.char)return!1;var f=ts[o.keyCode];return f==null||o.altGraphKey?!1:(o.keyCode==3&&o.code&&(f=o.code),LS(f,o,c))}function vd(o){return typeof o=="string"?pr[o]:o}function Va(o,c){for(var f=o.doc.sel.ranges,p=[],m=0;m<f.length;m++){for(var S=c(f[m]);p.length&&me(S.from,je(p).to)<=0;){var x=p.pop();if(me(x.from,S.from)<0){S.from=x.from;break}}p.push(S)}Vi(o,function(){for(var E=p.length-1;E>=0;E--)Ma(o.doc,"",p[E].from,p[E].to,"+delete");Ta(o)})}function Sp(o,c,f){var p=zr(o.text,c+f,f);return p<0||p>o.text.length?null:p}function bp(o,c,f){var p=Sp(o,c.ch,f);return p==null?null:new Z(c.line,p,f<0?"after":"before")}function wp(o,c,f,p,m){if(o){c.doc.direction=="rtl"&&(m=-m);var S=qe(f,c.doc.direction);if(S){var x=m<0?je(S):S[0],E=m<0==(x.level==1),D=E?"after":"before",A;if(x.level>0||c.doc.direction=="rtl"){var z=xa(c,f);A=m<0?f.text.length-1:0;var W=Fn(c,z,A).top;A=Vn(function(X){return Fn(c,z,X).top==W},m<0==(x.level==1)?x.from:x.to-1,A),D=="before"&&(A=Sp(f,A,1))}else A=m<0?x.to:x.from;return new Z(p,A,D)}}return new Z(p,m<0?f.text.length:0,m<0?"before":"after")}function LM(o,c,f,p){var m=qe(c,o.doc.direction);if(!m)return bp(c,f,p);f.ch>=c.text.length?(f.ch=c.text.length,f.sticky="before"):f.ch<=0&&(f.ch=0,f.sticky="after");var S=Gr(m,f.ch,f.sticky),x=m[S];if(o.doc.direction=="ltr"&&x.level%2==0&&(p>0?x.to>f.ch:x.from<f.ch))return bp(c,f,p);var E=function(pe,Se){return Sp(c,pe instanceof Z?pe.ch:pe,Se)},D,A=function(pe){return o.options.lineWrapping?(D=D||xa(o,c),M0(o,c,D,pe)):{begin:0,end:c.text.length}},z=A(f.sticky=="before"?E(f,-1):f.ch);if(o.doc.direction=="rtl"||x.level==1){var W=x.level==1==p<0,X=E(f,W?1:-1);if(X!=null&&(W?X<=x.to&&X<=z.end:X>=x.from&&X>=z.begin)){var J=W?"before":"after";return new Z(f.line,X,J)}}var Q=function(pe,Se,fe){for(var xe=function(ht,Wt){return Wt?new Z(f.line,E(ht,1),"before"):new Z(f.line,ht,"after")};pe>=0&&pe<m.length;pe+=Se){var Be=m[pe],Ae=Se>0==(Be.level!=1),He=Ae?fe.begin:E(fe.end,-1);if(Be.from<=He&&He<Be.to||(He=Ae?Be.from:E(Be.to,-1),fe.begin<=He&&He<fe.end))return xe(He,Ae)}},ne=Q(S+p,p,z);if(ne)return ne;var ue=p>0?z.end:E(z.begin,-1);return ue!=null&&!(p>0&&ue==c.text.length)&&(ne=Q(p>0?0:m.length-1,p,A(ue)),ne)?ne:null}var wl={selectAll:uS,singleSelection:function(o){return o.setSelection(o.getCursor("anchor"),o.getCursor("head"),Xt)},killLine:function(o){return Va(o,function(c){if(c.empty()){var f=De(o.doc,c.head.line).text.length;return c.head.ch==f&&c.head.line<o.lastLine()?{from:c.head,to:Z(c.head.line+1,0)}:{from:c.head,to:Z(c.head.line,f)}}else return{from:c.from(),to:c.to()}})},deleteLine:function(o){return Va(o,function(c){return{from:Z(c.from().line,0),to:ze(o.doc,Z(c.to().line+1,0))}})},delLineLeft:function(o){return Va(o,function(c){return{from:Z(c.from().line,0),to:c.from()}})},delWrappedLineLeft:function(o){return Va(o,function(c){var f=o.charCoords(c.head,"div").top+5,p=o.coordsChar({left:0,top:f},"div");return{from:p,to:c.from()}})},delWrappedLineRight:function(o){return Va(o,function(c){var f=o.charCoords(c.head,"div").top+5,p=o.coordsChar({left:o.display.lineDiv.offsetWidth+100,top:f},"div");return{from:c.from(),to:p}})},undo:function(o){return o.undo()},redo:function(o){return o.redo()},undoSelection:function(o){return o.undoSelection()},redoSelection:function(o){return o.redoSelection()},goDocStart:function(o){return o.extendSelection(Z(o.firstLine(),0))},goDocEnd:function(o){return o.extendSelection(Z(o.lastLine()))},goLineStart:function(o){return o.extendSelectionsBy(function(c){return DS(o,c.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(o){return o.extendSelectionsBy(function(c){return PS(o,c.head)},{origin:"+move",bias:1})},goLineEnd:function(o){return o.extendSelectionsBy(function(c){return TM(o,c.head.line)},{origin:"+move",bias:-1})},goLineRight:function(o){return o.extendSelectionsBy(function(c){var f=o.cursorCoords(c.head,"div").top+5;return o.coordsChar({left:o.display.lineDiv.offsetWidth+100,top:f},"div")},Kt)},goLineLeft:function(o){return o.extendSelectionsBy(function(c){var f=o.cursorCoords(c.head,"div").top+5;return o.coordsChar({left:0,top:f},"div")},Kt)},goLineLeftSmart:function(o){return o.extendSelectionsBy(function(c){var f=o.cursorCoords(c.head,"div").top+5,p=o.coordsChar({left:0,top:f},"div");return p.ch<o.getLine(p.line).search(/\S/)?PS(o,c.head):p},Kt)},goLineUp:function(o){return o.moveV(-1,"line")},goLineDown:function(o){return o.moveV(1,"line")},goPageUp:function(o){return o.moveV(-1,"page")},goPageDown:function(o){return o.moveV(1,"page")},goCharLeft:function(o){return o.moveH(-1,"char")},goCharRight:function(o){return o.moveH(1,"char")},goColumnLeft:function(o){return o.moveH(-1,"column")},goColumnRight:function(o){return o.moveH(1,"column")},goWordLeft:function(o){return o.moveH(-1,"word")},goGroupRight:function(o){return o.moveH(1,"group")},goGroupLeft:function(o){return o.moveH(-1,"group")},goWordRight:function(o){return o.moveH(1,"word")},delCharBefore:function(o){return o.deleteH(-1,"codepoint")},delCharAfter:function(o){return o.deleteH(1,"char")},delWordBefore:function(o){return o.deleteH(-1,"word")},delWordAfter:function(o){return o.deleteH(1,"word")},delGroupBefore:function(o){return o.deleteH(-1,"group")},delGroupAfter:function(o){return o.deleteH(1,"group")},indentAuto:function(o){return o.indentSelection("smart")},indentMore:function(o){return o.indentSelection("add")},indentLess:function(o){return o.indentSelection("subtract")},insertTab:function(o){return o.replaceSelection("	")},insertSoftTab:function(o){for(var c=[],f=o.listSelections(),p=o.options.tabSize,m=0;m<f.length;m++){var S=f[m].from(),x=_e(o.getLine(S.line),S.ch,p);c.push(pn(p-x%p))}o.replaceSelections(c)},defaultTab:function(o){o.somethingSelected()?o.indentSelection("add"):o.execCommand("insertTab")},transposeChars:function(o){return Vi(o,function(){for(var c=o.listSelections(),f=[],p=0;p<c.length;p++)if(c[p].empty()){var m=c[p].head,S=De(o.doc,m.line).text;if(S){if(m.ch==S.length&&(m=new Z(m.line,m.ch-1)),m.ch>0)m=new Z(m.line,m.ch+1),o.replaceRange(S.charAt(m.ch-1)+S.charAt(m.ch-2),Z(m.line,m.ch-2),m,"+transpose");else if(m.line>o.doc.first){var x=De(o.doc,m.line-1).text;x&&(m=new Z(m.line,1),o.replaceRange(S.charAt(0)+o.doc.lineSeparator()+x.charAt(x.length-1),Z(m.line-1,x.length-1),m,"+transpose"))}}f.push(new tt(m,m))}o.setSelections(f)})},newlineAndIndent:function(o){return Vi(o,function(){for(var c=o.listSelections(),f=c.length-1;f>=0;f--)o.replaceRange(o.doc.lineSeparator(),c[f].anchor,c[f].head,"+input");c=o.listSelections();for(var p=0;p<c.length;p++)o.indentLine(c[p].from().line,null,!0);Ta(o)})},openLine:function(o){return o.replaceSelection(`
`,"start")},toggleOverwrite:function(o){return o.toggleOverwrite()}};function DS(o,c){var f=De(o.doc,c),p=bn(f);return p!=f&&(c=N(p)),wp(!0,o,p,c,1)}function TM(o,c){var f=De(o.doc,c),p=dR(f);return p!=f&&(c=N(p)),wp(!0,o,f,c,-1)}function PS(o,c){var f=DS(o,c.line),p=De(o.doc,f.line),m=qe(p,o.doc.direction);if(!m||m[0].level==0){var S=Math.max(f.ch,p.text.search(/\S/)),x=c.line==f.line&&c.ch<=S&&c.ch;return Z(f.line,x?0:S,f.sticky)}return f}function yd(o,c,f){if(typeof c=="string"&&(c=wl[c],!c))return!1;o.display.input.ensurePolled();var p=o.display.shift,m=!1;try{o.isReadOnly()&&(o.state.suppressEdits=!0),f&&(o.display.shift=!1),m=c(o)!=Ft}finally{o.display.shift=p,o.state.suppressEdits=!1}return m}function DM(o,c,f){for(var p=0;p<o.state.keyMaps.length;p++){var m=Na(c,o.state.keyMaps[p],f,o);if(m)return m}return o.options.extraKeys&&Na(c,o.options.extraKeys,f,o)||Na(c,o.options.keyMap,f,o)}var PM=new Ue;function Cl(o,c,f,p){var m=o.state.keySeq;if(m){if(ES(c))return"handled";if(/\'$/.test(c)?o.state.keySeq=null:PM.set(50,function(){o.state.keySeq==m&&(o.state.keySeq=null,o.display.input.reset())}),IS(o,m+" "+c,f,p))return!0}return IS(o,c,f,p)}function IS(o,c,f,p){var m=DM(o,c,p);return m=="multi"&&(o.state.keySeq=c),m=="handled"&&zt(o,"keyHandled",o,c,f),(m=="handled"||m=="multi")&&(ii(f),np(o)),!!m}function RS(o,c){var f=TS(c,!0);return f?c.shiftKey&&!o.state.keySeq?Cl(o,"Shift-"+f,c,function(p){return yd(o,p,!0)})||Cl(o,f,c,function(p){if(typeof p=="string"?/^go[A-Z]/.test(p):p.motion)return yd(o,p)}):Cl(o,f,c,function(p){return yd(o,p)}):!1}function IM(o,c,f){return Cl(o,"'"+f+"'",c,function(p){return yd(o,p,!0)})}var Cp=null;function MS(o){var c=this;if(!(o.target&&o.target!=c.display.input.getField())&&(c.curOp.focus=le(Fe(c)),!bt(c,o))){d&&u<11&&o.keyCode==27&&(o.returnValue=!1);var f=o.keyCode;c.display.shift=f==16||o.shiftKey;var p=RS(c,o);C&&(Cp=p?f:null,!p&&f==88&&!jc&&(T?o.metaKey:o.ctrlKey)&&c.replaceSelection("",null,"cut")),r&&!T&&!p&&f==46&&o.shiftKey&&!o.ctrlKey&&document.execCommand&&document.execCommand("cut"),f==18&&!/\bCodeMirror-crosshair\b/.test(c.display.lineDiv.className)&&RM(c)}}function RM(o){var c=o.display.lineDiv;we(c,"CodeMirror-crosshair");function f(p){(p.keyCode==18||!p.altKey)&&(U(c,"CodeMirror-crosshair"),ti(document,"keyup",f),ti(document,"mouseover",f))}Ve(document,"keyup",f),Ve(document,"mouseover",f)}function AS(o){o.keyCode==16&&(this.doc.sel.shift=!1),bt(this,o)}function NS(o){var c=this;if(!(o.target&&o.target!=c.display.input.getField())&&!(ur(c.display,o)||bt(c,o)||o.ctrlKey&&!o.altKey||T&&o.metaKey)){var f=o.keyCode,p=o.charCode;if(C&&f==Cp){Cp=null,ii(o);return}if(!(C&&(!o.which||o.which<10)&&RS(c,o))){var m=String.fromCharCode(p??f);m!="\b"&&(IM(c,o,m)||c.display.input.onKeyPress(o))}}}var MM=400,xp=function(o,c,f){this.time=o,this.pos=c,this.button=f};xp.prototype.compare=function(o,c,f){return this.time+MM>o&&me(c,this.pos)==0&&f==this.button};var xl,kl;function AM(o,c){var f=+new Date;return kl&&kl.compare(f,o,c)?(xl=kl=null,"triple"):xl&&xl.compare(f,o,c)?(kl=new xp(f,o,c),xl=null,"double"):(xl=new xp(f,o,c),kl=null,"single")}function VS(o){var c=this,f=c.display;if(!(bt(c,o)||f.activeTouch&&f.input.supportsTouch())){if(f.input.ensurePolled(),f.shift=o.shiftKey,ur(f,o)){h||(f.scroller.draggable=!1,setTimeout(function(){return f.scroller.draggable=!0},100));return}if(!kp(c,o)){var p=As(c,o),m=mn(o),S=p?AM(p,m):"single";Pe(c).focus(),m==1&&c.state.selectingText&&c.state.selectingText(o),!(p&&NM(c,m,p,S,o))&&(m==1?p?OM(c,p,S,o):Xo(o)==f.scroller&&ii(o):m==2?(p&&hd(c.doc,p),setTimeout(function(){return f.input.focus()},20)):m==3&&(F?c.display.input.onContextMenu(o):rp(c)))}}}function NM(o,c,f,p,m){var S="Click";return p=="double"?S="Double"+S:p=="triple"&&(S="Triple"+S),S=(c==1?"Left":c==2?"Middle":"Right")+S,Cl(o,LS(S,m),m,function(x){if(typeof x=="string"&&(x=wl[x]),!x)return!1;var E=!1;try{o.isReadOnly()&&(o.state.suppressEdits=!0),E=x(o,f)!=Ft}finally{o.state.suppressEdits=!1}return E})}function VM(o,c,f){var p=o.getOption("configureMouse"),m=p?p(o,c,f):{};if(m.unit==null){var S=R?f.shiftKey&&f.metaKey:f.altKey;m.unit=S?"rectangle":c=="single"?"char":c=="double"?"word":"line"}return(m.extend==null||o.doc.extend)&&(m.extend=o.doc.extend||f.shiftKey),m.addNew==null&&(m.addNew=T?f.metaKey:f.ctrlKey),m.moveOnDrag==null&&(m.moveOnDrag=!(T?f.altKey:f.ctrlKey)),m}function OM(o,c,f,p){d?setTimeout(ke(O0,o),0):o.curOp.focus=le(Fe(o));var m=VM(o,f,p),S=o.doc.sel,x;o.options.dragDrop&&Oh&&!o.isReadOnly()&&f=="single"&&(x=S.contains(c))>-1&&(me((x=S.ranges[x]).from(),c)<0||c.xRel>0)&&(me(x.to(),c)>0||c.xRel<0)?BM(o,p,c,m):_M(o,p,c,m)}function BM(o,c,f,p){var m=o.display,S=!1,x=$t(o,function(A){h&&(m.scroller.draggable=!1),o.state.draggingText=!1,o.state.delayingBlurEvent&&(o.hasFocus()?o.state.delayingBlurEvent=!1:rp(o)),ti(m.wrapper.ownerDocument,"mouseup",x),ti(m.wrapper.ownerDocument,"mousemove",E),ti(m.scroller,"dragstart",D),ti(m.scroller,"drop",x),S||(ii(A),p.addNew||hd(o.doc,f,null,null,p.extend),h&&!w||d&&u==9?setTimeout(function(){m.wrapper.ownerDocument.body.focus({preventScroll:!0}),m.input.focus()},20):m.input.focus())}),E=function(A){S=S||Math.abs(c.clientX-A.clientX)+Math.abs(c.clientY-A.clientY)>=10},D=function(){return S=!0};h&&(m.scroller.draggable=!0),o.state.draggingText=x,x.copy=!p.moveOnDrag,Ve(m.wrapper.ownerDocument,"mouseup",x),Ve(m.wrapper.ownerDocument,"mousemove",E),Ve(m.scroller,"dragstart",D),Ve(m.scroller,"drop",x),o.state.delayingBlurEvent=!0,setTimeout(function(){return m.input.focus()},20),m.scroller.dragDrop&&m.scroller.dragDrop()}function OS(o,c,f){if(f=="char")return new tt(c,c);if(f=="word")return o.findWordAt(c);if(f=="line")return new tt(Z(c.line,0),ze(o.doc,Z(c.line+1,0)));var p=f(o,c);return new tt(p.from,p.to)}function _M(o,c,f,p){d&&rp(o);var m=o.display,S=o.doc;ii(c);var x,E,D=S.sel,A=D.ranges;if(p.addNew&&!p.extend?(E=S.sel.contains(f),E>-1?x=A[E]:x=new tt(f,f)):(x=S.sel.primary(),E=S.sel.primIndex),p.unit=="rectangle")p.addNew||(x=new tt(f,f)),f=As(o,c,!0,!0),E=-1;else{var z=OS(o,f,p.unit);p.extend?x=vp(x,z.anchor,z.head,p.extend):x=z}p.addNew?E==-1?(E=A.length,ni(S,Cn(o,A.concat([x]),E),{scroll:!1,origin:"*mouse"})):A.length>1&&A[E].empty()&&p.unit=="char"&&!p.extend?(ni(S,Cn(o,A.slice(0,E).concat(A.slice(E+1)),0),{scroll:!1,origin:"*mouse"}),D=S.sel):yp(S,E,x,yi):(E=0,ni(S,new Wi([x],0),yi),D=S.sel);var W=f;function X(fe){if(me(W,fe)!=0)if(W=fe,p.unit=="rectangle"){for(var xe=[],Be=o.options.tabSize,Ae=_e(De(S,f.line).text,f.ch,Be),He=_e(De(S,fe.line).text,fe.ch,Be),ht=Math.min(Ae,He),Wt=Math.max(Ae,He),yt=Math.min(f.line,fe.line),Oi=Math.min(o.lastLine(),Math.max(f.line,fe.line));yt<=Oi;yt++){var ki=De(S,yt).text,Mt=li(ki,ht,Be);ht==Wt?xe.push(new tt(Z(yt,Mt),Z(yt,Mt))):ki.length>Mt&&xe.push(new tt(Z(yt,Mt),Z(yt,li(ki,Wt,Be))))}xe.length||xe.push(new tt(f,f)),ni(S,Cn(o,D.ranges.slice(0,E).concat(xe),E),{origin:"*mouse",scroll:!1}),o.scrollIntoView(fe)}else{var Ei=x,Yt=OS(o,fe,p.unit),Bt=Ei.anchor,At;me(Yt.anchor,Bt)>0?(At=Yt.head,Bt=ba(Ei.from(),Yt.anchor)):(At=Yt.anchor,Bt=wi(Ei.to(),Yt.head));var Ct=D.ranges.slice(0);Ct[E]=FM(o,new tt(ze(S,Bt),At)),ni(S,Cn(o,Ct,E),yi)}}var J=m.wrapper.getBoundingClientRect(),Q=0;function ne(fe){var xe=++Q,Be=As(o,fe,!0,p.unit=="rectangle");if(Be)if(me(Be,W)!=0){o.curOp.focus=le(Fe(o)),X(Be);var Ae=ad(m,S);(Be.line>=Ae.to||Be.line<Ae.from)&&setTimeout($t(o,function(){Q==xe&&ne(fe)}),150)}else{var He=fe.clientY<J.top?-20:fe.clientY>J.bottom?20:0;He&&setTimeout($t(o,function(){Q==xe&&(m.scroller.scrollTop+=He,ne(fe))}),50)}}function ue(fe){o.state.selectingText=!1,Q=1/0,fe&&(ii(fe),m.input.focus()),ti(m.wrapper.ownerDocument,"mousemove",pe),ti(m.wrapper.ownerDocument,"mouseup",Se),S.history.lastSelOrigin=null}var pe=$t(o,function(fe){fe.buttons===0||!mn(fe)?ue(fe):ne(fe)}),Se=$t(o,ue);o.state.selectingText=Se,Ve(m.wrapper.ownerDocument,"mousemove",pe),Ve(m.wrapper.ownerDocument,"mouseup",Se)}function FM(o,c){var f=c.anchor,p=c.head,m=De(o.doc,f.line);if(me(f,p)==0&&f.sticky==p.sticky)return c;var S=qe(m);if(!S)return c;var x=Gr(S,f.ch,f.sticky),E=S[x];if(E.from!=f.ch&&E.to!=f.ch)return c;var D=x+(E.from==f.ch==(E.level!=1)?0:1);if(D==0||D==S.length)return c;var A;if(p.line!=f.line)A=(p.line-f.line)*(o.doc.direction=="ltr"?1:-1)>0;else{var z=Gr(S,p.ch,p.sticky),W=z-x||(p.ch-f.ch)*(E.level==1?-1:1);z==D-1||z==D?A=W<0:A=W>0}var X=S[D+(A?-1:0)],J=A==(X.level==1),Q=J?X.from:X.to,ne=J?"after":"before";return f.ch==Q&&f.sticky==ne?c:new tt(new Z(f.line,Q,ne),p)}function BS(o,c,f,p){var m,S;if(c.touches)m=c.touches[0].clientX,S=c.touches[0].clientY;else try{m=c.clientX,S=c.clientY}catch{return!1}if(m>=Math.floor(o.display.gutters.getBoundingClientRect().right))return!1;p&&ii(c);var x=o.display,E=x.lineDiv.getBoundingClientRect();if(S>E.bottom||!Ni(o,f))return bi(c);S-=E.top-x.viewOffset;for(var D=0;D<o.display.gutterSpecs.length;++D){var A=x.gutters.childNodes[D];if(A&&A.getBoundingClientRect().right>=m){var z=G(o.doc,S),W=o.display.gutterSpecs[D];return St(o,f,o,z,W.className,c),bi(c)}}}function kp(o,c){return BS(o,c,"gutterClick",!0)}function _S(o,c){ur(o.display,c)||UM(o,c)||bt(o,c,"contextmenu")||F||o.display.input.onContextMenu(c)}function UM(o,c){return Ni(o,"gutterContextMenu")?BS(o,c,"gutterContextMenu",!1):!1}function FS(o){o.display.wrapper.className=o.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+o.options.theme.replace(/(^|\s)\s*/g," cm-s-"),rl(o)}var Oa={toString:function(){return"CodeMirror.Init"}},US={},Sd={};function zM(o){var c=o.optionHandlers;function f(p,m,S,x){o.defaults[p]=m,S&&(c[p]=x?function(E,D,A){A!=Oa&&S(E,D,A)}:S)}o.defineOption=f,o.Init=Oa,f("value","",function(p,m){return p.setValue(m)},!0),f("mode",null,function(p,m){p.doc.modeOption=m,fp(p)},!0),f("indentUnit",2,fp,!0),f("indentWithTabs",!1),f("smartIndent",!0),f("tabSize",4,function(p){hl(p),rl(p),Ci(p)},!0),f("lineSeparator",null,function(p,m){if(p.doc.lineSep=m,!!m){var S=[],x=p.doc.first;p.doc.iter(function(D){for(var A=0;;){var z=D.text.indexOf(m,A);if(z==-1)break;A=z+m.length,S.push(Z(x,z))}x++});for(var E=S.length-1;E>=0;E--)Ma(p.doc,m,S[E],Z(S[E].line,S[E].ch+m.length))}}),f("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b\u200e\u200f\u2028\u2029\u202d\u202e\u2066\u2067\u2069\ufeff\ufff9-\ufffc]/g,function(p,m,S){p.state.specialChars=new RegExp(m.source+(m.test("	")?"":"|	"),"g"),S!=Oa&&p.refresh()}),f("specialCharPlaceholder",mR,function(p){return p.refresh()},!0),f("electricChars",!0),f("inputStyle",P?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),f("spellcheck",!1,function(p,m){return p.getInputField().spellcheck=m},!0),f("autocorrect",!1,function(p,m){return p.getInputField().autocorrect=m},!0),f("autocapitalize",!1,function(p,m){return p.getInputField().autocapitalize=m},!0),f("rtlMoveVisually",!M),f("wholeLineUpdateBefore",!0),f("theme","default",function(p){FS(p),ul(p)},!0),f("keyMap","default",function(p,m,S){var x=vd(m),E=S!=Oa&&vd(S);E&&E.detach&&E.detach(p,x),x.attach&&x.attach(p,E||null)}),f("extraKeys",null),f("configureMouse",null),f("lineWrapping",!1,GM,!0),f("gutters",[],function(p,m){p.display.gutterSpecs=hp(m,p.options.lineNumbers),ul(p)},!0),f("fixedGutter",!0,function(p,m){p.display.gutters.style.left=m?ep(p.display)+"px":"0",p.refresh()},!0),f("coverGutterNextToScrollbar",!1,function(p){return Da(p)},!0),f("scrollbarStyle","native",function(p){$0(p),Da(p),p.display.scrollbars.setScrollTop(p.doc.scrollTop),p.display.scrollbars.setScrollLeft(p.doc.scrollLeft)},!0),f("lineNumbers",!1,function(p,m){p.display.gutterSpecs=hp(p.options.gutters,m),ul(p)},!0),f("firstLineNumber",1,ul,!0),f("lineNumberFormatter",function(p){return p},ul,!0),f("showCursorWhenSelecting",!1,sl,!0),f("resetSelectionOnContextMenu",!0),f("lineWiseCopyCut",!0),f("pasteLinesPerSelection",!0),f("selectionsMayTouch",!1),f("readOnly",!1,function(p,m){m=="nocursor"&&(La(p),p.display.input.blur()),p.display.input.readOnlyChanged(m)}),f("screenReaderLabel",null,function(p,m){m=m===""?null:m,p.display.input.screenReaderLabelChanged(m)}),f("disableInput",!1,function(p,m){m||p.display.input.reset()},!0),f("dragDrop",!0,$M),f("allowDropFileTypes",null),f("cursorBlinkRate",530),f("cursorScrollMargin",0),f("cursorHeight",1,sl,!0),f("singleCursorHeightPerLine",!0,sl,!0),f("workTime",100),f("workDelay",100),f("flattenSpans",!0,hl,!0),f("addModeClass",!1,hl,!0),f("pollInterval",100),f("undoDepth",200,function(p,m){return p.doc.history.undoDepth=m}),f("historyEventDelay",1250),f("viewportMargin",10,function(p){return p.refresh()},!0),f("maxHighlightLength",1e4,hl,!0),f("moveInputWithCursor",!0,function(p,m){m||p.display.input.resetPosition()}),f("tabindex",null,function(p,m){return p.display.input.getField().tabIndex=m||""}),f("autofocus",null),f("direction","ltr",function(p,m){return p.doc.setDirection(m)},!0),f("phrases",null)}function $M(o,c,f){var p=f&&f!=Oa;if(!c!=!p){var m=o.display.dragFunctions,S=c?Ve:ti;S(o.display.scroller,"dragstart",m.start),S(o.display.scroller,"dragenter",m.enter),S(o.display.scroller,"dragover",m.over),S(o.display.scroller,"dragleave",m.leave),S(o.display.scroller,"drop",m.drop)}}function GM(o){o.options.lineWrapping?(we(o.display.wrapper,"CodeMirror-wrap"),o.display.sizer.style.minWidth="",o.display.sizerWidth=null):(U(o.display.wrapper,"CodeMirror-wrap"),Wh(o)),tp(o),Ci(o),rl(o),setTimeout(function(){return Da(o)},100)}function mt(o,c){var f=this;if(!(this instanceof mt))return new mt(o,c);this.options=c=c?Me(c):{},Me(US,c,!1);var p=c.value;typeof p=="string"?p=new xi(p,c.mode,null,c.lineSeparator,c.direction):c.mode&&(p.modeOption=c.mode),this.doc=p;var m=new mt.inputStyles[c.inputStyle](this),S=this.display=new iM(o,p,m,c);S.wrapper.CodeMirror=this,FS(this),c.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),$0(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:-1,cutIncoming:-1,selectingText:!1,draggingText:!1,highlight:new Ue,keySeq:null,specialChars:null},c.autofocus&&!P&&S.input.focus(),d&&u<11&&setTimeout(function(){return f.display.input.reset(!0)},20),WM(this),wM(),Bs(this),this.curOp.forceUpdate=!0,Z0(this,p),c.autofocus&&!P||this.hasFocus()?setTimeout(function(){f.hasFocus()&&!f.state.focused&&sp(f)},20):La(this);for(var x in Sd)Sd.hasOwnProperty(x)&&Sd[x](this,c[x],Oa);H0(this),c.finishInit&&c.finishInit(this);for(var E=0;E<Ep.length;++E)Ep[E](this);_s(this),h&&c.lineWrapping&&getComputedStyle(S.lineDiv).textRendering=="optimizelegibility"&&(S.lineDiv.style.textRendering="auto")}mt.defaults=US,mt.optionHandlers=Sd;function WM(o){var c=o.display;Ve(c.scroller,"mousedown",$t(o,VS)),d&&u<11?Ve(c.scroller,"dblclick",$t(o,function(D){if(!bt(o,D)){var A=As(o,D);if(!(!A||kp(o,D)||ur(o.display,D))){ii(D);var z=o.findWordAt(A);hd(o.doc,z.anchor,z.head)}}})):Ve(c.scroller,"dblclick",function(D){return bt(o,D)||ii(D)}),Ve(c.scroller,"contextmenu",function(D){return _S(o,D)}),Ve(c.input.getField(),"contextmenu",function(D){c.scroller.contains(D.target)||_S(o,D)});var f,p={end:0};function m(){c.activeTouch&&(f=setTimeout(function(){return c.activeTouch=null},1e3),p=c.activeTouch,p.end=+new Date)}function S(D){if(D.touches.length!=1)return!1;var A=D.touches[0];return A.radiusX<=1&&A.radiusY<=1}function x(D,A){if(A.left==null)return!0;var z=A.left-D.left,W=A.top-D.top;return z*z+W*W>400}Ve(c.scroller,"touchstart",function(D){if(!bt(o,D)&&!S(D)&&!kp(o,D)){c.input.ensurePolled(),clearTimeout(f);var A=+new Date;c.activeTouch={start:A,moved:!1,prev:A-p.end<=300?p:null},D.touches.length==1&&(c.activeTouch.left=D.touches[0].pageX,c.activeTouch.top=D.touches[0].pageY)}}),Ve(c.scroller,"touchmove",function(){c.activeTouch&&(c.activeTouch.moved=!0)}),Ve(c.scroller,"touchend",function(D){var A=c.activeTouch;if(A&&!ur(c,D)&&A.left!=null&&!A.moved&&new Date-A.start<300){var z=o.coordsChar(c.activeTouch,"page"),W;!A.prev||x(A,A.prev)?W=new tt(z,z):!A.prev.prev||x(A,A.prev.prev)?W=o.findWordAt(z):W=new tt(Z(z.line,0),ze(o.doc,Z(z.line+1,0))),o.setSelection(W.anchor,W.head),o.focus(),ii(D)}m()}),Ve(c.scroller,"touchcancel",m),Ve(c.scroller,"scroll",function(){c.scroller.clientHeight&&(ol(o,c.scroller.scrollTop),Vs(o,c.scroller.scrollLeft,!0),St(o,"scroll",o))}),Ve(c.scroller,"mousewheel",function(D){return J0(o,D)}),Ve(c.scroller,"DOMMouseScroll",function(D){return J0(o,D)}),Ve(c.wrapper,"scroll",function(){return c.wrapper.scrollTop=c.wrapper.scrollLeft=0}),c.dragFunctions={enter:function(D){bt(o,D)||Wr(D)},over:function(D){bt(o,D)||(bM(o,D),Wr(D))},start:function(D){return SM(o,D)},drop:$t(o,yM),leave:function(D){bt(o,D)||CS(o)}};var E=c.input.getField();Ve(E,"keyup",function(D){return AS.call(o,D)}),Ve(E,"keydown",$t(o,MS)),Ve(E,"keypress",$t(o,NS)),Ve(E,"focus",function(D){return sp(o,D)}),Ve(E,"blur",function(D){return La(o,D)})}var Ep=[];mt.defineInitHook=function(o){return Ep.push(o)};function El(o,c,f,p){var m=o.doc,S;f==null&&(f="add"),f=="smart"&&(m.mode.indent?S=Qo(o,c).state:f="prev");var x=o.options.tabSize,E=De(m,c),D=_e(E.text,null,x);E.stateAfter&&(E.stateAfter=null);var A=E.text.match(/^\s*/)[0],z;if(!p&&!/\S/.test(E.text))z=0,f="not";else if(f=="smart"&&(z=m.mode.indent(S,E.text.slice(A.length),E.text),z==Ft||z>150)){if(!p)return;f="prev"}f=="prev"?c>m.first?z=_e(De(m,c-1).text,null,x):z=0:f=="add"?z=D+o.options.indentUnit:f=="subtract"?z=D-o.options.indentUnit:typeof f=="number"&&(z=D+f),z=Math.max(0,z);var W="",X=0;if(o.options.indentWithTabs)for(var J=Math.floor(z/x);J;--J)X+=x,W+="	";if(X<z&&(W+=pn(z-X)),W!=A)return Ma(m,W,Z(c,0),Z(c,A.length),"+input"),E.stateAfter=null,!0;for(var Q=0;Q<m.sel.ranges.length;Q++){var ne=m.sel.ranges[Q];if(ne.head.line==c&&ne.head.ch<A.length){var ue=Z(c,A.length);yp(m,Q,new tt(ue,ue));break}}}var xn=null;function bd(o){xn=o}function Lp(o,c,f,p,m){var S=o.doc;o.display.shift=!1,p||(p=S.sel);var x=+new Date-200,E=m=="paste"||o.state.pasteIncoming>x,D=Zi(c),A=null;if(E&&p.ranges.length>1)if(xn&&xn.text.join(`
`)==c){if(p.ranges.length%xn.text.length==0){A=[];for(var z=0;z<xn.text.length;z++)A.push(S.splitLines(xn.text[z]))}}else D.length==p.ranges.length&&o.options.pasteLinesPerSelection&&(A=Ki(D,function(pe){return[pe]}));for(var W=o.curOp.updateInput,X=p.ranges.length-1;X>=0;X--){var J=p.ranges[X],Q=J.from(),ne=J.to();J.empty()&&(f&&f>0?Q=Z(Q.line,Q.ch-f):o.state.overwrite&&!E?ne=Z(ne.line,Math.min(De(S,ne.line).text.length,ne.ch+je(D).length)):E&&xn&&xn.lineWise&&xn.text.join(`
`)==D.join(`
`)&&(Q=ne=Z(Q.line,0)));var ue={from:Q,to:ne,text:A?A[X%A.length]:D,origin:m||(E?"paste":o.state.cutIncoming>x?"cut":"+input")};Ra(o.doc,ue),zt(o,"inputRead",o,ue)}c&&!E&&$S(o,c),Ta(o),o.curOp.updateInput<2&&(o.curOp.updateInput=W),o.curOp.typing=!0,o.state.pasteIncoming=o.state.cutIncoming=-1}function zS(o,c){var f=o.clipboardData&&o.clipboardData.getData("Text");if(f)return o.preventDefault(),!c.isReadOnly()&&!c.options.disableInput&&c.hasFocus()&&Vi(c,function(){return Lp(c,f,0,null,"paste")}),!0}function $S(o,c){if(!(!o.options.electricChars||!o.options.smartIndent))for(var f=o.doc.sel,p=f.ranges.length-1;p>=0;p--){var m=f.ranges[p];if(!(m.head.ch>100||p&&f.ranges[p-1].head.line==m.head.line)){var S=o.getModeAt(m.head),x=!1;if(S.electricChars){for(var E=0;E<S.electricChars.length;E++)if(c.indexOf(S.electricChars.charAt(E))>-1){x=El(o,m.head.line,"smart");break}}else S.electricInput&&S.electricInput.test(De(o.doc,m.head.line).text.slice(0,m.head.ch))&&(x=El(o,m.head.line,"smart"));x&&zt(o,"electricInput",o,m.head.line)}}}function GS(o){for(var c=[],f=[],p=0;p<o.doc.sel.ranges.length;p++){var m=o.doc.sel.ranges[p].head.line,S={anchor:Z(m,0),head:Z(m+1,0)};f.push(S),c.push(o.getRange(S.anchor,S.head))}return{text:c,ranges:f}}function Tp(o,c,f,p){o.setAttribute("autocorrect",f?"on":"off"),o.setAttribute("autocapitalize",p?"on":"off"),o.setAttribute("spellcheck",!!c)}function WS(){var o=_("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; min-height: 1em; outline: none"),c=_("div",[o],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return h?o.style.width="1000px":o.setAttribute("wrap","off"),L&&(o.style.border="1px solid black"),c}function HM(o){var c=o.optionHandlers,f=o.helpers={};o.prototype={constructor:o,focus:function(){Pe(this).focus(),this.display.input.focus()},setOption:function(p,m){var S=this.options,x=S[p];S[p]==m&&p!="mode"||(S[p]=m,c.hasOwnProperty(p)&&$t(this,c[p])(this,m,x),St(this,"optionChange",this,p))},getOption:function(p){return this.options[p]},getDoc:function(){return this.doc},addKeyMap:function(p,m){this.state.keyMaps[m?"push":"unshift"](vd(p))},removeKeyMap:function(p){for(var m=this.state.keyMaps,S=0;S<m.length;++S)if(m[S]==p||m[S].name==p)return m.splice(S,1),!0},addOverlay:ci(function(p,m){var S=p.token?p:o.getMode(this.options,p);if(S.startState)throw new Error("Overlays may not be stateful.");Fr(this.state.overlays,{mode:S,modeSpec:p,opaque:m&&m.opaque,priority:m&&m.priority||0},function(x){return x.priority}),this.state.modeGen++,Ci(this)}),removeOverlay:ci(function(p){for(var m=this.state.overlays,S=0;S<m.length;++S){var x=m[S].modeSpec;if(x==p||typeof p=="string"&&x.name==p){m.splice(S,1),this.state.modeGen++,Ci(this);return}}}),indentLine:ci(function(p,m,S){typeof m!="string"&&typeof m!="number"&&(m==null?m=this.options.smartIndent?"smart":"prev":m=m?"add":"subtract"),ee(this.doc,p)&&El(this,p,m,S)}),indentSelection:ci(function(p){for(var m=this.doc.sel.ranges,S=-1,x=0;x<m.length;x++){var E=m[x];if(E.empty())E.head.line>S&&(El(this,E.head.line,p,!0),S=E.head.line,x==this.doc.sel.primIndex&&Ta(this));else{var D=E.from(),A=E.to(),z=Math.max(S,D.line);S=Math.min(this.lastLine(),A.line-(A.ch?0:1))+1;for(var W=z;W<S;++W)El(this,W,p);var X=this.doc.sel.ranges;D.ch==0&&m.length==X.length&&X[x].from().ch>0&&yp(this.doc,x,new tt(D,X[x].to()),Xt)}}}),getTokenAt:function(p,m){return e0(this,p,m)},getLineTokens:function(p,m){return e0(this,Z(p),m,!0)},getTokenTypeAt:function(p){p=ze(this.doc,p);var m=Yy(this,De(this.doc,p.line)),S=0,x=(m.length-1)/2,E=p.ch,D;if(E==0)D=m[2];else for(;;){var A=S+x>>1;if((A?m[A*2-1]:0)>=E)x=A;else if(m[A*2+1]<E)S=A+1;else{D=m[A*2+2];break}}var z=D?D.indexOf("overlay "):-1;return z<0?D:z==0?null:D.slice(0,z-1)},getModeAt:function(p){var m=this.doc.mode;return m.innerMode?o.innerMode(m,this.getTokenAt(p).state).mode:m},getHelper:function(p,m){return this.getHelpers(p,m)[0]},getHelpers:function(p,m){var S=[];if(!f.hasOwnProperty(m))return S;var x=f[m],E=this.getModeAt(p);if(typeof E[m]=="string")x[E[m]]&&S.push(x[E[m]]);else if(E[m])for(var D=0;D<E[m].length;D++){var A=x[E[m][D]];A&&S.push(A)}else E.helperType&&x[E.helperType]?S.push(x[E.helperType]):x[E.name]&&S.push(x[E.name]);for(var z=0;z<x._global.length;z++){var W=x._global[z];W.pred(E,this)&&Ce(S,W.val)==-1&&S.push(W.val)}return S},getStateAfter:function(p,m){var S=this.doc;return p=Jy(S,p??S.first+S.size-1),Qo(this,p+1,m).state},cursorCoords:function(p,m){var S,x=this.doc.sel.primary();return p==null?S=x.head:typeof p=="object"?S=ze(this.doc,p):S=p?x.from():x.to(),wn(this,S,m||"page")},charCoords:function(p,m){return id(this,ze(this.doc,p),m||"page")},coordsChar:function(p,m){return p=P0(this,p,m||"page"),Yh(this,p.left,p.top)},lineAtHeight:function(p,m){return p=P0(this,{top:p,left:0},m||"page").top,G(this.doc,p+this.display.viewOffset)},heightAtLine:function(p,m,S){var x=!1,E;if(typeof p=="number"){var D=this.doc.first+this.doc.size-1;p<this.doc.first?p=this.doc.first:p>D&&(p=D,x=!0),E=De(this.doc,p)}else E=p;return td(this,E,{top:0,left:0},m||"page",S||x).top+(x?this.doc.height-dr(E):0)},defaultTextHeight:function(){return ka(this.display)},defaultCharWidth:function(){return Ea(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(p,m,S,x,E){var D=this.display;p=wn(this,ze(this.doc,p));var A=p.bottom,z=p.left;if(m.style.position="absolute",m.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(m),D.sizer.appendChild(m),x=="over")A=p.top;else if(x=="above"||x=="near"){var W=Math.max(D.wrapper.clientHeight,this.doc.height),X=Math.max(D.sizer.clientWidth,D.lineSpace.clientWidth);(x=="above"||p.bottom+m.offsetHeight>W)&&p.top>m.offsetHeight?A=p.top-m.offsetHeight:p.bottom+m.offsetHeight<=W&&(A=p.bottom),z+m.offsetWidth>X&&(z=X-m.offsetWidth)}m.style.top=A+"px",m.style.left=m.style.right="",E=="right"?(z=D.sizer.clientWidth-m.offsetWidth,m.style.right="0px"):(E=="left"?z=0:E=="middle"&&(z=(D.sizer.clientWidth-m.offsetWidth)/2),m.style.left=z+"px"),S&&$R(this,{left:z,top:A,right:z+m.offsetWidth,bottom:A+m.offsetHeight})},triggerOnKeyDown:ci(MS),triggerOnKeyPress:ci(NS),triggerOnKeyUp:AS,triggerOnMouseDown:ci(VS),execCommand:function(p){if(wl.hasOwnProperty(p))return wl[p].call(null,this)},triggerElectric:ci(function(p){$S(this,p)}),findPosH:function(p,m,S,x){var E=1;m<0&&(E=-1,m=-m);for(var D=ze(this.doc,p),A=0;A<m&&(D=Dp(this.doc,D,E,S,x),!D.hitSide);++A);return D},moveH:ci(function(p,m){var S=this;this.extendSelectionsBy(function(x){return S.display.shift||S.doc.extend||x.empty()?Dp(S.doc,x.head,p,m,S.options.rtlMoveVisually):p<0?x.from():x.to()},Kt)}),deleteH:ci(function(p,m){var S=this.doc.sel,x=this.doc;S.somethingSelected()?x.replaceSelection("",null,"+delete"):Va(this,function(E){var D=Dp(x,E.head,p,m,!1);return p<0?{from:D,to:E.head}:{from:E.head,to:D}})}),findPosV:function(p,m,S,x){var E=1,D=x;m<0&&(E=-1,m=-m);for(var A=ze(this.doc,p),z=0;z<m;++z){var W=wn(this,A,"div");if(D==null?D=W.left:W.left=D,A=HS(this,W,E,S),A.hitSide)break}return A},moveV:ci(function(p,m){var S=this,x=this.doc,E=[],D=!this.display.shift&&!x.extend&&x.sel.somethingSelected();if(x.extendSelectionsBy(function(z){if(D)return p<0?z.from():z.to();var W=wn(S,z.head,"div");z.goalColumn!=null&&(W.left=z.goalColumn),E.push(W.left);var X=HS(S,W,p,m);return m=="page"&&z==x.sel.primary()&&op(S,id(S,X,"div").top-W.top),X},Kt),E.length)for(var A=0;A<x.sel.ranges.length;A++)x.sel.ranges[A].goalColumn=E[A]}),findWordAt:function(p){var m=this.doc,S=De(m,p.line).text,x=p.ch,E=p.ch;if(S){var D=this.getHelper(p,"wordChars");(p.sticky=="before"||E==S.length)&&x?--x:++E;for(var A=S.charAt(x),z=$i(A,D)?function(W){return $i(W,D)}:/\s/.test(A)?function(W){return/\s/.test(W)}:function(W){return!/\s/.test(W)&&!$i(W)};x>0&&z(S.charAt(x-1));)--x;for(;E<S.length&&z(S.charAt(E));)++E}return new tt(Z(p.line,x),Z(p.line,E))},toggleOverwrite:function(p){p!=null&&p==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?we(this.display.cursorDiv,"CodeMirror-overwrite"):U(this.display.cursorDiv,"CodeMirror-overwrite"),St(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==le(Fe(this))},isReadOnly:function(){return!!(this.options.readOnly||this.doc.cantEdit)},scrollTo:ci(function(p,m){al(this,p,m)}),getScrollInfo:function(){var p=this.display.scroller;return{left:p.scrollLeft,top:p.scrollTop,height:p.scrollHeight-_n(this)-this.display.barHeight,width:p.scrollWidth-_n(this)-this.display.barWidth,clientHeight:qh(this),clientWidth:Rs(this)}},scrollIntoView:ci(function(p,m){p==null?(p={from:this.doc.sel.primary().head,to:null},m==null&&(m=this.options.cursorScrollMargin)):typeof p=="number"?p={from:Z(p,0),to:null}:p.from==null&&(p={from:p,to:null}),p.to||(p.to=p.from),p.margin=m||0,p.from.line!=null?GR(this,p):_0(this,p.from,p.to,p.margin)}),setSize:ci(function(p,m){var S=this,x=function(D){return typeof D=="number"||/^\d+$/.test(String(D))?D+"px":D};p!=null&&(this.display.wrapper.style.width=x(p)),m!=null&&(this.display.wrapper.style.height=x(m)),this.options.lineWrapping&&L0(this);var E=this.display.viewFrom;this.doc.iter(E,this.display.viewTo,function(D){if(D.widgets){for(var A=0;A<D.widgets.length;A++)if(D.widgets[A].noHScroll){Xr(S,E,"widget");break}}++E}),this.curOp.forceUpdate=!0,St(this,"refresh",this)}),operation:function(p){return Vi(this,p)},startOperation:function(){return Bs(this)},endOperation:function(){return _s(this)},refresh:ci(function(){var p=this.display.cachedTextHeight;Ci(this),this.curOp.forceUpdate=!0,rl(this),al(this,this.doc.scrollLeft,this.doc.scrollTop),dp(this.display),(p==null||Math.abs(p-ka(this.display))>.5||this.options.lineWrapping)&&tp(this),St(this,"refresh",this)}),swapDoc:ci(function(p){var m=this.doc;return m.cm=null,this.state.selectingText&&this.state.selectingText(),Z0(this,p),rl(this),this.display.input.reset(),al(this,p.scrollLeft,p.scrollTop),this.curOp.forceScroll=!0,zt(this,"swapDoc",this,m),m}),phrase:function(p){var m=this.options.phrases;return m&&Object.prototype.hasOwnProperty.call(m,p)?m[p]:p},getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},gn(o),o.registerHelper=function(p,m,S){f.hasOwnProperty(p)||(f[p]=o[p]={_global:[]}),f[p][m]=S},o.registerGlobalHelper=function(p,m,S,x){o.registerHelper(p,m,x),f[p]._global.push({pred:S,val:x})}}function Dp(o,c,f,p,m){var S=c,x=f,E=De(o,c.line),D=m&&o.direction=="rtl"?-f:f;function A(){var Se=c.line+D;return Se<o.first||Se>=o.first+o.size?!1:(c=new Z(Se,c.ch,c.sticky),E=De(o,Se))}function z(Se){var fe;if(p=="codepoint"){var xe=E.text.charCodeAt(c.ch+(f>0?0:-1));if(isNaN(xe))fe=null;else{var Be=f>0?xe>=55296&&xe<56320:xe>=56320&&xe<57343;fe=new Z(c.line,Math.max(0,Math.min(E.text.length,c.ch+f*(Be?2:1))),-f)}}else m?fe=LM(o.cm,E,c,f):fe=bp(E,c,f);if(fe==null)if(!Se&&A())c=wp(m,o.cm,E,c.line,D);else return!1;else c=fe;return!0}if(p=="char"||p=="codepoint")z();else if(p=="column")z(!0);else if(p=="word"||p=="group")for(var W=null,X=p=="group",J=o.cm&&o.cm.getHelper(c,"wordChars"),Q=!0;!(f<0&&!z(!Q));Q=!1){var ne=E.text.charAt(c.ch)||`
`,ue=$i(ne,J)?"w":X&&ne==`
`?"n":!X||/\s/.test(ne)?null:"p";if(X&&!Q&&!ue&&(ue="s"),W&&W!=ue){f<0&&(f=1,z(),c.sticky="after");break}if(ue&&(W=ue),f>0&&!z(!Q))break}var pe=fd(o,c,S,x,!0);return et(S,pe)&&(pe.hitSide=!0),pe}function HS(o,c,f,p){var m=o.doc,S=c.left,x;if(p=="page"){var E=Math.min(o.display.wrapper.clientHeight,Pe(o).innerHeight||m(o).documentElement.clientHeight),D=Math.max(E-.5*ka(o.display),3);x=(f>0?c.bottom:c.top)+f*D}else p=="line"&&(x=f>0?c.bottom+3:c.top-3);for(var A;A=Yh(o,S,x),!!A.outside;){if(f<0?x<=0:x>=m.height){A.hitSide=!0;break}x+=f*5}return A}var ot=function(o){this.cm=o,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new Ue,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};ot.prototype.init=function(o){var c=this,f=this,p=f.cm,m=f.div=o.lineDiv;m.contentEditable=!0,Tp(m,p.options.spellcheck,p.options.autocorrect,p.options.autocapitalize);function S(E){for(var D=E.target;D;D=D.parentNode){if(D==m)return!0;if(/\bCodeMirror-(?:line)?widget\b/.test(D.className))break}return!1}Ve(m,"paste",function(E){!S(E)||bt(p,E)||zS(E,p)||u<=11&&setTimeout($t(p,function(){return c.updateFromDOM()}),20)}),Ve(m,"compositionstart",function(E){c.composing={data:E.data,done:!1}}),Ve(m,"compositionupdate",function(E){c.composing||(c.composing={data:E.data,done:!1})}),Ve(m,"compositionend",function(E){c.composing&&(E.data!=c.composing.data&&c.readFromDOMSoon(),c.composing.done=!0)}),Ve(m,"touchstart",function(){return f.forceCompositionEnd()}),Ve(m,"input",function(){c.composing||c.readFromDOMSoon()});function x(E){if(!(!S(E)||bt(p,E))){if(p.somethingSelected())bd({lineWise:!1,text:p.getSelections()}),E.type=="cut"&&p.replaceSelection("",null,"cut");else if(p.options.lineWiseCopyCut){var D=GS(p);bd({lineWise:!0,text:D.text}),E.type=="cut"&&p.operation(function(){p.setSelections(D.ranges,0,Xt),p.replaceSelection("",null,"cut")})}else return;if(E.clipboardData){E.clipboardData.clearData();var A=xn.text.join(`
`);if(E.clipboardData.setData("Text",A),E.clipboardData.getData("Text")==A){E.preventDefault();return}}var z=WS(),W=z.firstChild;Tp(W),p.display.lineSpace.insertBefore(z,p.display.lineSpace.firstChild),W.value=xn.text.join(`
`);var X=le(Ge(m));he(W),setTimeout(function(){p.display.lineSpace.removeChild(z),X.focus(),X==m&&f.showPrimarySelection()},50)}}Ve(m,"copy",x),Ve(m,"cut",x)},ot.prototype.screenReaderLabelChanged=function(o){o?this.div.setAttribute("aria-label",o):this.div.removeAttribute("aria-label")},ot.prototype.prepareSelection=function(){var o=V0(this.cm,!1);return o.focus=le(Ge(this.div))==this.div,o},ot.prototype.showSelection=function(o,c){!o||!this.cm.display.view.length||((o.focus||c)&&this.showPrimarySelection(),this.showMultipleSelections(o))},ot.prototype.getSelection=function(){return this.cm.display.wrapper.ownerDocument.getSelection()},ot.prototype.showPrimarySelection=function(){var o=this.getSelection(),c=this.cm,f=c.doc.sel.primary(),p=f.from(),m=f.to();if(c.display.viewTo==c.display.viewFrom||p.line>=c.display.viewTo||m.line<c.display.viewFrom){o.removeAllRanges();return}var S=wd(c,o.anchorNode,o.anchorOffset),x=wd(c,o.focusNode,o.focusOffset);if(!(S&&!S.bad&&x&&!x.bad&&me(ba(S,x),p)==0&&me(wi(S,x),m)==0)){var E=c.display.view,D=p.line>=c.display.viewFrom&&jS(c,p)||{node:E[0].measure.map[2],offset:0},A=m.line<c.display.viewTo&&jS(c,m);if(!A){var z=E[E.length-1].measure,W=z.maps?z.maps[z.maps.length-1]:z.map;A={node:W[W.length-1],offset:W[W.length-2]-W[W.length-3]}}if(!D||!A){o.removeAllRanges();return}var X=o.rangeCount&&o.getRangeAt(0),J;try{J=oe(D.node,D.offset,A.offset,A.node)}catch{}J&&(!r&&c.state.focused?(o.collapse(D.node,D.offset),J.collapsed||(o.removeAllRanges(),o.addRange(J))):(o.removeAllRanges(),o.addRange(J)),X&&o.anchorNode==null?o.addRange(X):r&&this.startGracePeriod()),this.rememberSelection()}},ot.prototype.startGracePeriod=function(){var o=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){o.gracePeriod=!1,o.selectionChanged()&&o.cm.operation(function(){return o.cm.curOp.selectionChanged=!0})},20)},ot.prototype.showMultipleSelections=function(o){$(this.cm.display.cursorDiv,o.cursors),$(this.cm.display.selectionDiv,o.selection)},ot.prototype.rememberSelection=function(){var o=this.getSelection();this.lastAnchorNode=o.anchorNode,this.lastAnchorOffset=o.anchorOffset,this.lastFocusNode=o.focusNode,this.lastFocusOffset=o.focusOffset},ot.prototype.selectionInEditor=function(){var o=this.getSelection();if(!o.rangeCount)return!1;var c=o.getRangeAt(0).commonAncestorContainer;return Re(this.div,c)},ot.prototype.focus=function(){this.cm.options.readOnly!="nocursor"&&((!this.selectionInEditor()||le(Ge(this.div))!=this.div)&&this.showSelection(this.prepareSelection(),!0),this.div.focus())},ot.prototype.blur=function(){this.div.blur()},ot.prototype.getField=function(){return this.div},ot.prototype.supportsTouch=function(){return!0},ot.prototype.receivedFocus=function(){var o=this,c=this;this.selectionInEditor()?setTimeout(function(){return o.pollSelection()},20):Vi(this.cm,function(){return c.cm.curOp.selectionChanged=!0});function f(){c.cm.state.focused&&(c.pollSelection(),c.polling.set(c.cm.options.pollInterval,f))}this.polling.set(this.cm.options.pollInterval,f)},ot.prototype.selectionChanged=function(){var o=this.getSelection();return o.anchorNode!=this.lastAnchorNode||o.anchorOffset!=this.lastAnchorOffset||o.focusNode!=this.lastFocusNode||o.focusOffset!=this.lastFocusOffset},ot.prototype.pollSelection=function(){if(!(this.readDOMTimeout!=null||this.gracePeriod||!this.selectionChanged())){var o=this.getSelection(),c=this.cm;if(I&&v&&this.cm.display.gutterSpecs.length&&jM(o.anchorNode)){this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),this.focus();return}if(!this.composing){this.rememberSelection();var f=wd(c,o.anchorNode,o.anchorOffset),p=wd(c,o.focusNode,o.focusOffset);f&&p&&Vi(c,function(){ni(c.doc,Yr(f,p),Xt),(f.bad||p.bad)&&(c.curOp.selectionChanged=!0)})}}},ot.prototype.pollContent=function(){this.readDOMTimeout!=null&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var o=this.cm,c=o.display,f=o.doc.sel.primary(),p=f.from(),m=f.to();if(p.ch==0&&p.line>o.firstLine()&&(p=Z(p.line-1,De(o.doc,p.line-1).length)),m.ch==De(o.doc,m.line).text.length&&m.line<o.lastLine()&&(m=Z(m.line+1,0)),p.line<c.viewFrom||m.line>c.viewTo-1)return!1;var S,x,E;p.line==c.viewFrom||(S=Ns(o,p.line))==0?(x=N(c.view[0].line),E=c.view[0].node):(x=N(c.view[S].line),E=c.view[S-1].node.nextSibling);var D=Ns(o,m.line),A,z;if(D==c.view.length-1?(A=c.viewTo-1,z=c.lineDiv.lastChild):(A=N(c.view[D+1].line)-1,z=c.view[D+1].node.previousSibling),!E)return!1;for(var W=o.doc.splitLines(qM(o,E,z,x,A)),X=lr(o.doc,Z(x,0),Z(A,De(o.doc,A).text.length));W.length>1&&X.length>1;)if(je(W)==je(X))W.pop(),X.pop(),A--;else if(W[0]==X[0])W.shift(),X.shift(),x++;else break;for(var J=0,Q=0,ne=W[0],ue=X[0],pe=Math.min(ne.length,ue.length);J<pe&&ne.charCodeAt(J)==ue.charCodeAt(J);)++J;for(var Se=je(W),fe=je(X),xe=Math.min(Se.length-(W.length==1?J:0),fe.length-(X.length==1?J:0));Q<xe&&Se.charCodeAt(Se.length-Q-1)==fe.charCodeAt(fe.length-Q-1);)++Q;if(W.length==1&&X.length==1&&x==p.line)for(;J&&J>p.ch&&Se.charCodeAt(Se.length-Q-1)==fe.charCodeAt(fe.length-Q-1);)J--,Q++;W[W.length-1]=Se.slice(0,Se.length-Q).replace(/^\u200b+/,""),W[0]=W[0].slice(J).replace(/\u200b+$/,"");var Be=Z(x,J),Ae=Z(A,X.length?je(X).length-Q:0);if(W.length>1||W[0]||me(Be,Ae))return Ma(o.doc,W,Be,Ae,"+input"),!0},ot.prototype.ensurePolled=function(){this.forceCompositionEnd()},ot.prototype.reset=function(){this.forceCompositionEnd()},ot.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},ot.prototype.readFromDOMSoon=function(){var o=this;this.readDOMTimeout==null&&(this.readDOMTimeout=setTimeout(function(){if(o.readDOMTimeout=null,o.composing)if(o.composing.done)o.composing=null;else return;o.updateFromDOM()},80))},ot.prototype.updateFromDOM=function(){var o=this;(this.cm.isReadOnly()||!this.pollContent())&&Vi(this.cm,function(){return Ci(o.cm)})},ot.prototype.setUneditable=function(o){o.contentEditable="false"},ot.prototype.onKeyPress=function(o){o.charCode==0||this.composing||(o.preventDefault(),this.cm.isReadOnly()||$t(this.cm,Lp)(this.cm,String.fromCharCode(o.charCode==null?o.keyCode:o.charCode),0))},ot.prototype.readOnlyChanged=function(o){this.div.contentEditable=String(o!="nocursor")},ot.prototype.onContextMenu=function(){},ot.prototype.resetPosition=function(){},ot.prototype.needsContentAttribute=!0;function jS(o,c){var f=Jh(o,c.line);if(!f||f.hidden)return null;var p=De(o.doc,c.line),m=w0(f,p,c.line),S=qe(p,o.doc.direction),x="left";if(S){var E=Gr(S,c.ch);x=E%2?"right":"left"}var D=k0(m.map,c.ch,x);return D.offset=D.collapse=="right"?D.end:D.start,D}function jM(o){for(var c=o;c;c=c.parentNode)if(/CodeMirror-gutter-wrapper/.test(c.className))return!0;return!1}function Ba(o,c){return c&&(o.bad=!0),o}function qM(o,c,f,p,m){var S="",x=!1,E=o.doc.lineSeparator(),D=!1;function A(J){return function(Q){return Q.id==J}}function z(){x&&(S+=E,D&&(S+=E),x=D=!1)}function W(J){J&&(z(),S+=J)}function X(J){if(J.nodeType==1){var Q=J.getAttribute("cm-text");if(Q){W(Q);return}var ne=J.getAttribute("cm-marker"),ue;if(ne){var pe=o.findMarks(Z(p,0),Z(m+1,0),A(+ne));pe.length&&(ue=pe[0].find(0))&&W(lr(o.doc,ue.from,ue.to).join(E));return}if(J.getAttribute("contenteditable")=="false")return;var Se=/^(pre|div|p|li|table|br)$/i.test(J.nodeName);if(!/^br$/i.test(J.nodeName)&&J.textContent.length==0)return;Se&&z();for(var fe=0;fe<J.childNodes.length;fe++)X(J.childNodes[fe]);/^(pre|p)$/i.test(J.nodeName)&&(D=!0),Se&&(x=!0)}else J.nodeType==3&&W(J.nodeValue.replace(/\u200b/g,"").replace(/\u00a0/g," "))}for(;X(c),c!=f;)c=c.nextSibling,D=!1;return S}function wd(o,c,f){var p;if(c==o.display.lineDiv){if(p=o.display.lineDiv.childNodes[f],!p)return Ba(o.clipPos(Z(o.display.viewTo-1)),!0);c=null,f=0}else for(p=c;;p=p.parentNode){if(!p||p==o.display.lineDiv)return null;if(p.parentNode&&p.parentNode==o.display.lineDiv)break}for(var m=0;m<o.display.view.length;m++){var S=o.display.view[m];if(S.node==p)return JM(S,c,f)}}function JM(o,c,f){var p=o.text.firstChild,m=!1;if(!c||!Re(p,c))return Ba(Z(N(o.line),0),!0);if(c==p&&(m=!0,c=p.childNodes[f],f=0,!c)){var S=o.rest?je(o.rest):o.line;return Ba(Z(N(S),S.text.length),m)}var x=c.nodeType==3?c:null,E=c;for(!x&&c.childNodes.length==1&&c.firstChild.nodeType==3&&(x=c.firstChild,f&&(f=x.nodeValue.length));E.parentNode!=p;)E=E.parentNode;var D=o.measure,A=D.maps;function z(ue,pe,Se){for(var fe=-1;fe<(A?A.length:0);fe++)for(var xe=fe<0?D.map:A[fe],Be=0;Be<xe.length;Be+=3){var Ae=xe[Be+2];if(Ae==ue||Ae==pe){var He=N(fe<0?o.line:o.rest[fe]),ht=xe[Be]+Se;return(Se<0||Ae!=ue)&&(ht=xe[Be+(Se?1:0)]),Z(He,ht)}}}var W=z(x,E,f);if(W)return Ba(W,m);for(var X=E.nextSibling,J=x?x.nodeValue.length-f:0;X;X=X.nextSibling){if(W=z(X,X.firstChild,0),W)return Ba(Z(W.line,W.ch-J),m);J+=X.textContent.length}for(var Q=E.previousSibling,ne=f;Q;Q=Q.previousSibling){if(W=z(Q,Q.firstChild,-1),W)return Ba(Z(W.line,W.ch+ne),m);ne+=Q.textContent.length}}var Lt=function(o){this.cm=o,this.prevInput="",this.pollingFast=!1,this.polling=new Ue,this.hasSelection=!1,this.composing=null,this.resetting=!1};Lt.prototype.init=function(o){var c=this,f=this,p=this.cm;this.createField(o);var m=this.textarea;o.wrapper.insertBefore(this.wrapper,o.wrapper.firstChild),L&&(m.style.width="0px"),Ve(m,"input",function(){d&&u>=9&&c.hasSelection&&(c.hasSelection=null),f.poll()}),Ve(m,"paste",function(x){bt(p,x)||zS(x,p)||(p.state.pasteIncoming=+new Date,f.fastPoll())});function S(x){if(!bt(p,x)){if(p.somethingSelected())bd({lineWise:!1,text:p.getSelections()});else if(p.options.lineWiseCopyCut){var E=GS(p);bd({lineWise:!0,text:E.text}),x.type=="cut"?p.setSelections(E.ranges,null,Xt):(f.prevInput="",m.value=E.text.join(`
`),he(m))}else return;x.type=="cut"&&(p.state.cutIncoming=+new Date)}}Ve(m,"cut",S),Ve(m,"copy",S),Ve(o.scroller,"paste",function(x){if(!(ur(o,x)||bt(p,x))){if(!m.dispatchEvent){p.state.pasteIncoming=+new Date,f.focus();return}var E=new Event("paste");E.clipboardData=x.clipboardData,m.dispatchEvent(E)}}),Ve(o.lineSpace,"selectstart",function(x){ur(o,x)||ii(x)}),Ve(m,"compositionstart",function(){var x=p.getCursor("from");f.composing&&f.composing.range.clear(),f.composing={start:x,range:p.markText(x,p.getCursor("to"),{className:"CodeMirror-composing"})}}),Ve(m,"compositionend",function(){f.composing&&(f.poll(),f.composing.range.clear(),f.composing=null)})},Lt.prototype.createField=function(o){this.wrapper=WS(),this.textarea=this.wrapper.firstChild;var c=this.cm.options;Tp(this.textarea,c.spellcheck,c.autocorrect,c.autocapitalize)},Lt.prototype.screenReaderLabelChanged=function(o){o?this.textarea.setAttribute("aria-label",o):this.textarea.removeAttribute("aria-label")},Lt.prototype.prepareSelection=function(){var o=this.cm,c=o.display,f=o.doc,p=V0(o);if(o.options.moveInputWithCursor){var m=wn(o,f.sel.primary().head,"div"),S=c.wrapper.getBoundingClientRect(),x=c.lineDiv.getBoundingClientRect();p.teTop=Math.max(0,Math.min(c.wrapper.clientHeight-10,m.top+x.top-S.top)),p.teLeft=Math.max(0,Math.min(c.wrapper.clientWidth-10,m.left+x.left-S.left))}return p},Lt.prototype.showSelection=function(o){var c=this.cm,f=c.display;$(f.cursorDiv,o.cursors),$(f.selectionDiv,o.selection),o.teTop!=null&&(this.wrapper.style.top=o.teTop+"px",this.wrapper.style.left=o.teLeft+"px")},Lt.prototype.reset=function(o){if(!(this.contextMenuPending||this.composing&&o)){var c=this.cm;if(this.resetting=!0,c.somethingSelected()){this.prevInput="";var f=c.getSelection();this.textarea.value=f,c.state.focused&&he(this.textarea),d&&u>=9&&(this.hasSelection=f)}else o||(this.prevInput=this.textarea.value="",d&&u>=9&&(this.hasSelection=null));this.resetting=!1}},Lt.prototype.getField=function(){return this.textarea},Lt.prototype.supportsTouch=function(){return!1},Lt.prototype.focus=function(){if(this.cm.options.readOnly!="nocursor"&&(!P||le(Ge(this.textarea))!=this.textarea))try{this.textarea.focus()}catch{}},Lt.prototype.blur=function(){this.textarea.blur()},Lt.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Lt.prototype.receivedFocus=function(){this.slowPoll()},Lt.prototype.slowPoll=function(){var o=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){o.poll(),o.cm.state.focused&&o.slowPoll()})},Lt.prototype.fastPoll=function(){var o=!1,c=this;c.pollingFast=!0;function f(){var p=c.poll();!p&&!o?(o=!0,c.polling.set(60,f)):(c.pollingFast=!1,c.slowPoll())}c.polling.set(20,f)},Lt.prototype.poll=function(){var o=this,c=this.cm,f=this.textarea,p=this.prevInput;if(this.contextMenuPending||this.resetting||!c.state.focused||jr(f)&&!p&&!this.composing||c.isReadOnly()||c.options.disableInput||c.state.keySeq)return!1;var m=f.value;if(m==p&&!c.somethingSelected())return!1;if(d&&u>=9&&this.hasSelection===m||T&&/[\uf700-\uf7ff]/.test(m))return c.display.input.reset(),!1;if(c.doc.sel==c.display.selForContextMenu){var S=m.charCodeAt(0);if(S==8203&&!p&&(p="​"),S==8666)return this.reset(),this.cm.execCommand("undo")}for(var x=0,E=Math.min(p.length,m.length);x<E&&p.charCodeAt(x)==m.charCodeAt(x);)++x;return Vi(c,function(){Lp(c,m.slice(x),p.length-x,null,o.composing?"*compose":null),m.length>1e3||m.indexOf(`
`)>-1?f.value=o.prevInput="":o.prevInput=m,o.composing&&(o.composing.range.clear(),o.composing.range=c.markText(o.composing.start,c.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Lt.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Lt.prototype.onKeyPress=function(){d&&u>=9&&(this.hasSelection=null),this.fastPoll()},Lt.prototype.onContextMenu=function(o){var c=this,f=c.cm,p=f.display,m=c.textarea;c.contextMenuPending&&c.contextMenuPending();var S=As(f,o),x=p.scroller.scrollTop;if(!S||C)return;var E=f.options.resetSelectionOnContextMenu;E&&f.doc.sel.contains(S)==-1&&$t(f,ni)(f.doc,Yr(S),Xt);var D=m.style.cssText,A=c.wrapper.style.cssText,z=c.wrapper.offsetParent.getBoundingClientRect();c.wrapper.style.cssText="position: static",m.style.cssText=`position: absolute; width: 30px; height: 30px;
      top: `+(o.clientY-z.top-5)+"px; left: "+(o.clientX-z.left-5)+`px;
      z-index: 1000; background: `+(d?"rgba(255, 255, 255, .05)":"transparent")+`;
      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);`;var W;h&&(W=m.ownerDocument.defaultView.scrollY),p.input.focus(),h&&m.ownerDocument.defaultView.scrollTo(null,W),p.input.reset(),f.somethingSelected()||(m.value=c.prevInput=" "),c.contextMenuPending=J,p.selForContextMenu=f.doc.sel,clearTimeout(p.detectingSelectAll);function X(){if(m.selectionStart!=null){var ne=f.somethingSelected(),ue="​"+(ne?m.value:"");m.value="⇚",m.value=ue,c.prevInput=ne?"":"​",m.selectionStart=1,m.selectionEnd=ue.length,p.selForContextMenu=f.doc.sel}}function J(){if(c.contextMenuPending==J&&(c.contextMenuPending=!1,c.wrapper.style.cssText=A,m.style.cssText=D,d&&u<9&&p.scrollbars.setScrollTop(p.scroller.scrollTop=x),m.selectionStart!=null)){(!d||d&&u<9)&&X();var ne=0,ue=function(){p.selForContextMenu==f.doc.sel&&m.selectionStart==0&&m.selectionEnd>0&&c.prevInput=="​"?$t(f,uS)(f):ne++<10?p.detectingSelectAll=setTimeout(ue,500):(p.selForContextMenu=null,p.input.reset())};p.detectingSelectAll=setTimeout(ue,200)}}if(d&&u>=9&&X(),F){Wr(o);var Q=function(){ti(window,"mouseup",Q),setTimeout(J,20)};Ve(window,"mouseup",Q)}else setTimeout(J,50)},Lt.prototype.readOnlyChanged=function(o){o||this.reset(),this.textarea.disabled=o=="nocursor",this.textarea.readOnly=!!o},Lt.prototype.setUneditable=function(){},Lt.prototype.needsContentAttribute=!1;function XM(o,c){if(c=c?Me(c):{},c.value=o.value,!c.tabindex&&o.tabIndex&&(c.tabindex=o.tabIndex),!c.placeholder&&o.placeholder&&(c.placeholder=o.placeholder),c.autofocus==null){var f=le(Ge(o));c.autofocus=f==o||o.getAttribute("autofocus")!=null&&f==document.body}function p(){o.value=E.getValue()}var m;if(o.form&&(Ve(o.form,"submit",p),!c.leaveSubmitMethodAlone)){var S=o.form;m=S.submit;try{var x=S.submit=function(){p(),S.submit=m,S.submit(),S.submit=x}}catch{}}c.finishInit=function(D){D.save=p,D.getTextArea=function(){return o},D.toTextArea=function(){D.toTextArea=isNaN,p(),o.parentNode.removeChild(D.getWrapperElement()),o.style.display="",o.form&&(ti(o.form,"submit",p),!c.leaveSubmitMethodAlone&&typeof o.form.submit=="function"&&(o.form.submit=m))}},o.style.display="none";var E=mt(function(D){return o.parentNode.insertBefore(D,o.nextSibling)},c);return E}function KM(o){o.off=ti,o.on=Ve,o.wheelEventPixels=nM,o.Doc=xi,o.splitLines=Zi,o.countColumn=_e,o.findColumn=li,o.isWordChar=Ps,o.Pass=Ft,o.signal=St,o.Line=wa,o.changeEnd=Zr,o.scrollbarModel=z0,o.Pos=Z,o.cmpPos=me,o.modes=fa,o.mimeModes=yn,o.resolveMode=ma,o.getMode=va,o.modeExtensions=qr,o.extendMode=ya,o.copyState=On,o.startState=Sa,o.innerMode=Yo,o.commands=wl,o.keyMap=pr,o.keyName=TS,o.isModifierKey=ES,o.lookupKey=Na,o.normalizeKeyMap=EM,o.StringStream=wt,o.SharedTextMarker=yl,o.TextMarker=es,o.LineWidget=vl,o.e_preventDefault=ii,o.e_stopPropagation=ha,o.e_stop=Wr,o.addClass=we,o.contains=Re,o.rmClass=U,o.keyNames=ts}zM(mt),HM(mt);var YM="iter insert remove copy getEditor constructor".split(" ");for(var Cd in xi.prototype)xi.prototype.hasOwnProperty(Cd)&&Ce(YM,Cd)<0&&(mt.prototype[Cd]=(function(o){return function(){return o.apply(this.doc,arguments)}})(xi.prototype[Cd]));return gn(xi),mt.inputStyles={textarea:Lt,contenteditable:ot},mt.defineMode=function(o){!mt.defaults.mode&&o!="null"&&(mt.defaults.mode=o),Sn.apply(this,arguments)},mt.defineMIME=ga,mt.defineMode("null",function(){return{token:function(o){return o.skipToEnd()}}}),mt.defineMIME("text/plain","null"),mt.defineExtension=function(o,c){mt.prototype[o]=c},mt.defineDocExtension=function(o,c){xi.prototype[o]=c},mt.fromTextArea=XM,KM(mt),mt.version="5.65.18",mt})})(cm)),cm.exports}var lk;function X$(){return lk||(lk=1,(function(i,e){(function(t){t(Go())})(function(t){t.defineMode("javascript",function(n,r){var s=n.indentUnit,a=r.statementIndent,l=r.jsonld,d=r.json||l,u=r.trackScope!==!1,h=r.typescript,g=r.wordCharacters||/[\w$\xa1-\uffff]/,v=(function(){function N(Ut){return{type:Ut,style:"keyword"}}var G=N("keyword a"),ee=N("keyword b"),de=N("keyword c"),Z=N("keyword d"),me=N("operator"),et={type:"atom",style:"atom"};return{if:N("if"),while:G,with:G,else:ee,do:ee,try:ee,finally:ee,return:Z,break:Z,continue:Z,new:N("new"),delete:de,void:de,throw:de,debugger:N("debugger"),var:N("var"),const:N("var"),let:N("var"),function:N("function"),catch:N("catch"),for:N("for"),switch:N("switch"),case:N("case"),default:N("default"),in:me,typeof:me,instanceof:me,true:et,false:et,null:et,undefined:et,NaN:et,Infinity:et,this:N("this"),class:N("class"),super:N("atom"),yield:de,export:N("export"),import:N("import"),extends:de,await:de}})(),y=/[+\-*&%=<>!?|~^@]/,C=/^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;function w(N){for(var G=!1,ee,de=!1;(ee=N.next())!=null;){if(!G){if(ee=="/"&&!de)return;ee=="["?de=!0:de&&ee=="]"&&(de=!1)}G=!G&&ee=="\\"}}var b,k;function L(N,G,ee){return b=N,k=ee,G}function I(N,G){var ee=N.next();if(ee=='"'||ee=="'")return G.tokenize=P(ee),G.tokenize(N,G);if(ee=="."&&N.match(/^\d[\d_]*(?:[eE][+\-]?[\d_]+)?/))return L("number","number");if(ee=="."&&N.match(".."))return L("spread","meta");if(/[\[\]{}\(\),;\:\.]/.test(ee))return L(ee);if(ee=="="&&N.eat(">"))return L("=>","operator");if(ee=="0"&&N.match(/^(?:x[\dA-Fa-f_]+|o[0-7_]+|b[01_]+)n?/))return L("number","number");if(/\d/.test(ee))return N.match(/^[\d_]*(?:n|(?:\.[\d_]*)?(?:[eE][+\-]?[\d_]+)?)?/),L("number","number");if(ee=="/")return N.eat("*")?(G.tokenize=T,T(N,G)):N.eat("/")?(N.skipToEnd(),L("comment","comment")):Gi(N,G,1)?(w(N),N.match(/^\b(([gimyus])(?![gimyus]*\2))+\b/),L("regexp","string-2")):(N.eat("="),L("operator","operator",N.current()));if(ee=="`")return G.tokenize=R,R(N,G);if(ee=="#"&&N.peek()=="!")return N.skipToEnd(),L("meta","meta");if(ee=="#"&&N.eatWhile(g))return L("variable","property");if(ee=="<"&&N.match("!--")||ee=="-"&&N.match("->")&&!/\S/.test(N.string.slice(0,N.start)))return N.skipToEnd(),L("comment","comment");if(y.test(ee))return(ee!=">"||!G.lexical||G.lexical.type!=">")&&(N.eat("=")?(ee=="!"||ee=="=")&&N.eat("="):/[<>*+\-|&?]/.test(ee)&&(N.eat(ee),ee==">"&&N.eat(ee))),ee=="?"&&N.eat(".")?L("."):L("operator","operator",N.current());if(g.test(ee)){N.eatWhile(g);var de=N.current();if(G.lastType!="."){if(v.propertyIsEnumerable(de)){var Z=v[de];return L(Z.type,Z.style,de)}if(de=="async"&&N.match(/^(\s|\/\*([^*]|\*(?!\/))*?\*\/)*[\[\(\w]/,!1))return L("async","keyword",de)}return L("variable","variable",de)}}function P(N){return function(G,ee){var de=!1,Z;if(l&&G.peek()=="@"&&G.match(C))return ee.tokenize=I,L("jsonld-keyword","meta");for(;(Z=G.next())!=null&&!(Z==N&&!de);)de=!de&&Z=="\\";return de||(ee.tokenize=I),L("string","string")}}function T(N,G){for(var ee=!1,de;de=N.next();){if(de=="/"&&ee){G.tokenize=I;break}ee=de=="*"}return L("comment","comment")}function R(N,G){for(var ee=!1,de;(de=N.next())!=null;){if(!ee&&(de=="`"||de=="$"&&N.eat("{"))){G.tokenize=I;break}ee=!ee&&de=="\\"}return L("quasi","string-2",N.current())}var M="([{}])";function V(N,G){G.fatArrowAt&&(G.fatArrowAt=null);var ee=N.string.indexOf("=>",N.start);if(!(ee<0)){if(h){var de=/:\s*(?:\w+(?:<[^>]*>|\[\])?|\{[^}]*\})\s*$/.exec(N.string.slice(N.start,ee));de&&(ee=de.index)}for(var Z=0,me=!1,et=ee-1;et>=0;--et){var Ut=N.string.charAt(et),wi=M.indexOf(Ut);if(wi>=0&&wi<3){if(!Z){++et;break}if(--Z==0){Ut=="("&&(me=!0);break}}else if(wi>=3&&wi<6)++Z;else if(g.test(Ut))me=!0;else if(/["'\/`]/.test(Ut))for(;;--et){if(et==0)return;var ba=N.string.charAt(et-1);if(ba==Ut&&N.string.charAt(et-2)!="\\"){et--;break}}else if(me&&!Z){++et;break}}me&&!Z&&(G.fatArrowAt=et)}}var B={atom:!0,number:!0,variable:!0,string:!0,regexp:!0,this:!0,import:!0,"jsonld-keyword":!0};function F(N,G,ee,de,Z,me){this.indented=N,this.column=G,this.type=ee,this.prev=Z,this.info=me,de!=null&&(this.align=de)}function j(N,G){if(!u)return!1;for(var ee=N.localVars;ee;ee=ee.next)if(ee.name==G)return!0;for(var de=N.context;de;de=de.prev)for(var ee=de.vars;ee;ee=ee.next)if(ee.name==G)return!0}function U(N,G,ee,de,Z){var me=N.cc;for(O.state=N,O.stream=Z,O.marked=null,O.cc=me,O.style=G,N.lexical.hasOwnProperty("align")||(N.lexical.align=!0);;){var et=me.length?me.pop():d?Ce:_e;if(et(ee,de)){for(;me.length&&me[me.length-1].lex;)me.pop()();return O.marked?O.marked:ee=="variable"&&j(N,de)?"variable-2":G}}}var O={state:null,marked:null,cc:null};function $(){for(var N=arguments.length-1;N>=0;N--)O.cc.push(arguments[N])}function _(){return $.apply(null,arguments),!0}function se(N,G){for(var ee=G;ee;ee=ee.next)if(ee.name==N)return!0;return!1}function oe(N){var G=O.state;if(O.marked="def",!!u){if(G.context){if(G.lexical.info=="var"&&G.context&&G.context.block){var ee=Re(N,G.context);if(ee!=null){G.context=ee;return}}else if(!se(N,G.localVars)){G.localVars=new ie(N,G.localVars);return}}r.globalVars&&!se(N,G.globalVars)&&(G.globalVars=new ie(N,G.globalVars))}}function Re(N,G){if(G)if(G.block){var ee=Re(N,G.prev);return ee?ee==G.prev?G:new we(ee,G.vars,!0):null}else return se(N,G.vars)?G:new we(G.prev,new ie(N,G.vars),!1);else return null}function le(N){return N=="public"||N=="private"||N=="protected"||N=="abstract"||N=="readonly"}function we(N,G,ee){this.prev=N,this.vars=G,this.block=ee}function ie(N,G){this.name=N,this.next=G}var he=new ie("this",new ie("arguments",null));function Te(){O.state.context=new we(O.state.context,O.state.localVars,!1),O.state.localVars=he}function Fe(){O.state.context=new we(O.state.context,O.state.localVars,!0),O.state.localVars=null}Te.lex=Fe.lex=!0;function Ge(){O.state.localVars=O.state.context.vars,O.state.context=O.state.context.prev}Ge.lex=!0;function Pe(N,G){var ee=function(){var de=O.state,Z=de.indented;if(de.lexical.type=="stat")Z=de.lexical.indented;else for(var me=de.lexical;me&&me.type==")"&&me.align;me=me.prev)Z=me.indented;de.lexical=new F(Z,O.stream.column(),N,null,de.lexical,G)};return ee.lex=!0,ee}function ke(){var N=O.state;N.lexical.prev&&(N.lexical.type==")"&&(N.indented=N.lexical.indented),N.lexical=N.lexical.prev)}ke.lex=!0;function Me(N){function G(ee){return ee==N?_():N==";"||ee=="}"||ee==")"||ee=="]"?$():_(G)}return G}function _e(N,G){return N=="var"?_(Pe("vardef",G),ha,Me(";"),ke):N=="keyword a"?_(Pe("form"),Ft,_e,ke):N=="keyword b"?_(Pe("form"),_e,ke):N=="keyword d"?O.stream.match(/^\s*$/,!1)?_():_(Pe("stat"),yi,Me(";"),ke):N=="debugger"?_(Me(";")):N=="{"?_(Pe("}"),Fe,Vn,ke,Ge):N==";"?_():N=="if"?(O.state.lexical.info=="else"&&O.state.cc[O.state.cc.length-1]==ke&&O.state.cc.pop()(),_(Pe("form"),Ft,_e,ke,pa)):N=="function"?_(Zi):N=="for"?_(Pe("form"),Fe,Hc,_e,Ge,ke):N=="class"||h&&G=="interface"?(O.marked="keyword",_(Pe("form",N=="class"?N:G),fa,ke)):N=="variable"?h&&G=="declare"?(O.marked="keyword",_(_e)):h&&(G=="module"||G=="enum"||G=="type")&&O.stream.match(/^\s*\w/,!1)?(O.marked="keyword",G=="enum"?_(De):G=="type"?_(jc,Me("operator"),qe,Me(";")):_(Pe("form"),bi,Me("{"),Pe("}"),Vn,ke,ke)):h&&G=="namespace"?(O.marked="keyword",_(Pe("form"),Ce,_e,ke)):h&&G=="abstract"?(O.marked="keyword",_(_e)):_(Pe("stat"),Jo):N=="switch"?_(Pe("form"),Ft,Me("{"),Pe("}","switch"),Fe,Vn,ke,ke,Ge):N=="case"?_(Ce,Me(":")):N=="default"?_(Me(":")):N=="catch"?_(Pe("form"),Te,Ue,_e,ke,Ge):N=="export"?_(Pe("stat"),ma,ke):N=="import"?_(Pe("stat"),qr,ke):N=="async"?_(_e):G=="@"?_(Ce,_e):$(Pe("stat"),Ce,Me(";"),ke)}function Ue(N){if(N=="(")return _(vn,Me(")"))}function Ce(N,G){return Xt(N,G,!1)}function Xe(N,G){return Xt(N,G,!0)}function Ft(N){return N!="("?$():_(Pe(")"),yi,Me(")"),ke)}function Xt(N,G,ee){if(O.state.fatArrowAt==O.stream.start){var de=ee?Ki:je;if(N=="(")return _(Te,Pe(")"),Rt(vn,")"),ke,Me("=>"),de,Ge);if(N=="variable")return $(Te,bi,Me("=>"),de,Ge)}var Z=ee?li:Kt;return B.hasOwnProperty(N)?_(Z):N=="function"?_(Zi,Z):N=="class"||h&&G=="interface"?(O.marked="keyword",_(Pe("form"),Bh,ke)):N=="keyword c"||N=="async"?_(ee?Xe:Ce):N=="("?_(Pe(")"),yi,Me(")"),ke,Z):N=="operator"||N=="spread"?_(ee?Xe:Ce):N=="["?_(Pe("]"),wt,ke,Z):N=="{"?zr($i,"}",null,Z):N=="quasi"?$(Si,Z):N=="new"?_(Fr(ee)):_()}function yi(N){return N.match(/[;\}\)\],]/)?$():$(Ce)}function Kt(N,G){return N==","?_(yi):li(N,G,!1)}function li(N,G,ee){var de=ee==!1?Kt:li,Z=ee==!1?Ce:Xe;if(N=="=>")return _(Te,ee?Ki:je,Ge);if(N=="operator")return/\+\+|--/.test(G)||h&&G=="!"?_(de):h&&G=="<"&&O.stream.match(/^([^<>]|<[^<>]*>)*>\s*\(/,!1)?_(Pe(">"),Rt(qe,">"),ke,de):G=="?"?_(Ce,Me(":"),Z):_(Z);if(N=="quasi")return $(Si,de);if(N!=";"){if(N=="(")return zr(Xe,")","call",de);if(N==".")return _(Ps,de);if(N=="[")return _(Pe("]"),yi,Me("]"),ke,de);if(h&&G=="as")return O.marked="keyword",_(qe,de);if(N=="regexp")return O.state.lastType=O.marked="operator",O.stream.backUp(O.stream.pos-O.stream.start-1),_(Z)}}function Si(N,G){return N!="quasi"?$():G.slice(G.length-2)!="${"?_(Si):_(yi,pn)}function pn(N){if(N=="}")return O.marked="string-2",O.state.tokenize=R,_(Si)}function je(N){return V(O.stream,O.state),$(N=="{"?_e:Ce)}function Ki(N){return V(O.stream,O.state),$(N=="{"?_e:Xe)}function Fr(N){return function(G){return G=="."?_(N?fn:Ur):G=="variable"&&h?_(Ni,N?li:Kt):$(N?Xe:Ce)}}function Ur(N,G){if(G=="target")return O.marked="keyword",_(Kt)}function fn(N,G){if(G=="target")return O.marked="keyword",_(li)}function Jo(N){return N==":"?_(ke,_e):$(Kt,Me(";"),ke)}function Ps(N){if(N=="variable")return O.marked="property",_()}function $i(N,G){if(N=="async")return O.marked="property",_($i);if(N=="variable"||O.style=="keyword"){if(O.marked="property",G=="get"||G=="set")return _(Gc);var ee;return h&&O.state.fatArrowAt==O.stream.start&&(ee=O.stream.match(/^\s*:\s*/,!1))&&(O.state.fatArrowAt=O.stream.pos+ee[0].length),_(ar)}else{if(N=="number"||N=="string")return O.marked=l?"property":O.style+" property",_(ar);if(N=="jsonld-keyword")return _(ar);if(h&&le(G))return O.marked="keyword",_($i);if(N=="[")return _(Ce,$r,Me("]"),ar);if(N=="spread")return _(Xe,ar);if(G=="*")return O.marked="keyword",_($i);if(N==":")return $(ar)}}function Gc(N){return N!="variable"?$(ar):(O.marked="property",_(Zi))}function ar(N){if(N==":")return _(Xe);if(N=="(")return $(Zi)}function Rt(N,G,ee){function de(Z,me){if(ee?ee.indexOf(Z)>-1:Z==","){var et=O.state.lexical;return et.info=="call"&&(et.pos=(et.pos||0)+1),_(function(Ut,wi){return Ut==G||wi==G?$():$(N)},de)}return Z==G||me==G?_():ee&&ee.indexOf(";")>-1?$(N):_(Me(G))}return function(Z,me){return Z==G||me==G?_():$(N,de)}}function zr(N,G,ee){for(var de=3;de<arguments.length;de++)O.cc.push(arguments[de]);return _(Pe(G,ee),Rt(N,G),ke)}function Vn(N){return N=="}"?_():$(_e,Vn)}function $r(N,G){if(h){if(N==":")return _(qe);if(G=="?")return _($r)}}function Is(N,G){if(h&&(N==":"||G=="in"))return _(qe)}function Gr(N){if(h&&N==":")return O.stream.match(/^\s*\w+\s+is\b/,!1)?_(Ce,Vh,qe):_(qe)}function Vh(N,G){if(G=="is")return O.marked="keyword",_()}function qe(N,G){if(G=="keyof"||G=="typeof"||G=="infer"||G=="readonly")return O.marked="keyword",_(G=="typeof"?Xe:qe);if(N=="variable"||G=="void")return O.marked="type",_(Yi);if(G=="|"||G=="&")return _(qe);if(N=="string"||N=="number"||N=="atom")return _(Yi);if(N=="[")return _(Pe("]"),Rt(qe,"]",","),ke,Yi);if(N=="{")return _(Pe("}"),Ve,ke,Yi);if(N=="(")return _(Rt(bt,")"),Wc,Yi);if(N=="<")return _(Rt(qe,">"),qe);if(N=="quasi")return $(ti,Yi)}function Wc(N){if(N=="=>")return _(qe)}function Ve(N){return N.match(/[\}\)\]]/)?_():N==","||N==";"?_(Ve):$(or,Ve)}function or(N,G){if(N=="variable"||O.style=="keyword")return O.marked="property",_(or);if(G=="?"||N=="number"||N=="string")return _(or);if(N==":")return _(qe);if(N=="[")return _(Me("variable"),Is,Me("]"),or);if(N=="(")return $(jr,or);if(!N.match(/[;\}\)\],]/))return _()}function ti(N,G){return N!="quasi"?$():G.slice(G.length-2)!="${"?_(ti):_(qe,St)}function St(N){if(N=="}")return O.marked="string-2",O.state.tokenize=R,_(ti)}function bt(N,G){return N=="variable"&&O.stream.match(/^\s*[?:]/,!1)||G=="?"?_(bt):N==":"?_(qe):N=="spread"?_(bt):$(qe)}function Yi(N,G){if(G=="<")return _(Pe(">"),Rt(qe,">"),ke,Yi);if(G=="|"||N=="."||G=="&")return _(qe);if(N=="[")return _(qe,Me("]"),Yi);if(G=="extends"||G=="implements")return O.marked="keyword",_(qe);if(G=="?")return _(qe,Me(":"),qe)}function Ni(N,G){if(G=="<")return _(Pe(">"),Rt(qe,">"),ke,Yi)}function gn(){return $(qe,ii)}function ii(N,G){if(G=="=")return _(qe)}function ha(N,G){return G=="enum"?(O.marked="keyword",_(De)):$(bi,$r,mn,Oh)}function bi(N,G){if(h&&le(G))return O.marked="keyword",_(bi);if(N=="variable")return oe(G),_();if(N=="spread")return _(bi);if(N=="[")return zr(Xo,"]");if(N=="{")return zr(Wr,"}")}function Wr(N,G){return N=="variable"&&!O.stream.match(/^\s*:/,!1)?(oe(G),_(mn)):(N=="variable"&&(O.marked="property"),N=="spread"?_(bi):N=="}"?$():N=="["?_(Ce,Me("]"),Me(":"),Wr):_(Me(":"),bi,mn))}function Xo(){return $(bi,mn)}function mn(N,G){if(G=="=")return _(Xe)}function Oh(N){if(N==",")return _(ha)}function pa(N,G){if(N=="keyword b"&&G=="else")return _(Pe("form","else"),_e,ke)}function Hc(N,G){if(G=="await")return _(Hc);if(N=="(")return _(Pe(")"),Ko,ke)}function Ko(N){return N=="var"?_(ha,Hr):N=="variable"?_(Hr):$(Hr)}function Hr(N,G){return N==")"?_():N==";"?_(Hr):G=="in"||G=="of"?(O.marked="keyword",_(Ce,Hr)):$(Ce,Hr)}function Zi(N,G){if(G=="*")return O.marked="keyword",_(Zi);if(N=="variable")return oe(G),_(Zi);if(N=="(")return _(Te,Pe(")"),Rt(vn,")"),ke,Gr,_e,Ge);if(h&&G=="<")return _(Pe(">"),Rt(gn,">"),ke,Zi)}function jr(N,G){if(G=="*")return O.marked="keyword",_(jr);if(N=="variable")return oe(G),_(jr);if(N=="(")return _(Te,Pe(")"),Rt(vn,")"),ke,Gr,Ge);if(h&&G=="<")return _(Pe(">"),Rt(gn,">"),ke,jr)}function jc(N,G){if(N=="keyword"||N=="variable")return O.marked="type",_(jc);if(G=="<")return _(Pe(">"),Rt(gn,">"),ke)}function vn(N,G){return G=="@"&&_(Ce,vn),N=="spread"?_(vn):h&&le(G)?(O.marked="keyword",_(vn)):h&&N=="this"?_($r,mn):$(bi,$r,mn)}function Bh(N,G){return N=="variable"?fa(N,G):yn(N,G)}function fa(N,G){if(N=="variable")return oe(G),_(yn)}function yn(N,G){if(G=="<")return _(Pe(">"),Rt(gn,">"),ke,yn);if(G=="extends"||G=="implements"||h&&N==",")return G=="implements"&&(O.marked="keyword"),_(h?qe:Ce,yn);if(N=="{")return _(Pe("}"),Sn,ke)}function Sn(N,G){if(N=="async"||N=="variable"&&(G=="static"||G=="get"||G=="set"||h&&le(G))&&O.stream.match(/^\s+#?[\w$\xa1-\uffff]/,!1))return O.marked="keyword",_(Sn);if(N=="variable"||O.style=="keyword")return O.marked="property",_(ga,Sn);if(N=="number"||N=="string")return _(ga,Sn);if(N=="[")return _(Ce,$r,Me("]"),ga,Sn);if(G=="*")return O.marked="keyword",_(Sn);if(h&&N=="(")return $(jr,Sn);if(N==";"||N==",")return _(Sn);if(N=="}")return _();if(G=="@")return _(Ce,Sn)}function ga(N,G){if(G=="!"||G=="?")return _(ga);if(N==":")return _(qe,mn);if(G=="=")return _(Xe);var ee=O.state.lexical.prev,de=ee&&ee.info=="interface";return $(de?jr:Zi)}function ma(N,G){return G=="*"?(O.marked="keyword",_(Sa,Me(";"))):G=="default"?(O.marked="keyword",_(Ce,Me(";"))):N=="{"?_(Rt(va,"}"),Sa,Me(";")):$(_e)}function va(N,G){if(G=="as")return O.marked="keyword",_(Me("variable"));if(N=="variable")return $(Xe,va)}function qr(N){return N=="string"?_():N=="("?$(Ce):N=="."?$(Kt):$(ya,On,Sa)}function ya(N,G){return N=="{"?zr(ya,"}"):(N=="variable"&&oe(G),G=="*"&&(O.marked="keyword"),_(Yo))}function On(N){if(N==",")return _(ya,On)}function Yo(N,G){if(G=="as")return O.marked="keyword",_(ya)}function Sa(N,G){if(G=="from")return O.marked="keyword",_(Ce)}function wt(N){return N=="]"?_():$(Rt(Xe,"]"))}function De(){return $(Pe("form"),bi,Me("{"),Pe("}"),Rt(lr,"}"),ke,ke)}function lr(){return $(bi,mn)}function Zo(N,G){return N.lastType=="operator"||N.lastType==","||y.test(G.charAt(0))||/[,.]/.test(G.charAt(0))}function Gi(N,G,ee){return G.tokenize==I&&/^(?:operator|sof|keyword [bcd]|case|new|export|default|spread|[\[{}\(,;:]|=>)$/.test(G.lastType)||G.lastType=="quasi"&&/\{\s*$/.test(N.string.slice(0,N.pos-(ee||0)))}return{startState:function(N){var G={tokenize:I,lastType:"sof",cc:[],lexical:new F((N||0)-s,0,"block",!1),localVars:r.localVars,context:r.localVars&&new we(null,null,!1),indented:N||0};return r.globalVars&&typeof r.globalVars=="object"&&(G.globalVars=r.globalVars),G},token:function(N,G){if(N.sol()&&(G.lexical.hasOwnProperty("align")||(G.lexical.align=!1),G.indented=N.indentation(),V(N,G)),G.tokenize!=T&&N.eatSpace())return null;var ee=G.tokenize(N,G);return b=="comment"?ee:(G.lastType=b=="operator"&&(k=="++"||k=="--")?"incdec":b,U(G,ee,b,k,N))},indent:function(N,G){if(N.tokenize==T||N.tokenize==R)return t.Pass;if(N.tokenize!=I)return 0;var ee=G&&G.charAt(0),de=N.lexical,Z;if(!/^\s*else\b/.test(G))for(var me=N.cc.length-1;me>=0;--me){var et=N.cc[me];if(et==ke)de=de.prev;else if(et!=pa&&et!=Ge)break}for(;(de.type=="stat"||de.type=="form")&&(ee=="}"||(Z=N.cc[N.cc.length-1])&&(Z==Kt||Z==li)&&!/^[,\.=+\-*:?[\(]/.test(G));)de=de.prev;a&&de.type==")"&&de.prev.type=="stat"&&(de=de.prev);var Ut=de.type,wi=ee==Ut;return Ut=="vardef"?de.indented+(N.lastType=="operator"||N.lastType==","?de.info.length+1:0):Ut=="form"&&ee=="{"?de.indented:Ut=="form"?de.indented+s:Ut=="stat"?de.indented+(Zo(N,G)?a||s:0):de.info=="switch"&&!wi&&r.doubleIndentSwitch!=!1?de.indented+(/^(?:case|default)\b/.test(G)?s:2*s):de.align?de.column+(wi?0:1):de.indented+(wi?0:s)},electricInput:/^\s*(?:case .*?:|default:|\{|\})$/,blockCommentStart:d?null:"/*",blockCommentEnd:d?null:"*/",blockCommentContinue:d?null:" * ",lineComment:d?null:"//",fold:"brace",closeBrackets:"()[]{}''\"\"``",helperType:d?"json":"javascript",jsonldMode:l,jsonMode:d,expressionAllowed:Gi,skipExpression:function(N){U(N,"atom","atom","true",new t.StringStream("",2,null))}}}),t.registerHelper("wordChars","javascript",/[\w$]/),t.defineMIME("text/javascript","javascript"),t.defineMIME("text/ecmascript","javascript"),t.defineMIME("application/javascript","javascript"),t.defineMIME("application/x-javascript","javascript"),t.defineMIME("application/ecmascript","javascript"),t.defineMIME("application/json",{name:"javascript",json:!0}),t.defineMIME("application/x-json",{name:"javascript",json:!0}),t.defineMIME("application/manifest+json",{name:"javascript",json:!0}),t.defineMIME("application/ld+json",{name:"javascript",jsonld:!0}),t.defineMIME("text/typescript",{name:"javascript",typescript:!0}),t.defineMIME("application/typescript",{name:"javascript",typescript:!0})})})()),q$.exports}X$();var K$={exports:{}},ck;function PD(){return ck||(ck=1,(function(i,e){(function(t){t(Go())})(function(t){function n(l,d,u,h){if(u&&u.call){var g=u;u=null}else var g=a(l,u,"rangeFinder");typeof d=="number"&&(d=t.Pos(d,0));var v=a(l,u,"minFoldSize");function y(k){var L=g(l,d);if(!L||L.to.line-L.from.line<v)return null;if(h==="fold")return L;for(var I=l.findMarksAt(L.from),P=0;P<I.length;++P)if(I[P].__isFold){if(!k)return null;L.cleared=!0,I[P].clear()}return L}var C=y(!0);if(a(l,u,"scanUp"))for(;!C&&d.line>l.firstLine();)d=t.Pos(d.line-1,0),C=y(!1);if(!(!C||C.cleared||h==="unfold")){var w=r(l,u,C);t.on(w,"mousedown",function(k){b.clear(),t.e_preventDefault(k)});var b=l.markText(C.from,C.to,{replacedWith:w,clearOnEnter:a(l,u,"clearOnEnter"),__isFold:!0});b.on("clear",function(k,L){t.signal(l,"unfold",l,k,L)}),t.signal(l,"fold",l,C.from,C.to)}}function r(l,d,u){var h=a(l,d,"widget");if(typeof h=="function"&&(h=h(u.from,u.to)),typeof h=="string"){var g=document.createTextNode(h);h=document.createElement("span"),h.appendChild(g),h.className="CodeMirror-foldmarker"}else h&&(h=h.cloneNode(!0));return h}t.newFoldFunction=function(l,d){return function(u,h){n(u,h,{rangeFinder:l,widget:d})}},t.defineExtension("foldCode",function(l,d,u){n(this,l,d,u)}),t.defineExtension("isFolded",function(l){for(var d=this.findMarksAt(l),u=0;u<d.length;++u)if(d[u].__isFold)return!0}),t.commands.toggleFold=function(l){l.foldCode(l.getCursor())},t.commands.fold=function(l){l.foldCode(l.getCursor(),null,"fold")},t.commands.unfold=function(l){l.foldCode(l.getCursor(),{scanUp:!1},"unfold")},t.commands.foldAll=function(l){l.operation(function(){for(var d=l.firstLine(),u=l.lastLine();d<=u;d++)l.foldCode(t.Pos(d,0),{scanUp:!1},"fold")})},t.commands.unfoldAll=function(l){l.operation(function(){for(var d=l.firstLine(),u=l.lastLine();d<=u;d++)l.foldCode(t.Pos(d,0),{scanUp:!1},"unfold")})},t.registerHelper("fold","combine",function(){var l=Array.prototype.slice.call(arguments,0);return function(d,u){for(var h=0;h<l.length;++h){var g=l[h](d,u);if(g)return g}}}),t.registerHelper("fold","auto",function(l,d){for(var u=l.getHelpers(d,"fold"),h=0;h<u.length;h++){var g=u[h](l,d);if(g)return g}});var s={rangeFinder:t.fold.auto,widget:"↔",minFoldSize:0,scanUp:!1,clearOnEnter:!0};t.defineOption("foldOptions",null);function a(l,d,u){if(d&&d[u]!==void 0)return d[u];var h=l.options.foldOptions;return h&&h[u]!==void 0?h[u]:s[u]}t.defineExtension("foldOption",function(l,d){return a(this,l,d)})})})()),K$.exports}PD();var Y$={exports:{}},dk;function Z$(){return dk||(dk=1,(function(i,e){(function(t){t(Go(),PD())})(function(t){t.defineOption("foldGutter",!1,function(b,k,L){L&&L!=t.Init&&(b.clearGutter(b.state.foldGutter.options.gutter),b.state.foldGutter=null,b.off("gutterClick",g),b.off("changes",y),b.off("viewportChange",C),b.off("fold",w),b.off("unfold",w),b.off("swapDoc",y),b.off("optionChange",v)),k&&(b.state.foldGutter=new r(s(k)),h(b),b.on("gutterClick",g),b.on("changes",y),b.on("viewportChange",C),b.on("fold",w),b.on("unfold",w),b.on("swapDoc",y),b.on("optionChange",v))});var n=t.Pos;function r(b){this.options=b,this.from=this.to=0}function s(b){return b===!0&&(b={}),b.gutter==null&&(b.gutter="CodeMirror-foldgutter"),b.indicatorOpen==null&&(b.indicatorOpen="CodeMirror-foldgutter-open"),b.indicatorFolded==null&&(b.indicatorFolded="CodeMirror-foldgutter-folded"),b}function a(b,k){for(var L=b.findMarks(n(k,0),n(k+1,0)),I=0;I<L.length;++I)if(L[I].__isFold){var P=L[I].find(-1);if(P&&P.line===k)return L[I]}}function l(b){if(typeof b=="string"){var k=document.createElement("div");return k.className=b+" CodeMirror-guttermarker-subtle",k}else return b.cloneNode(!0)}function d(b,k,L){var I=b.state.foldGutter.options,P=k-1,T=b.foldOption(I,"minFoldSize"),R=b.foldOption(I,"rangeFinder"),M=typeof I.indicatorFolded=="string"&&u(I.indicatorFolded),V=typeof I.indicatorOpen=="string"&&u(I.indicatorOpen);b.eachLine(k,L,function(B){++P;var F=null,j=B.gutterMarkers;if(j&&(j=j[I.gutter]),a(b,P)){if(M&&j&&M.test(j.className))return;F=l(I.indicatorFolded)}else{var U=n(P,0),O=R&&R(b,U);if(O&&O.to.line-O.from.line>=T){if(V&&j&&V.test(j.className))return;F=l(I.indicatorOpen)}}!F&&!j||b.setGutterMarker(B,I.gutter,F)})}function u(b){return new RegExp("(^|\\s)"+b+"(?:$|\\s)\\s*")}function h(b){var k=b.getViewport(),L=b.state.foldGutter;L&&(b.operation(function(){d(b,k.from,k.to)}),L.from=k.from,L.to=k.to)}function g(b,k,L){var I=b.state.foldGutter;if(I){var P=I.options;if(L==P.gutter){var T=a(b,k);T?T.clear():b.foldCode(n(k,0),P)}}}function v(b,k){k=="mode"&&y(b)}function y(b){var k=b.state.foldGutter;if(k){var L=k.options;k.from=k.to=0,clearTimeout(k.changeUpdate),k.changeUpdate=setTimeout(function(){h(b)},L.foldOnChangeTimeSpan||600)}}function C(b){var k=b.state.foldGutter;if(k){var L=k.options;clearTimeout(k.changeUpdate),k.changeUpdate=setTimeout(function(){var I=b.getViewport();k.from==k.to||I.from-k.to>20||k.from-I.to>20?h(b):b.operation(function(){I.from<k.from&&(d(b,I.from,k.from),k.from=I.from),I.to>k.to&&(d(b,k.to,I.to),k.to=I.to)})},L.updateViewportTimeSpan||400)}}function w(b,k){var L=b.state.foldGutter;if(L){var I=k.line;I>=L.from&&I<L.to&&d(b,I,I+1)}}})})()),Y$.exports}Z$();var Q$={exports:{}},uk;function eG(){return uk||(uk=1,(function(i,e){(function(t){t(Go())})(function(t){function n(r){return function(s,a){var l=a.line,d=s.getLine(l);function u(w){for(var b,k=a.ch,L=0;;){var I=k<=0?-1:d.lastIndexOf(w[0],k-1);if(I==-1){if(L==1)break;L=1,k=d.length;continue}if(L==1&&I<a.ch)break;if(b=s.getTokenTypeAt(t.Pos(l,I+1)),!/^(comment|string)/.test(b))return{ch:I+1,tokenType:b,pair:w};k=I-1}}function h(w){var b=1,k=s.lastLine(),L,I=w.ch,P;e:for(var T=l;T<=k;++T)for(var R=s.getLine(T),M=T==l?I:0;;){var V=R.indexOf(w.pair[0],M),B=R.indexOf(w.pair[1],M);if(V<0&&(V=R.length),B<0&&(B=R.length),M=Math.min(V,B),M==R.length)break;if(s.getTokenTypeAt(t.Pos(T,M+1))==w.tokenType){if(M==V)++b;else if(!--b){L=T,P=M;break e}}++M}return L==null||l==L?null:{from:t.Pos(l,I),to:t.Pos(L,P)}}for(var g=[],v=0;v<r.length;v++){var y=u(r[v]);y&&g.push(y)}g.sort(function(w,b){return w.ch-b.ch});for(var v=0;v<g.length;v++){var C=h(g[v]);if(C)return C}return null}}t.registerHelper("fold","brace",n([["{","}"],["[","]"]])),t.registerHelper("fold","brace-paren",n([["{","}"],["[","]"],["(",")"]])),t.registerHelper("fold","import",function(r,s){function a(v){if(v<r.firstLine()||v>r.lastLine())return null;var y=r.getTokenAt(t.Pos(v,1));if(/\S/.test(y.string)||(y=r.getTokenAt(t.Pos(v,y.end+1))),y.type!="keyword"||y.string!="import")return null;for(var C=v,w=Math.min(r.lastLine(),v+10);C<=w;++C){var b=r.getLine(C),k=b.indexOf(";");if(k!=-1)return{startCh:y.end,end:t.Pos(C,k)}}}var l=s.line,d=a(l),u;if(!d||a(l-1)||(u=a(l-2))&&u.end.line==l-1)return null;for(var h=d.end;;){var g=a(h.line+1);if(g==null)break;h=g.end}return{from:r.clipPos(t.Pos(l,d.startCh+1)),to:h}}),t.registerHelper("fold","include",function(r,s){function a(g){if(g<r.firstLine()||g>r.lastLine())return null;var v=r.getTokenAt(t.Pos(g,1));if(/\S/.test(v.string)||(v=r.getTokenAt(t.Pos(g,v.end+1))),v.type=="meta"&&v.string.slice(0,8)=="#include")return v.start+8}var l=s.line,d=a(l);if(d==null||a(l-1)!=null)return null;for(var u=l;;){var h=a(u+1);if(h==null)break;++u}return{from:t.Pos(l,d+1),to:r.clipPos(t.Pos(u))}})})})()),Q$.exports}eG();var tG=Go();const ls=Qe(tG),iG=100;class nG extends Ph{constructor(e){super(),this.viewer=e,this.parsedValue=null,this.debouncedValueUpdater=nt(()=>{const s=this.textEditor.getValue();try{const a=JSON.parse(s);this.parsedValue=a,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(a){this.parsedValue=null,this.applyButton.disabled=!0;let l=0,d=0,u="Unknown parse error";if(a instanceof Error){const h=a.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(h!==null){u=h[1];const g=parseInt(h[2],10),v=s.substring(0,g).split(`
`);l=v.length-1,d=v[v.length-1].length}else u=a.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:u,severity:"error",from:ls.Pos(l,d)}]})}},iG),this.content.classList.add("neuroglancer-state-editor");const t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",()=>this.applyChanges()),t.disabled=!0;const n=this.closeButton=document.createElement("button");n.classList.add("close-button"),n.textContent="Close",this.content.appendChild(n),n.addEventListener("click",()=>this.dispose());const r=this.downloadButton=document.createElement("button");r.textContent="Download",r.title="Download state as a JSON file",this.content.appendChild(r),r.addEventListener("click",()=>this.downloadState()),this.textEditor=ls(s=>{},{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",()=>{this.debouncedValueUpdater()}),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}downloadState(){const e=document.createElement("a"),t=new Blob([this.getJson()],{type:"text/json"}),n=URL.createObjectURL(t);e.href=n,e.download="state.json",e.click(),document.body.removeChild(e)}applyChanges(){this.parsedValue!==null&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}getJson(){return re(Wv(this.viewer.state).value,null,"  ")}}var _d={},hk;function rG(){if(hk)return _d;hk=1,_d.__esModule=!0;var i=zE(),e=t(i);function t(n){return n&&n.__esModule?n:{default:n}}return _d.default=function(n){return Array.isArray(n)?n:(0,e.default)(n)},_d}var sG=rG();const aG=Qe(sG),oG={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1};class lG{constructor(){this.location=new Ts(oG)}get changed(){return this.location.changed}restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return No(this.location.toJSON())}}function cG(i){const e=new ce;function t(n,r){if(typeof n!="object"){e.set(r,""+n);return}for(const s of Qt(n))t(n[s],r+"."+s)}return t(i,""),e}function dG(i){const e=new $e;e.add(".type");const t=new $e;function n(r,s){for(const a of e)if(i[r].get(a)!==i[s].get(a))return!0;return!1}for(let r=0,s=i.length;r<s;++r){for(const l of i[r].keys())t.add(l);let a=[];for(let l=0;l<r;++l)n(r,l)||a.push(l);for(;a.length>0;){let l=a,d;for(const u of t){if(e.has(u))continue;const h=[];for(const g of a)i[g].get(u)===i[r].get(u)&&h.push(g);if(h.length<l.length&&(l=h,d=u),h.length===0)break}if(d===void 0)break;a=l,e.add(d)}}return Ee(e)}function uG(i,e){const t={};for(const n of e){const r=i.get(n);if(r!==void 0){if(n==="")return r;t[n]=r}}return re(t)}function hG(i){return H({type:i.RPC_TYPE_ID},i.key||{})}function pG(i){const e=i.map(cG),t=dG(e);return e.map(n=>uG(n,t))}const fG=1e3,Wf=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:i=>{let e=0;for(let t=0;t<HL;++t)e+=i[zs(t,mr.VISIBLE)*as+vr.numChunks];return e}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:i=>i[zs(pt.DOWNLOADING,mr.VISIBLE)*as+vr.numChunks]},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:i=>i[zs(pt.SYSTEM_MEMORY,mr.VISIBLE)*as+vr.numChunks]+i[zs(pt.SYSTEM_MEMORY_WORKER,mr.VISIBLE)*as+vr.numChunks]},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:i=>i[zs(pt.GPU_MEMORY,mr.VISIBLE)*as+vr.numChunks]},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:i=>i[zs(pt.FAILED,mr.VISIBLE)*as+vr.numChunks]},{label:"Visible memory",key:"visibleGpuMemory",getter:i=>i[zs(pt.GPU_MEMORY,mr.VISIBLE)*as+vr.gpuMemoryBytes]},{label:"Download latency",key:"downloadLatency",getter:i=>i[bC(uu.totalTime)]/i[bC(uu.totalChunks)]}];class gG extends ca{constructor(e,t,n){super(e,n.location),this.chunkQueueManager=t,this.displayState=n,this.data=void 0,this.requestDataTimerId=-1,this.dataRequested=!1,this.body=document.createElement("div"),this.debouncedUpdateView=this.registerCancellable(nt(()=>this.updateView(),0));const r=this.body;r.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(r),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;const e=this.chunkQueueManager;this.dataRequested=!0,e.getStatistics().then(t=>{this.dataRequested=!1,this.data=t,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout(()=>{this.requestDataTimerId=-1,this.requestData()},fG)})}updateView(){const e=this.data;if(e===void 0)return;const t=document.createElement("table"),n=[];for(const u of e){var r=ae(u,2);const h=r[0],g=r[1],v=[h];for(const y of Wf){const C=y.getter;v.push(C(g))}n.push(v)}const s=pG(n.map(u=>hG(u[0]))),a=new ce;s.forEach((u,h)=>{a.set(n[h][0],u)});{const u=document.createElement("thead");let h=document.createElement("tr");u.appendChild(h);const g=y=>{const C=document.createElement("td");C.textContent=y,h.appendChild(C)};g("Name");let v;for(const y of Wf){const C=y.label,w=C.indexOf("/");let b=C;if(w!==-1){if(b=C.substring(0,w),b===v){++h.lastElementChild.colSpan;continue}v=b}g(b)}h=document.createElement("tr"),u.appendChild(h);{const y=document.createElement("td");h.appendChild(y)}for(const y of Wf){const C=y.label,w=C.indexOf("/");let b="";w!==-1&&(b=C.substring(w+1));const k=document.createElement("td");k.textContent=b,h.appendChild(k)}t.appendChild(u)}const l=document.createElement("tbody");for(const u of n){var d=aG(u);const h=d[0],g=d.slice(1),v=document.createElement("tr"),y=C=>{const w=document.createElement("td");w.textContent=C,v.appendChild(w)};y(a.get(h));for(const C of g)y(""+C);l.appendChild(v)}t.appendChild(l),Ke(this.body),this.body.appendChild(t)}}/**
* @license
* Copyright 2018 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class my extends Y{constructor(e,t=()=>lt(1,0,0)){super(),this.model=e,this.getDefaultColor=t,this.element=document.createElement("input");const n=this.element;n.classList.add("neuroglancer-color-widget"),n.type="color",n.addEventListener("change",()=>this.updateModel()),n.addEventListener("input",()=>this.updateModel()),n.addEventListener("wheel",r=>{r.stopPropagation(),r.preventDefault(),this.adjustHueViaWheel(r)}),this.registerDisposer(e.changed.add(()=>this.updateView())),this.updateView()}getRGB(){var e;return(e=this.model.value)!==null&&e!==void 0?e:this.getDefaultColor()}updateView(){this.element.value=Ii(this.getRGB())}updateModel(){this.model.value=Ao(this.element.value)}adjustHueViaWheel(e){const t=this.getRGB(),n=Ne();qF(n,t[0],t[1],t[2]);const r=e.deltaY;let s=Math.round(n[0]*256);s+=r>0?1:r<0?-1:0,s=(s+256)%256,n[0]=s/256,Su(n,n[0],n[1],n[2]),this.model.value=n}}class mG extends Y{constructor(e,t={}){super(),this.model=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input");let n=t.validator,r=t.label;const s=this.element,a=this.inputElement;n===void 0&&(e instanceof Jt?n=e.validator:n=l=>l),this.validator=n,r!==void 0&&(s.textContent=r),s.appendChild(a),s.className="neuroglancer-number-input",a.type="text",this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(a,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(Wn(e)){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){kt(this.element),super.disposed()}}/**
* @license
* Copyright 2020 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class ID extends Y{constructor(e){super(),this.model=e,this.element=document.createElement("input"),this.registerDisposer(e.changed.add(()=>this.updateView()));const t=this.element;t.type="text",this.registerEventListener(t,"change",()=>this.updateModel()),this.updateView()}disposed(){kt(this.element)}updateView(){var e;this.element.value=((e=this.model.value)!==null&&e!==void 0?e:"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}}const vG=H(H({},la),{side:"left",row:2});class yG{constructor(){this.location=new Ts(vG)}get changed(){return this.location.changed}toJSON(){return No(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class SG extends ca{constructor(e,t,n){super(e,t.location),this.addTitleBar({title:"Settings"});const r=document.createElement("div");r.classList.add("neuroglancer-settings-body");let s=document.createElement("div");s.classList.add("neuroglancer-settings-scroll-container"),r.appendChild(s),this.addBody(r);{const u=this.registerDisposer(new ID(n.title));u.element.placeholder="Title",u.element.classList.add("neuroglancer-settings-title"),s.appendChild(u.element)}const a=(u,h)=>{const g=this.registerDisposer(new mG(h,{label:u}));g.element.classList.add("neuroglancer-settings-limit-widget"),s.appendChild(g.element)};a("GPU memory limit",n.chunkQueueManager.capacities.gpuMemory.sizeLimit),a("System memory limit",n.chunkQueueManager.capacities.systemMemory.sizeLimit),a("Concurrent chunk requests",n.chunkQueueManager.capacities.download.itemLimit);const l=(u,h)=>{const g=document.createElement("label");g.textContent=u;const v=this.registerDisposer(new Es(h));g.appendChild(v.element),s.appendChild(g)};l("Show axis lines",n.showAxisLines),l("Show scale bar",n.showScaleBar),l("Show cross sections in 3-d",n.showPerspectiveSliceViews),l("Show default annotations",n.showDefaultAnnotations),l("Show chunk statistics",n.statisticsDisplayState.location.watchableVisible),l("Wire frame rendering",n.wireFrame),l("Enable prefetching",n.chunkQueueManager.enablePrefetch);const d=(u,h)=>{const g=document.createElement("label");g.textContent=u;const v=this.registerDisposer(new my(h));g.appendChild(v.element),s.appendChild(g)};d("Cross-section background",n.crossSectionBackgroundColor),d("Projection background",n.perspectiveViewBackgroundColor)}}class bG extends Y{constructor(e,t){super(),this.selectedLayer=e,this.toolBinder=t,this.element=document.createElement("div"),this.viewContext=void 0,this.updateView=this.registerCancellable(dt(()=>{let r=this.viewContext;r!==void 0&&(this.unregisterDisposer(r),r.dispose()),this.viewContext=r=this.registerDisposer(new Y),Ke(this.element);const s=this.selectedTool;s!==void 0&&this.element.appendChild(this.makeWidget(r,s));const a=Ee(this.toolBinder.bindings);a.sort(([d],[u])=>Lc(d,u));for(const d of a){var l=ae(d,2);const u=l[1];this.element.appendChild(this.makeWidget(r,u))}}));const n=this.element;n.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add(()=>this.selectedLayerChanged())),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}get selectedTool(){const e=this.selectedLayer.layer;if(e===void 0)return;const t=e.layer;if(t!==null)return t.tool.value}selectedLayerChanged(){let e=this.unbindPreviousLayer;e!==void 0&&e();const t=this.selectedLayer.layer;t!==void 0&&(this.unbindPreviousLayer=t.specificationChanged.add(()=>{this.updateView()})),this.updateView()}disposed(){const e=this.unbindPreviousLayer;e!==void 0&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){const n=document.createElement("div");n.title="dblclick → unbind",t instanceof Eo&&(n.title+=", click → bind key"),n.className="neuroglancer-annotation-tool-status-widget";const r=document.createElement("div");r.className="neuroglancer-annotation-tool-status-widget-layer-number";const s=t.layer.managedLayer;s.manager.rootLayers.updateNonArchivedLayerIndices();const a=s.nonArchivedLayerIndex;r.textContent=(a+1).toString();const l=document.createElement("div");if(l.className="neuroglancer-annotation-tool-status-widget-description",l.textContent=t.description,n.addEventListener("dblclick",()=>{t instanceof XT?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)}),t instanceof Eo){const d=document.createElement("div");d.className="neuroglancer-annotation-tool-status-widget-key",d.textContent=t.keyBinding,n.appendChild(d),ZT(e,n,u=>t.layer.toolBinder.set(u,t.addRef()))}return n.appendChild(r),n.appendChild(l),n}}function wG(i){return encodeURI(i).replace(/[!'()*;,]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}class CG extends Y{constructor(e,t,n=""){super(),this.gl=e,this.frameNumberCounter=t;const r=n+"chunk_worker.bundle.js";this.worker=typeof n=="string"?new Worker(r):n,this.chunkQueueManager=this.registerDisposer(new Ng(new LO(this.worker),this.gl,this.frameNumberCounter,{gpuMemory:new Td({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new Td({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new Td({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new Td({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer(()=>this.worker.terminate()),this.chunkManager=this.registerDisposer(new Vg(this.chunkQueueManager))}get rpc(){return this.chunkQueueManager.rpc}}const RD=["showHelpButton","showSettingsButton","showEditStateButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus"],MD=[...RD,"showLayerPanel","showLayerHoverValues"],AD=[...MD,"showUIControls","showPanelBorders"];function xG(){return Object.fromEntries(AD.map(i=>[i,new _t(!0)]))}function kG(i,e){for(const t of AD){const n=e[t];n!==void 0&&(i[t].value=n)}}const EG=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS<"u"?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0};class LG extends ph{constructor(e){super(),this.viewer=e,this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer)}restoreState(e){const t=this.viewer;super.restoreState(e),ye(e,"navigation",n=>{ge(n),ye(n,"pose",r=>{ge(r),ye(r,"position",s=>{ge(s),hi(s,"voxelCoordinates",t.position),ye(s,"voxelSize",a=>{const l=rt(new Float64Array(3),a,vi);for(let d=0;d<3;++d)l[d]*=1e-9;t.coordinateSpace.value=st({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:l})})}),hi(r,"orientation",t.crossSectionOrientation)}),hi(n,"zoomFactor",t.crossSectionScale.legacyJsonView)}),hi(e,"perspectiveOrientation",t.projectionOrientation),hi(e,"perspectiveZoom",t.projectionScale.legacyJsonView),hi(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}}const ps={expectingExternalUI:!1};class TG extends Y{constructor(e,t={}){super(),this.display=e,this.title=new Jt(void 0,Le),this.coordinateSpace=new gv,this.position=this.registerDisposer(new js(this.coordinateSpace)),this.relativeDisplayScales=this.registerDisposer(new dT(this.coordinateSpace)),this.displayDimensions=this.registerDisposer(new hT(this.coordinateSpace)),this.displayDimensionRenderInfo=this.registerDisposer(new uT(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef())),this.crossSectionOrientation=this.registerDisposer(new bo),this.crossSectionScale=this.registerDisposer(new bF(this.displayDimensionRenderInfo.addRef())),this.projectionOrientation=this.registerDisposer(new bo),this.crossSectionDepthRange=this.registerDisposer(new $g(-10,this.displayDimensionRenderInfo)),this.projectionDepthRange=this.registerDisposer(new $g(-50,this.displayDimensionRenderInfo)),this.projectionScale=this.registerDisposer(new wF(this.displayDimensionRenderInfo.addRef())),this.navigationState=this.registerDisposer(new Co(new wo(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef())),this.perspectiveNavigationState=this.registerDisposer(new Co(new wo(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef())),this.mouseState=new RG,this.layerManager=this.registerDisposer(new ND),this.selectedLayer=this.registerDisposer(new _G(this.layerManager.addRef())),this.showAxisLines=new _t(!0,!0),this.wireFrame=new _t(!1,!1),this.showScaleBar=new _t(!0,!0),this.showPerspectiveSliceViews=new _t(!0,!0),this.visibleLayerRoles=MO(),this.showDefaultAnnotations=new _t(!0,!0),this.crossSectionBackgroundColor=new nu(lt(.5,.5,.5)),this.perspectiveViewBackgroundColor=new nu(lt(0,0,0)),this.scaleBarOptions=new u4,this.partialViewport=new rO,this.statisticsDisplayState=new lG,this.helpPanelState=new n$,this.settingsPanelState=new yG,this.layerSelectedValues=this.registerDisposer(new MG(this.layerManager,this.mouseState)),this.selectionDetailsState=this.registerDisposer(new AG(this.coordinateSpace,this.layerSelectedValues)),this.selectedStateServer=new Jt("",Le),this.layerListPanelState=new z$,this.resetInitiated=new be,this.makeUrlFromState=I=>ps.expectingExternalUI?"/#!"+wG(re(I)):window.location.toString(),this.uiControlVisibility={},this.visible=!0,this.toolInputEventMapBinder=(I,P)=>{P.registerDisposer(this.inputEventBindings.sliceView.addParent(I,Number.POSITIVE_INFINITY)),P.registerDisposer(this.inputEventBindings.perspectiveView.addParent(I,Number.POSITIVE_INFINITY))},this.toolBinder=this.registerDisposer(new Mz(this.toolInputEventMapBinder));var n=t.dataContext;const r=n===void 0?new CG(e.gl,e,t.bundleRoot):n;var s=t.visibility;const a=s===void 0?new Nt(Nt.VISIBLE):s;var l=t.inputEventBindings;const d=l===void 0?{global:new at,sliceView:new at,perspectiveView:new at}:l;var u=t.element;const h=u===void 0?e.makeCanvasOverlayElement():u;var g=t.dataSourceProvider;const v=g===void 0?z4({credentialsManager:zo}):g;var y=t.uiConfiguration;const C=y===void 0?xG():y;this.visibility=a,this.inputEventBindings=d,this.element=h,this.dataSourceProvider=v,this.uiConfiguration=C,this.registerDisposer(Lr(I=>{this.display.applyWindowedViewportToElement(h,I)},this.partialViewport)),this.registerDisposer(()=>kt(this.element)),this.dataContext=this.registerDisposer(r),kG(C,t);const w=H(H({},EG),t),b=w.resetStateWhenEmpty,k=w.showLayerDialog;for(const I of MD)this.uiControlVisibility[I]=this.makeUiControlVisibilityState(I);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add(()=>{this.updateShowBorders()})),this.showLayerDialog=k,this.resetStateWhenEmpty=b,this.layerSpecification=new zG(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.toolBinder),this.registerDisposer(e.updateStarted.add(()=>{this.onUpdateDisplay()})),this.showDefaultAnnotations.changed.add(()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(un.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(un.DEFAULT_ANNOTATION)}),this.registerDisposer(this.navigationState.changed.add(()=>{this.handleNavigationStateChanged()}));const L=this.registerCancellable(nt(()=>{!this.wasDisposed&&this.layerManager.managedLayers.length===0&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.resetInitiated.dispatch(),!lm&&this.showLayerDialog&&this.visibility.visible&&jD(this.layerSpecification,this.selectedLayer))}));this.layerManager.layersChanged.add(L),L(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.layerSelectedValues.handleLayerChange()})),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(kD(h,this.navigationState.position)),this.state=new LG(this)}get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}get expectingExternalUI(){return ps.expectingExternalUI}set expectingExternalUI(e){ps.expectingExternalUI=e}makeUiControlVisibilityState(e){const t=this.uiConfiguration.showUIControls,n=this.uiConfiguration[e];return this.registerDisposer(fw((r,s)=>r&&s,t,n))}get inputEventMap(){return this.inputEventBindings.global}updateShowBorders(){const e=this.element,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){const e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";const t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";const n=this.registerDisposer(new Dh(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner));this.registerDisposer(new en(this.uiControlVisibility.showLocation,n.element)),t.appendChild(n.element);const r=this.registerDisposer(new k$(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(r.element.style.flex="1",r.element.style.alignSelf="center",this.registerDisposer(new en(this.uiControlVisibility.showLocation,r.element)),t.appendChild(r.element),typeof NEUROGLANCER_CREDIT_LINK<"u"){let l=NEUROGLANCER_CREDIT_LINK;Array.isArray(l)||(l=[l]);for(const d of l){const u=d.url,h=d.text,g=document.createElement("a");g.style.marginRight="5px",g.href=u,g.textContent=h,g.style.fontFamily="sans-serif",g.style.color="yellow",g.target="_blank",t.appendChild(g)}}const s=this.registerDisposer(new bG(this.selectedLayer,this.toolBinder));if(t.appendChild(s.element),this.registerDisposer(new en(this.uiControlVisibility.showAnnotationToolStatus,s.element)),Z4){const l=this.registerDisposer(new Q4(this));t.appendChild(l.element)}{const l=this.layerListPanelState,d=this.registerDisposer(new Gn(l.location.watchableVisible,{svg:Bz,backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));d.element.insertAdjacentElement("afterbegin",this.registerDisposer(new j$(this.layerManager)).element),this.registerDisposer(new en(this.uiControlVisibility.showLayerListPanelButton,d.element)),t.appendChild(d.element)}{const l=this.selectionDetailsState,d=this.registerDisposer(new Gn(l.location.watchableVisible,{svg:_z,backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new en(this.uiControlVisibility.showSelectionPanelButton,d.element)),t.appendChild(d.element)}{const l=this.selectedLayer,d=this.registerDisposer(new Gn({get value(){return l.visible},set value(u){l.visible=u},changed:l.location.locationChanged},{svg:QT,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new en(this.uiControlVisibility.showLayerSidePanelButton,d.element)),t.appendChild(d.element)}{const l=ft({text:"{}",title:"Edit JSON state"});this.registerEventListener(l,"click",()=>{this.editJsonState()}),this.registerDisposer(new en(this.uiControlVisibility.showEditStateButton,l)),t.appendChild(l)}{const l=Zn({title:"Copy view URL to clipboard",onClick:()=>{const d=Ji(this.makeUrlFromState(this.state.toJSON()));Ye.showTemporaryMessage(d?"URL copied to clipboard":"Failed to copy URL to clipboard")}});t.appendChild(l)}{const l=this.helpPanelState,d=this.registerDisposer(new Gn(l.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new en(this.uiControlVisibility.showHelpButton,d.element)),t.appendChild(d.element)}{const l=this.settingsPanelState,d=this.registerDisposer(new Gn(l.location.watchableVisible,{svg:Fz,backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new en(this.uiControlVisibility.showSettingsButton,d.element)),t.appendChild(d.element)}this.registerDisposer(new en(fw((...l)=>l.reduce((d,u)=>d||u,!1),...RD.map(l=>this.uiControlVisibility[l])),t)),e.appendChild(t),this.layout=this.registerDisposer(new M$(this,"4panel")),this.sidePanelManager=this.registerDisposer(new gU(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new H$(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new F$(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new d1(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.closeSelectionTab=()=>{for(const l of this.sidePanelManager.registeredPanels)l.panel instanceof d1&&l.panel.close()},this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new gG(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{const l=this.inputEventBindings;return new r$(this.sidePanelManager,this.helpPanelState,[["Global",l.global],["Cross section view",l.sliceView],["3-D projection view",l.perspectiveView]],this.layerManager,this.toolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new SG(this.sidePanelManager,this.settingsPanelState,this)}));const a=()=>{const l=this.visibility.visible;l!==this.visible&&(e.style.visibility=l?"inherit":"hidden",this.visible=l)};a(),this.registerDisposer(this.visibility.changed.add(a))}registerEventActionBindings(){const e=this.element;this.registerDisposer(new Nn(e,this.inputEventMap)),this.registerDisposer(new xh(e))}bindAction(e,t){this.registerDisposer(ve(this.element,e,t))}bindCallback(e,t){const n=()=>{t(this)};this.registerDisposer(ve(this.element,e,n))}registerActionListeners(){for(const e of["recolor","clear-segments"])this.bindAction(e,()=>{this.layerManager.invokeAction(e),this.closeSelectionTab&&this.closeSelectionTab()});for(const e of["select"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e)});for(const e of["copy-segment-id","add-copy-segment-id"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e,this.selectedLayer.layer)});this.bindAction("help",()=>this.toggleHelpPanel());for(let e=1;e<=9;++e)this.bindAction(`toggle-layer-${e}`,()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&t.setVisible(!t.visible)}),this.bindAction(`toggle-pick-layer-${e}`,()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(t.pickEnabled=!t.pickEnabled)}),this.bindAction(`select-layer-${e}`,()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(this.selectedLayer.layer=t,this.selectedLayer.visible=!0)});for(let e=0;e<26;++e){const t=String.fromCharCode(65+e);this.bindAction(`tool-${t}`,()=>{this.activateTool(t)})}this.bindAction("annotate",()=>{const e=this.selectedLayer.layer;if(e===void 0){Ye.showTemporaryMessage("The annotate command requires a layer to be selected.");return}const t=e.layer;if(t===null||t.tool.value===void 0){Ye.showTemporaryMessage(`The selected layer (${re(e.name)}) does not have an active annotation tool.`);return}t.tool.value.trigger(this.mouseState)}),this.bindAction("toggle-axis-lines",()=>this.showAxisLines.toggle()),this.bindAction("toggle-scale-bar",()=>this.showScaleBar.toggle()),this.bindAction("toggle-default-annotations",()=>this.showDefaultAnnotations.toggle()),this.bindAction("toggle-show-slices",()=>this.showPerspectiveSliceViews.toggle()),this.bindAction("toggle-show-statistics",()=>this.showStatistics())}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}activateTool(e){this.toolBinder.activate(e)}editJsonState(){new nG(this)}copyJsonStateToUrl(){Ji(this.makeUrlFromState(this.state.toJSON()))}showStatistics(e=void 0){e===void 0&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){let e=this.dataContext.chunkQueueManager;e.chunkUpdateDeadline===null&&(e.chunkUpdateDeadline=Date.now()+10)}}}const pk="tool",fk="toolBindings",Hf="localPosition",gk="localDimensions",mk="source",DG="transform",vk="pick";class PG{constructor(){this.callbacks=[]}defer(e){this.callbacks.push(e)}}class Wo extends Y{constructor(e){super(),this.managedLayer=e,this.pick=new _t(!0,!0),this.layersChanged=new be,this.readyStateChanged=new be,this.specificationChanged=new be,this.renderLayers=new Array,this.loadingCounter=1,this.tabs=this.registerDisposer(new yz),this.panels=new Tz(this),this.tool=this.registerDisposer(new Rz(this)),this.toolBinder=new Az(this),this.dataSourcesChanged=new be,this.dataSources=[],this.allowingRefresh=!1,this.localCoordinateSpaceCombiner.includeDimensionPredicate=VL,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("source",{label:"Source",order:-100,getter:()=>new Ez(this)})}get localPosition(){return this.managedLayer.localPosition}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}get type(){return this.constructor.type}initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=co,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationType=void 0,e.annotationBuffer=void 0,e.annotationIndex=void 0,e.annotationCount=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){const n=(e.localCoordinateSpace=this.localCoordinateSpace.value).rank;if(n!==0){const r=ye(t,Hf,s=>rt(new Float32Array(n),s,vt));r===void 0?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=r)}(e.annotationId=ye(t,"annotationId",Le))!==void 0&&(e.annotationSourceIndex=ye(t,"annotationSource",ui,0),e.annotationPartIndex=ye(t,"annotationPart",ui),e.annotationSubsource=ye(t,"annotationSubsource",Le)),e.value=t.value}displaySelectionState(e,t,n){return!1}selectionStateToJson(e,t){const n={};if(e.localPositionValid){const r=e.localPosition;r.length>0&&(n.localPosition=Ee(r))}return e.annotationId!==void 0&&(n.annotationId=e.annotationId,n.annotationPart=e.annotationPartIndex,n.annotationSource=e.annotationSourceIndex,n.annotationSubsource=e.annotationSubsource),e.value!=null&&(n.value=e.value),n}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;const n=this.localPosition.value;let r=e.localPosition;r.length!==n.length?e.localPosition=n.slice():r.set(n),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;const n=t.localPosition;e.localPosition.length!==n.length?e.localPosition=n.slice():e.localPosition.set(n),e.annotationId=t.annotationId,e.annotationType=t.annotationType,e.annotationBuffer=t.annotationBuffer,e.annotationIndex=t.annotationIndex,e.annotationCount=t.annotationCount,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}get isReady(){return this.loadingCounter===0}get manager(){return this.managedLayer.manager}canAddDataSource(){return!0}addDataSource(e){const t=new X_(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){function*e(){for(const t of this.dataSources){const n=t.loadState;if(!(n===void 0||n.error!==void 0))for(const r of n.subsources)if(r.enabled)yield r;else{const s=r.activated;r.messages.clearMessages(),s!==void 0&&(s.dispose(),r.activated=void 0,n.activatedSubsourcesChanged.dispatch())}}}this.activateDataSubsources(e.call(this))}decrementLoadingCounter(){--this.loadingCounter===0&&this.readyStateChanged.dispatch()}markLoading(){const e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return++this.loadingCounter===1&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){const t=this.manager.root.coordinateSpaceCombiner.bind(e),n=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),n()}}initializationDone(){const e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,n,r){return e===void 0?[]:[$l(e,n)]}getDataSourceSpecifications(e){let t,n=K(e,mk,s=>Array.isArray(s)?s.map(a=>$l(a)):typeof s=="object"?[$l(s)]:(t=s,[]));const r=K(e,DG,O3);return n.push(...this.getLegacyDataSourceSpecifications(t,e,r,n)),n=n.filter(s=>s.url),n.length===0&&n.push(eT()),n}restoreState(e){this.tool.restoreState(e[pk]),this.toolBinder.restoreState(e[fk]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[gk]),this.localPosition.restoreState(e[Hf]),this.constructor.supportsPickOption&&this.pick.restoreState(e[vk]);for(const t of this.getDataSourceSpecifications(e))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);const t=this.layersChanged;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){const t=this.renderLayers,n=this.layersChanged,r=t.indexOf(e);if(r===-1)throw new Error("Attempted to remove invalid RenderLayer");t.splice(r,1),e.layerChanged.remove(n.dispatch),e.userLayer=void 0,e.dispose(),n.dispatch()}disposed(){const e=this.layersChanged;so(this.dataSources);for(const t of this.renderLayers)t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let n,r=this.renderLayers,s=t.pickedRenderLayer;if(s!==null&&r.indexOf(s)!==-1&&(n=s.transformPickedValue(t),n=this.transformPickedValue(n),n!=null))return n;for(let a of r)if(n=a.getValueAt(e),n!=null)break;return this.transformPickedValue(n)}transformPickedValue(e){return e}toJSON(){return H({type:this.type,[mk]:IG(this.dataSources),[pk]:this.tool.toJSON(),[fk]:this.toolBinder.toJSON(),[gk]:this.localCoordinateSpace.toJSON(),[Hf]:this.localPosition.toJSON(),[vk]:this.pick.toJSON()},this.panels.toJSON())}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){const n=this.manager.root.globalPosition,r=this.localPosition;e?(ow(n.value,t,e.globalToRenderLayerDimensions),ow(r.value,t,e.localToRenderLayerDimensions)):n.value.set(t),r.changed.dispatch(),n.changed.dispatch()}}Wo.supportsPickOption=!1;function IG(i){if(i.length!==0)return i.length===1?i[0].toJSON():i.map(e=>e.toJSON())}class vy extends Y{constructor(e,t){super(),this.manager=t,this.localCoordinateSpace=new gv,this.localCoordinateSpaceCombiner=new Sv(this.localCoordinateSpace,Ul),this.localPosition=this.registerDisposer(new js(this.localCoordinateSpace)),this.nonArchivedLayerIndex=-1,this.readyStateChanged=new be,this.layerChanged=new be,this.specificationChanged=new be,this.containers=new $e,this.layer_=null,this.visible=!0,this.archived=!1,this.name_=e}get layer(){return this.layer_}set layer(e){let t=this.layer_;if(t!=null&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,e!=null){const n=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{n.forEach(r=>r())},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){const e=this.layer;return e!==null&&e.isReady}get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}get supportsPickOption(){const e=this.layer;return e!==null&&e.constructor.supportsPickOption}get pickEnabled(){const e=this.layer;return e!==null&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){const t=this.layer;t!==null&&t.constructor.supportsPickOption&&(t.pick.value=e)}toJSON(){let e=this.layer;if(e===null)return;let t=e.toJSON();return t.name=this.name,this.visible||(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived){this.visible=!0,this.setArchived(!1);return}this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(e===!0){this.visible=!1,this.archived=!0;for(const t of this.manager.root.subsets){const n=t.layerManager;n.has(this)&&n.removeManagedLayer(this)}}else{for(const t of this.manager.root.subsets){const n=t.layerManager;n.has(this)||n.addManagedLayer(this.addRef())}this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}}class ND extends Y{constructor(){super(),this.managedLayers=new Array,this.layerSet=new $e,this.layersChanged=new be,this.readyStateChanged=new be,this.specificationChanged=new be,this.boundPositions=new G_,this.numDirectUsers=0,this.nonArchivedLayerIndexGeneration=-1,this.renderLayerToManagedLayerMapGeneration=-1,this.renderLayerToManagedLayerMap_=new ce,this.scheduleRemoveLayersWithSingleRef=this.registerCancellable(nt(()=>this.removeLayersWithSingleRef(),0)),this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}updateNonArchivedLayerIndices(){const e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(const n of this.managedLayers)n.archived||(n.nonArchivedLayerIndex=t++);for(const n of this.managedLayers)n.archived&&(n.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(const n of this.managedLayers)if(!n.archived){if(t===e)return n;++t}}get renderLayerToManagedLayerMap(){const e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e){this.renderLayerToManagedLayerMapGeneration=e,t.clear();for(const n of this.managedLayers){const r=n.layer;if(r!==null)for(const s of r.renderLayers)t.set(s,n)}}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter(n=>e(n)?!0:(this.unbindManagedLayer(n),this.layerSet.delete(n),t=!0,!1)),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){this.numDirectUsers>0||this.filter(e=>e.refCount!==1||e.archived)}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return++this.numDirectUsers===1&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{--this.numDirectUsers===0&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,Oz),this.layerSet.add(e),e.containers.add(this),t===void 0&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(let e of this.managedLayers)!e.visible||!e.layer||(yield*e.layer.renderLayers)}unbindManagedLayer(e){this.updateSignalBindings(e,Vz),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.dispose()}clear(){for(let e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){const t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){let t=this.managedLayers.indexOf(e);if(t===-1)throw new Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){const n=this.managedLayers.length;if(e===t||e<0||e>=n||t<0||t>=n)return;var r=this.managedLayers.splice(e,1),s=ae(r,1);let a=s[0];this.managedLayers.splice(t,0,a),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find(t=>t.name===e)}getUniqueLayerName(e){let t=e,n=0;for(;this.getLayerByName(t)!==void 0;)t=e+ ++n;return t}has(e){return this.layerSet.has(e)}get renderLayers(){let e=this;return{*[Mi](){for(let t of e.managedLayers)if(t.layer!==null)for(let n of t.layer.renderLayers)yield n}}}get visibleRenderLayers(){let e=this;return{*[Mi](){for(let t of e.managedLayers)if(!(t.layer===null||!t.visible))for(let n of t.layer.renderLayers)yield n}}}invokeAction(e,t){const n=new PG;for(let r of this.managedLayers){if(r.layer===null||!r.visible||t!==void 0&&r!==t)continue;let s=r.layer;s.handleAction(e,n);for(let a of s.renderLayers)a.handleAction(e)}for(const r of n.callbacks)r()}}class RG{constructor(){this.changed=new be,this.coordinateSpace=Ir,this.position=co,this.unsnappedPosition=co,this.active=!1,this.displayDimensions=void 0,this.pickedRenderLayer=null,this.pickedValue=new te(0,0),this.pickedOffset=0,this.pickedAnnotationLayer=void 0,this.pickedAnnotationId=void 0,this.pickedAnnotationBuffer=void 0,this.pickedAnnotationBufferBaseOffset=void 0,this.pickedAnnotationIndex=void 0,this.pickedAnnotationCount=void 0,this.pickedAnnotationType=void 0,this.forcerFunction=void 0}removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,e===void 0&&this.setActive(!1)}updateUnconditionally(){const e=this.forcerFunction;return e===void 0?!1:(e(),this.active)}setActive(e){(this.active!==e||e===!0)&&(this.active=e,this.changed.dispatch())}}class MG extends Y{constructor(e,t){super(),this.layerManager=e,this.mouseState=t,this.changed=new be,this.needsUpdate=!0,this.registerDisposer(t.changed.add(()=>{this.handleChange()})),this.registerDisposer(e.layersChanged.add(()=>{this.handleLayerChange()}))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;let e=this.mouseState;const t=this.changed.count;if(e.active)for(const n of this.layerManager.managedLayers){const r=n.layer;if(n.visible&&r!==null){const s=r.selectionState;s&&(r.resetSelectionState(s),s.generation=t,r.captureSelectionState(s,e))}}}get(e){this.update();const t=e.selectionState;if(!(t&&t.generation!==this.changed.count))return t}toJSON(){this.update();const e={};for(const t of this.layerManager.managedLayers){const n=t.layer;if(n){const r=this.get(n);r!==void 0&&(e[t.name]=n.selectionStateToJson(r,!0))}}return e}}const yk=10,dm=H(H({},la),{minSize:150,row:1}),Sk=H(H({},dm),{visible:!0});class AG extends Y{constructor(e,t){super(),this.coordinateSpace=e,this.layerSelectedValues=t,this.changed=new be,this.history=[],this.historyIndex=0,this.location=new Ts(dm),this.pin=new ct(!0),this.registerDisposer(Pr((n,r)=>{r||(this.capture(!0),n.registerDisposer(t.changed.add(n.registerCancellable(hh(()=>this.capture(!0),100,{leading:!0,trailing:!0})))))},this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}get value(){return this.value_}goBack(){const e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return this.pin.value?this.historyIndex+1<this.history.length:!1}goForward(){if(!this.pin.value)return;const e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,e!==void 0&&this.pin.value){const t=this.history;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>yk&&t.splice(0,t.length-yk),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t,n=!0,r=!0){if(n===!1&&(!this.location.visible||this.pin.value))return;const s={};e.initializeSelectionState(s),t(s)&&(r&&(this.location.visible=!0),n===!0?this.pin.value=!0:n==="toggle"&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:s}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){const e=this.value;let t;if(this.location.visible){if(t=this.location.toJSON(H(H({},Sk),{visible:!ps.expectingExternalUI})),this.pin.value&&e!==void 0){const n={};for(const r of e.layers){let s=r.layer.selectionStateToJson(r.state,!1);Qt(s).length===0&&(s=void 0),n[r.layer.managedLayer.name]=s}e.position!==void 0&&(t.position=Ee(e.position)),t.layers=n}}else t=this.location.toJSON(dm),t=No(t),t!==void 0&&(t.visible=!1);return t}select(e=!0){const t=this.pin;e&&(this.location.visible=!0),t.value=!t.value,t.value&&this.capture()}capture(e=!1){const t=NG(this.layerSelectedValues);e&&t===void 0||(this.value=t)}restoreState(e){if(e===void 0){this.pin.value=!0,this.value=void 0;return}if(e===null){this.pin.value=!1,this.location.visible=!0,this.value=void 0;return}ge(e),this.location.restoreState(e,H(H({},Sk),{visible:!ps.expectingExternalUI}));const t=this.coordinateSpace.value,n=t.rank>0?ye(e,"position",s=>rt(new Float32Array(t.rank),s,vt)):void 0,r=[];ye(e,"layers",s=>{ge(s);const a=this.layerSelectedValues.layerManager;for(const d of Tc(s)){var l=ae(d,2);const u=l[0],h=l[1],g=a.getLayerByName(u);if(g===void 0)return;const v=g.layer;if(v===null)return;ge(h);const y={};v.initializeSelectionState(y),v.selectionStateFromJson(y,h),r.push({layer:v,state:y})}}),this.pin.value=r.length>0||n!==void 0,this.value={position:n,coordinateSpace:t,layers:r}}}function NG(i){const e=i.mouseState;if(!e.active)return;const t=[];for(const n of i.layerManager.managedLayers){const r=n.layer;if(r===null)continue;const s=i.get(r);if(s===void 0)continue;const a={};r.initializeSelectionState(a),r.copySelectionState(a,s),t.push({layer:r,state:a})}return{position:e.position.slice(),coordinateSpace:e.coordinateSpace,layers:t}}class VG extends Y{constructor(e){super(),this.view=e,this.messages=new Vo,this.seenGeneration=-1,this.state=void 0}}let OG=0;class BG extends Y{constructor(e,t,n,r,s,a){super(),this.layerManager=e,this.renderLayerType=t,this.view=n,this.roles=r,this.layerAdded=s,this.visibility=a,this.visibleLayers_=new ce,this.debouncedUpdateVisibleLayers=this.registerCancellable(nt(()=>this.updateVisibleLayers(),0)),this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(r.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach(e=>e.dispose()),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){const e=++OG,t=this.visibleLayers_,n=this.renderLayerType,r=this.layerAdded,s=this.roles;for(let l of this.layerManager.readyRenderLayers())if(l instanceof n&&s.has(l.role)){let d=l,u=t.get(d);u===void 0&&(u=new VG(this.view),u.registerDisposer(d.messages.addChild(u.messages)),u.registerDisposer(d.addRef()),u.registerDisposer(d.visibility.add(this.visibility)),t.set(d,u),r(d,u),d.attach(u)),u.seenGeneration=e}for(const l of t){var a=ae(l,2);const d=a[0],u=a[1];u.seenGeneration!==e&&(t.delete(d),u.dispose())}}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}}function VD(i,e,t,n,r){return n.registerDisposer(new BG(i,e,n,t,(s,a)=>{a.registerDisposer(s.redrawNeeded.add(()=>n.scheduleRedraw()));const l=s.backend;l&&(l.rpc.invoke(oO,{layer:l.rpcId,view:n.rpcId}),a.registerDisposer(()=>l.rpc.invoke(lO,{layer:l.rpcId,view:n.rpcId}))),n.scheduleRedraw(),a.registerDisposer(()=>n.scheduleRedraw())},n.visibility))}class _G extends Y{constructor(e){super(),this.layerManager=e,this.changed=new be,this.location=new Ts(Lz),this.registerDisposer(e),this.location.changed.add(()=>{var t,n;this.changed.dispatch();const r=(n=(t=this.layer)===null||t===void 0?void 0:t.layer)!==null&&n!==void 0?n:void 0;if(r!==void 0){const s=this.location.value;if(s.visible){const a=r.panels.panels[0];a.location.value!==s&&(a.location.value=s,a.location.locationChanged.dispatch())}}})}get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(e===!0&&t===void 0){const n=this.layerManager.managedLayers;n.length>0?t=this.layer=n[0]:e=!1}if(e===!0&&t!==void 0){const n=t.layer;(n===null||n.panels.panels[0].tabs.length===0)&&(e=!1)}this.visible!==e&&(this.location.visible=e,!e&&t!==void 0&&this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;const t=e.layer;t!==null&&t instanceof Ar&&(t.dataSources.some(n=>n.spec.url.length!==0)||jo(e))}set layer(e){if(e===this.layer_)return;const t=this.layer_;if(t!==void 0&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,e!==void 0){const n=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(n);const r=e.specificationChanged.add(()=>{this.changed.dispatch()});this.existingLayerDisposer=()=>{const s=e.layer;if(s!==null){const a=s.tool.value;a!==void 0&&a.deactivate()}e.unregisterDisposer(n),r()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){const e=this.location.toJSON();return this.layer!==void 0&&(e.layer=this.layer.name),No(e)}restoreState(e){if(e===void 0){this.reset();return}ge(e),this.location.restoreState(e);const t=K(e,"layer",Dn),n=t!==void 0?this.layerManager.getLayerByName(t):void 0;n===void 0&&(this.visible=!1),this.layer=n}reset(){this.location.reset(),this.layer=void 0}}class FG extends Y{constructor(e,t){super(),this.layerManager=e,this.filter=t,this.changed=new be,this.validate=nt(()=>{const n=this.layerName_;if(n!==void 0){const r=this.layerManager.getLayerByName(n);r!==void 0&&this.filter(r)?(this.layer_=r,this.changed.dispatch()):(this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch())}},0),this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add(()=>{const n=this.layer_;if(n!==void 0)if(!this.layerManager.layerSet.has(n)||!this.filter(n))this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch();else{const r=n.name;r!==this.layerName_&&(this.layerName_=r,this.changed.dispatch())}}))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){this.layer_!==e&&(e!==void 0&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch())}set layerName(e){e!==this.layerName_&&(this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate())}restoreState(e){const t=Dn(e);this.layerName=t}toJSON(){const e=this.layer_;return e!==void 0?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}}class bk extends Y{constructor(e,t,n,r){super(),this.layerManager=e,this.layer=t,this.predicate=n,this.getGroup=r,this.linkedLayers_=new $e,this.changed=new be,this.linkedLayersChanged=new be,this.root_=t;const s=this;this.root={get value(){return s.root_},changed:s.changed}}get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}reset(){this.isolate()}restoreState(e){if(e===void 0)return;const t=Le(e);this.linkByName(t)}toJSON(){const e=this.root.value;if(e!==this.layer)return e.managedLayer.name}isolate(e=!0){const t=this.getGroup,n=this.layer,r=this.root_;if(r===n){const a=this.linkedLayers_;if(a.size!==0){for(const l of a){const d=t(l);d.root_=l,d.changed.dispatch()}a.clear(),this.linkedLayersChanged.dispatch()}return}const s=t(r);s.linkedLayers_.delete(n),s.linkedLayersChanged.dispatch(),this.root_=n,e&&this.changed.dispatch()}linkByName(e){const t=this.layer.managedLayer,n=this.layerManager.getLayerByName(e);if(n===void 0||n===t)return;const r=n.layer;r!==null&&this.predicate(r)&&this.linkToLayer(r)}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);const t=this.getGroup,n=t(e).root_;if(n===this.layer)return;const r=t(n);r.linkedLayers_.add(this.layer),r.linkedLayersChanged.dispatch(),this.root_=n,this.changed.dispatch()}disposed(){this.isolate(!1)}}function OD(i,e){const t=ye(e,"type",Le,"auto");i.archived=ye(e,"archived",oo,!1),i.archived?i.visible=!1:i.visible=ye(e,"visible",oo,!0);const n=Pu.get(t)||Ar;return i.layer=new n(i),e}function BD(i,e){try{const t=i.layer;if(t===null)return;t.restoreState(e),t.initializationDone()}catch(t){throw jo(i),t}}function _D(i,e){try{ge(e),OD(i,e),BD(i,e)}catch(t){throw jo(i),t}}function UG(i,e){try{_D(i,e)}catch(t){new Ye().setErrorMessage(t instanceof Error?t.message:""+t)}}function FD(i,e,t){const n=new vy(e,i);return _D(n,t),n}class UD extends Y{constructor(){super(...arguments),this.changed=new be}}class zG extends UD{constructor(e,t,n,r,s,a,l,d,u){super(),this.display=e,this.dataSourceProviderRegistry=t,this.layerManager=n,this.chunkManager=r,this.selectionState=s,this.selectedLayer=a,this.coordinateSpace=l,this.globalPosition=d,this.toolBinder=u,this.coordinateSpaceCombiner=new Sv(this.coordinateSpace,R3),this.subsets=new $e,this.layerSelectedValues=this.selectionState.layerSelectedValues,this.registerDisposer(n.layersChanged.add(this.changed.dispatch)),this.registerDisposer(n.specificationChanged.add(this.changed.dispatch))}get rpc(){return this.chunkManager.rpc}get root(){return this}reset(){this.layerManager.clear()}restoreState(e){this.layerManager.clear();let t;Array.isArray(e)?t=e:(ge(e),t=Tc(e).map(([r,s])=>typeof s=="string"?{name:r,source:s}:(ge(s),H(H({},s),{name:r}))));const n=[];for(const r of t){ge(r);const s=this.layerManager.getUniqueLayerName(K(r,"name",Le)),a=new vy(s,this);try{OD(a,r),this.layerManager.addManagedLayer(a),n.push({managedLayer:a,spec:r})}catch(l){a.dispose(),new Ye().setErrorMessage(`Error creating layer ${re(s)}: `+(l instanceof Error)?l.message:""+l)}}for(const r of n){const s=r.managedLayer,a=r.spec;try{BD(s,a)}catch(l){new Ye().setErrorMessage(`Error creating layer ${re(name)}: `+(l instanceof Error)?l.message:""+l)}}}add(e,t){this.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){const e=[];let t=0;for(let n of this.layerManager.managedLayers){const r=n.toJSON();r!=null&&(e.push(r),++t)}if(t!==0)return e}get rootLayers(){return this.layerManager}}class zD extends UD{constructor(e){super(),this.master=e,this.changed=new be,this.layerManager=this.registerDisposer(new ND),this.registerDisposer(e);const t=this.layerManager;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){const t=this.master.layerManager,n=[];for(const r of new $e(We(e,Le))){const s=t.getLayerByName(r);if(s===void 0)throw new Error(`Undefined layer referenced in subset specification: ${re(r)}`);s.archived||n.push(s)}this.layerManager.clear();for(const r of n)this.layerManager.addManagedLayer(r.addRef())}toJSON(){return this.layerManager.managedLayers.map(e=>e.name)}add(e,t){this.master.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}}const Pu=new ce,yy=new ce,$D=[i=>{const e=i.volume;if(e===void 0)return;const t=yy.get(e.volumeType);if(t!==void 0)return{layerConstructor:t,priority:0}}];function Ho(i,e=i.type){Pu.set(e,i)}function Sy(i){$D.push(i)}function GD(i,e){yy.set(i,e)}function by(i,e){const t=i.layer;if(t===null)return;const n=t.toJSON(),r=new e(i);r.restoreState(n),r.initializationDone(),i.layer=r}function WD(i,e){return e!==i.name?(e=i.manager.root.layerManager.getUniqueLayerName(e),i.name=e,i.layerChanged.dispatch(),!0):!1}function jo(i){if(!i.wasDisposed)for(const e of i.containers)e.removeManagedLayer(i)}function um(i,e){return i===void 0?e:e===void 0?i:i.priority<e.priority?e:i}function $G(i){let e;for(const n of $D)e=um(e,n(i));const t=i.volume;if(t!==void 0){const n=yy.get(t.volumeType);n!==void 0&&(e=um(e,{layerConstructor:n,priority:0}))}return e}function HD(i){let e;for(const t of i){const n=t.subsourceEntry.subsource;e=um(e,$G(n))}return e}class Ar extends Wo{activateDataSubsources(e){var t;this.detectedLayerConstructor=(t=HD(e))===null||t===void 0?void 0:t.layerConstructor}}Ar.type="new";Ar.typeAbbreviation="new";class wy extends Wo{activateDataSubsources(e){var t;const n=(t=HD(e))===null||t===void 0?void 0:t.layerConstructor;n!==void 0&&by(this.managedLayer,n)}}wy.type="auto";wy.typeAbbreviation="auto";function jD(i,e){const t=FD(i,"new layer",{type:"new"});i.add(t),e.layer=t,e.visible=!0}Ho(Ar);Ho(wy);function wk(i,e){return e=Hn(e,3432918353)>>>0,e=(e<<15|e>>>17)>>>0,e=Hn(e,461845907)>>>0,i^=e,i=(i<<13|i>>>19)>>>0,i=Hn(i,5)+3864292196>>>0,i}function GG(i,e){return i^=e,i^=i>>>16,i=Hn(i,2246822507)>>>0,i^=i>>>13,i*=3266489909,i^=i>>>16,i>>>0}function qD(i,e,t){let n=i;return n=wk(n,e),n=wk(n,t),GG(n,8)}class WG extends Or{constructor(e,t){super(e,t),this.properties=t.properties}static encodeOptions(e){return{properties:e.properties}}}function HG(i,e,t){const n=i.length-1;for(;;){if(e=e&n,i[e]===0){i[e]=t;return}++e}}function Iu(i,e){return e<=255?new Uint8Array(i):e<=65535?new Uint16Array(i):new Uint32Array(i)}function jG(i){const e=i.length/2,t=2**(Math.ceil(Fi(e))+1),n=Iu(t,e+1);for(let r=0;r<e;++r){const s=i[2*r],a=i[2*r+1];HG(n,qD(0,s,a),r+1)}return n}function qG(i,e,t,n){let r=qD(0,t,n);const s=i.length-1;for(;;){r=r&s;let a=i[r];if(a===0)return-1;if(--a,e[2*a]===t&&e[2*a+1]===n)return a;++r}}class JD{constructor(e){this.inlineProperties=e.inlineProperties}}class JG{constructor(e){var t;this.segmentPropertyMap=e;const n=e.inlineProperties;n!==void 0&&(this.inlineIdToIndex=jG(n.ids)),this.tags=n?.properties.find(r=>r.type==="tags"),this.labels=n?.properties.find(r=>r.type==="label"),this.numericalProperties=(t=n?.properties.filter(r=>r.type==="number"))!==null&&t!==void 0?t:[]}getSegmentInlineIndex(e){const t=this.inlineIdToIndex;return t===void 0?-1:qG(t,this.segmentPropertyMap.inlineProperties.ids,e.low,e.high)}getSegmentLabel(e){const t=this.getSegmentInlineIndex(e);if(t===-1)return;const n=this.labels,r=this.tags;let s="";if(n!==void 0&&(s=n.values[t]),r!==void 0){const a=r.tags;let l=r.values[t];for(let d=0,u=l.length;d<u;++d){const h=a[l.charCodeAt(d)];s.length>0&&(s+=" "),s+="#",s+=h}}if(s.length!==0)return s}}function XD(i,e,t){for(let n=0,r=t.length;n<r;++n)e[t[n]]=i[n]}function XG(i){const e=i.length;if(e===0)return!0;let t=i[0],n=i[1];for(let r=0;r<e;r+=2){const s=i[r],a=i[r+1];if((a-n||s-t)<=0)return!1;t=s,n=a}return!0}function KG(i){const e=i.ids;if(XG(e))return i;const t=e.length/2,n=Iu(t,t-1);for(let a=0;a<t;++a)n[a]=a;n.sort((a,l)=>{const d=e[a*2],u=e[a*2+1],h=e[l*2],g=e[l*2+1];return u-g||d-h});const r=new Uint32Array(t*2);for(let a=0;a<t;++a){const l=n[a];r[a*2]=e[l*2],r[a*2+1]=e[l*2+1]}const s=i.properties.map(a=>{const l=a.values,d=new l.constructor(t);for(let u=0;u<t;++u)d[u]=l[n[u]];return H(H({},a),{values:d})});return{ids:r,properties:s}}function YG(i,e,t){const n=new Array(e);return n.fill(""),XD(i.values,n,t),H(H({},i),{values:n})}function ZG(i,e,t){const n=new Float32Array(e);return n.fill(Number.NaN),XD(i.values,n,t),H(H({},i),{values:n})}function Ck(i,e,t){const n=i.type;return n==="label"||n==="description"||n==="string"||n==="tags"?YG(i,e,t):ZG(i,e,t)}function QG(i,e){if(i===void 0)return e;if(e===void 0)return i;let t=0;const n=i.ids.length/2,r=e.ids.length/2,s=new Uint32Array(n),a=new Uint32Array(r),l=i.ids,d=e.ids;mN(n,r,(g,v)=>{const y=l[2*g+1],C=l[2*g],w=d[2*v+1],b=d[2*v];return y-w||C-b},g=>{s[g]=t,++t},g=>{a[g]=t,++t},(g,v)=>{s[g]=t,a[v]=t,++t});let u;if(t===n)u=l;else if(t===r)u=d;else{u=new Uint32Array(t*2);for(let g=0;g<n;++g){const v=s[g];u[2*v]=l[2*g],u[2*v+1]=l[2*g+1]}for(let g=0;g<r;++g){const v=a[g];u[2*v]=d[2*g],u[2*v+1]=d[2*g+1]}}const h=[];if(t===n)h.push(...i.properties);else for(const g of i.properties)h.push(Ck(g,t,s));if(t===r)h.push(...e.properties);else for(const g of e.properties)h.push(Ck(g,t,a));return{ids:u,properties:h}}function eW(i,e){return new JD({inlineProperties:QG(i.inlineProperties,e.inlineProperties)})}function tW(i){for(;;){if(i.length===0)return;if(i.length===1)return i[0];const e=[];for(let t=0,n=i.length;t<n;t+=2)t+1===n?e.push(i[t]):e.push(eW(i[t],i[t+1]));i=e}}function iW(i,e){return i.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:e.map(t=>oi(t))},()=>{const t=tW(e);if(t!==void 0)return new JG(t)})}const nW=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function rW(i,e){var t;if(e.match(nW)!==null){const g=e.split(/[\s,]+/),v=[],y=new $e;for(let C=0,w=g.length;C<w;++C){const b=g[C];if(b==="")continue;const k=new te;if(!k.tryParseString(b))continue;const L=k.toString();y.has(L)||(y.add(L),v.push(k))}return v.sort(te.compare),{ids:v}}const n={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},r=(t=i?.segmentPropertyMap.inlineProperties)===null||t===void 0?void 0:t.properties,s=i?.tags,a=s?.tags||[],l=a.map(g=>g.toLowerCase()),d=i?.labels,u=[];let h;for(let g=0;g<e.length;g=h){let v=e.indexOf(" ",g),y;if(v===-1?h=v=e.length:h=v+1,y=e.substring(g,v),y.length===0)continue;const C=(b,k)=>{const L=b.toLowerCase(),I=l.indexOf(L);if(I===-1){u.push({begin:k,end:v,message:`Invalid tag: ${b}`});return}if(b=a[I],n.includeTags.includes(b)||n.excludeTags.includes(b)){u.push({begin:k,end:v,message:`Duplicate tag: ${b}`});return}return b};if(y.startsWith("#")){const b=C(y.substring(1),g+1);b!==void 0&&n.includeTags.push(b);continue}if(y.startsWith("-#")){const b=C(y.substring(2),g+2);b!==void 0&&n.excludeTags.push(b);continue}if(y.startsWith("<")||y.startsWith(">")){let b=y.substring(1).toLowerCase();if(b!=="id"&&b!=="label"){const k=r?.find(L=>L.id.toLowerCase()===b&&(L.type==="number"||L.type==="label"||L.type==="string"));if(k===void 0){u.push({begin:g+1,end:v,message:`Invalid field: ${b}`});continue}b=k.id}if(n.sortBy.find(k=>k.fieldId===b)!==void 0){u.push({begin:g+1,end:v,message:`Duplicate sort field: ${b}`});continue}n.sortBy.push({order:y[0],fieldId:b});continue}if(y.startsWith("|")){let b=y.substring(1).toLowerCase();if(b==="id"||b==="label")continue;const k=r?.find(L=>L.id.toLowerCase()===b&&(L.type==="number"||L.type==="string"));if(k===void 0){u.push({begin:g+1,end:v,message:`Invalid field: ${b}`});continue}if(b=k.id,n.sortBy.find(L=>L.fieldId===b)||n.includeColumns.find(L=>L===b))continue;n.includeColumns.push(b);continue}if(y.startsWith("/")){if(n.regexp!==void 0){u.push({begin:g,end:v,message:"Only one regular expression allowed"});continue}if(n.prefix!==void 0){u.push({begin:g,end:v,message:"Prefix cannot be combined with regular expression"});continue}if(d===void 0){u.push({begin:g,end:v,message:"No label property"});continue}try{n.regexp=new RegExp(y.substring(1))}catch{u.push({begin:g,end:v,message:"Invalid regular expression syntax"})}continue}const w=y.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)([0-9.].*)$/);if(w!==null){let b=w[1].toLowerCase();const k=w[2],L=i?.numericalProperties.find(B=>B.id.toLowerCase()===b);if(L===void 0){u.push({begin:g,end:g+b.length,message:`Invalid numerical field: ${b}`});continue}b=L.id;let I;try{I=vc(L.dataType,w[3])}catch(B){u.push({begin:g+w[1].length+w[2].length,end:v,message:B.message});continue}let P=n.numericalConstraints.find(B=>B.fieldId===b);P===void 0&&(P={fieldId:b,bounds:L.bounds},n.numericalConstraints.push(P));const T=ql(L.bounds,P.bounds[0]),R=ql(L.bounds,P.bounds[1]);let M=R,V=T;switch(k){case"<":M=au(L.dataType,I,-1);break;case"<=":M=I;break;case"=":M=V=I;break;case">=":V=I;break;case">":V=au(L.dataType,I,1);break}if(V=dn(T,V)>0?T:V,M=dn(R,M)<0?R:M,dn(V,M)>0){u.push({begin:g,end:v,message:"Constraint would not match any values"});continue}P.bounds=[V,M];continue}if(n.regexp!==void 0){u.push({begin:g,end:v,message:"Prefix cannot be combined with regular expression"});continue}if(d===void 0){u.push({begin:g,end:v,message:"No label property"});continue}n.prefix!==void 0?n.prefix+=` ${y}`:n.prefix=y}return u.length>0?{errors:u}:(n.sortBy.length===0&&n.sortBy.push({fieldId:KD(i),order:"<"}),n)}function jf(i){return"\\u"+i.toString(16).padStart(4,"0")}function sW(i,e){var t;if(e.errors!==void 0)return{query:e,total:-1,count:0,errors:e.errors};if(e.ids!==void 0){const T=e.ids;return{query:e,total:-1,explicitIds:T,count:T.length}}const n=(t=i?.segmentPropertyMap)===null||t===void 0?void 0:t.inlineProperties;if(n===void 0)return{query:e,count:0,total:-1};const r=n?.properties,s=n.ids.length/2;let a=Iu(s,s);for(let T=0;T<s;++T)a[T]=T;const l=T=>{let R=a.length,M=0;for(let V=0;V<R;++V){const B=a[V];T(B)&&(a[M]=B,++M)}a=a.subarray(0,M)};if(e.regexp!==void 0||e.prefix!==void 0){const T=i.labels.values,R=e.regexp,M=e.prefix;R!==void 0&&l(V=>T[V].match(R)!==null),M!==void 0&&l(V=>T[V].startsWith(M))}const d=e.includeTags,u=e.excludeTags,h=i.tags;if(d.length>0||u.length>0){const T=h.values,R=h.tags,M=[];for(const U of d)M.push([R.indexOf(U),1]);for(const U of u)M.push([R.indexOf(U),0]);M.sort((U,O)=>U[0]-O[0]);let V="^",B=0;const F=U=>{U<B||(V+=`[${jf(B)}-${jf(U)}]*`)};for(const U of M){var g=ae(U,2);const O=g[0],$=g[1];F(O-1),$&&(V+=jf(O)),B=O+1}F(65535),V+="$";const j=new RegExp(V);l(U=>T[U].match(j)!==null)}let v,y;const C=e.numericalConstraints;if(C.length>0){const T=i.numericalProperties,R=C.length,M=2**R-1;v=Iu(a.length,M);for(let F=0;F<R;++F){const j=C[F],U=T.find(se=>se.id===j.fieldId).values,O=2**F;var w=ae(j.bounds,2);const $=w[0],_=w[1];for(let se=0,oe=a.length;se<oe;++se){const Re=U[a[se]];v[se]|=O*(Re>=$&&Re<=_)}}y=a,a=y.slice();let V=a.length,B=0;for(let F=0;F<V;++F)v[F]===M&&(a[B]=a[F],++B);a=a.subarray(0,B)}let b=[];if(h!==void 0){const T=[],R=h.tags,M=h.values,V=new Uint32Array(R.length);for(let B=0,F=a.length;B<F;++B){const j=M[a[B]];for(let U=0,O=j.length;U<O;++U)++V[j.charCodeAt(U)]}for(let B=0,F=R.length;B<F;++B){const j=V[B],U=R[B],O={tag:U,tagIndex:B,count:V[B]};e.includeTags.includes(U)||e.excludeTags.includes(U)?T.push(O):j>0&&b.push(O)}T.push(...b),b=T}const k=(T,R)=>{if(T.type!=="number"){const M=T.values;a.sort((V,B)=>Lc(M[V],M[B])*R)}else{const M=T.values;a.sort((V,B)=>(M[V]-M[B])*R)}},L=T=>{h!==void 0&&k(h,T);const R=i?.labels;R!==void 0&&k(R,T)},I=e.sortBy;for(let T=I.length-1;T>=0;--T){var P=I[T];const R=P.fieldId,M=P.order,V=M==="<"?1:-1;if(R==="id"){if(T+1===I.length){if(M==="<")continue;a.reverse();continue}a.sort((B,F)=>V*(B-F));continue}else R==="label"?L(V):k(r.find(B=>B.id===R),V)}return{query:e,intermediateIndices:y,intermediateIndicesMask:v,indices:a,tags:b,count:a.length,total:s}}function aW(i,e,t){const n=e.values;var r=ae(t,2);const s=r[0],a=r[1],l=a<=s?0:256/(a-s),d=new Uint32Array(258),u=i.query.numericalConstraints,h=u.findIndex(g=>g.fieldId===e.id);if(h===-1){const g=i.indices;for(let v=0,y=g.length;v<y;++v){const C=n[g[v]];isNaN(C)||++d[Math.min(255,Math.max(-1,(C-s)*l))+1>>>0]}}else{const g=i.intermediateIndices,v=i.intermediateIndicesMask,y=2**u.length-1-2**h;for(let C=0,w=g.length;C<w;++C)if((v[C]&y)==y){const b=n[g[C]];isNaN(b)||++d[Math.min(255,Math.max(-1,(b-s)*l))+1>>>0]}}return{queryResult:i,histogram:d,window:t}}function oW(i,e,t,n){if(i===void 0){t.length=0,n.length=0;return}const r=i.numericalProperties,s=r.length;if(e?.indices===void 0){t.length=0;return}for(let a=0;a<s;++a){const l=t[a],d=n[a],u=r[a];l!==void 0&&l.queryResult===e&&xr(u.dataType,l.window,d)||(t[a]=aW(e,u,d))}}function KD(i){return i?.tags||i?.labels?"label":"id"}function lW(i,e){var t=e;const n=t.ids;if(n!==void 0)return n.map(g=>g.toString()).join(", ");let r="";e=e;var s=e;const a=s.prefix,l=s.regexp;a!==void 0?r=a:l!==void 0&&(r=`/${l}`);for(const g of e.includeTags)r.length>0&&(r+=" "),r+=`#${g}`;for(const g of e.excludeTags)r.length>0&&(r+=" "),r+=`-#${g}`;for(const g of e.numericalConstraints){const v=g.fieldId,y=g.bounds;var d=ae(y,2);const C=d[0],w=d[1],b=i.numericalProperties.find(k=>k.id===v);if(!xr(b.dataType,b.bounds,y)){if(dn(C,w)===0){r.length>0&&(r+=" "),r+=`${v}=${C}`;continue}if(dn(C,b.bounds[0])>0){r.length>0&&(r+=" ");const k=au(b.dataType,C,-1),L=C.toString(),I=k.toString();b.dataType!==q.FLOAT32||L.length<=I.length?r+=`${v}>=${L}`:r+=`${v}>${I}`}if(dn(w,b.bounds[1])<0){r.length>0&&(r+=" ");const k=au(b.dataType,w,1),L=w.toString(),I=k.toString();b.dataType!==q.FLOAT32||L.length<=I.length?r+=`${v}<=${L}`:r+=`${v}<${I}`}}}var u=e;let h=u.sortBy;if(h.length===1){const g=h[0];g.order==="<"&&g.fieldId===KD(i)&&(h=[])}for(const g of h)r.length>0&&(r+=" "),r+=`${g.order}${g.fieldId}`;for(const g of e.includeColumns)r.length>0&&(r+=" "),r+=`|${g}`;return r}const qf=new te;function Kd(i,e,t){if(e===void 0)return;const n=e.explicitIds;if(n!==void 0){n.forEach(t);return}const r=e.indices;if(r!==void 0){var s=i?.segmentPropertyMap.inlineProperties;const a=s.ids;for(let l=0,d=r.length;l<d;++l){const u=r[l];qf.low=a[u*2],qf.high=a[u*2+1],t(qf,l)}}}function cW(i,e,t){if(t.size===0)return 0;let n=0;return Kd(i,e,r=>{t.has(r)&&++n}),n}function xk(i,e,t,n){const r=i.includeTags.filter(a=>a!==e),s=i.excludeTags.filter(a=>a!==e);return n===!0&&(t?r:s).push(e),H(H({},i),{includeTags:r,excludeTags:s})}function dW(i){return i.ids!==void 0?!1:i.errors!==void 0?!0:!(i.numericalConstraints.length>0||i.includeTags.length>0||i.excludeTags.length>0||i.prefix||i.regexp)}function Cy(i,e){if(i===void 0||i.ids!==void 0||i.errors!==void 0)return!1;const t=i.sortBy,n=i.includeColumns;return t.find(r=>r.fieldId===e)!==void 0||n.includes(e)}const Yd=Xi("disjoint_sets:rank"),kr=Xi("disjoint_sets:parent"),Ru=Xi("disjoint_sets:next"),Ol=Xi("disjoint_sets:prev");function Jf(i){let e=i,t=i[kr];for(;t!==i;)i=t,t=i[kr];for(i=e[kr];t!==i;)e[kr]=t,e=i,i=e[kr];return t}function uW(i,e){let t=i[Yd],n=e[Yd];return t>n?(e[kr]=i,i):(i[kr]=e,t===n&&(e[Yd]=n+1),e)}function hW(i,e){let t=i[Ol],n=e[Ol];e[Ol]=t,t[Ru]=e,i[Ol]=n,n[Ru]=i}function*kk(i){let e=i;do yield e,e=e[Ru];while(e!==i)}function pW(i){i[kr]=i,i[Yd]=0,i[Ru]=i[Ol]=i}const Ha=Xi("disjoint_sets:min");function Ek(i){return i[kr]===i}class YD{constructor(){this.map=new ce,this.visibleSegmentEquivalencePolicy=new ct(Pn.MIN_REPRESENTATIVE),this.generation=0}has(e){let t=e.toString();return this.map.get(t)!==void 0}get(e){let t=e.toString(),n=this.map.get(t);return n===void 0?e:Jf(n)[Ha]}isMinElement(e){let t=this.get(e);return t===e||te.equal(t,e)}makeSet(e){let t=e.toString(),n=this.map,r=n.get(t);return r===void 0?(r=e.clone(),pW(r),r[Ha]=r,n.set(t,r),r):Jf(r)}link(e,t){if(e=this.makeSet(e),t=this.makeSet(t),e===t)return!1;this.generation++;let n=uW(e,t);hW(e,t);let r=e[Ha],s=t[Ha];const a=(this.visibleSegmentEquivalencePolicy.value&Pn.MAX_REPRESENTATIVE)!==0;return n[Ha]=te.less(r,s)===a?s:r,!0}linkAll(e){for(let t=1,n=e.length;t<n;++t)this.link(e[0],e[t])}deleteSet(e){const t=this.map;let n=!1;for(const r of this.setElements(e))t.delete(r.toString()),n=!0;return n}*setElements(e){let t=e.toString(),n=this.map.get(t);n===void 0?yield e:yield*kk(n)}clear(){let e=this.map;return e.size===0?!1:(++this.generation,e.clear(),!0)}get size(){return this.map.size}*mappings(e=new Array(2)){for(let t of this.map.values())e[0]=t,e[1]=Jf(t)[Ha],yield e}*roots(){for(let e of this.map.values())Ek(e)&&(yield e)}[Mi](){return this.mappings()}toJSON(){let e=new Array;for(let t of this.map.values())if(Ek(t)){let n=new Array;for(let r of kk(t))n.push(r);n.sort(te.compare),e.push(n)}return e.sort((t,n)=>te.compare(t[0],n[0])),e.map(t=>t.map(n=>n.toString()))}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var fW=function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=An(e,t):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(a=i[l])&&(s=(r<3?a(s):r>3?a(e,t,s):a(e,t))||s);return r>3&&s&&Mn(e,t,s),s},hm;const gW="DisjointUint64Sets",ZD="DisjointUint64Sets.add",QD="DisjointUint64Sets.clear",eP="DisjointUint64Sets.highBitRepresentativeChanged",tP="DisjointUint64Sets.deleteSet";let lc=hm=class extends sh{constructor(){super(...arguments),this.disjointSets=new YD,this.changed=new be}get value(){return this}static makeWithCounterpart(i,e){let t=new this;return t.disjointSets.visibleSegmentEquivalencePolicy=e,t.registerDisposer(e.changed.add(()=>{Lk(t)})),t.initializeCounterpart(i),e.value&&Lk(t),t}disposed(){this.disjointSets=void 0,this.changed=void 0,super.disposed()}link(i,e){if(this.disjointSets.link(i,e)){let t=this.rpc;return t&&t.invoke(ZD,{id:this.rpcId,al:i.low,ah:i.high,bl:e.low,bh:e.high}),this.changed.dispatch(),!0}return!1}linkAll(i){for(let e=1,t=i.length;e<t;++e)this.link(i[0],i[e])}has(i){return this.disjointSets.has(i)}get(i){return this.disjointSets.get(i)}clear(){if(this.disjointSets.clear()){let i=this.rpc;i&&i.invoke(QD,{id:this.rpcId}),this.changed.dispatch()}}setElements(i){return this.disjointSets.setElements(i)}deleteSet(i){if(this.disjointSets.deleteSet(i)){let e=this.rpc;e&&e.invoke(tP,{id:this.rpcId,l:i.low,h:i.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(i){if(i!==void 0){let e=[new te,new te];We(i,t=>{We(t,(n,r)=>{e[r%2].parseString(String(n),10),r!==0&&this.link(e[0],e[1])})})}}assignFrom(i){this.clear(),i instanceof hm&&(i=i.disjointSets);for(const t of i){var e=ae(t,2);const n=e[0],r=e[1];this.link(n,r)}}};lc=hm=fW([ah(gW)],lc);const ro=new te,Xf=new te;Et(ZD,function(i){let e=this.get(i.id);ro.low=i.al,ro.high=i.ah,Xf.low=i.bl,Xf.high=i.bh,e.disjointSets.link(ro,Xf)&&e.changed.dispatch()});Et(QD,function(i){let e=this.get(i.id);e.disjointSets.clear()&&e.changed.dispatch()});function Lk(i){i.rpc.invoke(eP,{id:i.rpcId,value:i.disjointSets.visibleSegmentEquivalencePolicy.value})}Et(eP,function(i){let e=this.get(i.id);e.disjointSets.visibleSegmentEquivalencePolicy.value=i.value});Et(tP,function(i){let e=this.get(i.id);ro.low=i.l,ro.high=i.h,e.disjointSets.deleteSet(ro)&&e.changed.dispatch()});class mW extends c_{constructor(){super(...arguments),this.spanningTreeEdges=new ce,this.equivalences=new lc,this.connections=new $e,this.changed=new Ze}link(e,t){this.equivalences.link(e,t);for(const n of this.connections)n.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){this.equivalences.linkAll(e);for(const t of this.connections)t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){this.equivalences.deleteSet(e);for(const t of this.connections)t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(const e of this.connections)Kf(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){const n=e.toString(),r=t.toString(),s=this.spanningTreeEdges;let a=s.get(n);a===void 0&&(a=new $e,s.set(n,a));let l=s.get(r);l===void 0&&(l=new $e,s.set(r,l)),a.add(r),l.add(n)}removeSpanningTreeEdge(e,t){const n=e.toString(),r=t.toString(),s=this.spanningTreeEdges,a=s.get(n),l=s.get(r);a.delete(r),a.size===0&&s.delete(n),l.delete(n),l.size===0&&s.delete(r)}*getSpanningTreeNeighbors(e){const t=new te,n=this.spanningTreeEdges.get(e.toString());if(n!==void 0)for(const r of n)t.parseString(r),yield t}restoreState(e){const t=this.equivalences,n=this.spanningTreeEdges;if(t.clear(),n.clear(),e===void 0)return;const r=[new te,new te];We(e,s=>{We(s,(a,l)=>{r[l%2].parseString(String(a),10),l!==0&&t.link(r[0],r[1])&&this.addSpanningTreeEdge(r[0],r[1])})})}toJSON(){const e=this.spanningTreeEdges;if(e.size===0)return;const t=new Array;for(let r of e){var n=ae(r,2);let s=n[0],a=n[1];const l=te.parseString(s);for(const d of a){const u=te.parseString(d);te.compare(l,u)>0||t.push([l,u])}}return t.sort((r,s)=>te.compare(r[0],s[0])||te.compare(r[1],s[1])),t.map(r=>r.map(s=>s.toString()))}get visibleSegmentEquivalencePolicy(){return Pn.MIN_REPRESENTATIVE}async merge(e,t){const n=this.equivalences;return te.equal(n.get(e),n.get(t))?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),n.get(e))}async split(e,t){const n=this.computeSplit(e,t);if(n===void 0)throw new Error("Segments are already split");const r=n.includeBaseSegments,s=n.includeRepresentative,a=n.excludeBaseSegments,l=n.excludeRepresentative,d=this.equivalences;this.deleteSet(e),this.linkAll(r),this.linkAll(a);const u=(v,y)=>{for(const C of v)for(const w of this.getSpanningTreeNeighbors(C))te.equal(d.get(w),y)||this.removeSpanningTreeEdge(C,w)},h=d.get(e),g=d.get(t);u(r,h),u(a,g);for(const v of this.connections){const y=v.segmentsState.visibleSegments;y.has(l)&&(y.delete(l),y.add(s))}return this.normalizeAll(),this.changed.dispatch(),{include:h,exclude:g}}trackSegment(e,t){return()=>{}}computeSplit(e,t){const n=this.equivalences,r=n.get(e);if(!te.equal(r,n.get(t)))return;const s=new YD;for(const g of n.setElements(r))if(!te.equal(g,t))for(const v of this.getSpanningTreeNeighbors(g))te.equal(v,t)||s.link(g,v);const a=[],l=[],d=s.get(e);let u=e,h=t;for(const g of n.setElements(r))te.equal(s.get(g),d)?(a.push(g),te.compare(g,u)<0&&(u=g)):(l.push(g),te.compare(g,h)<0&&(h=g));return a.sort(te.compare),l.sort(te.compare),{includeBaseSegments:a,includeRepresentative:u,excludeBaseSegments:l,excludeRepresentative:h}}connect(e){const t=new vW(this,e);return e.segmentEquivalences.assignFrom(this.equivalences),Kf(e.visibleSegments,e.segmentEquivalences.disjointSets),t.registerDisposer(e.visibleSegments.changed.add(t.registerCancellable(nt(()=>Kf(e.visibleSegments,e.segmentEquivalences.disjointSets),0)))),this.connections.add(t),t.registerDisposer(()=>{this.connections.delete(t)}),t}}function Kf(i,e){const t=[];for(const n of i.unsafeKeys()){const r=e.get(n);te.equal(n,r)||(t.push(r),i.delete(n))}for(const n of t)i.add(n)}class vW extends d_{computeSplit(e,t){return this.graph.computeSplit(e,t)}}var fi;(function(i){i[i.UNKNOWN=0]="UNKNOWN",i[i.IMAGE=1]="IMAGE",i[i.SEGMENTATION=2]="SEGMENTATION"})(fi||(fi={}));function Tk(i){const e=i.rank,t=i.dataType,n=i.compressedSegmentationBlockSize;var r=i.baseVoxelOffset;const s=r===void 0?new Float32Array(e):r;return H(H({},Cc(i)),{compressedSegmentationBlockSize:n,baseVoxelOffset:s,dataType:t})}function yW(i){if(i.compressedSegmentationBlockSize!==void 0||i.volumeType!==fi.SEGMENTATION&&!i.volumeSourceOptions.discreteValues)return!1;switch(i.dataType){case q.UINT32:case q.UINT64:break;default:return!1}switch(i.rank){case 3:return!0;case 4:return i.chunkDataSize[3]===1;default:return!1}}function SW(i){let e=i.rank,t=i.lowerVoxelBound,n=i.upperVoxelBound;if(!yW(i))return Tk(i);var r=i.volumeSourceOptions;let s=r.displayRank,a=r.multiscaleToViewTransform,l=i.chunkToMultiscaleTransform,d=i.chunkToViewTransform;d===void 0&&(d=nh(new Float32Array(e*s),s,a,s,l,e+1,s,e,e));const u=i.maxCompressedSegmentationBlockSize,h=i.chunkDataSize;return Tk(H(H({},i),{compressedSegmentationBlockSize:Float32Array.from(gu({rank:e,chunkToViewTransform:d,displayRank:s,lowerVoxelBound:t,upperVoxelBound:n,maxVoxelsPerChunkLog2:9,maxBlockSize:u===void 0?h:y3(new Uint32Array(e),h,u)}))}))}function zc(i){const e=i.rank;var t=i.volumeSourceOptions;const n=t.displayRank,r=t.multiscaleToViewTransform,s=t.modelChannelDimensionIndices,a=i.chunkToMultiscaleTransform,l=nh(new Float32Array(n*e),n,r,n,a,e+1,n,e,e);let d=i.minBlockSize;d===void 0?(d=new Uint32Array(e),d.fill(1)):d=new Uint32Array(d);const u=i.lowerVoxelBound,h=i.upperVoxelBound;if(s.length!==0)for(const v of ih(a,e,s)){let y=h[v];u!==void 0&&(y-=u[v]),d[v]=y}var g=i.chunkDataSizes;return(g===void 0?$B(H(H({},i),{minBlockSize:d,chunkToViewTransform:l,displayRank:n})):g).map(v=>SW(H(H({},i),{chunkDataSize:v,chunkToViewTransform:l})))}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const bW=Ne(),wW=Ne(),Dk=.001,CW=.001;function xW(i){let e=0;for(var t=0;t<3;++t)i[t]<0&&(e+=1<<t);return e}const iP=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),kW=(()=>{const i=[0,1,2,4,5,3,6,7],e=[0,1,2,5,3,4,6,7],t=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],n=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],r=new Int32Array(384);for(let s=0;s<8;++s)for(let a=0;a<t.length;++a){const l=e[s]*8+t[a];r[s*8*6+a]=i[n[l]]}return r})();function Mu(i){i.addUniform("highp vec3","uPlaneNormal"),i.addUniform("highp float","uPlaneDistance"),i.addUniform("highp ivec2","uVertexIndex",24),i.addUniform("highp vec3","uVertexBasePosition",8),i.addInitializer(e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),iP)}),i.addVertexCode(`
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {
  for (int e = 0; e < 4; ++e) {
    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];
    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));
    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));
    highp vec3 vDir = v2 - v1;
    highp float denom = dot(vDir, uPlaneNormal);
    if (abs(denom) > ${CW}) {
      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;
      if ((lambda >= -${Dk}) && (lambda <= (1.0 + ${Dk}))) {
        lambda = clamp(lambda, 0.0, 1.0);
        highp vec3 position = v1 + lambda * vDir;
        return position;
      }
    }
  }
  return vec3(0, 0, 0);
}
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {
  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);
}
`)}function EW(i,e,t){const n=i.gl;n.uniform3fv(i.uniform("uPlaneNormal"),e),n.uniform1f(i.uniform("uPlaneDistance"),t);const r=xW(e);n.uniform2iv(i.uniform("uVertexIndex"),kW.subarray(r*48,(r+1)*48))}function xy(i,e,t,n,r){const s=oL(bW,e,n);eu(s,s);const a=rv(an(wW,t,r),s);EW(i,s,a)}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const LW=.001,TW=Je();function DW(i,e){if(Mr(i),Mu(i),i.addUniform("highp vec3","uTranslation"),i.addUniform("highp mat4","uProjectionMatrix"),i.addUniform("highp vec3","uChunkDataSize"),i.addUniform("highp vec3","uLowerClipBound"),i.addUniform("highp vec3","uUpperClipBound"),e){tr(i),i.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${us};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`),i.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()));
`);return}i.addVarying("highp vec3","vChunkPosition"),i.setVertexMain(`
vec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);
gl_Position = uProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
vChunkPosition = (position - uTranslation) +
    ${LW} * abs(uPlaneNormal);
`)}function PW(i,e,t){t&&nr(i,e,1)}function IW(i,e,t,n,r,s){const a=t.projectionParameters.value,l=a.centerDataPosition;xy(e,a.viewportNormalInGlobalCoordinates,l,s.transform,s.invTransform),i.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,ei(TW,n,s.transform)),i.uniform3fv(e.uniform("uLowerClipBound"),r.lowerClipDisplayBound),i.uniform3fv(e.uniform("uUpperClipBound"),r.upperClipDisplayBound)}function RW(i,e,t){i.uniform3fv(e.uniform("uChunkDataSize"),t)}function MW(i,e,t,n){i.uniform3fv(e.uniform("uTranslation"),t),n?ir(e.gl,6,1):i.drawArrays(i.TRIANGLE_FAN,0,6)}function AW(i,e,t){return i>e?t>i?i:e>t?e:t:t>e?e:i>t?i:t}class nP extends Fv{constructor(e,t){var n=t.shaderError;const r=n===void 0?lh():n,s=t.shaderParameters;super(e.chunkManager,e,t);const a=this.gl;this.vertexIdHelper=this.registerDisposer(rr.get(a)),this.shaderParameters=s;const l=t.channelCoordinateSpace;this.channelCoordinateSpace=l===void 0?Zs(Ir):l,this.registerDisposer(s.changed.add(this.redrawNeeded.dispatch));const d=this.registerDisposer(cn((u,h)=>({numChannelDimensions:u.rank,dataHistogramChannelSpecifications:h}),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=Ev(this,a,{memoizeKey:`volume/RenderLayer:${oi(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:s,encodeParameters:t.encodeShaderParameters,shaderError:r,extraParameters:d,defineShader:(u,h,g,v)=>{const y=h.chunkFormat,C=h.dataHistogramsEnabled,w=v.dataHistogramChannelSpecifications,b=v.numChannelDimensions;if(DW(u,y===null),u.addOutputBuffer("vec4","v4f_fragData0",0),u.addFragmentCode(`
void emit(vec4 color) {
  v4f_fragData0 = color;
}
`),y===null)return;$T(u,y,b,"vChunkPosition");const k=w.length;if(C&&k>0){let L="";const I=y.dataType;for(let P=0;P<k;++P){const T=w[P].channel,R=`out_histogram${P}`;u.addOutputBuffer("vec4",R,1+P);const M=`getDataValue(${T.join(",")})`,V=`invlerpForHistogram${P}`;u.addFragmentCode(T2(u,V,I,!1)),u.addFragmentCode(`
float getHistogramValue${P}() {
  return invlerpForHistogram${P}(${M});
}
`),L+=`{
float x = getHistogramValue${P}();
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
${R} = vec4(x, x, x, 1.0);
}`}u.addFragmentCode(`void userMain();
void main() {
  ${L}
  userMain();
}
#define main userMain
`)}this.defineShader(u,g)},getContextKey:u=>{var h;return`${(h=u.chunkFormat)===null||h===void 0?void 0:h.shaderKey}/${u.dataHistogramsEnabled}`}}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){let t=this.tempChunkPosition;for(const n of this.visibleSourcesList){const r=n.source,s=n.chunkTransform;if(!Xl(t,e,this.localPosition.value,s.layerRank,s.combinedGlobalLocalToChunkTransform))continue;const a=r.getValueAt(t,s);if(a!=null)return a}return null}beginChunkFormat(e,t,n){const r=this.gl,s=this.dataHistogramSpecifications.visibility.visible,a=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:s}),l=a.shader,d=a.parameters,u=a.fallback;if(l!==null&&(l.bind(),PW(l,n,t===null),t!==null)){if(s){const h=a.extraParameters.dataHistogramChannelSpecifications.length,g=this.dataHistogramSpecifications.bounds.value;for(let v=0;v<h;++v)Rv(l,`invlerpForHistogram${v}`,t.dataType,g[v])}this.initializeShader(e,l,d,u),t.beginDrawing(r,l)}return a}endSlice(e,t,n){}draw(e){const t=e.sliceView,n=t.visibleLayers.get(this).visibleSources;if(n.length===0)return;const r=e.projectionParameters,s=e.wireFrame,a=this.gl;this.vertexIdHelper.enable();const l=Ne(),d=this.renderScaleHistogram;d!==void 0&&d.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let u,h=null,g;const v=Ne(),y=()=>{h!==null&&(g!==null&&g.endDrawing(a,h),this.endSlice(t,h,u.parameters))};let C=!0;for(const w of n){const b=Ov(r,w.chunkLayout),k=w.chunkTransform.channelToChunkDimensionIndices,L=w.source,I=w.fixedPositionWithinChunk,P=w.chunkDisplayDimensionIndices;for(const U of P)I[U]=0;const T=s?null:L.chunkFormat;if(T!==g&&(g=T,y(),u=this.beginChunkFormat(t,T,r),h=u.shader),h===null)continue;const R=L.chunks;v.fill(1);let M=b.size,V;const B=L.spec.rank;IW(a,h,t,r.viewProjectionMat,w,b),T!==null&&T.beginSource(a,h),C=!0;let F=0,j=0;if(t.forEachVisibleChunk(w,b,U=>{let O=R.get(U);if(O&&O.state===pt.GPU_MEMORY){let $=O.chunkDataSize;if($!==V){V=$;for(let se=0;se<3;++se){const oe=P[se];v[se]=oe===-1||oe>=B?1:V[oe]}RW(a,h,v)}const _=O.chunkGridPosition;for(let se=0;se<3;++se){const oe=P[se];l[se]=oe===-1||oe>=B?0:M[se]*_[oe]}T!==null&&T.bindChunk(a,h,O,I,P,k,C),C=!1,MW(a,h,l,s),++F}else++j}),(F!==0||j!==0)&&d!==void 0){const U=w.effectiveVoxelSize,O=AW(U[0],U[1],U[2]);d.add(O,O/r.pixelSize,F,j)}}if(y(),this.vertexIdHelper.disable(),!e.wireFrame){const w=this.getDataHistogramCount();w>0&&t.computeHistograms(w,this.dataHistogramSpecifications)}}}class Pk{constructor(e){this.disjointSets=e,this.generation=Number.NaN,this.hashMap=new Hv}update(){let e=this.disjointSets;const t=e.generation;if(this.generation!==t){this.generation=t;let r=this.hashMap;r.clear();for(let s of e.mappings()){var n=ae(s,2);let a=n[0],l=n[1];r.set(a,l)}}}}class Yf extends nP{constructor(e,t){super(e,{shaderParameters:new KE(n=>({hasEquivalences:n.registerDisposer(cn(r=>r.size!==0,[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:n.registerDisposer(cn(r=>r.size!==0,[t.segmentStatedColors])),hasSegmentDefaultColor:n.registerDisposer(cn(r=>r!==void 0,[t.segmentDefaultColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring})),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition}),this.displayState=t,this.segmentationGroupState=this.displayState.segmentationGroupState.value,this.segmentColorShaderManager=new JF("segmentColorHash"),this.segmentStatedColorShaderManager=new XF("segmentStatedColor"),this.hashTableManager=new yT("visibleSegments"),this.gpuHashTable=this.registerDisposer(Rl.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable)),this.gpuTemporaryHashTable=Rl.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable),this.equivalencesShaderManager=new ST("equivalences"),this.equivalencesHashMap=new Pk(this.segmentationGroupState.segmentEquivalences.disjointSets),this.temporaryEquivalencesHashMap=new Pk(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets),this.gpuEquivalencesHashTable=this.registerDisposer(Rl.get(this.gl,this.equivalencesHashMap.hashMap)),this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(Rl.get(this.gl,this.temporaryEquivalencesHashMap.hashMap)),this.registerDisposer(this.shaderParameters),RT(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){var e;(e=this.gpuSegmentStatedColorHashTable)===null||e===void 0||e.dispose()}getSources(e){return this.multiscaleSource.getSources(H(H({},e),{discreteValues:!0}))}defineShader(e,t){this.hashTableManager.defineShader(e);let n=`
uint64_t getUint64DataValue() {
  uint64_t x = toUint64(getDataValue());
`;n+=`return x;
}
`,e.addFragmentCode(n),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  uint64_t mappedValue;
  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {
    return mappedValue;
  }
  return value;
}
`)):e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  return value;
}
`),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uShowAllSegments"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let r=`
  uint64_t baseValue = getUint64DataValue();
  uint64_t value = getMappedObjectId(baseValue);
  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};

  float alpha = uSelectedAlpha;
  float saturation = uSaturation;
`;t.hideSegmentZero&&(r+=`
  if (value.value[0] == 0u && value.value[1] == 0u) {
    emit(vec4(vec4(0, 0, 0, 0)));
    return;
  }
`),r+=`
  bool has = uShowAllSegments != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);
  if (uSelectedSegment == value.value) {
    float adjustment = has ? 0.5 : 0.75;
    if (saturation > adjustment) {
      saturation -= adjustment;
    } else {
      saturation += adjustment;
    }
  } else if (!has) {
    alpha = uNotSelectedAlpha;
  }
`;let s=`vec3 getMappedIdColor(uint64_t value) {
`;t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),s+=`
  vec3 rgb;
  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgb)) {
    return rgb;
  }
`),t.hasSegmentDefaultColor?(e.addUniform("highp vec3","uSegmentDefaultColor"),s+=`  return uSegmentDefaultColor;
`):(this.segmentColorShaderManager.defineShader(e),s+=`  return segmentColorHash(value);
`),s+=`
}
`,e.addFragmentCode(s),r+=`
  vec3 rgb = getMappedIdColor(valueForColor);
  emit(vec4(mix(vec3(1.0,1.0,1.0), rgb, saturation), alpha));
`,e.setFragmentMain(r)}initializeShader(e,t,n){const r=this.gl,s=this.displayState,a=this.segmentationGroupState,l=this.displayState.segmentSelectionState;var d=this.displayState;const u=d.segmentDefaultColor.value,h=d.segmentColorHash.value,g=F2(a),v=this.displayState.ignoreNullVisibleSet.value;let y=0,C=0;if(l.hasSelectedSegment){let w=l.selectedSegment;y=w.low,C=w.high}if(r.uniform1f(t.uniform("uSelectedAlpha"),s.selectedAlpha.value),r.uniform1f(t.uniform("uSaturation"),s.saturation.value),r.uniform1f(t.uniform("uNotSelectedAlpha"),s.notSelectedAlpha.value),r.uniform2ui(t.uniform("uSelectedSegment"),y,C),r.uniform1ui(t.uniform("uShowAllSegments"),g.hashTable.size||!v?0:1),this.hashTableManager.enable(r,t,a.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),n.hasEquivalences){const w=a.useTemporarySegmentEquivalences.value;(w?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(r,t,w?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}if(u===void 0?this.segmentColorShaderManager.enable(r,t,h):r.uniform3fv(t.uniform("uSegmentDefaultColor"),u),n.hasSegmentStatedColors){const w=this.displayState.segmentStatedColors.value;let b=this.gpuSegmentStatedColorHashTable;(b===void 0||b.hashTable!==w.hashTable)&&(b?.dispose(),this.gpuSegmentStatedColorHashTable=b=Rl.get(r,w.hashTable)),this.segmentStatedColorShaderManager.enable(r,t,b)}}endSlice(e,t,n){const r=this.gl;this.hashTableManager.disable(r,t),n.hasEquivalences&&this.equivalencesShaderManager.disable(r,t),n.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(r,t),super.endSlice(e,t,n)}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function Bl(i=.5){return new Jt(i,vL)}/**
* @license
* Copyright 2020 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const ky=12,rP=8,NW=6,VW=`
vec3 getBoxFaceVertexPosition(int vertexIndex) {
  const vec3 vertexPositions[] = vec3[](
  // Front face
  vec3(0.0, 0.0,  1.0), // 0
  vec3(1.0, 0.0,  1.0), // 1
  vec3(1.0,  1.0,  1.0), // 2
  vec3(0.0,  1.0,  1.0), // 3

  // Back face
  vec3(0.0, 0.0, 0.0), // 4
  vec3(0.0,  1.0, 0.0), // 5
  vec3(1.0,  1.0, 0.0), // 6
  vec3(1.0, 0.0, 0.0), // 7

  // Top face
  vec3(0.0,  1.0, 0.0), // 8
  vec3(0.0,  1.0,  1.0), // 9
  vec3(1.0,  1.0,  1.0), // 10
  vec3(1.0,  1.0, 0.0), // 11

  // Bottom face
  vec3(0.0, 0.0, 0.0), // 12
  vec3( 1.0, 0.0, 0.0), // 13
  vec3( 1.0, 0.0,  1.0), // 14
  vec3(0.0, 0.0,  1.0), // 15

  // Right face
  vec3( 1.0, 0.0, 0.0), // 16
  vec3( 1.0,  1.0, 0.0), // 17
  vec3( 1.0,  1.0,  1.0), // 18
  vec3( 1.0, 0.0,  1.0), // 19

  // Left face
  vec3(0.0, 0.0, 0.0), // 20
  vec3(0.0, 0.0,  1.0), // 21
  vec3(0.0,  1.0,  1.0), // 22
  vec3(0.0,  1.0, 0.0) // 23
  );
  const int indices[] = int[](
    0,  1,  2,      0,  2,  3,    // front
    4,  5,  6,      4,  6,  7,    // back
    8,  9,  10,     8,  10, 11,   // top
    12, 13, 14,     12, 14, 15,   // bottom
    16, 17, 18,     16, 18, 19,   // right
    20, 21, 22,     20, 22, 23   // left
  );
  return vertexPositions[indices[vertexIndex]];
}
`;function OW(i,e,t){i.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*NW*e,t)}const BW=0,Ey=BW+1,Bi=Ey+rP,_W=Bi+ky,FW=_W+6,UW=Float32Array.from([0,0,0,0,0,1,Bi+0,1,0,0,1,0,1,Bi+1,0,1,0,0,1,1,Bi+2,1,1,0,1,1,1,Bi+3,0,0,0,0,1,0,Bi+4,0,0,1,0,1,1,Bi+5,1,0,0,1,1,0,Bi+6,1,0,1,1,1,1,Bi+7,0,0,0,1,0,0,Bi+8,0,0,1,1,0,1,Bi+9,0,1,0,1,1,0,Bi+10,0,1,1,1,1,1,Bi+11]),Ik=Je(),ss=new Float32Array(6);let sP=class extends xc{constructor(){super(...arguments),this.vertexIdHelper=this.registerDisposer(rr.get(this.gl))}defineShader(i){Mr(i);const e=this.rank;bc(i,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",e,2),i.addUniform("vec3","uModelSpaceBoundOffsets",2)}enable(i,e,t){fs(Ik,e.modelViewProjectionMatrix),ZN(Ik,ss);const n=e.chunkDisplayTransform.numChunkDisplayDims;for(let r=0;r<n;++r)ss[r]=0,ss[r+3]=0;for(let r=n;r<3;++r){const s=Math.abs(ss[r+3]-ss[r]);ss[r]-=s,ss[r+3]+=s}super.enable(i,e,r=>{const s=r.vertexShaderInputBinders.Bounds;s.enable(1);const a=this.gl;a.uniform3fv(r.uniform("uModelSpaceBoundOffsets"),ss),a.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer),s.bind(this.geometryDataStride,e.bufferOffset);const l=this.vertexIdHelper;l.enable(),t(r),l.disable(),s.disable()})}};function aP(i){i.addVertexCode(`
void setBoundingBoxBorderWidth(float width) {}
void setBoundingBoxBorderColor(vec4 color) {}
`)}function oP(i){i.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {}
`)}function pm(i){oP(i),i.addVertexCode(`
float ng_lineWidth;
void setBoundingBoxBorderWidth(float size) {
  ng_lineWidth = size;
}
void setBoundingBoxBorderColor(vec4 color) {
  vColor = color;
}
`)}function zW(i){aP(i),i.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {
  vColor = color;
}
`)}class $W extends sP{constructor(){super(...arguments),this.edgeBoxCornerOffsetsBuffer=this.registerDisposer(Ui.fromData(this.gl,og(UW,7,1,us))),this.edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",e=>{const t=this.rank;this.defineShader(e),tr(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),pm(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);
vec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(endpointA, 1.0),
         uModelViewProjection * vec4(endpointB, 1.0),
         ng_lineWidth);
${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));
`)}),this.boxCornerOffsetsBuffer=this.registerDisposer(Ui.fromData(this.gl,og(iP,3,1,oy))),this.cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",e=>{const t=this.rank;this.defineShader(e),Nc(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),pm(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);
emitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);
uint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);
uint cornerPickOffset = ${Ey}u + cornerIndex;
${this.setPartIndex(e,"cornerPickOffset")};
`),e.setFragmentMain(`
vec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);
vec4 color = getCircleColor(vColor, borderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}drawEdges(e){const t=this.gl;this.enable(this.edgeShaderGetter,e,n=>{const r=n.attribute("aBoxCornerOffset1"),s=n.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1,28,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(s,4,WebGL2RenderingContext.FLOAT,!1,28,12),nr(n,e.renderContext.projectionParameters,1),ir(t,ky,e.count),t.disableVertexAttribArray(r),t.disableVertexAttribArray(s)})}drawCorners(e){const t=this.gl;this.enable(this.cornerShaderGetter,e,n=>{const r=n.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1),Vc(n,e.renderContext.projectionParameters,{featherWidthInPixels:0}),Oc(n.gl,rP,e.count),t.disableVertexAttribArray(r)})}draw(e){this.drawEdges(e),this.drawCorners(e)}}let GW=class extends sP{constructor(){super(...arguments),this.faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",i=>{const e=this.rank;super.defineShader(i),Mu(i),tr(i),i.addVarying("highp float","vClipCoefficient"),pm(i),i.setVertexMain(`
float modelPositionA[${e}] = getBounds0();
float modelPositionB[${e}] = getBounds1();
for (int i = 0; i < ${e}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex1 = gl_VertexID / ${us};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),
         uModelViewProjection * vec4(vertexPosition2, 1.0),
         ng_lineWidth);
${this.setPartIndex(i)};
`),i.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));
`)}),this.fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",i=>{const e=this.rank;super.defineShader(i),Mu(i),i.addVarying("highp float","vClipCoefficient"),zW(i),i.setVertexMain(`
float modelPositionA[${e}] = getBounds0();
float modelPositionB[${e}] = getBounds1();
for (int i = 0; i < ${e}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex = gl_VertexID;
vec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);
gl_Position = uModelViewProjection * vec4(vertexPosition, 1);
${this.invokeUserMain}
${this.setPartIndex(i)};
`),i.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)})}enableForBoundingBox(i,e,t){super.enable(i,e,n=>{const r=e.renderContext.sliceView.projectionParameters.value;xy(n,r.viewportNormalInGlobalCoordinates,r.centerDataPosition,e.renderSubspaceModelMatrix,e.renderSubspaceInvModelMatrix),t(n)})}draw(i){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,i,()=>{UO(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,6,i.count)}),this.enableForBoundingBox(this.faceShaderGetter,i,e=>{nr(e,i.renderContext.projectionParameters,1),ir(e.gl,6,i.count)})}};function WW(i,e){const t=i.length;for(let n=0;n<t;++n){const r=e[n],s=e[n+t],a=i[n];i[n]=Math.abs(r-a)<Math.abs(s-a)?r:s}}kc(Ie.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:GW,perspectiveViewRenderHelper:$W,defineShaderNoOpSetters(i){oP(i),aP(i)},pickIdsPerInstance:FW,snapPosition(i,e,t,n){const r=i.length,s=new Float32Array(e,t,r*2);n>=Ey&&n<Bi&&WW(i,s)},getRepresentativePoint(i,e,t){i.set(e.pointA)},updateViaRepresentativePoint(i,e,t){const n=e.length,r=i.pointA,s=i.pointB,a=new Float32Array(n),l=new Float32Array(n);for(let d=0;d<n;++d){const u=a[d]=e[d];l[d]=s[d]+(u-r[d])}return H(H({},i),{pointA:a,pointB:l})}});const qa=0,fm=qa+1,HW=fm+2;function lP(i){i.addVertexCode(`
void setEndpointMarkerSize(float startSize, float endSize) {}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
`)}function cP(i){i.addVertexCode(`
void setLineWidth(float width) {}
void setLineColor(vec4 startColor, vec4 endColor) {}
`)}let Rk=class extends xc{constructor(){super(...arguments),this.vertexIdHelper=this.registerDisposer(rr.get(this.gl)),this.edgeShaderGetter=this.getDependentShader("annotation/line/edge",i=>{const e=this.rank;this.defineShader(i),tr(i),i.addVarying(`highp float[${e}]`,"vModelPosition"),i.addVertexCode(`
float ng_LineWidth;
`),lP(i),i.addVertexCode(`
void setLineWidth(float width) {
  ng_LineWidth = width;
}
void setLineColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),i.setVertexMain(`
float modelPositionA[${e}] = getVertexPosition0();
float modelPositionB[${e}] = getVertexPosition1();
for (int i = 0; i < ${e}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(i)};
`),i.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)}),this.endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",i=>{const e=this.rank;this.defineShader(i),Nc(i,this.targetIsSliceView),i.addVarying("highp float","vClipCoefficient"),i.addVarying("highp vec4","vBorderColor"),cP(i),i.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${oy};
}
void setEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),i.setVertexMain(`
float modelPosition[${e}] = getVertexPosition0();
float modelPositionB[${e}] = getVertexPosition1();
for (int i = 0; i < ${e}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(i,"uint(getEndpointIndex()) + 1u")};
`),i.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}defineShader(i){Mr(i);const e=this.rank;bc(i,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",e,2)}enable(i,e,t){super.enable(i,e,n=>{const r=n.vertexShaderInputBinders.VertexPosition;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer),r.bind(this.geometryDataStride,e.bufferOffset);const s=this.vertexIdHelper;s.enable(),t(n),s.disable(),r.disable()})}drawEdges(i){this.enable(this.edgeShaderGetter,i,e=>{nr(e,i.renderContext.projectionParameters,1),ir(e.gl,1,i.count)})}drawEndpoints(i){this.enable(this.endpointShaderGetter,i,e=>{Vc(e,i.renderContext.projectionParameters,{featherWidthInPixels:.5}),Oc(e.gl,2,i.count)})}draw(i){this.drawEdges(i),this.drawEndpoints(i)}};function jW(i,e){const t=i.length;lL(i,e.subarray(0,t),e.subarray(t),i)}function qW(i,e,t){const n=i.length,r=n*t;for(let s=0;s<n;++s)i[s]=e[r+s]}kc(Ie.LINE,{sliceViewRenderHelper:Rk,perspectiveViewRenderHelper:Rk,defineShaderNoOpSetters(i){lP(i),cP(i)},pickIdsPerInstance:HW,snapPosition(i,e,t,n){const r=i.length,s=new Float32Array(e,t,r*2);n===qa?jW(i,s):qW(i,s,n-fm)},getRepresentativePoint(i,e,t){i.set(t===qa||t===fm?e.pointA:e.pointB)},updateViaRepresentativePoint(i,e,t){let n=H({},i);const r=e.length;switch(t){case qa:{const s=i.pointA,a=i.pointB,l=new Float32Array(r),d=new Float32Array(r);for(let u=0;u<r;++u){const h=l[u]=e[u];d[u]=a[u]+(h-s[u])}return H(H({},i),{pointA:l,pointB:d})}case qa+1:return H(H({},i),{pointA:new Float32Array(e)});case qa+2:return H(H({},i),{pointB:new Float32Array(e)})}return n}});let Mk=class extends xc{constructor(){super(...arguments),this.shaderGetter3d=this.getDependentShader("annotation/point:3d",i=>{Mr(i),Nc(i,this.targetIsSliceView),this.defineShaderCommon(i),i.addVertexMain(`
emitCircle(uModelViewProjection *
           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
`),i.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
emitAnnotation(color);
`)}),this.makeShaderGetter2d=i=>this.getDependentShader(`annotation/point:2d:${i}`,e=>{Mr(e),tr(e,!0),this.defineShaderCommon(e),e.addVertexMain(`
vec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);
vec3 subspacePositionB = subspacePositionA;
vec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);
vec4 zCoeffs = uModelViewProjection[${i}];
float minZ = 1e30;
float maxZ = -1e30;
for (int i = 0; i < 3; ++i) {
  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1
  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];
  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;
  if (k1 != 0.0) {
    minZ = min(minZ, q1);
    maxZ = max(maxZ, q1);
  }
  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2
  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];
  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;
  if (k2 != 0.0) {
    minZ = min(minZ, q2);
    maxZ = max(maxZ, q2);
  }
}
if (minZ > maxZ) minZ = maxZ = 0.0;
subspacePositionA[${i}] = minZ;
subspacePositionB[${i}] = maxZ;
emitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);
`),e.setFragmentMain(`
vec4 color = getRoundedLineColor(vColor, vBorderColor);
emitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));
`)}),this.shaderGetter2d=this.makeShaderGetter2d(2),this.shaderGetter1d=this.makeShaderGetter2d(1),this.vertexIdHelper=this.registerDisposer(rr.get(this.gl))}defineShaderCommon(i){const e=this.rank;bc(i,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",e),i.addVarying("highp vec4","vBorderColor"),i.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
void setPointMarkerSize(float size) {
  ng_markerDiameter = size;
}
void setPointMarkerBorderWidth(float size) {
  ng_markerBorderWidth = size;
}
void setPointMarkerColor(vec4 color) {
  vColor = color;
}
void setPointMarkerBorderColor(vec4 color) {
  vBorderColor = color;
}
`),i.addVertexMain(`
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
float modelPosition[${e}] = getVertexPosition0();
float clipCoefficient = getSubspaceClipCoefficient(modelPosition);
if (clipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
${this.invokeUserMain}
vColor.a *= clipCoefficient;
vBorderColor.a *= clipCoefficient;
${this.setPartIndex(i)};
`)}enable(i,e,t){super.enable(i,e,n=>{const r=n.vertexShaderInputBinders.VertexPosition;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer),r.bind(this.geometryDataStride,e.bufferOffset);const s=this.vertexIdHelper;s.enable(),t(n),s.disable(),r.disable()})}draw(i){const e=i.chunkDisplayTransform.numChunkDisplayDims;switch(e){case 3:this.enable(this.shaderGetter3d,i,t=>{Vc(t,i.renderContext.projectionParameters,{featherWidthInPixels:1}),Oc(t.gl,1,i.count)});break;case 2:case 1:this.enable(e===2?this.shaderGetter2d:this.shaderGetter1d,i,t=>{nr(t,i.renderContext.projectionParameters,1),ir(t.gl,1,i.count)});break}}};kc(Ie.POINT,{sliceViewRenderHelper:Mk,perspectiveViewRenderHelper:Mk,defineShaderNoOpSetters(i){i.addVertexCode(`
void setPointMarkerSize(float size) {}
void setPointMarkerBorderWidth(float size) {}
void setPointMarkerColor(vec4 color) {}
void setPointMarkerBorderColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition(i,e,t){i.set(new Float32Array(e,t,i.length))},getRepresentativePoint(i,e){i.set(e.point)},updateViaRepresentativePoint(i,e){return H(H({},i),{point:new Float32Array(e)})}});/**
* @license
* Copyright 2018 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const dP=`
struct EllipseQuadraticForm {
  highp float A;  // x*x coefficient
  highp float B;  // x*y coefficient
  highp float C;  // y*y coefficient
  highp float D;  // x coefficient
  highp float E;  // y coefficient
  highp float F;  // 1 coefficient
};
`,JW=[dP,`
EllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {
  EllipseQuadraticForm p;
  p.A = A[0][0];
  p.B = A[0][1] + A[1][0];
  p.C = A[1][1];
  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +
        c[2] * (A[0][2] + A[2][0]);
  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +
        c[2] * (A[1][2] + A[2][1]);
  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -
        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -
        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;
  return p;
}
`],XW=`
struct CenterOrientEllipse {
  vec2 k;   // center
  vec2 u1;  // minor axis direction
  vec2 u2;  // major axis direction
  float a;  // semimajor axis
  float b;  // semiminor axis
  bool valid; // indicates if the ellipse is valid
};
`,KW=[dP,XW,`
CenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {
  CenterOrientEllipse r;
  float a11 = p.A;
  float a12 = p.B / 2.0;
  float a22 = p.C;
  float b1 = p.D;
  float b2 = p.E;
  float c = p.F;
  float kdenom = 2.0 * (a12 * a12 - a11 * a22);
  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;
  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;
  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);
  float m11 = mu * a11;
  float m12 = mu * a12;
  float m22 = mu * a22;
  float lambdaTerm1 = m11 + m22;
  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);
  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);
  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);
  r.a = 1.0 / sqrt(lambda1);
  r.b = 1.0 / sqrt(lambda2);
  r.valid = lambda1 > 0.0 && lambda2 > 0.0;
  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {
    r.u1 = vec2(1.0, 0.0);
  } else if (m11 >= m22) {
    r.u1 = normalize(vec2(lambda1 - m22, m12));
  } else {
    r.u1 = normalize(vec2(m12, lambda1 - m11));
  }
  r.u2 = vec2(-r.u1.y, r.u1.x);
  return r;
}
`],Ak=Je();let uP=class extends xc{defineShader(i){const e=this.rank;bc(i,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",e,2),i.addVertexCode(`
struct SubspaceParams {
  highp vec3 subspaceCenter;
  highp vec3 subspaceRadii;
  highp float clipCoefficient;
  bool cull;
};
SubspaceParams getSubspaceParams() {
  SubspaceParams params;
  highp float modelCenter[${e}] = getCenterAndRadii0();
  highp float modelRadii[${e}] = getCenterAndRadii1();
  float radiusAdjustment = 1.0;
  float clipCoefficient = 1.0;
  for (int i = 0; i < ${e}; ++i) {
    float r = modelRadii[i];
    float c = modelCenter[i];
    float x = uModelClipBounds[i];
    float clipRadius = uModelClipBounds[i + ${e}];
    if (r != 0.0 && clipRadius != 0.0) {
      float d = c - x;
      d = d * d;
      radiusAdjustment -= d / (r * r);
    }
    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;
    clipCoefficient *= max(0.0, 1.0 - e);
  }
  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));
  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);
  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;
  params.clipCoefficient = clipCoefficient;
  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;
  return params;
}
void setEllipsoidFillColor(vec4 color) {
  vColor = color;
}
`)}enable(i,e,t){super.enable(i,e,n=>{const r=n.vertexShaderInputBinders.CenterAndRadii;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer),r.bind(this.geometryDataStride,e.bufferOffset),t(n),r.disable()})}};class YW extends uP{constructor(){super(...arguments),this.sphereRenderHelper=this.registerDisposer(new FT(this.gl,10,10)),this.shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
${this.invokeUserMain}
emitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));
`)}),this.tempLightVec=new Float32Array(4)}draw(e){this.enable(this.shaderGetter,e,t=>{const n=t.gl;let r=this.tempLightVec;var s=e.renderContext;let a=s.lightDirection,l=s.ambientLighting,d=s.directionalLighting;nv(r,a,d),r[3]=l,n.uniform4fv(t.uniform("uLightDirection"),r),n.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,iv(Je(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)})}}class ZW extends uP{constructor(){super(...arguments),this.shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",e=>{Mr(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(JW),e.addVertexCode(KW),e.addVertexCode(sy),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
mat3 Aobject = mat3(0.0);
for (int i = 0; i < 3; ++i) {
  float r = max(params.subspaceRadii[i], 1e-3);
  Aobject[i][i] = 1.0 / (r * r);
}
mat3 RviewportToObject = mat3(uViewportToObject);
mat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;
vec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;
EllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);
vec2 u1, u2;
float a, b;
CenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);
vec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
vec2 viewportCorner = centerOrient.k +
  centerOrient.u1 * cornerOffset.x * centerOrient.a +
  centerOrient.u2 * cornerOffset.y * centerOrient.b;
if (centerOrient.valid) {
  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);
} else {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
}
vCircleCoord = cornerOffset;
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
if (dot(vCircleCoord, vCircleCoord) > 1.0) {
  discard;
}
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)}),this.vertexIdHelper=this.registerDisposer(rr.get(this.gl))}draw(e){this.enable(this.shaderGetter,e,t=>{const n=t.gl,r=e.renderContext.sliceView.projectionParameters.value,s=ei(Ak,e.renderSubspaceInvModelMatrix,r.invViewMatrix);n.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,s),n.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,r.projectionMat);const a=Ak;fs(a,s),n.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,a);const l=this.vertexIdHelper;l.enable(),ay(n,1,e.count),l.disable()})}}kc(Ie.ELLIPSOID,{sliceViewRenderHelper:ZW,perspectiveViewRenderHelper:YW,defineShaderNoOpSetters(i){i.addVertexCode(`
void setEllipsoidFillColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(i,e){i.set(e.center)},updateViaRepresentativePoint(i,e){return H(H({},i),{center:new Float32Array(e)})}});const Ja=0,gm=Ja+1,QW=gm+2;function mm(i){i.addVertexCode(`
 void setAxisEndpointMarkerSize(float startSize, float endSize) {}
 void setAxisEndpointMarkerBorderWidth(float startSize, float endSize) {}
 void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
 void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
 `)}function vm(i){i.addVertexCode(`
 void setAxisWidth(float width) {}
 void setAxisColor(vec4 startColor, vec4 endColor) {}
 `)}function ym(i){i.addVertexCode(`
 void setSphereColor(vec4 color) {}
 `)}class Nk extends xc{constructor(){super(...arguments),this.sphereShader=this.registerDisposer(new zU(this.gl)),this.vertexIdHelper=this.registerDisposer(rr.get(this.gl)),this.edgeShaderGetter=this.getDependentShader("annotation/sphere/axis",e=>{const t=this.rank;this.defineShader(e),tr(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),mm(e),ym(e),e.addVertexCode(`
void setAxisWidth(float width) {
  ng_LineWidth = width;
}
void setAxisColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)}),this.endpointShaderGetter=this.getDependentShader("annotation/sphere/endpoint",e=>{const t=this.rank;this.defineShader(e),Nc(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),vm(e),ym(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${oy};
}
void setAxisEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setAxisEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)}),this.sphereShadeGetter=this.getDependentShader("annotation/sphere/sphere",e=>{const t=this.rank;this.defineShader(e),this.sphereShader.defineShader(e),e.addVarying("highp float","vClipCoefficient"),vm(e),mm(e),e.addVertexCode(`
 void setSphereColor(vec4 color) {
   vColor = color;
 }
 `),e.setVertexMain(`
 float modelPosition[${t}] = getVertexPosition0();
 float modelPositionB[${t}] = getVertexPosition1();
 float diameter = 0.0;
 for (int i = 0; i < ${t}; ++i) {
   float dx = modelPosition[i] - modelPositionB[i];
   diameter += dx * dx;
   modelPosition[i] = (modelPosition[i] + modelPositionB[i]) * 0.5;
 }
 float radius = sqrt(diameter) * 0.5;
 if (radius > 0.0) {
   vClipCoefficient = getRadiusAdjustment(vec3(modelPosition[0], modelPosition[1], modelPosition[2]), radius);
 } else {
   vClipCoefficient = 1.0;
 }

 // vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
 vColor = vec4(1.0, 0.0, 0.0, 0.5);
 // vColor = vec4(defaultColor(), 0.5);
 ${this.invokeUserMain}
 // float radius = diameter * 0.5;
 emitSphere(uModelViewProjection, uNormalTransform, projectModelVectorToSubspace(modelPosition), vec3(radius, radius, radius), uLightDirection);
 ${this.setPartIndex(e)};
 `),e.setFragmentMain(`
     vec4 color = vColor;
     color.a *= vClipCoefficient;
     emitAnnotation(color);
 `)})}defineShader(e){Mr(e);const t=this.rank;bc(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,n,r=!0){super.enable(e,t,s=>{const a=s.vertexShaderInputBinders.VertexPosition;a.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),a.bind(this.serializedBytesPerAnnotation,t.bufferOffset);const l=this.vertexIdHelper;r&&l.enable(),n(s),r&&l.disable(),a.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{nr(t,e.renderContext.projectionParameters,1),ir(t.gl,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{Vc(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),Oc(t.gl,2,e.count)})}drawSphere(e){this.enable(this.sphereShadeGetter,e,t=>{this.sphereShader.draw(t,e,e.count)},!1)}draw(e){this.drawEdges(e),this.drawEndpoints(e),this.drawSphere(e)}}function e6(i,e){const t=i.length;lL(i,e.subarray(0,t),e.subarray(t),i)}function t6(i,e,t){const n=i.length,r=n*t;for(let s=0;s<n;++s)i[s]=e[r+s]}kc(Ie.SPHERE,{sliceViewRenderHelper:Nk,perspectiveViewRenderHelper:Nk,defineShaderNoOpSetters(i){mm(i),vm(i),ym(i)},pickIdsPerInstance:QW,snapPosition(i,e,t,n){const r=i.length,s=new Float32Array(e,t,r*2);n===Ja?e6(i,s):t6(i,s,n-gm)},getRepresentativePoint(i,e,t){i.set(t===Ja||t===gm?e.pointA:e.pointB)},updateViaRepresentativePoint(i,e,t){let n=H({},i);const r=e.length;switch(t){case Ja:{const s=i.pointA,a=i.pointB,l=new Float32Array(r),d=new Float32Array(r);for(let u=0;u<r;++u){const h=l[u]=e[u];d[u]=a[u]+(h-s[u])}return H(H({},i),{pointA:l,pointB:d})}case Ja+1:return H(H({},i),{pointA:new Float32Array(e)});case Ja+2:return H(H({},i),{pointB:new Float32Array(e)})}return n}});/**
* @license
* Copyright 2020 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const hP=Je(),pP=Ne();function fP(i){i.addUniform("highp vec3","uTranslation"),i.addUniform("highp mat4","uProjectionMatrix"),i.addUniform("highp vec3","uChunkDataSize"),i.addUniform("highp vec3","uLowerClipBound"),i.addUniform("highp vec3","uUpperClipBound"),i.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);
`)}const i6={defineShader(i){fP(i),tr(i),i.addVertexCode(`
const vec3[24] boxCornerOffsets = vec3[](
  vec3(0, 0, 0), vec3(0, 0, 1),  // e1
  vec3(1, 0, 0), vec3(1, 0, 1),  // e2
  vec3(0, 1, 0), vec3(0, 1, 1),  // e3
  vec3(1, 1, 0), vec3(1, 1, 1),  // e4
  vec3(0, 0, 0), vec3(0, 1, 0),  // e5
  vec3(0, 0, 1), vec3(0, 1, 1),  // e6
  vec3(1, 0, 0), vec3(1, 1, 0),  // e7
  vec3(1, 0, 1), vec3(1, 1, 1),  // e8
  vec3(0, 0, 0), vec3(1, 0, 0),  // e9
  vec3(0, 0, 1), vec3(1, 0, 1),  // e10
  vec3(0, 1, 0), vec3(1, 1, 0),  // e11
  vec3(0, 1, 1), vec3(1, 1, 1)  // e12
);
`),i.setVertexMain(`
int edgeIndex = gl_VertexID / ${us};
vec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));
vec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));
vec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);
vec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(i,e){nr(i,e,1)},draw(i,e,t){const n=i.gl,r=hP,s=e.chunkLayout;ei(r,t.viewProjectionMat,s.transform),n.uniformMatrix4fv(i.uniform("uProjectionMatrix"),!1,r),n.uniform3fv(i.uniform("uChunkDataSize"),s.size),n.uniform3fv(i.uniform("uLowerClipBound"),e.lowerClipDisplayBound),n.uniform3fv(i.uniform("uUpperClipBound"),e.upperClipDisplayBound);const a=s.size,l=e.curPositionInChunks,d=e.chunkDisplayDimensionIndices,u=pP;for(let h=0;h<3;++h){const g=d[h];u[h]=(g===-1?0:l[g])*a[h]}n.uniform3fv(i.uniform("uTranslation"),u),ir(n,ky,1)}},n6={defineShader(i){Mu(i),fP(i),tr(i),i.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${us};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(i,e){nr(i,e,1)},draw(i,e,t){const n=i.gl,r=hP,s=e.chunkLayout;ei(r,t.viewProjectionMat,s.transform),n.uniformMatrix4fv(i.uniform("uProjectionMatrix"),!1,r),n.uniform3fv(i.uniform("uChunkDataSize"),s.size),n.uniform3fv(i.uniform("uLowerClipBound"),e.lowerClipDisplayBound),n.uniform3fv(i.uniform("uUpperClipBound"),e.upperClipDisplayBound);const a=s.size,l=e.curPositionInChunks,d=e.chunkDisplayDimensionIndices,u=pP;for(let h=0;h<3;++h){const g=d[h];u[h]=(g===-1?0:l[g])*a[h]}n.uniform3fv(i.uniform("uTranslation"),u),xy(i,t.viewportNormalInGlobalCoordinates,t.centerDataPosition,s.transform,s.invTransform),ir(n,6,1)}};/**
* @license
* Copyright 2018 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var r6=function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=An(e,t):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(a=i[l])&&(s=(r<3?a(s):r>3?a(e,t,s):a(e,t))||s);return r>3&&s&&Mn(e,t,s),s};const s6=Je();function a6(i){if(i!==void 0)return e=>{const t=e.relatedSegments;if(t===void 0)return!1;for(let r=0,s=t.length;r<s;++r){const a=i[r];if(a==null)continue;var n=a.segmentationGroupState.value;const l=n.visibleSegments,d=n.segmentEquivalences;for(const u of t[r])if(l.has(d.get(u)))return!0}return!1}}function o6(i,e){const t=new s3(i.annotationPropertySerializers);for(const n of i)(e===void 0||e(n))&&t.add(n);return t.serialize()}let Sm=class extends oh(Ec){constructor(i,e,t,n){super(n),this.chunkManager=i,this.source=e,this.segmentationStates=t,this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:e.rpcId,segmentationStates:this.serializeDisplayState()});const r=()=>{const s={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke(s_,s)};this.registerDisposer(t.changed.add(r))}serializeDisplayState(){const i=this.segmentationStates.value;if(i!==void 0)return i.map(e=>e==null?e:NT(e.segmentationGroupState.value))}};Sm=r6([hn(r_)],Sm);class l6 extends Y{constructor(e,t){super(),this.chunkManager=e,this.state=t,this.layerChunkProgressInfo=new bv,this.numPickIds=0,this.generation=-1,this.redrawNeeded=new be,this.serializedAnnotations=void 0,this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()},this.segmentationStates=this.registerDisposer(cn(r=>{var s=this.state;const a=s.displayState,l=s.source,d=a.relationshipStates;return a.displayUnfiltered.value?void 0:l.relationships.map(u=>{const h=d.get(u);return h.showMatches.value?h.segmentationState.value:void 0})},[this.state.displayState.relationshipStates],(r,s)=>r===void 0||s===void 0?r===s:Oe(r,s))),this.registerDisposer(t),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer(Pr((r,s)=>{if(this.handleChangeAffectingBuffer(),s!==void 0)for(const a of s)a!=null&&r.registerDisposer(ao((l,d)=>{l.registerDisposer(d.visibleSegments.changed.add(()=>this.handleChangeAffectingBuffer())),l.registerDisposer(d.segmentEquivalences.changed.add(()=>this.handleChangeAffectingBuffer()))},a.segmentationGroupState))},this.segmentationStates)),this.source instanceof lo||(this.sharedObject=this.registerDisposer(new Sm(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));const n=this.state.displayState;this.registerDisposer(n.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}get visibility(){const e=this.sharedObject;if(e!==void 0)return e.visibility}get gl(){return this.chunkManager.gl}updateBuffer(){const e=this.source;if(e instanceof lo){const t=e.changed.count;if(this.generation!==t){let n=this.buffer;n===void 0&&(n=this.buffer=this.registerDisposer(new Ui(this.chunkManager.gl))),this.generation=t;const r=this.serializedAnnotations=o6(e,a6(this.segmentationStates.value));n.setData(this.serializedAnnotations.data),this.numPickIds=j2(r)}}}}function gP(i){const e=i.chunkTransform.modelTransform.unpaddedRank,t=new Float32Array(e*2),n=new Float32Array(e*3);n.fill(0),t.fill(1,e);const r=i.numChunkDisplayDims,s=i.chunkDisplayDimensionIndices;for(let a=0;a<r;++a){const l=s[a];t[e+l]=0,n[l*3+a]=1}return{modelClipBounds:t,renderSubspaceTransform:n}}function Vk(i,e,t){t.clearMessages();const n=u=>{t.addMessage({severity:Yn.error,message:u})};if(i.error!==void 0)return n(i.error);const r=GL(i.modelTransform,e.displayDimensionIndices);let s;try{s=WL(i,r)}catch(u){return n(u.message)}var a=gP(s);const l=a.modelClipBounds,d=a.renderSubspaceTransform;return{chunkTransform:i,chunkDisplayTransform:s,modelClipBounds:l,renderSubspaceTransform:d}}function Ly(i,e){class t extends i{constructor(r,s){super(),this.base=r,this.renderScaleHistogram=s,this.curRank=-1,this.renderHelpers=[],this.isAnnotation=!0;const a=r.visibility;a!==void 0&&this.registerDisposer(a.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer(()=>{for(const l of this.renderHelpers)l.dispose()}),this.role=r.state.role,this.registerDisposer(r.redrawNeeded.add(this.redrawNeeded.dispatch)),this.handleRankChanged()}handleRankChanged(){const r=this.base.source.rank;if(r===this.curRank)return;this.curRank=r,this.tempChunkPosition=new Float32Array(r);const s=this.renderHelpers,a=this.gl;for(const u of s)u.dispose();const l=this.base.source.properties,d=this.base.state.displayState;for(const u of Tr){const h=zl(u),g=h[e],v=s[u]=new g(a,u,r,l,d.shaderControls,d.fallbackShaderControls,d.shaderError);v.pickIdsPerInstance=h.pickIdsPerInstance,v.targetIsSliceView=e==="sliceViewRenderHelper"}}attach(r){super.attach(r),this.handleRankChanged();const s=this.chunkTransform,a=r.view.displayDimensionRenderInfo.value;r.state={chunkTransform:s,displayDimensionRenderInfo:a,chunkRenderParameters:Vk(s,a,r.messages)}}updateAttachmentState(r){const s=r.state;this.handleRankChanged();const a=this.chunkTransform,l=r.view.displayDimensionRenderInfo.value;return s!==void 0&&s.chunkTransform===a&&s.displayDimensionRenderInfo===l?s.chunkRenderParameters:(s.chunkTransform=a,s.displayDimensionRenderInfo=l,s.chunkRenderParameters=Vk(a,l,r.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(r,s){const a=s.modelClipBounds,l=this.curRank,d=s.chunkTransform;Xl(a.subarray(0,l),r.projectionParameters.globalPosition,this.base.state.localPosition.value,d.layerRank,d.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(r,s,a,l=1){if(!r.bufferValid){let d=r.buffer;d===void 0&&(d=r.buffer=new Ui(this.gl));const u=r.serializedAnnotations;d.setData(u.data),r.numPickIds=j2(u),r.bufferValid=!0}this.drawGeometry(r,s,a,l)}drawGeometry(r,s,a,l=1){const d=this.base,u=a.chunkDisplayTransform,h=r.serializedAnnotations,g=h.typeToIdMaps,v=h.typeToOffset;let y=0;s.emitPickID&&(y=s.pickIDs.register(this,r.numPickIds,0,0,r));const C=d.hoverState.value,w=ei(s6,s.projectionParameters.viewProjectionMat,u.displaySubspaceModelMatrix),b={annotationLayer:d,renderContext:s,selectedIndex:0,basePickId:y,buffer:r.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:w,modelClipBounds:a.modelClipBounds,subspaceMatrix:a.renderSubspaceTransform,renderSubspaceModelMatrix:u.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:u.displaySubspaceInvModelMatrix,chunkDisplayTransform:u};for(const k of Tr){const L=g[k];let I=L.size;if(I>0){const P=zl(k);let T=4294967295;if(C!==void 0){const R=L.get(C.id);R!==void 0&&(T=R*P.pickIdsPerInstance)}I=Math.round(I*l),b.count=I,b.bufferOffset=v[k],b.selectedIndex=T,this.renderHelpers[k].draw(b),b.basePickId+=I*P.pickIdsPerInstance}}}updateMouseState(r,s,a,l){const d=l.serializedAnnotations,u=d.typeToIds,h=d.typeToOffset,g=this.curRank,v=this.chunkTransform;if(v.error===void 0)for(const y of Tr){const C=u[y],w=zl(y),b=w.pickIdsPerInstance;if(a<C.length*b){const k=Math.floor(a/b),L=C[k],I=a%b;r.pickedAnnotationId=L,r.pickedAnnotationLayer=this.base.state,r.pickedOffset=I,r.pickedAnnotationBuffer=d.data.buffer,r.pickedAnnotationType=y,r.pickedAnnotationBufferBaseOffset=d.data.byteOffset+h[y],r.pickedAnnotationIndex=k,r.pickedAnnotationCount=C.length;const P=this.tempChunkPosition,T=v.chunkToLayerTransform,R=v.combinedGlobalLocalToChunkTransform,M=v.layerRank,V=v.modelTransform.globalToRenderLayerDimensions,B=r.position;if(!Xl(P,B,this.base.state.localPosition.value,M,R))return;const F=this.base.source.annotationPropertySerializers[y];w.snapPosition(P,r.pickedAnnotationBuffer,r.pickedAnnotationBufferBaseOffset+r.pickedAnnotationIndex*F.propertyGroupBytes[0],I);const j=V.length;for(let U=0;U<j;++U){const O=V[U];if(O===-1)continue;let $=T[(g+1)*g+O];for(let _=0;_<g;++_)$+=P[_]*T[_*(M+1)+O];gt($)&&(B[U]=$)}return}a-=C.length*b}}transformPickedValue(r){const s=r.pickedAnnotationBuffer;if(s===void 0)return;const a=this.base.source.properties;if(a.length===0)return;const l=r.pickedAnnotationBufferBaseOffset,d=r.pickedAnnotationType,u=r.pickedAnnotationIndex,h=r.pickedAnnotationCount,g=this.base.source.annotationPropertySerializers,v=new Array(a.length);return g[d].deserialize(new DataView(s),l,u,h,qi.LITTLE===pc,v),qV(a[0],v[0])}isReady(){const r=this.base.source;if(!(r instanceof In))return!0;const s=this.base.segmentationStates.value;if(s===void 0)return!0;for(let a=0,l=s.length;a<l;++a){const d=s[a];if(d===null)return!1;if(d===void 0)continue;const u=r.segmentFilteredSources[a].chunks;let h=!1;if(Bo(d.segmentationGroupState.value,g=>{const v=Jn(g);u.has(v)||(h=!0)}),h)return!1}return!0}}return t}const mP=i=>class extends i{constructor(){super(...arguments),this.layerChunkProgressInfo=this.base.layerChunkProgressInfo}draw(e,t){const n=this.updateAttachmentState(t);if(this.curRank===0||n===void 0)return;this.updateModelClipBounds(e,n);const r=this.base.source;if(r instanceof lo){const s=this.base;s.updateBuffer(),this.drawGeometry(s,e,n)}else{const s=this.renderScaleHistogram;s.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(r.temporary.data,e,n);const a=this.base.segmentationStates.value;let l=0,d=0;if(a!==void 0)for(let u=0,h=a.length;u<h;++u){const g=a[u];if(g==null)continue;const v=r.segmentFilteredSources[u].chunks;Bo(g.segmentationGroupState.value,y=>{const C=Jn(y),w=v.get(C);if(w!==void 0&&w.state===pt.GPU_MEMORY){const b=w.data;if(b===void 0)return;this.drawGeometryChunkData(b,e,n),++l}else++d})}s.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,l,d)}}},vP=Ly(Uo,"perspectiveViewRenderHelper");class c6 extends mP(vP){}const yP=i=>{class e extends i{constructor(n){super(n.annotationLayer,n.renderScaleHistogram),this.wireFrameRenderHelper=this instanceof yo?n6:i6,this.wireFrameShaderGetter=ho(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof yo}`,parameters:Zs(void 0),defineShader:a=>{this.wireFrameRenderHelper.defineShader(a)}}),this.renderScaleTarget=n.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));const r=this.registerDisposer(new Ec(this.layerChunkProgressInfo)),s=this.base.chunkManager.rpc;r.RPC_TYPE_ID=i_,r.initializeCounterpart(s,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(gi.makeFromExisting(s,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(gi.makeFromExisting(s,this.renderScaleTarget)).rpcId}),this.backend=r}attach(n){super.attach(n),n.state.sources=n.registerDisposer(Pr((r,s,a)=>{const l=zv(a,s,d=>this.base.state.source.getSources(d),n.messages,this);for(const d of l)for(const u of d)r.registerDisposer(u.source),H(u,gP(u.chunkDisplayTransform));return n.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(n_,{layer:this.backend.rpcId,view:n.view.rpcId,displayDimensionRenderInfo:a,sources:Uv(l)}),this.redrawNeeded.dispatch(),l},this.base.state.transform,n.view.displayDimensionRenderInfo))}draw(n,r){const s=this.updateAttachmentState(r);if(this.curRank===0||s===void 0)return;const a=r.state.sources.value;if(a.length===0)return;this.updateModelClipBounds(n,s);const l=this.renderScaleHistogram;l.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);const d=n.projectionParameters;let u;if(n.wireFrame){var h=this.wireFrameShaderGetter(n.emitter);const g=h.shader;if(g===null)return;g.bind(),this.wireFrameRenderHelper.initialize(g,d),u=g}o_(d,this.base.state.localPosition.value,this.renderScaleTarget.value,a[0],()=>{},(g,v,y,C,w)=>{const b=g.source.chunks.get(g.curPositionInChunks.join());let k;if(b===void 0||b.state!==pt.GPU_MEMORY)k=0;else{const L=b.data;if(L===void 0)return;u!==void 0?this.wireFrameRenderHelper.draw(u,g,d):this.drawGeometryChunkData(L,n,s,y),k=1}l.add(C,w,k,1-k)})}}return e},d6=yP(vP),u6=yP(Ly(yo,"sliceViewRenderHelper")),h6=mP(Ly(yo,"sliceViewRenderHelper"));class p6 extends Y{constructor(){super(...arguments),this.changed=new be,this.isLoadingChanged=new be,this.states=[],this.relationships=[],this.loadingCount=0}get value(){return this.states}get isLoading(){return this.loadingCount!==0}markLoading(){return this.loadingCount++,()=>{--this.loadingCount===0&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort((e,t)=>{let n=e.sourceIndex-t.sourceIndex;return n!==0?n:e.subsourceIndex-t.subsourceIndex})}updateRelationships(){const e=new $e;for(const t of this.states)for(const n of t.source.relationships)e.add(n);this.relationships=Ee(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{const t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}}function f6(i,e){switch(e.type){case Ie.AXIS_ALIGNED_BOUNDING_BOX:case Ie.LINE:case Ie.SPHERE:TL(i,e.pointA,e.pointB),v3(i,i,.5);break;case Ie.POINT:i.set(e.point);break;case Ie.ELLIPSOID:i.set(e.center);break}}function SP(i,e,t){e.error===void 0&&i.setLayerPosition(e.modelTransform,t)}function bP(i,e,t){const n=e.layerRank,r=new Float32Array(n);Di[i.type].visitGeometry(i,(s,a)=>{r.set(s);const l=new Float32Array(n);(a?xL:Er)(l,e.chunkToLayerTransform,n+1,r,n),t(l,a)})}class g6 extends _r{constructor(e,t){super(),this.layer=e,this.displayState=t,this.previousSelectedState=void 0,this.previousHoverId=void 0,this.previousHoverAnnotationLayerState=void 0,this.virtualListSource={length:0,render:y=>this.render(y),changed:new Ze},this.virtualList=new ly({source:this.virtualListSource}),this.listElements=[],this.updated=!1,this.mutableControls=document.createElement("div"),this.headerRow=document.createElement("div"),this.attachedAnnotationStates=new ce,this.forceUpdateView=()=>{this.updated=!1,this.updateView()},this.globalDimensionIndices=[],this.localDimensionIndices=[],this.curCoordinateSpaceGeneration=-1,this.prevCoordinateSpaceGeneration=-1,this.columnWidths=[],this.gridTemplate="",this.selectedAnnotationState=jn((y,C)=>{var w;if(y===void 0)return;const b=this.layer,k=(w=y.layers.find(P=>P.layer===b))===null||w===void 0?void 0:w.state;if(k===void 0)return;const L=k.annotationId;if(L===void 0)return;const I=this.annotationStates.states.find(P=>P.sourceIndex===k.annotationSourceIndex&&(k.annotationSubsource===void 0||P.subsourceId===k.annotationSubsource));if(I!==void 0)return{annotationId:L,annotationLayerState:I,pin:C}},this.layer.manager.root.selectionState,this.layer.manager.root.selectionState.pin),this.element.classList.add("neuroglancer-annotation-layer-view"),this.registerDisposer(this.visibility.changed.add(()=>this.updateView())),this.registerDisposer(e.annotationStates.changed.add(()=>this.updateAttachedAnnotationLayerStates())),this.headerRow.classList.add("neuroglancer-annotation-list-header");const n=document.createElement("div");n.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this);const r=this.registerDisposer(new my(this.displayState.color));r.element.title="Change annotation display color",this.registerDisposer(new en(jn(y=>y.match(/\bdefaultColor\b/)!==null,t.shaderControls.processedFragmentMain),r.element)),n.appendChild(r.element);const s=this.mutableControls,a=ft({text:Di[Ie.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new TP(this.layer,{})}});s.appendChild(a);const l=ft({text:Di[Ie.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new Dy(this.layer,{})}});s.appendChild(l);const d=ft({text:Di[Ie.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new Py(this.layer,{})}});s.appendChild(d);const u=ft({text:Di[Ie.SPHERE].icon,title:"Annotate Sphere",onClick:()=>{this.layer.tool.value=new Iy(this.layer,{})}});s.appendChild(u);const h=ft({text:Di[Ie.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new PP(this.layer,{})}});s.appendChild(h),n.appendChild(s),this.element.appendChild(n),this.element.appendChild(this.headerRow);const g=this.virtualList;g.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(g.element),this.virtualList.element.addEventListener("mouseleave",()=>{this.displayState.hoverState.value=void 0});const v=tU();this.registerDisposer(new Br(this.virtualList.element,v)),this.virtualList.element.title=v.describe(),this.registerDisposer(this.displayState.hoverState.changed.add(()=>this.updateHoverView())),this.registerDisposer(this.selectedAnnotationState.changed.add(()=>this.updateSelectionView())),this.registerDisposer(this.layer.localCoordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}get annotationStates(){return this.layer.annotationStates}updateAttachedAnnotationLayerStates(){const e=this.annotationStates.states,t=this.attachedAnnotationStates,n=new ce;for(const s of t){var r=ae(s,2);const a=r[0],l=r[1];e.includes(a)||(t.delete(a),l.refCounted.dispose())}for(const s of e){const a=t.get(s);if(a!==void 0){n.set(s,a);continue}const l=s.source,d=new Y;(l instanceof lo||l instanceof In)&&(d.registerDisposer(l.childAdded.add(u=>this.addAnnotationElement(u,s))),d.registerDisposer(l.childUpdated.add(u=>this.updateAnnotationElement(u,s))),d.registerDisposer(l.childDeleted.add(u=>this.deleteAnnotationElement(u,s))),d.registerDisposer(l.childRefreshed.add(()=>this.clearAnnotationElement(s)))),d.registerDisposer(s.transform.changed.add(this.forceUpdateView)),n.set(s,{refCounted:d,annotations:[],idToIndex:new ce,listOffset:0})}this.attachedAnnotationStates=n,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}updateCoordinateSpace(){const e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,n=[],r=[];for(let s=0,a=t.rank;s<a;++s)this.annotationStates.states.some(l=>{const d=l.transform.value;return d.error!==void 0?!1:d.globalToRenderLayerDimensions[s]!==-1})&&n.push(s);for(let s=0,a=e.rank;s<a;++s)this.annotationStates.states.some(l=>{const d=l.transform.value;return d.error!==void 0?!1:d.localToRenderLayerDimensions[s]!==-1})&&r.push(s);(!Oe(n,this.globalDimensionIndices)||!Oe(r,this.localDimensionIndices))&&(this.localDimensionIndices=r,this.globalDimensionIndices=n,++this.curCoordinateSpaceGeneration)}getRenderedAnnotationListElement(e,t,n=!1){const r=this.attachedAnnotationStates.get(e);if(r==null)return;const s=r.idToIndex.get(t);if(s===void 0)return;const a=r.listOffset+s;return n&&this.virtualList.scrollItemIntoView(s),this.virtualList.getItemElement(a)}clearSelectionClass(){const e=this.previousSelectedState;if(e===void 0)return;this.previousSelectedState=void 0;const t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);t!==void 0&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){const e=this.previousHoverId,t=this.previousHoverAnnotationLayerState;if(t!==void 0){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;const n=this.getRenderedAnnotationListElement(t,e);n!==void 0&&n.classList.remove("neuroglancer-annotation-hover")}}updateSelectionView(){const e=this.selectedAnnotationState.value,t=this.previousSelectedState;if(t===e||t!==void 0&&e!==void 0&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin||(this.clearSelectionClass(),this.previousSelectedState=e,e===void 0))return;const n=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);n!==void 0&&n.classList.add("neuroglancer-annotation-selected")}updateHoverView(){const e=this.displayState.hoverState.value;let t,n;e!==void 0&&(t=e.id,n=e.annotationLayerState);const r=this.previousHoverId,s=this.previousHoverAnnotationLayerState;if(t===r&&n===s||(this.clearHoverClass(),this.previousHoverId=t,this.previousHoverAnnotationLayerState=n,t===void 0))return;const a=this.getRenderedAnnotationListElement(n,t);a!==void 0&&a.classList.add("neuroglancer-annotation-hover")}render(e){var t=this.listElements[e];const n=t.annotation,r=t.state;return this.makeAnnotationListElement(n,r)}setColumnWidth(e,t){t+=2;const n=this.columnWidths;n[e]>t||(n[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`))}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;const s=this.columnWidths;s.length=0;const a=this.headerRow,l=document.createElement("div");l.style.gridColumn="symbol";const d=document.createElement("div");d.style.gridColumn="delete",Ke(a),a.appendChild(l);let u=0,h="[symbol] 2ch";const g=(C,w)=>{const b=document.createElement("div");b.classList.add("neuroglancer-annotations-view-dimension");const k=document.createElement("span");k.classList.add("neuroglancer-annotations-view-dimension-name"),k.textContent=C.names[w];const L=document.createElement("scale");L.classList.add("neuroglancer-annotations-view-dimension-scale"),L.textContent=Qs(C.scales[w],C.units[w],{precision:2}),b.appendChild(k),b.appendChild(L),b.style.gridColumn=`dim ${u+1}`,this.setColumnWidth(u,L.textContent.length+k.textContent.length+3),h+=` [dim] var(--neuroglancer-column-${u}-width)`,++u,a.appendChild(b)},v=this.layer.manager.root.coordinateSpace.value;for(const C of this.globalDimensionIndices)g(v,C);const y=this.layer.localCoordinateSpace.value;for(const C of this.localDimensionIndices)g(y,C);a.appendChild(d),h+=" [delete] 2ch",this.gridTemplate=h,a.style.gridTemplateColumns=h,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1;const t=this.listElements;t.length=0;for(const s of this.attachedAnnotationStates){var n=ae(s,2);const a=n[0],l=n[1];if(a.source.readonly||(e=!0),a.chunkTransform.value.error!==void 0)continue;const d=a.source,u=Ee(d);l.annotations=u;const h=l.idToIndex;h.clear();for(let g=0,v=u.length;g<v;++g)h.set(u[g].id,g);for(const g of u)t.push({state:a,annotation:g})}const r=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:r,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(const t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}clearAnnotationElement(e){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const t=this.attachedAnnotationStates.get(e);if(t!==void 0){const n=t.annotations.length;t.annotations=[],t.idToIndex.clear(),this.listElements=[],this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:n,insertCount:0}])}this.resetOnUpdate()}addAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const n=this.attachedAnnotationStates.get(t);if(n!==void 0){const r=n.annotations.length;n.annotations.push(e),n.idToIndex.set(e.id,r);const s=n.listOffset+r;this.listElements.splice(s,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:s,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const n=this.attachedAnnotationStates.get(t);if(n!==void 0){const r=n.idToIndex.get(e.id);if(r!==void 0){const s=n.listOffset+r;n.annotations[r]=e,this.listElements[s].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:s,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const n=this.attachedAnnotationStates.get(t);if(n!==void 0){const r=n.idToIndex,s=r.get(e);if(s!==void 0){const a=n.listOffset+s,l=n.annotations;l.splice(s,1),r.delete(e);for(let d=s,u=l.length;d<u;++d)r.set(l[d].id,d);this.listElements.splice(a,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:a,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}makeAnnotationListElement(e,t){const n=t.chunkTransform.value,r=document.createElement("div");r.classList.add("neuroglancer-annotation-list-entry"),r.style.gridTemplateColumns=this.gridTemplate;const s=document.createElement("div");s.className="neuroglancer-annotation-icon",s.textContent=Di[e.type].icon,r.appendChild(s);let a;const l=()=>{t.source.readonly||a===void 0&&(a=hs({title:"Delete annotation",onClick:h=>{h.stopPropagation(),h.preventDefault();const g=t.source.getReference(e.id);try{t.source.delete(g)}finally{g.dispose()}}}),a.classList.add("neuroglancer-annotation-list-entry-delete"),r.appendChild(a))};let d=0;if(bP(e,n,(h,g)=>{++d;const v=document.createElement("div");v.className="neuroglancer-annotation-position",r.appendChild(v);let y=0;const C=(w,b)=>{for(const k of w){const L=b[k];if(L!==-1){const I=Math.floor(h[L]),P=document.createElement("div"),T=I.toString();P.textContent=T,P.classList.add("neuroglancer-annotation-coordinate"),P.style.gridColumn=`dim ${y+1}`,this.setColumnWidth(y,T.length),v.appendChild(P)}++y}};C(this.globalDimensionIndices,n.modelTransform.globalToRenderLayerDimensions),C(this.localDimensionIndices,n.modelTransform.localToRenderLayerDimensions),l()}),e.description){++d;const h=document.createElement("div");h.classList.add("neuroglancer-annotation-description"),h.textContent=e.description,r.appendChild(h)}s.style.gridRow=`span ${d}`,a!==void 0&&(a.style.gridRow=`span ${d}`),r.addEventListener("mouseenter",()=>{this.displayState.hoverState.value={id:e.id,partIndex:0,annotationLayerState:t},this.layer.selectAnnotation(t,e.id,!1)}),r.addEventListener("action:select-position",h=>{h.stopPropagation(),this.layer.selectAnnotation(t,e.id,"toggle")}),r.addEventListener("action:pin-annotation",h=>{h.stopPropagation(),this.layer.selectAnnotation(t,e.id,!0)}),r.addEventListener("action:move-to-annotation",h=>{h.stopPropagation(),h.preventDefault();const g=n.layerRank,v=new Float32Array(g),y=new Float32Array(g);f6(v,e),Er(y,n.chunkToLayerTransform,g+1,v,g),SP(this.layer,n,y)});const u=this.selectedAnnotationState.value;return u!==void 0&&u.annotationLayerState===t&&u.annotationId===e.id&&r.classList.add("neuroglancer-annotation-selected"),r}}class m6 extends _r{constructor(e){super(),this.layer=e,this.layerView=this.registerDisposer(new g6(this.layer,this.layer.annotationDisplayState));const t=this.element;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}}function Po(i){let e=[];const t=i.source.relationships,n=i.displayState.relationshipStates;for(let r=0,s=t.length;r<s;++r){const a=n.get(t[r]).segmentationState.value;if(a!=null&&a.segmentSelectionState.hasSelectedSegment){e[r]=[a.segmentSelectionState.selectedSegment.clone()];continue}e[r]=[]}return e}class wP extends XT{constructor(e,t){super(e)}get annotationLayer(){for(const e of this.layer.annotationStates.states)if(!e.source.readonly)return e}}const CP="annotatePoint",xP="annotateLine",kP="annotateBoundingBox",EP="annotateEllipsoid",LP="annotateSphere";class TP extends wP{constructor(){super(...arguments),this.sourceSignalUpdated=!1}trigger(e){const t=this.annotationLayer;if(t!==void 0&&e.updateUnconditionally()){const n=cc(e,t);if(n===void 0)return;const r={id:"",description:"",relatedSegments:Po(t),point:n,type:Ie.POINT,properties:t.source.properties.map(a=>a.default)},s=t.source.add(r,!0);t.source instanceof In?this.sourceSignalUpdated||(t.source.childAdded.add(a=>{a.source===void 0&&this.layer.selectAnnotation(t,a.id,!0,!ps.expectingExternalUI)}),this.sourceSignalUpdated=!0):this.layer.selectAnnotation(t,s.id,!0),s.dispose()}}get description(){return"annotate point"}toJSON(){return CP}}function cc(i,e){const t=e.chunkTransform.value;if(t.error!==void 0)return;const n=new Float32Array(t.modelTransform.unpaddedRank);if(Xl(n,i.unsnappedPosition,e.localPosition.value,t.layerRank,t.combinedGlobalLocalToChunkTransform))return n}class DP extends wP{trigger(e){const t=this.annotationLayer;if(t!==void 0&&e.updateUnconditionally()){const n=()=>{const r=this.inProgressAnnotation,s=r.reference,a=this.getUpdatedAnnotation(s.value,e,t);re(kg(a,t.source))!==re(kg(s.value,t.source))&&(r.annotationLayer.source.update(s,a),this.layer.selectAnnotation(t,s.id,!0,!ps.expectingExternalUI))};if(this.inProgressAnnotation===void 0){const r=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,r.id,!0,!ps.expectingExternalUI);const s=e.changed.add(n),a=()=>{s(),r.dispose()};this.inProgressAnnotation={annotationLayer:t,reference:r,disposer:a}}else n(),this.inProgressAnnotation.annotationLayer.source.commit(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0}}disposed(){this.deactivate(),super.disposed()}deactivate(){this.inProgressAnnotation!==void 0&&(this.inProgressAnnotation.annotationLayer.source.delete(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0)}}class Ty extends DP{getInitialAnnotation(e,t){const n=cc(e,t);return{id:"",type:this.annotationType,description:"",pointA:n,pointB:n,properties:t.source.properties.map(r=>r.default)}}getUpdatedAnnotation(e,t,n){const r=cc(t,n);return r===void 0?e:H(H({},e),{pointB:r})}}class Dy extends Ty{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,n){const r=super.getUpdatedAnnotation(e,t,n),s=r.pointA,a=r.pointB,l=s.length;for(let d=0;d<l;++d)s[d]===a[d]&&(a[d]+=1);return r}toJSON(){return kP}}Dy.prototype.annotationType=Ie.AXIS_ALIGNED_BOUNDING_BOX;class Py extends Ty{get description(){return"annotate line"}getInitialAnnotation(e,t){const n=super.getInitialAnnotation(e,t);return this.initialRelationships=n.relatedSegments=Po(t),n}getUpdatedAnnotation(e,t,n){const r=super.getUpdatedAnnotation(e,t,n),s=this.initialRelationships,a=Po(n);return s===void 0?r.relatedSegments=a:r.relatedSegments=Ee(a,(l,d)=>{const u=s[d];return l=l.filter(h=>u.findIndex(g=>te.equal(h,g))===-1),[...u,...l]}),r}toJSON(){return xP}}Py.prototype.annotationType=Ie.LINE;class Iy extends Ty{get description(){return"annotate sphere"}getInitialAnnotation(e,t){const n=super.getInitialAnnotation(e,t);return this.initialRelationships=n.relatedSegments=Po(t),n}getUpdatedAnnotation(e,t,n){const r=super.getUpdatedAnnotation(e,t,n),s=this.initialRelationships,a=Po(n);return s===void 0?r.relatedSegments=a:r.relatedSegments=Ee(a,(l,d)=>{const u=s[d];return l=l.filter(h=>u.findIndex(g=>te.equal(h,g))===-1),[...u,...l]}),r}toJSON(){return LP}}Iy.prototype.annotationType=Ie.SPHERE;class PP extends DP{getInitialAnnotation(e,t){const n=cc(e,t);return{type:Ie.ELLIPSOID,id:"",description:"",segments:Po(t),center:n,radii:lt(0,0,0),properties:t.source.properties.map(r=>r.default)}}getUpdatedAnnotation(e,t,n){const r=cc(t,n);if(r===void 0)return e;const s=e.center,a=s.length;for(let l=0;l<a;++l)r[l]=Math.abs(s[l]-r[l]);return H(H({},e),{radii:r})}get description(){return"annotate ellipsoid"}toJSON(){return EP}}_c(CP,(i,e)=>new TP(i,e));_c(kP,(i,e)=>new Dy(i,e));_c(xP,(i,e)=>new Py(i,e));_c(EP,(i,e)=>new PP(i,e));_c(LP,(i,e)=>new Iy(i,e));const v6=at.fromObject({enter:{action:"commit"},escape:{action:"cancel"}});function y6(i,e,t,n){return new Qn(t,(r,s,a)=>{const l=document.createElement("div");l.classList.add("neuroglancer-related-segment-list"),r!=null&&a.registerDisposer(sc(r,l));const d=document.createElement("div");d.classList.add("neuroglancer-related-segment-list-header");const u=Zn({title:"Copy segment IDs",onClick:()=>{Ji(e.map(C=>C.toString()).join(", "))}});d.appendChild(u);let h;if(r!=null&&(h=document.createElement("input"),h.type="checkbox",h.addEventListener("change",()=>{const C=r.segmentationGroupState.value.visibleSegments,w=e.some(b=>!C.has(b));for(const b of e)C.set(b,w)}),d.appendChild(h)),n!==void 0){const C=hs({title:"Remove all IDs",onClick:()=>{n([])}});d.appendChild(C)}const g=document.createElement("span");if(g.classList.add("neuroglancer-related-segment-list-title"),g.textContent=i,d.appendChild(g),n!==void 0){const C=HT({title:"Add related segment ID",onClick:()=>{const w=new Y,b=a.registerDisposer(jE(w)),k=document.createElement("div");k.classList.add("neuroglancer-segment-list-entry"),k.classList.add("neuroglancer-segment-list-entry-new");const L=Zn({});if(L.classList.add("neuroglancer-segment-list-entry-copy"),k.appendChild(L),r!=null){const M=document.createElement("input");M.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),M.type="checkbox",k.appendChild(M)}const I=hs({title:"Cancel adding new segment ID",onClick:()=>{b()}});I.classList.add("neuroglancer-segment-list-entry-delete"),k.appendChild(I);const P=document.createElement("input");P.autocomplete="off",P.spellcheck=!1,P.classList.add("neuroglancer-segment-list-entry-id");const T=w.registerDisposer(new Nn(P,v6));T.allShortcutsAreGlobal=!0;const R=()=>{const M=new te;if(M.tryParseString(P.value))return P.dataset.valid="true",M;P.dataset.valid="false"};R(),P.addEventListener("input",()=>{R()}),P.addEventListener("blur",()=>{const M=R();M!==void 0&&n([...e,M]),b()}),ve(P,"cancel",b),ve(P,"commit",()=>{const M=R();M!==void 0&&n([...e,M]),b()}),k.appendChild(P),l.appendChild(k),P.focus(),w.registerDisposer(()=>{P.value="",k.remove()})}});d.appendChild(C)}l.appendChild(d);const v=[],y=Rc.make(r??void 0,!1);for(const C of e){const w=y.get(C);if(v.push(w),n!==void 0){const b=hs({title:"Remove ID",onClick:k=>{n(e.filter(L=>!te.equal(L,C))),k.stopPropagation()}});b.classList.add("neuroglancer-segment-list-entry-delete"),w.children[0].appendChild(b)}l.appendChild(w)}if(r!=null){const C=a.registerCancellable(dt(()=>{const w=r.segmentationGroupState.value.visibleSegments;let b=0;for(const k of e)w.has(k)&&++b;for(const k of v)y.update(k);h.checked=b===e.length&&b>0,h.indeterminate=b>0&&b<e.length}));C(),C.flush(),Mc(r,a,C),a.registerDisposer(r.segmentationGroupState.changed.add(C))}s.appendChild(l)})}const Ok="annotationColor";function Ry(i){class e extends i{constructor(...n){super(...n),this.annotationStates=this.registerDisposer(new p6),this.annotationDisplayState=new AB,this.annotationCrossSectionRenderScaleHistogram=new vo,this.annotationCrossSectionRenderScaleTarget=ta(8),this.annotationProjectionRenderScaleHistogram=new vo,this.annotationProjectionRenderScaleTarget=ta(8),this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new m6(this)});let r;const s=()=>{const l=this.isReady;l&&r!==void 0?(r(),r=void 0):!l&&r===void 0&&(r=this.annotationStates.markLoading())};this.readyStateChanged.add(s),s();const a=this.manager.layerSelectedValues.mouseState;this.registerDisposer(a.changed.add(()=>{if(a.active){const l=a.pickedAnnotationLayer;if(l!==void 0&&this.annotationStates.states.includes(l)){const d=this.annotationDisplayState.hoverState.value;(d===void 0||d.id!==a.pickedAnnotationId||d.partIndex!==a.pickedOffset||d.annotationLayerState!==l)&&(this.annotationDisplayState.hoverState.value={id:a.pickedAnnotationId,partIndex:a.pickedOffset,annotationLayerState:l});return}}this.annotationDisplayState.hoverState.value=void 0}))}initializeAnnotationLayerViewTab(n){}restoreState(n){super.restoreState(n),this.annotationDisplayState.color.restoreState(n[Ok])}captureSelectionState(n,r){super.captureSelectionState(n,r);const s=r.pickedAnnotationLayer;s===void 0||!this.annotationStates.states.includes(s)||(n.annotationId=r.pickedAnnotationId,n.annotationType=r.pickedAnnotationType,n.annotationBuffer=new Uint8Array(r.pickedAnnotationBuffer,r.pickedAnnotationBufferBaseOffset),n.annotationIndex=r.pickedAnnotationIndex,n.annotationCount=r.pickedAnnotationCount,n.annotationPartIndex=r.pickedOffset,n.annotationSourceIndex=s.sourceIndex,n.annotationSubsource=s.subsourceId)}displayAnnotationState(n,r,s){if(n.annotationId===void 0)return!1;const a=this.annotationStates.states.find(d=>d.sourceIndex===n.annotationSourceIndex&&(n.annotationSubsource===void 0||d.subsourceId===n.annotationSubsource));if(a===void 0)return!1;a.source instanceof In;const l=s.registerDisposer(a.source.getReference(n.annotationId));return r.appendChild(s.registerDisposer(new Qn(s.registerDisposer(new KE(()=>({annotation:l,chunkTransform:a.chunkTransform}))),({annotation:d,chunkTransform:u},h,g)=>{let v;if(d==null)if(n.annotationType!==void 0&&n.annotationBuffer!==void 0){const w=Di[n.annotationType],b=a.source.rank,k=w.serializedBytes(b),L=n.annotationBuffer.byteOffset,I=new DataView(n.annotationBuffer.buffer),P=qi.LITTLE===pc,T=a.source.properties,R=new bL(b,k,T),M=n.annotationIndex,V=n.annotationCount;d=w.deserialize(I,L+R.propertyGroupBytes[0]*M,P,b,n.annotationId),R.deserialize(I,L,M,V,P,d.properties=new Array(T.length)),a.source.hasNonSerializedProperties()&&(v="Loading...")}else v=d===null?"Annotation not found":"Loading...";if(d!=null){const w=u.error===void 0?u.layerRank:0,b=document.createElement("div");b.classList.add("neuroglancer-selected-annotation-details-position-grid"),b.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${w}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,h.appendChild(b);const k=Di[d.type],L=document.createElement("div");if(L.className="neuroglancer-selected-annotation-details-icon",L.textContent=k.icon,b.appendChild(L),w!==0){const B=u.modelTransform.layerDimensionNames;for(let F=0;F<w;++F){const j=document.createElement("div");j.classList.add("neuroglancer-selected-annotation-details-position-dim"),j.textContent=B[F],j.style.gridColumn=`dim ${F+1}`,b.appendChild(j)}bP(d,u,(F,j)=>{const U=Zn({title:"Copy position",onClick:()=>{Ji(F.map(O=>Math.floor(O)).join(", "))}});U.style.gridColumn="copy",b.appendChild(U);for(let O=0;O<w;++O){const $=document.createElement("div");$.classList.add("neuroglancer-selected-annotation-details-position-coord"),$.style.gridColumn=`coord ${O+1}`,$.textContent=Math.floor(F[O]).toString(),b.appendChild($)}if(!j){const O=PT({title:"Move to position",onClick:()=>{SP(this,u,F)}});O.style.gridColumn="move",b.appendChild(O)}})}if(!a.source.readonly){const B=hs({title:"Delete annotation",onClick:()=>{a.source.delete(l)}});B.classList.add("neuroglancer-selected-annotation-details-delete"),b.appendChild(B)}var y=a.source;const I=y.relationships,P=y.properties,T=a.source.readonly;for(let B=0,F=P.length;B<F;++B){const j=P[B],U=document.createElement("label");U.classList.add("neuroglancer-annotation-property");const O=document.createElement("span");O.classList.add("neuroglancer-annotation-property-label"),O.textContent=j.identifier,U.appendChild(O);const $=j.description;$!==void 0&&(U.title=$);const _=d.properties[B],se=document.createElement("span");switch(se.classList.add("neuroglancer-annotation-property-value"),j.type){case"rgb":{const oe=eo(_),Re=Ii(oe);se.textContent=Re,se.style.backgroundColor=Re,se.style.color=yg(oe)?"white":"black";break}case"rgba":{const oe=eo(_);se.textContent=Ii(sv(_)),se.style.backgroundColor=Ii(eo(_)),se.style.color=yg(oe)?"white":"black";break}default:se.textContent=wL(j,_);break}U.appendChild(se),h.appendChild(U)}var C=d;const R=C.relatedSegments;for(let B=0,F=I.length;B<F;++B){const j=R===void 0?[]:R[B];if(j.length===0&&T)continue;const U=B,O=I[B];h.appendChild(g.registerDisposer(y6(O,j,a.displayState.relationshipStates.get(O).segmentationState,T?void 0:$=>{const _=l.value;if(_==null)return;let se=_.relatedSegments;se===void 0?se=a.source.relationships.map(()=>[]):se=se.slice(),se[U]=$;const oe=H(H({},_),{relatedSegments:se});a.source.update(l,oe),a.source.commit(l)})).element)}let M=null,V=a.source;if(V instanceof In&&V.makeEditWidget&&(M=V.makeEditWidget(l),M&&(M.className="neuroglancer-annotation-details-description",h.appendChild(M))),(!a.source.readonly||d.description)&&M===null)if(a.source.readonly){const B=document.createElement("div");B.className="neuroglancer-annotation-details-description",B.textContent=d.description||"",h.appendChild(B)}else{const B=document.createElement("textarea");B.value=d.description||"",B.rows=3,B.className="neuroglancer-annotation-details-description",B.placeholder="Description",B.addEventListener("change",()=>{const F=B.value;a.source.update(l,H(H({},d),{description:F||void 0})),a.source.commit(l)}),h.appendChild(B)}}if(v!==void 0){const w=document.createElement("div");w.classList.add("neuroglancer-selection-annotation-status"),w.textContent=v,h.appendChild(w)}})).element),!0}displaySelectionState(n,r,s){let a=this.displayAnnotationState(n,r,s);return super.displaySelectionState(n,r,s)&&(a=!0),a}addLocalAnnotations(n,r,s){const a=n.subsourceEntry,l=new Ag({localPosition:this.localPosition,transform:n.getRenderLayerTransform(),source:r,displayState:this.annotationDisplayState,dataSource:n.loadedDataSource.layerDataSource,subsourceIndex:n.subsourceIndex,subsourceId:a.id,role:s});this.addAnnotationLayerState(l,n)}addStaticAnnotations(n){const r=n.subsourceEntry.subsource.staticAnnotations;return r===void 0?!1:(n.activate(()=>{this.addLocalAnnotations(n,r,un.DEFAULT_ANNOTATION)}),!0)}addAnnotationLayerState(n,r){const s=r.activated;s.registerDisposer(this.annotationStates.add(n));const a=new l6(this.manager.chunkManager,n.addRef());if(a.source instanceof In){const l=new u6({annotationLayer:a.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});s.registerDisposer(r.messages.addChild(l.messages));const d=new d6({annotationLayer:a.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});s.registerDisposer(r.messages.addChild(d.messages)),s.registerDisposer(Pr((u,h)=>{h&&(u.registerDisposer(this.addRenderLayer(l.addRef())),u.registerDisposer(this.addRenderLayer(d.addRef())))},this.annotationDisplayState.displayUnfiltered))}{const l=new h6(a,this.annotationCrossSectionRenderScaleHistogram);s.registerDisposer(this.addRenderLayer(l)),s.registerDisposer(r.messages.addChild(l.messages))}{const l=new c6(a.addRef(),this.annotationProjectionRenderScaleHistogram);s.registerDisposer(this.addRenderLayer(l)),s.registerDisposer(r.messages.addChild(l.messages))}}selectAnnotation(n,r,s,a=!0){this.manager.root.selectionState.captureSingleLayerState(this,l=>(l.annotationId=r,l.annotationSourceIndex=n.sourceIndex,l.annotationSubsource=n.subsourceId,!0),s,a)}toJSON(){const n=super.toJSON();return n[Ok]=this.annotationDisplayState.color.toJSON(),n}}return e}const Bk=at.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}});class IP extends Y{constructor(e,t,n,r){super(),this.element=e,this.dataType=t,this.getModel=n,this.setModel=r,e.title=Bk.describe(),this.registerDisposer(new Br(e,Bk)),ve(e,"set",s=>{const a=s.detail,l=this.getModel(),d=this.getTargetValue(a);if(d===void 0)return;const u=Fl(l.window,l.range),h=GV(u,d),g=v=>{const y=this.getModel();this.setModel(Au(y,"range",h,v))};g(d),Rn(a,v=>{const y=this.getTargetValue(v);y!==void 0&&g(y)})}),ve(e,"adjust-window-via-drag",s=>{const a=s.detail,l=this.getTargetFraction(a),d=this.getWindowLerp(l),u=l<.5?0:1,h=g=>{const v=this.getModel();this.setModel(Au(v,"window",u,g))};Rn(a,g=>{const v=this.getModel().window,y=this.getTargetFraction(g);h(u===0?Cr([d,v[1]],this.dataType,-y/(1-y)):Cr([v[0],d],this.dataType,1/y))})}),ve(e,"zoom-via-wheel",s=>{const a=s.detail,l=xu(a),d=this.getTargetFraction(a),u=this.dataType,h=this.getModel(),g=Cr(h.window,u,d*(1-l)),v=Cr(h.window,u,(1-d)*l+d);this.setModel(H(H({},h),{window:[g,v],range:h.range}))})}getTargetFraction(e){const t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return Cr(this.getModel().window,this.dataType,e)}getTargetValue(e){const t=this.getTargetFraction(e);if(gt(t))return this.getWindowLerp(t)}}const _k=Xi("histogramSamplerTexture");function Au(i,e,t,n,r=!1){const s=H({},i),a=i[e];if(s[e]=[a[0],a[1]],s[e][t]=n,e==="window"&&dn(n,a[1-t])*(2*t-1)<0&&(s[e][1-t]=n),e==="range"&&r){const l=[i.window[0],i.window[1]];for(let d=0;d<2;++d)dn(n,l[d])*(2*d-1)>0&&(l[d]=n);s.window=l}return s}const S6=254,Nl=S6+1;class b6 extends ZL{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.controller=this.registerDisposer(new IP(this.element,this.parent.dataType,()=>this.parent.trackable.value,t=>{this.parent.trackable.value=t})),this.dataValuesBuffer=this.registerDisposer(Zl(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{const t=new Uint8Array(Nl*us);for(let n=0;n<Nl;++n)for(let r=0;r<us;++r)t[n*us+r]=n;return t})).value,this.lineShader=this.registerDisposer((()=>{const t=new ea(this.gl);return tr(t),t.addTextureSampler("sampler2D","uHistogramSampler",_k),t.addOutputBuffer("vec4","out_color",0),t.addAttribute("uint","aDataValue"),t.addUniform("float","uBoundsFraction"),t.addVertexCode(`
float getCount(int i) {
  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;
}
vec4 getVertex(float cdf, int i) {
  float x;
  if (i == 0) {
    x = -1.0;
  } else if (i == 255) {
    x = 1.0;
  } else {
    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;
  }
  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);
}
`),t.setVertexMain(`
int lineNumber = int(aDataValue);
int dataValue = lineNumber;
float cumSum = 0.0;
for (int i = 0; i <= dataValue; ++i) {
  cumSum += getCount(i);
}
float total = cumSum + getCount(dataValue + 1);
float cumSumEnd = dataValue == ${Nl-1} ? cumSum : total;
if (dataValue == ${Nl-1}) {
  cumSum + getCount(dataValue + 1);
}
for (int i = dataValue + 2; i < 256; ++i) {
  total += getCount(i);
}
total = max(total, 1.0);
float cdf1 = cumSum / total;
float cdf2 = cumSumEnd / total;
emitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);
`),t.setFragmentMain(`
out_color = vec4(0.0, 1.0, 1.0, getLineAlpha());
`),t.build()})()),this.regionCornersBuffer=Ql(this.gl,0,-1,1,1),this.regionShader=this.registerDisposer((()=>{const t=new ea(this.gl);return t.addAttribute("vec2","aVertexPosition"),t.addUniform("vec2","uBounds"),t.addUniform("vec4","uColor"),t.addOutputBuffer("vec4","out_color",0),t.setVertexMain(`
gl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);
`),t.setFragmentMain(`
out_color = uColor;
`),t.build()})()),this.element.classList.add("neuroglancer-invlerp-cdfpanel")}get drawOrder(){return 100}drawIndirect(){const e=this.lineShader,t=this.gl,n=this.regionShader;var r=this.parent;const s=r.dataType,a=r.trackable.value;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{n.bind(),t.uniform4f(n.uniform("uColor"),.2,.2,.2,1);const l=tn(a.window,a.range[0]),d=tn(a.window,a.range[1]),u=ou(s,a.window);t.uniform2f(n.uniform("uBounds"),Math.min(l,d)*u,Math.max(l,d)*u+(1-u));const h=n.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(h,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(h)}if(this.parent.histogramSpecifications.producerVisibility.visible){const l=this.renderViewport;e.bind(),nr(e,{width:l.logicalWidth,height:l.logicalHeight},1);const d=e.textureUnit(_k);t.uniform1f(e.uniform("uBoundsFraction"),ou(s,a.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+d),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),po(t);const u=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(u,1,WebGL2RenderingContext.UNSIGNED_BYTE),ir(t,Nl,1),t.disableVertexAttribArray(u),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}}function w6(){}class C6 extends ZL{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.cornersBuffer=Ql(this.gl,-1,-1,1,1),this.element.classList.add("neuroglancer-invlerp-legend-panel");const t=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=ho(this,this.gl,H(H({},t),{memoizeKey:{id:"colorLegendShader",base:t.memoizeKey},defineShader:(n,r,s)=>{n.addOutputBuffer("vec4","v4f_fragData0",0),n.addAttribute("vec2","aVertexPosition"),n.addUniform("float","uLegendOffset"),n.addVarying("float","vLinearPosition"),n.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);
`);const a=this.parent.dataType,l=si(a);n.addFragmentCode(yB(n,"ng_colorLegendLerp",a)),n.addFragmentCode(`
void emit(vec4 v) {
  v4f_fragData0 = v;
}
${l} getDataValue() {
  return ng_colorLegendLerp(vLinearPosition);
}
${l} getDataValue(int dummyChannel) {
  return getDataValue();
}
${l} getInterpolatedDataValue() {
  return getDataValue();
}
${l} getInterpolatedDataValue(int dummyChannel) {
  return getDataValue();
}
`),t.defineShader(n,r,s)}}))}drawIndirect(){const e=this.shaderGetter(w6),t=e.shader;if(t===null)return;this.setGLLogicalViewport();const n=this.gl;n.clearColor(0,0,0,0),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),n.enable(WebGL2RenderingContext.BLEND);var r=this.parent;const s=r.trackable.value.window,a=r.dataType;Rv(t,"ng_colorLegendLerp",this.parent.dataType,s);const l=WV(a,s);n.uniform1f(t.uniform("uLegendOffset"),gt(l)?l:0),n.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),n.disable(WebGL2RenderingContext.DEPTH_TEST),n.disable(WebGL2RenderingContext.STENCIL_TEST);const d=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(d,2,WebGL2RenderingContext.FLOAT),n.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),n.disableVertexAttribArray(d)}isReady(){return!0}}function Fk(i,e){const t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add("neuroglancer-invlerp-widget-bound"),t.classList.add(`neuroglancer-invlerp-widget-${i}-bound`),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=i==="range"?`Data value that maps to ${e}`:`${e===0?"Lower":"Upper"} bound for distribution`,t}function Uk(i,e,t){const n=document.createElement("div");n.classList.add("neuroglancer-invlerp-widget-bounds"),n.classList.add(`neuroglancer-invlerp-widget-${i}-bounds`);const r=[Fk(i,0),Fk(i,1)];for(let a=0;a<2;++a){const l=r[a];l.addEventListener("input",()=>{RP(l)}),l.addEventListener("change",()=>{const d=t.value,u=d[i];try{const h=vc(e,l.value);t.value=Au(d,i,a,h,!0)}catch{bm(l,u[a])}})}let s;return n.appendChild(r[0]),n.appendChild(r[1]),i==="range"&&(s=[document.createElement("div"),document.createElement("div"),document.createElement("div")],s[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),n.insertBefore(s[0],r[0]),n.insertBefore(s[1],r[1]),n.appendChild(s[2])),{container:n,inputs:r,spacers:s}}function RP(i){_i(i,Math.max(1,i.value.length+.1))}function bm(i,e){let t;e instanceof te||Ai(e)?t=e.toString():t=e.toPrecision(6),i.value=t,RP(i)}function MP(i){const e=i.value,t=e.range;i.value=H(H({},e),{range:[t[1],t[0]]})}function x6(i,e,t){const n=e.value,r=Cr(n.range,i,.5-t/2),s=Cr(n.range,i,.5+t/2);e.value=H(H({},n),{range:[r,s]})}function k6(i,e,t,n,r){const s=Math.exp(r),a=e.value,l=Cr(t,i,.5-s/2+n),d=Cr(t,i,.5+s/2+n);e.value=H(H({},a),{range:[l,d]})}class E6 extends _r{constructor(e,t,n,r,s,a,l){super(e),this.display=t,this.dataType=n,this.trackable=r,this.histogramSpecifications=s,this.histogramIndex=a,this.legendShaderOptions=l,this.cdfPanel=this.registerDisposer(new b6(this)),this.boundElements={range:Uk("range",this.dataType,this.trackable),window:Uk("window",this.dataType,this.trackable)},this.registerDisposer(s.visibility.add(this.visibility));const d=this.element,u=this.boundElements;if(l!==void 0){const g=this.registerDisposer(new C6(this));d.appendChild(g.element)}const h=g=>{const v=ft({svg:g,title:"Invert range",onClick:()=>{this.invertRange()}});return u.range.spacers[1].appendChild(v),v};this.invertArrows=[h(CT),h(wT)],d.appendChild(u.range.container),d.appendChild(this.cdfPanel.element),d.classList.add("neuroglancer-invlerp-widget"),d.appendChild(u.window.container),this.updateView(),this.registerDisposer(r.changed.add(this.registerCancellable(dt(()=>this.updateView()))))}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){MP(this.trackable)}updateView(){const e=this.boundElements,t=this.trackable.value,n=this.dataType;for(let g=0;g<2;++g)bm(e.range.inputs[g],t.range[g]),bm(e.window.inputs[g],t.window[g]);const r=dn(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=r?"row-reverse":"row";const s=Fl(t.window,t.range),a=e.range.spacers,l=ou(n,t.window),d=tn(t.window,s[r?1:0])*l,u=tn(t.window,s[r?0:1])*l+(1-l);a[r?2:0].style.width=`${d*100}%`,a[r?0:2].style.width=`${(1-u)*100}%`;const h=this.invertArrows;h[r?1:0].style.display="",h[r?0:1].style.display="none"}}const My="mergeSegments",Ay="splitSegments",L6=at.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),T6=at.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+alt+mousedown0":{action:"split-and-select-segments"},"at:shift?+mousedown2":{action:"set-anchor"}});class D6 extends Eo{constructor(e){super(e),this.lastAnchorBaseSegment=new ct(void 0);const t=()=>{const n=e.anchorSegment.value;if(n===void 0)return;const r=e.displayState.segmentSelectionState;if(!r.hasSelectedSegment)return;const s=e.displayState.segmentationGroupState.value.segmentEquivalences,a=s.get(n);if(!te.equal(r.selectedSegment,a))return;const l=r.baseSelectedSegment,d=u_(l),u=s.disjointSets.visibleSegmentEquivalencePolicy.value;u&Pn.NONREPRESENTATIVE_EXCLUDED&&d||u&Pn.REPRESENTATIVE_EXCLUDED&&!d||(this.lastAnchorBaseSegment.value=l.clone())};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return My}activate(e){const t=this.layer.displayState.segmentationGroupState.value,n=()=>{let h=this.layer.anchorSegment.value,g=this.lastAnchorBaseSegment.value;if(h===void 0)return{anchorSegment:void 0,error:"Select anchor segment for merge"};const v=t.segmentEquivalences.get(h);return t.visibleSegments.has(v)?g===void 0||!te.equal(t.segmentEquivalences.get(g),v)?{anchorSegment:h,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:g,error:void 0}:{anchorSegment:h,error:"Anchor segment must be in visible set"}},r=()=>{var h=n();let g=h.anchorSegment,v=h.error;if(g===void 0||v!==void 0)return{anchorSegment:g,error:v,otherSegment:void 0,anchorSegmentValid:!1};const y=this.layer.displayState,C=y.segmentSelectionState.baseValue;return C===void 0||te.equal(y.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(g))?{anchorSegment:g,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:g,otherSegment:C,error:void 0,anchorSegmentValid:!0}};var s=bh(e);const a=s.body,l=s.header;l.textContent="Merge segments",a.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(L6),e.registerDisposer(()=>{bu(t)});const d=()=>{Ke(a);const h=this.layer.displayState;var g=r();let v=g.anchorSegment,y=g.otherSegment,C=g.anchorSegmentValid,w=g.error;const b=L=>{const I=ey(this.layer.displayState,L);return I.classList.add("neuroglancer-segment-list-entry-double-line"),I};if(v!==void 0&&a.appendChild(b(xo(h,v))),w!==void 0){const L=document.createElement("span");L.textContent=w,a.appendChild(L)}if(y!==void 0){const L=document.createElement("span");L.textContent=" merge ",a.appendChild(L),a.appendChild(b(xo(h,y)))}const k=t.segmentEquivalences;if(C){t.useTemporaryVisibleSegments.value=!0;const L=t.temporaryVisibleSegments;L.clear(),L.add(k.get(v)),y!==void 0&&L.add(k.get(y))}else{bu(t);return}};d(),e.registerDisposer(sc(this.layer.displayState,a));const u=e.registerCancellable(dt(d));Mc(this.layer.displayState,e,u),e.registerDisposer(this.layer.anchorSegment.changed.add(u)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(u)),e.bindAction("merge-segments",h=>{h.stopPropagation(),(async()=>{const g=t.graph.value;if(g===void 0)return;var v=r();const y=v.anchorSegment,C=v.otherSegment,w=v.error;if(!(y===void 0||C===void 0||w!==void 0))try{await g.merge(y,C),Ye.showTemporaryMessage("Merge performed")}catch(b){Ye.showTemporaryMessage(`Merge failed: ${b}`)}})()}),e.bindAction("set-anchor",h=>{h.stopPropagation();const g=this.layer.displayState.segmentSelectionState.baseValue;if(g===void 0)return;const v=this.layer.anchorSegment.value;if(t.visibleSegments.add(g),v===void 0||!te.equal(v,g)){this.layer.anchorSegment.value=g.clone();return}})}get description(){return"merge"}}class P6 extends Eo{toJSON(){return Ay}activate(e){const t=this.layer.displayState.segmentationGroupState.value,n=()=>{let g=this.layer.anchorSegment.value;if(g===void 0)return{anchorSegment:void 0,error:"Select anchor segment for split"};const v=t.segmentEquivalences.get(g);return t.visibleSegments.has(v)?{anchorSegment:g,error:void 0}:{anchorSegment:g,error:"Anchor segment must be in visible set"}};var r=bh(e);const s=r.body,a=r.header;a.textContent="Split segments",s.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(T6);const l=()=>{var g=n();let v=g.anchorSegment,y=g.error;if(v===void 0||y!==void 0)return{anchorSegment:v,error:y,otherSegment:void 0,anchorSegmentValid:!1};const C=this.layer.displayState,w=C.segmentSelectionState.baseValue;return w===void 0||!te.equal(C.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(v))||te.equal(w,v)?{anchorSegment:v,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:v,otherSegment:w,anchorSegmentValid:!0,error:void 0}};e.registerDisposer(()=>{bu(t)});const d=()=>{Ke(s);const g=this.layer.displayState;var v=l();let y=v.anchorSegment,C=v.otherSegment,w=v.anchorSegmentValid,b=v.error,k,L;(()=>{const P=t.segmentEquivalences,T=this.layer.graphConnection;if(!w||T===void 0){bu(t);return}else{if(t.useTemporaryVisibleSegments.value=!0,C!==void 0){const M=T.computeSplit(y,C);if(M!==void 0){k=new vs(y,M.includeRepresentative),L=new vs(C,M.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;const V=M.includeRepresentative,B=M.excludeRepresentative,F=t.temporarySegmentEquivalences;F.clear();for(const U of M.includeBaseSegments)F.link(U,V);for(const U of M.excludeBaseSegments)F.link(U,B);const j=t.temporaryVisibleSegments;j.clear(),j.add(V),j.add(B);return}}t.useTemporarySegmentEquivalences.value=!1;const R=t.temporaryVisibleSegments;R.clear(),R.add(P.get(y))}})();const I=P=>{const T=ey(this.layer.displayState,P);return T.classList.add("neuroglancer-segment-list-entry-double-line"),T};if(y!==void 0&&s.appendChild(I(k??xo(g,y))),b!==void 0){const P=document.createElement("span");P.textContent=b,s.appendChild(P)}if(L!==void 0){const P=document.createElement("span");P.textContent=" split ",s.appendChild(P),s.appendChild(I(L))}};e.registerDisposer(sc(this.layer.displayState,s)),d();const u=e.registerCancellable(dt(d));Mc(this.layer.displayState,e,u),e.registerDisposer(this.layer.anchorSegment.changed.add(u));const h=async g=>{const v=t.graph.value;if(v===void 0)return;var y=l();const C=y.anchorSegment,w=y.otherSegment,b=y.error;if(!(C===void 0||w===void 0||b!==void 0))try{await v.split(C,w),g&&t.visibleSegments.add(t.segmentEquivalences.get(w)),Ye.showTemporaryMessage("Split performed")}catch(k){Ye.showTemporaryMessage(`Split failed: ${k}`)}};e.bindAction("split-segments",g=>{g.stopPropagation(),h(!1)}),e.bindAction("split-and-select-segments",g=>{g.stopPropagation(),h(!0)}),e.bindAction("set-anchor",g=>{g.stopPropagation();const v=this.layer.displayState.segmentSelectionState.baseValue;if(v===void 0)return;t.visibleSegments.add(v);const y=this.layer.anchorSegment.value;if(y===void 0||!te.equal(y,v)){this.layer.anchorSegment.value=v.clone();return}})}get description(){return"split"}}function I6(){oc(qt,My,i=>new D6(i)),oc(qt,Ay,i=>new P6(i))}/**
* /**
* @license
* This work is a derivative of the Google Neuroglancer project,
* Copyright 2016 Google Inc.
* The Derivative Work is covered by
* Copyright 2021 Howard Hughes Medical Institute
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const Ny="selectSegments",wm="mousedown0",R6=at.fromObject({[`at:alt?+shift?+${wm}`]:"drag-select-segments"});var Ti;(function(i){i[i.IDLE=0]="IDLE",i[i.SELECT=1]="SELECT",i[i.DESELECT=2]="DESELECT"})(Ti||(Ti={}));class M6 extends Eo{constructor(e){super(e)}toJSON(){return Ny}activate(e){const t=this.layer;var n=bh(e);const r=n.body,s=n.header;let a=Ti.IDLE,l=!1;e.bindInputEventMap(R6);const d=()=>Cu.value&2?Ti.DESELECT:Ti.SELECT,u=y=>{a!==y&&(a=y,l=!1,h())},h=()=>{Ke(r);const y=document.createElement("span");switch(a){case Ti.IDLE:s.textContent="Select/Deselect segments",y.textContent=`${wm} to select segments; alt+${wm} to deselect segments.`;break;case Ti.SELECT:case Ti.DESELECT:s.textContent=`${a==Ti.SELECT?"Select":"Deselect"} segments`,y.textContent=`Drag to ${a==Ti.SELECT?"select":"deselect"} segments (${t.displayState.segmentationGroupState.value.visibleSegments.size} selected).`}r.appendChild(y)};h();const g=()=>{if(a==Ti.IDLE)return;const y=t.displayState.segmentSelectionState;if(y.hasSelectedSegment){const C=y.selectedSegment,w=t.displayState.segmentationGroupState.value.visibleSegments;switch(a){case Ti.SELECT:w.add(C);break;case Ti.DESELECT:w.delete(C);break}}};e.registerDisposer(t.displayState.segmentSelectionState.changed.add(()=>{l&&g()})),e.registerDisposer(t.displayState.segmentationGroupState.value.visibleSegments.changed.add(h)),e.registerDisposer(Cu.changed.add(()=>{a!=Ti.IDLE&&u(d())}));const v=(y,C)=>{y.stopPropagation(),u(C),g();const w=y.detail.screenX,b=y.detail.screenY;Rn(y.detail,(k,L,I)=>{if(!l){const P=k.screenX-w,T=k.screenY-b;P*P+T*T>25&&(g(),l=!0)}},k=>{l=!1,u(Ti.IDLE)})};e.bindAction("drag-select-segments",y=>v(y,d()))}get description(){return"select"}}function A6(){oc(qt,Ny,i=>new M6(i))}const N6=new te;class V6 extends Y{constructor(e,t,n,r){super(),this.query=e,this.segmentPropertyMap=t,this.segmentationDisplayState=n,this.parentElement=r,this.changed=new Ze,this.explicitSegmentsVisible=!1,this.visibleSegmentsGeneration=-1,this.queryResult=new ct(void 0),this.statusText=new ct(""),this.selectedMatches=0,this.matchStatusTextPrefix="",this.debouncedUpdate=nt(()=>this.update(),0),this.render=s=>{const a=this.explicitSegments;let l,d=!1;if(a!==void 0&&s<a.length)l=a[s],d=this.explicitSegmentsVisible;else{a!==void 0&&(s-=a.length),l=N6;const h=this.queryResult.value.indices[s],g=this.segmentPropertyMap.segmentPropertyMap.inlineProperties.ids;l.low=g[h*2],l.high=g[h*2+1]}const u=this.segmentWidgetFactory.get(l);return d&&(u.dataset.visibleList="true"),u},this.update(),this.registerDisposer(n.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(e.changed.add(this.debouncedUpdate))}get numMatches(){var e,t;return(t=(e=this.queryResult.value)===null||e===void 0?void 0:e.count)!==null&&t!==void 0?t:0}update(){var e;const t=this.query.value,n=this.segmentPropertyMap,r=this.queryResult.value;let s;if(this.prevQuery===t)s=r;else{const b=rW(n,t);s=sW(n,b)}const a=[];let l=!1,d="";const u=this.segmentationDisplayState.segmentationGroupState.value.visibleSegments,h=u.changed.count,g=this.visibleSegmentsGeneration,v=dW(s.query);if(v){if(g!==h||this.explicitSegments===void 0||!this.explicitSegmentsVisible){this.visibleSegmentsGeneration=h;const b=Ee(u,L=>L.clone());b.sort(te.compare);const k=this.explicitSegments;k===void 0?(this.explicitSegments=b,a.push({retainCount:0,insertCount:b.length,deleteCount:0})):a.push(...gN(k,b,te.compare)),this.explicitSegments=b,l=!0}else a.push({retainCount:this.explicitSegments.length,deleteCount:0,insertCount:0});this.explicitSegmentsVisible=!0}else this.visibleSegmentsGeneration=h,this.explicitSegments!==void 0&&this.explicitSegmentsVisible&&(a.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,l=!0),this.explicitSegmentsVisible=!1;var y=s;const C=y.explicitIds;if(C!==void 0?this.explicitSegments=C:this.explicitSegmentsVisible||(this.explicitSegments=void 0),r!==s&&(a.push({retainCount:0,deleteCount:(e=r?.count)!==null&&e!==void 0?e:0,insertCount:s.count}),l=!0,this.queryResult.value=s),s.explicitIds!==void 0?d=`${s.count} ids`:v?d=`${s.count} listed ids`:s.total>0&&(d=`${s.count}/${s.total} matches`),r!==s||h!==g){let b=d,k=0;n!==void 0&&s.count>0&&(k=cW(n,s,u),b+=` (${k} visible)`),this.selectedMatches=k,this.statusText.value=b}this.prevQuery=t,this.matchStatusTextPrefix=d;const w=this.explicitSegments;this.length=(this.explicitSegmentsVisible?w.length:0)+s.count,l&&this.changed.dispatch(a)}updateRendering(e){this.segmentWidgetFactory.update(e)}updateRenderedItems(e){e.forEachRenderedItem(t=>{this.updateRendering(t)})}}const zk=at.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}}),O6=100;function AP(i){_i(i,Math.max(1,i.value.length+.1))}function Zf(i,e){let t;if(Ai(e))t=e.toString();else{const n=e.toString(),r=e.toPrecision(6);t=n.length<r.length?n:r}i.value=t,AP(i)}function B6(i,e){const t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add(`neuroglancer-segment-query-result-numerical-plot-${i}-bound`),t.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=(e===0?"Lower":"Upper")+" bound "+(i==="range"?"range":"for distribution"),t.addEventListener("input",()=>{AP(t)}),t}function _6(i,e,t){if(i===void 0||i.indices===void 0)return;const n=i.query;let r=n.sortBy,s=n.includeColumns;Cy(n,t)?(r=r.filter(a=>a.fieldId!==t),s=s.filter(a=>a!==t)):s.push(t),e(H(H({},n),{sortBy:r,includeColumns:s}))}function NP(i,e,t){var n;const r=i?.query,s=r?.sortBy;if(s===void 0)return;const a=r.includeColumns,l=((n=s.find(u=>u.fieldId===t))===null||n===void 0?void 0:n.order)==="<"?">":"<",d=a.filter(u=>u!==t);for(const u of s)u.fieldId!=="id"&&u.fieldId!=="label"&&u.fieldId!==t&&d.push(u.fieldId);e(H(H({},r),{sortBy:[{fieldId:t,order:l}],includeColumns:d}))}function VP(i,e,t){var n,r;const s=(n=i?.query)===null||n===void 0?void 0:n.sortBy,a=(r=s?.find(l=>l.fieldId===t))===null||r===void 0?void 0:r.order;e.textContent=a===">"?"▼":"▲",e.style.visibility=a===void 0?"":"visible",e.title=`Sort by ${t} in ${a==="<"?"descending":"ascending"} order`}class F6 extends Y{constructor(e,t,n){super(),this.segmentPropertyMap=e,this.queryResult=t,this.setQuery=n,this.propertyHistograms=[],this.bounds={window:new ct([]),range:new ct([])},this.throttledUpdate=this.registerCancellable(hh(()=>this.updateHistograms(),100)),this.debouncedRender=this.registerCancellable(dt(()=>this.updateHistogramRenderings())),this.debouncedSetQuery=this.registerCancellable(nt(()=>this.setQueryFromBounds(),200));const r=e?.numericalProperties,s=[];let a;if(r!==void 0&&r.length>0){a=document.createElement("details");const l=document.createElement("summary");l.textContent=`${r.length} numerical propert${r.length>1?"ies":"y"}`,a.appendChild(l),a.classList.add("neuroglancer-segment-query-result-numerical-list");const d=this.bounds.window.value;for(let u=0,h=r.length;u<h;++u){const g=r[u],v=this.makeNumericalPropertySummary(u,g);s.push(v),a.appendChild(v.element),d[u]=g.bounds}}this.listElement=a,this.properties=s,this.registerDisposer(this.queryResult.changed.add(()=>{this.handleNewQueryResult()})),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){const e=this.queryResult.value;if(e===void 0||e.indices===void 0)return;const t=e.query,n=[],r=this.bounds.range.value,s=this.properties;for(let a=0,l=s.length;a<l;++a){const d=s[a].property;n.push({fieldId:d.id,bounds:r[a]})}this.setQuery(H(H({},t),{numericalConstraints:n}))}getBounds(e){const t=this.bounds;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){const n=this.properties[e].property;let r=Fl(n.bounds,t.range);dn(r[0],r[1])>0&&(r=[r[1],r[0]]);const s=Fl(n.bounds,t.window),a=this.getBounds(e),l=this.properties[e].property.dataType;xr(l,s,a.window)||(this.bounds.window.value[e]=s,this.bounds.window.changed.dispatch()),xr(l,r,a.range)||(this.bounds.range.value[e]=r,this.bounds.range.changed.dispatch())}setBound(e,t,n,r){const s=this.segmentPropertyMap.numericalProperties[n].bounds;r=ql(s,r);const a=this.getBounds(n),l=Au(a,e,t,r,!0);this.setBounds(n,l)}handleNewQueryResult(){const e=this.queryResult.value;if(this.listElement!==void 0){if(e?.indices!==void 0){const t=e.query.numericalConstraints,n=this.segmentPropertyMap.numericalProperties,r=this.bounds.range.value,s=t.length,a=n.length;r.length=a;for(let l=0;l<a;++l)r[l]=n[l].bounds;for(let l=0;l<s;++l){const d=t[l],u=n.findIndex(h=>h.id===d.fieldId);r[u]=d.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){const e=this.queryResult.value;this.listElement!==void 0&&(oW(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();const e=this.listElement;if(e===void 0)return;const t=this.propertyHistograms;if(t.length===0){e.style.display="none";return}e.style.display="";const n=this.properties;for(let r=0,s=n.length;r<s;++r)this.updateNumericalPropertySummary(r,n[r],t[r])}makeNumericalPropertySummary(e,t){const n=document.createElement("div");n.classList.add("neuroglancer-segment-query-result-numerical-plot-container");const r=document.createElement("img");r.classList.add("neuroglancer-segment-query-result-numerical-plot");const s=new IP(r,t.dataType,()=>this.getBounds(e),h=>this.setBounds(e,h)),a=document.createElement("span");a.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");const l=document.createElement("input");l.type="checkbox",l.addEventListener("click",()=>{_6(this.queryResult.value,this.setQuery,t.id)});const d=h=>{const g=document.createElement("div");g.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),g.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${h}`);const v=w=>{const b=B6(h,w);return b.addEventListener("change",()=>{if(this.bounds[h].value[e]!==void 0){try{const k=vc(t.dataType,b.value);this.setBound(h,w,e,k),this.bounds[h].changed.dispatch()}catch{}Zf(b,this.bounds[h].value[e][w])}}),b},y=[v(0),v(1)];let C;if(h==="range"){C=[document.createElement("div"),document.createElement("div"),document.createElement("div")],C[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),C[1].appendChild(l);const w=document.createElement("span");w.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),w.appendChild(document.createTextNode(t.id)),w.appendChild(a),w.addEventListener("click",()=>{NP(this.queryResult.value,this.setQuery,t.id)}),C[1].appendChild(w);const b=t.description;b&&(C[1].title=b),g.appendChild(C[0]),g.appendChild(y[0]);const k=document.createElement("div");k.textContent="≤",k.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),g.appendChild(k),g.appendChild(C[1]);const L=document.createElement("div");L.textContent="≤",L.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),g.appendChild(L),g.appendChild(y[1]),g.appendChild(C[2])}else g.appendChild(y[0]),g.appendChild(y[1]);return{container:g,spacers:C,inputs:y}},u={range:d("range"),window:d("window")};return n.appendChild(u.range.container),n.appendChild(r),n.appendChild(u.window.container),{property:t,controller:s,element:n,plotImg:r,boundElements:u,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:l,sortIcon:a}}updateNumericalPropertySummary(e,t,n){const r=t.bounds.window,s=this.bounds.window.value[e],a=t.bounds.range,l=this.bounds.range.value[e],d=t.property,u=this.queryResult.value,h=Cy(u?.query,d.id);if(t.columnCheckbox.checked=h,t.columnCheckbox.title=h?"Remove column from result table":"Add column to result table",VP(u,t.sortIcon,d.id),t.propertyHistogram===n&&xr(d.dataType,r,s)&&xr(d.dataType,a,l))return;const g=n.histogram,v="http://www.w3.org/2000/svg",y=document.createElementNS(v,"svg");y.setAttribute("width","1"),y.setAttribute("height","1"),y.setAttribute("preserveAspectRatio","none");const C=document.createElementNS(v,"rect"),w=tn(s,l[0]),b=tn(s,l[1]);C.setAttribute("x",`${w}`),C.setAttribute("y","0"),C.setAttribute("width",`${b-w}`),C.setAttribute("height","1"),C.setAttribute("fill","#4f4f4f"),y.appendChild(C);const k=g.length,L=(B,F,j)=>{const U=document.createElementNS(v,"polyline");let O="",$=0;for(let le=B;le<j;++le)$+=g[le];if($===0)return;const _=tn(s,n.window[0]),se=tn(s,n.window[1]),oe=(le,we)=>{const ie=le/(k-2),he=_*(1-ie)+se*ie;O+=` ${he},${1-we}`};B!==0&&oe(B,0);let Re=0;for(let le=B;le<F;++le){const we=g[le];Re+=we,oe(le,Re/$)}return U.setAttribute("fill","none"),U.setAttribute("stroke-width","1px"),U.setAttribute("points",O),U.setAttribute("vector-effect","non-scaling-stroke"),U};{const B=L(0,k-1,k);B!==void 0&&(B.setAttribute("stroke","cyan"),y.appendChild(B))}if(!xr(d.dataType,d.bounds,l)){const B=Math.floor(Math.max(0,Math.min(1,tn(n.window,l[0])))*(k-2)),F=Math.ceil(Math.max(0,Math.min(1,tn(n.window,l[1])))*(k-2)),j=L(B,F,F);j!==void 0&&(j.setAttribute("stroke","white"),y.appendChild(j))}const I=new XMLSerializer().serializeToString(y);t.plotImg.src=`data:image/svg+xml;base64,${btoa(I)}`,t.propertyHistogram=n;for(let B=0;B<2;++B)r[B]=s[B],Zf(t.boundElements.window.inputs[B],s[B]),a[B]=l[B],Zf(t.boundElements.range.inputs[B],l[B]);const P=t.boundElements.range.spacers,T=Fl(s,l),R=ou(d.dataType,s),M=tn(s,T[0])*R,V=tn(s,T[1])*R+(1-R);P[0].style.width=`${M*100}%`,P[2].style.width=`${(1-V)*100}%`}}function U6(i,e){const t=i.tags;if(t===void 0||t.length===0)return;const n=i.query,r=document.createElement("div");r.classList.add("neuroglancer-segment-query-result-tag-list");for(const s of t){const a=s.tag,l=s.count,d=document.createElement("div");d.classList.add("neuroglancer-segment-query-result-tag");const u=document.createElement("span");u.classList.add("neuroglancer-segment-query-result-tag-name"),u.textContent=a,r.appendChild(d);const h=n.includeTags.includes(a),g=n.excludeTags.includes(a);let v;h?v="Remove tag from required set":g?v="Remove tag from excluded set":v="Add tag to required set",u.addEventListener("click",()=>{e(xk(n,a,!0,!h&&!g))}),u.title=v;const y=h||g,C=b=>{const k=b?l:i.count-l,L=document.createElement("div");if(L.classList.add("neuroglancer-segment-query-result-tag-toggle"),L.classList.add(`neuroglancer-segment-query-result-tag-${b?"include":"exclude"}`),d.appendChild(L),!y&&k===0)return;const I=b?h:g;L.appendChild(new Gn({get value(){return I},set value(P){e(xk(n,a,b,P))},changed:qE},{text:b?"+":"-",enableTitle:`Add tag to ${b?"required":"exclusion"} set`,disableTitle:`Remove tag from ${b?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};C(!0),C(!1),d.appendChild(u);const w=document.createElement("span");w.classList.add("neuroglancer-segment-query-result-tag-count"),y||(w.textContent=l.toString()),d.appendChild(w)}return r}class z6 extends _r{constructor(e){super(),this.layer=e;const t=this.element;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new Qn(e.displayState.segmentationGroupState.value.graph,(d,u,h)=>{if(d===void 0)return;const g=document.createElement("div");g.className="neuroglancer-segmentation-toolbox",g.appendChild(Uf(h,e,{toolJson:My,label:"Merge",title:"Merge segments"})),g.appendChild(Uf(h,e,{toolJson:Ay,label:"Split",title:"Split segments"})),u.appendChild(g)})).element);const n=document.createElement("div");n.className="neuroglancer-segmentation-toolbox",n.appendChild(Uf(this,e,{toolJson:Ny,label:"Select",title:"Select/Deselect segments"})),t.appendChild(n);const r=document.createElement("input");r.classList.add("neuroglancer-segment-list-query"),r.addEventListener("focus",()=>{r.select()});const s=this.registerDisposer(new Nn(r,zk));s.allShortcutsAreGlobal=!0;const a=this.layer.displayState.segmentQuery,l=this.registerCancellable(nt(()=>{a.value=r.value},200));r.autocomplete="off",r.title=zk.describe(),r.spellcheck=!1,r.placeholder="Enter ID, name prefix or /regexp",this.registerDisposer(Lr(d=>{r.value=d},a)),this.registerDisposer(Lr(d=>{Date.now()-d<100&&(setTimeout(()=>{r.focus()},0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)},this.layer.segmentQueryFocusTime)),t.appendChild(r),t.appendChild(this.registerDisposer(new Qn(e.displayState.segmentPropertyMap,(d,u,h)=>{const g=le=>{r.focus(),r.select();const we=lW(d,le);document.execCommand("insertText",!1,we),a.value=we,r.select()},v=h.registerDisposer(new V6(a,d,e.displayState,u)),y=e.displayState.segmentationGroupState.value,C=document.createElement("ul");C.classList.add("neuroglancer-segment-query-errors"),u.appendChild(C);const w=document.createElement("div");w.classList.add("neuroglancer-segment-query-result-statistics");const b=document.createElement("span"),k=document.createElement("input");k.type="checkbox",k.checked=!0,k.title="Deselect all segment IDs",k.addEventListener("change",()=>{y.visibleSegments.clear()});const L=Zn({title:"Copy visible segment IDs",onClick:()=>{const le=Ee(y.visibleSegments,we=>we.clone());le.sort(te.compare),Ji(le.join(", "))}}),I=document.createElement("span");b.appendChild(L),b.appendChild(k),b.appendChild(I);const P=document.createElement("span"),T=document.createElement("input"),R=Zn({onClick:()=>{l(),l.flush(),v.debouncedUpdate.flush();const le=v.queryResult.value;if(le===void 0)return;const we=new Array(le.count);Kd(d,le,(ie,he)=>{we[he]=ie.toString()}),Ji(we.join(", "))}});T.type="checkbox";const M=()=>{l(),l.flush(),v.debouncedUpdate.flush();const le=v.queryResult.value;if(le===void 0)return;const we=y.visibleSegments,ie=v.selectedMatches,he=ie!==le.count;if(he&&le.count-ie>O6){if(!U)return U=!0,V.textContent=`Confirm: show ${le.count-ie} segments?`,!1;U=!1,j()}return Kd(d,le,Te=>{we.set(Te,he)}),!0};T.addEventListener("click",le=>{M()||le.preventDefault()});const V=document.createElement("span");P.appendChild(R),P.appendChild(T),P.appendChild(V),b.classList.add("neuroglancer-segment-list-status"),P.classList.add("neuroglancer-segment-list-status"),u.appendChild(w);const B=document.createElement("div");B.classList.add("neuroglancer-segment-query-result-statistics-separator"),u.appendChild(B),u.appendChild(P),u.appendChild(b);let F=-1;const j=()=>{const le=y.visibleSegments.size;F!==le&&(F=le,I.textContent=`${le} visible in total`,k.checked=le>0,k.style.visibility=le?"visible":"hidden",L.style.visibility=le?"visible":"hidden"),V.textContent=v.statusText.value;const we=v.numMatches,ie=v.selectedMatches;R.style.visibility=we?"visible":"hidden",R.title=`Copy ${we} segment ID(s)`,T.style.visibility=we?"visible":"hidden",ie===0?(T.checked=!1,T.indeterminate=!1,T.title=`Show ${we} segment ID(s)`):ie===we?(T.checked=!0,T.indeterminate=!1,T.title=`Hide ${ie} segment ID(s)`):(T.checked=!0,T.indeterminate=!0,T.title=`Show ${we-ie} segment ID(s)`)};j(),v.statusText.changed.add(j),h.registerDisposer(y.visibleSegments.changed.add(j));let U=!1;h.registerEventListener(r,"input",()=>{l(),U&&(U=!1,j())}),h.registerDisposer(ve(r,"cancel",()=>{r.focus(),r.select(),document.execCommand("delete"),r.blur(),r.value="",a.value="",U=!1,j()})),h.registerDisposer(ve(r,"toggle-listed",M)),h.registerDisposer(ve(r,"hide-all",()=>{y.visibleSegments.clear()})),h.registerDisposer(ve(r,"hide-listed",()=>{l(),l.flush(),v.debouncedUpdate.flush();const le=y.visibleSegments;if(a.value==="")le.clear();else{const we=v.queryResult.value;if(we===void 0)return;Kd(d,we,ie=>{le.delete(ie)})}}));const O=h.registerDisposer(new ly({source:v,horizontalScroll:!0})),$=h.registerCancellable(dt(()=>{v.updateRenderedItems(O)})),_=this.layer.displayState;h.registerDisposer(_.segmentSelectionState.changed.add($)),h.registerDisposer(y.visibleSegments.changed.add($)),h.registerDisposer(_.segmentColorHash.changed.add($)),h.registerDisposer(_.segmentStatedColors.changed.add($)),h.registerDisposer(_.segmentDefaultColor.changed.add($)),O.element.classList.add("neuroglancer-segment-list"),h.registerDisposer(e.bindSegmentListWidth(O.element)),h.registerDisposer(new Br(O.element,vh()));const se=h.registerDisposer(new F6(d,v.queryResult,g));{const le=se.listElement;le!==void 0&&w.appendChild(le)}let oe;const Re=le=>{const we=le?.errors;if(Ke(C),we!==void 0)for(const ie of we){const he=document.createElement("li");he.textContent=ie.message,C.appendChild(he)}};Lr(le=>{if(v.segmentWidgetFactory=new kU(v.segmentationDisplayState,v.parentElement,ie=>Cy(le?.query,ie.id)),O.scrollToTop(),Ke(O.header),d!==void 0){const ie=v.segmentWidgetFactory.getHeader();ie.container.classList.add("neuroglancer-segment-list-header");for(const he of ie.propertyLabels){const Te=he.label,Fe=he.sortIcon,Ge=he.id;Te.addEventListener("click",()=>{NP(v.queryResult.value,g,Ge)}),VP(le,Fe,Ge)}O.header.appendChild(ie.container)}if(Re(le),B.style.display="none",oe?.remove(),le===void 0)return;let we=le.query;we.errors!==void 0||we.ids!==void 0||(oe=U6(le,g),oe!==void 0&&w.appendChild(oe),(se.properties.length>0||oe!==void 0)&&(B.style.display=""))},v.queryResult),u.appendChild(O.element)})).element)}}function Vy(i={}){return ft(H({text:"?"},i))}function OP(i,e,t,n){const r=document.createElement("label");r.classList.add("neuroglancer-layer-control-container");const s=document.createElement("div");s.classList.add("neuroglancer-layer-control-label-container");const a=document.createElement("div");a.classList.add("neuroglancer-layer-control-label"),s.appendChild(a);const l=document.createElement("div");l.classList.add("neuroglancer-layer-control-label-text-container"),l.appendChild(document.createTextNode(t.label)),a.appendChild(l),t.title&&(a.title=t.title),r.appendChild(s);var d=t.makeControl(e,i,{labelContainer:s,labelTextContainer:l,display:e.manager.root.display,visibility:n});const u=d.control,h=d.controlElement;return h.classList.add("neuroglancer-layer-control-control"),r.appendChild(h),{controlContainer:r,label:a,labelContainer:s,labelTextContainer:l,control:u}}class BP extends Eo{constructor(e,t){super(e),this.options=t}activate(e){const t=this.options,n=this.layer,r=t.isValid;if(r!==void 0&&!r(n).value)return;var s=bh(e);const a=s.header,l=s.body;var d=OP(e,n,t,new Nt(Nt.VISIBLE));const u=d.controlContainer,h=d.control,g=d.labelContainer;a.appendChild(g),l.appendChild(u),t.activateTool(e,h)}get description(){var e;const t=this.options;return(e=t.toolDescription)!==null&&e!==void 0?e:t.label}toJSON(){return this.options.toolJson}}function $k(i,e,t,n){var r=OP(i,e,t,n);const s=r.controlContainer,a=r.label;return s.classList.add("neuroglancer-layer-options-control-container"),a.prepend(i.registerDisposer(new YT(e,t.toolJson)).element),s}function Oy(i,e,t,n){const r=n.isValid;return r===void 0?$k(i,e,n,t):i.registerDisposer(new Qn(r(e),(s,a,l)=>{s&&a.appendChild($k(l,e,n,t))},t)).element}function _P(i,e){const t=e.toolJson,n=typeof t=="string"?t:t.type;oc(i,n,r=>new BP(r,e))}class Gk extends Y{constructor(e){super(),this.group=e,this.element=document.createElement("div"),this.topRow=document.createElement("div"),this.label=document.createElement("label"),this.selectElement=document.createElement("select"),this.linkedLayers=document.createElement("div"),this.unlinkButton=document.createElement("button");const t=this.element,n=this.label,r=this.topRow,s=this.selectElement,a=this.linkedLayers,l=this.unlinkButton;r.appendChild(n),r.appendChild(s),r.appendChild(l),l.textContent="Unlink",l.addEventListener("click",()=>{this.group.isolate()}),t.appendChild(r),t.appendChild(a),this.updateView();const d=nt(()=>this.updateView(),0);this.registerEventListener(s,"change",()=>{this.updateModel(),d()}),this.registerDisposer(this.group.changed.add(d)),this.registerDisposer(this.group.linkedLayersChanged.add(d)),this.registerDisposer(this.group.layerManager.layersChanged.add(d))}updateModel(){const e=this.selectElement.value;e===""&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){var e;const t=this.selectElement,n=this.group,r=n.predicate;Ke(t);const s=this.group.rootGroup.linkedLayers.size!==0;this.unlinkButton.style.display=s?"":"none";const a=this.linkedLayers,l=n.linkedLayers.size!==0;if(a.style.display=l?"":"none",this.unlinkButton.textContent=l?"Unlink all":"Unlink",l){this.element.style.display="",t.style.display="none",Ke(a);for(const d of n.linkedLayers){const u=document.createElement("div");u.classList.add("neuroglancer-linked-layer-widget-layer");const h=Zv({title:"Unlink layer",onClick:()=>{this.group.getGroup(d).isolate()}});u.appendChild(h),u.appendChild(document.createTextNode(d.managedLayer.name)),a.appendChild(u)}}else{t.style.display="";const d=document.createElement("option");t.appendChild(d);let u=0;for(const h of this.group.layerManager.managedLayers){const g=h.layer;if(g!==null&&g!==n.layer&&r(g)){++u;const v=document.createElement("option"),y=h.name;v.textContent=y,v.value=y,t.appendChild(v)}}t.value=(e=n.toJSON())!==null&&e!==void 0?e:"",this.element.style.display=u===0?"none":""}}}const $6="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='maximiseIconTitle'%3e%3ctitle%20id='maximiseIconTitle'%3eMaximise%20View%3c/title%3e%3cpolyline%20points='21%2016%2021%2021%2016%2021'/%3e%3cpolyline%20points='8%2021%203%2021%203%2016'/%3e%3cpolyline%20points='16%203%2021%203%2021%208'/%3e%3cpolyline%20points='3%208%203%203%208%203'/%3e%3c/svg%3e";function By(i={}){return ft(H({svg:$6},i))}var G6={exports:{}},Wk;function W6(){return Wk||(Wk=1,(function(i,e){(function(t){t(Go())})(function(t){var n="CodeMirror-lint-markers",r="CodeMirror-lint-line-";function s(M,V,B){var F=document.createElement("div");F.className="CodeMirror-lint-tooltip cm-s-"+M.options.theme,F.appendChild(B.cloneNode(!0)),M.state.lint.options.selfContain?M.getWrapperElement().appendChild(F):document.body.appendChild(F);function j(U){if(!F.parentNode)return t.off(document,"mousemove",j);var O=Math.max(0,U.clientY-F.offsetHeight-5),$=Math.max(0,Math.min(U.clientX+5,F.ownerDocument.defaultView.innerWidth-F.offsetWidth));F.style.top=O+"px",F.style.left=$+"px"}return t.on(document,"mousemove",j),j(V),F.style.opacity!=null&&(F.style.opacity=1),F}function a(M){M.parentNode&&M.parentNode.removeChild(M)}function l(M){M.parentNode&&(M.style.opacity==null&&a(M),M.style.opacity=0,setTimeout(function(){a(M)},600))}function d(M,V,B,F){var j=s(M,V,B);function U(){t.off(F,"mouseout",U),j&&(l(j),j=null)}var O=setInterval(function(){if(j)for(var $=F;;$=$.parentNode){if($&&$.nodeType==11&&($=$.host),$==document.body)return;if(!$){U();break}}if(!j)return clearInterval(O)},400);t.on(F,"mouseout",U)}function u(M,V,B){this.marked=[],V instanceof Function&&(V={getAnnotations:V}),(!V||V===!0)&&(V={}),this.options={},this.linterOptions=V.options||{};for(var F in h)this.options[F]=h[F];for(var F in V)h.hasOwnProperty(F)?V[F]!=null&&(this.options[F]=V[F]):V.options||(this.linterOptions[F]=V[F]);this.timeout=null,this.hasGutter=B,this.onMouseOver=function(j){R(M,j)},this.waitingFor=0}var h={highlightLines:!1,tooltips:!0,delay:500,lintOnChange:!0,getAnnotations:null,async:!1,selfContain:null,formatAnnotation:null,onUpdateLinting:null};function g(M){var V=M.state.lint;V.hasGutter&&M.clearGutter(n),V.options.highlightLines&&v(M);for(var B=0;B<V.marked.length;++B)V.marked[B].clear();V.marked.length=0}function v(M){M.eachLine(function(V){var B=V.wrapClass&&/\bCodeMirror-lint-line-\w+\b/.exec(V.wrapClass);B&&M.removeLineClass(V,"wrap",B[0])})}function y(M,V,B,F,j){var U=document.createElement("div"),O=U;return U.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+B,F&&(O=U.appendChild(document.createElement("div")),O.className="CodeMirror-lint-marker CodeMirror-lint-marker-multiple"),j!=!1&&t.on(O,"mouseover",function($){d(M,$,V,O)}),U}function C(M,V){return M=="error"?M:V}function w(M){for(var V=[],B=0;B<M.length;++B){var F=M[B],j=F.from.line;(V[j]||(V[j]=[])).push(F)}return V}function b(M){var V=M.severity;V||(V="error");var B=document.createElement("div");return B.className="CodeMirror-lint-message CodeMirror-lint-message-"+V,typeof M.messageHTML<"u"?B.innerHTML=M.messageHTML:B.appendChild(document.createTextNode(M.message)),B}function k(M,V){var B=M.state.lint,F=++B.waitingFor;function j(){F=-1,M.off("change",j)}M.on("change",j),V(M.getValue(),function(U,O){M.off("change",j),B.waitingFor==F&&(O&&U instanceof t&&(U=O),M.operation(function(){I(M,U)}))},B.linterOptions,M)}function L(M){var V=M.state.lint;if(V){var B=V.options,F=B.getAnnotations||M.getHelper(t.Pos(0,0),"lint");if(F)if(B.async||F.async)k(M,F);else{var j=F(M.getValue(),V.linterOptions,M);if(!j)return;j.then?j.then(function(U){M.operation(function(){I(M,U)})}):M.operation(function(){I(M,j)})}}}function I(M,V){var B=M.state.lint;if(B){var F=B.options;g(M);for(var j=w(V),U=0;U<j.length;++U){var O=j[U];if(O){for(var $=null,_=B.hasGutter&&document.createDocumentFragment(),se=0;se<O.length;++se){var oe=O[se],Re=oe.severity;Re||(Re="error"),$=C($,Re),F.formatAnnotation&&(oe=F.formatAnnotation(oe)),B.hasGutter&&_.appendChild(b(oe)),oe.to&&B.marked.push(M.markText(oe.from,oe.to,{className:"CodeMirror-lint-mark CodeMirror-lint-mark-"+Re,__annotation:oe}))}B.hasGutter&&M.setGutterMarker(U,n,y(M,_,$,O.length>1,F.tooltips)),F.highlightLines&&M.addLineClass(U,"wrap",r+$)}}F.onUpdateLinting&&F.onUpdateLinting(V,j,M)}}function P(M){var V=M.state.lint;V&&(clearTimeout(V.timeout),V.timeout=setTimeout(function(){L(M)},V.options.delay))}function T(M,V,B){for(var F=B.target||B.srcElement,j=document.createDocumentFragment(),U=0;U<V.length;U++){var O=V[U];j.appendChild(b(O))}d(M,B,j,F)}function R(M,V){var B=V.target||V.srcElement;if(/\bCodeMirror-lint-mark-/.test(B.className)){for(var F=B.getBoundingClientRect(),j=(F.left+F.right)/2,U=(F.top+F.bottom)/2,O=M.findMarksAt(M.coordsChar({left:j,top:U},"client")),$=[],_=0;_<O.length;++_){var se=O[_].__annotation;se&&$.push(se)}$.length&&T(M,$,V)}}t.defineOption("lint",!1,function(M,V,B){if(B&&B!=t.Init&&(g(M),M.state.lint.options.lintOnChange!==!1&&M.off("change",P),t.off(M.getWrapperElement(),"mouseover",M.state.lint.onMouseOver),clearTimeout(M.state.lint.timeout),delete M.state.lint),V){for(var F=M.getOption("gutters"),j=!1,U=0;U<F.length;++U)F[U]==n&&(j=!0);var O=M.state.lint=new u(M,V,j);O.options.lintOnChange&&M.on("change",P),O.options.tooltips!=!1&&O.options.tooltips!="gutter"&&t.on(M.getWrapperElement(),"mouseover",O.onMouseOver),L(M)}}),t.defineExtension("performLint",function(){L(this)})})})()),G6.exports}W6();var Hk,jk;function H6(){return jk||(jk=1,Hk=function(i){i.defineMode("glsl",function(s,a){var l=s.indentUnit,d=a.keywords||e(t),u=a.builtins||e(n),h=a.blockKeywords||e("case do else for if switch while struct"),g=a.atoms||e("null"),v=a.hooks||{},y=a.multiLineStrings,C=/[+\-*&%=<>!?|\/]/,w;function b(R,M){var V=R.next();if(v[V]){var B=v[V](R,M);if(B!==!1)return B}if(V=='"'||V=="'")return M.tokenize=k(V),M.tokenize(R,M);if(/[\[\]{}\(\),;\:\.]/.test(V))return w=V,"bracket";if(/\d/.test(V))return R.eatWhile(/[\w\.]/),"number";if(V=="/"){if(R.eat("*"))return M.tokenize=L,L(R,M);if(R.eat("/"))return R.skipToEnd(),"comment"}if(V=="#")return R.eatWhile(/[\S]+/),R.eatWhile(/[\s]+/),R.eatWhile(/[\S]+/),R.eatWhile(/[\s]+/),"comment";if(C.test(V))return R.eatWhile(C),"operator";R.eatWhile(/[\w\$_]/);var F=R.current();return d.propertyIsEnumerable(F)?(h.propertyIsEnumerable(F)&&(w="newstatement"),"keyword"):u.propertyIsEnumerable(F)?"builtin":g.propertyIsEnumerable(F)?"atom":"word"}function k(R){return function(M,V){for(var B=!1,F,j=!1;(F=M.next())!=null;){if(F==R&&!B){j=!0;break}B=!B&&F=="\\"}return(j||!(B||y))&&(V.tokenize=b),"string"}}function L(R,M){for(var V=!1,B;B=R.next();){if(B=="/"&&V){M.tokenize=b;break}V=B=="*"}return"comment"}function I(R,M,V,B,F){this.indented=R,this.column=M,this.type=V,this.align=B,this.prev=F}function P(R,M,V){return R.context=new I(R.indented,M,V,null,R.context)}function T(R){var M=R.context.type;return(M==")"||M=="]"||M=="}")&&(R.indented=R.context.indented),R.context=R.context.prev}return{startState:function(R){return{tokenize:null,context:new I((R||0)-l,0,"top",!1),indented:0,startOfLine:!0}},token:function(R,M){var V=M.context;if(R.sol()&&(V.align==null&&(V.align=!1),M.indented=R.indentation(),M.startOfLine=!0),R.eatSpace())return null;w=null;var B=(M.tokenize||b)(R,M);if(B=="comment"||B=="meta")return B;if(V.align==null&&(V.align=!0),(w==";"||w==":")&&V.type=="statement")T(M);else if(w=="{")P(M,R.column(),"}");else if(w=="[")P(M,R.column(),"]");else if(w=="(")P(M,R.column(),")");else if(w=="}"){for(;V.type=="statement";)V=T(M);for(V.type=="}"&&(V=T(M));V.type=="statement";)V=T(M)}else w==V.type?T(M):(V.type=="}"||V.type=="top"||V.type=="statement"&&w=="newstatement")&&P(M,R.column(),"statement");return M.startOfLine=!1,B},indent:function(R,M){if(R.tokenize!=b&&R.tokenize!=null)return 0;var V=M&&M.charAt(0),B=R.context,F=V==B.type;return B.type=="statement"?B.indented+(V=="{"?0:l):B.align?B.column+(F?0:1):B.indented+(F?0:l)},electricChars:"{}"}});function e(s){for(var a={},l=s.split(" "),d=0;d<l.length;++d)a[l[d]]=!0;return a}var t="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor",n="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod require export";function r(s,a){return a.startOfLine?(s.skipToEnd(),"meta"):!1}(function(){i.defineMIME("text/x-glsl",{name:"glsl",keywords:e(t),builtins:e(n),blockKeywords:e("case do else for if switch while struct"),atoms:e("null"),hooks:{"#":r}})})()}),Hk}var j6=H6();const q6=Qe(j6);/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/q6(ls);const J6=500;class _y extends Y{constructor(e){super(),this.state=e,this.changingValue=!1,this.debouncedValueUpdater=nt(()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}},J6),this.textEditor=ls(r=>{},{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",()=>{this.setValidState(void 0),this.debouncedValueUpdater()}),this.registerDisposer(this.state.fragmentMain.changed.add(()=>{this.changingValue||this.textEditor.setValue(this.state.fragmentMain.value)})),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add(()=>{this.updateErrorState()}));const t=this.state.shaderControlState;t!==void 0&&this.registerDisposer(t.parseErrors.changed.add(()=>{this.updateErrorState()})),this.updateErrorState();const n=new IntersectionObserver(r=>{r.some(s=>s.isIntersecting)&&this.textEditor.refresh()},{root:document.body});n.observe(this.element),this.registerDisposer(()=>n.disconnect())}get element(){return this.textEditor.getWrapperElement()}updateErrorState(){var e=this.state.sourceStringNumber;const t=e===void 0?1:e,n=this.state.shaderError.value;let r;const s=this.state.shaderControlState;s!==void 0?r=s.parseErrors.value:r=[],n===void 0&&r.length===0?this.setValidState(void 0):n!=null||r.length!==0?(this.textEditor.setOption("lint",{getAnnotations:()=>{const a=[];for(const l of r)a.push({message:l.message,severity:"error",from:ls.Pos(l.line)});if(n!=null)if(n.name==="ShaderCompilationError")for(const l of n.errorMessages)a.push({message:l.message,severity:"error",from:ls.Pos(l.file===t&&l.line||0)});else n.name==="ShaderLinkError"?a.push({message:n.log,severity:"error",from:ls.Pos(0)}):a.push({message:n.message,severity:"error",from:ls.Pos(0)});return a}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){let t=this.element;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),e===!0?t.classList.add("valid-input"):e===!1&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,kt(this.element),this.textEditor=void 0,super.disposed()}}const X6=at.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function K6(i){return{makeControl:(e,t,n)=>{var r=i(e);const s=r.watchableValue,a=r.channelCoordinateSpaceCombiner,l=r.dataType,d=r.defaultChannel,u=r.histogramSpecifications,h=r.legendShaderOptions,g=r.histogramIndex;if(a!==void 0&&d.length!==0){const y=t.registerDisposer(new js(a.combined)),C=t.registerDisposer(new Dh(y,a,{copyButton:!1}));t.registerDisposer(y.changed.add(()=>{const b=y.value,k=Ee(b,I=>Math.floor(I)),L=s.value;Oe(L.channel,k)||(s.value=H(H({},s.value),{channel:k}))}));const w=()=>{const b=y.value,k=s.value;Oe(b,k.channel)||(b.set(k.channel),y.changed.dispatch())};w(),t.registerDisposer(s.changed.add(w)),n.labelContainer.appendChild(C.element)}const v=t.registerDisposer(new E6(n.visibility,n.display,l,s,u,g,d.length===0?h:void 0));return{control:v,controlElement:v.element}},activateTool:(e,t)=>{e.bindInputEventMap(X6),e.bindAction("adjust-contrast-via-wheel",n=>{n.stopPropagation();const r=xu(n.detail);x6(t.dataType,t.trackable,r)}),e.bindAction("adjust-via-drag",n=>{n.stopPropagation();let r=n.detail.screenX,s=n.detail.screenY,a=t.trackable.value.range,l=a,d=r,u=s;Rn(n.detail,h=>{const g=t.trackable.value.range,v=h.screenX,y=h.screenY;xr(t.dataType,g,l)||(a=g,r=d,s=u),k6(t.dataType,t.trackable,a,(y-s)*2/screen.height,(v-r)*4/screen.width),l=t.trackable.value.range,d=v,u=y})}),e.bindAction("invert-range",n=>{n.stopPropagation(),MP(t.trackable)})}}}/**
* @license
* Copyright 2021 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function Hl(i){return{makeControl:(e,t)=>{const n=i(e),r=t.registerDisposer(new Es(n));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}/**
* @license
* Copyright 2021 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const Y6=at.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function FP(i){return{makeControl:(e,t)=>{const n=i(e),r=t.registerDisposer(new my(n));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{e.bindInputEventMap(Y6),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustHueViaWheel(n.detail)})}}}class Z6 extends Y{constructor(e,{min:t=0,max:n=1,step:r=.01}={}){super(),this.value=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input"),this.numericInputElement=document.createElement("input");let s=this.element,a=this.inputElement,l=this.numericInputElement;s.className="range-slider";const d=h=>{h.min=""+t,h.max=""+n,h.step=""+r,h.valueAsNumber=this.value.value,this.registerEventListener(h,"change",()=>this.inputValueChanged(h)),this.registerEventListener(h,"input",()=>this.inputValueChanged(h)),this.registerEventListener(h,"wheel",g=>{this.adjustViaWheel(h,g)})};a.type="range",d(a),l.type="number";const u=Math.max(t.toString().length,n.toString().length,Math.min(n,t+r).toString().length,Math.max(t,n-r).toString().length);l.style.width=u+2+"ch",d(l),s.appendChild(a),s.appendChild(l),e.changed.add(()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value})}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){const n=this.inputElement;let r=t.deltaY;r>0?(n.stepUp(),this.inputValueChanged(e)):r<0&&(n.stepDown(),this.inputValueChanged(e))}disposed(){kt(this.element),super.disposed()}}/**
* @license
* Copyright 2021 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const Q6=at.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function cs(i){return{makeControl:(e,t)=>{var n=i(e);const r=n.value,s=n.options,a=t.registerDisposer(new Z6(r,s));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(Q6),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustViaWheel(t.inputElement,n.detail)})}}}function qk(i,e){const t=i.shaderControlState,n=t.state.get(e);if(n===void 0)return;const r=n.control;switch(r.type){case"slider":return cs(()=>({value:n.trackable,options:{min:r.min,max:r.max,step:r.step}}));case"color":return FP(()=>n.trackable);case"checkbox":return Hl(()=>n.trackable);case"invlerp":{let a=0;for(const l of t.state){var s=ae(l,2);const d=s[0],u=s[1].control.type;if(d===e)break;u==="invlerp"&&++a}return K6(()=>({dataType:r.dataType,defaultChannel:r.default.channel,watchableValue:n.trackable,channelCoordinateSpaceCombiner:t.channelCoordinateSpaceCombiner,histogramSpecifications:t.histogramSpecifications,histogramIndex:a,legendShaderOptions:i.legendShaderOptions}))}}}function UP(i,e,t){return{label:t,toolJson:eH(t,e),makeControl:(n,r,s)=>{const a=i(n);return qk(a,t).makeControl(n,r,s)},activateTool:(n,r)=>{const s=i(n.tool.layer);return qk(s,t).activateTool(n,r)}}}class Fy extends _r{constructor(e,t,n,r={}){super(r.visibility),this.state=e,this.display=t,this.layer=n,this.options=r,this.controlDisposer=void 0;var s=r.toolId;const a=s===void 0?zP:s;this.toolId=a;const l=this.element;l.style.display="contents";const d=e.controls;this.registerDisposer(d.changed.add(this.registerCancellable(nt(()=>this.updateControls(),0)))),this.updateControls()}updateControls(){const e=this.element;this.controlDisposer!==void 0&&(this.controlDisposer.dispose(),Ke(e));const t=this.controlDisposer=new Y,n=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(const r of this.state.state.keys())e.appendChild(Oy(t,this.layer,this.visibility,UP(n,this.toolId,r)))}disposed(){var e;(e=this.controlDisposer)===null||e===void 0||e.dispose(),super.disposed()}}const zP="shaderControl",$P="control";function eH(i,e){return{type:e,[$P]:i}}class tH extends BP{constructor(e,t,n,r){super(e,UP(()=>t,n,r)),this.layerShaderControls=t,this.control=r,this.registerDisposer(t.shaderControlState.controls.changed.add(this.registerCancellable(nt(()=>{t.shaderControlState.state.get(r)===void 0&&this.unbind()}))))}activate(e){this.layerShaderControls.shaderControlState.state.get(this.control)!==void 0&&super.activate(e)}}function Uy(i,e,t=zP){oc(i,t,(n,r)=>{const s=K(r,$P,Le);return new tH(n,e(n),t,s)})}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function GP(i){return new _y({fragmentMain:i.displayState.skeletonRenderingOptions.shader,shaderError:i.displayState.shaderError,shaderControlState:i.displayState.skeletonRenderingOptions.shaderControlState})}class iH extends _r{constructor(e){super(),this.layer=e;const t=this.element;t.classList.add("neuroglancer-segmentation-rendering-tab");{const r=this.registerDisposer(new Gk(e.displayState.linkedSegmentationGroup));r.label.textContent="Linked to: ",t.appendChild(r.element)}{const r=this.registerDisposer(new Gk(e.displayState.linkedSegmentationColorGroup));r.label.textContent="Colors linked to: ",t.appendChild(r.element)}for(const r of jP)t.appendChild(Oy(this,e,this.visibility,r));const n=this.registerDisposer(new Qn(e.hasSkeletonsLayer,(r,s,a)=>{if(!r)return;let l=document.createElement("div");l.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let d=document.createElement("div");d.style.flex="1",d.textContent="Skeleton shader:",l.appendChild(d),l.appendChild(By({title:"Show larger editor view",onClick:()=>{new nH(this.layer)}})),l.appendChild(Vy({title:"Documentation on skeleton rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),s.appendChild(l);const u=a.registerDisposer(GP(this.layer));s.appendChild(u.element),s.appendChild(a.registerDisposer(new Fy(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:HP})).element),u.textEditor.refresh()},this.visibility));t.appendChild(n.element)}}let nH=class extends Ph{constructor(i){super(),this.layer=i,this.codeWidget=this.registerDisposer(GP(this.layer)),this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};/**
* @license
* This work is a derivative of the Google Neuroglancer project,
* Copyright 2016 Google Inc.
* The Derivative Work is covered by
* Copyright 2019 Howard Hughes Medical Institute
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var rH=function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=An(e,t):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(a=i[l])&&(s=(r<3?a(s):r>3?a(e,t,s):a(e,t))||s);return r>3&&s&&Mn(e,t,s),s},Cm;let xm=Cm=class extends sh{constructor(){super(...arguments),this.hashTable=new Hv,this.changed=new Ze}get value(){return this}static makeWithCounterpart(i){let e=new Cm;return e.initializeCounterpart(i),e}set_(i,e){return this.hashTable.set(i,e)}set(i,e){if(this.set_(i,e)){let t=this.rpc;t&&t.invoke("Uint64Map.set",{id:this.rpcId,key:i,value:e}),this.changed.dispatch(i,!0)}}has(i){return this.hashTable.has(i)}get(i,e){return this.hashTable.get(i,e)}[Mi](){return this.hashTable.entries()}unsafeEntries(){return this.hashTable.unsafeEntries()}delete_(i){return this.hashTable.delete(i)}delete(i){if(this.delete_(i)){let e=this.rpc;e&&e.invoke("Uint64Map.delete",{id:this.rpcId,key:i}),this.changed.dispatch(i,!1)}}get size(){return this.hashTable.size}assignFrom(i){this.clear();for(const t of i.unsafeEntries()){var e=ae(t,2);const n=e[0],r=e[1];this.set(n,r)}}clear(){if(this.hashTable.clear()){let i=this.rpc;i&&i.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let i={};for(let t of this.hashTable.unsafeEntries()){var e=ae(t,2);let n=e[0],r=e[1];i[n.toString()]=r.toString()}return i}};xm=Cm=rH([ah("Uint64Map")],xm);Et("Uint64Map.set",function(i){let e=this.get(i.id);e.set_(i.key,i.value)&&e.changed.dispatch()});Et("Uint64Map.delete",function(i){let e=this.get(i.id);e.delete_(i.key)&&e.changed.dispatch()});Et("Uint64Map.clear",function(i){let e=this.get(i.id);e.hashTable.clear()&&e.changed.dispatch()});/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var sH=function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=An(e,t):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(a=i[l])&&(s=(r<3?a(s):r>3?a(e,t,s):a(e,t))||s);return r>3&&s&&Mn(e,t,s),s},km;let Nu=km=class extends sh{constructor(){super(...arguments),this.hashTable=new gT,this.changed=new Ze}get value(){return this}static makeWithCounterpart(i){let e=new km;return e.initializeCounterpart(i),e}set(i,e){e?this.add(i):this.delete(i)}reserve_(i){return this.hashTable.reserve(i)}reserve(i){if(this.reserve_(i)){let e=this.rpc;e&&e.invoke("Uint64Set.reserve",{id:this.rpcId,value:i})}}add_(i){let e=!1;for(const t of i)e=this.hashTable.add(t)||e;return e}add(i){const e=Array().concat(i);if(this.add_(e)){let t=this.rpc;t&&t.invoke("Uint64Set.add",{id:this.rpcId,value:e}),this.changed.dispatch(i,!0)}}has(i){return this.hashTable.has(i)}[Mi](){return this.hashTable.keys()}unsafeKeys(){return this.hashTable.unsafeKeys()}delete_(i){let e=!1;for(const t of i)e=this.hashTable.delete(t)||e;return e}delete(i){const e=Array().concat(i);if(this.delete_(Array().concat(i))){let t=this.rpc;t&&t.invoke("Uint64Set.delete",{id:this.rpcId,value:e}),this.changed.dispatch(i,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let i=this.rpc;i&&i.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let i=new Array;for(let e of this.unsafeKeys())i.push(e.toString());return i.sort(),i}assignFrom(i){this.clear();for(const e of i.unsafeKeys())this.add(e)}};Nu=km=sH([ah("Uint64Set")],Nu);Et("Uint64Set.reserve",function(i){let e=this.get(i.id);e.reserve_(i.value)&&e.changed.dispatch()});Et("Uint64Set.add",function(i){let e=this.get(i.id);e.add_(i.value)&&e.changed.dispatch()});Et("Uint64Set.delete",function(i){let e=this.get(i.id);e.delete_(i.value)&&e.changed.dispatch()});Et("Uint64Set.clear",function(i){let e=this.get(i.id);e.hashTable.clear()&&e.changed.dispatch()});/**
* @license
* Copyright 2021 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const aH=at.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function WP(i){return{makeControl:(e,t)=>{const n=i(e),r=t.registerDisposer(new ED(n));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{e.bindInputEventMap(aH),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustViaWheel(n.detail)})}}}const oH=200,Jk=at.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});function lH(i){if(i<1||i>1024){const e=Fi(i)|0,t=i/2**e;return`${cD(t,1)}p${e}`}return Math.round(i)+""}class Em extends Y{constructor(e,t){super(),this.histogram=e,this.target=t,this.label=document.createElement("div"),this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.legend=document.createElement("div"),this.legendRenderScale=document.createElement("div"),this.legendSpatialScale=document.createElement("div"),this.legendChunks=document.createElement("div"),this.ctx=this.canvas.getContext("2d"),this.hoverTarget=new ct(void 0),this.throttledUpdateView=this.registerCancellable(hh(()=>this.debouncedUpdateView(),oH,{leading:!0,trailing:!0})),this.debouncedUpdateView=this.registerCancellable(nt(()=>this.updateView(),0));const n=this.canvas,r=this.label,s=this.element,a=this.legend,l=this.legendRenderScale,d=this.legendSpatialScale,u=this.legendChunks;r.className="neuroglancer-render-scale-widget-prompt",s.className="neuroglancer-render-scale-widget",s.title=Jk.describe(),a.className="neuroglancer-render-scale-widget-legend",s.appendChild(r),s.appendChild(n),s.appendChild(a),l.title="Target resolution of data in screen pixels",u.title="Number of chunks rendered",a.appendChild(l),a.appendChild(u),a.appendChild(d),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new Br(n,Jk)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));const h=v=>{const y=v.offsetX/n.width*jt;return v_(y)};this.registerEventListener(n,"pointermove",v=>{this.hoverTarget.value=[h(v),v.offsetY]}),this.registerEventListener(n,"pointerleave",()=>{this.hoverTarget.value=void 0}),this.registerDisposer(ve(n,"set",v=>{this.target.value=h(v.detail)})),this.registerDisposer(ve(n,"adjust-via-wheel",v=>{this.adjustViaWheel(v.detail)})),this.registerDisposer(ve(n,"reset",v=>{this.reset(),v.preventDefault()}));const g=new ResizeObserver(()=>this.debouncedUpdateView());g.observe(n),this.registerDisposer(()=>g.disconnect()),this.updateView()}adjustViaWheel(e){const t=e.deltaY;t!==0&&(this.hoverTarget.value=void 0,this.target.value*=2**ic(t),e.preventDefault())}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){const e=this.ctx,t=this.canvas,n=t.width=t.offsetWidth,r=t.height=t.offsetHeight,s=this.target.value,a=this.hoverTarget.value;{const T=this.legendRenderScale,R=a===void 0?s:a[0],M=lH(R);T.textContent=M+" px"}function l(T){return T*n/jt}e.clearRect(0,0,n,r);const d=this.histogram,u=d.value,h=d.spatialScales;d.visibility.visible||u.fill(0);const g=Ee(h.keys());g.sort();const v=Ne();let y=1;const C=h.size;let w=0,b=0;for(let T=0;T<jt;++T){let R=0;for(let M=0;M<C;++M){const V=M*jt*2+T,B=u[V],F=u[V+jt];w+=B,b+=F,R+=B+F}y=Math.max(R,y)}const k=r/Math.log(1+y);function L(T){return r-Math.log(1+T)*k}let I;if(a!==void 0){const T=Math.floor(jd(a[0]));if(T>=0&&T<jt){let R=0;const M=a[1];for(let V=C-1;V>=0;--V){const B=g[V],F=2*h.get(B)*jt+T,j=u[F]+u[F+jt];if(j===0)continue;const U=Math.round(L(R));if(R+=j,Math.round(L(R))<=M&&M<=U){I=B;break}}}}if(I!==void 0){w=0,b=0;const T=2*h.get(I)*jt;for(let R=0;R<jt;++R){const M=T+R;w+=u[M],b+=u[M+jt]}gt(I)?this.legendSpatialScale.textContent=Qs(I,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${w}/${w+b}`;const P=g.map(T=>{const R=T===I?.5:1;let M;gt(T)?M=(Fi(T)*.1%1+1)%1:M=0,Su(v,M,R,1);const V=Ii(v);Su(v,M,R,.5);const B=Ii(v);return[V,B]});for(let T=0;T<jt;++T){let R=0;for(let M=C-1;M>=0;--M){const V=g[M],B=h.get(V)*jt*2+T,F=u[B],j=u[B+jt],U=F+j;if(U===0)continue;const O=Math.round(l(T)),$=Math.round(l(T+1)),_=Math.round(L(R));R+=U;const se=Math.round(L(R)),oe=(F*se+j*_)/U;e.fillStyle=P[M][1],e.fillRect(O,se,$-O,oe-se),e.fillStyle=P[M][0],e.fillRect(O,oe,$-O,_-oe)}}{const T=s;e.fillStyle="#fff";const R=l(jd(T));e.fillRect(Math.floor(R),0,1,r)}if(a!==void 0){const T=a[0];e.fillStyle="#888";const R=l(jd(T));e.fillRect(Math.floor(R),0,1,r)}}}const cH=at.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function Vu(i){return{makeControl:(e,t)=>{var n=i(e);const r=n.histogram,s=n.target,a=t.registerDisposer(new Em(r,s));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(cH),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustViaWheel(n.detail)}),e.bindAction("reset",n=>{n.stopPropagation(),n.preventDefault(),t.reset()})}}}const dH="data:image/svg+xml,%3csvg%20role='img'%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20aria-labelledby='rotateIconTitle'%3e%3ctitle%20id='rotateIconTitle'%3eRotate%3c/title%3e%3cpath%20d='M22%2012l-3%203-3-3'/%3e%3cpath%20d='M2%2012l3-3%203%203'/%3e%3cpath%20d='M19.016%2014v-1.95A7.05%207.05%200%200%200%208%206.22'/%3e%3cpath%20d='M16.016%2017.845A7.05%207.05%200%200%201%205%2012.015V10'/%3e%3cpath%20stroke-linecap='round'%20d='M5%2010V9'/%3e%3cpath%20stroke-linecap='round'%20d='M19%2015v-1'/%3e%3c/svg%3e";function Ou(i,e){e?i.displayState.segmentDefaultColor.value=lt(1,0,0):i.displayState.segmentDefaultColor.value=void 0}function uH(){const i=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(e,t,{labelTextContainer:n})=>{const r=document.createElement("input");r.type="radio",r.addEventListener("change",()=>{Ou(e,!r.checked)}),n.prepend(r);const s=document.createElement("div");s.classList.add("neuroglancer-segmentation-color-seed-control");const a=t.registerDisposer(new ID(e.displayState.segmentColorHash));s.appendChild(a.element);const l=ft({svg:dH,title:"Randomize",onClick:()=>i(e)});return s.appendChild(l),t.registerDisposer(Lr(d=>{const u=d===void 0;s.style.visibility=u?"":"hidden",r.checked=u},e.displayState.segmentDefaultColor)),{controlElement:s,control:a}},activateTool:e=>{const t=e.tool.layer;Ou(t,!1),i(t)}}}function hH(){const i=FP(e=>e.displayState.segmentDefaultColor);return H(H({},i),{makeControl:(e,t,n)=>{const r=i.makeControl(e,t,n),s=r.controlElement,a=document.createElement("input");return a.type="radio",a.addEventListener("change",()=>{Ou(e,a.checked),a.checked&&s.click()}),n.labelTextContainer.prepend(a),t.registerDisposer(Lr(l=>{const d=l!==void 0;s.style.visibility=d?"":"hidden",a.checked=d},e.displayState.segmentDefaultColor)),r},activateTool:(e,t)=>{Ou(e.tool.layer,!0),i.activateTool(e,t)}})}const Lm="selectedAlpha",Tm="notSelectedAlpha",Dm="objectAlpha",Pm="saturation",Im="hideSegmentZero",Rm="baseSegmentColoring",Mm="ignoreNullVisibleSet",pH="mesh",fH="skeletons",Xk="segments",Bu="equivalences",Am="colorSeed",Kk="segmentColors",Nm="meshRenderScale",Vm="crossSectionRenderScale",_u="skeletonRendering",gH="skeletonShader",Yk="segmentQuery",Om="meshSilhouetteRendering",Zk="linkedSegmentationGroup",Qk="linkedSegmentationColorGroup",Bm="segmentDefaultColor",eE="anchorSegment",HP="skeletonShaderControl";class mH extends Y{constructor(e){super(),this.layer=e,this.specificationChanged=new Ze,this.localGraph=new mW,this.visibleSegments=this.registerDisposer(Nu.makeWithCounterpart(this.layer.manager.rpc)),this.segmentPropertyMap=new ct(void 0),this.graph=new ct(void 0),this.segmentEquivalences=this.registerDisposer(lc.makeWithCounterpart(this.layer.manager.rpc,this.layer.registerDisposer(cn(n=>n&&n.visibleSegmentEquivalencePolicy||Pn.MIN_REPRESENTATIVE,[this.graph])))),this.localSegmentEquivalences=!1,this.maxIdLength=new ct(1),this.hideSegmentZero=new _t(!0,!0),this.segmentQuery=new Jt("",Le),this.temporaryVisibleSegments=this.layer.registerDisposer(Nu.makeWithCounterpart(this.layer.manager.rpc)),this.temporarySegmentEquivalences=this.layer.registerDisposer(lc.makeWithCounterpart(this.layer.manager.rpc,this.segmentEquivalences.disjointSets.visibleSegmentEquivalencePolicy)),this.useTemporaryVisibleSegments=this.layer.registerDisposer(gi.make(this.layer.manager.rpc,!1)),this.useTemporarySegmentEquivalences=this.layer.registerDisposer(gi.make(this.layer.manager.rpc,!1));const t=this.specificationChanged;this.visibleSegments.changed.add(t.dispatch),this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch)}restoreState(e){ye(e,Im,t=>this.hideSegmentZero.restoreState(t)),ye(e,Bu,t=>{this.localGraph.restoreState(t)}),ye(e,Xk,t=>{const n=this.segmentEquivalences,r=this.visibleSegments;We(t,s=>{let a=te.parseString(String(s),10);r.add(n.get(a))})}),ye(e,Yk,t=>this.segmentQuery.restoreState(t))}toJSON(){const e={};e[Im]=this.hideSegmentZero.toJSON();let t=this.visibleSegments;t.size>0&&(e[Xk]=t.toJSON());let n=this.segmentEquivalences;return this.localSegmentEquivalences&&n.size>0&&(e[Bu]=n.toJSON()),e[Yk]=this.segmentQuery.toJSON(),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences)}}class vH extends Y{constructor(e){super(),this.layer=e,this.specificationChanged=new Ze,this.segmentColorHash=Xv.getDefault(),this.segmentStatedColors=this.registerDisposer(new xm),this.segmentDefaultColor=new nV;const t=this.specificationChanged;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch)}restoreState(e){ye(e,Am,t=>this.segmentColorHash.restoreState(t)),ye(e,Bm,t=>this.segmentDefaultColor.restoreState(t)),ye(e,Kk,t=>{let n=av(t,s=>Ao(String(s)));for(let s of n){var r=ae(s,2);let a=r[0],l=r[1];const d=te.parseString(String(a)),u=new te(vg(l));this.segmentStatedColors.set(d,u)}})}toJSON(){const e={};e[Am]=this.segmentColorHash.toJSON(),e[Bm]=this.segmentDefaultColor.toJSON();const t=this.segmentStatedColors;if(t.size>0){const r=e[Kk]={};for(const s of t.unsafeEntries()){var n=ae(s,2);const a=n[0],l=n[1];r[a.toString()]=Ii(eo(l.low))}}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.segmentDefaultColor.value=e.segmentDefaultColor.value}}class tE extends Y{constructor(e,t){super(),this.linkedGroup=e,this.propertyName=t,this.value}get changed(){return this.linkedGroup.root.changed}get value(){const e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;const t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){const n=this.curGroupState;n!==void 0&&(t.assignFrom(n),n.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){var e;(e=this.curGroupState)===null||e===void 0||e.dispose()}}class yH{constructor(e){this.layer=e,this.segmentSelectionState=new bU,this.selectedAlpha=Bl(.5),this.saturation=Bl(1),this.notSelectedAlpha=Bl(0),this.silhouetteRendering=new Jt(0,gL,0),this.objectAlpha=Bl(1),this.ignoreNullVisibleSet=new _t(!0,!0),this.skeletonRenderingOptions=new WU,this.shaderError=lh(),this.renderScaleHistogram=new vo,this.renderScaleTarget=ta(1),this.selectSegment=this.layer.selectSegment,this.transparentPickEnabled=this.layer.pick,this.baseSegmentColoring=new _t(!1,!1),this.filterBySegmentLabel=this.layer.filterBySegmentLabel,this.moveToSegment=t=>{this.layer.moveToSegment(t)},this.linkedSegmentationGroup=this.layer.registerDisposer(new bk(this.layer.manager.rootLayers,this.layer,t=>t instanceof qt,t=>t.displayState.linkedSegmentationGroup)),this.linkedSegmentationColorGroup=this.layer.registerDisposer(new bk(this.layer.manager.rootLayers,this.layer,t=>t instanceof qt,t=>t.displayState.linkedSegmentationColorGroup)),this.originalSegmentationGroupState=this.layer.registerDisposer(new mH(this.layer)),this.originalSegmentationColorGroupState=this.layer.registerDisposer(new vH(this.layer)),e.displayState=this,this.segmentationGroupState=this.layer.registerDisposer(new tE(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new tE(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.hideSegmentZero=this.layer.registerDisposer(new zd(this.segmentationGroupState,t=>t.hideSegmentZero)),this.segmentColorHash=this.layer.registerDisposer(new cf(this.segmentationColorGroupState,t=>t.segmentColorHash)),this.segmentStatedColors=this.layer.registerDisposer(new cf(this.segmentationColorGroupState,t=>t.segmentStatedColors)),this.segmentDefaultColor=this.layer.registerDisposer(new cf(this.segmentationColorGroupState,t=>t.segmentDefaultColor)),this.segmentQuery=this.layer.registerDisposer(new zd(this.segmentationGroupState,t=>t.segmentQuery)),this.segmentPropertyMap=this.layer.registerDisposer(new zd(this.segmentationGroupState,t=>t.segmentPropertyMap))}}const SH=Ry(Wo);class qt extends SH{constructor(e){super(e),this.sliceViewRenderScaleHistogram=new vo,this.sliceViewRenderScaleTarget=ta(1),this.segmentQueryFocusTime=new ct(Number.NEGATIVE_INFINITY),this.selectSegment=(t,n)=>{this.manager.root.selectionState.captureSingleLayerState(this,r=>(r.value=t.clone(),!0),n)},this.filterBySegmentLabel=t=>{const n=xo(this.displayState,t).label;n&&this.filterSegments(n)},this.filterSegments=t=>{this.displayState.segmentationGroupState.value.segmentQuery.value=t,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer},this.displayState=new yH(this),this.anchorSegment=new Jt(void 0,t=>t===void 0?void 0:te.parseString(t)),this.has2dLayer=this.registerDisposer(jn(t=>t.some(n=>n instanceof Yf),{changed:this.layersChanged,value:this.renderLayers})),this.has3dLayer=this.registerDisposer(jn(t=>t.some(n=>n instanceof g1||n instanceof Bf||n instanceof _f||n instanceof E1),{changed:this.layersChanged,value:this.renderLayers})),this.hasSkeletonsLayer=this.registerDisposer(jn(t=>t.some(n=>n instanceof _f),{changed:this.layersChanged,value:this.renderLayers})),this.registerDisposer(ao((t,n)=>{t.registerDisposer(n.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationGroupState)),this.registerDisposer(ao((t,n)=>{t.registerDisposer(n.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new iH(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new z6(this)}),this.tabs.default="rendering"}bindSegmentListWidth(e){return sc(this.displayState,e)}get volumeOptions(){return{volumeType:fi.SEGMENTATION}}activateDataSubsources(e){const t=[],n=this.displayState.linkedSegmentationGroup.root.value===this;let r;for(const a of e){if(this.addStaticAnnotations(a))continue;var s=a.subsourceEntry.subsource;const l=s.volume,d=s.mesh,u=s.segmentPropertyMap,h=s.segmentationGraph,g=s.local;if(l instanceof Ds){switch(l.dataType){case q.FLOAT32:a.deactivate("Data type not compatible with segmentation layer");continue}a.activate(()=>a.addRenderLayer(new Yf(l,H(H({},this.displayState),{transform:a.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition}))),this.displayState.segmentationGroupState.value)}else d!==void 0?a.activate(()=>{const v=H(H({},this.displayState),{transform:a.getRenderLayerTransform()});if(d instanceof Ac)a.addRenderLayer(new g1(this.manager.chunkManager,d,v));else if(d instanceof yh)a.addRenderLayer(new Bf(this.manager.chunkManager,d,v));else{const y=new HU(this.manager.chunkManager,d,v);a.addRenderLayer(new _f(y.addRef())),a.addRenderLayer(new E1(y))}},this.displayState.segmentationGroupState.value):u!==void 0?n?(a.activate(()=>{}),t.push(u)):a.deactivate("Not supported on non-root linked segmentation layers"):h!==void 0?n?r!==void 0?a.deactivate("Only one segmentation graph is supported"):(r=h,a.activate(v=>{this.graphConnection=v.registerDisposer(h.connect(this.displayState.segmentationGroupState.value));const y=H(H({},this.displayState),{transform:a.getRenderLayerTransform()}),C=this.graphConnection.createRenderLayers(this.manager.chunkManager,y,this.localPosition);for(const w of C)a.addRenderLayer(w)})):a.deactivate("Not supported on non-root linked segmentation layers"):g===Rr.equivalences?n?r!==void 0?a.deactivate("Only one segmentation graph is supported"):(r=this.displayState.originalSegmentationGroupState.localGraph,a.activate(v=>{this.graphConnection=v.registerDisposer(r.connect(this.displayState.segmentationGroupState.value)),v.registerDisposer(()=>{this.graphConnection=void 0})})):a.deactivate("Not supported on non-root linked segmentation layers"):a.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=iW(this.manager.chunkManager,t),this.displayState.originalSegmentationGroupState.graph.value=r}getLegacyDataSourceSpecifications(e,t,n,r){const s=super.getLegacyDataSourceSpecifications(e,t,n,r),a=ye(t,pH,d=>d===null?null:Le(d)),l=ye(t,fH,d=>d===null?null:Le(d));if(a!==void 0||l!==void 0)for(const d of s)d.enableDefaultSubsources=!1,d.subsources=new ce([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return a!=null&&s.push($l(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:a,type:"mesh"}))),l!=null&&s.push($l(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:l,type:"skeletons"}))),t[Bu]!==void 0&&r.find(d=>d.url===Fg)===void 0&&s.push({url:Fg,enableDefaultSubsources:!0,transform:{outputSpace:uo,sourceRank:0,transform:void 0,inputSpace:uo},subsources:new ce}),s}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[Lm]),this.displayState.saturation.restoreState(e[Pm]),this.displayState.notSelectedAlpha.restoreState(e[Tm]),this.displayState.objectAlpha.restoreState(e[Dm]),this.displayState.baseSegmentColoring.restoreState(e[Rm]),this.displayState.silhouetteRendering.restoreState(e[Om]),this.displayState.ignoreNullVisibleSet.restoreState(e[Mm]);const t=this.displayState.skeletonRenderingOptions;t.restoreState(e[_u]);const n=e[gH];n!==void 0&&t.shader.restoreState(n),this.displayState.renderScaleTarget.restoreState(e[Nm]),this.anchorSegment.restoreState(e[eE]),this.sliceViewRenderScaleTarget.restoreState(e[Vm]);const r=ye(e,Zk,Le);r!==void 0&&this.displayState.linkedSegmentationGroup.linkByName(r);const s=ye(e,Qk,a=>a===!1?void 0:Le(a),r);s!==void 0&&this.displayState.linkedSegmentationColorGroup.linkByName(s),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){var e;const t=super.toJSON();t[Lm]=this.displayState.selectedAlpha.toJSON(),t[Tm]=this.displayState.notSelectedAlpha.toJSON(),t[Pm]=this.displayState.saturation.toJSON(),t[Dm]=this.displayState.objectAlpha.toJSON(),t[Rm]=this.displayState.baseSegmentColoring.toJSON(),t[Mm]=this.displayState.ignoreNullVisibleSet.toJSON(),t[Om]=this.displayState.silhouetteRendering.toJSON(),t[eE]=this.anchorSegment.toJSON(),t[_u]=this.displayState.skeletonRenderingOptions.toJSON(),t[Nm]=this.displayState.renderScaleTarget.toJSON(),t[Vm]=this.sliceViewRenderScaleTarget.toJSON();var n=this.displayState;const r=n.linkedSegmentationGroup,s=n.linkedSegmentationColorGroup;return t[Zk]=r.toJSON(),s.root.value!==r.root.value&&(t[Qk]=(e=s.toJSON())!==null&&e!==void 0?e:!1),t[Bu]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),r.root.value===this&&H(t,this.displayState.segmentationGroupState.value.toJSON()),s.root.value===this&&H(t,this.displayState.segmentationColorGroupState.value.toJSON()),t}transformPickedValue(e){return e==null?e:IT(this.displayState,e,!0)}handleAction(e,t){switch(e){case"recolor":{this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break}case"clear-segments":{if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break}case"select":{if(!this.pick.value)break;const n=this.displayState.segmentSelectionState;if(n.hasSelectedSegment){const r=n.selectedSegment,s=this.displayState.segmentationGroupState.value.visibleSegments,a=!s.has(r);(a||t.segmentationToggleSegmentState===void 0)&&(t.segmentationToggleSegmentState=a),t.defer(()=>{t.segmentationToggleSegmentState===a&&s.set(r,a)})}break}case"copy-segment-id":{if(!this.pick.value)break;const n=this.displayState.segmentSelectionState;if(n.hasSelectedSegment){const r=n.selectedSegment;this.copiedSegments=[r.clone()];const s=r.toString();Ji(s)&&Ye.showTemporaryMessage(s+" copied to clipboard")}break}case"add-copy-segment-id":{if(!this.pick.value)break;const n=this.displayState.segmentSelectionState;if(n.hasSelectedSegment){const r=n.selectedSegment;this.copiedSegments.push(r.clone());const s=this.copiedSegments.map(a=>a.toString()).join(",");Ji(s)&&Ye.showTemporaryMessage(s+" copied to clipboard")}break}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);const n=new te;let r=e.value;typeof r=="number"&&(r=r.toString()),typeof r!="string"||!n.tryParseString(r)?e.value=void 0:e.value=n}selectionStateToJson(e,t){const n=super.selectionStateToJson(e,t);let r=e.value;return r instanceof vs?t?n.value={key:r.key.toString(),value:r.value?r.value.toString():void 0,label:r.label}:n.value=(r.value||r.key).toString():r instanceof te&&(n.value=r.toString()),n}displaySegmentationSelection(e,t,n){const r=e.value;let s;if((typeof r=="number"||typeof r=="string")&&(s=new te,!s.tryParseString(r.toString())))return!1;if(r instanceof te)s=r.clone();else if(r instanceof vs)s=r.key.clone();else return!1;const a=this.displayState,l=xo(a,s);var d=this.displayState.segmentationGroupState.value;const u=d.segmentEquivalences,h=d.segmentPropertyMap.value,g=u.get(s),v=ey(this.displayState,l);if(Mc(a,n,n.redraw),n.registerDisposer(sc(a,v)),v.classList.add("neuroglancer-selection-details-segment"),t.appendChild(v),h!==void 0){const y=h.segmentPropertyMap.inlineProperties;if(y!==void 0){const C=h.getSegmentInlineIndex(g);if(C!==-1){for(const w of y.properties)if(w.type!=="label"){if(w.type==="description"){const b=w.values[C];if(!b)continue;const k=document.createElement("div");k.classList.add("neuroglancer-selection-details-segment-description"),k.textContent=b,t.appendChild(k)}else if(w.type==="number"||w.type==="string"){const b=w.values[C];if(w.type==="number"?isNaN(b):!b)continue;const k=document.createElement("div");k.classList.add("neuroglancer-selection-details-segment-property");const L=document.createElement("div");L.classList.add("neuroglancer-selection-details-segment-property-name"),L.textContent=w.id,w.description&&(L.title=w.description);const I=document.createElement("div");I.classList.add("neuroglancer-selection-details-segment-property-value"),I.textContent=b.toString(),k.appendChild(L),k.appendChild(I),t.appendChild(k)}}}}}return!0}displaySelectionState(e,t,n){let r=this.displaySegmentationSelection(e,t,n);return super.displaySelectionState(e,t,n)&&(r=!0),r}moveToSegment(e){for(const n of this.renderLayers){if(!(n instanceof Bf))continue;const r=n.getObjectPosition(e);if(r!==void 0){this.setLayerPosition(n.displayState.transform.value,r);return}}let t=!1;for(const n of this.renderLayers)if(n instanceof Yf){const r=n.multiscaleSource;r.getSegmentPosition&&(t=!0,r.getSegmentPosition(e).then(s=>{this.setLayerPosition(null,s)}).catch(s=>{Ye.showTemporaryMessage(`Failed to retrieve position for segment ${e}: ${s}`)}))}t||Ye.showTemporaryMessage(`No position information loaded for segment ${e}`)}}qt.type="segmentation";qt.typeAbbreviation="seg";qt.supportsPickOption=!0;const bH=10;function iE(i){return[H({label:`Skeleton mode (${i})`,toolJson:`${_u}.mode${i}`,isValid:e=>e.hasSkeletonsLayer},WP(e=>e.displayState.skeletonRenderingOptions[`params${i}`].mode)),H({label:`Line width (${i})`,toolJson:`${_u}.lineWidth${i}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${i})`,title:`Skeleton line width (${i})`},cs(e=>({value:e.displayState.skeletonRenderingOptions[`params${i}`].lineWidth,options:{min:1,max:40,step:1}})))]}const jP=[H({label:"Color seed",title:"Color segments based on a hash of their id",toolJson:Am},uH()),H({label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:Bm},hH()),H({label:"Saturation",toolJson:Pm,title:"Saturation of segment colors"},cs(i=>({value:i.displayState.saturation}))),H({label:"Opacity (on)",toolJson:Lm,isValid:i=>i.has2dLayer,title:"Opacity in cross-section views of segments that are selected"},cs(i=>({value:i.displayState.selectedAlpha}))),H({label:"Opacity (off)",toolJson:Tm,isValid:i=>i.has2dLayer,title:"Opacity in cross-section views of segments that are not selected"},cs(i=>({value:i.displayState.notSelectedAlpha}))),H({label:"Resolution (slice)",toolJson:Vm,isValid:i=>i.has2dLayer},Vu(i=>({histogram:i.sliceViewRenderScaleHistogram,target:i.sliceViewRenderScaleTarget}))),H({label:"Resolution (mesh)",toolJson:Nm,isValid:i=>i.has3dLayer},Vu(i=>({histogram:i.displayState.renderScaleHistogram,target:i.displayState.renderScaleTarget}))),H({label:"Opacity (3d)",toolJson:Dm,isValid:i=>i.has3dLayer,title:"Opacity of meshes and skeletons"},cs(i=>({value:i.displayState.objectAlpha}))),H({label:"Silhouette (3d)",toolJson:Om,isValid:i=>i.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction"},cs(i=>({value:i.displayState.silhouetteRendering,options:{min:0,max:bH,step:.1}}))),H({label:"Hide segment ID 0",toolJson:Im,title:"Disallow selection and display of segment id 0"},Hl(i=>i.displayState.hideSegmentZero)),H({label:"Base segment coloring",toolJson:Rm,title:"Color base segments individually"},Hl(i=>i.displayState.baseSegmentColoring)),H({label:"Show all by default",title:"Show all segments if none are selected",toolJson:Mm},Hl(i=>i.displayState.ignoreNullVisibleSet)),...iE("2d"),...iE("3d")];for(const i of jP)_P(qt,i);Ho(qt);GD(fi.SEGMENTATION,qt);Sy(i=>{if(i.mesh!==void 0)return{layerConstructor:qt,priority:1}});Uy(qt,i=>({shaderControlState:i.displayState.skeletonRenderingOptions.shaderControlState}),HP);I6();A6();/**
* @license
* Copyright 2018 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class wH extends Y{constructor(e){super(),this.ref=e,this.element=document.createElement("label"),this.selectElement=document.createElement("select"),this.registerDisposer(e);const t=this.element,n=this.selectElement;t.appendChild(n),this.updateView(),this.registerEventListener(n,"change",()=>this.updateModel()),this.registerDisposer(this.ref.changed.add(nt(()=>this.updateView(),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){const e=this.selectElement,t=this.ref,n=t.filter;Ke(e);const r=document.createElement("option");e.appendChild(r);for(const s of this.ref.layerManager.managedLayers)if(n(s)){const a=document.createElement("option"),l=s.name;a.textContent=l,a.value=l,e.appendChild(a)}e.value=t.layerName||""}}const CH="points",Qf="annotations",nE="annotationProperties",rE="annotationRelationships",sE="crossSectionAnnotationSpacing",aE="projectionAnnotationSpacing",oE="shader",lE="shaderControls";function xH(i,e){e!==void 0&&We(e,(t,n)=>{i.add({type:Ie.POINT,id:""+n,point:PV(t),properties:[]})})}function kH(i){const e=i.layer;return e===null||e instanceof qt}function EH(i){if(i===void 0)return null;const e=i.layer;return e===null||!(e instanceof qt)?null:e.displayState}const cE="linkedSegmentationLayer",dE="filterBySegmentation",uE="ignoreNullSegmentFilter";class LH extends Y{constructor(e,t,n){super(),this.layerManager=e,this.annotationStates=t,this.annotationDisplayState=n,this.changed=new be,this.curGeneration=-1,this.wasLoading=void 0,this.map=new ce,this.registerDisposer(t.changed.add(()=>this.update())),this.registerDisposer(t.isLoadingChanged.add(()=>this.update())),this.update()}update(){const e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;const n=this.map;let r=!1;for(const a of this.annotationStates.relationships){let l=n.get(a);l===void 0&&(l=this.addRelationship(a),r=!0),l.seenGeneration=e}if(!t)for(const a of n){var s=ae(a,2);const l=s[0];s[1].seenGeneration!==e&&(n.delete(l),r=!0)}r&&this.changed.dispatch()}addRelationship(e){const t=this.annotationDisplayState.relationshipStates.get(e),n=new FG(this.layerManager.addRef(),kH);n.registerDisposer(n.changed.add(()=>{t.segmentationState.value=n.layerName===void 0?void 0:EH(n.layer)}));const r=t.showMatches,s={layerRef:n,showMatches:r,seenGeneration:-1};return n.changed.add(this.changed.dispatch),r.changed.add(this.changed.dispatch),this.map.set(e,s),s}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(const e of this.map.values())e.showMatches.reset()}toJSON(){const e=this.map;if(e.size===0)return{};let t;const n=[];for(const s of e){var r=ae(s,2);const a=r[0],l=r[1];l.showMatches.value&&n.push(a);const d=l.layerRef.layerName;d!==void 0&&((t=t||{})[a]=d)}return n.sort(),{[cE]:t,[dE]:n.length===0?void 0:n}}restoreState(e){const t=this.annotationStates.isLoading;ye(e,cE,n=>{typeof n=="string"&&(n={segments:n}),ge(n);for(const s of Qt(n)){const a=Le(n[s]);let l=this.map.get(s);if(l===void 0){if(!t)continue;l=this.addRelationship(s)}l.layerRef.layerName=a}for(const s of this.map){var r=ae(s,2);const a=r[0],l=r[1];Object.prototype.hasOwnProperty.call(n,a)||(l.layerRef.layerName=void 0)}}),ye(e,dE,n=>{typeof n=="boolean"&&(n=n===!0?["segments"]:[]);for(const r of Ln(n)){let s=this.map.get(r);if(s===void 0){if(!t)continue;s=this.addRelationship(r)}s.showMatches.value=!0}})}disposed(){const e=this.map;for(const t of e.values())this.unbind(t);e.clear(),super.disposed()}}class TH extends Y{constructor(e,t){super(),this.relationship=e,this.state=t,this.element=document.createElement("label"),this.seenGeneration=-1;const n=this.element,r=this.registerDisposer(new Es(t.showMatches)),s=new wH(t.layerRef);n.appendChild(r.element),n.appendChild(document.createTextNode(e)),n.appendChild(s.element)}}class DH extends Y{constructor(e){super(),this.linkedSegmentationLayers=e,this.widgets=new ce,this.element=document.createElement("div"),this.element.style.display="contents";const t=this.registerCancellable(dt(()=>this.updateView()));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){const e=this.linkedSegmentationLayers,t=e.annotationStates,n=t.changed.count,r=this.widgets;function*s(){for(const l of t.relationships){let d=r.get(l);d===void 0&&(d=new TH(l,e.get(l))),d.seenGeneration=n,yield d.element}}for(const l of r){var a=ae(l,2);const d=a[0],u=a[1];u.seenGeneration!==n&&(u.dispose(),r.delete(d))}Xn(this.element,s.call(this))}disposed(){super.disposed();for(const e of this.widgets.values())e.dispose()}}const PH=Ry(Wo);class Ss extends PH{constructor(e){super(e),this.annotationProperties=new ct(void 0),this.localAnnotationsJson=void 0,this.pointAnnotationsJson=void 0,this.linkedSegmentationLayers=this.registerDisposer(new LH(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState)),this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new RH(this)}),this.tabs.default="annotations",this.allowingRefresh=!0}disposed(){const e=this.localAnnotations;e!==void 0&&e.dispose(),super.disposed()}restoreState(e){super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.localAnnotationsJson=e[Qf],this.localAnnotationProperties=ye(e,nE,CL),this.localAnnotationRelationships=ye(e,rE,Ln,["segments"]),this.pointAnnotationsJson=e[CH],this.annotationCrossSectionRenderScaleTarget.restoreState(e[sE]),this.annotationProjectionRenderScaleTarget.restoreState(e[aE]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[uE]),this.annotationDisplayState.shader.restoreState(e[oE]),this.annotationDisplayState.shaderControls.restoreState(e[lE])}getLegacyDataSourceSpecifications(e,t,n,r){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,n,r);const s=ye(t,"voxelSize",l=>rt(new Float64Array(3),l,d=>vi(d)/1e9)),a=["m","m","m"];if(s!==void 0){const l=st({rank:3,units:a,scales:s,names:["x","y","z"]});n===void 0?n={outputSpace:l,sourceRank:3,transform:void 0,inputSpace:l}:n=H(H({},n),{inputSpace:l})}return[{url:tT,transform:n,enableDefaultSubsources:!0,subsources:new ce}]}activateDataSubsources(e){var t;let n=!1,r;for(const a of e){const l=a.subsourceEntry,d=l.subsource.local,u=g=>r!==void 0&&ln(g)!==ln(r)?(a.deactivate("Annotation properties are not compatible"),!1):(r=g,!0);if(d===Rr.annotations){if(n){a.deactivate("Only one local annotations source per layer is supported");continue}if(n=!0,!u((t=this.localAnnotationProperties)!==null&&t!==void 0?t:[]))continue;a.activate(g=>{var v;const y=this.localAnnotations=new t3(a.loadedDataSource.transform,(v=this.localAnnotationProperties)!==null&&v!==void 0?v:[],this.localAnnotationRelationships);try{y.restoreState(this.localAnnotationsJson)}catch{}g.registerDisposer(()=>{y.dispose(),this.localAnnotations=void 0}),g.registerDisposer(this.localAnnotations.changed.add(this.specificationChanged.dispatch));try{xH(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;const C=new Ag({localPosition:this.localPosition,transform:g.registerDisposer(zL(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,a.loadedDataSource.transform,void 0)),source:y.addRef(),displayState:this.annotationDisplayState,dataSource:a.loadedDataSource.layerDataSource,subsourceIndex:a.subsourceIndex,subsourceId:l.id,role:un.ANNOTATION});this.addAnnotationLayerState(C,a)});continue}const h=l.subsource.annotation;if(h!==void 0){if(!u(h.properties))continue;a.activate(()=>{const g=new Ag({localPosition:this.localPosition,transform:a.getRenderLayerTransform(),source:h,displayState:this.annotationDisplayState,dataSource:a.loadedDataSource.layerDataSource,subsourceIndex:a.subsourceIndex,subsourceId:l.id,role:un.ANNOTATION});this.addAnnotationLayerState(g,a)});continue}a.deactivate("Not compatible with annotation layer")}const s=this.annotationProperties.value;ln(s)!==ln(r)&&(this.annotationProperties.value=r)}initializeAnnotationLayerViewTab(e){const t=e.registerDisposer(jn(r=>r.some(s=>s.source instanceof In),this.annotationStates)),n=e.registerDisposer(new Qn(t,(r,s,a)=>{if(r){{const l=a.registerDisposer(new Em(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));l.label.textContent="Spacing (cross section)",s.appendChild(l.element)}{const l=a.registerDisposer(new Em(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));l.label.textContent="Spacing (projection)",s.appendChild(l.element)}}}));e.element.insertBefore(n.element,e.element.firstChild);{const r=e.registerDisposer(new Es(this.annotationDisplayState.ignoreNullSegmentFilter)),s=document.createElement("label");s.appendChild(document.createTextNode("Ignore null related segment filter")),s.title="Display all annotations if filtering by related segments is enabled but no segments are selected",s.appendChild(r.element),e.element.appendChild(s)}e.element.appendChild(e.registerDisposer(new DH(this.linkedSegmentationLayers)).element)}toJSON(){const e=super.toJSON();e[sE]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[aE]=this.annotationProjectionRenderScaleTarget.toJSON(),this.localAnnotations!==void 0?e[Qf]=this.localAnnotations.toJSON():this.localAnnotationsJson!==void 0&&(e[Qf]=this.localAnnotationsJson),e[nE]=QV(this.localAnnotationProperties);const t=this.localAnnotationRelationships;return e[rE]=t&&t.length===1&&t[0]==="segments"?void 0:t,e[uE]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[oE]=this.annotationDisplayState.shader.toJSON(),e[lE]=this.annotationDisplayState.shaderControls.toJSON(),H(e,this.linkedSegmentationLayers.toJSON()),e}}Ss.type="annotation";Ss.typeAbbreviation="ann";function qP(i){return new _y({shaderError:i.annotationDisplayState.shaderError,fragmentMain:i.annotationDisplayState.shader,shaderControlState:i.annotationDisplayState.shaderControls})}let IH=class extends Ph{constructor(i){super(),this.layer=i,this.codeWidget=this.registerDisposer(qP(this.layer)),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}},RH=class extends _r{constructor(i){super(),this.layer=i,this.codeWidget=this.registerDisposer(qP(this.layer));const e=this.element;e.classList.add("neuroglancer-annotation-rendering-tab"),e.appendChild(this.registerDisposer(new Qn(i.annotationProperties,(r,s)=>{if(r===void 0||r.length===0)return;const a=document.createElement("div");s.appendChild(a),a.classList.add("neuroglancer-annotation-shader-property-list");for(const l of r){const d=document.createElement("div");d.classList.add("neuroglancer-annotation-shader-property");const u=document.createElement("span");u.classList.add("neuroglancer-annotation-shader-property-type"),u.textContent=l.type;const h=document.createElement("span");h.classList.add("neuroglancer-annotation-shader-property-identifier"),h.textContent=`prop_${l.identifier}`,d.appendChild(u),d.appendChild(h);const g=l.description;g!==void 0&&(d.title=g),a.appendChild(d)}})).element);let t=document.createElement("div");t.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let n=document.createElement("div");n.style.flex="1",n.textContent="Annotation shader:",t.appendChild(n),t.appendChild(By({title:"Show larger editor view",onClick:()=>{new IH(this.layer)}})),t.appendChild(Vy({title:"Documentation on annotation rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/annotation/rendering.md"})),e.appendChild(t),e.appendChild(this.codeWidget.element),e.appendChild(this.registerDisposer(new Fy(i.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}};Ho(Ss);Ho(Ss,"pointAnnotation");Sy(i=>{if(i.local===Rr.annotations)return{layerConstructor:Ss,priority:100};if(i.annotation!==void 0)return{layerConstructor:Ss,priority:1}});Uy(Ss,i=>({shaderControlState:i.annotationDisplayState.shaderControls}));function MH(i){i.registerEventListener(document,"copy",e=>{if(Yv(e.target))return;const t=document.getSelection();if(t!==null&&t.type==="Range")return;const n=Wv(i.state).value,r=e.clipboardData;r!==null&&r.setData("text/plain",re(n,void 0,"  ")),e.preventDefault()})}function AH(i,e){let t=Vl`^[\[\]{}()\s,]*`;for(let s=0;s<e;++s)s!==0&&(t+=Vl`[,\s]+`),t+=Vl`(\d+(?:\.\d+)?)`;t+=Vl`[\[\]{}()\s,]*$`;const n=i.match(t);if(n===null)return;const r=new Float32Array(e);for(let s=0;s<e;++s){const a=Number(n[s+1]);if(!gt(a))return;r[s]=a}return r}function NH(i){i.registerEventListener(document,"paste",e=>{if(Yv(e.target))return;const t=e.clipboardData;if(t!==null){const n=t.getData("text/plain"),r=AH(n,i.coordinateSpace.value.rank);r!==void 0&&(i.navigationState.position.value=r)}e.preventDefault()})}const hE=Xi("SingleTextureVolumeChunk.textureUnit"),Fd=Xi("SingleTextureVolumeChunk.textureLayout");class JP extends Y{constructor(e,t){super(),this.shaderKey=e,this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",hE)}beginDrawing(e,t){let n=t.textureUnit(hE);e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),t[Fd]=null}endDrawing(e,t){e.bindTexture(Mg[this.shaderSamplerType],null),t[Fd]=null}bindChunk(e,t,n,r,s,a,l){let d=n.textureLayout;(t[Fd]!==d||l)&&(t[Fd]=d,this.setupTextureLayout(e,t,d,r,s,a)),e.bindTexture(Mg[this.shaderSamplerType],n.texture)}beginSource(e,t){}}class XP extends ZU{constructor(e,t){super(e,t),this.texture=null,this.data=t.data}copyToGPU(e){super.copyToGPU(e);let t=this.texture=e.createTexture();const n=Mg[this.chunkFormat.shaderSamplerType];e.bindTexture(n,t),this.setTextureData(e),e.bindTexture(n,null)}freeGPUMemory(e){super.freeGPUMemory(e),e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/let VH=class KP extends Y{constructor(e,t,n){super(),this.chunkDataSize=t,this.textureDims=n,this.textureShape=new Uint32Array(this.textureDims);const r=t.length;let s=0;for(const g of t)g!==1&&++s;const a=this.strides=new Uint32Array(r*n),l=n===3?e.max3dTextureSize:e.maxTextureSize;let d=0,u=1;const h=this.textureShape;h.fill(1);for(let g=0;g<r;++g){const v=t[g];if(v===1)continue;const y=v*u;let C;y>l||u!==1&&d+s<n?(++d,u=v,C=1):(C=u,u=y),a[n*g+d]=C,h[d]=u}}static get(e,t,n){return e.memoize.get(`sliceview.UncompressedTextureLayout:${t.join()}:${n}`,()=>new KP(e,t,n))}},eg=new Uint32Array(15),OH=class YP extends JP{constructor(e,t,n,r){super(n,t),this.textureDims=r,Ic(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${r}D`,this.textureAccessHelper=new HF("chunkData",r)}static get(e,t,n){const r=`sliceview.UncompressedChunkFormat:${t}:${n}`;return e.memoize.get(r,()=>new YP(e,t,r,n))}defineShader(e,t){super.defineShader(e,t);const n=this.textureDims,r=`ivec${this.textureDims}`;let s=this.textureAccessHelper;const a=(4+t)*n;eg.length<a&&(eg=new Uint32Array(a)),e.addUniform(`highp ${r}`,"uVolumeChunkStrides",4+t),e.addFragmentCode(s.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType));let l=`
${si(this.dataType)} getDataValueAt(highp ivec3 p`;for(let d=0;d<t;++d)l+=`, highp int channelIndex${d}`;l+=`) {
  highp ${r} offset = uVolumeChunkStrides[0]
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let d=0;d<t;++d)l+=`
  offset += channelIndex${d} * uVolumeChunkStrides[${4+d}];
`;l+=`
  return readVolumeData(offset);
}
`,e.addFragmentCode(l)}setupTextureLayout(e,t,n,r,s,a){const l=eg,d=a.length,u=n.strides,h=r.length,g=this.textureDims;for(let y=0;y<g;++y){let C=0;for(let w=0;w<h;++w)C+=r[w]*u[w*g+y];l[y]=C}for(let y=0;y<3;++y){const C=s[y];if(!(C>=h))for(let w=0;w<g;++w)l[(y+1)*g+w]=u[C*g+w]}for(let y=0;y<d;++y){const C=a[y];if(C===-1)l.fill(0,(4+y)*g,(4+y+1)*g);else for(let w=0;w<g;++w)l[(4+y)*g+w]=u[C*g+w]}const v=(4+d)*g;g===3?e.uniform3iv(t.uniform("uVolumeChunkStrides"),l,0,v):e.uniform2iv(t.uniform("uVolumeChunkStrides"),l,0,v)}getTextureLayout(e,t){return VH.get(e,t,this.textureDims)}setTextureData(e,t,n){const r=t.textureShape;(this.textureDims===3?GF:$F)(e,this,n,r[0],r[1],r[2])}};class BH extends XP{setTextureData(e){let t=this.source,n=t.chunkFormatHandler,r=n.chunkFormat,s;this.chunkDataSize===t.spec.chunkDataSize?this.textureLayout=s=n.textureLayout.addRef():this.textureLayout=s=r.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,s,this.data)}getValueAt(e){let t=this.chunkFormat;const n=this.chunkDataSize;let r=0,s=1;const a=e.length;for(let u=0;u<a;++u)r+=s*e[u],s*=n[u];let l=t.dataType,d=this.data;switch(l){case q.UINT8:case q.INT8:case q.FLOAT32:case q.UINT16:case q.INT16:case q.UINT32:case q.INT32:return d[r];case q.UINT64:{let u=r*2;return new te(d[u],d[u+1])}}}}class _H extends Y{constructor(e,t){super();let n=0;for(const r of t.chunkDataSize)r>1&&++n;this.chunkFormat=this.registerDisposer(OH.get(e,t.dataType,n>=3?3:2)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize))}getChunk(e,t){return new BH(e,t)}}WT((i,e)=>e.compressedSegmentationBlockSize==null?new _H(i,e):null);/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function ZP(i,e,t,n,r,s){let a=0,l=0,d=1,u=1;for(let w=0;w<3;++w){let b=r[w],k=n[w],L=Math.floor(b/k),I=b%k;a+=L*d,d*=Math.ceil(t[w]/k),l+=I*u,u*=k}let h=e+a*2,g=i[h],v=i[h+1],y=g&16777215,C=g>>24&255;if(C>0){let w=(e+v&16777215)+Math.floor(l*C/32),b=i[w],k=l*C%32,L=b>>k&(1<<C)-1;y+=s*L}return y}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function FH(i,e,t,n,r){let s=ZP(i,e,t,n,r,1)+e;return i[s]}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function UH(i,e,t,n,r,s){let a=ZP(e,t,n,r,s,2)+t;return i.low=e[a],i.high=e[a+1],i}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class zy extends Y{constructor(e,t){super(),this.chunkDataSize=e,this.subchunkSize=t;const n=this.subchunkGridSize=Ne();for(let r=0;r<3;++r)n[r]=Math.ceil(e[r]/t[r])}static get(e,t,n){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${mg(t)},${mg(n)}`,()=>new zy(t,n))}}const zH=Ic(new gh,q.UINT32);let tg=new Uint32Array(16);class $y extends JP{constructor(e,t,n,r){super(r,e),this.subchunkSize=t,this.numChannels=n,this.textureAccessHelper=new Jv("chunkData")}static get(e,t,n,r){let s=`sliceview.CompressedSegmentationChunkFormat:${t}:${r}`,a=`${s}:${mg(n)}`;return e.memoize.get(a,()=>new $y(t,n,r,s))}get shaderSamplerType(){return"usampler2D"}defineShader(e,t){super.defineShader(e,t);const n=4*(4+t);tg.length<n&&(tg=new Uint32Array(n));let r=this.textureAccessHelper;r.defineShader(e);let s=u=>"compressedSegmentationChunkFormat_"+u;e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode(sB);const a=this.dataType,l=si(a);a===q.UINT64?e.addFragmentCode(Dt):e.addFragmentCode(Tv),e.addFragmentCode(r.getAccessor(s("readTextureValue"),"uVolumeChunkSampler",q.UINT32,1));let d=`
uint ${s("getChannelOffset")}(int channelIndex) {
  if (channelIndex == 0) {
    return ${this.numChannels}u;
  }
  return ${s("readTextureValue")}(uint(channelIndex)).value;
}
${l} getDataValueAt(highp ivec3 p`;for(let u=0;u<t;++u)d+=`, highp int channelIndex${u}`;d+=`) {
  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let u=0;u<t;++u)d+=`
  chunkPositionFull += channelIndex${u} * uVolumeChunkStrides[${4+u}];
`;d+=`
  highp ivec3 chunkPosition = chunkPositionFull.xyz;

  // TODO: maybe premultiply this and store as uniform.
  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;
  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);

  int channelOffset = int(${s("getChannelOffset")}(chunkPositionFull[3]));

  // TODO: Maybe just combine this offset into subchunkGridStrides.
  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;

  highp uint subchunkHeader0 = ${s("readTextureValue")}(uint(subchunkHeaderOffset)).value;
  highp uint subchunkHeader1 = ${s("readTextureValue")}(uint(subchunkHeaderOffset + 1)).value;
  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);
  highp uint encodingBits = subchunkHeader0 >> 24u;
  if (encodingBits > 0u) {
    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;
    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);
    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);
    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;
    uint encodedValue = ${s("readTextureValue")}(encodedValueOffset).value;
    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;
    uint encodedValueShifted = encodedValue >> wordOffset;
    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);
    outputValueOffset += decodedValue * ${this.dataType===q.UINT64?"2u":"1u"};
  }
  ${l} result;
`,a===q.UINT64?d+=`
  result.value[0] = ${s("readTextureValue")}(outputValueOffset).value;
  result.value[1] = ${s("readTextureValue")}(outputValueOffset+1u).value;
`:d+=`
  result.value = ${s("readTextureValue")}(outputValueOffset).value;
`,d+=`
  return result;
}
`,e.addFragmentCode(d)}setupTextureLayout(e,t,n,r,s,a){const l=n.subchunkGridSize;e.uniform3i(t.uniform("uSubchunkGridSize"),l[0],l[1],l[2]);const d=tg,u=a.length;d.fill(0);for(let h=0;h<3;++h){d[h]=r[h];const g=s[h];g!==-1&&(d[4*(h+1)+g]=1)}for(let h=0;h<u;++h){const g=a[h];g!==-1&&(d[4*(4+h)+g]=1)}e.uniform4iv(t.uniform("uVolumeChunkStrides"),d,0,(u+4)*4)}setTextureData(e,t,n){qv(e,zH,n)}getTextureLayout(e,t){return zy.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);const n=this.subchunkSize;e.uniform3i(t.uniform("uSubchunkSize"),n[0],n[1],n[2])}}class $H extends XP{setTextureData(e){let t=this.data,n=this.chunkFormat,r=this.textureLayout=n.getTextureLayout(e,this.chunkDataSize);n.setTextureData(e,r,t)}getValueAt(e){let t=this.chunkDataSize,n=this.chunkFormat,r=this.data,s=r[e[3]||0];if(n.dataType===q.UINT64){let a=new te;return UH(a,r,s,t,n.subchunkSize,e),a}else return FH(r,s,t,n.subchunkSize,e)}}class GH extends Y{constructor(e,t){super();let n=t.dataType;if(n!==q.UINT64&&n!==q.UINT32)throw new Error(`Unsupported compressed segmentation data type: ${q[n]}`);this.chunkFormat=this.registerDisposer($y.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1))}getChunk(e,t){return new $H(e,t)}}WT((i,e)=>e.compressedSegmentationBlockSize!=null?new GH(i,e):null);/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function WH(i,e=document.getElementById("neuroglancer-container")){try{let t=new sO(e);return new TG(t,i)}catch(t){throw Ye.showMessage(`Error: ${t.message}`),t}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function HH(i=document){return Tn(i,"contextmenu",e=>{e.preventDefault()})}const Gy="DVID";function jH(i){return i.text()}function qH(i,e=Vt){const t=`${i.url}`,n={method:i.method,body:i.payload};return ys(t,n,sr,e)}function JH(i,e,t=Vt){return XH(i,e.url,{method:e.method,body:e.payload},sr,t)}function XH(i,e,t,n,r=Vt){return py(i,e,t,n,(s,a)=>{const l=H({},a);return s.token&&(l.headers=H(H({},l.headers),{Authorization:`Bearer ${s}`})),l},s=>{if(s.status===504)return"retry";throw s},r)}async function KH(i,e=Vt){return{token:await ys(i,{method:"GET",credentials:"include"},jH,e)}}class YH extends Fc{constructor(e){super(),this.authServer=e,this.get=wh(t=>{if(!this.authServer)return xt.resolve({token:""});const n=new Ye(!0);let r;return new xt((s,a)=>{const l=()=>{r=void 0,n.dispose()};t.add(()=>{r!==void 0&&(r.cancel(),r=void 0,n.dispose(),a(ms))});function d(h,g="DVID authorization required.",v="Request authorization."){n.setText(g+" ");let y=document.createElement("button");y.textContent=v,n.element.appendChild(y),y.addEventListener("click",()=>{let C=h.match(/^[^\/]+\/\/[^\/\.]+\.([^\/]+)/);if(C){const w=`https://flyemlogin.${C[1]}/login`;window.alert(`Please log into ${w} and then refresh the neurogalncer page to try again.
If you are unable to log into ${w}, please check your authorization server ${h} to make sure it is correct.`)}else window.alert(`Please check your authorization server ${h} to make sure it is correct.`)}),n.setVisible(!0)}function u(h){r!==void 0&&r.cancel(),r=new ks,d(h,"Waiting for DVID authorization...","Retry"),KH(h,r).then(g=>{r!==void 0&&(l(),s(g))},g=>{r!==void 0&&(r=void 0,d(h,`DVID authorization failed: ${g}.`,"Retry"))})}u(this.authServer)})})}}class ZH extends $z{constructor(e,t){super(new YH(t),{})}}/**
* @license
* This work is a derivative of the Google Neuroglancer project,
* Copyright 2016 Google Inc.
* The Derivative Work is covered by
* Copyright 2019 Howard Hughes Medical Institute
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/zo.register(Gy,i=>new ZH(i.dvidServer,i.authServer));/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const QH="CredentialsProvider",ej="CredentialsProvider.get";/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var tj=function(i,e,t,n){var r=arguments.length,s=r<3?e:n===null?n=An(e,t):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(a=i[l])&&(s=(r<3?a(s):r>3?a(e,t,s):a(e,t))||s);return r>3&&s&&Mn(e,t,s),s};let _m=class extends er{constructor(i,e){super(),this.provider=i,this.registerDisposer(i),this.initializeCounterpart(e)}get(i,e){return this.provider.get(i,e)}};_m=tj([hn(QH)],_m);l2(ej,function(i,e){return this.get(i.providerId).get(i.invalidCredentials,e).then(t=>({value:t}))});/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/function ij(i,e){if(e===void 0)return;const t=i.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:oi(e)},()=>new _m(e.addRef(),i.rpc)),n=t.addCounterpartRef();return t.dispose(),n}function It(){return function(i){class e extends i{constructor(...n){var r;super(...n);const s=n[1];this.credentialsProvider=(r=s.credentialsProvider)===null||r===void 0?void 0:r.addRef()}initializeCounterpart(n,r){const s=this.credentialsProvider;r.credentialsProvider=ij(this.chunkManager,s),super.initializeCounterpart(n,r)}static encodeOptions(n){const r=super.encodeOptions(n),s=n.credentialsProvider;return r.credentialsProvider=s===void 0?void 0:oi(s),r}}return e}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const nj=lt(128,128,128);var sn;(function(i){i[i.JPEG=0]="JPEG",i[i.RAW=1]="RAW",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i[i.COMPRESSED_SEGMENTATIONARRAY=3]="COMPRESSED_SEGMENTATIONARRAY"})(sn||(sn={}));class Ih{}let QP=class extends Ih{};QP.RPC_ID="dvid/VolumeChunkSource";let eI=class extends Ih{};eI.RPC_ID="dvid/SkeletonSource";let tI=class extends Ih{};tI.RPC_ID="dvid/MeshSource";let iI=class extends Ih{constructor(){super(...arguments),this.chunkDataSize=nj}},Wy=class extends iI{};Wy.RPC_ID="dvid/AnnotationSource";let nI=class extends iI{};nI.RPC_ID="dvid/AnnotationChunkSource";let rI=class{constructor(i,e){this.numLevels=1;try{if(ge(i),e==="dvid"){let t=K(i,"Extended",ge);if(t.MaxDownresLevel){let n=K(t,"MaxDownresLevel",ai);this.numLevels=n+1}this.voxelSize=K(t,"VoxelSize",n=>za(Ne(),n)),this.upperVoxelBound=K(t,"MaxPoint",n=>za(Ne(),n.map(r=>++r))),this.lowerVoxelBound=K(t,"MinPoint",n=>za(Ne(),n)),this.blockSize=K(t,"BlockSize",n=>za(Ne(),n))}else if(e==="gs"){ge(i);const t=K(i,"scales",s=>s);if(t.length===0)throw new Error("Expected at least one scale");const n=t[0];this.voxelSize=K(n,"resolution",s=>_l(Ne(),s)),this.lowerVoxelBound=ye(n,"offset",s=>za(Ne(),s))||lt(0,0,0);const r=K(n,"size",s=>za(Ne(),s));this.upperVoxelBound=eL(Ne(),r,this.lowerVoxelBound),this.blockSize=lt(64,64,64)}else throw new Error("unrecognized volume info")}catch(t){throw new Error(`Failed to parse volume geometry: ${t.message}`)}}},rj=class{constructor(i){try{this.scales=[],this.scales.push(i);let e=i.voxelSize,t=i.lowerVoxelBound,n=i.upperVoxelBound;for(let r=1;r<i.numLevels;++r){let s=H({},i);s.voxelSize=iL(Ne(),e,lt(2,2,2)),e=s.voxelSize,s.upperVoxelBound=gw(Ne(),ug(Ne(),n,lt(2,2,2))),n=s.upperVoxelBound,s.lowerVoxelBound=gw(Ne(),ug(Ne(),t,lt(2,2,2))),t=s.lowerVoxelBound,this.scales.push(s)}}catch(e){throw new Error(`Failed to parse multiscale volume specification: ${e.message}`)}}get numChannels(){return this.scales.length===0?0:this.scales[0].numChannels}},Rh=new ce;Rh.set("uint8",q.UINT8);Rh.set("uint32",q.UINT32);Rh.set("uint64",q.UINT64);class sI{constructor(e){this.obj=e,ge(e),K(e,"TypeName",Le)}get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}get tags(){return this.obj.Tags}}class aI{constructor(e,t,n){this.name=t,this.base=n,this.volumeInfo=new rI(lj(n.tags,e),"dvid")}get lowerVoxelBound(){return this.volumeInfo.lowerVoxelBound}get upperVoxelBound(){return this.volumeInfo.upperVoxelBound}get blockSize(){return this.volumeInfo.blockSize}get voxelSize(){return this.volumeInfo.voxelSize}get numLevels(){return this.volumeInfo.numLevels}}class sj extends Pt(It()(Bc),QP){}class aj extends Pt(It()(Sh),eI){}class oj extends Pt(It()(Ac),tI){}class Zd extends aI{constructor(e,t,n,r,s){super(e,t,n),this.encoding=r;let a=K(e,"Extended",ge),l=K(a,"Values",u=>We(u,ge));if(l.length<1)throw new Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");let d=new $e(s);if(r!==sn.COMPRESSED_SEGMENTATIONARRAY)for(;d.has(t+"_"+this.volumeInfo.numLevels.toString());)this.volumeInfo.numLevels+=1;d.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",d.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=K(l[0],"DataType",u=>mL(u,Rh))}get volumeType(){return this.encoding===sn.COMPRESSED_SEGMENTATION||this.encoding===sn.COMPRESSED_SEGMENTATIONARRAY?fi.SEGMENTATION:fi.IMAGE}getSources(e,t,n,r){const s=this.encoding,a=[],l=64;for(let d=0;d<this.numLevels;++d){const u=Math.pow(2,d),h=Math.pow(2,-d),g=Ne(),v=Ne();for(let k=0;k<3;++k){const L=Math.floor(this.lowerVoxelBound[k]*h);g[k]=L-L%l;const I=Math.ceil(this.upperVoxelBound[k]*h);v[k]=I,I%l!==0&&(v[k]+=l-I%l)}let y=t.dataInstanceKey;s!==sn.COMPRESSED_SEGMENTATIONARRAY&&d>0&&(y+="_"+d.toString());const C=H(H({},t),{dataInstanceKey:y,dataScale:d.toString(),encoding:s}),w=Je();for(let k=0;k<3;++k)w[5*k]=u,w[12+k]=g[k]*u;const b=zc({rank:3,chunkToMultiscaleTransform:w,dataType:this.dataType,baseVoxelOffset:g,upperVoxelBound:tL(Ne(),v,g),volumeType:this.volumeType,volumeSourceOptions:n,compressedSegmentationBlockSize:s===sn.COMPRESSED_SEGMENTATION||s===sn.COMPRESSED_SEGMENTATIONARRAY?lt(8,8,8):void 0}).map(k=>({chunkSource:e.getChunkSource(sj,{spec:k,parameters:C,credentialsProvider:r}),chunkToMultiscaleTransform:w}));a.push(b)}return dc(a)}}function oI(i){let e=K(i,"Base",ge),t=K(e,"Syncs",Ln);return t.length===1?t[0]:""}function lj(i,e){if(!i)return e;const t=e&&e.Extended||{};let n=t.MaxDownresLevel,r=t.MaxPoint,s=t.MinPoint,a=t.VoxelSize,l=t.BlockSize;try{i.MaxDownresLevel&&typeof i.MaxDownresLevel=="string"?(n=parseInt(K(i,"MaxDownresLevel",Le)),n<0&&(n=t.MaxDownresLevel)):typeof i.MaxDownresLevel=="number"&&(n=K(i,"MaxDownresLevel",TV))}catch{}try{i.MaxPoint&&typeof i.MaxPoint=="string"?r=JSON.parse(K(i,"MaxPoint",Le)):Array.isArray(i.MaxPoint)&&i.MaxPoint.length===3&&(r=i.MaxPoint)}catch{}try{i.MinPoint&&typeof i.MinPoint=="string"?s=JSON.parse(K(i,"MinPoint",Le)):Array.isArray(i.MinPoint)&&i.MinPoint.length===3&&(s=i.MinPoint)}catch{}try{i.VoxelSize&&typeof i.VoxelSize=="string"?a=JSON.parse(K(i,"VoxelSize",Le)):Array.isArray(i.VoxelSize)&&i.VoxelSize.length===3&&(a=i.VoxelSize)}catch{}try{i.BlockSize&&typeof i.BlockSize=="string"?l=JSON.parse(K(i,"BlockSize",Le)):Array.isArray(i.BlockSize)&&i.BlockSize.length===3&&(l=i.BlockSize)}catch{}return{Base:e&&e.Base||{},Extended:H(H({},t),{VoxelSize:a,MinPoint:s,MaxPoint:r,MaxDownresLevel:n,BlockSize:l})}}class lI extends aI{get tags(){return K(this.base.obj,"Tags",ge)}constructor(e,t,n){super(e,t,n)}}function cj(i,e,t){ge(i);let n=i[e],r=K(n,"Base",s=>new sI(s));if(r.typeName==="annotation"){let s=oI(n);return s&&(n=i[s]),new lI(n,e,r)}return dj(n,e,t)}function dj(i,e,t){ge(i);let n=K(i,"Base",r=>new sI(r));switch(n.typeName){case"uint8blk":case"grayscale8":let r=n.compressionName.indexOf("jpeg")!==-1;return new Zd(i,e,n,r?sn.JPEG:sn.RAW,t);case"labels64":case"labelblk":return new Zd(i,e,n,sn.COMPRESSED_SEGMENTATION,t);case"labelarray":case"labelmap":return new Zd(i,e,n,sn.COMPRESSED_SEGMENTATIONARRAY,t);default:throw new Error(`DVID data type ${re(n.typeName)} is not supported.`)}}class Fu{constructor(e){if(this.errors=[],this.dataInstances=new ce,this.vnodes=new $e,e instanceof Fu){this.alias=e.alias,this.description=e.description,this.errors=e.errors,this.dataInstances=e.dataInstances;return}ge(e),this.alias=K(e,"Alias",Le),this.description=K(e,"Description",Le);let t=K(e,"DataInstances",ge),n=Qt(t);for(let a of n)try{this.dataInstances.set(a,cj(t,a,n))}catch(l){let d=`Failed to parse data instance ${re(a)}: ${l.message}`;console.log(d),this.errors.push(d)}let r=K(e,"DAG",ge),s=K(r,"Nodes",ge);for(let a of Qt(s))this.vnodes.add(a)}}function uj(i){try{let n=av(i,s=>new Fu(s)),r=new ce;for(let s of n){var e=ae(s,2);let a=e[0],l=e[1];r.set(a,l);for(let d of l.vnodes)if(d!==a){let u=new Fu(l);r.set(d,u)}}for(let s of r){var t=ae(s,2);let a=t[0],l=t[1];l.uuid=a}return r}catch(n){throw new Error(`Failed to parse DVID repositories info: ${n.message}`)}}class hj{constructor(e){this.repositories=uj(e)}getNode(e){let t=[];for(let n of this.repositories.keys())n.startsWith(e)&&t.push(n);if(t.length!==1)throw new Error(`Node key ${re(e)} matches ${re(t)} nodes.`);return this.repositories.get(t[0])}}function cI(i,e,t){return i.memoize.getUncounted({type:"dvid:getServerInfo",baseUrl:e},()=>{const n=JH(t,{url:`${e}/api/repos/info`,method:"GET"}).then(s=>new hj(s)),r=`repository info for DVID server ${e}`;return Ye.forPromise(n,{initialMessage:`Retrieving ${r}.`,delay:!0,errorPrefix:`Error retrieving ${r}: `}),n})}class pj extends Ds{constructor(e,t,n,r){super(e),this.sourceParameters=t,this.info=n,this.credentialsProvider=r}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}get baseUrl(){return this.sourceParameters.baseUrl}get nodeKey(){return this.sourceParameters.nodeKey}get dataInstanceKey(){return this.sourceParameters.dataInstanceKey}get supervoxels(){return this.sourceParameters.supervoxels||!1}getSegmentPosition(e){const t=this.sourceParameters.dvidService;return t?fetch(`${t}/locate-body?dvid=${this.baseUrl}&uuid=${this.nodeKey}&segmentation=${this.dataInstanceKey}&body=${e.toString()}${this.supervoxels?"&supervoxels=true":""}`,{method:"GET"}).then(n=>n.json()).then(n=>new Float32Array(n)):xt.reject("No locate service is available")}getSources(e){return this.info.getSources(this.chunkManager,this.sourceParameters,e,this.credentialsProvider)}}const fj=/^((?:http|https):\/\/[^\/]+)\/([^\/]+)\/([^\/\?#]+)(?:(?:\?|#)(.*))?$/;function dI(i){if(i.startsWith("https"))return i+"/api/server/token"}function gj(i){let e=i.match(fj);if(e===null)throw new Error(`Invalid DVID URL: ${re(i)}.`);let t={baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]};const n=e[4];if(n){const r=gc(n);r.usertag==="true"&&(t.usertag=!0),r.user&&(t.user=r.user);const s=r.dvidService||r.dvidservice||r["dvid-service"];s&&(t.dvidService=s),(r.forceDvidService||r.forcedividservice||r["force-dvid-service"])&&(t.forceDvidService=!0),t.supervoxels=r.supervoxels==="true"}return t.authServer=dI(t.baseUrl),t}function mj(i,e,t){return i.usertag?BN(Ne(),t,e):i.chunkDataSize}function vj(i,e){let t=n=>{const r=n.lowerVoxelBound,s=n.upperVoxelBound,a=mj(e,r,s);return{spec:Cc({rank:3,chunkDataSize:Uint32Array.from(a),lowerVoxelBound:r,upperVoxelBound:s}),chunkToMultiscaleTransform:Je()}};if(e.usertag){if(e.user)return[[t(i.scales[0])]];throw"Expecting a valid user"}else return[i.scales.map(n=>t(n))]}const yj=Pt(It()(In),Wy);class Sj extends Pt(It()(So),nI){}class bj extends yj{constructor(e,t){super(e,H({rank:3,relationships:["segments"],properties:t.parameters.properties},t)),this.readonly=!1,this.parameters=t.parameters,this.multiscaleVolumeInfo=t.multiscaleVolumeInfo,this.childAdded=this.childAdded||new Ze,this.childUpdated=this.childUpdated||new Ze,this.childDeleted=this.childDeleted||new Ze,this.childRefreshed=this.childRefreshed||new be,this.parameters.readonly!==void 0&&(this.readonly=this.parameters.readonly),this.parameters.user||(this.readonly=!0)}getSources(e){let t=vj(this.multiscaleVolumeInfo,this.parameters),n=0;return t[0].length>1&&(n=3),this.chunkSources=t.map(r=>r.map(({spec:s,chunkToMultiscaleTransform:a})=>({chunkSource:this.chunkManager.getChunkSource(Sj,{spec:H({limit:n,chunkToMultiscaleTransform:a},s),parent:this,credentialsProvider:this.credentialsProvider,parameters:this.parameters}),chunkToMultiscaleTransform:a}))),this.chunkSources}invalidateCache(){this.metadataChunkSource.invalidateCache();for(let e of this.chunkSources)for(let t of e)t.chunkSource.invalidateCache();for(let e of this.segmentFilteredSources)e.invalidateCache();this.childRefreshed.dispatch()}}async function wj(i,e,t,n){let r=(a,l)=>i.chunkManager.getChunkSource(bj,{parameters:l,credentialsProvider:n,multiscaleVolumeInfo:a}),s=new rj(t.volumeInfo);return r(s,e)}async function Cj(i,e,t,n){const r={lowerBounds:new Float64Array(t.lowerVoxelBound),upperBounds:Float64Array.from(t.upperVoxelBound)},s=st({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(t.voxelSize,l=>l/1e9),boundingBoxes:[aa(r)]}),a=await wj(i,e,t,n);return{modelTransform:zi(s),subsources:[{id:"default",subsource:{annotation:a},default:!0}]}}function xj(i,e,t,n){const r=t,s={lowerBounds:new Float64Array(r.lowerVoxelBound),upperBounds:Float64Array.from(r.upperVoxelBound)},a=st({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(r.voxelSize,u=>u/1e9),boundingBoxes:[aa(s)]}),l=new pj(i.chunkManager,e,r,n),d={modelTransform:zi(a),subsources:[{id:"default",subsource:{volume:l},default:!0}]};if(r.meshSrc){const u=Je();for(let h=0;h<3;++h)u[5*h]=1/r.voxelSize[h];d.subsources.push({id:"meshes",default:!0,subsource:{mesh:i.chunkManager.getChunkSource(oj,{parameters:H(H({},e),{segmentationName:r.name,dataInstanceKey:r.meshSrc}),credentialsProvider:n})},subsourceToModelSubspaceTransform:u})}return r.skeletonSrc&&d.subsources.push({id:"skeletons",default:!0,subsource:{mesh:i.chunkManager.getChunkSource(aj,{parameters:H(H({},e),{dataInstanceKey:r.skeletonSrc}),credentialsProvider:n})}}),d.subsources.push({id:"bounds",subsource:{staticAnnotations:yc(s)},default:!0}),d}function kj(i){return i.chunkManager.memoize.getUncounted({type:"dvid:MultiscaleVolumeChunkSource",sourceUrl:i.providerUrl},async()=>{const e=gj(i.providerUrl),t=e.baseUrl,n=e.nodeKey,r=e.dataInstanceKey,s=n.indexOf(":"),a=s!==-1?n.slice(0,s):n,l=i.credentialsManager.getCredentialsProvider(Gy,{dvidServer:e.baseUrl,authServer:e.authServer}),d=(await cI(i.chunkManager,t,l)).getNode(a);if(d===void 0)throw new Error(`Invalid node: ${re(n)}.`);const u=d.dataInstances.get(r);if(!u)throw new Error(`Invalid data instance ${r}.`);if(u.base.typeName==="annotation"){if(!(u instanceof lI))throw new Error(`Invalid data instance ${r}.`);let h=H(H({},new Wy),e);return u.blockSize&&(h.chunkDataSize=u.blockSize),h.syncedLabel=oI({Base:u.base.obj}),h.properties=[{identifier:"rendering_attribute",description:"rendering attribute",type:"int32",default:0,min:0,max:5,step:1},{identifier:"confidence",description:"confidence",type:"float32",default:0,min:0,max:1,step:.01}],Cj(i,h,u,l)}else{if(!(u instanceof Zd))throw new Error(`Invalid data instance ${r}.`);return xj(i,e,u,l)}})}function Ej(i,e){return{offset:0,completions:Fo(e,i.dataInstances.values(),t=>t.name,t=>`${t.base.typeName}`)}}function Lj(i,e){let t=e.match(/^(?:([^\/]+)(?:\/([^\/]*))?)?$/);if(t===null)throw new Error("Invalid DVID URL syntax.");if(t[2]===void 0)return{offset:0,completions:Fo(e,i.repositories.values(),s=>s.uuid+"/",s=>`${s.alias}: ${s.description}`)};let n=t[1],r=i.getNode(n);return _o(n.length+1,Ej(r,t[2]))}async function Tj(i){const e=/^((?:http|https):\/\/[^\/]+)\/([^\?]*).*$/;let t=i.providerUrl.match(e);if(t===null)throw null;let n=t[1],r=t[2],s=dI(n);const a=await cI(i.chunkManager,n,i.credentialsManager.getCredentialsProvider(Gy,{dvidServer:n,authServer:s}));return _o(n.length+1,Lj(a,r))}class Dj extends oa{constructor(e){super(),this.credentialsManager=e}get description(){return"DVID"}get(e){return kj(e)}completeUrl(e){return Tj(e)}}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/da("dvid",i=>new Dj(i.credentialsManager));function pE(i){return i.text()}function Pj(i,e,t,n=Vt){const r={method:t.method,body:t.payload};return r.method==="POST"&&(r.headers={"Content-Type":"application/json"}),Rj(i,e,t.url,r,sr,n)}function Ij(i){return(e,t)=>{let n=H({},t);return e?n.headers=H(H({},n.headers),{Authorization:`Bearer ${e}`}):i.startsWith("https:")&&(n.credentials="include"),n}}function Rj(i,e,t,n,r,s=Vt){return py(i,t,n,r,Ij(t),a=>{const l=a.status;if((l===403||l===401)&&e)return"refresh";if(l===504)return"retry";throw a},s)}function Mj(i){return"neurohub"in i?xt.resolve(i.neurohub.clio.auth.getAuthResponse().id_token):xt.resolve("")}class Aj extends Fc{constructor(e,t){super(),this.authServer=e,this.retry=t,this.get=wh(n=>{const r=new Ye(!0);let s;return new xt((a,l)=>{const d=()=>{s=void 0,r.dispose()};n.add(()=>{s!==void 0&&(s.cancel(),s=void 0,r.dispose(),l(ms))});const u=(g="Authorization required.",v="Request authorization.")=>{if(r.setText(g+" "),this.retry){let y=document.createElement("button");y.textContent=v,r.element.appendChild(y),y.addEventListener("click",this.retry)}r.setVisible(!0)};let h=this.authServer;s!==void 0&&s.cancel(),s=new ks,u("Waiting for authorization...","Retry"),this.getAuthToken(h,s).then(g=>{s!==void 0&&(d(),a(g))},g=>{s!==void 0&&(s=void 0,u(`Authorization failed: ${g}.`,"Retry"))})})})}getAuthToken(e,t=Vt){if(e){if(e.startsWith("token:"))return xt.resolve(e.substring(6));if(e=="neurohub")return Mj(window);{const n=new Headers;return ys(e,{method:"GET",headers:n},pE,t).catch(()=>ys(e,{method:"GET"},pE,t))}}else return xt.resolve("")}}const uI="Clio",Nj=/^([^\/]+:\/\/[^\/]+)\/([^\/]+)\/([^\/\?]+)(\?.*)?$/;function Vj(i){let e=i.match(Nj);if(e===null)throw new Error(`Invalid DVID URL: ${re(i)}.`);return{baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]}}function hI(i){let e=Do(i);return e.protocol==="precomputed"&&(e=Do(e.host+e.path)),e}function pI(i){let e=i.protocol,t=i.host,n=i.path;switch(e){case"gs":return`https://storage.googleapis.com/${t}${n}/info`;case"dvid":const r=Vj(t+n);return`${r.baseUrl}/api/node/${r.nodeKey}/${r.dataInstanceKey}/info`;case"https":return`${e}://${t}${n}/info`;default:throw Error("Unrecognized volume information")}}class Oj{constructor(e){this.parameters=e}getTopLevelUrl(){var e=this.parameters;const t=e.baseUrl,n=e.api;return`${t}/${n||"clio_toplevel"}`}getDatasetsUrl(){return`${this.getTopLevelUrl()}/datasets`}getGrayscaleInfoUrl(){let e=hI(this.parameters.grayscale);return pI(e)}getAnnotationEndpoint(){return this.parameters.kind==="Atlas"?"atlas":"annotations"}getAnnotationEntryUrl(){return`${this.getTopLevelUrl()}/${this.getAnnotationEndpoint()}/${this.parameters.dataset}`}getAllAnnotationsUrl(){return this.getAnnotationEntryUrl()+(this.parameters.groups?`?groups=${this.parameters.groups}`:"")}hasPointQueryApi(){return this.parameters.api==="clio_toplevel"||this.parameters.kind==="Atlas"}getPostAnnotationUrl(e){return this.hasPointQueryApi()?`${this.getAnnotationEntryUrl()}?x=${e[0]}&y=${e[1]}&z=${e[2]}`:this.getAnnotationEntryUrl()}getDeleteAnnotationUrl(e){if(this.hasPointQueryApi()){const t=e.match(/(-?\d+)_(-?\d+)_(-?\d+)/);if(t)return this.getAnnotationUrl(t?.slice(1,4))}return`${this.getAnnotationEntryUrl()}/${e}`}getAnnotationUrl(e){return`${this.getAnnotationEntryUrl()}?x=${e[0]}&y=${e[1]}&z=${e[2]}`}}/**
* @license
* This work is a derivative of the Google Neuroglancer project,
* Copyright 2016 Google Inc.
* The Derivative Work is covered by
* Copyright 2019 Howard Hughes Medical Institute
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/class Bj extends Aj{constructor(e){super(e),this.authServer=e}}zo.register(uI,i=>new Bj(i));const _j="annotation.add.signal";Et(_j,function(i){const e=this.get(i.id),t=cv(i.newAnnotation);t&&(e.parent.updateReference(t),e.parent.childAdded.dispatch(t))});class Fj{constructor(e){this.annotation=e}get renderingAttribute(){if(this.kind==="Atlas")if(this.title){if(this.checked)return 1}else return-1;else{if(this.bookmarkType==="False Split")return 2;if(this.bookmarkType==="False Merge")return 3}return 0}get confidence(){return 0}updateProperties(){this.annotation.properties=[this.renderingAttribute,this.confidence]}get ext(){return this.annotation.ext===void 0&&(this.annotation.ext={}),this.annotation.ext}get prop(){return this.annotation.prop}set prop(e){this.annotation.prop=e}get bookmarkType(){if(this.prop)switch(this.prop.type){case"Split":return"False Merge";case"Merge":return"False Split"}return"Other"}get type(){return this.annotation.type}get kind(){return this.annotation.kind}set kind(e){this.annotation.kind=e,this.update()}roundPos(){this.annotation.type===Ie.POINT?this.annotation.point=this.annotation.point.map(e=>Math.round(e)):(this.annotation.type===Ie.LINE||this.annotation.type===Ie.SPHERE)&&(this.annotation.pointA=this.annotation.pointA.map(e=>Math.round(e)),this.annotation.pointB=this.annotation.pointB.map(e=>Math.round(e)))}setProp(e){this.prop=H(H({},this.prop),e)}get user(){return this.prop&&this.prop.user}set user(e){this.setProp({user:e})}get comment(){return this.prop&&this.prop.comment}get description(){return this.comment}updatePresentation(){this.title?this.annotation.description=this.title+": ":this.annotation.description="",this.description&&(this.annotation.description+=this.description)}update(){this.updatePresentation(),this.updateProperties()}set comment(e){this.setProp({comment:e}),this.updatePresentation()}updateComment(){this.comment=this.annotation.description||"",this.annotation.description=void 0}get title(){return this.prop&&this.prop.title}set title(e){this.setProp({title:e}),this.updatePresentation()}get timestamp(){return this.prop&&this.prop.timestamp?Number(this.prop.timestamp):0}addTimeStamp(){this.setProp({timestamp:String(Date.now())})}get checked(){return this.ext&&this.ext.verified||this.prop&&this.prop.checked||!1}set checked(e){this.setProp({checked:e})}get presentation(){return this.updatePresentation(),this.annotation.description||""}set presentation(e){this.annotation.description=e}}function Uj(i){const e=i.split(".")[1];if(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(window.atob(t).split("").map(function(r){return"%"+("00"+r.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(n)}}function fI(i,e){let t;const n=Uj(i);return n&&("user"in n?t=n.user:"email"in n&&(t=n.email)),t||(t=e),t}const zj={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["comment"],properties:{comment:{$id:"#/properties/Prop/properties/comment",type:"string",title:"Comment",default:""}}}}};class Ud extends Fj{get title(){return this.annotation.ext&&this.annotation.ext.title}set title(e){this.ext.title=e}get description(){return this.annotation.ext&&this.annotation.ext.description}set description(e){this.ext.description=e}get user(){return this.annotation.ext&&this.annotation.ext.user}set user(e){this.ext.user=e}get checked(){return this.ext&&this.ext.verified}set checked(e){this.ext.verified=e}}function $j(i){let e=i.match(/^\${(.*):JSON}$/);return e?JSON.parse(e[1]):null}const Gj={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["description"],properties:{description:{$id:"#/properties/Prop/properties/description",type:"string",title:"Description",default:""}}}}},Wj={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["title","description"],properties:{title:{$id:"#/properties/Prop/properties/title",type:"string",title:"Title",default:""},description:{$id:"#/properties/Prop/properties/description",type:"string",title:"Description",default:""}}}}};function gI(i){return Array.isArray(i)}function Hj(i){return gI(i)||i===null?!1:typeof i=="object"}class mI{constructor(e){this.name=e,this.childNodeList=new Array,this.parentNode=null}isRoot(){return this.parentNode===null}isLeaf(){return this.childNodeList.length===0}*[Mi](){function*e(t){yield t;for(let n of t.childNodeList)yield*e(n)}yield*e(this)}*leafNodes(){for(let e of this)e.childNodeList.length===0&&(yield e)}get fullName(){let e=this.name,t=this.parentNode;for(;t;)e=t.name+"/"+e,t=t.parentNode;return e}get nameArray(){let e=new Array;if(!this.isRoot()){e.push(this.name);let t=this.parentNode;for(;t&&!t.isRoot();)e.push(t.name),t=t.parentNode}return e}getPropertyValue(e){if(!this.isRoot()&&e){let t=this.nameArray,n=e;for(let r=t.length-1;r>=0;--r)if(Hj(n)){let s=t[r];n=n[s]}else return n;return n}}}function vI(i,e){if(i.type=="object"){e.properties==null&&(e.properties={}),e.properties.title=i.title;let t=i.required;gI(t)&&t.forEach(n=>{let r=new mI(n);r.parentNode=e,e.childNodeList.push(r);let s=i.properties[n];vI(s,r)})}else e.properties=i}function jj(i,e){let t=new mI(e);return vI(i,t),t}const qj="annotation";function Jj(i,e,t,n=!1){let r=document.createElement("div"),s=i.title;s&&r.appendChild(document.createTextNode(s));let a;switch(i.type){case"number":a=document.createElement("input"),typeof t=="number"&&(a.text=t);break;case"string":let l=i.enum;Array.isArray(l)?(a=document.createElement("select"),r.appendChild(a),l.forEach(d=>{let u=document.createElement("option");u.text=d,u.value=d,u.disabled=n,a.appendChild(u)}),t!==void 0&&(a.value=t)):(a=document.createElement("input"),a.setAttribute("autocomplete","off"),typeof t=="string"&&(a.value=t,a.setAttribute("value",t)));break;case"boolean":a=document.createElement("input"),a.type="checkbox",typeof t=="boolean"?a.checked=t:a.checked=t==1;break}return a&&(a.id=e,a.readOnly=n,r.appendChild(a)),r}function Xj(i,e){return i+"/"+e}function Kj(i,e,t,n=!1){let r=document.createElement("div"),s=jj(i,t);s.record=r;for(let a of s)if(!a.isRoot())if(a.isLeaf()){let l=a.getPropertyValue(e),d=Jj(a.properties,a.fullName,l,n);a.parentNode.record.appendChild(d)}else{let l=document.createElement("fieldset"),d=document.createElement("legend");d.textContent=a.properties.title,l.appendChild(d),a.record=l,a.parentNode.record.appendChild(l)}return r}function Yj(i,e,t=!1){return Kj(i,e,qj,t)}function Zj(i){let e=document.getElementById(i);if(e)return e.type==="checkbox"?e.checked:e.value}function yI(i,e,t,n){i.type==="object"?i.required.forEach(r=>{let s=t;e&&(typeof t[e]>"u"&&(t[e]={}),s=t[e]),yI(i.properties[r],r,s,Xj(n,r))}):t[e]=Zj(n)}function Qj(i,e,t,n,r,s){const a=H({},i.value);if(a.type!==Ie.POINT&&a.type!==Ie.LINE&&a.type!==Ie.SPHERE)return null;e||(e=zj);const l=n(a),d=r?r(a):l.prop;let u=Yj(e,d?{Prop:d}:{},t.readonly),h=document.createElement("button");return h.textContent="update",h.onclick=()=>{let g={};yI(e,"",g,"annotation");const v=g.Prop;s?s(a,v):l.setProp(v),l.update(),t.update(i,a),t.commit(i)},u.appendChild(h),u}let e5=`
{
  "definitions": {},
  "type": "object",
  "required": [
    "Prop"
  ],
  "properties": {
    "Prop": {
      "$id": "#/properties/Prop",
      "type": "object",
      "title": "Properties",
      "required": [
        "comment",
        "type",
        "checked"
      ],
      "properties": {
        "comment": {
          "$id": "#/properties/Prop/properties/comment",
          "type": "string",
          "title": "Comment",
          "default": ""
        },
        "type": {
          "$id": "#/properties/Prop/properties/type",
          "type": "string",
          "title": "Type",
          "enum": ["Merge", "Split", "Other"]
        },
        "checked": {
          "$id": "#/properties/Prop/properties/checked",
          "type": "boolean",
          "title": "Checked"
        }
      }
    }
  }
}
`;JSON.parse(e5);/**
* @license
* This work is a derivative of the Google Neuroglancer project,
* Copyright 2016 Google Inc.
* The Derivative Work is covered by
* Copyright 2019 Howard Hughes Medical Institute
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const t5=lt(64,64,64);class i5{}function n5(i){return i.authServer?i.authServer==="neurohub"||i.authServer.startsWith("http"):!1}class SI extends i5{constructor(){super(...arguments),this.chunkDataSize=t5}}let Hy=class extends SI{};Hy.RPC_ID="clio/Annotation";class bI extends SI{}bI.RPC_ID="clio/AnnotationChunkSource";class r5 extends Pt(It()(So),bI){}async function s5(i){const e=i.grayscale;if(e){let t=hI(e);return qH({method:"GET",url:pI(t)}).then(n=>new rI(n,t.protocol==="https"?"gs":t.protocol))}else return xt.resolve({numChannels:1,voxelSize:lt(8,8,8),lowerVoxelBound:lt(0,0,0),upperVoxelBound:lt(5e4,5e4,5e4),blockSize:lt(64,64,64),numLevels:1})}function a5(i){return[[(e=>{const t=e.upperVoxelBound;return{spec:Cc({rank:3,chunkDataSize:Uint32Array.from(t),lowerVoxelBound:e.lowerVoxelBound,upperVoxelBound:e.upperVoxelBound}),chunkToMultiscaleTransform:Je()}})(i)]]}const o5=Pt(It()(In),Hy);class l5 extends o5{constructor(e,t){super(e,H({rank:3,relationships:["segments"],properties:t.parameters.properties},t)),this.readonly=!1,this.parameters=t.parameters,this.dataInfo=t.dataInfo,this.childAdded=this.childAdded||new Ze,this.childUpdated=this.childUpdated||new Ze,this.childDeleted=this.childDeleted||new Ze,this.makeEditWidget=n=>{const r=l=>new Ud(l),s=l=>H(H({},l.prop),l.ext),a=(l,d)=>{const u=new Ud(l);d.title&&(u.title=d.title),d.description&&(u.description=d.description)};return Qj(n,this.parameters.schema,this,r,s,a)},this.getUser=()=>this.parameters.user}getSources(e){let t=a5(this.dataInfo),n=0;return t[0].length>1&&(n=10),t.map(r=>r.map(({spec:s,chunkToMultiscaleTransform:a})=>({chunkSource:this.chunkManager.getChunkSource(r5,{spec:H({limit:n,chunkToMultiscaleTransform:a},s),parent:this,credentialsProvider:this.credentialsProvider,parameters:this.parameters}),chunkToMultiscaleTransform:a})))}*[Mi](){for(let e of this.references)e[1].value&&(yield e[1].value)}commit(e){e.value&&(e.value.type===Ie.LINE||e.value.type===Ie.SPHERE)&&(e.value.pointA=e.value.pointA.map(t=>Math.round(t)),e.value.pointB=e.value.pointB.map(t=>Math.round(t))),super.commit(e)}add(e,t=!0){if(this.readonly){let r="Permission denied for changing annotations.";throw Ye.showTemporaryMessage(r),Error(r)}const n=new Ud(e);if(n.addTimeStamp(),this.parameters.user&&(n.user=this.parameters.user),e.type===Ie.POINT&&(n.kind=this.parameters.kind||"Note",e.description)){let r=$j(e.description);r&&n.setProp(r)}return n.roundPos(),n.update(),super.add(e,t)}update(e,t){const n=new Ud(t);n.roundPos(),n.update(),super.update(e,t)}invalidateCache(){this.references.forEach(e=>{e.dispose()}),this.references.clear(),this.childRefreshed.dispatch(),this.metadataChunkSource.invalidateCache();for(let e of this.getSources({multiscaleToViewTransform:new Float32Array,displayRank:1,modelChannelDimensionIndices:[]}))for(let t of e)t.chunkSource.invalidateCache();for(let e of this.segmentFilteredSources)e.invalidateCache()}}async function c5(i,e,t,n){return((r,s)=>i.chunkManager.getChunkSource(l5,{parameters:s,credentialsProvider:n,dataInfo:r}))(t,e)}async function d5(i,e,t){const n=await s5(e),r={lowerBounds:new Float64Array(n.lowerVoxelBound),upperBounds:Float64Array.from(n.upperVoxelBound)},s=st({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(n.voxelSize,l=>l/1e9),boundingBoxes:[aa(r)]}),a=await c5(i,e,n,t);return{modelTransform:zi(s),subsources:[{id:"default",subsource:{annotation:a},default:!0}]}}const u5=/^([^\/]+:\/\/[^\/]+)\/(?:([^\/\?#]+)\/)?([^\/\?#]+)(?:(?:\?|#)(.*))?$/;function h5(i){let e=i.match(u5);if(e===null)throw new Error(`Invalid Clio URL: ${re(i)}.`);let t={baseUrl:e[1],api:e[2],dataset:e[3]},n=e[4];if(n){let r=gc(n);r.token?(t.authToken=r.token,t.authServer="token:"+r.token):r.auth&&(t.authServer=r.auth),r.user?t.user=r.user:t.authToken&&(t.user=fI(t.authToken)),r.kind?r.kind==="atlas"?t.kind="Atlas":t.kind=r.kind:t.kind="Normal",r.groups&&(t.groups=r.groups)}return t}async function p5(i,e){const t=new Oj(i);return Pj(e(i.authServer),n5(i),{url:t.getDatasetsUrl(),method:"GET"}).then(n=>{const r=K(n,i.dataset,ge);if("location"in r)i.grayscale=K(r,"location",Le);else if("mainLayer"in r){const s=K(r,"mainLayer",Le),a=K(r,"neuroglancer",ge).layers.find(l=>l.name===s);a.source&&a.source.url?i.grayscale=K(a.source,"url",Le):i.grayscale=K(a,"source",Le)}return i})}async function f5(i,e){let t=h5(i.providerUrl);if(!t.user&&t.authServer){let n=e(t.authServer).get();t.authToken=(await n).credentials,t.user=fI(t.authToken)}return i.chunkManager.memoize.getUncounted(H({type:"clio:MultiscaleVolumeChunkSource"},t),async()=>{t=await p5(t,e);let n=H(H({},new Hy),t);t.kind==="Atlas"?n.schema=Wj:n.schema=Gj,n.properties=[{identifier:"rendering_attribute",description:"rendering attribute",type:"int32",default:0,min:0,max:5,step:1}];const r=e(t.authServer);return d5(i,n,r)})}async function g5(i){return xt.resolve({offset:0,completions:[{value:""}]})}class m5 extends oa{constructor(e){super(),this.credentialsManager=e,this.description="Clio"}getCredentialsProvider(e){let t="";return e&&(t=e),this.credentialsManager.getCredentialsProvider(uI,t)}get(e){return f5(e,this.getCredentialsProvider.bind(this))}completeUrl(e){return g5(e.providerUrl)}}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/da("clio",i=>new m5(i.credentialsManager));/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const Mh="google-brainmaps";function ja(i,e,t,n=Vt){return Js(e,`${i.serverUrl}${t.path}`,{method:t.method,body:t.payload},t.responseType==="json"?sr:$4,n)}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var br;(function(i){i[i.RAW=0]="RAW",i[i.JPEG=1]="JPEG",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"})(br||(br={}));class wI{}wI.RPC_ID="brainmaps/VolumeChunkSource";let CI=class{};CI.RPC_ID="brainmaps/MultiscaleMeshSource";let xI=class{};xI.RPC_ID="brainmaps/MeshSource";let kI=class{};kI.RPC_ID="brainmaps/SkeletonSource";let EI=class{};EI.RPC_ID="brainmaps/Annotation";let LI=class{};LI.RPC_ID="brainmaps/AnnotationSpatialIndex";class v5 extends Pt(It()(Bc),wI){}class y5 extends Pt(It()(yh),CI){}class S5 extends Pt(It()(Ac),xI){}class b5 extends Pt(It()(Sh),kI){}class w5 extends Pt(It()(So),LI){}const $c=new ce;$c.set("UINT8",q.UINT8);$c.set("FLOAT",q.FLOAT32);$c.set("UINT32",q.UINT32);$c.set("UINT64",q.UINT64);function C5(i){ge(i);try{return{corner:K(i,"corner",e=>ru(Ne(),e,vt)),size:K(i,"size",e=>ru(Ne(),e,vi)),metadata:K(i,"metadata",Dn)}}catch(e){throw new Error(`Failed to parse bounding box: ${e.message}`)}}class x5{constructor(e){try{ge(e),this.numChannels=K(e,"channelCount",ai),this.dataType=K(e,"channelType",t=>mL(t,$c)),this.voxelSize=K(e,"pixelSize",t=>ru(Ne(),t,vi)),this.upperVoxelBound=K(e,"volumeSize",t=>ru(Ne(),t,ai)),this.boundingBoxes=K(e,"boundingBox",t=>t===void 0?[]:We(t,C5))}catch(t){throw new Error(`Failed to parse BrainMaps volume geometry: ${t.message}`)}}}function k5(i){return ge(i),{name:K(i,"name",Le),type:K(i,"type",Le)}}function E5(i){try{return ge(i),K(i,"meshes",e=>e===void 0?[]:We(e,k5))}catch(e){throw new Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}}const L5="([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",ig="([0-9]+)",TI=new RegExp(`^(.*)_${ig}x${ig}x${ig}_lod([0-9]+)_${L5}$`);function T5(i,e){const t=new ce,n=i.scales[0],r=new $e;for(const a of e){if(a.type!=="TRIANGLES")continue;const l=a.name.match(TI);if(l===null)continue;const d=l[1];let u=t.get(d);u===void 0&&(u={key:d,chunkShape:Ne(),lods:[]},t.set(d,u));const h=parseInt(l[5]);if(u.lods[h]!==void 0){r.add(d);continue}const g=lt(parseInt(l[2],10),parseInt(l[3],10),parseInt(l[4],10)),v=new Uint32Array(3);for(let y=0;y<3;++y)v[y]=Math.ceil(n.upperVoxelBound[y]/g[y]);u.lods[h]={info:a,scale:parseFloat(l[6]),relativeBlockShape:g,gridShape:v}}const s=[];e:for(const a of t.values()){if(r.has(a.key))continue e;const l=a.lods[0];if(l===void 0)continue e;const d=l.relativeBlockShape;iL(a.chunkShape,d,n.voxelSize);for(let u=1;u<a.lods.length;++u){const h=a.lods[u];if(h===void 0)continue e;const g=h.relativeBlockShape;for(let v=0;v<3;++v){const y=g[v],C=d[v];if(y<C||y%C!==0)continue e;g[v]=y/C}}d.fill(1),s.push(a)}return s}function D5(i,e){const t=T5(i,e),n=[],r=a=>{n.some(l=>l.name===a.name)||n.push(a)},s=new $e;for(const a of t){r({multi:a,single:void 0,name:a.key,partOfMultiscale:!1});for(const l of a.lods)s.add(l.info)}for(const a of e)r({single:a,multi:void 0,name:a.name,partOfMultiscale:s.has(a)});return n}class P5{constructor(e){try{ge(e);let t=this.scales=K(e,"geometry",a=>We(a,l=>new x5(l)));if(t.length===0)throw new Error("Expected at least one scale.");let n=t[0],r=this.numChannels=n.numChannels,s=this.dataType=n.dataType;for(let a=1,l=t.length;a<l;++a){let d=t[a];if(d.dataType!==s)throw new Error(`Scale ${a} has data type ${q[d.dataType]} but scale 0 has data type ${q[s]}.`);if(d.numChannels!==r)throw new Error(`Scale ${a} has ${d.numChannels} channel(s) but scale 0 has ${r} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(n.upperVoxelBound)}}catch(t){throw new Error(`Failed to parse BrainMaps multiscale volume specification: ${t.message}`)}}getModelSpace(e=!1){const t=this.scales[0],n=["x","y","z"],r=["m","m","m"],s=Ee(t.voxelSize,l=>l/1e9),a=Ee(t.upperVoxelBound);return e&&(n.push("c^"),r.push(""),s.push(1),a.push(this.numChannels)),st({names:n,units:r,scales:Float64Array.from(s),boundingBoxes:[aa({lowerBounds:new Float64Array(n.length),upperBounds:Float64Array.from(a)})]})}}let I5=class extends Ds{constructor(i,e,t,n,r,s,a){super(i),this.instance=e,this.credentialsProvider=t,this.volumeId=n,this.changeSpec=r,this.multiscaleVolumeInfo=s,this.encoding=a.encoding,this.jpegQuality=a.jpegQuality,this.chunkLayoutPreference=a.chunkLayoutPreference;let l=fi.IMAGE;this.dataType===q.UINT64&&(l=fi.SEGMENTATION),this.volumeType=l}get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return this.multiscaleVolumeInfo.numChannels!==1?4:3}getSources(i){let e=br.RAW;(this.dataType===q.UINT64||this.dataType===q.UINT32)&&this.volumeType===fi.SEGMENTATION&&this.encoding!==br.RAW?e=br.COMPRESSED_SEGMENTATION:this.volumeType===fi.IMAGE&&this.dataType===q.UINT8&&this.multiscaleVolumeInfo.numChannels===1&&this.encoding!==br.RAW&&i.discreteValues!==!0&&(e=br.JPEG);const t=e===br.JPEG?this.jpegQuality:void 0,n=this.scales[0],r=n.upperVoxelBound,s=Ne(),a=this.rank;return dc(this.scales.map((l,d)=>{ug(s,l.voxelSize,n.voxelSize);let u=l.upperVoxelBound,h,g=l.numChannels;const v=new Float32Array((a+1)**2);v[(a+1)*a+a]=1;const y=new Float32Array(a);g!==1&&(u=Float32Array.of(...u,g),h=Uint32Array.of(1,1,1,g),v[(a+1)*3+3]=1,y[3]=g);for(let C=0;C<3;++C)v[(a+1)*C+C]=s[C],y[C]=r[C]/s[C];return zc({rank:a,minBlockSize:h,chunkToMultiscaleTransform:v,dataType:l.dataType,upperVoxelBound:u,volumeType:this.volumeType,volumeSourceOptions:i,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:lt(64,64,64)}).map(C=>({chunkSource:this.chunkManager.getChunkSource(v5,{credentialsProvider:this.credentialsProvider,spec:C,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:d,encoding:e,jpegQuality:t,instance:this.instance}}),chunkToMultiscaleTransform:v,upperClipBound:y}))}))}};function R5(i){const e=Je(),t=i.scales[0].voxelSize;for(let n=0;n<3;++n)e[5*n]=1/t[n];return e}function M5(i){const e=i.match(/^([^:?\/]+:[^:?\/]+:[^:?\/]+)(?::([^:?\/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(e===null)throw new Error(`Invalid Brain Maps volume key: ${re(i)}.`);let t;e[2]!==void 0&&(t={changeStackId:e[2]});const n=gc(e[4]||"");return{volumeId:e[1],changeSpec:t,meshName:e[3],parameters:n}}function A5(i){try{return ge(i),{id:K(i,"id",Le),label:K(i,"label",Le),description:K(i,"description",Dn)}}catch(e){throw new Error(`Failed to parse project: ${e.message}`)}}function N5(i){try{return ge(i),K(i,"project",e=>e===void 0?[]:We(e,A5))}catch(e){throw new Error(`Error parsing project list: ${e.message}`)}}function fE(i,e){try{return ge(i),K(i,e,t=>t===void 0?[]:We(t,Le))}catch(t){throw new Error(`Error parsing dataset list: ${t.message}`)}}function V5(i){return K(i,"changeStackId",e=>e===void 0?void 0:We(e,Le))}const O5=Pt(It()(In),EI);class B5 extends O5{constructor(e,t){super(e,H({rank:3,relationships:["segments"],properties:[]},t)),this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}hasNonSerializedProperties(){return!0}getSources(){const e=this.parameters.upperVoxelBound,t=Cc({rank:3,chunkDataSize:e,upperVoxelBound:e}),n=Je();return[[{chunkSource:this.chunkManager.getChunkSource(w5,{parent:this,spec:H({limit:0,chunkToMultiscaleTransform:n},t),parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:n}]]}}const _5=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}];class DI extends oa{constructor(e,t){super(),this.instance=e,this.credentialsProvider=t}get description(){return this.instance.description}getMultiscaleInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance,credentialsProvider:oi(this.credentialsProvider)},()=>ja(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes/${t}`,responseType:"json"}).then(n=>new P5(n)))}getMeshesInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance,credentialsProvider:oi(this.credentialsProvider)},()=>ja(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/objects/${t}/meshes`,responseType:"json"}).then(n=>E5(n)))}get(e){var t=M5(e.providerUrl);const n=t.volumeId,r=t.changeSpec,s=t.meshName,a=t.parameters;ge(a);const l=ye(a,"encoding",g=>Ri(g,br)),d=ye(a,"jpegQuality",g=>{const v=ui(g);if(v<1||v>100)throw new Error(`Expected integer in range [1, 100], but received: ${g}`);return v},70),u=ye(a,"chunkLayout",g=>Ri(g,to)),h={encoding:l,chunkLayoutPreference:u,jpegQuality:d};return e.chunkManager.memoize.getUncounted({type:"brainmaps:get",instance:this.instance,volumeId:n,changeSpec:r,brainmapsOptions:h},async()=>{var g=await xt.all([this.getMultiscaleInfo(e.chunkManager,n),this.getMeshesInfo(e.chunkManager,n)]),v=ae(g,2);const y=v[0],C=v[1],w=new I5(e.chunkManager,this.instance,this.credentialsProvider,n,r,y,h),b={modelTransform:zi(y.getModelSpace(y.numChannels!==1)),subsources:[{id:s===void 0?"default":"volume",subsource:{volume:w},default:s===void 0}]},k=yc(y.box);y.scales[0].boundingBoxes.forEach((P,T)=>{k.add({type:Ie.AXIS_ALIGNED_BOUNDING_BOX,description:P.metadata,pointA:P.corner,pointB:eL(Ne(),P.corner,P.size),id:`boundingBox${T}`,properties:[]})}),b.subsources.push({id:"bounds",subsource:{staticAnnotations:k},default:!0});const L=D5(y,C),I=(P,T)=>{let R;const M=P.single;if(M!==void 0)M.type==="TRIANGLES"?R=e.chunkManager.getChunkSource(S5,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:n,meshName:M.name,changeSpec:r}}):R=e.chunkManager.getChunkSource(b5,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:n,meshName:P.name,changeSpec:r}});else{const V=P.multi;R=e.chunkManager.getChunkSource(y5,{credentialsProvider:this.credentialsProvider,format:{fragmentRelativeVertices:!1,vertexPositionFormat:Dr.float32},parameters:{instance:this.instance,volumeId:n,info:V,changeSpec:r}})}b.subsources.push({id:s===void 0?`/${P.name}`:"default",subsource:{mesh:R},subsourceToModelSubspaceTransform:R5(y),modelSubspaceDimensionIndices:[0,1,2],default:T})};if(s!==void 0){const P=L.find(T=>T.name===s);if(P===void 0)throw new Error(`Mesh/skeleton source not found: ${re(P)}`);I(P,!0)}else{let P=!0;for(const T of L)T.partOfMultiscale||(I(T,P),P=!1)}return r!==void 0&&b.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.chunkManager.getChunkSource(B5,{parameters:{volumeId:n,changestack:r.changeStackId,instance:this.instance,upperVoxelBound:y.scales[0].upperVoxelBound},credentialsProvider:this.credentialsProvider})}}),b})}getProjectList(e){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getProjectList"},()=>{let t=ja(this.instance,this.credentialsProvider,{method:"GET",path:"/v1beta2/projects",responseType:"json"}).then(r=>N5(r));const n=`${this.instance.description} project list`;return Ye.forPromise(t,{delay:!0,initialMessage:`Retrieving ${n}.`,errorPrefix:`Error retrieving ${n}: `}),t})}getDatasetList(e,t){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},()=>{let n=ja(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/datasets?project_id=${t}`,responseType:"json"}).then(s=>fE(s,"datasetIds"));const r=`${this.instance.description} dataset list`;return Ye.forPromise(n,{delay:!0,initialMessage:`Retrieving ${r}`,errorPrefix:`Error retrieving ${r}`}),n})}getVolumeList(e,t,n){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:${n}:getVolumeList`},()=>{let r=ja(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes?project_id=${t}&dataset_id=${n}`,responseType:"json"}).then(a=>{const l=fE(a,"volumeId"),d=t.length+n.length+2,u=[];for(const h of l)u.push(h.substring(d));return u});const s=`${this.instance.description} volume list`;return Ye.forPromise(r,{delay:!0,initialMessage:`Retrieving ${s}`,errorPrefix:`Error retrieving ${s}`}),r})}getChangeStackList(e,t){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},()=>{let n=ja(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/changes/${t}/change_stacks`,responseType:"json"}).then(s=>V5(s));const r=`change stacks for ${t}`;return Ye.forPromise(n,{delay:!0,initialMessage:`Retrieving ${r}.`,errorPrefix:`Error retrieving ${r}: `}),n})}async completeUrl(e){const t=e.providerUrl,n=t.match(/^([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(n===null)throw null;var r=ae(n,7);const s=r[1],a=r[2],l=r[3],d=r[4],u=r[5],h=r[6];if(h!==void 0)return _o(t.length-h.length,await Y2(h,_5));if(u!==void 0){const v=`${s}:${a}:${l}`,y=await this.getMeshesInfo(e.chunkManager,v),C=[],w=new $e;for(const b of y)if(b.name.startsWith(u))switch(b.type){case"LINE_SEGMENTS":C.push({value:b.name,description:"Skeletons"});break;case"TRIANGLES":{C.push({value:b.name,description:"Mesh (single-resolution)"});const k=b.name.match(TI);if(k!==null){const L=k[1];if(w.has(L))break;w.add(L),C.push({value:L,description:"Mesh (multi-resolution)"})}break}}return C.sort((b,k)=>Lc(b.value,k.value)),{offset:t.length-u.length,completions:C}}if(d!==void 0){const v=`${s}:${a}:${l}`,y=await this.getChangeStackList(e.chunkManager,v);if(y===void 0)throw null;return{offset:t.length-d.length,completions:Lf(d,y)}}if(l!==void 0)return{offset:t.length-l.length,completions:Lf(l,await this.getVolumeList(e.chunkManager,s,a))};if(a!==void 0){const v=await this.getDatasetList(e.chunkManager,s);return{offset:t.length-a.length,completions:Lf(a,v.map(y=>`${y}:`))}}const g=await this.getProjectList(e.chunkManager);return{offset:0,completions:Fo(s,g,v=>`${v.id}:`,v=>v.label)}}}const F5={description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"};da("brainmaps",i=>new DI(F5,i.credentialsManager.getCredentialsProvider(Mh)));if(typeof NEUROGLANCER_BRAINMAPS_SERVERS<"u")for(const i of Tc(NEUROGLANCER_BRAINMAPS_SERVERS)){var gE=ae(i,2);const e=gE[0],t=gE[1];da(`brainmaps-${e}`,n=>new DI(t,n.credentialsManager.getCredentialsProvider(Mh)))}const U5="https://accounts.google.com/o/oauth2/auth",mE="https://accounts.google.com";function z5(i,e){let t=document.createElement("iframe");t.style.display="none",t.id=i,t.name=i;const n=location.origin;t.src=`https://accounts.google.com/o/oauth2/postmessageRelay?parent=${encodeURIComponent(n)}#rpctoken=${e}`,document.body.appendChild(t)}class $5{constructor(){this.finished=new Ze}}class G5{constructor(){this.proxyName=`postmessageRelay${lu()}`,this.rpcToken=`${lu()}`,this.relayReadyService=`oauth2relayReady:${this.rpcToken}`,this.oauth2CallbackService=`oauth2callback:${this.rpcToken}`,this.pendingRequests=new ce,z5(this.proxyName,this.rpcToken),this.relayReadyPromise=new xt(e=>{addEventListener("message",t=>{if(t.origin===mE)try{let n=ge(JSON.parse(t.data)),r=Le(n.s);if(r===this.relayReadyService&&e(),r===this.oauth2CallbackService){let s=We(n.a,k=>k),a=Le(s[0]),l=location.origin;if(!a.startsWith(l+"#")&&!a.startsWith(l+"?"))throw new Error(`oauth2callback: URL ${re(a)} does not match current origin ${l}.`);let d=a.substring(l.length+1).split("&"),u=new ce;for(let k of d){let L=k.match("^([a-z_]+)=(.*)$");if(L===null)throw new Error(`oauth2callback: URL part ${re(L)} does not match expected pattern.`);u.set(L[1],L[2])}let h=u.get("state");if(h===void 0)throw new Error("oauth2callback: State argument is missing.");let g=this.pendingRequests.get(h);if(g===void 0)return;let v=u.get("error");if(v!==void 0){let k=u.get("error_subtype"),L=v;k!==void 0&&(L+=": "+k),g.finished.dispatch(void 0,new Error(`Error obtaining Google OAuth2 token: ${L}`));return}let y=u.get("access_token"),C=u.get("token_type"),w=u.get("expires_in"),b=u.get("scope");if(y===void 0||C===void 0||w===void 0||b===void 0)throw new Error("oauth2callback: URL lacks expected parameters.");g.finished.dispatch({accessToken:y,tokenType:C,expiresIn:w,scope:b});return}}catch(n){throw new Error(`Invalid message received from ${mE}: ${re(t.data)}: ${n.message}.`)}})})}addPendingRequest(e){let t=new $5;return this.pendingRequests.set(e,t),t.finished.add(()=>{this.pendingRequests.delete(e)}),t}makeAuthRequestUrl(e){let t=`${U5}?client_id=${encodeURIComponent(e.clientId)}`;t+="&redirect_uri=postmessage",t+="&response_type=token";var n=e.origin;let r=n===void 0?location.origin:n;return t+=`&origin=${encodeURIComponent(r)}`,t+=`&proxy=${this.proxyName}`,t+="&include_granted_scopes=true",t+=`&scope=${encodeURIComponent(e.scopes.join(" "))}`,e.state&&(t+=`&state=${e.state}`),e.approvalPrompt&&(t+=`&approval_prompt=${encodeURIComponent(e.approvalPrompt)}`),e.loginHint&&(t+=`&login_hint=${encodeURIComponent(e.loginHint)}`),e.immediate&&(t+="&immediate=true"),e.authUser!==void 0&&(t+=`&authuser=${e.authUser}`),t}}let ng;function W5(){return ng===void 0&&(ng=new G5),ng}function H5(i,e=Vt){const t=lu(),n=W5(),r=n.makeAuthRequestUrl({state:t,clientId:i.clientId,scopes:i.scopes,approvalPrompt:i.approvalPrompt,loginHint:i.loginHint,immediate:i.immediate,authUser:i.authUser}),s=n.addPendingRequest(t),a=new xt((l,d)=>{s.finished.add((u,h)=>{u!==void 0?l(u):d(h)})});if(s.finished.add(e.add(()=>{s.finished.dispatch(void 0,ms)})),i.immediate)n.relayReadyPromise.then(()=>{if(e.isCanceled)return;const l=document.createElement("iframe");l.src=r,l.style.display="none",document.body.appendChild(l),s.finished.add(()=>{kt(l)})});else if(!e.isCanceled){const l=open(r);l!==null&&s.finished.add(()=>{l.close()})}return a}class j5 extends Fc{constructor(e){super(),this.options=e,this.get=wh(t=>{const n=this.options,r=new Ye(!0);let s;return new xt((a,l)=>{const d=()=>{s=void 0,r.dispose()};t.add(()=>{s!==void 0&&(s.cancel(),s=void 0,r.dispose(),l(ms))});function u(g=`${n.description} authorization required.`,v="Request authorization."){r.setText(g+"  ");let y=document.createElement("button");y.textContent=v,r.element.appendChild(y),y.addEventListener("click",()=>{h(!1)}),r.setVisible(!0)}function h(g){s!==void 0&&s.cancel(),s=new ks,u(`Waiting for ${n.description} authorization...`,"Retry"),H5({clientId:n.clientId,scopes:n.scopes,immediate:g,authUser:0},s).then(v=>{s!==void 0&&(d(),a(v))},v=>{s!==void 0&&(s=void 0,g?u():u(`${n.description} authorization failed: ${v}.`,"Retry"))})}h(!0)})})}}/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const q5="https://www.googleapis.com/auth/brainmaps";class PI extends j5{constructor(e){super({clientId:e,scopes:[q5],description:"Brain Maps"})}}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/zo.register(Mh,()=>new PI(BRAINMAPS_CLIENT_ID));/**
* @license
* Copyright 2016 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var Uu;(function(i){i[i.RAW=0]="RAW",i[i.JPEG=1]="JPEG",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i[i.COMPRESSO=3]="COMPRESSO",i[i.PNG=4]="PNG"})(Uu||(Uu={}));let II=class{};II.RPC_ID="precomputed/VolumeChunkSource";class RI{}RI.RPC_ID="precomputed/MeshSource";var zu;(function(i){i[i.RAW=0]="RAW",i[i.GZIP=1]="GZIP"})(zu||(zu={}));var Fm;(function(i){i[i.IDENTITY=0]="IDENTITY",i[i.MURMURHASH3_X86_128=1]="MURMURHASH3_X86_128"})(Fm||(Fm={}));class MI{}MI.RPC_ID="precomputed/MultiscaleMeshSource";class AI{}AI.RPC_ID="precomputed/SkeletonSource";class NI{}NI.RPC_ID="precomputed/AnnotationSpatialIndexSource";class VI{}VI.RPC_ID="precomputed/AnnotationSource";class OI{}OI.RPC_ID="precomputed/IndexedSegmentPropertySource";/**
* @license
* Copyright 2020 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/async function J5(i,e,t,n,r){const s=await Js(i,`https://www.googleapis.com/storage/v1/b/${e}/o?delimiter=${encodeURIComponent(n)}&prefix=${encodeURIComponent(t)}&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,{},sr,r);ge(s);const a=ye(s,"prefixes",Ln,[]),l=ye(s,"items",d=>We(d,u=>(ge(u),K(u,"name",Le))),[]).filter(d=>!d.endsWith("_$folder$"));return[...a,...l]}async function X5(i,e,t,n,r){if(!n.startsWith("/"))throw null;const s=await J5(i,t,n.substring(1),"/",r);let a=n.lastIndexOf("/");return{offset:a+e.length+1,completions:s.map(l=>({value:l.substring(a)}))}}/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/async function K5(i,e,t){var n=await $o(t,i,{headers:{accept:"text/html"}},async u=>({text:await u.text(),contentType:u.headers.get("content-type")}),e);const r=n.text,s=n.contentType;if(s===null||/\btext\/html\b/i.exec(s)===null)return[];const a=new DOMParser().parseFromString(r,"text/html"),l=a.evaluate("//a/@href",a,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),d=[];for(let u=0,h=l.snapshotLength;u<h;++u){const g=l.snapshotItem(u).textContent;g&&d.push(new URL(g,i).toString())}return d}async function Y5(i,e,t){console.log("getHtmlPathCompletions");const n=i.match(/^([a-z]+:\/\/.*\/)([^\/?#]*)$/);if(n===null)throw null;const r=await K5(n[1],e,t),s=n[1].length,a=[];for(const l of r)l.startsWith(i)&&a.push({value:l.substring(s)});return{offset:s,completions:a}}const Z5=[{value:"gs://",description:"Google Cloud Storage (JSON API)"},{value:"gs+xml://",description:"Google Cloud Storage (XML API)"},{value:"gs+json://",description:"Google Cloud Storage (storage JSON API)"},{value:"gs+ngauth+http://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+ngauth+https://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+xml+ngauth+http://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"gs+xml+ngauth+https://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"s3://",description:"Amazon Simple Storage Service (S3)"},{value:"https://"},{value:"http://"}];async function jy(i,e,t){if(!e.includes("://"))return{offset:0,completions:Fo(e,Z5,y=>y.value,y=>y.description)};var n=Uc(e,i);const r=n.url,s=n.credentialsProvider,a=e.length-r.length;let l;try{l=Do(r)}catch{throw null}var d=l;const u=d.protocol,h=d.host,g=d.path,v=await(async()=>{if(u==="gs+xml"&&g.length>0)return await Qg(s,`${u}://${h}`,`https://storage.googleapis.com/${h}`,g,t);if((u==="gs"||u==="gs+json")&&g.length>0)return await X5(s,`${u}://${h}`,h,g,t);if(u==="s3"&&g.length>0)return await K4(h,g,t);const y=r.match(/^((?:http|https):\/\/(?:storage\.googleapis\.com\/[^\/]+|[^\/]+\.storage\.googleapis\.com|[^\/]+\.s3(?:[^./]+)?\.amazonaws.com))(\/.*)$/);if(y!==null)return await Qg(s,y[1],y[1],y[2],t);if((u==="http"||u==="https")&&g.length>0)return await Y5(r,t,s);throw null})();return{offset:a+v.offset,completions:v.completions}}class Q5 extends Pt(It()(Bc),II){}class e8 extends Pt(It()(Ac),RI){}class t8 extends Pt(It()(yh),MI){}class i8 extends Pt(It()(Sh),AI){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}}function Ks(i,e){const t=i.split("/");for(const n of e.split("/")){if(n===".."&&t.length!==0){t.length=t.length-1;continue}t.push(n)}return t.join("/")}class n8{constructor(e,t){ge(e);const n=t===1?3:4,r=this.resolution=new Float64Array(n),s=this.voxelOffset=new Float32Array(n),a=this.size=new Float32Array(n);if(n===4&&(r[3]=1,a[3]=t),K(e,"resolution",l=>rt(r.subarray(0,3),l,vi)),ye(e,"voxel_offset",l=>rt(s.subarray(0,3),l,ui)),K(e,"size",l=>rt(a.subarray(0,3),l,ai)),this.chunkSizes=K(e,"chunk_sizes",l=>We(l,d=>{const u=new Uint32Array(n);return n===4&&(u[3]=t),rt(u.subarray(0,3),d,ai),u})),this.chunkSizes.length===0)throw new Error("No chunk sizes specified.");if(this.sharding=K(e,"sharding",Ah),this.sharding!==void 0&&this.chunkSizes.length!==1)throw new Error("Sharding requires a single chunk size per scale");(this.encoding=K(e,"encoding",l=>Ri(l,Uu)))===Uu.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=K(e,"compressed_segmentation_block_size",l=>rt(Ne(),l,ai))),this.key=K(e,"key",Le)}}function r8(i){ge(i);const e=K(i,"data_type",b=>Ri(b,q)),t=K(i,"num_channels",ai),n=K(i,"type",b=>Ri(b,fi)),r=K(i,"mesh",Dn),s=K(i,"skeletons",Dn),a=K(i,"segment_properties",Dn),l=K(i,"scales",b=>We(b,k=>new n8(k,t)));if(l.length===0)throw new Error("Expected at least one scale");const d=l[0],u=t===1?3:4,h=new Float64Array(u),g=new Float64Array(u),v=new Float64Array(u),y=["x","y","z"],C=["m","m","m"];for(let b=0;b<3;++b)h[b]=d.resolution[b]/1e9,g[b]=d.voxelOffset[b],v[b]=g[b]+d.size[b];u===4&&(h[3]=1,v[3]=t,y[3]="c^",C[3]="");const w=st({rank:u,names:y,units:C,scales:h,boundingBoxes:[aa({lowerBounds:g,upperBounds:v})]});return{dataType:e,volumeType:n,mesh:r,skeletons:s,segmentPropertyMap:a,scales:l,modelSpace:w}}class s8 extends Ds{constructor(e,t,n,r){super(e),this.credentialsProvider=t,this.url=n,this.info=r}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}getSources(e){const t=this.info.scales[0].resolution,n=this.rank;return dc(this.info.scales.map(r=>{const s=r.resolution,a=n+1,l=new Float32Array(a*a);l[l.length-1]=1;var d=this.info.modelSpace.boundingBoxes[0].box;const u=d.lowerBounds,h=d.upperBounds,g=new Float32Array(n),v=new Float32Array(n);for(let y=0;y<3;++y){const C=s[y]/t[y];l[a*y+y]=C;const w=r.voxelOffset[y];l[a*n+y]=w*C,g[y]=u[y]/C-w,v[y]=h[y]/C-w}return n===4&&(l[a*3+3]=1,g[3]=u[3],v[3]=h[3]),zc({rank:n,dataType:this.dataType,chunkToMultiscaleTransform:l,upperVoxelBound:r.size,volumeType:this.volumeType,chunkDataSizes:r.chunkSizes,baseVoxelOffset:r.voxelOffset,compressedSegmentationBlockSize:r.compressedSegmentationBlockSize,volumeSourceOptions:e}).map(y=>({chunkSource:this.chunkManager.getChunkSource(Q5,{credentialsProvider:this.credentialsProvider,spec:y,parameters:{url:Ks(this.url,r.key),encoding:r.encoding,sharding:r.sharding}}),chunkToMultiscaleTransform:l,lowerClipBound:g,upperClipBound:v}))}))}}const a8=Pt(It()(In),VI);class o8 extends Pt(It()(So),NI){}class l8 extends a8{constructor(e,t){const n=t.parameters;super(e,{rank:n.rank,relationships:n.relationships.map(r=>r.name),properties:n.properties,parameters:n}),this.readonly=!0,this.metadata=t.metadata,this.credentialsProvider=t.credentialsProvider}getSources(){return[this.metadata.spatialIndices.map(e=>{const t=e.spec;return{chunkSource:this.chunkManager.getChunkSource(o8,{credentialsProvider:this.credentialsProvider,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}})]}}function c8(i,e,t){return i.getChunkSource(e8,{parameters:t,credentialsProvider:e})}function BI(i){return K(i,"transform",e=>{const t=Je();return e!==void 0&&rt(t.subarray(0,12),e,vt),iv(t,t),t})}function d8(i){ge(i);const e=K(i,"@type",Le);let t;if(e==="neuroglancer_legacy_mesh")t=void 0;else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${re(e)}`);{const r=K(i,"lod_scale_multiplier",vi),s=K(i,"vertex_quantization_bits",ai),a=BI(i),l=K(i,"sharding",Ah);t={lodScaleMultiplier:r,transform:a,sharding:l,vertexQuantizationBits:s}}}const n=K(i,"segment_properties",Dn);return{metadata:t,segmentPropertyMap:n}}async function u8(i,e,t){let n;try{n=await qo(i,e,t)}catch(r){if(Eh(r))return{metadata:void 0};throw r}return d8(n)}function vE(i){return i===void 0?zu.RAW:Ri(i,zu)}function Ah(i){if(i===void 0)return;ge(i);const e=K(i,"@type",Le);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${re(e)}`);const t=K(i,"hash",d=>Ri(d,Fm)),n=K(i,"preshift_bits",ui),r=K(i,"shard_bits",ui),s=K(i,"minishard_bits",ui),a=K(i,"minishard_index_encoding",vE),l=K(i,"data_encoding",vE);return{hash:t,preshiftBits:n,shardBits:r,minishardBits:s,minishardIndexEncoding:a,dataEncoding:l}}function h8(i){ge(i);const e=K(i,"@type",Le);if(e!=="neuroglancer_skeletons")throw new Error(`Unsupported skeleton type: ${re(e)}`);const t=BI(i),n=new ce;K(i,"vertex_attributes",a=>{a!==void 0&&We(a,l=>{ge(l);const d=K(l,"id",Le);if(d==="")throw new Error("vertex attribute id must not be empty");if(n.has(d))throw new Error(`duplicate vertex attribute id ${re(d)}`);const u=K(l,"data_type",g=>Ri(g,q)),h=K(l,"num_components",ai);n.set(d,{dataType:u,numComponents:h})})});const r=K(i,"sharding",Ah),s=K(i,"segment_properties",Dn);return{metadata:{transform:t,vertexAttributes:n,sharding:r},segmentPropertyMap:s}}async function p8(i,e,t){const n=await qo(i,e,t);return h8(n)}function _I(){return st({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function FI(i,e,t){var n=await u8(i,e,t);const r=n.metadata,s=n.segmentPropertyMap;if(r===void 0)return{source:c8(i,e,{url:t,lod:0}),transform:Je(),segmentPropertyMap:s};let a;const l=r.vertexQuantizationBits;if(l===10)a=Dr.uint10;else if(l===16)a=Dr.uint16;else throw new Error(`Invalid vertex quantization bits: ${l}`);return{source:i.getChunkSource(t8,{credentialsProvider:e,parameters:{url:t,metadata:r},format:{fragmentRelativeVertices:!0,vertexPositionFormat:a}}),transform:r.transform,segmentPropertyMap:s}}async function UI(i,e,t){var n=await p8(i,e,t);const r=n.metadata,s=n.segmentPropertyMap;return{source:i.getChunkSource(i8,{credentialsProvider:e,parameters:{url:t,metadata:r}}),transform:r.transform,segmentPropertyMap:s}}function qo(i,e,t){return i.memoize.getUncounted({type:"precomputed:metadata",url:t,credentialsProvider:oi(e)},async()=>await $o(e,`${t}/info`,{},sr))}function yE(i){const e=Je(),t=i.scales[0].resolution;for(let n=0;n<3;++n)e[5*n]=1/t[n];return e}async function f8(i,e,t,n){const r=r8(n),s=new s8(i.chunkManager,e,t,r),a=r.modelSpace,l=[{id:"default",default:!0,subsource:{volume:s}},{id:"bounds",default:!0,subsource:{staticAnnotations:yc(a.bounds)}}];if(r.segmentPropertyMap!==void 0){const h=Ks(t,r.segmentPropertyMap),g=await qo(i.chunkManager,e,h),v=Nh(i.chunkManager,e,g);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:v}})}if(r.mesh!==void 0){const h=Ks(t,r.mesh);var d=await FI(i.chunkManager,e,h);const g=d.source,v=d.transform,y=yE(r);ei(y,y,v),l.push({id:"mesh",default:!0,subsource:{mesh:g},subsourceToModelSubspaceTransform:y})}if(r.skeletons!==void 0){const h=Ks(t,r.skeletons);var u=await UI(i.chunkManager,e,h);const g=u.source,v=u.transform,y=yE(r);ei(y,y,v),l.push({id:"skeletons",default:!0,subsource:{mesh:g},subsourceToModelSubspaceTransform:y})}return{modelTransform:zi(a),subsources:l}}async function g8(i,e,t){var n=await UI(i.chunkManager,e,t);const r=n.source,s=n.transform,a=n.segmentPropertyMap,l=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:s}];if(a!==void 0){const d=Ks(t,a),u=await qo(i.chunkManager,e,d),h=Nh(i.chunkManager,e,u);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:h}})}return{modelTransform:zi(_I()),subsources:l}}function rg(i,e){return ge(e),{url:Ks(i,K(e,"key",Le)),sharding:K(e,"sharding",Ah)}}class m8{constructor(e,t){this.url=e,ge(t);const n=K(t,"dimensions",du),r=n.rank,s=K(t,"lower_bound",l=>rt(new Float64Array(r),l,vt)),a=K(t,"upper_bound",l=>rt(new Float64Array(r),l,vt));this.coordinateSpace=st({rank:r,names:n.names,units:n.units,scales:n.scales,boundingBoxes:[aa({lowerBounds:s,upperBounds:a})]}),this.parameters={type:K(t,"annotation_type",l=>Ri(l,Ie)),rank:r,relationships:K(t,"relationships",l=>We(l,d=>{const u=rg(e,d),h=K(d,"id",Le);return H(H({},u),{name:h})})),properties:K(t,"properties",CL),byId:K(t,"by_id",l=>rg(e,l))},this.spatialIndices=K(t,"spatial",l=>We(l,d=>{const u=rg(e,d),h=K(d,"grid_shape",b=>rt(new Float32Array(r),b,ai)),g=K(d,"chunk_size",b=>rt(new Float32Array(r),b,vi)),v=K(d,"limit",ai),y=new Float32Array(r);for(let b=0;b<r;++b)y[b]=h[b]*g[b];const C=xs(Float32Array,r+1);for(let b=0;b<r;++b)C[(r+1)*r+b]=s[b];const w=H({limit:v,chunkToMultiscaleTransform:C},Cc({rank:r,chunkDataSize:g,upperVoxelBound:y}));return w.upperChunkBound=h,{parameters:u,spec:w,limit:v}})),this.spatialIndices.reverse()}}async function v8(i,e,t,n){const r=new m8(t,n);return{modelTransform:zi(r.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:i.chunkManager.getChunkSource(l8,{credentialsProvider:e,metadata:r,parameters:r.parameters})}}]}}async function SE(i,e,t){var n=await FI(i.chunkManager,e,t);const r=n.source,s=n.transform,a=n.segmentPropertyMap,l=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:s}];if(a!==void 0){const d=Ks(t,a),u=await qo(i.chunkManager,e,d),h=Nh(i.chunkManager,e,u);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:h}})}return{modelTransform:zi(_I()),subsources:l}}function y8(i){ge(i);const e=new te,t=K(i,"ids",s=>{s=Ln(s);const a=s.length,l=new Uint32Array(a*2);for(let d=0;d<a;++d){if(!e.tryParseString(s[d]))throw new Error(`Invalid uint64 id: ${re(s[d])}`);l[2*d]=e.low,l[2*d+1]=e.high}return l}),n=t.length/2,r=K(i,"properties",s=>We(s,a=>{ge(a);const l=K(a,"id",Le),d=ye(a,"description",Le),u=K(a,"type",g=>{if(g!=="label"&&g!=="description"&&g!=="string"&&g!=="tags"&&g!=="number")throw new Error(`Invalid property type: ${re(g)}`);return g});if(u==="tags"){const g=K(a,"tags",Ln);let v=ye(a,"tag_descriptions",Ln);if(v===void 0)v=new Array(g.length),v.fill("");else if(v.length!==g.length)throw new Error(`Expected tag_descriptions to have length: ${g.length}`);const y=K(a,"values",C=>{if(!Array.isArray(C)||C.length!==n)throw new Error(`Expected ${n} values, but received: ${C.length}`);return C.map(w=>String.fromCharCode(...w))});return{id:l,description:d,type:u,tags:g,tagDescriptions:v,values:y}}if(u==="number"){const g=K(a,"data_type",w=>Ri(w,q));if(g===q.UINT64)throw new Error("uint64 properties not supported");const v=K(a,"values",w=>{if(!Array.isArray(w)||w.length!==n)throw new Error(`Expected ${n} values, but received: ${w.length}`);return sV[g].from(w)});let y=1/0,C=-1/0;for(let w=v.length-1;w>=0;--w){const b=v[w];b<y&&(y=b),b>C&&(C=b)}return{id:l,description:d,type:u,dataType:g,values:v,bounds:[y,C]}}const h=K(a,"values",g=>{if(Ln(g),g.length!==n)throw new Error(`Expected ${n} values, but received: ${g.length}`);return g});return{id:l,description:d,type:u,values:h}}));return KG({ids:t,properties:r})}Pt(It()(WG),OI);function Nh(i,e,t,n){try{const r=K(t,"@type",Le);if(r!=="neuroglancer_segment_properties")throw new Error(`Unsupported segment property map type: ${re(r)}`);const s=ye(t,"inline",y8);return new JD({inlineProperties:s})}catch(r){throw new Error(`Error parsing segment property map: ${r.message}`)}}async function S8(i,e,t,n){return{modelTransform:zi(uo),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:Nh(i.chunkManager,e,n)}}]}}const b8=/^([^#]*)(?:#(.*))?$/;function sg(i){var e=i.match(b8),t=ae(e,3);let n=t[1],r=t[2];n.endsWith("/")&&(n=n.substring(0,n.length-1));const s=gc(r||"");return{url:n,parameters:s}}function bE(i,e){const t=DV(e);return t&&(i+=`#${t}`),i}class w8 extends oa{get description(){return"Precomputed file-backed data source"}normalizeUrl(e){var t=sg(e.providerUrl);const n=t.url,r=t.parameters;return e.providerProtocol+"://"+bE(n,r)}convertLegacyUrl(e){var t=sg(e.providerUrl);const n=t.url,r=t.parameters;return e.type==="mesh"&&(r.type="mesh"),e.providerProtocol+"://"+bE(n,r)}get(e){var t=sg(e.providerUrl);const n=t.url,r=t.parameters;return e.chunkManager.memoize.getUncounted({type:"precomputed:get",providerUrl:n,parameters:r},async()=>{var s=Uc(n,e.credentialsManager);const a=s.url,l=s.credentialsProvider;let d;try{d=await qo(e.chunkManager,l,a)}catch(g){if(Eh(g)&&r.type==="mesh")return await SE(e,l,a);throw g}ge(d);const u=ye(d,"redirect",Le);if(u!==void 0)throw new Z2(u);const h=ye(d,"@type",Le);switch(h){case"neuroglancer_skeletons":return await g8(e,l,a);case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":return await SE(e,l,a);case"neuroglancer_annotations_v1":return await v8(e,l,a,d);case"neuroglancer_segment_properties":return await S8(e,l,a,d);case"neuroglancer_multiscale_volume":case void 0:return await f8(e,l,a,d);default:throw new Error(`Invalid type: ${re(h)}`)}})}completeUrl(e){return jy(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
* @license
* Copyright 2017 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/da("precomputed",()=>new w8);var ag={},wE;function C8(){return wE||(wE=1,ag.__esModule=!0,ag.default=function(i){if(i==null)throw new TypeError("Cannot destructure undefined")}),ag}var x8=C8();const zI=Qe(x8);/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var $u;(function(i){i[i.RAW=0]="RAW",i[i.GZIP=1]="GZIP",i[i.BLOSC=2]="BLOSC"})($u||($u={}));let $I=class{};$I.RPC_ID="n5/VolumeChunkSource";class k8 extends Pt(It()(Bc),$I){}let E8=class extends Ds{constructor(i,e,t,n){super(i),this.credentialsProvider=e,this.multiscaleMetadata=t,this.scales=n;let r,s;if(n.forEach((h,g)=>{if(h!==void 0){if(s===void 0&&(s=g),r!==void 0&&h.dataType!==r)throw new Error(`Scale s${g} has data type ${q[h.dataType]} but expected ${q[r]}.`);r=h.dataType}}),r===void 0)throw new Error("At least one scale must be specified.");const a=t.scales[s],l=n[s];this.dataType=r,this.volumeType=fi.IMAGE,this.baseScaleIndex=s;const d=t.modelSpace,u=d.rank;this.modelSpace=st({names:d.names,scales:d.scales,units:d.units,boundingBoxes:[{transform:Yw(Float64Array,a.downsamplingFactor,!1),box:{lowerBounds:new Float64Array(u),upperBounds:new Float64Array(l.size)}}],coordinateArrays:d.coordinateArrays})}get rank(){return this.modelSpace.rank}getSources(i){zI(this);const e=this.scales,t=this.rank,n=this.multiscaleMetadata.scales;return dc(e.filter(r=>r!==void 0).map((r,s)=>{const a=n[s],l=Yw(Float32Array,a.downsamplingFactor);return zc({rank:t,chunkToMultiscaleTransform:l,dataType:r.dataType,upperVoxelBound:r.size,volumeType:this.volumeType,chunkDataSizes:[r.chunkSize],volumeSourceOptions:i}).map(d=>({chunkSource:this.chunkManager.getChunkSource(k8,{credentialsProvider:this.credentialsProvider,spec:d,parameters:{url:a.url,encoding:r.encoding}}),chunkToMultiscaleTransform:l}))}))}};class L8{constructor(e){ge(e),this.dataType=K(e,"dataType",n=>Ri(n,q)),this.size=Float32Array.from(K(e,"dimensions",n=>We(n,ai))),this.chunkSize=K(e,"blockSize",n=>rt(new Uint32Array(this.size.length),n,ai));let t;ye(e,"compression",n=>{t=K(n,"type",r=>Ri(r,$u))}),t===void 0&&(t=K(e,"compressionType",n=>Ri(n,$u))),this.encoding=t}}function T8(i,e,t){return xt.all(t.scales.map(async n=>{const r=await GI(i,e,n.url,!0);if(r!==void 0)return new L8(r)}))}function D8(i){var e=Do(i);let t=e.protocol,n=e.host,r=e.path;r.endsWith("/")&&(r=r.substring(0,r.length-1));const s=[];for(;;){s.push(`${t}://${n}${r}/attributes.json`);const a=r.lastIndexOf("/");if(a===-1)break;r=r.substring(0,a)}return s}function P8(i,e,t,n){return i.memoize.getUncounted({type:"n5:attributes.json",url:t,credentialsProvider:oi(e)},()=>$o(e,t,{},sr).then(r=>{try{return ge(r)}catch(s){throw new Error(`Error reading attributes from ${t}: ${s.message}`)}}).catch(r=>{if(Eh(r))return n?void 0:{};throw r}))}async function GI(i,e,t,n){const r=D8(t),s=await xt.all(r.map((a,l)=>P8(i,e,a,n&&l===r.length-1)));if(s.indexOf(void 0)===-1)return s.reverse(),H({},...s)}function os(i,e){if(i!==-1&&e!==i)throw new Error(`Rank mismatch, received ${e} but expected ${i}`);return e}function WI(i){return Float64Array.from(We(i,vi))}function HI(i){const e=qn(i);if(e.length===0)throw new Error("Expected non-empty array");let t=-1;return{all:We(e,n=>{const r=WI(n);return t=os(t,r.length),r}),single:void 0,rank:t}}function I8(i){const e=qn(i);if(e.length===0)throw new Error("Expected non-empty array");if(Array.isArray(e[0]))return HI(e);const t=WI(i);return{all:void 0,single:t,rank:t.length}}const R8=["x","y","z","t","c"];function M8(i){const e=R8.slice(0,i);for(;e.length<i;)e.push(`d${e.length+1}`);return e}function A8(i,e){ge(e);let t=-1,n=ye(e,"resolution",v=>{const y=Float64Array.from(We(v,vi));return t=os(t,y.length),y}),r=ye(e,"axes",v=>{const y=We(v,Le);return t=os(t,y.length),y}),s=ye(e,"units",v=>{const y=We(v,rC);return t=os(t,y.length),y}),a={unit:"m",exponent:-9},l,d;ye(e,"downsamplingFactors",v=>{var y=I8(v);const C=y.single,w=y.all,b=y.rank;t=os(t,b),C!==void 0&&(l=C),w!==void 0&&(d=w)}),ye(e,"pixelResolution",v=>{a=K(v,"unit",rC),ye(v,"dimensions",y=>{n=Float64Array.from(We(y,vi)),t=os(t,n.length)})}),ye(e,"scales",v=>{var y=HI(v);const C=y.all,w=y.rank;t=os(t,w),d=C});const u=ye(e,"dimensions",v=>{const y=We(v,ai);return t=os(t,y.length),y});if(t===-1)throw new Error("Unable to determine rank of dataset");s===void 0&&(s=new Array(t),s.fill(a)),n===void 0&&(n=new Float64Array(t),n.fill(1));for(let v=0;v<t;++v)n[v]=pv(n[v],s[v].exponent);const h=new Array(t);r!==void 0&&ye(e,"coordinateArrays",v=>{ge(v);for(let y=0;y<t;++y){const C=r[y];if(Object.prototype.hasOwnProperty.call(v,C)){const w=Ln(v[C]);h[y]={explicit:!1,labels:w,coordinates:Ee(w,(b,k)=>k)},s[y]={unit:"",exponent:0},n[y]=1}}}),r===void 0&&(r=M8(t));const g=st({rank:t,valid:!0,names:r,scales:n,units:s.map(v=>v.unit),coordinateArrays:h});if(u===void 0){if(d===void 0)throw new Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:g,url:i,attributes:e,scales:d.map((v,y)=>({url:`${i}/s${y}`,downsamplingFactor:v}))}}return l===void 0&&(l=new Float64Array(t),l.fill(1)),{modelSpace:g,url:i,attributes:e,scales:[{url:i,downsamplingFactor:l}]}}class N8 extends oa{get description(){return"N5 data source"}get(e){let t=e.providerUrl;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"n5:MultiscaleVolumeChunkSource",providerUrl:t},async()=>{var n=Uc(t,e.credentialsManager);const r=n.url,s=n.credentialsProvider,a=await GI(e.chunkManager,s,r,!1),l=A8(r,a),d=await T8(e.chunkManager,s,l),u=new E8(e.chunkManager,s,l,d);return{modelTransform:zi(u.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:u}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:yc(u.modelSpace.bounds)}}]}})}completeUrl(e){return jy(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/da("n5",()=>new N8);/**
* @license
* Copyright 2019 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/var Za;(function(i){i[i.RAW=0]="RAW",i[i.GZIP=1]="GZIP",i[i.BLOSC=2]="BLOSC"})(Za||(Za={}));class jI{}jI.RPC_ID="zarr/VolumeChunkSource";const wr=new ce;wr.set("|u1",{endianness:qi.LITTLE,dataType:q.UINT8});wr.set("|i1",{endianness:qi.LITTLE,dataType:q.INT8});for(let i of[["<",qi.LITTLE],[">",qi.BIG]]){var CE=ae(i,2);let e=CE[0],t=CE[1];for(let n of["u","i"])wr.set(`${e}${n}8`,{endianness:t,dataType:q.UINT64});wr.set(`${e}u2`,{endianness:t,dataType:q.UINT16}),wr.set(`${e}i2`,{endianness:t,dataType:q.INT16}),wr.set(`${e}u4`,{endianness:t,dataType:q.UINT32}),wr.set(`${e}i4`,{endianness:t,dataType:q.INT32}),wr.set(`${e}f4`,{endianness:t,dataType:q.FLOAT32})}function V8(i){const e=wr.get(i);if(e===void 0)throw new Error(`Unsupported numpy data type: ${re(i)}`);return e}class O8 extends Pt(It()(Bc),jI){}function qI(i){return ye(i,"dimension_separator",e=>{if(e!=="."&&e!=="/")throw new Error(`Expected "." or "/", but received: ${re(e)}`);return e})}function B8(i){try{ge(i),K(i,"zarr_format",l=>{if(l!==2)throw new Error(`Expected 2 but received: ${re(l)}`)});const e=K(i,"shape",l=>We(l,d=>{if(typeof d!="number"||!Ai(d)||d<0)throw new Error(`Expected non-negative integer, but received: ${re(d)}`);return d})),t=K(i,"chunks",l=>rt(new Array(e.length),l,d=>{if(typeof d!="number"||!Ai(d)||d<=0)throw new Error(`Expected positive integer, but received: ${re(d)}`);return d})),n=K(i,"order",l=>{if(l!=="C"&&l!=="F")throw new Error(`Expected "C" or "F", but received: ${re(l)}`);return l}),r=qI(i),s=K(i,"dtype",l=>V8(Le(l))),a=K(i,"compressor",l=>{if(l===null)return Za.RAW;ge(l);const d=K(l,"id",Le);switch(d){case"blosc":return Za.BLOSC;case"gzip":return Za.GZIP;case"zlib":return Za.GZIP;default:throw new Error(`Unsupported compressor: ${re(d)}`)}});return{rank:e.length,shape:e,chunks:t,order:n,dataType:s.dataType,encoding:{compressor:a,endianness:s.endianness},dimensionSeparator:r}}catch(e){throw new Error(`Error parsing zarr metadata: ${e.message}`)}}class _8 extends Ds{constructor(e,t,n,r,s,a){super(e),this.credentialsProvider=t,this.url=n,this.separator=r,this.metadata=s,this.attrs=a,this.dataType=s.dataType,this.volumeType=fi.IMAGE;let l=ye(a,"_ARRAY_DIMENSIONS",d=>rt(new Array(s.rank),d,Le));l===void 0&&(l=Ee(s.shape,(d,u)=>`d${u}`)),this.modelSpace=st({names:l,scales:Float64Array.from(s.shape,()=>1),units:Ee(s.shape,()=>""),boundingBoxes:[aa({lowerBounds:new Float64Array(s.rank),upperBounds:Float64Array.from(s.shape)})]})}get rank(){return this.metadata.rank}getSources(e){const t=this.metadata,n=t.rank,r=t.chunks,s=t.shape;let a,l,d;if(t.order==="F")a=Uint32Array.from(r),l=Float32Array.from(s),d=xs(Float32Array,n+1);else{a=new Uint32Array(n),l=new Float32Array(n),d=new Float32Array((n+1)**2),d[(n+1)**2-1]=1;for(let u=0;u<n;++u)a[u]=r[n-1-u],l[u]=s[n-1-u],d[u+(n-1-u)*(n+1)]=1}return dc([zc({rank:n,chunkToMultiscaleTransform:d,dataType:t.dataType,upperVoxelBound:l,volumeType:this.volumeType,chunkDataSizes:[a],volumeSourceOptions:e}).map(u=>({chunkSource:this.chunkManager.getChunkSource(O8,{credentialsProvider:this.credentialsProvider,spec:u,parameters:{url:this.url,encoding:t.encoding,separator:this.separator}}),chunkToMultiscaleTransform:d}))])}}function F8(i,e,t){return i.memoize.getUncounted({type:"zarr:.zattrs json",url:t,credentialsProvider:oi(e)},async()=>{try{const n=await $o(e,t+"/.zattrs",{},sr);return ge(n),n}catch(n){if(Eh(n))return{};throw n}})}function U8(i,e,t){return i.memoize.getUncounted({type:"zarr:.zarray json",url:t,credentialsProvider:oi(e)},async()=>{const n=await $o(e,t+"/.zarray",{},sr);return B8(n)})}const z8=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}];class $8 extends oa{get description(){return"Zarr data source"}get(e){var t=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),n=ae(t,3);let r=n[1],s=n[2];const a=gc(s||"");ge(a);const l=qI(a);return r.endsWith("/")&&(r=r.substring(0,r.length-1)),e.chunkManager.memoize.getUncounted({type:"zarr:MultiscaleVolumeChunkSource",providerUrl:r,dimensionSeparator:l},async()=>{var d=Uc(r,e.credentialsManager);const u=d.url,h=d.credentialsProvider;var g=await xt.all([U8(e.chunkManager,h,u),F8(e.chunkManager,h,u)]),v=ae(g,2);const y=v[0],C=v[1];if(y.dimensionSeparator!==void 0&&l!==void 0&&y.dimensionSeparator!==l)throw new Error(`Explicitly specified dimension separator ${re(l)} does not match value in .zarray ${re(y.dimensionSeparator)}`);const w=new _8(e.chunkManager,h,u,l||y.dimensionSeparator||".",y,C);return{modelTransform:zi(w.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:w}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:yc(w.modelSpace.bounds)}}]}})}async completeUrl(e){var t=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),n=ae(t,3);let r=n[2];return r!==void 0?_o(e.providerUrl.length-r.length,await Y2(r,z8)):await jy(e.credentialsManager,e.providerUrl,e.cancellationToken)}}/**
* @license
* Copyright 2020 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/da("zarr",()=>new $8);var na;(function(i){i[i.DEFAULT=0]="DEFAULT",i[i.ADDITIVE=1]="ADDITIVE"})(na||(na={}));const G8=new ce([[na.DEFAULT,i=>{i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA)}],[na.ADDITIVE,i=>{i.blendFunc(i.SRC_ALPHA,i.ONE)}]]);function W8(i=na.DEFAULT){return new fh(na,i)}const JI=`#uicontrol invlerp normalized
void main() {
  emitGrayscale(normalized());
}
`;function H8(i=JI){return kv(i)}function XI(i,e){i.addFragmentCode(`
#define VOLUME_RENDERING false

void emitRGBA(vec4 rgba) {
  emit(vec4(rgba.rgb, rgba.a * uOpacity));
}
void emitRGB(vec3 rgb) {
  emit(vec4(rgb, uOpacity));
}
void emitGrayscale(float value) {
  emit(vec4(value, value, value, uOpacity));
}
void emitTransparent() {
  emit(vec4(0.0, 0.0, 0.0, 0.0));
}
`),i.addFragmentCode(tc),ec(e,i),i.setFragmentMainFunction(Yl(e.parseResult.code))}class j8 extends nP{constructor(e,t){var n,r,s;const a=t.opacity,l=t.blendMode,d=t.shaderControlState;super(e,H(H({},t),{fallbackShaderParameters:new ct(Mv(dh(JI,{imageData:{dataType:e.dataType,channelRank:(s=(r=(n=t.channelCoordinateSpace)===null||n===void 0?void 0:n.value)===null||r===void 0?void 0:r.rank)!==null&&s!==void 0?s:0}}))),encodeShaderParameters:u=>u.key,shaderParameters:d.builderState,dataHistogramSpecifications:d.histogramSpecifications})),this.shaderControlState=d,this.opacity=a,this.blendMode=l,this.registerDisposer(a.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(l.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(d.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),XI(e,t)}initializeShader(e,t,n){const r=this.gl;r.uniform1f(t.uniform("uOpacity"),this.opacity.value),mo(r,t,this.shaderControlState,n.parseResult.controls)}setGLBlendMode(e,t){const n=this.blendMode.value;n===na.ADDITIVE||t>0?(e.enable(e.BLEND),G8.get(n)(e)):e.disable(WebGL2RenderingContext.BLEND)}}/**
* @license
* Copyright 2020 Google Inc.
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/const q8="volume_rendering/VolumeRenderingRenderLayer",J8="volume_rendering/VolumeRenderingRenderLayer/update",Um=64,X8=uc();function K8(i,e,t){let n=0,r=0;for(let u=0;u<3;++u){const h=i[16+u],g=h*e[u],v=h*t[u];n+=Math.min(g,v),r+=Math.max(g,v)}const s=-i[19],a=Math.max(s,n),l=i[23],d=Math.min(l,r);return{near:s,far:l,adjustedNear:a,adjustedFar:d}}function xE(i,e,t,n,r,s){if(n.length===0)return;const a=i.viewMatrix,l=i.projectionMat,d=i.displayDimensionRenderInfo.voxelPhysicalScales,u=gg(d),h=(uL(l)/Um)**3,g=tv(th(X8,a)),v=I=>{const P=n[I];return Math.abs(P.chunkLayout.detTransform*g)};let y=n.length-1,C=v(y);for(let I=y-1;I>=0;--I){const P=v(I);if(Math.abs(P-h)<Math.abs(C-h))C=P,y=I;else break}const w=Math.pow(C*u/g,1/3),b=Math.pow(C,1/3)*i.width/(2*l[0]);let k=!0;const L=n[y];O2(i,e,L,(I,P)=>{k&&(r(L,y,w,b,P),k=!1),s(L,y,I)})}const Y8=Je(),Z8=new Float32Array(24);class Q8 extends Uo{constructor(e){super(),this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.renderScaleTarget=e.renderScaleTarget,this.renderScaleHistogram=e.renderScaleHistogram,this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility));const t=this.registerDisposer(cn(a=>a.rank,[this.channelCoordinateSpace]));this.shaderGetter=Ev(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:({emitter:a,chunkFormat:l})=>`${oi(a)}:${l.shaderKey}`,shaderError:e.shaderError,extraParameters:t,defineShader:(a,{emitter:l,chunkFormat:d},u,h)=>{if(u.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");Mr(a),a.addFragmentCode(`
#define VOLUME_RENDERING true
`),l(a),a.addUniform("highp float","uNearLimitFraction"),a.addUniform("highp float","uFarLimitFraction"),a.addUniform("highp int","uMaxSteps"),a.addUniform("highp vec3","uTranslation"),a.addUniform("highp mat4","uModelViewProjectionMatrix"),a.addUniform("highp mat4","uInvModelViewProjectionMatrix"),a.addUniform("highp vec3","uChunkDataSize"),a.addUniform("highp vec3","uLowerClipBound"),a.addUniform("highp vec3","uUpperClipBound"),a.addUniform("highp float","uBrightnessFactor"),a.addVarying("highp vec4","vNormalizedPosition"),a.addVertexCode(VW),a.setVertexMain(`
vec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);
vec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));
vNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
`),a.addFragmentCode(`
vec3 curChunkPosition;
vec4 outputColor;
void userMain();
`),$T(a,d,h,"curChunkPosition"),a.addFragmentCode(`
void emitRGBA(vec4 rgba) {
  float alpha = rgba.a * uBrightnessFactor;
  outputColor += vec4(rgba.rgb * alpha, alpha);
}
void emitRGB(vec3 rgb) {
  emitRGBA(vec4(rgb, 1.0));
}
void emitGrayscale(float value) {
  emitRGB(vec3(value, value, value));
}
void emitTransparent() {
  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));
}
`),a.setFragmentMainFunction(`
void main() {
  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;
  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);
  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);
  vec3 nearPoint = nearPointH.xyz / nearPointH.w;
  vec3 farPoint = farPointH.xyz / farPointH.w;
  vec3 rayVector = farPoint - nearPoint;
  vec3 boxStart = max(uLowerClipBound, uTranslation);
  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);
  float intersectStart = uNearLimitFraction;
  float intersectEnd = uFarLimitFraction;
  for (int i = 0; i < 3; ++i) {
    float startPt = nearPoint[i];
    float endPt = farPoint[i];
    float boxLower = boxStart[i];
    float boxUpper = boxEnd[i];
    float r = rayVector[i];
    float startFraction;
    float endFraction;
    if (startPt >= boxLower && startPt <= boxUpper) {
      startFraction = 0.0;
    } else {
      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    if (endPt >= boxLower && endPt <= boxUpper) {
      endFraction = 1.0;
    } else {
      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    intersectStart = max(intersectStart, startFraction);
    intersectEnd = min(intersectEnd, endFraction);
  }
  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);
  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));
  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);
  outputColor = vec4(0, 0, 0, 0);
  for (int step = startStep; step < endStep; ++step) {
    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(step) * stepSize);
    curChunkPosition = position - uTranslation;
    userMain();
  }
  emit(outputColor, 0u);
}
`),a.addFragmentCode(tc),ec(u,a),a.addFragmentCode(`
#define main userMain
`+Yl(u.parseResult.code)+`
#undef main
`)}}),this.vertexIdHelper=this.registerDisposer(rr.get(this.gl)),this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));const n=this.multiscaleSource.chunkManager,r=this.registerDisposer(new Ec(this.layerChunkProgressInfo)),s=n.rpc;r.RPC_TYPE_ID=q8,r.initializeCounterpart(s,{chunkManager:n.rpcId,localPosition:this.registerDisposer(gi.makeFromExisting(s,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(gi.makeFromExisting(s,this.renderScaleTarget)).rpcId}),this.backend=r}get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer(Pr((t,n,r)=>{const s=zv(r,n,a=>this.multiscaleSource.getSources(a),e.messages,this);for(const a of s)for(const l of a)t.registerDisposer(l.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(J8,{layer:this.backend.rpcId,view:e.view.rpcId,sources:Uv(s)}),this.redrawNeeded.dispatch(),s},this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){if(!e.emitColor)return;const n=t.state.sources.value;if(n.length===0)return;let r=0,s=0,a=null,l,d;const u=Ne(),h=this.gl;this.vertexIdHelper.enable();const g=this.renderScaleHistogram;g.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);const v=()=>{a!==null&&(l!==null&&l.endDrawing(h,a),(b!==0||k!==0)&&g.add(r,s,b,k))};let y=!0;const C=e.projectionParameters;let w,b=0,k=0,L;const I=this.multiscaleSource.rank,P=Ne();h.enable(WebGL2RenderingContext.CULL_FACE),h.cullFace(WebGL2RenderingContext.FRONT),xE(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,n[0],(T,R,M,V)=>{r=M,s=V;const B=Ov(C,T.chunkLayout),F=T.source,j=T.fixedPositionWithinChunk,U=T.chunkDisplayDimensionIndices;for(const Fe of U)j[Fe]=0;const O=F.chunkFormat;if(O!==l&&(l=O,v(),d=this.shaderGetter({emitter:e.emitter,chunkFormat:O}),a=d.shader,a!==null&&(a.bind(),O!==null&&(mo(h,a,this.shaderControlState,d.parameters.parseResult.controls),O.beginDrawing(h,a),O.beginSource(h,a)))),L=void 0,a===null)return;w=F.chunks,u.fill(1);const $=ei(Y8,C.viewProjectionMat,B.transform);h.uniformMatrix4fv(a.uniform("uModelViewProjectionMatrix"),!1,$);const _=Z8;iu(_,$),fs($,$),h.uniformMatrix4fv(a.uniform("uInvModelViewProjectionMatrix"),!1,$);var se=K8(_,T.lowerClipDisplayBound,T.upperClipDisplayBound);const oe=se.near,Re=se.far,le=se.adjustedNear,we=se.adjustedFar,ie=(we-le)/(Um-1)/(Re-oe);h.uniform1f(a.uniform("uBrightnessFactor"),ie);const he=(le-oe)/(Re-oe),Te=(we-oe)/(Re-oe);h.uniform1f(a.uniform("uNearLimitFraction"),he),h.uniform1f(a.uniform("uFarLimitFraction"),Te),h.uniform1i(a.uniform("uMaxSteps"),Um),h.uniform3fv(a.uniform("uLowerClipBound"),T.lowerClipDisplayBound),h.uniform3fv(a.uniform("uUpperClipBound"),T.upperClipDisplayBound)},T=>{if(a===null)return;const R=T.curPositionInChunks.join(),M=w.get(R);if(M!==void 0&&M.state===pt.GPU_MEMORY){const V=T.chunkLayout.size;let B=M.chunkDataSize;const F=T.chunkDisplayDimensionIndices,j=T.fixedPositionWithinChunk,U=T.chunkTransform.channelToChunkDimensionIndices;if(zI(T),B!==L){L=B;for(let $=0;$<3;++$){const _=F[$];u[$]=_===-1||_>=I?1:L[_]}h.uniform3fv(a.uniform("uChunkDataSize"),u)}const O=M.chunkGridPosition;for(let $=0;$<3;++$){const _=F[$];P[$]=_===-1||_>=I?0:V[$]*O[_]}l?.bindChunk(h,a,M,j,F,U,y),y=!1,h.uniform3fv(a.uniform("uTranslation"),P),OW(h,1,1),++b}else++k}),h.disable(WebGL2RenderingContext.CULL_FACE),v(),this.vertexIdHelper.disable()}isReady(e,t){const n=t.state.sources.value;if(n.length===0)return!0;let r=!1;return xE(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,n[0],()=>{},s=>{const a=s.source.chunks.get(s.curPositionInChunks.join());(a===void 0||a.state!==pt.GPU_MEMORY)&&(r=!0)}),r}}const eq=at.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}});class tq{constructor(e){this.id=e,this.element=document.createElement("div"),this.nameContainer=document.createElement("div"),this.nameElement=document.createElement("input"),this.lowerElement=document.createElement("div"),this.upperElement=document.createElement("div");const t=this.element,n=this.nameContainer,r=this.nameElement,s=this.lowerElement,a=this.upperElement;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),n.classList.add("neuroglancer-channel-dimensions-widget-name-container"),r.classList.add("neuroglancer-channel-dimensions-widget-name"),n.appendChild(r),s.classList.add("neuroglancer-channel-dimensions-widget-lower"),a.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(n),t.appendChild(s),t.appendChild(a),n.draggable=!0,r.disabled=!0,r.spellcheck=!1,r.autocomplete="off",r.required=!0,r.placeholder=" ",n.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",n.addEventListener("dblclick",()=>{r.disabled=!1,r.focus(),r.select()}),r.addEventListener("focus",()=>{r.select()})}}class iq extends Y{constructor(e){super(),this.combiner=e,this.element=document.createElement("div"),this.dimensionWidgets=[],this.curCoordinateSpace=void 0,this.dragSource=void 0,this.coordinateSpace=this.combiner.combined;const t=this.element;t.classList.add("neuroglancer-channel-dimensions-widget");const n=this.registerCancellable(dt(()=>this.updateView()));this.registerDisposer(e.combined.changed.add(n));const r=this.registerDisposer(new Nn(t,eq));r.allShortcutsAreGlobal=!0,this.registerDisposer(ve(t,"cancel",s=>{this.forceUpdateView();const a=s.target;a instanceof HTMLElement&&a.blur()})),this.updateView()}reorderDimensionTo(e,t){if(e===t)return;const n=this.coordinateSpace;n.value=UL(n.value,e,t)}makeNewDimensionWidget(e){const t=new tq(e);return t.nameContainer.addEventListener("dragstart",n=>{this.dragSource=t,n.stopPropagation(),n.dataTransfer.setData("neuroglancer-dimension","")}),t.nameContainer.addEventListener("dragenter",n=>{const r=this.dragSource;if(r===void 0||r===t)return;const s=this.dimensionWidgets,a=s.indexOf(r),l=s.indexOf(t);a===-1||l===-1||(n.preventDefault(),this.reorderDimensionTo(l,a))}),t.nameContainer.addEventListener("dragend",n=>{this.dragSource===t&&(this.dragSource=void 0)}),t.nameElement.addEventListener("blur",n=>{t.nameElement.disabled=!0;const r=n.relatedTarget;this.dimensionWidgets.some(s=>s.nameElement===r)||this.updateNames()||this.forceUpdateView()}),t.nameElement.addEventListener("input",()=>{const n=t.nameElement;_i(n),this.updateNameValidity()}),ve(t.nameElement,"commit",()=>{this.updateNames()}),ve(t.nameElement,"tab-forward",n=>this.selectAdjacentField(n,t,1)),ve(t.nameElement,"tab-backward",n=>this.selectAdjacentField(n,t,-1)),t}selectAdjacentField(e,t,n){e.stopPropagation();const r=this.dimensionWidgets,s=r.indexOf(t);if(s===-1)return;const a=s+n;if(a<0||a>=r.length)return;const l=r[a];l.nameElement.disabled=!1,l.nameElement.focus(),e.preventDefault()}updateNames(){const e=this.dimensionWidgets,t=this.coordinateSpace,n=t.value,r=e.map(d=>d.nameElement.value);if(this.combiner.getRenameValidity(r).includes(!1))return!1;const s=n.names;if(Oe(s,r))return!1;const a=n.timestamps.map((d,u)=>s[u]===r[u]?d:Date.now()),l=H(H({},n),{names:r,timestamps:a});return t.value=l,!0}updateNameValidity(){const e=this.dimensionWidgets,t=e.map(s=>s.nameElement.value),n=t.length,r=this.combiner.getRenameValidity(t);for(let s=0;s<n;++s)e[s].nameElement.dataset.isValid=r[s]===!1?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){const e=this.coordinateSpace.value;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;const t=this.element,n=this.dimensionWidgets,r=this.dimensionWidgets=e.ids.map(a=>n.find(l=>l.id===a)||this.makeNewDimensionWidget(a));function*s(){const a=e.names,l=e.rank;var d=e.bounds;const u=d.lowerBounds,h=d.upperBounds;for(let g=0;g<l;++g){const v=r[g];v.nameElement.value=a[g],delete v.nameElement.dataset.isValid,_i(v.nameElement),v.lowerElement.textContent=u[g].toString(),v.upperElement.textContent=h[g].toString(),yield v.element}}Xn(t,s.call(this))}}const zm="opacity",$m="blend",kE="shader",EE="shaderControls",Gm="crossSectionRenderScale",LE="channelDimensions",Wm="volumeRendering",nq="volumeRenderScale",rq=Ry(Wo);class ua extends rq{constructor(e){super(e),this.opacity=Bl(.5),this.blendMode=W8(),this.fragmentMain=H8(),this.shaderError=lh(),this.dataType=new ct(void 0),this.sliceViewRenderScaleHistogram=new vo,this.sliceViewRenderScaleTarget=ta(1),this.volumeRenderingRenderScaleHistogram=new vo,this.volumeRenderingRenderScaleTarget=ta(1),this.channelCoordinateSpace=new gv,this.channelCoordinateSpaceCombiner=new Sv(this.channelCoordinateSpace,I3),this.channelSpace=this.registerDisposer(jn(t=>f2(()=>_3(t)),this.channelCoordinateSpace)),this.volumeRendering=new _t(!1,!1),this.shaderControlState=this.registerDisposer(new Av(this.fragmentMain,this.registerDisposer(cn((t,n)=>t===void 0?null:{imageData:{dataType:t,channelRank:n.rank}},[this.dataType,this.channelCoordinateSpace],(t,n)=>re(t)===re(n))),this.channelCoordinateSpaceCombiner)),this.localCoordinateSpaceCombiner.includeDimensionPredicate=Ul,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRendering.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new sq(this)}),this.tabs.default="rendering"}markLoading(){const e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){const t=super.addCoordinateSpace(e),n=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),n()}}activateDataSubsources(e){let t;for(const n of e){if(this.addStaticAnnotations(n))continue;const r=n.subsourceEntry.subsource.volume;if(!(r instanceof Ds)){n.deactivate("Not compatible with image layer");continue}if(t&&r.dataType!==t){n.deactivate(`Data type must be ${q[r.dataType].toLowerCase()}`);continue}t=r.dataType,n.activate(s=>{n.addRenderLayer(new j8(r,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:n.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));const a=s.registerDisposer(new Q8({multiscaleSource:r,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:n.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.volumeRenderingRenderScaleTarget,renderScaleHistogram:this.volumeRenderingRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));s.registerDisposer(n.messages.addChild(a.messages)),s.registerDisposer(Pr((l,d)=>{d&&l.registerDisposer(this.addRenderLayer(a.addRef()))},this.volumeRendering)),this.shaderError.changed.dispatch()})}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[zm]),ye(e,$m,t=>this.blendMode.restoreState(t)),this.fragmentMain.restoreState(e[kE]),this.shaderControlState.restoreState(e[EE]),this.sliceViewRenderScaleTarget.restoreState(e[Gm]),this.channelCoordinateSpace.restoreState(e[LE]),this.volumeRendering.restoreState(e[Wm])}toJSON(){const e=super.toJSON();return e[zm]=this.opacity.toJSON(),e[$m]=this.blendMode.toJSON(),e[kE]=this.fragmentMain.toJSON(),e[EE]=this.shaderControlState.toJSON(),e[Gm]=this.sliceViewRenderScaleTarget.toJSON(),e[LE]=this.channelCoordinateSpace.toJSON(),e[Wm]=this.volumeRendering.toJSON(),e}displayImageSelectionState(e,t){const n=e.value;if(n==null)return!1;const r=this.channelSpace.value;if(r.error!==void 0)return!1;const s=r.numChannels,a=r.coordinates;var l=r.channelCoordinateSpace;const d=l.names,u=l.rank,h=document.createElement("div");h.classList.add("neuroglancer-selection-details-value-grid");let g="[copy] 0fr ";u!==0&&(g+=`repeat(${u}, [dim] 0fr [coord] 0fr) `),g+="[value] 1fr",h.style.gridTemplateColumns=g;for(let v=0;v<s;++v){const y=u===0?n:n[v],C=y==null?"":y.toString(),w=Zn({title:"Copy value",onClick:()=>{Ji(C)}});h.appendChild(w);for(let k=0;k<u;++k){const L=document.createElement("div");L.classList.add("neuroglancer-selection-details-value-grid-dim"),L.textContent=d[k],h.appendChild(L);const I=document.createElement("div");I.classList.add("neuroglancer-selection-details-value-grid-coord"),I.textContent=a[v*u+k].toString(),h.appendChild(I)}const b=document.createElement("div");b.classList.add("neuroglancer-selection-details-value-grid-value"),b.textContent=C,h.appendChild(b)}return t.appendChild(h),!0}displaySelectionState(e,t,n){let r=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,n)&&(r=!0),r}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode(`
#define uOpacity 1.0
`),XI(e,t)},initializeShader:e=>{const t=e.shader;mo(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}}ua.type="image";ua.typeAbbreviation="img";function KI(i){return new _y({shaderError:i.shaderError,fragmentMain:i.fragmentMain,shaderControlState:i.shaderControlState})}const YI=[H({label:"Resolution (slice)",toolJson:Gm},Vu(i=>({histogram:i.sliceViewRenderScaleHistogram,target:i.sliceViewRenderScaleTarget}))),H({label:"Blending",toolJson:$m},WP(i=>i.blendMode)),H({label:"Volume rendering (experimental)",toolJson:Wm},Hl(i=>i.volumeRendering)),H({label:"Resolution (3d)",toolJson:nq,isValid:i=>i.volumeRendering},Vu(i=>({histogram:i.volumeRenderingRenderScaleHistogram,target:i.volumeRenderingRenderScaleTarget}))),H({label:"Opacity",toolJson:zm},cs(i=>({value:i.opacity})))];for(const i of YI)_P(ua,i);class sq extends _r{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(KI(this.layer));const t=this.element;t.classList.add("neuroglancer-image-dropdown");for(const s of YI)t.appendChild(Oy(this,e,this.visibility,s));let n=document.createElement("div");n.style.flex="1";let r=document.createElement("div");r.className="neuroglancer-image-dropdown-top-row",r.appendChild(document.createTextNode("Shader")),r.appendChild(n),r.appendChild(By({title:"Show larger editor view",onClick:()=>{new aq(this.layer)}})),r.appendChild(Vy({title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(r),t.appendChild(this.registerDisposer(new iq(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new Fy(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}}class aq extends Ph{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(KI(this.layer)),this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}Ho(ua);GD(fi.IMAGE,ua);Sy(i=>{const e=i.volume;if(e!==void 0&&e.volumeType===fi.UNKNOWN)return{layerConstructor:ua,priority:-100}});Uy(ua,i=>({shaderControlState:i.shaderControlState,legendShaderOptions:i.getLegendShaderOptions()}));function oq(i){if(i.brainMapsClientId){const t=i.brainMapsClientId;zo.register(Mh,()=>new PI(t))}let e=WH({bundleRoot:i.bundleRoot},i.target);return rU(e.inputEventBindings),MH(e),NH(e),HH(i.target),e}const lq="#323232",bs={};let ws;function mq(i){let e=null,t=i.replace(/^[^#]+/,"");if((t===""||t==="#"||t==="#!")&&(t="#!{}"),t.startsWith("#!+"))t=t.slice(3),t=decodeURIComponent(t),e=Sg(t);else if(t.startsWith("#!"))t=t.slice(2),t=decodeURIComponent(t),e=Sg(t);else throw new Error("URL hash is expected to be of the form '#!{...}' or '#!+{...}'.");return e}function vq(i){const e=i?bs[i]:ws;return e?e.state.toJSON():{}}function yq(i,e){try{const t=te.parseString(i),n=e?bs[e]:ws;if(n){for(const r of n.layerManager.managedLayers)if(r.layer instanceof qt){const{displayState:s}=r.layer,a=AT(s,t);if(s.segmentSelectionState.isSelected(t))for(let l=0;l<3;l+=1)a[l]=(a[l]-.5)/.5;return Ii(a)}}}catch{}return""}function Sq(i){const e=i?bs[i]:ws;e&&e.closeSelectionTab&&e.closeSelectionTab()}function qy(i){const e=i?bs[i]:ws;if(e)return e.layerManager}function Hm(i,e){const t=qy(i);if(t)return t.managedLayers.filter(n=>n.name===e)[0]}function ZI(i,e){const t=Hm(i,e);if(t&&t.layer instanceof Ss)return t.layer}function bq(i,e){const t=ZI(i,e);if(t&&t.dataSources&&t.dataSources[0].loadState_){const{dataSource:n}=t.dataSources[0].loadState_;if(n)return n.subsources[0].subsource.annotation}}function cq(i,e,t){const n=qy(i);n&&e&&t&&(n.customSignalHandlerRemovers||(n.customSignalHandlerRemovers={}),n.customSignalHandlerRemovers[e]||(n.customSignalHandlerRemovers[e]=[]),n.customSignalHandlerRemovers[e].push(t))}function TE(i,e){i&&i.customSignalHandlerRemovers&&i.customSignalHandlerRemovers[e]&&(i.customSignalHandlerRemovers[e].forEach(t=>{t()}),delete i.customSignalHandlerRemovers[e])}function wq(i,e){const t=qy(i);if(t){const{layerName:n}=e;if(TE(t,n),e.process){(s=>cq(void 0,n,s))(t.layersChanged.add(()=>{const s=Hm(void 0,n);s&&e.process(s)}));const r=Hm(void 0,n);return r&&e.process(r),()=>{e.cancel&&e.cancel(),TE(t,n)}}}return e.cancel}function dq(i,e,t){i&&!i.signalReady&&(e.onAnnotationAdded&&t(i.childAdded.add(n=>{e.onAnnotationAdded(n)})),e.onAnnotationDeleted&&t(i.childDeleted.add(n=>{e.onAnnotationDeleted(n)})),e.onAnnotationUpdated&&t(i.childUpdated.add(n=>{e.onAnnotationUpdated(n)})),e.onAnnotationChanged&&i.referencesChanged&&t(i.referencesChanged.add(e.onAnnotationChanged)),i.signalReady=!0,t(()=>{i.signalReady=!1}))}function uq(i){if(i.dataSources&&i.dataSources.length>0&&i.dataSources[0].loadState_&&i.dataSources[0].loadState_.dataSource)return i.dataSources[0].loadState_.dataSource}function hq(i){const e=uq(i);if(e)return e.subsources[0].subsource.annotation}function pq(i,e,t){const n=()=>{const s=hq(i);s&&dq(s,e,t)},r=i.dataSourcesChanged;r&&!r.signalReady&&(t(r.add(n)),r.signalReady=!0,t(()=>{r.signalReady=!1}),n())}function DE(i,e,t){i&&(i.expectingExternalTable=!0,i.selectedAnnotation&&!i.selectedAnnotation.changed.signalReady&&e.onAnnotationSelectionChanged&&(t(i.selectedAnnotation.changed.add(()=>{e.onAnnotationSelectionChanged(i.selectedAnnotation.value)})),t(()=>{i.selectedAnnotation.changed.signalReady=!1}),i.selectedAnnotation.changed.signalReady=!0),pq(i,e,t))}function Cq(i,e,t){if(!i.layerChanged.signalReady){const n=i.layerChanged.add(()=>{DE(i.layer,e,t)});i.layerChanged.signalReady=!0,t(n),t(()=>{i.layerChanged.signalReady=!1}),DE(i.layer,e,t)}}function xq(i){const e=i?bs[i]:ws;return e?e.selectionDetailsState?"viewer":"layer":null}function kq(i,e){const t=i?bs[i]:ws;if(t)if(t.selectionDetailsState){if(t.selectionDetailsState.value){const{layers:n}=t.selectionDetailsState.value;if(n){const r=n.find(s=>s.layer.managedLayer.name===e);if(r&&r.state)return r.state.annotationId}}}else{const n=ZI(void 0,e);if(n&&n.selectedAnnotation&&n.selectedAnnotation.value)return n.selectedAnnotation.value.id}return null}class fq extends qS.Component{constructor(e){super(e),kn(this,"minimalPoseSnapshot",()=>{const t=this.viewer,n=t.projectionScale?.value,r=t.projectionOrientation?.orientation;return{position:Array.from(t.position.value||[]),projectionScale:n,projectionOrientation:Array.from(r||[])}}),kn(this,"scheduleEmit",()=>{let t=null;return()=>{this.muteViewerChanged||t===null&&(t=requestAnimationFrame(()=>{t=null,this.props.onViewerStateChanged?.(this.minimalPoseSnapshot())}))}}),kn(this,"withoutEmitting",t=>{this.muteViewerChanged=!0;try{t()}finally{requestAnimationFrame(()=>{this.muteViewerChanged=!1})}}),kn(this,"didLayersChange",(t,n)=>{const r=l=>(l||[]).map(d=>{if(!d)return d;const{segmentColors:u,...h}=d;return h}),s=r(t?.layers),a=r(n?.layers);return JSON.stringify(s)!==JSON.stringify(a)}),kn(this,"applyColorsAndVisibility",t=>{if(!this.viewer)return;const n={...t||{}};for(const a of Object.keys(n))this.allKnownIds.add(a);if(this.allKnownIds.size===0){const a=this.props.viewerState?.layers?.[0]?.segmentColors||{};for(const l of Object.keys(a))this.allKnownIds.add(l)}const r={};for(const a of this.allKnownIds)r[a]=n[a]||lq;const s=(this.props.viewerState?.layers??(this.viewer.state.toJSON().layers||[])).map((a,l)=>l===0||a?.type==="segmentation"?{...a,segmentColors:r}:a);this.withoutEmitting(()=>{this.viewer.state.restoreState({layers:s})})}),kn(this,"updateEventBindings",t=>{const n=this.viewer.inputEventBindings,r=s=>{const a=(d,u,h)=>{const g=d.get(u);g&&(d.delete(u),h&&d.set(h,g))},l=s.bindings;t.forEach(d=>{const u=Array.isArray(d)?d[0]:d,h=`at:${u}`,g=d[1]?`at:${d[1]}`:void 0;a(l,h,g);const v=`bubble:${u}`,y=d[1]?`bubble:${d[1]}`:void 0;a(l,v,y)}),s.parents.forEach(d=>{r(d)})};r(n.global),r(n.perspectiveView),r(n.sliceView)}),kn(this,"selectionDetailsStateChanged",()=>{if(this.viewer){const{onSelectionDetailsStateChanged:t}=this.props;t&&t()}}),kn(this,"layersChanged",()=>{if(this.handlerRemovers&&this.handlerRemovers.forEach(t=>t()),this.viewer){const{onSelectedChanged:t,onVisibleChanged:n}=this.props;if(t||n){this.handlerRemovers=[];for(const r of this.viewer.layerManager.managedLayers)if(r.layer instanceof qt){const{segmentSelectionState:s}=r.layer.displayState,{visibleSegments:a}=r.layer.displayState.segmentationGroupState.value;if(s&&t){const l=this.selectedChanged.bind(void 0,r),d=s.changed.add(l);this.handlerRemovers.push(d),r.registerDisposer(d)}if(a&&n){const l=this.visibleChanged.bind(void 0,r),d=a.changed.add(l);this.handlerRemovers.push(d),r.registerDisposer(d)}}}}}),kn(this,"selectedChanged",t=>{if(!this.viewer)return;const{onSelectedChanged:n}=this.props;if(n){const{segmentSelectionState:r}=t.layer.displayState;if(!r)return;const s=r.selectedSegment;s&&n(s,t)}}),kn(this,"visibleChanged",t=>{if(this.viewer){const{onVisibleChanged:n}=this.props;if(n){const{visibleSegments:r}=t.layer.displayState.segmentationGroupState.value;r&&n(r,t)}}}),this.ngContainer=qS.createRef(),this.viewer=null,this.muteViewerChanged=!1,this.prevVisibleIds=new Set,this.prevColorMap=null,this.disposers=[],this.prevColorOverrides=new Set,this.overrideColorsById=Object.create(null),this.allKnownIds=new Set}componentDidMount(){const{viewerState:e,brainMapsClientId:t,eventBindingsToUpdate:n,callbacks:r,key:s,bundleRoot:a}=this.props;this.viewer=oq({brainMapsClientId:t,target:this.ngContainer.current,bundleRoot:a}),this.setCallbacks(r),n&&this.updateEventBindings(n),this.viewer.expectingExternalUI=!0,this.viewer.selectionDetailsState&&this.viewer.selectionDetailsState.changed.add(this.selectionDetailsStateChanged),this.viewer.layerManager.layersChanged.add(this.layersChanged);const l=this.scheduleEmit();this.disposers.push(this.viewer.projectionScale.changed.add(l)),this.disposers.push(this.viewer.projectionOrientation.changed.add(l)),this.disposers.push(this.viewer.position.changed.add(l)),e&&this.withoutEmitting(()=>{this.viewer.state.restoreState(e)}),s?bs[s]=this.viewer:ws=this.viewer}componentDidUpdate(e,t){const{viewerState:n,cellColorMapping:r}=this.props,s={};for(const P of this.viewer.layerManager.managedLayers)if(P.layer instanceof qt){const{segmentSelectionState:T}=P.layer.displayState;s[P.name]=T.selectedSegment}for(const P of this.viewer.layerManager.managedLayers)if(P.layer instanceof qt){const{segmentSelectionState:T}=P.layer.displayState;T.set(s[P.name])}if(!n)return;const a=e.viewerState,l=ZM(a,n);if(l.changed){const P={};l.scale?(P.projectionScale=n.projectionScale,Array.isArray(n.position)&&(P.position=n.position)):l.pos&&(P.position=n.position),l.rot&&(P.projectionOrientation=n.projectionOrientation),this.withoutEmitting(()=>this.viewer.state.restoreState(P))}this.didLayersChange(a,n)&&this.withoutEmitting(()=>{const P=Array.isArray(n.layers)?n.layers:[];this.viewer.state.restoreState({layers:P}),r&&Object.keys(r).length&&this.applyColorsAndVisibility(r)});const d=e.cellColorMapping?Object.keys(e.cellColorMapping).length:0,u=r?Object.keys(r).length:0,h=e.cellColorMapping!==r;!this.didLayersChange(a,n)&&(h||d!==u)&&this.withoutEmitting(()=>{this.applyColorsAndVisibility(r)});const g=P=>(P||[]).map(T=>{if(!T)return T;const{segments:R,segmentColors:M,...V}=T;return V}),v=e.viewerState?.layers,y=n?.layers,C=JSON.stringify(g(v)),w=JSON.stringify(g(y)),b=C!==w,k=v&&v[0]&&Array.isArray(v[0].segments)?v[0].segments.length:0,L=y&&y[0]&&Array.isArray(y[0].segments)?y[0].segments.length:0,I=k===0&&L>0;(b||I)&&this.withoutEmitting(()=>{this.viewer.state.restoreState({layers:y})})}componentWillUnmount(){this.disposers.forEach(t=>{try{t()}catch{}}),this.disposers=[];const{key:e}=this.props;e?delete bs[e]:ws=void 0}setCallbacks(e){e.forEach(t=>{this.viewer.bindCallback(t.name,t.function),this.viewer.inputEventBindings.sliceView.set(t.event,t.name)})}render(){const{perspectiveZoom:e}=this.props;return JS.jsx("div",{className:"neuroglancer-container",ref:this.ngContainer,children:JS.jsxs("p",{children:["Neuroglancer here with zoom ",e]})})}}kn(fq,"defaultProps",{perspectiveZoom:20,eventBindingsToUpdate:null,brainMapsClientId:"NOT_A_VALID_ID",viewerState:null,onSelectedChanged:null,onVisibleChanged:null,onSelectionDetailsStateChanged:null,onViewerStateChanged:null,key:null,callbacks:[],ngServer:"https://neuroglancer-demo.appspot.com/"});export{cq as addLayerSignalRemover,Sq as closeSelectionTab,DE as configureAnnotationLayer,Cq as configureAnnotationLayerChanged,wq as configureLayersChangedSignals,fq as default,ZI as getAnnotationLayer,xq as getAnnotationSelectionHost,bq as getAnnotationSource,qy as getLayerManager,Hm as getManagedLayer,yq as getNeuroglancerColor,vq as getNeuroglancerViewerState,kq as getSelectedAnnotationId,mq as parseUrlHash,TE as unsubscribeLayersChangedSignals};

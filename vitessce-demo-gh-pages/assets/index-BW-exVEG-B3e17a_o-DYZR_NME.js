const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/troika-three-text.esm-Dv4dfK9D-CbbrrTSH-ClXaBIPx.js","assets/index-Bm04Wswa.js","assets/index-D0JW_tSo.css"])))=>i.map(i=>d[i]);
import{L as T,H as I,h as us,J as He,l as Le,S as Fe,M as Nn,a as Pr,k as st,b as At,c as C,I as J,d as ce,T as k,t as Ir,m as Oe,v as ds,x as hs,e as fs,f as Xt,X as $,G as ot,g as _t,i as ze,j as ps,O as ms,o as gs,C as xs,D as ke,_ as Br,p as gn,P as je,q as vs,s as xn,u as Nr,Q as Gn,Y as ys,y as Vn,R as ws,z as vt,K as As,A as _s,B as bs,V as Ss,E as Or,F as On,U as Ts,W as Es,Z as Ms,$ as zr,a0 as Cs,a1 as Ls,a2 as Rs,a3 as Ps,a4 as vn,a5 as Is,a6 as Bs,a7 as Xn,a8 as Ns,a9 as Yt,aa as Os,ab as Ur,ac as zs,ad as Us,ae as Ds,af as Fs,ag as js,ah as Hs,ai as ks,aj as Dr,ak as Gs,al as Vs,am as Xs,an as Fr,ao as qs,ap as Ks,aq as Se,ar as Ws,as as qn,at as $s,au as Ys,av as yn,aw as jr,ax as Zs,ay as gt,az as Hr,aA as Js,aB as Qs,aC as eo}from"./index-Bm04Wswa.js";import{l as to,d as kr,o as no,$ as Me,a as Gr,b as wn,z as it}from"./OrbitControls-DuFHF-v2-DcFGr2Is-DshK8e8v.js";const Vr=(i,e=Vr,t=e.f||(e.f=["assets/troika-three-text.esm-Dv4dfK9D-CbbrrTSH.js","assets/index-D9chyKeb.js","assets/index-D0JW_tSo.css"]))=>i.map(r=>t[r]),ro=i=>typeof i=="object"&&typeof i.then=="function",Tt=[];function so(i,e,t=(r,n)=>r===n){if(i===e)return!0;if(!i||!e)return!1;const r=i.length;if(e.length!==r)return!1;for(let n=0;n<r;n++)if(!t(i[n],e[n]))return!1;return!0}function oo(i,e=null,t=!1,r={}){e===null&&(e=[i]);for(const s of Tt)if(so(e,s.keys,s.equal)){if(t)return;if(Object.prototype.hasOwnProperty.call(s,"error"))throw s.error;if(Object.prototype.hasOwnProperty.call(s,"response"))return r.lifespan&&r.lifespan>0&&(s.timeout&&clearTimeout(s.timeout),s.timeout=setTimeout(s.remove,r.lifespan)),s.response;if(!t)throw s.promise}const n={keys:e,equal:r.equal,remove:()=>{const s=Tt.indexOf(n);s!==-1&&Tt.splice(s,1)},promise:(ro(i)?i:i(...e)).then(s=>{n.response=s,r.lifespan&&r.lifespan>0&&(n.timeout=setTimeout(n.remove,r.lifespan))}).catch(s=>n.error=s)};if(Tt.push(n),!t)throw n.promise}const Kn=(i,e,t)=>oo(i,e,!1,t);class io extends He{constructor(e,t){super(),this.inputSource=null,this.xrControllerModel=null,this.index=e,this.controller=t.xr.getController(e),this.grip=t.xr.getControllerGrip(e),this.hand=t.xr.getHand(e),this.grip.userData.name="grip",this.controller.userData.name="controller",this.hand.userData.name="hand",this.visible=!1,this.add(this.controller,this.grip,this.hand),this._onConnected=this._onConnected.bind(this),this._onDisconnected=this._onDisconnected.bind(this),this.controller.addEventListener("connected",this._onConnected),this.controller.addEventListener("disconnected",this._onDisconnected)}_onConnected(e){e.fake||e.data&&(this.visible=!0,this.inputSource=e.data,this.dispatchEvent(e))}_onDisconnected(e){e.fake||(this.visible=!1,this.inputSource=null,this.dispatchEvent(e))}dispose(){this.controller.removeEventListener("connected",this._onConnected),this.controller.removeEventListener("disconnected",this._onDisconnected)}}var Wn,$n;const ao=i=>Array.from(new Set(i)),de=typeof window<"u"&&((Wn=window.document)!=null&&Wn.createElement||(($n=window.navigator)==null?void 0:$n.product)==="ReactNative")?T.useLayoutEffect:T.useEffect;function be(i){const e=T.useRef(i);return de(()=>void(e.current=i),[i]),e}function Xe(i,e,{handedness:t}={}){const r=be(e),n=q(s=>s.controllers);de(()=>{const s=n.map(o=>{if(t&&o.inputSource&&o.inputSource.handedness!==t)return;const a=l=>r.current({nativeEvent:l,target:o});return o.controller.addEventListener(i,a),()=>o.controller.removeEventListener(i,a)});return()=>s.forEach(o=>o?.())},[n,t,i])}const Yn=new J;function lo({children:i}){const e=Me(u=>u.events),t=Me(u=>u.get),r=Me(u=>u.raycaster),n=q(u=>u.controllers),s=q(u=>u.interactions),o=q(u=>u.hoverState),a=q(u=>u.hasInteraction),l=q(u=>u.getInteraction),c=T.useCallback(u=>{const h=Array.from(s.keys());return Yn.identity().extractRotation(u.matrixWorld),r.ray.origin.setFromMatrixPosition(u.matrixWorld),r.ray.direction.set(0,0,-1).applyMatrix4(Yn),r.intersectObjects(h,!0)},[s,r]);it(()=>{var u;if(s.size!==0)for(const h of n){if(!((u=h.inputSource)!=null&&u.handedness))return;const f=o[h.inputSource.handedness],w=new Set;let g=c(h.controller);if(e.filter)g=e.filter(g,t());else{const m=g.find(p=>p?.object);m&&(g=[m])}for(const m of g){let p=m.object;for(;p;){if(a(p,"onHover")&&!f.has(p)){const x=l(p,"onHover");for(const v of x)v({target:h,intersection:m,intersections:g})}l(p,"onMove")?.forEach(x=>x({target:h,intersection:m,intersections:g})),f.set(p,m),w.add(p.id),p=p.parent}}for(const m of f.keys())if(!w.has(m.id)){f.delete(m);const p=l(m,"onBlur");if(!p)continue;for(const x of p)x({target:h,intersections:g})}}});const d=T.useCallback(u=>h=>{var f;if(!((f=h.target.inputSource)!=null&&f.handedness))return;const w=o[h.target.inputSource.handedness],g=Array.from(new Set(w.values()));s.forEach((m,p)=>{var x,v,y;if(w.has(p)){if(!m[u])return;for(const _ of m[u])(x=_.current)==null||x.call(_,{target:h.target,intersection:w.get(p),intersections:g})}else if(u==="onSelect"&&m.onSelectMissed)for(const _ of m.onSelectMissed)(v=_.current)==null||v.call(_,{target:h.target,intersections:g});else if(u==="onSqueeze"&&m.onSqueezeMissed)for(const _ of m.onSqueezeMissed)(y=_.current)==null||y.call(_,{target:h.target,intersections:g})})},[o,s]);return Xe("select",d("onSelect")),Xe("selectstart",d("onSelectStart")),Xe("selectend",d("onSelectEnd")),Xe("squeeze",d("onSqueeze")),Xe("squeezeend",d("onSqueezeEnd")),Xe("squeezestart",d("onSqueezeStart")),T.createElement(T.Fragment,null,i)}function ge(i,e,t){const r=q(o=>o.addInteraction),n=q(o=>o.removeInteraction),s=be(t);de(()=>{const o=i.current;if(!(!o||!s.current))return r(o,e,s),()=>n(o,e,s)},[i,e,r,n])}const co=T.forwardRef(function({onHover:i,onBlur:e,onSelectStart:t,onSelectEnd:r,onSelectMissed:n,onSelect:s,onSqueezeStart:o,onSqueezeEnd:a,onSqueezeMissed:l,onSqueeze:c,onMove:d,children:u},h){const f=T.useRef(null);return T.useImperativeHandle(h,()=>f.current),ge(f,"onHover",i),ge(f,"onBlur",e),ge(f,"onSelectStart",t),ge(f,"onSelectEnd",r),ge(f,"onSelectMissed",n),ge(f,"onSelect",s),ge(f,"onSqueezeStart",o),ge(f,"onSqueezeEnd",a),ge(f,"onSqueezeMissed",l),ge(f,"onSqueeze",c),ge(f,"onMove",d),T.createElement("group",{ref:f},u)}),uo=T.forwardRef(function({onSelectStart:i,onSelectEnd:e,children:t,...r},n){const s=T.useRef(),o=T.useRef(null),a=T.useMemo(()=>new J,[]);return T.useImperativeHandle(n,()=>o.current),it(()=>{const l=s.current,c=o.current;l&&(c.applyMatrix4(a),c.applyMatrix4(l.matrixWorld),c.updateMatrixWorld(),a.copy(l.matrixWorld).invert())}),T.createElement(co,{ref:o,onSelectStart:l=>{s.current=l.target.controller,a.copy(l.target.controller.matrixWorld).invert(),i?.(l)},onSelectEnd:l=>{l.target.controller===s.current&&(s.current=void 0),e?.(l)},...r},t)}),Xr=T.createContext(null),Ge=kr((i,e)=>({set:i,get:e,session:null,referenceSpaceType:null}));function ho({foveation:i=0,frameRate:e=void 0,referenceSpace:t="local-floor",onSessionStart:r,onSessionEnd:n,onVisibilityChange:s,onInputSourcesChange:o,children:a}){const l=Me(v=>v.gl),c=Me(v=>v.camera),d=q(v=>v.player),u=q(v=>v.get),h=q(v=>v.set),f=q(v=>v.session),w=q(v=>v.controllers),g=be(r),m=be(n),p=be(s),x=be(o);return de(()=>{const v=[0,1].map(y=>{const _=new io(y,l),b=()=>h(S=>({controllers:[...S.controllers,_]})),A=()=>h(S=>({controllers:S.controllers.filter(E=>E!==_)}));return _.addEventListener("connected",b),_.addEventListener("disconnected",A),()=>{_.removeEventListener("connected",b),_.removeEventListener("disconnected",A)}});return()=>v.forEach(y=>y())},[l,h]),de(()=>Ge.subscribe(({session:v})=>h(()=>({session:v}))),[l.xr,h]),de(()=>{l.xr.setFoveation(i),h(()=>({foveation:i}))},[l.xr,i,h]),de(()=>{var v;try{e&&((v=f?.updateTargetFrameRate)==null||v.call(f,e))}catch{}h(()=>({frameRate:e}))},[f,e,h]),de(()=>{const v=Ge.getState();l.xr.setReferenceSpaceType(t),h(()=>({referenceSpace:t})),v.set({referenceSpaceType:t})},[l.xr,t,h]),de(()=>{if(!f)return void l.xr.setSession(null);const v=A=>{var S;h(()=>({isPresenting:!0})),(S=g.current)==null||S.call(g,{nativeEvent:{...A,target:f},target:f})},y=A=>{var S;h(()=>({isPresenting:!1,session:null})),Ge.setState(()=>({session:null})),(S=m.current)==null||S.call(m,{nativeEvent:{...A,target:f},target:f})},_=A=>{var S;(S=p.current)==null||S.call(p,{nativeEvent:A,target:f})},b=A=>{var S;const E=Object.values(f.inputSources).some(M=>M.hand);h(()=>({isHandTracking:E})),(S=x.current)==null||S.call(x,{nativeEvent:A,target:f})};return l.xr.addEventListener("sessionstart",v),l.xr.addEventListener("sessionend",y),f.addEventListener("visibilitychange",_),f.addEventListener("inputsourceschange",b),l.xr.setSession(f).then(()=>{l.xr.setFoveation(u().foveation)}),()=>{l.xr.removeEventListener("sessionstart",v),l.xr.removeEventListener("sessionend",y),f.removeEventListener("visibilitychange",_),f.removeEventListener("inputsourceschange",b)}},[f,l.xr,h,u]),T.createElement(lo,null,T.createElement("primitive",{object:d},T.createElement("primitive",{object:c}),w.map(v=>T.createElement("primitive",{key:v.index,object:v}))),a)}function fo(i){const e=T.useMemo(()=>kr((t,r)=>({set:t,get:r,controllers:[],isPresenting:!1,isHandTracking:!1,player:new He,session:null,foveation:0,referenceSpace:"local-floor",hoverState:{left:new Map,right:new Map,none:new Map},interactions:new Map,hasInteraction(n,s){var o;return!!((o=r().interactions.get(n))!=null&&o[s].some(a=>a.current))},getInteraction(n,s){var o;return(o=r().interactions.get(n))==null?void 0:o[s].reduce((a,l)=>(l.current&&a.push(l.current),a),[])},addInteraction(n,s,o){const a=r().interactions;a.has(n)||a.set(n,{onHover:[],onBlur:[],onSelect:[],onSelectEnd:[],onSelectStart:[],onSelectMissed:[],onSqueeze:[],onSqueezeEnd:[],onSqueezeStart:[],onSqueezeMissed:[],onMove:[]}),a.get(n)[s].push(o)},removeInteraction(n,s,o){const a=r().interactions.get(n);if(a){const l=a[s].indexOf(o);l!==-1&&a[s].splice(l,1)}}})),[]);return T.createElement(Xr.Provider,{value:e},T.createElement(ho,{...i}))}const po=(i,e)=>{var t;if(!(!i&&!e))return i&&!e?{optionalFeatures:[i]}:i&&e?{...e,optionalFeatures:ao([...(t=e.optionalFeatures)!=null?t:[],i])}:e},mo=async(i,e)=>{const t=Ge.getState();if(t.session){console.warn("@react-three/xr: session already started, please stop it first");return}const r=po(t.referenceSpaceType,e),n=await navigator.xr.requestSession(i,r);return t.set(()=>({session:n})),n},go=async()=>{const i=Ge.getState();if(!i.session){console.warn("@react-three/xr: no session to stop, please start it first");return}await i.session.end(),i.set({session:null})},xo=async(i,{sessionInit:e,enterOnly:t,exitOnly:r}={})=>{const n=Ge.getState();if(!(n.session&&t)&&!(!n.session&&r))return n.session?await go():await mo(i,e)},vo=(i,e,t)=>{switch(i){case"entered":return`Exit ${e}`;case"exited":return`Enter ${e}`;case"unsupported":default:switch(t){case"https":return"HTTPS needed";case"security":return`${e} blocked`;case"unknown":default:return`${e} unsupported`}}},zn=T.forwardRef(function({mode:i,sessionInit:e,enterOnly:t=!1,exitOnly:r=!1,onClick:n,onError:s,children:o,...a},l){var c;const[d,u]=T.useState("exited"),[h,f]=T.useState("unknown"),w=vo(d,i,h),g=i==="inline"?i:`immersive-${i.toLowerCase()}`,m=be(s);de(()=>{if(!navigator?.xr)return void u("unsupported");navigator.xr.isSessionSupported(g).then(x=>{if(x)u("exited");else{const v=location.protocol==="https:";u("unsupported"),f(v?"unknown":"https")}}).catch(x=>{u("unsupported"),"name"in x&&x.name==="SecurityError"?f("security"):f("unknown")})},[g]),de(()=>Ge.subscribe(x=>{x.session?u("entered"):d!=="unsupported"&&u("exited")}),[d]);const p=T.useCallback(async x=>{n?.(x);try{xo(g,{sessionInit:e,enterOnly:t,exitOnly:r})}catch(v){const y=m.current;if(y&&v instanceof Error)y(v);else throw v}},[n,g,e,t,r,m]);return T.createElement("button",{...a,ref:l,onClick:d==="unsupported"?n:p},(c=typeof o=="function"?o(d):o)!=null?c:w)}),qr={position:"absolute",bottom:"24px",left:"50%",transform:"translateX(-50%)",padding:"12px 24px",border:"1px solid white",borderRadius:"4px",background:"rgba(0, 0, 0, 0.1)",color:"white",font:"normal 0.8125rem sans-serif",outline:"none",zIndex:99999,cursor:"pointer"};T.forwardRef(({style:i=qr,sessionInit:e={domOverlay:typeof document<"u"?{root:document.body}:void 0,optionalFeatures:["hit-test","dom-overlay","dom-overlay-for-handheld-ar"]},children:t,...r},n)=>T.createElement(zn,{...r,ref:n,mode:"AR",style:i,sessionInit:e},t));T.forwardRef(({style:i=qr,sessionInit:e={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]},children:t,...r},n)=>T.createElement(zn,{...r,ref:n,mode:"VR",style:i,sessionInit:e},t));function q(i=t=>t,e){const t=T.useContext(Xr);if(!t)throw new Error("useXR must be used within an <XR /> component!");return t(i,e)}function Zn(i,e){if(e===Ys)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),i;if(e===yn||e===jr){let t=i.getIndex();if(t===null){const o=[],a=i.getAttribute("position");if(a!==void 0){for(let l=0;l<a.count;l++)o.push(l);i.setIndex(o),t=i.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),i}const r=t.count-2,n=[];if(t)if(e===yn)for(let o=1;o<=r;o++)n.push(t.getX(0)),n.push(t.getX(o)),n.push(t.getX(o+1));else for(let o=0;o<r;o++)o%2===0?(n.push(t.getX(o)),n.push(t.getX(o+1)),n.push(t.getX(o+2))):(n.push(t.getX(o+2)),n.push(t.getX(o+1)),n.push(t.getX(o)));n.length/3!==r&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const s=i.clone();return s.setIndex(n),s.clearGroups(),s}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),i}const yo=parseInt(Nr.replace(/\D+/g,""));class Kr extends xs{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new So(t)}),this.register(function(t){return new Io(t)}),this.register(function(t){return new Bo(t)}),this.register(function(t){return new No(t)}),this.register(function(t){return new Eo(t)}),this.register(function(t){return new Mo(t)}),this.register(function(t){return new Co(t)}),this.register(function(t){return new Lo(t)}),this.register(function(t){return new bo(t)}),this.register(function(t){return new Ro(t)}),this.register(function(t){return new To(t)}),this.register(function(t){return new Po(t)}),this.register(function(t){return new Ao(t)}),this.register(function(t){return new Oo(t)}),this.register(function(t){return new zo(t)})}load(e,t,r,n){const s=this;let o;this.resourcePath!==""?o=this.resourcePath:this.path!==""?o=this.path:o=ke.extractUrlBase(e),this.manager.itemStart(e);const a=function(c){n?n(c):console.error(c),s.manager.itemError(e),s.manager.itemEnd(e)},l=new Br(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(c){try{s.parse(c,o,function(d){t(d),s.manager.itemEnd(e)},a)}catch(d){a(d)}},r,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,r,n){let s;const o={},a={};if(typeof e=="string")s=JSON.parse(e);else if(e instanceof ArrayBuffer)if(ke.decodeText(new Uint8Array(e.slice(0,4)))===Wr){try{o[U.KHR_BINARY_GLTF]=new Uo(e)}catch(c){n&&n(c);return}s=JSON.parse(o[U.KHR_BINARY_GLTF].content)}else s=JSON.parse(ke.decodeText(new Uint8Array(e)));else s=e;if(s.asset===void 0||s.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const l=new Yo(s,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let c=0;c<this.pluginCallbacks.length;c++){const d=this.pluginCallbacks[c](l);a[d.name]=d,o[d.name]=!0}if(s.extensionsUsed)for(let c=0;c<s.extensionsUsed.length;++c){const d=s.extensionsUsed[c],u=s.extensionsRequired||[];switch(d){case U.KHR_MATERIALS_UNLIT:o[d]=new _o;break;case U.KHR_DRACO_MESH_COMPRESSION:o[d]=new Do(s,this.dracoLoader);break;case U.KHR_TEXTURE_TRANSFORM:o[d]=new Fo;break;case U.KHR_MESH_QUANTIZATION:o[d]=new jo;break;default:u.indexOf(d)>=0&&a[d]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+d+'".')}}l.setExtensions(o),l.setPlugins(a),l.parse(r,n)}parseAsync(e,t){const r=this;return new Promise(function(n,s){r.parse(e,t,n,s)})}}function wo(){let i={};return{get:function(e){return i[e]},add:function(e,t){i[e]=t},remove:function(e){delete i[e]},removeAll:function(){i={}}}}const U={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Ao{constructor(e){this.parser=e,this.name=U.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let r=0,n=t.length;r<n;r++){const s=t[r];s.extensions&&s.extensions[this.name]&&s.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,s.extensions[this.name].light)}}_loadLight(e){const t=this.parser,r="light:"+e;let n=t.cache.get(r);if(n)return n;const s=t.json,o=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e];let a;const l=new ze(16777215);o.color!==void 0&&l.fromArray(o.color);const c=o.range!==void 0?o.range:0;switch(o.type){case"directional":a=new bs(l),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new _s(l),a.distance=c;break;case"spot":a=new As(l),a.distance=c,o.spot=o.spot||{},o.spot.innerConeAngle=o.spot.innerConeAngle!==void 0?o.spot.innerConeAngle:0,o.spot.outerConeAngle=o.spot.outerConeAngle!==void 0?o.spot.outerConeAngle:Math.PI/4,a.angle=o.spot.outerConeAngle,a.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return a.position.set(0,0,0),a.decay=2,Ie(a,o),o.intensity!==void 0&&(a.intensity=o.intensity),a.name=t.createUniqueName(o.name||"light_"+e),n=Promise.resolve(a),t.cache.add(r,n),n}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,r=this.parser,n=r.json.nodes[e],s=(n.extensions&&n.extensions[this.name]||{}).light;return s===void 0?null:this._loadLight(s).then(function(o){return r._getNodeRef(t.cache,s,o)})}}class _o{constructor(){this.name=U.KHR_MATERIALS_UNLIT}getMaterialType(){return Fe}extendParams(e,t,r){const n=[];e.color=new ze(1,1,1),e.opacity=1;const s=t.pbrMetallicRoughness;if(s){if(Array.isArray(s.baseColorFactor)){const o=s.baseColorFactor;e.color.fromArray(o),e.opacity=o[3]}s.baseColorTexture!==void 0&&n.push(r.assignTexture(e,"map",s.baseColorTexture,3001))}return Promise.all(n)}}class bo{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const n=r.extensions[this.name].emissiveStrength;return n!==void 0&&(t.emissiveIntensity=n),Promise.resolve()}}class So{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:Le}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&s.push(r.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&s.push(r.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(s.push(r.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const a=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new k(a,a)}return Promise.all(s)}}class To{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:Le}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&s.push(r.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&s.push(r.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(s)}}class Eo{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:Le}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[];t.sheenColor=new ze(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=n.extensions[this.name];return o.sheenColorFactor!==void 0&&t.sheenColor.fromArray(o.sheenColorFactor),o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&s.push(r.assignTexture(t,"sheenColorMap",o.sheenColorTexture,3001)),o.sheenRoughnessTexture!==void 0&&s.push(r.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(s)}}class Mo{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:Le}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&s.push(r.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(s)}}class Co{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:Le}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&s.push(r.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const a=o.attenuationColor||[1,1,1];return t.attenuationColor=new ze(a[0],a[1],a[2]),Promise.all(s)}}class Lo{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:Le}extendMaterialParams(e,t){const r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const n=r.extensions[this.name];return t.ior=n.ior!==void 0?n.ior:1.5,Promise.resolve()}}class Ro{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:Le}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&s.push(r.assignTexture(t,"specularIntensityMap",o.specularTexture));const a=o.specularColorFactor||[1,1,1];return t.specularColor=new ze(a[0],a[1],a[2]),o.specularColorTexture!==void 0&&s.push(r.assignTexture(t,"specularColorMap",o.specularColorTexture,3001)),Promise.all(s)}}class Po{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:Le}extendMaterialParams(e,t){const r=this.parser,n=r.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&s.push(r.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(s)}}class Io{constructor(e){this.parser=e,this.name=U.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,r=t.json,n=r.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const s=n.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,s.source,o)}}class Bo{constructor(e){this.parser=e,this.name=U.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,r=this.parser,n=r.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],a=n.images[o.source];let l=r.textureLoader;if(a.uri){const c=r.options.manager.getHandler(a.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return r.loadTextureImage(e,o.source,l);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class No{constructor(e){this.parser=e,this.name=U.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,r=this.parser,n=r.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],a=n.images[o.source];let l=r.textureLoader;if(a.uri){const c=r.options.manager.getHandler(a.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return r.loadTextureImage(e,o.source,l);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Oo{constructor(e){this.name=U.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,r=t.bufferViews[e];if(r.extensions&&r.extensions[this.name]){const n=r.extensions[this.name],s=this.parser.getDependency("buffer",n.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return s.then(function(a){const l=n.byteOffset||0,c=n.byteLength||0,d=n.count,u=n.byteStride,h=new Uint8Array(a,l,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(d,u,h,n.mode,n.filter).then(function(f){return f.buffer}):o.ready.then(function(){const f=new ArrayBuffer(d*u);return o.decodeGltfBuffer(new Uint8Array(f),d,u,h,n.mode,n.filter),f})})}else return null}}class zo{constructor(e){this.name=U.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,r=t.nodes[e];if(!r.extensions||!r.extensions[this.name]||r.mesh===void 0)return null;const n=t.meshes[r.mesh];for(const l of n.primitives)if(l.mode!==ue.TRIANGLES&&l.mode!==ue.TRIANGLE_STRIP&&l.mode!==ue.TRIANGLE_FAN&&l.mode!==void 0)return null;const s=r.extensions[this.name].attributes,o=[],a={};for(const l in s)o.push(this.parser.getDependency("accessor",s[l]).then(c=>(a[l]=c,a[l])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(l=>{const c=l.pop(),d=c.isGroup?c.children:[c],u=l[0].count,h=[];for(const f of d){const w=new J,g=new C,m=new Or,p=new C(1,1,1),x=new Ss(f.geometry,f.material,u);for(let v=0;v<u;v++)a.TRANSLATION&&g.fromBufferAttribute(a.TRANSLATION,v),a.ROTATION&&m.fromBufferAttribute(a.ROTATION,v),a.SCALE&&p.fromBufferAttribute(a.SCALE,v),x.setMatrixAt(v,w.compose(g,m,p));for(const v in a)v!=="TRANSLATION"&&v!=="ROTATION"&&v!=="SCALE"&&f.geometry.setAttribute(v,a[v]);On.prototype.copy.call(x,f),this.parser.assignFinalMaterial(x),h.push(x)}return c.isGroup?(c.clear(),c.add(...h),c):h[0]}))}}const Wr="glTF",ct=12,Jn={JSON:1313821514,BIN:5130562};class Uo{constructor(e){this.name=U.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,ct);if(this.header={magic:ke.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Wr)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-ct,n=new DataView(e,ct);let s=0;for(;s<r;){const o=n.getUint32(s,!0);s+=4;const a=n.getUint32(s,!0);if(s+=4,a===Jn.JSON){const l=new Uint8Array(e,ct+s,o);this.content=ke.decodeText(l)}else if(a===Jn.BIN){const l=ct+s;this.body=e.slice(l,l+o)}s+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Do{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=U.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const r=this.json,n=this.dracoLoader,s=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,a={},l={},c={};for(const d in o){const u=An[d]||d.toLowerCase();a[u]=o[d]}for(const d in e.attributes){const u=An[d]||d.toLowerCase();if(o[d]!==void 0){const h=r.accessors[e.attributes[d]],f=rt[h.componentType];c[u]=f.name,l[u]=h.normalized===!0}}return t.getDependency("bufferView",s).then(function(d){return new Promise(function(u){n.decodeDracoFile(d,function(h){for(const f in h.attributes){const w=h.attributes[f],g=l[f];g!==void 0&&(w.normalized=g)}u(h)},a,c)})})}}class Fo{constructor(){this.name=U.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class jo{constructor(){this.name=U.KHR_MESH_QUANTIZATION}}class $r extends Zs{constructor(e,t,r,n){super(e,t,r,n)}copySampleValue_(e){const t=this.resultBuffer,r=this.sampleValues,n=this.valueSize,s=e*n*3+n;for(let o=0;o!==n;o++)t[o]=r[s+o];return t}interpolate_(e,t,r,n){const s=this.resultBuffer,o=this.sampleValues,a=this.valueSize,l=a*2,c=a*3,d=n-t,u=(r-t)/d,h=u*u,f=h*u,w=e*c,g=w-c,m=-2*f+3*h,p=f-h,x=1-m,v=p-h+u;for(let y=0;y!==a;y++){const _=o[g+y+a],b=o[g+y+l]*d,A=o[w+y+a],S=o[w+y]*d;s[y]=x*_+v*b+m*A+p*S}return s}}const Ho=new Or;class ko extends $r{interpolate_(e,t,r,n){const s=super.interpolate_(e,t,r,n);return Ho.fromArray(s).normalize().toArray(s),s}}const ue={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},rt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Qn={9728:Ps,9729:Xt,9984:Rs,9985:Ls,9986:Cs,9987:zr},er={33071:Bs,33648:Is,10497:vn},Zt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},An={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",...yo>=152?{TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3"}:{TEXCOORD_0:"uv",TEXCOORD_1:"uv2"},COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Re={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Go={CUBICSPLINE:void 0,LINEAR:Fr,STEP:Xs},Jt={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Vo(i){return i.DefaultMaterial===void 0&&(i.DefaultMaterial=new Nn({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:st})),i.DefaultMaterial}function De(i,e,t){for(const r in t.extensions)i[r]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[r]=t.extensions[r])}function Ie(i,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(i.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Xo(i,e,t){let r=!1,n=!1,s=!1;for(let c=0,d=e.length;c<d;c++){const u=e[c];if(u.POSITION!==void 0&&(r=!0),u.NORMAL!==void 0&&(n=!0),u.COLOR_0!==void 0&&(s=!0),r&&n&&s)break}if(!r&&!n&&!s)return Promise.resolve(i);const o=[],a=[],l=[];for(let c=0,d=e.length;c<d;c++){const u=e[c];if(r){const h=u.POSITION!==void 0?t.getDependency("accessor",u.POSITION):i.attributes.position;o.push(h)}if(n){const h=u.NORMAL!==void 0?t.getDependency("accessor",u.NORMAL):i.attributes.normal;a.push(h)}if(s){const h=u.COLOR_0!==void 0?t.getDependency("accessor",u.COLOR_0):i.attributes.color;l.push(h)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l)]).then(function(c){const d=c[0],u=c[1],h=c[2];return r&&(i.morphAttributes.position=d),n&&(i.morphAttributes.normal=u),s&&(i.morphAttributes.color=h),i.morphTargetsRelative=!0,i})}function qo(i,e){if(i.updateMorphTargets(),e.weights!==void 0)for(let t=0,r=e.weights.length;t<r;t++)i.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(i.morphTargetInfluences.length===t.length){i.morphTargetDictionary={};for(let r=0,n=t.length;r<n;r++)i.morphTargetDictionary[t[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Ko(i){let e;const t=i.extensions&&i.extensions[U.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Qt(t.attributes):e=i.indices+":"+Qt(i.attributes)+":"+i.mode,i.targets!==void 0)for(let r=0,n=i.targets.length;r<n;r++)e+=":"+Qt(i.targets[r]);return e}function Qt(i){let e="";const t=Object.keys(i).sort();for(let r=0,n=t.length;r<n;r++)e+=t[r]+":"+i[t[r]]+";";return e}function _n(i){switch(i){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Wo(i){return i.search(/\.jpe?g($|\?)/i)>0||i.search(/^data\:image\/jpeg/)===0?"image/jpeg":i.search(/\.webp($|\?)/i)>0||i.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const $o=new J;class Yo{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new wo,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let r=!1,n=!1,s=-1;typeof navigator<"u"&&typeof navigator.userAgent<"u"&&(r=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,s=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||r||n&&s<98?this.textureLoader=new Ts(this.options.manager):this.textureLoader=new Es(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Br(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const r=this,n=this.json,s=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([r.getDependencies("scene"),r.getDependencies("animation"),r.getDependencies("camera")])}).then(function(o){const a={scene:o[0][n.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:n.asset,parser:r,userData:{}};De(s,a,n),Ie(a,n),Promise.all(r._invokeAll(function(l){return l.afterRoot&&l.afterRoot(a)})).then(function(){e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[];for(let n=0,s=t.length;n<s;n++){const o=t[n].joints;for(let a=0,l=o.length;a<l;a++)e[o[a]].isBone=!0}for(let n=0,s=e.length;n<s;n++){const o=e[n];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(r[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,r){if(e.refs[t]<=1)return r;const n=r.clone(),s=(o,a)=>{const l=this.associations.get(o);l!=null&&this.associations.set(a,l);for(const[c,d]of o.children.entries())s(d,a.children[c])};return s(r,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let r=0;r<t.length;r++){const n=e(t[r]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const r=[];for(let n=0;n<t.length;n++){const s=e(t[n]);s&&r.push(s)}return r}getDependency(e,t){const r=e+":"+t;let n=this.cache.get(r);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(s){return s.loadNode&&s.loadNode(t)});break;case"mesh":n=this._invokeOne(function(s){return s.loadMesh&&s.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(s){return s.loadBufferView&&s.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(s){return s.loadMaterial&&s.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(s){return s.loadTexture&&s.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(s){return s.loadAnimation&&s.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e);break}this.cache.add(r,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const r=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(n.map(function(s,o){return r.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],r=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[U.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(s,o){r.load(ke.resolveURL(t.uri,n.path),s,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(r){const n=t.byteLength||0,s=t.byteOffset||0;return r.slice(s,s+n)})}loadAccessor(e){const t=this,r=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0){const o=Zt[n.type],a=rt[n.componentType],l=n.normalized===!0,c=new a(n.count*o);return Promise.resolve(new vt(c,o,l))}const s=[];return n.bufferView!==void 0?s.push(this.getDependency("bufferView",n.bufferView)):s.push(null),n.sparse!==void 0&&(s.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(s).then(function(o){const a=o[0],l=Zt[n.type],c=rt[n.componentType],d=c.BYTES_PER_ELEMENT,u=d*l,h=n.byteOffset||0,f=n.bufferView!==void 0?r.bufferViews[n.bufferView].byteStride:void 0,w=n.normalized===!0;let g,m;if(f&&f!==u){const p=Math.floor(h/f),x="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+p+":"+n.count;let v=t.cache.get(x);v||(g=new c(a,p*f,n.count*f/d),v=new Ms(g,f/d),t.cache.add(x,v)),m=new je(v,l,h%f/d,w)}else a===null?g=new c(n.count*l):g=new c(a,h,n.count*l),m=new vt(g,l,w);if(n.sparse!==void 0){const p=Zt.SCALAR,x=rt[n.sparse.indices.componentType],v=n.sparse.indices.byteOffset||0,y=n.sparse.values.byteOffset||0,_=new x(o[1],v,n.sparse.count*p),b=new c(o[2],y,n.sparse.count*l);a!==null&&(m=new vt(m.array.slice(),m.itemSize,m.normalized));for(let A=0,S=_.length;A<S;A++){const E=_[A];if(m.setX(E,b[A*l]),l>=2&&m.setY(E,b[A*l+1]),l>=3&&m.setZ(E,b[A*l+2]),l>=4&&m.setW(E,b[A*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m})}loadTexture(e){const t=this.json,r=this.options,n=t.textures[e].source,s=t.images[n];let o=this.textureLoader;if(s.uri){const a=r.manager.getHandler(s.uri);a!==null&&(o=a)}return this.loadTextureImage(e,n,o)}loadTextureImage(e,t,r){const n=this,s=this.json,o=s.textures[e],a=s.images[t],l=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[l])return this.textureCache[l];const c=this.loadImageSource(t,r).then(function(d){d.flipY=!1,d.name=o.name||a.name||"",d.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(d.name=a.uri);const u=(s.samplers||{})[o.sampler]||{};return d.magFilter=Qn[u.magFilter]||Xt,d.minFilter=Qn[u.minFilter]||zr,d.wrapS=er[u.wrapS]||vn,d.wrapT=er[u.wrapT]||vn,n.associations.set(d,{textures:e}),d}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){const r=this,n=this.json,s=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(u=>u.clone());const o=n.images[e],a=self.URL||self.webkitURL;let l=o.uri||"",c=!1;if(o.bufferView!==void 0)l=r.getDependency("bufferView",o.bufferView).then(function(u){c=!0;const h=new Blob([u],{type:o.mimeType});return l=a.createObjectURL(h),l});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const d=Promise.resolve(l).then(function(u){return new Promise(function(h,f){let w=h;t.isImageBitmapLoader===!0&&(w=function(g){const m=new Xn(g);m.needsUpdate=!0,h(m)}),t.load(ke.resolveURL(u,s.path),w,void 0,f)})}).then(function(u){return c===!0&&a.revokeObjectURL(l),u.userData.mimeType=o.mimeType||Wo(o.uri),u}).catch(function(u){throw console.error("THREE.GLTFLoader: Couldn't load texture",l),u});return this.sourceCache[e]=d,d}assignTexture(e,t,r,n){const s=this;return this.getDependency("texture",r.index).then(function(o){if(!o)return null;if(r.texCoord!==void 0&&r.texCoord>0&&(o=o.clone(),o.channel=r.texCoord),s.extensions[U.KHR_TEXTURE_TRANSFORM]){const a=r.extensions!==void 0?r.extensions[U.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const l=s.associations.get(o);o=s.extensions[U.KHR_TEXTURE_TRANSFORM].extendTexture(o,a),s.associations.set(o,l)}}return n!==void 0&&("colorSpace"in o?o.colorSpace=n===3001?"srgb":"srgb-linear":o.encoding=n),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let r=e.material;const n=t.attributes.tangent===void 0,s=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+r.uuid;let l=this.cache.get(a);l||(l=new Ns,Yt.prototype.copy.call(l,r),l.color.copy(r.color),l.map=r.map,l.sizeAttenuation=!1,this.cache.add(a,l)),r=l}else if(e.isLine){const a="LineBasicMaterial:"+r.uuid;let l=this.cache.get(a);l||(l=new Os,Yt.prototype.copy.call(l,r),l.color.copy(r.color),l.map=r.map,this.cache.add(a,l)),r=l}if(n||s||o){let a="ClonedMaterial:"+r.uuid+":";n&&(a+="derivative-tangents:"),s&&(a+="vertex-colors:"),o&&(a+="flat-shading:");let l=this.cache.get(a);l||(l=r.clone(),s&&(l.vertexColors=!0),o&&(l.flatShading=!0),n&&(l.normalScale&&(l.normalScale.y*=-1),l.clearcoatNormalScale&&(l.clearcoatNormalScale.y*=-1)),this.cache.add(a,l),this.associations.set(l,this.associations.get(r))),r=l}e.material=r}getMaterialType(){return Nn}loadMaterial(e){const t=this,r=this.json,n=this.extensions,s=r.materials[e];let o;const a={},l=s.extensions||{},c=[];if(l[U.KHR_MATERIALS_UNLIT]){const u=n[U.KHR_MATERIALS_UNLIT];o=u.getMaterialType(),c.push(u.extendParams(a,s,t))}else{const u=s.pbrMetallicRoughness||{};if(a.color=new ze(1,1,1),a.opacity=1,Array.isArray(u.baseColorFactor)){const h=u.baseColorFactor;a.color.fromArray(h),a.opacity=h[3]}u.baseColorTexture!==void 0&&c.push(t.assignTexture(a,"map",u.baseColorTexture,3001)),a.metalness=u.metallicFactor!==void 0?u.metallicFactor:1,a.roughness=u.roughnessFactor!==void 0?u.roughnessFactor:1,u.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(a,"metalnessMap",u.metallicRoughnessTexture)),c.push(t.assignTexture(a,"roughnessMap",u.metallicRoughnessTexture))),o=this._invokeOne(function(h){return h.getMaterialType&&h.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(h){return h.extendMaterialParams&&h.extendMaterialParams(e,a)})))}s.doubleSided===!0&&(a.side=Ur);const d=s.alphaMode||Jt.OPAQUE;if(d===Jt.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,d===Jt.MASK&&(a.alphaTest=s.alphaCutoff!==void 0?s.alphaCutoff:.5)),s.normalTexture!==void 0&&o!==Fe&&(c.push(t.assignTexture(a,"normalMap",s.normalTexture)),a.normalScale=new k(1,1),s.normalTexture.scale!==void 0)){const u=s.normalTexture.scale;a.normalScale.set(u,u)}return s.occlusionTexture!==void 0&&o!==Fe&&(c.push(t.assignTexture(a,"aoMap",s.occlusionTexture)),s.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=s.occlusionTexture.strength)),s.emissiveFactor!==void 0&&o!==Fe&&(a.emissive=new ze().fromArray(s.emissiveFactor)),s.emissiveTexture!==void 0&&o!==Fe&&c.push(t.assignTexture(a,"emissiveMap",s.emissiveTexture,3001)),Promise.all(c).then(function(){const u=new o(a);return s.name&&(u.name=s.name),Ie(u,s),t.associations.set(u,{materials:e}),s.extensions&&De(n,u,s),u})}createUniqueName(e){const t=zs.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,r=this.extensions,n=this.primitiveCache;function s(a){return r[U.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(l){return tr(l,a,t)})}const o=[];for(let a=0,l=e.length;a<l;a++){const c=e[a],d=Ko(c),u=n[d];if(u)o.push(u.promise);else{let h;c.extensions&&c.extensions[U.KHR_DRACO_MESH_COMPRESSION]?h=s(c):h=tr(new Ir,c,t),n[d]={primitive:c,promise:h},o.push(h)}}return Promise.all(o)}loadMesh(e){const t=this,r=this.json,n=this.extensions,s=r.meshes[e],o=s.primitives,a=[];for(let l=0,c=o.length;l<c;l++){const d=o[l].material===void 0?Vo(this.cache):this.getDependency("material",o[l].material);a.push(d)}return a.push(t.loadGeometries(o)),Promise.all(a).then(function(l){const c=l.slice(0,l.length-1),d=l[l.length-1],u=[];for(let f=0,w=d.length;f<w;f++){const g=d[f],m=o[f];let p;const x=c[f];if(m.mode===ue.TRIANGLES||m.mode===ue.TRIANGLE_STRIP||m.mode===ue.TRIANGLE_FAN||m.mode===void 0)p=s.isSkinnedMesh===!0?new Us(g,x):new Oe(g,x),p.isSkinnedMesh===!0&&p.normalizeSkinWeights(),m.mode===ue.TRIANGLE_STRIP?p.geometry=Zn(p.geometry,jr):m.mode===ue.TRIANGLE_FAN&&(p.geometry=Zn(p.geometry,yn));else if(m.mode===ue.LINES)p=new Ds(g,x);else if(m.mode===ue.LINE_STRIP)p=new Fs(g,x);else if(m.mode===ue.LINE_LOOP)p=new js(g,x);else if(m.mode===ue.POINTS)p=new Hs(g,x);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+m.mode);Object.keys(p.geometry.morphAttributes).length>0&&qo(p,s),p.name=t.createUniqueName(s.name||"mesh_"+e),Ie(p,s),m.extensions&&De(n,p,m),t.assignFinalMaterial(p),u.push(p)}for(let f=0,w=u.length;f<w;f++)t.associations.set(u[f],{meshes:e,primitives:f});if(u.length===1)return s.extensions&&De(n,u[0],s),u[0];const h=new He;s.extensions&&De(n,h,s),t.associations.set(h,{meshes:e});for(let f=0,w=u.length;f<w;f++)h.add(u[f]);return h})}loadCamera(e){let t;const r=this.json.cameras[e],n=r[r.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return r.type==="perspective"?t=new ks(Dr.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):r.type==="orthographic"&&(t=new Gs(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),r.name&&(t.name=this.createUniqueName(r.name)),Ie(t,r),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],r=[];for(let n=0,s=t.joints.length;n<s;n++)r.push(this._loadNodeShallow(t.joints[n]));return t.inverseBindMatrices!==void 0?r.push(this.getDependency("accessor",t.inverseBindMatrices)):r.push(null),Promise.all(r).then(function(n){const s=n.pop(),o=n,a=[],l=[];for(let c=0,d=o.length;c<d;c++){const u=o[c];if(u){a.push(u);const h=new J;s!==null&&h.fromArray(s.array,c*16),l.push(h)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[c])}return new Vs(a,l)})}loadAnimation(e){const t=this.json.animations[e],r=t.name?t.name:"animation_"+e,n=[],s=[],o=[],a=[],l=[];for(let c=0,d=t.channels.length;c<d;c++){const u=t.channels[c],h=t.samplers[u.sampler],f=u.target,w=f.node,g=t.parameters!==void 0?t.parameters[h.input]:h.input,m=t.parameters!==void 0?t.parameters[h.output]:h.output;f.node!==void 0&&(n.push(this.getDependency("node",w)),s.push(this.getDependency("accessor",g)),o.push(this.getDependency("accessor",m)),a.push(h),l.push(f))}return Promise.all([Promise.all(n),Promise.all(s),Promise.all(o),Promise.all(a),Promise.all(l)]).then(function(c){const d=c[0],u=c[1],h=c[2],f=c[3],w=c[4],g=[];for(let m=0,p=d.length;m<p;m++){const x=d[m],v=u[m],y=h[m],_=f[m],b=w[m];if(x===void 0)continue;x.updateMatrix();let A;switch(Re[b.path]){case Re.weights:A=$s;break;case Re.rotation:A=qn;break;case Re.position:case Re.scale:default:A=Ws;break}const S=x.name?x.name:x.uuid,E=_.interpolation!==void 0?Go[_.interpolation]:Fr,M=[];Re[b.path]===Re.weights?x.traverse(function(L){L.morphTargetInfluences&&M.push(L.name?L.name:L.uuid)}):M.push(S);let R=y.array;if(y.normalized){const L=_n(R.constructor),P=new Float32Array(R.length);for(let B=0,D=R.length;B<D;B++)P[B]=R[B]*L;R=P}for(let L=0,P=M.length;L<P;L++){const B=new A(M[L]+"."+Re[b.path],v.array,R,E);_.interpolation==="CUBICSPLINE"&&(B.createInterpolant=function(D){const j=this instanceof qn?ko:$r;return new j(this.times,this.values,this.getValueSize()/3,D)},B.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),g.push(B)}}return new qs(r,void 0,g)})}createNodeMesh(e){const t=this.json,r=this,n=t.nodes[e];return n.mesh===void 0?null:r.getDependency("mesh",n.mesh).then(function(s){const o=r._getNodeRef(r.meshCache,n.mesh,s);return n.weights!==void 0&&o.traverse(function(a){if(a.isMesh)for(let l=0,c=n.weights.length;l<c;l++)a.morphTargetInfluences[l]=n.weights[l]}),o})}loadNode(e){const t=this.json,r=this,n=t.nodes[e],s=r._loadNodeShallow(e),o=[],a=n.children||[];for(let c=0,d=a.length;c<d;c++)o.push(r.getDependency("node",a[c]));const l=n.skin===void 0?Promise.resolve(null):r.getDependency("skin",n.skin);return Promise.all([s,Promise.all(o),l]).then(function(c){const d=c[0],u=c[1],h=c[2];h!==null&&d.traverse(function(f){f.isSkinnedMesh&&f.bind(h,$o)});for(let f=0,w=u.length;f<w;f++)d.add(u[f]);return d})}_loadNodeShallow(e){const t=this.json,r=this.extensions,n=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const s=t.nodes[e],o=s.name?n.createUniqueName(s.name):"",a=[],l=n._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return l&&a.push(l),s.camera!==void 0&&a.push(n.getDependency("camera",s.camera).then(function(c){return n._getNodeRef(n.cameraCache,s.camera,c)})),n._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){a.push(c)}),this.nodeCache[e]=Promise.all(a).then(function(c){let d;if(s.isBone===!0?d=new Ks:c.length>1?d=new He:c.length===1?d=c[0]:d=new On,d!==c[0])for(let u=0,h=c.length;u<h;u++)d.add(c[u]);if(s.name&&(d.userData.name=s.name,d.name=o),Ie(d,s),s.extensions&&De(r,d,s),s.matrix!==void 0){const u=new J;u.fromArray(s.matrix),d.applyMatrix4(u)}else s.translation!==void 0&&d.position.fromArray(s.translation),s.rotation!==void 0&&d.quaternion.fromArray(s.rotation),s.scale!==void 0&&d.scale.fromArray(s.scale);return n.associations.has(d)||n.associations.set(d,{}),n.associations.get(d).nodes=e,d}),this.nodeCache[e]}loadScene(e){const t=this.extensions,r=this.json.scenes[e],n=this,s=new He;r.name&&(s.name=n.createUniqueName(r.name)),Ie(s,r),r.extensions&&De(t,s,r);const o=r.nodes||[],a=[];for(let l=0,c=o.length;l<c;l++)a.push(n.getDependency("node",o[l]));return Promise.all(a).then(function(l){for(let d=0,u=l.length;d<u;d++)s.add(l[d]);const c=d=>{const u=new Map;for(const[h,f]of n.associations)(h instanceof Yt||h instanceof Xn)&&u.set(h,f);return d.traverse(h=>{const f=n.associations.get(h);f!=null&&u.set(h,f)}),u};return n.associations=c(s),s})}}function Zo(i,e,t){const r=e.attributes,n=new $;if(r.POSITION!==void 0){const a=t.json.accessors[r.POSITION],l=a.min,c=a.max;if(l!==void 0&&c!==void 0){if(n.set(new C(l[0],l[1],l[2]),new C(c[0],c[1],c[2])),a.normalized){const d=_n(rt[a.componentType]);n.min.multiplyScalar(d),n.max.multiplyScalar(d)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const s=e.targets;if(s!==void 0){const a=new C,l=new C;for(let c=0,d=s.length;c<d;c++){const u=s[c];if(u.POSITION!==void 0){const h=t.json.accessors[u.POSITION],f=h.min,w=h.max;if(f!==void 0&&w!==void 0){if(l.setX(Math.max(Math.abs(f[0]),Math.abs(w[0]))),l.setY(Math.max(Math.abs(f[1]),Math.abs(w[1]))),l.setZ(Math.max(Math.abs(f[2]),Math.abs(w[2]))),h.normalized){const g=_n(rt[h.componentType]);l.multiplyScalar(g)}a.max(l)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(a)}i.boundingBox=n;const o=new ot;n.getCenter(o.center),o.radius=n.min.distanceTo(n.max)/2,i.boundingSphere=o}function tr(i,e,t){const r=e.attributes,n=[];function s(o,a){return t.getDependency("accessor",o).then(function(l){i.setAttribute(a,l)})}for(const o in r){const a=An[o]||o.toLowerCase();a in i.attributes||n.push(s(r[o],a))}if(e.indices!==void 0&&!i.index){const o=t.getDependency("accessor",e.indices).then(function(a){i.setIndex(a)});n.push(o)}return Ie(i,e),Zo(i,e,t),Promise.all(n).then(function(){return e.targets!==void 0?Xo(i,e.targets,t):i})}var Jo=Object.defineProperty,Qo=(i,e,t)=>e in i?Jo(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,G=(i,e,t)=>(Qo(i,typeof e!="symbol"?e+"":e,t),t);const X={ComponentState:{DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"},ComponentProperty:{BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"},ComponentType:{TOUCHPAD:"touchpad"},ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:{TRANSFORM:"transform",VISIBILITY:"visibility"}};async function Yr(i){const e=await fetch(i);if(e.ok)return e.json();throw new Error(e.statusText)}async function ei(i){if(!i)throw new Error("No basePath supplied");return await Yr(`${i}/profilesList.json`)}async function ti(i,e,t=null,r=!0){if(!i)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No basePath supplied");const n=await ei(e);let s;if(i.profiles.some(l=>{const c=n[l];return c&&(s={profileId:l,profilePath:`${e}/${c.path}`,deprecated:!!c.deprecated}),!!s}),!s){if(!t)throw new Error("No matching profile name found");const l=n[t];if(!l)throw new Error(`No matching profile name found and default profile "${t}" missing.`);s={profileId:t,profilePath:`${e}/${l.path}`,deprecated:!!l.deprecated}}const o=await Yr(s.profilePath);let a;if(r){let l;if(i.handedness==="any"?l=o.layouts[Object.keys(o.layouts)[0]]:l=o.layouts[i.handedness],!l)throw new Error(`No matching handedness, ${i.handedness}, in profile ${s.profileId}`);l.assetPath&&(a=s.profilePath.replace("profile.json",l.assetPath))}return{profile:o,assetPath:a}}const ni={xAxis:0,yAxis:0,button:0,state:X.ComponentState.DEFAULT};function ri(i=0,e=0){let t=i,r=e;if(Math.sqrt(i*i+e*e)>1){const n=Math.atan2(e,i);t=Math.cos(n),r=Math.sin(n)}return{normalizedXAxis:t*.5+.5,normalizedYAxis:r*.5+.5}}class si{constructor(e){G(this,"value"),G(this,"componentProperty"),G(this,"states"),G(this,"valueNodeName"),G(this,"valueNodeProperty"),G(this,"minNodeName"),G(this,"maxNodeName"),G(this,"valueNode"),G(this,"minNode"),G(this,"maxNode"),this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===X.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(ni)}updateFromComponent({xAxis:e,yAxis:t,button:r,state:n}){const{normalizedXAxis:s,normalizedYAxis:o}=ri(e,t);switch(this.componentProperty){case X.ComponentProperty.X_AXIS:this.value=this.states.includes(n)?s:.5;break;case X.ComponentProperty.Y_AXIS:this.value=this.states.includes(n)?o:.5;break;case X.ComponentProperty.BUTTON:this.value=this.states.includes(n)&&r?r:0;break;case X.ComponentProperty.STATE:this.valueNodeProperty===X.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(n):this.value=this.states.includes(n)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class oi{constructor(e,t){if(G(this,"id"),G(this,"values"),G(this,"type"),G(this,"gamepadIndices"),G(this,"rootNodeName"),G(this,"visualResponses"),G(this,"touchPointNodeName"),G(this,"touchPointNode"),!e||!t||!t.visualResponses||!t.gamepadIndices||Object.keys(t.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach(r=>{const n=new si(t.visualResponses[r]);this.visualResponses[r]=n}),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:X.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=X.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||this.values.button===1?this.values.state=X.ComponentState.PRESSED:(t.touched||this.values.button>X.ButtonTouchThreshold)&&(this.values.state=X.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===X.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>X.AxisTouchThreshold&&(this.values.state=X.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===X.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>X.AxisTouchThreshold&&(this.values.state=X.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(t=>{t.updateFromComponent(this.values)})}}class ii{constructor(e,t,r){if(G(this,"xrInputSource"),G(this,"assetUrl"),G(this,"layoutDescription"),G(this,"id"),G(this,"components"),!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");if(!t.layouts[e.handedness])throw new Error("No layout for "+e.handedness+" handedness");this.xrInputSource=e,this.assetUrl=r,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(n=>{const s=this.layoutDescription.components[n];this.components[n]=new oi(n,s)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach(t=>{e.push(t.data)}),e}updateFromGamepad(){Object.values(this.components).forEach(e=>{e.updateFromGamepad(this.xrInputSource.gamepad)})}}const nr=new $,Et=new C;class Un extends ys{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const e=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],t=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],r=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(r),this.setAttribute("position",new Vn(e,3)),this.setAttribute("uv",new Vn(t,2))}applyMatrix4(e){const t=this.attributes.instanceStart,r=this.attributes.instanceEnd;return t!==void 0&&(t.applyMatrix4(e),r.applyMatrix4(e),t.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const r=new gn(t,6,1);return this.setAttribute("instanceStart",new je(r,3,0)),this.setAttribute("instanceEnd",new je(r,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e,t=3){let r;e instanceof Float32Array?r=e:Array.isArray(e)&&(r=new Float32Array(e));const n=new gn(r,t*2,1);return this.setAttribute("instanceColorStart",new je(n,t,0)),this.setAttribute("instanceColorEnd",new je(n,t,t)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new ws(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new $);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;e!==void 0&&t!==void 0&&(this.boundingBox.setFromBufferAttribute(e),nr.setFromBufferAttribute(t),this.boundingBox.union(nr))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new ot),this.boundingBox===null&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(e!==void 0&&t!==void 0){const r=this.boundingSphere.center;this.boundingBox.getCenter(r);let n=0;for(let s=0,o=e.count;s<o;s++)Et.fromBufferAttribute(e,s),n=Math.max(n,r.distanceToSquared(Et)),Et.fromBufferAttribute(t,s),n=Math.max(n,r.distanceToSquared(Et));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}class Zr extends Un{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,r=new Float32Array(2*t);for(let n=0;n<t;n+=3)r[2*n]=e[n],r[2*n+1]=e[n+1],r[2*n+2]=e[n+2],r[2*n+3]=e[n+3],r[2*n+4]=e[n+4],r[2*n+5]=e[n+5];return super.setPositions(r),this}setColors(e,t=3){const r=e.length-t,n=new Float32Array(2*r);if(t===3)for(let s=0;s<r;s+=t)n[2*s]=e[s],n[2*s+1]=e[s+1],n[2*s+2]=e[s+2],n[2*s+3]=e[s+3],n[2*s+4]=e[s+4],n[2*s+5]=e[s+5];else for(let s=0;s<r;s+=t)n[2*s]=e[s],n[2*s+1]=e[s+1],n[2*s+2]=e[s+2],n[2*s+3]=e[s+3],n[2*s+4]=e[s+4],n[2*s+5]=e[s+5],n[2*s+6]=e[s+6],n[2*s+7]=e[s+7];return super.setColors(n,t),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}}class Dn extends vs{constructor(e){super({type:"LineMaterial",uniforms:xn.clone(xn.merge([Gn.common,Gn.fog,{worldUnits:{value:1},linewidth:{value:1},resolution:{value:new k(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}}])),vertexShader:`
				#include <common>
				#include <fog_pars_vertex>
				#include <logdepthbuf_pars_vertex>
				#include <clipping_planes_pars_vertex>

				uniform float linewidth;
				uniform vec2 resolution;

				attribute vec3 instanceStart;
				attribute vec3 instanceEnd;

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
						attribute vec4 instanceColorStart;
						attribute vec4 instanceColorEnd;
					#else
						varying vec3 vLineColor;
						attribute vec3 instanceColorStart;
						attribute vec3 instanceColorEnd;
					#endif
				#endif

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#ifdef USE_DASH

					uniform float dashScale;
					attribute float instanceDistanceStart;
					attribute float instanceDistanceEnd;
					varying float vLineDistance;

				#endif

				void trimSegment( const in vec4 start, inout vec4 end ) {

					// trim end segment so it terminates between the camera plane and the near plane

					// conservative estimate of the near plane
					float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
					float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
					float nearEstimate = - 0.5 * b / a;

					float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

					end.xyz = mix( start.xyz, end.xyz, alpha );

				}

				void main() {

					#ifdef USE_COLOR

						vLineColor = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

					#endif

					#ifdef USE_DASH

						vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
						vUv = uv;

					#endif

					float aspect = resolution.x / resolution.y;

					// camera space
					vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
					vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

					#ifdef WORLD_UNITS

						worldStart = start.xyz;
						worldEnd = end.xyz;

					#else

						vUv = uv;

					#endif

					// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
					// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
					// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
					// perhaps there is a more elegant solution -- WestLangley

					bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

					if ( perspective ) {

						if ( start.z < 0.0 && end.z >= 0.0 ) {

							trimSegment( start, end );

						} else if ( end.z < 0.0 && start.z >= 0.0 ) {

							trimSegment( end, start );

						}

					}

					// clip space
					vec4 clipStart = projectionMatrix * start;
					vec4 clipEnd = projectionMatrix * end;

					// ndc space
					vec3 ndcStart = clipStart.xyz / clipStart.w;
					vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

					// direction
					vec2 dir = ndcEnd.xy - ndcStart.xy;

					// account for clip-space aspect ratio
					dir.x *= aspect;
					dir = normalize( dir );

					#ifdef WORLD_UNITS

						// get the offset direction as perpendicular to the view vector
						vec3 worldDir = normalize( end.xyz - start.xyz );
						vec3 offset;
						if ( position.y < 0.5 ) {

							offset = normalize( cross( start.xyz, worldDir ) );

						} else {

							offset = normalize( cross( end.xyz, worldDir ) );

						}

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

						// don't extend the line if we're rendering dashes because we
						// won't be rendering the endcaps
						#ifndef USE_DASH

							// extend the line bounds to encompass  endcaps
							start.xyz += - worldDir * linewidth * 0.5;
							end.xyz += worldDir * linewidth * 0.5;

							// shift the position of the quad so it hugs the forward edge of the line
							offset.xy -= dir * forwardOffset;
							offset.z += 0.5;

						#endif

						// endcaps
						if ( position.y > 1.0 || position.y < 0.0 ) {

							offset.xy += dir * 2.0 * forwardOffset;

						}

						// adjust for linewidth
						offset *= linewidth * 0.5;

						// set the world position
						worldPos = ( position.y < 0.5 ) ? start : end;
						worldPos.xyz += offset;

						// project the worldpos
						vec4 clip = projectionMatrix * worldPos;

						// shift the depth of the projected points so the line
						// segments overlap neatly
						vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
						clip.z = clipPose.z * clip.w;

					#else

						vec2 offset = vec2( dir.y, - dir.x );
						// undo aspect ratio adjustment
						dir.x /= aspect;
						offset.x /= aspect;

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						// endcaps
						if ( position.y < 0.0 ) {

							offset += - dir;

						} else if ( position.y > 1.0 ) {

							offset += dir;

						}

						// adjust for linewidth
						offset *= linewidth;

						// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
						offset /= resolution.y;

						// select end
						vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

						// back to clip space
						offset *= clip.w;

						clip.xy += offset;

					#endif

					gl_Position = clip;

					vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

					#include <logdepthbuf_vertex>
					#include <clipping_planes_vertex>
					#include <fog_vertex>

				}
			`,fragmentShader:`
				uniform vec3 diffuse;
				uniform float opacity;
				uniform float linewidth;

				#ifdef USE_DASH

					uniform float dashOffset;
					uniform float dashSize;
					uniform float gapSize;

				#endif

				varying float vLineDistance;

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#include <common>
				#include <fog_pars_fragment>
				#include <logdepthbuf_pars_fragment>
				#include <clipping_planes_pars_fragment>

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
					#else
						varying vec3 vLineColor;
					#endif
				#endif

				vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

					float mua;
					float mub;

					vec3 p13 = p1 - p3;
					vec3 p43 = p4 - p3;

					vec3 p21 = p2 - p1;

					float d1343 = dot( p13, p43 );
					float d4321 = dot( p43, p21 );
					float d1321 = dot( p13, p21 );
					float d4343 = dot( p43, p43 );
					float d2121 = dot( p21, p21 );

					float denom = d2121 * d4343 - d4321 * d4321;

					float numer = d1343 * d4321 - d1321 * d4343;

					mua = numer / denom;
					mua = clamp( mua, 0.0, 1.0 );
					mub = ( d1343 + d4321 * ( mua ) ) / d4343;
					mub = clamp( mub, 0.0, 1.0 );

					return vec2( mua, mub );

				}

				void main() {

					#include <clipping_planes_fragment>

					#ifdef USE_DASH

						if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

						if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

					#endif

					float alpha = opacity;

					#ifdef WORLD_UNITS

						// Find the closest points on the view ray and the line segment
						vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
						vec3 lineDir = worldEnd - worldStart;
						vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

						vec3 p1 = worldStart + lineDir * params.x;
						vec3 p2 = rayEnd * params.y;
						vec3 delta = p1 - p2;
						float len = length( delta );
						float norm = len / linewidth;

						#ifndef USE_DASH

							#ifdef USE_ALPHA_TO_COVERAGE

								float dnorm = fwidth( norm );
								alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

							#else

								if ( norm > 0.5 ) {

									discard;

								}

							#endif

						#endif

					#else

						#ifdef USE_ALPHA_TO_COVERAGE

							// artifacts appear on some hardware if a derivative is taken within a conditional
							float a = vUv.x;
							float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
							float len2 = a * a + b * b;
							float dlen = fwidth( len2 );

							if ( abs( vUv.y ) > 1.0 ) {

								alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

							}

						#else

							if ( abs( vUv.y ) > 1.0 ) {

								float a = vUv.x;
								float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
								float len2 = a * a + b * b;

								if ( len2 > 1.0 ) discard;

							}

						#endif

					#endif

					vec4 diffuseColor = vec4( diffuse, alpha );
					#ifdef USE_COLOR
						#ifdef USE_LINE_COLOR_ALPHA
							diffuseColor *= vLineColor;
						#else
							diffuseColor.rgb *= vLineColor;
						#endif
					#endif

					#include <logdepthbuf_fragment>

					gl_FragColor = diffuseColor;

					#include <tonemapping_fragment>
					#include <${parseInt(Nr.replace(/\D+/g,""))>=154?"colorspace_fragment":"encodings_fragment"}>
					#include <fog_fragment>
					#include <premultiplied_alpha_fragment>

				}
			`,clipping:!0}),this.isLineMaterial=!0,this.onBeforeCompile=function(){this.transparent?this.defines.USE_LINE_COLOR_ALPHA="1":delete this.defines.USE_LINE_COLOR_ALPHA},Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(t){t===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(t){!!t!="USE_DASH"in this.defines&&(this.needsUpdate=!0),t===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(t){this.uniforms.dashOffset.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}},alphaToCoverage:{enumerable:!0,get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(t){!!t!="USE_ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),t===!0?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(e)}}const rr=new C,sr=new C,ee=new _t,te=new _t,we=new _t,en=new C,tn=new J,ne=new Se,or=new C,Mt=new $,Ct=new ot,Ae=new _t;let _e,bn,Jr,Ve;function ir(i,e,t){return Ae.set(0,0,-e,1).applyMatrix4(i.projectionMatrix),Ae.multiplyScalar(1/Ae.w),Ae.x=Ve/t.width,Ae.y=Ve/t.height,Ae.applyMatrix4(i.projectionMatrixInverse),Ae.multiplyScalar(1/Ae.w),Math.abs(Math.max(Ae.x,Ae.y))}function ai(i,e){for(let t=0,r=bn.count;t<r;t++){ne.start.fromBufferAttribute(bn,t),ne.end.fromBufferAttribute(Jr,t);const n=new C,s=new C;_e.distanceSqToSegment(ne.start,ne.end,s,n),s.distanceTo(n)<Ve*.5&&e.push({point:s,pointOnLine:n,distance:_e.origin.distanceTo(s),object:i,face:null,faceIndex:t,uv:null,uv2:null})}}function li(i,e,t){const r=e.projectionMatrix,n=i.material.resolution,s=i.matrixWorld,o=i.geometry,a=o.attributes.instanceStart,l=o.attributes.instanceEnd,c=-e.near;_e.at(1,we),we.w=1,we.applyMatrix4(e.matrixWorldInverse),we.applyMatrix4(r),we.multiplyScalar(1/we.w),we.x*=n.x/2,we.y*=n.y/2,we.z=0,en.copy(we),tn.multiplyMatrices(e.matrixWorldInverse,s);for(let d=0,u=a.count;d<u;d++){if(ee.fromBufferAttribute(a,d),te.fromBufferAttribute(l,d),ee.w=1,te.w=1,ee.applyMatrix4(tn),te.applyMatrix4(tn),ee.z>c&&te.z>c)continue;if(ee.z>c){const m=ee.z-te.z,p=(ee.z-c)/m;ee.lerp(te,p)}else if(te.z>c){const m=te.z-ee.z,p=(te.z-c)/m;te.lerp(ee,p)}ee.applyMatrix4(r),te.applyMatrix4(r),ee.multiplyScalar(1/ee.w),te.multiplyScalar(1/te.w),ee.x*=n.x/2,ee.y*=n.y/2,te.x*=n.x/2,te.y*=n.y/2,ne.start.copy(ee),ne.start.z=0,ne.end.copy(te),ne.end.z=0;const h=ne.closestPointToPointParameter(en,!0);ne.at(h,or);const f=Dr.lerp(ee.z,te.z,h),w=f>=-1&&f<=1,g=en.distanceTo(or)<Ve*.5;if(w&&g){ne.start.fromBufferAttribute(a,d),ne.end.fromBufferAttribute(l,d),ne.start.applyMatrix4(s),ne.end.applyMatrix4(s);const m=new C,p=new C;_e.distanceSqToSegment(ne.start,ne.end,p,m),t.push({point:p,pointOnLine:m,distance:_e.origin.distanceTo(p),object:i,face:null,faceIndex:d,uv:null,uv2:null})}}}class Qr extends Oe{constructor(e=new Un,t=new Dn({color:Math.random()*16777215})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,r=e.attributes.instanceEnd,n=new Float32Array(2*t.count);for(let o=0,a=0,l=t.count;o<l;o++,a+=2)rr.fromBufferAttribute(t,o),sr.fromBufferAttribute(r,o),n[a]=a===0?0:n[a-1],n[a+1]=n[a]+rr.distanceTo(sr);const s=new gn(n,2,1);return e.setAttribute("instanceDistanceStart",new je(s,1,0)),e.setAttribute("instanceDistanceEnd",new je(s,1,1)),this}raycast(e,t){const r=this.material.worldUnits,n=e.camera;n===null&&!r&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const s=e.params.Line2!==void 0&&e.params.Line2.threshold||0;_e=e.ray;const o=this.matrixWorld,a=this.geometry,l=this.material;Ve=l.linewidth+s,bn=a.attributes.instanceStart,Jr=a.attributes.instanceEnd,a.boundingSphere===null&&a.computeBoundingSphere(),Ct.copy(a.boundingSphere).applyMatrix4(o);let c;if(r)c=Ve*.5;else{const u=Math.max(n.near,Ct.distanceToPoint(_e.origin));c=ir(n,u,l.resolution)}if(Ct.radius+=c,_e.intersectsSphere(Ct)===!1)return;a.boundingBox===null&&a.computeBoundingBox(),Mt.copy(a.boundingBox).applyMatrix4(o);let d;if(r)d=Ve*.5;else{const u=Math.max(n.near,Mt.distanceToPoint(_e.origin));d=ir(n,u,l.resolution)}Mt.expandByScalar(d),_e.intersectsBox(Mt)!==!1&&(r?ai(this,t):li(this,n,t))}}class ci extends Qr{constructor(e=new Zr,t=new Dn({color:Math.random()*16777215})){super(e,t),this.isLine2=!0,this.type="Line2"}}const ui="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",di="generic-trigger";class hi{constructor(e=null,t=ui){this.gltfLoader=e??new Kr,this.path=t,this._assetCache={}}initializeControllerModel(e,t){return t.targetRayMode!=="tracked-pointer"||!t.gamepad?Promise.resolve():ti(t,this.path,di).then(({profile:r,assetPath:n})=>{if(!n)throw new Error("no asset path");const s=new ii(t,r,n);e.connectMotionController(s);const o=s.assetUrl,a=this._assetCache[o];if(a){const l=a.scene.clone();e.connectModel(l)}else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(o,l=>{if(!e.motionController){console.warn("motionController gone while gltf load, bailing...");return}this._assetCache[o]=l;const c=l.scene.clone();e.connectModel(c)},void 0,()=>{throw new Error(`Asset ${o} missing or malformed.`)})}}).catch(r=>{console.warn(r)})}}const ar=i=>"envMap"in i,lr=(i,e)=>{i.envMap=e,i.needsUpdate=!0},es=(i,e)=>{e instanceof Oe&&(Array.isArray(e.material)?e.material.forEach(t=>ar(t)?lr(t,i):void 0):ar(e.material)&&lr(e.material,i))},cr=i=>"envMapIntensity"in i,ur=(i,e)=>{i.envMapIntensity=e,i.needsUpdate=!0},Sn=(i,e)=>{e instanceof Oe&&(Array.isArray(e.material)?e.material.forEach(t=>cr(t)?ur(t,i):void 0):cr(e.material)&&ur(e.material,i))};function fi(i,e){Object.values(i.components).forEach(t=>{const{type:r,touchPointNodeName:n,visualResponses:s}=t;if(r===X.ComponentType.TOUCHPAD&&n)if(t.touchPointNode=e.getObjectByName(n),t.touchPointNode){const o=new eo(.001),a=new Fe({color:255}),l=new Oe(o,a);t.touchPointNode.add(l)}else console.warn(`Could not find touch dot, ${t.touchPointNodeName}, in touchpad component ${t.id}`);Object.values(s).forEach(o=>{const{valueNodeName:a,minNodeName:l,maxNodeName:c,valueNodeProperty:d}=o;if(d===X.VisualResponseProperty.TRANSFORM&&l&&c){if(o.minNode=e.getObjectByName(l),o.maxNode=e.getObjectByName(c),!o.minNode){console.warn(`Could not find ${l} in the model`);return}if(!o.maxNode){console.warn(`Could not find ${c} in the model`);return}}o.valueNode=e.getObjectByName(a),o.valueNode||console.warn(`Could not find ${a} in the model`)})})}function pi(i,e){fi(i.motionController,e),(i.envMap||i.envMapIntensity!=null)&&e.traverse(t=>{i.envMap&&es(i.envMap,t),i.envMapIntensity!=null&&Sn(i.envMapIntensity,t)}),i.add(e)}class mi extends He{constructor(){super(),this.motionController=null,this.envMap=null,this.envMapIntensity=1,this.scene=null}setEnvironmentMap(e,t=1){var r;return this.envMap===e&&this.envMapIntensity===t?this:(this.envMap=e,this.envMapIntensity=t,(r=this.scene)==null||r.traverse(n=>{es(e,n),Sn(t,n)}),this)}setEnvironmentMapIntensity(e){var t;return this.envMapIntensity===e?this:(this.envMapIntensity=e,(t=this.scene)==null||t.traverse(r=>Sn(e,r)),this)}connectModel(e){if(!this.motionController){console.warn("scene tried to add, but no motion controller");return}this.scene=e,pi(this,e),this.dispatchEvent({type:"modelconnected",data:e})}connectMotionController(e){this.motionController=e,this.dispatchEvent({type:"motionconnected",data:e})}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach(t=>{Object.values(t.visualResponses).forEach(r=>{const{valueNode:n,minNode:s,maxNode:o,value:a,valueNodeProperty:l}=r;n&&(l===X.VisualResponseProperty.VISIBILITY&&typeof a=="boolean"?n.visible=a:l===X.VisualResponseProperty.TRANSFORM&&s&&o&&typeof a=="number"&&(n.quaternion.slerpQuaternions(s.quaternion,o.quaternion,a),n.position.lerpVectors(s.position,o.position,a)))})}))}disconnect(){this.dispatchEvent({type:"motiondisconnected",data:this.motionController}),this.dispatchEvent({type:"modeldisconnected",data:this.scene}),this.motionController=null,this.scene&&this.remove(this.scene),this.scene=null}dispose(){this.disconnect()}}const gi=T.forwardRef(function({target:i,hideOnBlur:e=!1,...t},r){const n=q(a=>a.hoverState),s=T.useRef(null),o=T.useMemo(()=>new Ir().setFromPoints([new C(0,0,0),new C(0,0,-1)]),[]);return T.useImperativeHandle(r,()=>s.current),it(()=>{if(!i.inputSource)return;let a=1;const l=n[i.inputSource.handedness].values().next().value;l&&i.inputSource.handedness!=="none"?(a=l.distance,e&&(s.current.visible=!1)):e&&(s.current.visible=!0);const c=-.01;s.current.scale.z=a+c}),T.createElement("line",{ref:s,geometry:o,"material-opacity":.8,"material-transparent":!0,...t})}),xi=new hi,vi=({target:i,envMap:e,envMapIntensity:t})=>{const r=T.useRef(null),n=be(l=>{e!=null&&l.setEnvironmentMap(e)}),s=be(l=>l.setEnvironmentMap(null)),o=be(l=>{t!=null&&l.setEnvironmentMapIntensity(t)}),a=T.useCallback(l=>{var c,d,u;if(r.current=l,l){if(i.xrControllerModel=l,(c=i.inputSource)!=null&&c.hand)return;n.current(l),o.current(l),i.inputSource?xi.initializeControllerModel(l,i.inputSource):console.warn("no input source on XRController when handleControllerModel")}else{if((d=i.inputSource)!=null&&d.hand)return;(u=i.xrControllerModel)==null||u.disconnect(),i.xrControllerModel=null}},[i,o,n]);return T.useLayoutEffect(()=>{r.current&&(e?n.current(r.current):s.current(r.current))},[e,n,s]),T.useLayoutEffect(()=>{r.current&&o.current(r.current)},[t,o]),T.createElement("xRControllerModel",{ref:a})};function yi({rayMaterial:i={},hideRaysOnBlur:e=!1,envMap:t,envMapIntensity:r}){const n=q(a=>a.controllers),s=q(a=>a.isHandTracking),o=T.useMemo(()=>Object.entries(i).reduce((a,[l,c])=>({...a,[`material-${l}`]:c}),{}),[JSON.stringify(i)]);return T.useMemo(()=>Gr({XRControllerModel:mi}),[]),T.createElement(T.Fragment,null,n.map((a,l)=>T.createElement(T.Fragment,{key:l},wn(T.createElement(vi,{target:a,envMap:t,envMapIntensity:r}),a.grip),wn(T.createElement(gi,{visible:!s,hideOnBlur:e,target:a,...o}),a.controller))))}const wi="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/";class Ai{constructor(e,t,r=wi,n,s){this.controller=t,this.handModel=e,this.bones=[];const o=new Kr;s||o.setPath(r),o.load(s??`${n}.glb`,a=>{const l=a.scene.children[0];this.handModel.add(l),this.scene=l;const c=l.getObjectByProperty("type","SkinnedMesh");c.frustumCulled=!1,c.castShadow=!0,c.receiveShadow=!0,["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"].forEach(d=>{const u=l.getObjectByName(d);u!==void 0?u.jointName=d:console.warn(`Couldn't find ${d} in ${n} hand mesh`),this.bones.push(u)})})}updateMesh(){const e=this.controller.joints;let t=!0;for(let r=0;r<this.bones.length;r++){const n=this.bones[r];if(n){const s=e[n.jointName];if(s.visible){const o=s.position;n.position.copy(o),n.quaternion.copy(s.quaternion),t=!1}}}t&&this.scene?this.scene.visible=!1:this.scene&&(this.scene.visible=!0)}dispose(){this.scene&&this.handModel.remove(this.scene)}}const _i=.01,bi="index-finger-tip";class Si extends On{constructor(e,t,r){super(),this._onConnected=n=>{const s=n.data;s.hand&&!this.motionController&&(this.xrInputSource=s,this.motionController=new Ai(this,this.controller,void 0,s.handedness,s.handedness==="left"?this.leftModelPath:this.rightModelPath))},this._onDisconnected=()=>{var n;(n=this.xrInputSource)!=null&&n.hand&&this.motionControllerCleanup()},this.controller=e,this.motionController=null,this.envMap=null,this.leftModelPath=t,this.rightModelPath=r,this.mesh=null,this.xrInputSource=null,e.addEventListener("connected",this._onConnected),e.addEventListener("disconnected",this._onDisconnected)}motionControllerCleanup(){var e;this.clear(),(e=this.motionController)==null||e.dispose(),this.motionController=null}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&this.motionController.updateMesh()}getPointerPosition(){const e=this.controller.joints[bi];return e?e.position:null}intersectBoxObject(e){const t=this.getPointerPosition();if(t){const r=new ot(t,_i),n=new $().setFromObject(e);return r.intersectsBox(n)}else return!1}checkButton(e){this.intersectBoxObject(e)?e.onPress():e.onClear(),e.isPressed()&&e.whilePressed()}dispose(){this.motionControllerCleanup(),this.controller.removeEventListener("connected",this._onConnected),this.controller.removeEventListener("disconnected",this._onDisconnected)}}function Ti({modelLeft:i,modelRight:e}){const t=q(r=>r.controllers);return T.useMemo(()=>Gr({OculusHandModel:Si}),[]),de(()=>{for(const r of t)r.hand.dispatchEvent({type:"connected",data:r.inputSource,fake:!0})},[t,i,e]),T.createElement(T.Fragment,null,t.map(({hand:r})=>wn(T.createElement("oculusHandModel",{args:[r,i,e]}),r)))}const Ei=T.forwardRef(function({points:i,color:e=16777215,vertexColors:t,linewidth:r,lineWidth:n,segments:s,dashed:o,...a},l){var c;const d=Me(g=>g.size),u=T.useMemo(()=>s?new Qr:new ci,[s]),[h]=T.useState(()=>new Dn),f=(t==null||(c=t[0])==null?void 0:c.length)===4?4:3,w=T.useMemo(()=>{const g=s?new Un:new Zr,m=i.map(p=>{const x=Array.isArray(p);return p instanceof C||p instanceof _t?[p.x,p.y,p.z]:p instanceof k?[p.x,p.y,0]:x&&p.length===3?[p[0],p[1],p[2]]:x&&p.length===2?[p[0],p[1],0]:p});if(g.setPositions(m.flat()),t){e=16777215;const p=t.map(x=>x instanceof ze?x.toArray():x);g.setColors(p.flat(),f)}return g},[i,s,t,f]);return T.useLayoutEffect(()=>{u.computeLineDistances()},[i,u]),T.useLayoutEffect(()=>{o?h.defines.USE_DASH="":delete h.defines.USE_DASH,h.needsUpdate=!0},[o,h]),T.useEffect(()=>()=>w.dispose(),[w]),T.createElement("primitive",At({object:u,ref:l},a),T.createElement("primitive",{object:w,attach:"geometry"}),T.createElement("primitive",At({object:h,attach:"material",color:e,vertexColors:!!t,resolution:[d.width,d.height],linewidth:r??n,dashed:o,transparent:f===4},a)))}),ts=T.forwardRef(({sdfGlyphSize:i=64,anchorX:e="center",anchorY:t="middle",font:r,fontSize:n=1,children:s,characters:o,onSync:a,...l},c)=>{const{Text:d,preloadFont:u}=Kn(async()=>Js(()=>Qs(()=>import("./troika-three-text.esm-Dv4dfK9D-CbbrrTSH-ClXaBIPx.js"),__vite__mapDeps([0,1,2])),Vr([0,1,2])),[]),h=Me(({invalidate:m})=>m),[f]=T.useState(()=>new d),[w,g]=T.useMemo(()=>{const m=[];let p="";return T.Children.forEach(s,x=>{typeof x=="string"||typeof x=="number"?p+=x:m.push(x)}),[m,p]},[s]);return Kn(()=>new Promise(m=>u({font:r,characters:o},m)),["troika-text",r,o]),T.useLayoutEffect(()=>void f.sync(()=>{h(),a&&a(f)})),T.useEffect(()=>()=>f.dispose(),[f]),T.createElement("primitive",At({object:f,ref:c,font:r,text:g,anchorX:e,anchorY:t,fontSize:n,sdfGlyphSize:i},l),w)}),ns=0,Mi=1,rs=2,dr=2,nn=1.25,hr=1,yt=32,Kt=65535,Ci=Math.pow(2,-24),rn=Symbol("SKIP_GENERATION");function Li(i){return i.index?i.index.count:i.attributes.position.count}function at(i){return Li(i)/3}function Ri(i,e=ArrayBuffer){return i>65535?new Uint32Array(new e(4*i)):new Uint16Array(new e(2*i))}function Pi(i,e){if(!i.index){const t=i.attributes.position.count,r=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,n=Ri(t,r);i.setIndex(new vt(n,1));for(let s=0;s<t;s++)n[s]=s}}function ss(i){const e=at(i),t=i.drawRange,r=t.start/3,n=(t.start+t.count)/3,s=Math.max(0,r),o=Math.min(e,n)-s;return[{offset:Math.floor(s),count:Math.floor(o)}]}function os(i){if(!i.groups||!i.groups.length)return ss(i);const e=[],t=new Set,r=i.drawRange,n=r.start/3,s=(r.start+r.count)/3;for(const a of i.groups){const l=a.start/3,c=(a.start+a.count)/3;t.add(Math.max(n,l)),t.add(Math.min(s,c))}const o=Array.from(t.values()).sort((a,l)=>a-l);for(let a=0;a<o.length-1;a++){const l=o[a],c=o[a+1];e.push({offset:Math.floor(l),count:Math.floor(c-l)})}return e}function Ii(i){if(i.groups.length===0)return!1;const e=at(i),t=os(i).sort((s,o)=>s.offset-o.offset),r=t[t.length-1];r.count=Math.min(e-r.offset,r.count);let n=0;return t.forEach(({count:s})=>n+=s),e!==n}function sn(i,e,t,r,n){let s=1/0,o=1/0,a=1/0,l=-1/0,c=-1/0,d=-1/0,u=1/0,h=1/0,f=1/0,w=-1/0,g=-1/0,m=-1/0;for(let p=e*6,x=(e+t)*6;p<x;p+=6){const v=i[p+0],y=i[p+1],_=v-y,b=v+y;_<s&&(s=_),b>l&&(l=b),v<u&&(u=v),v>w&&(w=v);const A=i[p+2],S=i[p+3],E=A-S,M=A+S;E<o&&(o=E),M>c&&(c=M),A<h&&(h=A),A>g&&(g=A);const R=i[p+4],L=i[p+5],P=R-L,B=R+L;P<a&&(a=P),B>d&&(d=B),R<f&&(f=R),R>m&&(m=R)}r[0]=s,r[1]=o,r[2]=a,r[3]=l,r[4]=c,r[5]=d,n[0]=u,n[1]=h,n[2]=f,n[3]=w,n[4]=g,n[5]=m}function Bi(i,e=null,t=null,r=null){const n=i.attributes.position,s=i.index?i.index.array:null,o=at(i),a=n.normalized;let l;e===null?(l=new Float32Array(o*6*4),t=0,r=o):(l=e,t=t||0,r=r||o);const c=n.array,d=n.offset||0;let u=3;n.isInterleavedBufferAttribute&&(u=n.data.stride);const h=["getX","getY","getZ"];for(let f=t;f<t+r;f++){const w=f*3,g=f*6;let m=w+0,p=w+1,x=w+2;s&&(m=s[m],p=s[p],x=s[x]),a||(m=m*u+d,p=p*u+d,x=x*u+d);for(let v=0;v<3;v++){let y,_,b;a?(y=n[h[v]](m),_=n[h[v]](p),b=n[h[v]](x)):(y=c[m+v],_=c[p+v],b=c[x+v]);let A=y;_<A&&(A=_),b<A&&(A=b);let S=y;_>S&&(S=_),b>S&&(S=b);const E=(S-A)/2,M=v*2;l[g+M+0]=A+E,l[g+M+1]=E+(Math.abs(A)+E)*Ci}}return l}function V(i,e,t){return t.min.x=e[i],t.min.y=e[i+1],t.min.z=e[i+2],t.max.x=e[i+3],t.max.y=e[i+4],t.max.z=e[i+5],t}function fr(i){let e=-1,t=-1/0;for(let r=0;r<3;r++){const n=i[r+3]-i[r];n>t&&(t=n,e=r)}return e}function pr(i,e){e.set(i)}function mr(i,e,t){let r,n;for(let s=0;s<3;s++){const o=s+3;r=i[s],n=e[s],t[s]=r<n?r:n,r=i[o],n=e[o],t[o]=r>n?r:n}}function Lt(i,e,t){for(let r=0;r<3;r++){const n=e[i+2*r],s=e[i+2*r+1],o=n-s,a=n+s;o<t[r]&&(t[r]=o),a>t[r+3]&&(t[r+3]=a)}}function ut(i){const e=i[3]-i[0],t=i[4]-i[1],r=i[5]-i[2];return 2*(e*t+t*r+r*e)}const Ee=32,Ni=(i,e)=>i.candidate-e.candidate,Pe=new Array(Ee).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),Rt=new Float32Array(6);function Oi(i,e,t,r,n,s){let o=-1,a=0;if(s===ns)o=fr(e),o!==-1&&(a=(e[o]+e[o+3])/2);else if(s===Mi)o=fr(i),o!==-1&&(a=zi(t,r,n,o));else if(s===rs){const l=ut(i);let c=nn*n;const d=r*6,u=(r+n)*6;for(let h=0;h<3;h++){const f=e[h],w=(e[h+3]-f)/Ee;if(n<Ee/4){const g=[...Pe];g.length=n;let m=0;for(let x=d;x<u;x+=6,m++){const v=g[m];v.candidate=t[x+2*h],v.count=0;const{bounds:y,leftCacheBounds:_,rightCacheBounds:b}=v;for(let A=0;A<3;A++)b[A]=1/0,b[A+3]=-1/0,_[A]=1/0,_[A+3]=-1/0,y[A]=1/0,y[A+3]=-1/0;Lt(x,t,y)}g.sort(Ni);let p=n;for(let x=0;x<p;x++){const v=g[x];for(;x+1<p&&g[x+1].candidate===v.candidate;)g.splice(x+1,1),p--}for(let x=d;x<u;x+=6){const v=t[x+2*h];for(let y=0;y<p;y++){const _=g[y];v>=_.candidate?Lt(x,t,_.rightCacheBounds):(Lt(x,t,_.leftCacheBounds),_.count++)}}for(let x=0;x<p;x++){const v=g[x],y=v.count,_=n-v.count,b=v.leftCacheBounds,A=v.rightCacheBounds;let S=0;y!==0&&(S=ut(b)/l);let E=0;_!==0&&(E=ut(A)/l);const M=hr+nn*(S*y+E*_);M<c&&(o=h,c=M,a=v.candidate)}}else{for(let p=0;p<Ee;p++){const x=Pe[p];x.count=0,x.candidate=f+w+p*w;const v=x.bounds;for(let y=0;y<3;y++)v[y]=1/0,v[y+3]=-1/0}for(let p=d;p<u;p+=6){let x=~~((t[p+2*h]-f)/w);x>=Ee&&(x=Ee-1);const v=Pe[x];v.count++,Lt(p,t,v.bounds)}const g=Pe[Ee-1];pr(g.bounds,g.rightCacheBounds);for(let p=Ee-2;p>=0;p--){const x=Pe[p],v=Pe[p+1];mr(x.bounds,v.rightCacheBounds,x.rightCacheBounds)}let m=0;for(let p=0;p<Ee-1;p++){const x=Pe[p],v=x.count,y=x.bounds,_=Pe[p+1].rightCacheBounds;v!==0&&(m===0?pr(y,Rt):mr(y,Rt,Rt)),m+=v;let b=0,A=0;m!==0&&(b=ut(Rt)/l);const S=n-m;S!==0&&(A=ut(_)/l);const E=hr+nn*(b*m+A*S);E<c&&(o=h,c=E,a=x.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${s} used.`);return{axis:o,pos:a}}function zi(i,e,t,r){let n=0;for(let s=e,o=e+t;s<o;s++)n+=i[s*6+r*2];return n/t}class on{constructor(){this.boundingData=new Float32Array(6)}}function Ui(i,e,t,r,n,s){let o=r,a=r+n-1;const l=s.pos,c=s.axis*2;for(;;){for(;o<=a&&t[o*6+c]<l;)o++;for(;o<=a&&t[a*6+c]>=l;)a--;if(o<a){for(let d=0;d<3;d++){let u=e[o*3+d];e[o*3+d]=e[a*3+d],e[a*3+d]=u}for(let d=0;d<6;d++){let u=t[o*6+d];t[o*6+d]=t[a*6+d],t[a*6+d]=u}o++,a--}else return o}}function Di(i,e,t,r,n,s){let o=r,a=r+n-1;const l=s.pos,c=s.axis*2;for(;;){for(;o<=a&&t[o*6+c]<l;)o++;for(;o<=a&&t[a*6+c]>=l;)a--;if(o<a){let d=i[o];i[o]=i[a],i[a]=d;for(let u=0;u<6;u++){let h=t[o*6+u];t[o*6+u]=t[a*6+u],t[a*6+u]=h}o++,a--}else return o}}function oe(i,e){return e[i+15]===65535}function ie(i,e){return e[i+6]}function he(i,e){return e[i+14]}function fe(i){return i+8}function pe(i,e){return e[i+6]}function is(i,e){return e[i+7]}let as,xt,Vt,ls;const Fi=Math.pow(2,32);function Tn(i){return"count"in i?1:1+Tn(i.left)+Tn(i.right)}function ji(i,e,t){return as=new Float32Array(t),xt=new Uint32Array(t),Vt=new Uint16Array(t),ls=new Uint8Array(t),En(i,e)}function En(i,e){const t=i/4,r=i/2,n="count"in e,s=e.boundingData;for(let o=0;o<6;o++)as[t+o]=s[o];if(n)if(e.buffer){const o=e.buffer;ls.set(new Uint8Array(o),i);for(let a=i,l=i+o.byteLength;a<l;a+=yt){const c=a/2;oe(c,Vt)||(xt[a/4+6]+=t)}return i+o.byteLength}else{const o=e.offset,a=e.count;return xt[t+6]=o,Vt[r+14]=a,Vt[r+15]=Kt,i+yt}else{const o=e.left,a=e.right,l=e.splitAxis;let c;if(c=En(i+yt,o),c/4>Fi)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return xt[t+6]=c/4,c=En(c,a),xt[t+7]=l,c}}function Hi(i,e){const t=(i.index?i.index.count:i.attributes.position.count)/3,r=t>2**16,n=r?4:2,s=e?new SharedArrayBuffer(t*n):new ArrayBuffer(t*n),o=r?new Uint32Array(s):new Uint16Array(s);for(let a=0,l=o.length;a<l;a++)o[a]=a;return o}function ki(i,e,t,r,n){const{maxDepth:s,verbose:o,maxLeafTris:a,strategy:l,onProgress:c,indirect:d}=n,u=i._indirectBuffer,h=i.geometry,f=h.index?h.index.array:null,w=d?Di:Ui,g=at(h),m=new Float32Array(6);let p=!1;const x=new on;return sn(e,t,r,x.boundingData,m),y(x,t,r,m),x;function v(_){c&&c(_/g)}function y(_,b,A,S=null,E=0){if(!p&&E>=s&&(p=!0,o&&(console.warn(`MeshBVH: Max depth of ${s} reached when generating BVH. Consider increasing maxDepth.`),console.warn(h))),A<=a||E>=s)return v(b+A),_.offset=b,_.count=A,_;const M=Oi(_.boundingData,S,e,b,A,l);if(M.axis===-1)return v(b+A),_.offset=b,_.count=A,_;const R=w(u,f,e,b,A,M);if(R===b||R===b+A)v(b+A),_.offset=b,_.count=A;else{_.splitAxis=M.axis;const L=new on,P=b,B=R-b;_.left=L,sn(e,P,B,L.boundingData,m),y(L,P,B,m,E+1);const D=new on,j=R,Z=A-B;_.right=D,sn(e,j,Z,D.boundingData,m),y(D,j,Z,m,E+1)}return _}}function Gi(i,e){const t=i.geometry;e.indirect&&(i._indirectBuffer=Hi(t,e.useSharedArrayBuffer),Ii(t)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),i._indirectBuffer||Pi(t,e);const r=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,n=Bi(t),s=e.indirect?ss(t):os(t);i._roots=s.map(o=>{const a=ki(i,n,o.offset,o.count,e),l=Tn(a),c=new r(yt*l);return ji(0,a,c),c})}class Ce{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let r=1/0,n=-1/0;for(let s=0,o=e.length;s<o;s++){const a=e[s][t];r=a<r?a:r,n=a>n?a:n}this.min=r,this.max=n}setFromPoints(e,t){let r=1/0,n=-1/0;for(let s=0,o=t.length;s<o;s++){const a=t[s],l=e.dot(a);r=l<r?l:r,n=l>n?l:n}this.min=r,this.max=n}isSeparated(e){return this.min>e.max||e.min>this.max}}Ce.prototype.setFromBox=(function(){const i=new C;return function(e,t){const r=t.min,n=t.max;let s=1/0,o=-1/0;for(let a=0;a<=1;a++)for(let l=0;l<=1;l++)for(let c=0;c<=1;c++){i.x=r.x*a+n.x*(1-a),i.y=r.y*l+n.y*(1-l),i.z=r.z*c+n.z*(1-c);const d=e.dot(i);s=Math.min(d,s),o=Math.max(d,o)}this.min=s,this.max=o}})();const Vi=(function(){const i=new C,e=new C,t=new C;return function(r,n,s){const o=r.start,a=i,l=n.start,c=e;t.subVectors(o,l),i.subVectors(r.end,r.start),e.subVectors(n.end,n.start);const d=t.dot(c),u=c.dot(a),h=c.dot(c),f=t.dot(a),w=a.dot(a)*h-u*u;let g,m;w!==0?g=(d*u-f*h)/w:g=0,m=(d+g*u)/h,s.x=g,s.y=m}})(),Fn=(function(){const i=new k,e=new C,t=new C;return function(r,n,s,o){Vi(r,n,i);let a=i.x,l=i.y;if(a>=0&&a<=1&&l>=0&&l<=1){r.at(a,s),n.at(l,o);return}else if(a>=0&&a<=1){l<0?n.at(0,o):n.at(1,o),r.closestPointToPoint(o,!0,s);return}else if(l>=0&&l<=1){a<0?r.at(0,s):r.at(1,s),n.closestPointToPoint(s,!0,o);return}else{let c;a<0?c=r.start:c=r.end;let d;l<0?d=n.start:d=n.end;const u=e,h=t;if(r.closestPointToPoint(d,!0,e),n.closestPointToPoint(c,!0,t),u.distanceToSquared(d)<=h.distanceToSquared(c)){s.copy(u),o.copy(d);return}else{s.copy(c),o.copy(h);return}}}})(),Xi=(function(){const i=new C,e=new C,t=new Hr,r=new Se;return function(n,s){const{radius:o,center:a}=n,{a:l,b:c,c:d}=s;if(r.start=l,r.end=c,r.closestPointToPoint(a,!0,i).distanceTo(a)<=o||(r.start=l,r.end=d,r.closestPointToPoint(a,!0,i).distanceTo(a)<=o)||(r.start=c,r.end=d,r.closestPointToPoint(a,!0,i).distanceTo(a)<=o))return!0;const u=s.getPlane(t);if(Math.abs(u.distanceToPoint(a))<=o){const h=u.projectPoint(a,e);if(s.containsPoint(h))return!0}return!1}})(),qi=1e-15;function an(i){return Math.abs(i)<qi}class ve extends gt{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new C),this.satBounds=new Array(4).fill().map(()=>new Ce),this.points=[this.a,this.b,this.c],this.sphere=new ot,this.plane=new Hr,this.needsUpdate=!0}intersectsSphere(e){return Xi(e,this)}update(){const e=this.a,t=this.b,r=this.c,n=this.points,s=this.satAxes,o=this.satBounds,a=s[0],l=o[0];this.getNormal(a),l.setFromPoints(a,n);const c=s[1],d=o[1];c.subVectors(e,t),d.setFromPoints(c,n);const u=s[2],h=o[2];u.subVectors(t,r),h.setFromPoints(u,n);const f=s[3],w=o[3];f.subVectors(r,e),w.setFromPoints(f,n),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,e),this.needsUpdate=!1}}ve.prototype.closestPointToSegment=(function(){const i=new C,e=new C,t=new Se;return function(r,n=null,s=null){const{start:o,end:a}=r,l=this.points;let c,d=1/0;for(let u=0;u<3;u++){const h=(u+1)%3;t.start.copy(l[u]),t.end.copy(l[h]),Fn(t,r,i,e),c=i.distanceToSquared(e),c<d&&(d=c,n&&n.copy(i),s&&s.copy(e))}return this.closestPointToPoint(o,i),c=o.distanceToSquared(i),c<d&&(d=c,n&&n.copy(i),s&&s.copy(o)),this.closestPointToPoint(a,i),c=a.distanceToSquared(i),c<d&&(d=c,n&&n.copy(i),s&&s.copy(a)),Math.sqrt(d)}})();ve.prototype.intersectsTriangle=(function(){const i=new ve,e=new Array(3),t=new Array(3),r=new Ce,n=new Ce,s=new C,o=new C,a=new C,l=new C,c=new C,d=new Se,u=new Se,h=new Se,f=new C;function w(g,m,p){const x=g.points;let v=0,y=-1;for(let _=0;_<3;_++){const{start:b,end:A}=d;b.copy(x[_]),A.copy(x[(_+1)%3]),d.delta(o);const S=an(m.distanceToPoint(b));if(an(m.normal.dot(o))&&S){p.copy(d),v=2;break}const E=m.intersectLine(d,f);if(!E&&S&&f.copy(b),(E||S)&&!an(f.distanceTo(A))){if(v<=1)(v===1?p.start:p.end).copy(f),S&&(y=v);else if(v>=2){(y===1?p.start:p.end).copy(f),v=2;break}if(v++,v===2&&y===-1)break}}return v}return function(g,m=null,p=!1){this.needsUpdate&&this.update(),g.isExtendedTriangle?g.needsUpdate&&g.update():(i.copy(g),i.update(),g=i);const x=this.plane,v=g.plane;if(Math.abs(x.normal.dot(v.normal))>1-1e-10){const y=this.satBounds,_=this.satAxes;t[0]=g.a,t[1]=g.b,t[2]=g.c;for(let S=0;S<4;S++){const E=y[S],M=_[S];if(r.setFromPoints(M,t),E.isSeparated(r))return!1}const b=g.satBounds,A=g.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let S=0;S<4;S++){const E=b[S],M=A[S];if(r.setFromPoints(M,e),E.isSeparated(r))return!1}for(let S=0;S<4;S++){const E=_[S];for(let M=0;M<4;M++){const R=A[M];if(s.crossVectors(E,R),r.setFromPoints(s,e),n.setFromPoints(s,t),r.isSeparated(n))return!1}}return m&&(p||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),m.start.set(0,0,0),m.end.set(0,0,0)),!0}else{const y=w(this,v,u);if(y===1&&g.containsPoint(u.end))return m&&(m.start.copy(u.end),m.end.copy(u.end)),!0;if(y!==2)return!1;const _=w(g,x,h);if(_===1&&this.containsPoint(h.end))return m&&(m.start.copy(h.end),m.end.copy(h.end)),!0;if(_!==2)return!1;if(u.delta(a),h.delta(l),a.dot(l)<0){let L=h.start;h.start=h.end,h.end=L}const b=u.start.dot(a),A=u.end.dot(a),S=h.start.dot(a),E=h.end.dot(a),M=A<S,R=b<E;return b!==E&&S!==A&&M===R?!1:(m&&(c.subVectors(u.start,h.start),c.dot(a)>0?m.start.copy(u.start):m.start.copy(h.start),c.subVectors(u.end,h.end),c.dot(a)<0?m.end.copy(u.end):m.end.copy(h.end)),!0)}}})();ve.prototype.distanceToPoint=(function(){const i=new C;return function(e){return this.closestPointToPoint(e,i),e.distanceTo(i)}})();ve.prototype.distanceToTriangle=(function(){const i=new C,e=new C,t=["a","b","c"],r=new Se,n=new Se;return function(s,o=null,a=null){const l=o||a?r:null;if(this.intersectsTriangle(s,l))return(o||a)&&(o&&l.getCenter(o),a&&l.getCenter(a)),0;let c=1/0;for(let d=0;d<3;d++){let u;const h=t[d],f=s[h];this.closestPointToPoint(f,i),u=f.distanceToSquared(i),u<c&&(c=u,o&&o.copy(i),a&&a.copy(f));const w=this[h];s.closestPointToPoint(w,i),u=w.distanceToSquared(i),u<c&&(c=u,o&&o.copy(w),a&&a.copy(i))}for(let d=0;d<3;d++){const u=t[d],h=t[(d+1)%3];r.set(this[u],this[h]);for(let f=0;f<3;f++){const w=t[f],g=t[(f+1)%3];n.set(s[w],s[g]),Fn(r,n,i,e);const m=i.distanceToSquared(e);m<c&&(c=m,o&&o.copy(i),a&&a.copy(e))}}return Math.sqrt(c)}})();class re{constructor(e,t,r){this.isOrientedBox=!0,this.min=new C,this.max=new C,this.matrix=new J,this.invMatrix=new J,this.points=new Array(8).fill().map(()=>new C),this.satAxes=new Array(3).fill().map(()=>new C),this.satBounds=new Array(3).fill().map(()=>new Ce),this.alignedSatBounds=new Array(3).fill().map(()=>new Ce),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),r&&this.matrix.copy(r)}set(e,t,r){this.min.copy(e),this.max.copy(t),this.matrix.copy(r),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}re.prototype.update=(function(){return function(){const i=this.matrix,e=this.min,t=this.max,r=this.points;for(let l=0;l<=1;l++)for(let c=0;c<=1;c++)for(let d=0;d<=1;d++){const u=1*l|2*c|4*d,h=r[u];h.x=l?t.x:e.x,h.y=c?t.y:e.y,h.z=d?t.z:e.z,h.applyMatrix4(i)}const n=this.satBounds,s=this.satAxes,o=r[0];for(let l=0;l<3;l++){const c=s[l],d=n[l],u=1<<l,h=r[u];c.subVectors(o,h),d.setFromPoints(c,r)}const a=this.alignedSatBounds;a[0].setFromPointsField(r,"x"),a[1].setFromPointsField(r,"y"),a[2].setFromPointsField(r,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}})();re.prototype.intersectsBox=(function(){const i=new Ce;return function(e){this.needsUpdate&&this.update();const t=e.min,r=e.max,n=this.satBounds,s=this.satAxes,o=this.alignedSatBounds;if(i.min=t.x,i.max=r.x,o[0].isSeparated(i)||(i.min=t.y,i.max=r.y,o[1].isSeparated(i))||(i.min=t.z,i.max=r.z,o[2].isSeparated(i)))return!1;for(let a=0;a<3;a++){const l=s[a],c=n[a];if(i.setFromBox(l,e),c.isSeparated(i))return!1}return!0}})();re.prototype.intersectsTriangle=(function(){const i=new ve,e=new Array(3),t=new Ce,r=new Ce,n=new C;return function(s){this.needsUpdate&&this.update(),s.isExtendedTriangle?s.needsUpdate&&s.update():(i.copy(s),i.update(),s=i);const o=this.satBounds,a=this.satAxes;e[0]=s.a,e[1]=s.b,e[2]=s.c;for(let u=0;u<3;u++){const h=o[u],f=a[u];if(t.setFromPoints(f,e),h.isSeparated(t))return!1}const l=s.satBounds,c=s.satAxes,d=this.points;for(let u=0;u<3;u++){const h=l[u],f=c[u];if(t.setFromPoints(f,d),h.isSeparated(t))return!1}for(let u=0;u<3;u++){const h=a[u];for(let f=0;f<4;f++){const w=c[f];if(n.crossVectors(h,w),t.setFromPoints(n,e),r.setFromPoints(n,d),t.isSeparated(r))return!1}}return!0}})();re.prototype.closestPointToPoint=(function(){return function(i,e){return this.needsUpdate&&this.update(),e.copy(i).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e}})();re.prototype.distanceToPoint=(function(){const i=new C;return function(e){return this.closestPointToPoint(e,i),e.distanceTo(i)}})();re.prototype.distanceToBox=(function(){const i=["x","y","z"],e=new Array(12).fill().map(()=>new Se),t=new Array(12).fill().map(()=>new Se),r=new C,n=new C;return function(s,o=0,a=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(s))return(a||l)&&(s.getCenter(n),this.closestPointToPoint(n,r),s.closestPointToPoint(r,n),a&&a.copy(r),l&&l.copy(n)),0;const c=o*o,d=s.min,u=s.max,h=this.points;let f=1/0;for(let g=0;g<8;g++){const m=h[g];n.copy(m).clamp(d,u);const p=m.distanceToSquared(n);if(p<f&&(f=p,a&&a.copy(m),l&&l.copy(n),p<c))return Math.sqrt(p)}let w=0;for(let g=0;g<3;g++)for(let m=0;m<=1;m++)for(let p=0;p<=1;p++){const x=(g+1)%3,v=(g+2)%3,y=m<<x|p<<v,_=1<<g|m<<x|p<<v,b=h[y],A=h[_];e[w].set(b,A);const S=i[g],E=i[x],M=i[v],R=t[w],L=R.start,P=R.end;L[S]=d[S],L[E]=m?d[E]:u[E],L[M]=p?d[M]:u[E],P[S]=u[S],P[E]=m?d[E]:u[E],P[M]=p?d[M]:u[E],w++}for(let g=0;g<=1;g++)for(let m=0;m<=1;m++)for(let p=0;p<=1;p++){n.x=g?u.x:d.x,n.y=m?u.y:d.y,n.z=p?u.z:d.z,this.closestPointToPoint(n,r);const x=n.distanceToSquared(r);if(x<f&&(f=x,a&&a.copy(r),l&&l.copy(n),x<c))return Math.sqrt(x)}for(let g=0;g<12;g++){const m=e[g];for(let p=0;p<12;p++){const x=t[p];Fn(m,x,r,n);const v=r.distanceToSquared(n);if(v<f&&(f=v,a&&a.copy(r),l&&l.copy(n),v<c))return Math.sqrt(v)}}return Math.sqrt(f)}})();class jn{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class Ki extends jn{constructor(){super(()=>new ve)}}const me=new Ki;class Wi{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=r=>{t&&e.push(t),t=r,this.float32Array=new Float32Array(r),this.uint16Array=new Uint16Array(r),this.uint32Array=new Uint32Array(r)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const H=new Wi;let Ne,nt;const qe=[],Pt=new jn(()=>new $);function $i(i,e,t,r,n,s){Ne=Pt.getPrimitive(),nt=Pt.getPrimitive(),qe.push(Ne,nt),H.setBuffer(i._roots[e]);const o=Mn(0,i.geometry,t,r,n,s);H.clearBuffer(),Pt.releasePrimitive(Ne),Pt.releasePrimitive(nt),qe.pop(),qe.pop();const a=qe.length;return a>0&&(nt=qe[a-1],Ne=qe[a-2]),o}function Mn(i,e,t,r,n=null,s=0,o=0){const{float32Array:a,uint16Array:l,uint32Array:c}=H;let d=i*2;if(oe(d,l)){const u=ie(i,c),h=he(d,l);return V(i,a,Ne),r(u,h,!1,o,s+i,Ne)}else{let u=function(R){const{uint16Array:L,uint32Array:P}=H;let B=R*2;for(;!oe(B,L);)R=fe(R),B=R*2;return ie(R,P)},h=function(R){const{uint16Array:L,uint32Array:P}=H;let B=R*2;for(;!oe(B,L);)R=pe(R,P),B=R*2;return ie(R,P)+he(B,L)};const f=fe(i),w=pe(i,c);let g=f,m=w,p,x,v,y;if(n&&(v=Ne,y=nt,V(g,a,v),V(m,a,y),p=n(v),x=n(y),x<p)){g=w,m=f;const R=p;p=x,x=R,v=y}v||(v=Ne,V(g,a,v));const _=oe(g*2,l),b=t(v,_,p,o+1,s+g);let A;if(b===dr){const R=u(g),L=h(g)-R;A=r(R,L,!0,o+1,s+g,v)}else A=b&&Mn(g,e,t,r,n,s,o+1);if(A)return!0;y=nt,V(m,a,y);const S=oe(m*2,l),E=t(y,S,x,o+1,s+m);let M;if(E===dr){const R=u(m),L=h(m)-R;M=r(R,L,!0,o+1,s+m,y)}else M=E&&Mn(m,e,t,r,n,s,o+1);return!!M}}const dt=new C,ln=new C;function Yi(i,e,t={},r=0,n=1/0){const s=r*r,o=n*n;let a=1/0,l=null;if(i.shapecast({boundsTraverseOrder:d=>(dt.copy(e).clamp(d.min,d.max),dt.distanceToSquared(e)),intersectsBounds:(d,u,h)=>h<a&&h<o,intersectsTriangle:(d,u)=>{d.closestPointToPoint(e,dt);const h=e.distanceToSquared(dt);return h<a&&(ln.copy(dt),a=h,l=u),h<s}}),a===1/0)return null;const c=Math.sqrt(a);return t.point?t.point.copy(ln):t.point=ln.clone(),t.distance=c,t.faceIndex=l,t}const Ke=new C,We=new C,$e=new C,It=new k,Bt=new k,Nt=new k,gr=new C,xr=new C,vr=new C,Ot=new C;function Zi(i,e,t,r,n,s){let o;return s===Pr?o=i.intersectTriangle(r,t,e,!0,n):o=i.intersectTriangle(e,t,r,s!==Ur,n),o===null?null:{distance:i.origin.distanceTo(n),point:n.clone()}}function Ji(i,e,t,r,n,s,o,a,l){Ke.fromBufferAttribute(e,s),We.fromBufferAttribute(e,o),$e.fromBufferAttribute(e,a);const c=Zi(i,Ke,We,$e,Ot,l);if(c){r&&(It.fromBufferAttribute(r,s),Bt.fromBufferAttribute(r,o),Nt.fromBufferAttribute(r,a),c.uv=gt.getInterpolation(Ot,Ke,We,$e,It,Bt,Nt,new k)),n&&(It.fromBufferAttribute(n,s),Bt.fromBufferAttribute(n,o),Nt.fromBufferAttribute(n,a),c.uv1=gt.getInterpolation(Ot,Ke,We,$e,It,Bt,Nt,new k)),t&&(gr.fromBufferAttribute(t,s),xr.fromBufferAttribute(t,o),vr.fromBufferAttribute(t,a),c.normal=gt.getInterpolation(Ot,Ke,We,$e,gr,xr,vr,new C),c.normal.dot(i.direction)>0&&c.normal.multiplyScalar(-1));const d={a:s,b:o,c:a,normal:new C,materialIndex:0};gt.getNormal(Ke,We,$e,d.normal),c.face=d,c.faceIndex=s}return c}function Wt(i,e,t,r,n){const s=r*3;let o=s+0,a=s+1,l=s+2;const c=i.index;i.index&&(o=c.getX(o),a=c.getX(a),l=c.getX(l));const{position:d,normal:u,uv:h,uv1:f}=i.attributes,w=Ji(t,d,u,h,f,o,a,l,e);return w?(w.faceIndex=r,n&&n.push(w),w):null}function W(i,e,t,r){const n=i.a,s=i.b,o=i.c;let a=e,l=e+1,c=e+2;t&&(a=t.getX(a),l=t.getX(l),c=t.getX(c)),n.x=r.getX(a),n.y=r.getY(a),n.z=r.getZ(a),s.x=r.getX(l),s.y=r.getY(l),s.z=r.getZ(l),o.x=r.getX(c),o.y=r.getY(c),o.z=r.getZ(c)}function Qi(i,e,t,r,n,s){const{geometry:o,_indirectBuffer:a}=i;for(let l=r,c=r+n;l<c;l++)Wt(o,e,t,l,s)}function ea(i,e,t,r,n){const{geometry:s,_indirectBuffer:o}=i;let a=1/0,l=null;for(let c=r,d=r+n;c<d;c++){let u;u=Wt(s,e,t,c),u&&u.distance<a&&(l=u,a=u.distance)}return l}function ta(i,e,t,r,n,s,o){const{geometry:a}=t,{index:l}=a,c=a.attributes.position;for(let d=i,u=e+i;d<u;d++){let h;if(h=d,W(o,h*3,l,c),o.needsUpdate=!0,r(o,h,n,s))return!0}return!1}function na(i,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=i.geometry,r=t.index?t.index.array:null,n=t.attributes.position;let s,o,a,l,c=0;const d=i._roots;for(let h=0,f=d.length;h<f;h++)s=d[h],o=new Uint32Array(s),a=new Uint16Array(s),l=new Float32Array(s),u(0,c),c+=s.byteLength;function u(h,f,w=!1){const g=h*2;if(a[g+15]===Kt){const m=o[h+6],p=a[g+14];let x=1/0,v=1/0,y=1/0,_=-1/0,b=-1/0,A=-1/0;for(let S=3*m,E=3*(m+p);S<E;S++){let M=r[S];const R=n.getX(M),L=n.getY(M),P=n.getZ(M);R<x&&(x=R),R>_&&(_=R),L<v&&(v=L),L>b&&(b=L),P<y&&(y=P),P>A&&(A=P)}return l[h+0]!==x||l[h+1]!==v||l[h+2]!==y||l[h+3]!==_||l[h+4]!==b||l[h+5]!==A?(l[h+0]=x,l[h+1]=v,l[h+2]=y,l[h+3]=_,l[h+4]=b,l[h+5]=A,!0):!1}else{const m=h+8,p=o[h+6],x=m+f,v=p+f;let y=w,_=!1,b=!1;e?y||(_=e.has(x),b=e.has(v),y=!_&&!b):(_=!0,b=!0);const A=y||_,S=y||b;let E=!1;A&&(E=u(m,f,y));let M=!1;S&&(M=u(p,f,y));const R=E||M;if(R)for(let L=0;L<3;L++){const P=m+L,B=p+L,D=l[P],j=l[P+3],Z=l[B],Q=l[B+3];l[h+L]=D<Z?D:Z,l[h+L+3]=j>Q?j:Q}return R}}}const yr=new $;function Ue(i,e,t,r){return V(i,e,yr),t.intersectBox(yr,r)}function ra(i,e,t,r,n,s){const{geometry:o,_indirectBuffer:a}=i;for(let l=r,c=r+n;l<c;l++){let d=a?a[l]:l;Wt(o,e,t,d,s)}}function sa(i,e,t,r,n){const{geometry:s,_indirectBuffer:o}=i;let a=1/0,l=null;for(let c=r,d=r+n;c<d;c++){let u;u=Wt(s,e,t,o?o[c]:c),u&&u.distance<a&&(l=u,a=u.distance)}return l}function oa(i,e,t,r,n,s,o){const{geometry:a}=t,{index:l}=a,c=a.attributes.position;for(let d=i,u=e+i;d<u;d++){let h;if(h=t.resolveTriangleIndex(d),W(o,h*3,l,c),o.needsUpdate=!0,r(o,h,n,s))return!0}return!1}const wr=new C;function ia(i,e,t,r,n){H.setBuffer(i._roots[e]),Cn(0,i,t,r,n),H.clearBuffer()}function Cn(i,e,t,r,n){const{float32Array:s,uint16Array:o,uint32Array:a}=H,l=i*2;if(oe(l,o)){const c=ie(i,a),d=he(l,o);Qi(e,t,r,c,d,n)}else{const c=fe(i);Ue(c,s,r,wr)&&Cn(c,e,t,r,n);const d=pe(i,a);Ue(d,s,r,wr)&&Cn(d,e,t,r,n)}}const Ar=new C,aa=["x","y","z"];function la(i,e,t,r){H.setBuffer(i._roots[e]);const n=Ln(0,i,t,r);return H.clearBuffer(),n}function Ln(i,e,t,r){const{float32Array:n,uint16Array:s,uint32Array:o}=H;let a=i*2;if(oe(a,s)){const l=ie(i,o),c=he(a,s);return ea(e,t,r,l,c)}else{const l=is(i,o),c=aa[l],d=r.direction[c]>=0;let u,h;d?(u=fe(i),h=pe(i,o)):(u=pe(i,o),h=fe(i));const f=Ue(u,n,r,Ar)?Ln(u,e,t,r):null;if(f){const g=f.point[c];if(d?g<=n[h+l]:g>=n[h+l+3])return f}const w=Ue(h,n,r,Ar)?Ln(h,e,t,r):null;return f&&w?f.distance<=w.distance?f:w:f||w||null}}const zt=new $,Ye=new ve,Ze=new ve,ht=new J,_r=new re,Ut=new re;function ca(i,e,t,r){H.setBuffer(i._roots[e]);const n=Rn(0,i,t,r);return H.clearBuffer(),n}function Rn(i,e,t,r,n=null){const{float32Array:s,uint16Array:o,uint32Array:a}=H;let l=i*2;if(n===null&&(t.boundingBox||t.computeBoundingBox(),_r.set(t.boundingBox.min,t.boundingBox.max,r),n=_r),oe(l,o)){const c=e.geometry,d=c.index,u=c.attributes.position,h=t.index,f=t.attributes.position,w=ie(i,a),g=he(l,o);if(ht.copy(r).invert(),t.boundsTree)return V(i,s,Ut),Ut.matrix.copy(ht),Ut.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:m=>Ut.intersectsBox(m),intersectsTriangle:m=>{m.a.applyMatrix4(r),m.b.applyMatrix4(r),m.c.applyMatrix4(r),m.needsUpdate=!0;for(let p=w*3,x=(g+w)*3;p<x;p+=3)if(W(Ze,p,d,u),Ze.needsUpdate=!0,m.intersectsTriangle(Ze))return!0;return!1}});for(let m=w*3,p=(g+w)*3;m<p;m+=3){W(Ye,m,d,u),Ye.a.applyMatrix4(ht),Ye.b.applyMatrix4(ht),Ye.c.applyMatrix4(ht),Ye.needsUpdate=!0;for(let x=0,v=h.count;x<v;x+=3)if(W(Ze,x,h,f),Ze.needsUpdate=!0,Ye.intersectsTriangle(Ze))return!0}}else{const c=i+8,d=a[i+6];return V(c,s,zt),!!(n.intersectsBox(zt)&&Rn(c,e,t,r,n)||(V(d,s,zt),n.intersectsBox(zt)&&Rn(d,e,t,r,n)))}}const Dt=new J,cn=new re,ft=new re,ua=new C,da=new C,ha=new C,fa=new C;function pa(i,e,t,r={},n={},s=0,o=1/0){e.boundingBox||e.computeBoundingBox(),cn.set(e.boundingBox.min,e.boundingBox.max,t),cn.needsUpdate=!0;const a=i.geometry,l=a.attributes.position,c=a.index,d=e.attributes.position,u=e.index,h=me.getPrimitive(),f=me.getPrimitive();let w=ua,g=da,m=null,p=null;n&&(m=ha,p=fa);let x=1/0,v=null,y=null;return Dt.copy(t).invert(),ft.matrix.copy(Dt),i.shapecast({boundsTraverseOrder:_=>cn.distanceToBox(_),intersectsBounds:(_,b,A)=>A<x&&A<o?(b&&(ft.min.copy(_.min),ft.max.copy(_.max),ft.needsUpdate=!0),!0):!1,intersectsRange:(_,b)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:A=>ft.distanceToBox(A),intersectsBounds:(A,S,E)=>E<x&&E<o,intersectsRange:(A,S)=>{for(let E=A,M=A+S;E<M;E++){W(f,3*E,u,d),f.a.applyMatrix4(t),f.b.applyMatrix4(t),f.c.applyMatrix4(t),f.needsUpdate=!0;for(let R=_,L=_+b;R<L;R++){W(h,3*R,c,l),h.needsUpdate=!0;const P=h.distanceToTriangle(f,w,m);if(P<x&&(g.copy(w),p&&p.copy(m),x=P,v=R,y=E),P<s)return!0}}}});{const A=at(e);for(let S=0,E=A;S<E;S++){W(f,3*S,u,d),f.a.applyMatrix4(t),f.b.applyMatrix4(t),f.c.applyMatrix4(t),f.needsUpdate=!0;for(let M=_,R=_+b;M<R;M++){W(h,3*M,c,l),h.needsUpdate=!0;const L=h.distanceToTriangle(f,w,m);if(L<x&&(g.copy(w),p&&p.copy(m),x=L,v=M,y=S),L<s)return!0}}}}}),me.releasePrimitive(h),me.releasePrimitive(f),x===1/0?null:(r.point?r.point.copy(g):r.point=g.clone(),r.distance=x,r.faceIndex=v,n&&(n.point?n.point.copy(p):n.point=p.clone(),n.point.applyMatrix4(Dt),g.applyMatrix4(Dt),n.distance=g.sub(n.point).length(),n.faceIndex=y),r)}function ma(i,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=i.geometry,r=t.index?t.index.array:null,n=t.attributes.position;let s,o,a,l,c=0;const d=i._roots;for(let h=0,f=d.length;h<f;h++)s=d[h],o=new Uint32Array(s),a=new Uint16Array(s),l=new Float32Array(s),u(0,c),c+=s.byteLength;function u(h,f,w=!1){const g=h*2;if(a[g+15]===Kt){const m=o[h+6],p=a[g+14];let x=1/0,v=1/0,y=1/0,_=-1/0,b=-1/0,A=-1/0;for(let S=m,E=m+p;S<E;S++){const M=3*i.resolveTriangleIndex(S);for(let R=0;R<3;R++){let L=M+R;L=r?r[L]:L;const P=n.getX(L),B=n.getY(L),D=n.getZ(L);P<x&&(x=P),P>_&&(_=P),B<v&&(v=B),B>b&&(b=B),D<y&&(y=D),D>A&&(A=D)}}return l[h+0]!==x||l[h+1]!==v||l[h+2]!==y||l[h+3]!==_||l[h+4]!==b||l[h+5]!==A?(l[h+0]=x,l[h+1]=v,l[h+2]=y,l[h+3]=_,l[h+4]=b,l[h+5]=A,!0):!1}else{const m=h+8,p=o[h+6],x=m+f,v=p+f;let y=w,_=!1,b=!1;e?y||(_=e.has(x),b=e.has(v),y=!_&&!b):(_=!0,b=!0);const A=y||_,S=y||b;let E=!1;A&&(E=u(m,f,y));let M=!1;S&&(M=u(p,f,y));const R=E||M;if(R)for(let L=0;L<3;L++){const P=m+L,B=p+L,D=l[P],j=l[P+3],Z=l[B],Q=l[B+3];l[h+L]=D<Z?D:Z,l[h+L+3]=j>Q?j:Q}return R}}}const br=new C;function ga(i,e,t,r,n){H.setBuffer(i._roots[e]),Pn(0,i,t,r,n),H.clearBuffer()}function Pn(i,e,t,r,n){const{float32Array:s,uint16Array:o,uint32Array:a}=H,l=i*2;if(oe(l,o)){const c=ie(i,a),d=he(l,o);ra(e,t,r,c,d,n)}else{const c=fe(i);Ue(c,s,r,br)&&Pn(c,e,t,r,n);const d=pe(i,a);Ue(d,s,r,br)&&Pn(d,e,t,r,n)}}const Sr=new C,xa=["x","y","z"];function va(i,e,t,r){H.setBuffer(i._roots[e]);const n=In(0,i,t,r);return H.clearBuffer(),n}function In(i,e,t,r){const{float32Array:n,uint16Array:s,uint32Array:o}=H;let a=i*2;if(oe(a,s)){const l=ie(i,o),c=he(a,s);return sa(e,t,r,l,c)}else{const l=is(i,o),c=xa[l],d=r.direction[c]>=0;let u,h;d?(u=fe(i),h=pe(i,o)):(u=pe(i,o),h=fe(i));const f=Ue(u,n,r,Sr)?In(u,e,t,r):null;if(f){const g=f.point[c];if(d?g<=n[h+l]:g>=n[h+l+3])return f}const w=Ue(h,n,r,Sr)?In(h,e,t,r):null;return f&&w?f.distance<=w.distance?f:w:f||w||null}}const Ft=new $,Je=new ve,Qe=new ve,pt=new J,Tr=new re,jt=new re;function ya(i,e,t,r){H.setBuffer(i._roots[e]);const n=Bn(0,i,t,r);return H.clearBuffer(),n}function Bn(i,e,t,r,n=null){const{float32Array:s,uint16Array:o,uint32Array:a}=H;let l=i*2;if(n===null&&(t.boundingBox||t.computeBoundingBox(),Tr.set(t.boundingBox.min,t.boundingBox.max,r),n=Tr),oe(l,o)){const c=e.geometry,d=c.index,u=c.attributes.position,h=t.index,f=t.attributes.position,w=ie(i,a),g=he(l,o);if(pt.copy(r).invert(),t.boundsTree)return V(i,s,jt),jt.matrix.copy(pt),jt.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:m=>jt.intersectsBox(m),intersectsTriangle:m=>{m.a.applyMatrix4(r),m.b.applyMatrix4(r),m.c.applyMatrix4(r),m.needsUpdate=!0;for(let p=w,x=g+w;p<x;p++)if(W(Qe,3*e.resolveTriangleIndex(p),d,u),Qe.needsUpdate=!0,m.intersectsTriangle(Qe))return!0;return!1}});for(let m=w,p=g+w;m<p;m++){const x=e.resolveTriangleIndex(m);W(Je,3*x,d,u),Je.a.applyMatrix4(pt),Je.b.applyMatrix4(pt),Je.c.applyMatrix4(pt),Je.needsUpdate=!0;for(let v=0,y=h.count;v<y;v+=3)if(W(Qe,v,h,f),Qe.needsUpdate=!0,Je.intersectsTriangle(Qe))return!0}}else{const c=i+8,d=a[i+6];return V(c,s,Ft),!!(n.intersectsBox(Ft)&&Bn(c,e,t,r,n)||(V(d,s,Ft),n.intersectsBox(Ft)&&Bn(d,e,t,r,n)))}}const Ht=new J,un=new re,mt=new re,wa=new C,Aa=new C,_a=new C,ba=new C;function Sa(i,e,t,r={},n={},s=0,o=1/0){e.boundingBox||e.computeBoundingBox(),un.set(e.boundingBox.min,e.boundingBox.max,t),un.needsUpdate=!0;const a=i.geometry,l=a.attributes.position,c=a.index,d=e.attributes.position,u=e.index,h=me.getPrimitive(),f=me.getPrimitive();let w=wa,g=Aa,m=null,p=null;n&&(m=_a,p=ba);let x=1/0,v=null,y=null;return Ht.copy(t).invert(),mt.matrix.copy(Ht),i.shapecast({boundsTraverseOrder:_=>un.distanceToBox(_),intersectsBounds:(_,b,A)=>A<x&&A<o?(b&&(mt.min.copy(_.min),mt.max.copy(_.max),mt.needsUpdate=!0),!0):!1,intersectsRange:(_,b)=>{if(e.boundsTree){const A=e.boundsTree;return A.shapecast({boundsTraverseOrder:S=>mt.distanceToBox(S),intersectsBounds:(S,E,M)=>M<x&&M<o,intersectsRange:(S,E)=>{for(let M=S,R=S+E;M<R;M++){const L=A.resolveTriangleIndex(M);W(f,3*L,u,d),f.a.applyMatrix4(t),f.b.applyMatrix4(t),f.c.applyMatrix4(t),f.needsUpdate=!0;for(let P=_,B=_+b;P<B;P++){const D=i.resolveTriangleIndex(P);W(h,3*D,c,l),h.needsUpdate=!0;const j=h.distanceToTriangle(f,w,m);if(j<x&&(g.copy(w),p&&p.copy(m),x=j,v=P,y=M),j<s)return!0}}}})}else{const A=at(e);for(let S=0,E=A;S<E;S++){W(f,3*S,u,d),f.a.applyMatrix4(t),f.b.applyMatrix4(t),f.c.applyMatrix4(t),f.needsUpdate=!0;for(let M=_,R=_+b;M<R;M++){const L=i.resolveTriangleIndex(M);W(h,3*L,c,l),h.needsUpdate=!0;const P=h.distanceToTriangle(f,w,m);if(P<x&&(g.copy(w),p&&p.copy(m),x=P,v=M,y=S),P<s)return!0}}}}}),me.releasePrimitive(h),me.releasePrimitive(f),x===1/0?null:(r.point?r.point.copy(g):r.point=g.clone(),r.distance=x,r.faceIndex=v,n&&(n.point?n.point.copy(p):n.point=p.clone(),n.point.applyMatrix4(Ht),g.applyMatrix4(Ht),n.distance=g.sub(n.point).length(),n.faceIndex=y),r)}function Ta(){return typeof SharedArrayBuffer<"u"}const wt=new H.constructor,qt=new H.constructor,Be=new jn(()=>new $),et=new $,tt=new $,dn=new $,hn=new $;let fn=!1;function Ea(i,e,t,r){if(fn)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");fn=!0;const n=i._roots,s=e._roots;let o,a=0,l=0;const c=new J().copy(t).invert();for(let d=0,u=n.length;d<u;d++){wt.setBuffer(n[d]),l=0;const h=Be.getPrimitive();V(0,wt.float32Array,h),h.applyMatrix4(c);for(let f=0,w=s.length;f<w&&(qt.setBuffer(s[d]),o=xe(0,0,t,c,r,a,l,0,0,h),qt.clearBuffer(),l+=s[f].length,!o);f++);if(Be.releasePrimitive(h),wt.clearBuffer(),a+=n[d].length,o)break}return fn=!1,o}function xe(i,e,t,r,n,s=0,o=0,a=0,l=0,c=null,d=!1){let u,h;d?(u=qt,h=wt):(u=wt,h=qt);const f=u.float32Array,w=u.uint32Array,g=u.uint16Array,m=h.float32Array,p=h.uint32Array,x=h.uint16Array,v=i*2,y=e*2,_=oe(v,g),b=oe(y,x);let A=!1;if(b&&_)d?A=n(ie(e,p),he(e*2,x),ie(i,w),he(i*2,g),l,o+e,a,s+i):A=n(ie(i,w),he(i*2,g),ie(e,p),he(e*2,x),a,s+i,l,o+e);else if(b){const S=Be.getPrimitive();V(e,m,S),S.applyMatrix4(t);const E=fe(i),M=pe(i,w);V(E,f,et),V(M,f,tt);const R=S.intersectsBox(et),L=S.intersectsBox(tt);A=R&&xe(e,E,r,t,n,o,s,l,a+1,S,!d)||L&&xe(e,M,r,t,n,o,s,l,a+1,S,!d),Be.releasePrimitive(S)}else{const S=fe(e),E=pe(e,p);V(S,m,dn),V(E,m,hn);const M=c.intersectsBox(dn),R=c.intersectsBox(hn);if(M&&R)A=xe(i,S,t,r,n,s,o,a,l+1,c,d)||xe(i,E,t,r,n,s,o,a,l+1,c,d);else if(M)if(_)A=xe(i,S,t,r,n,s,o,a,l+1,c,d);else{const L=Be.getPrimitive();L.copy(dn).applyMatrix4(t);const P=fe(i),B=pe(i,w);V(P,f,et),V(B,f,tt);const D=L.intersectsBox(et),j=L.intersectsBox(tt);A=D&&xe(S,P,r,t,n,o,s,l,a+1,L,!d)||j&&xe(S,B,r,t,n,o,s,l,a+1,L,!d),Be.releasePrimitive(L)}else if(R)if(_)A=xe(i,E,t,r,n,s,o,a,l+1,c,d);else{const L=Be.getPrimitive();L.copy(hn).applyMatrix4(t);const P=fe(i),B=pe(i,w);V(P,f,et),V(B,f,tt);const D=L.intersectsBox(et),j=L.intersectsBox(tt);A=D&&xe(E,P,r,t,n,o,s,l,a+1,L,!d)||j&&xe(E,B,r,t,n,o,s,l,a+1,L,!d),Be.releasePrimitive(L)}}return A}const kt=new re,Er=new $,Ma={strategy:ns,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0};class Hn{static serialize(e,t={}){t={cloneBuffers:!0,...t};const r=e.geometry,n=e._roots,s=e._indirectBuffer,o=r.getIndex();let a;return t.cloneBuffers?a={roots:n.map(l=>l.slice()),index:o.array.slice(),indirectBuffer:s?s.slice():null}:a={roots:n,index:o.array,indirectBuffer:s},a}static deserialize(e,t,r={}){r={setIndex:!0,indirect:!!e.indirectBuffer,...r};const{index:n,roots:s,indirectBuffer:o}=e,a=new Hn(t,{...r,[rn]:!0});if(a._roots=s,a._indirectBuffer=o||null,r.setIndex){const l=t.getIndex();if(l===null){const c=new vt(e.index,1,!1);t.setIndex(c)}else l.array!==n&&(l.array.set(n),l.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t=Object.assign({...Ma,[rn]:!1},t),t.useSharedArrayBuffer&&!Ta())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[rn]||(Gi(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new $)));const{_indirectBuffer:r}=this;this.resolveTriangleIndex=t.indirect?n=>r[n]:n=>n}refit(e=null){return(this.indirect?ma:na)(this,e)}traverse(e,t=0){const r=this._roots[t],n=new Uint32Array(r),s=new Uint16Array(r);o(0);function o(a,l=0){const c=a*2,d=s[c+15]===Kt;if(d){const u=n[a+6],h=s[c+14];e(l,d,new Float32Array(r,a*4,6),u,h)}else{const u=a+yt/4,h=n[a+6],f=n[a+7];e(l,d,new Float32Array(r,a*4,6),f)||(o(u,l+1),o(h,l+1))}}}raycast(e,t=st){const r=this._roots,n=this.geometry,s=[],o=t.isMaterial,a=Array.isArray(t),l=n.groups,c=o?t.side:t,d=this.indirect?ga:ia;for(let u=0,h=r.length;u<h;u++){const f=a?t[l[u].materialIndex].side:c,w=s.length;if(d(this,u,f,e,s),a){const g=l[u].materialIndex;for(let m=w,p=s.length;m<p;m++)s[m].face.materialIndex=g}}return s}raycastFirst(e,t=st){const r=this._roots,n=this.geometry,s=t.isMaterial,o=Array.isArray(t);let a=null;const l=n.groups,c=s?t.side:t,d=this.indirect?va:la;for(let u=0,h=r.length;u<h;u++){const f=o?t[l[u].materialIndex].side:c,w=d(this,u,f,e);w!=null&&(a==null||w.distance<a.distance)&&(a=w,o&&(w.face.materialIndex=l[u].materialIndex))}return a}intersectsGeometry(e,t){let r=!1;const n=this._roots,s=this.indirect?ya:ca;for(let o=0,a=n.length;o<a&&(r=s(this,o,e,t),!r);o++);return r}shapecast(e){const t=me.getPrimitive(),r=this.indirect?oa:ta;let{boundsTraverseOrder:n,intersectsBounds:s,intersectsRange:o,intersectsTriangle:a}=e;if(o&&a){const u=o;o=(h,f,w,g,m)=>u(h,f,w,g,m)?!0:r(h,f,this,a,w,g,t)}else o||(a?o=(u,h,f,w)=>r(u,h,this,a,f,w,t):o=(u,h,f)=>f);let l=!1,c=0;const d=this._roots;for(let u=0,h=d.length;u<h;u++){const f=d[u];if(l=$i(this,u,s,o,n,c),l)break;c+=f.byteLength}return me.releasePrimitive(t),l}bvhcast(e,t,r){let{intersectsRanges:n,intersectsTriangles:s}=r;const o=me.getPrimitive(),a=this.geometry.index,l=this.geometry.attributes.position,c=this.indirect?w=>{const g=this.resolveTriangleIndex(w);W(o,g*3,a,l)}:w=>{W(o,w*3,a,l)},d=me.getPrimitive(),u=e.geometry.index,h=e.geometry.attributes.position,f=e.indirect?w=>{const g=e.resolveTriangleIndex(w);W(d,g*3,u,h)}:w=>{W(d,w*3,u,h)};if(s){const w=(g,m,p,x,v,y,_,b)=>{for(let A=p,S=p+x;A<S;A++){f(A),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let E=g,M=g+m;E<M;E++)if(c(E),o.needsUpdate=!0,s(o,d,E,A,v,y,_,b))return!0}return!1};if(n){const g=n;n=function(m,p,x,v,y,_,b,A){return g(m,p,x,v,y,_,b,A)?!0:w(m,p,x,v,y,_,b,A)}}else n=w}return Ea(this,e,t,n)}intersectsBox(e,t){return kt.set(e.min,e.max,t),kt.needsUpdate=!0,this.shapecast({intersectsBounds:r=>kt.intersectsBox(r),intersectsTriangle:r=>kt.intersectsTriangle(r)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,r={},n={},s=0,o=1/0){return(this.indirect?Sa:pa)(this,e,t,r,n,s,o)}closestPointToPoint(e,t={},r=0,n=1/0){return Yi(this,e,t,r,n)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(t=>{V(0,new Float32Array(t),Er),e.union(Er)}),e}}function Mr(i,e,t){return i===null||(i.point.applyMatrix4(e.matrixWorld),i.distance=i.point.distanceTo(t.ray.origin),i.object=e,i.distance<t.near||i.distance>t.far)?null:i}const pn=new ps,Cr=new J,Ca=Oe.prototype.raycast;function La(i,e){if(this.geometry.boundsTree){if(this.material===void 0)return;Cr.copy(this.matrixWorld).invert(),pn.copy(i.ray).applyMatrix4(Cr);const t=this.geometry.boundsTree;if(i.firstHitOnly===!0){const r=Mr(t.raycastFirst(pn,this.material),this,i);r&&e.push(r)}else{const r=t.raycast(pn,this.material);for(let n=0,s=r.length;n<s;n++){const o=Mr(r[n],this,i);o&&e.push(o)}}}else Ca.call(this,i,e)}function Ra(i){return this.boundsTree=new Hn(this,i),this.boundsTree}function Pa(){this.boundsTree=null}const Lr=i=>i.isMesh,Ia=T.forwardRef(({enabled:i=!0,firstHitOnly:e=!1,children:t,strategy:r=rs,verbose:n=!1,setBoundingBox:s=!0,maxDepth:o=40,maxLeafTris:a=10,indirect:l=!1,...c},d)=>{const u=T.useRef(null),h=Me(f=>f.raycaster);return T.useImperativeHandle(d,()=>u.current,[]),T.useEffect(()=>{if(i){const f={strategy:r,verbose:n,setBoundingBox:s,maxDepth:o,maxLeafTris:a,indirect:l},w=u.current;return h.firstHitOnly=e,w.traverse(g=>{Lr(g)&&!g.geometry.boundsTree&&g.raycast===Oe.prototype.raycast&&(g.raycast=La,g.geometry.computeBoundsTree=Ra,g.geometry.disposeBoundsTree=Pa,g.geometry.computeBoundsTree(f))}),()=>{delete h.firstHitOnly,w.traverse(g=>{Lr(g)&&g.geometry.boundsTree&&(g.geometry.disposeBoundsTree(),g.raycast=Oe.prototype.raycast)})}}},[]),T.createElement("group",At({ref:u},c),t)}),Ba=T.forwardRef(function({children:i,disable:e,disableX:t,disableY:r,disableZ:n,left:s,right:o,top:a,bottom:l,front:c,back:d,onCentered:u,precise:h=!0,cacheKey:f=0,...w},g){const m=T.useRef(null),p=T.useRef(null),x=T.useRef(null);return T.useLayoutEffect(()=>{p.current.matrixWorld.identity();const v=new $().setFromObject(x.current,h),y=new C,_=new ot,b=v.max.x-v.min.x,A=v.max.y-v.min.y,S=v.max.z-v.min.z;v.getCenter(y),v.getBoundingSphere(_);const E=a?A/2:l?-A/2:0,M=s?-b/2:o?b/2:0,R=c?S/2:d?-S/2:0;p.current.position.set(e||t?0:-y.x+M,e||r?0:-y.y+E,e||n?0:-y.z+R),typeof u<"u"&&u({parent:m.current.parent,container:m.current,width:b,height:A,depth:S,boundingBox:v,boundingSphere:_,center:y,verticalAlignment:E,horizontalAlignment:M,depthAlignment:R})},[f,u,a,s,c,e,t,r,n,h,o,l,d]),T.useImperativeHandle(g,()=>m.current,[]),T.createElement("group",At({ref:m},w),T.createElement("group",{ref:p},T.createElement("group",{ref:x},i)))});function Na(){const{controllers:i}=q(),e=T.useRef(),t=T.useRef();return it(()=>{if(i&&i[0]&&i[1]){if(i[0].controller){const r=i[0].hand.joints["index-finger-tip"].position;e.current.position.copy(r)}if(i[1].controller){const r=i[1].hand.joints["index-finger-tip"].position;t.current.position.copy(r)}}}),I.jsxs(I.Fragment,{children:[I.jsxs("mesh",{name:"leftTipBbox",ref:t,children:[I.jsx("boxGeometry",{args:[.02,.02,.02]}),I.jsx("meshStandardMaterial",{color:"blue",transparent:!0,opacity:0})]}),I.jsxs("mesh",{name:"rightTipBbox",ref:e,children:[I.jsx("boxGeometry",{args:[.02,.02,.02]}),I.jsx("meshStandardMaterial",{color:"orange",transparent:!0,opacity:0})]})]})}function mn(i){const{currentLine:e,scale:t}=i,r=T.useRef();return I.jsxs("group",{children:[I.jsx(Ba,{bottom:!0,right:!0,position:[e.midPoint.x,e.midPoint.y,e.midPoint.z],rotation:[0,0,0],children:I.jsx(ts,{color:"gray",scale:.05,ref:r,children:`${(e.startPoint.distanceTo(e.endPoint)*t).toFixed(2)} µm`})}),I.jsx(Ei,{points:[e.startPoint,e.endPoint],color:"white",lineWidth:2,dashed:!1,segments:!0})]})}function Oa(i){const{segmentationGroup:e,segmentationSettings:t,segmentationSceneScale:r,renderingSettings:n,materialRef:s,highlightEntity:o,setObsHighlight:a}=i,l=T.useRef(),c=T.useRef(),d=T.useRef(),{isPresenting:u}=q();T.useEffect(()=>{u&&l?.current?s!==null&&(s.current.material.uniforms.u_physical_Pixel.value=.2):u||s!==null&&(s.current.material.uniforms.u_physical_Pixel.value=2.5)},[u]);const{scene:h}=Me(),{controllers:f}=q(),[w,g]=T.useState(!1),[m,p]=T.useState(!1),[x,v]=T.useState(!1),[y,_]=T.useState({startPoint:new C,midPoint:new C,endPoint:new C,setStartPoint:!1,setEndPoint:!1}),[b,A]=T.useState([]),[S,E]=T.useState(0);return it(()=>{if(u){const M=h.getObjectByName("rightTipBbox"),R=h.getObjectByName("leftTipBbox"),L=new $().setFromObject(R),P=new $().setFromObject(M);let B=!1;if(E(S-1),L.intersectsBox(P)&&L.max.x!==-P.min.x&&(g(!0),v(!0),_({startPoint:new C,midPoint:new C,endPoint:new C,setStartPoint:!1,setEndPoint:!1})),w){let D=f[1].hand.joints["index-finger-tip"].position.clone(),j=f[0].hand.joints["index-finger-tip"].position.clone();D=D.applyMatrix4(d.current.matrixWorld.clone().invert()),j=j.applyMatrix4(d.current.matrixWorld.clone().invert());let Z=D.clone(),Q=j.clone();y.setStartPoint&&(Z=y.startPoint),y.setEndPoint&&(Q=y.endPoint),_({startPoint:Z,midPoint:new C().addVectors(Z,Q).multiplyScalar(.5),endPoint:Q,setStartPoint:y.setStartPoint,setEndPoint:y.setEndPoint}),f[0].hand.inputState.pinching===!0&&_({startPoint:y.startPoint,midPoint:y.midPoint,endPoint:y.endPoint,setStartPoint:y.setStartPoint,setEndPoint:!0}),f[1].hand.inputState.pinching===!0&&_({startPoint:y.startPoint,midPoint:y.midPoint,endPoint:y.endPoint,setStartPoint:!0,setEndPoint:y.setEndPoint}),y.setStartPoint&&y.setEndPoint&&(b.push(y),A(b),v(!1),g(!1),E(8))}else S<=0&&l?.current&&u&&(l.current.children[0].children.forEach((D,j)=>{const Z=l.current.children[0].children[j],Q=new $().setFromObject(Z),bt=L.intersectsBox(Q),$t=P.intersectsBox(Q);(bt||$t)&&(B=!0,a(Z.name),p(!0),f[1]!==void 0&&bt&&f[1].hand.inputState.pinching===!0&&(E(10),B=!1,f[1].hand.inputState.pinching=!1),f[0]!==void 0&&$t&&f[0].hand.inputState.pinching===!0&&(E(10),B=!1,f[0].hand.inputState.pinching=!1))}),!B&&m&&(a(null),p(!1)))}},[w,m,y,b,x,S,u]),I.jsx("group",{children:q().isPresenting?I.jsxs(uo,{children:[I.jsxs("group",{ref:d,children:[e?.visible?I.jsxs("group",{children:[I.jsx("hemisphereLight",{skyColor:8421504,groundColor:6316128}),I.jsx("directionalLight",{color:16777215,position:[0,-800,0]}),I.jsx("primitive",{ref:l,object:e,position:[-.18,1.13,-1],scale:[.002*r[0],.002*r[1],.002*r[2]]})]}):null,n.uniforms&&n.shader?I.jsx("group",{children:I.jsxs("mesh",{name:"cube",position:[-.18,1.13,-1],rotation:[0,0,0],scale:[.002*n.meshScale[0],.002*n.meshScale[1],.002*n.meshScale[2]],ref:s,children:[I.jsx("boxGeometry",{args:n.geometrySize}),I.jsx("shaderMaterial",{customProgramCacheKey:()=>"1",side:st,uniforms:n.uniforms,needsUpdate:!0,transparent:!0,vertexShader:n.shader.vertexShader,fragmentShader:n.shader.fragmentShader})]})}):null]}),I.jsx("group",{name:"currentLine",ref:c,children:x?I.jsx(mn,{currentLine:y,scale:1/.002*.4}):null}),I.jsx("group",{name:"lines",children:b.map(M=>I.jsx(mn,{currentLine:M,scale:1/.002*.4}))})]}):I.jsxs("group",{children:[I.jsxs("group",{children:[e?.visible?I.jsxs("group",{children:[I.jsx("hemisphereLight",{skyColor:8421504,groundColor:6316128}),I.jsx("directionalLight",{color:16777215,position:[0,-800,0]}),I.jsx("directionalLight",{color:16777215,position:[0,800,0]}),I.jsx(Ia,{firstHitOnly:!0,children:I.jsx("primitive",{ref:l,object:e,position:[0,0,0],onClick:M=>{M.object.parent.userData.name==="finalPass"&&o(M.object.name,M.object.userData.layerScope,M.object.userData.channelScope)},onPointerOver:M=>{a(M.object.name)},onPointerOut:M=>a(null)})})]}):null,n.uniforms&&n.shader?I.jsx("group",{children:I.jsxs("mesh",{scale:n.meshScale,ref:s,children:[I.jsx("boxGeometry",{args:n.geometrySize}),I.jsx("shaderMaterial",{customProgramCacheKey:()=>"1",side:st,uniforms:n.uniforms,needsUpdate:!0,transparent:!0,vertexShader:n.shader.vertexShader,fragmentShader:n.shader.fragmentShader})]})}):null]}),I.jsx("group",{name:"lines",children:b.map(M=>I.jsx(mn,{currentLine:M,scale:1}))})]})})}function za(){const{controllers:i}=q();return it(()=>{i?.[0]&&i?.[1]&&(i[0]?.hand?.children?.[25]?.children?.[0]?.children?.[0]&&(i[0].hand.children[25].children[0].children[0].material.transparent=!0,i[0].hand.children[25].children[0].children[0].material.opacity=.5),i[1]?.hand?.children?.[25]?.children?.[0]?.children?.[0]&&(i[1].hand.children[25].children[0].children[0].material.transparent=!0,i[1].hand.children[25].children[0].children[0].material.opacity=.5))}),null}class Ua{constructor(e,t,r,n,s){if(this.spacing=[1,1,1],this.offset=[0,0,0],this.matrix=new gs,this.matrix.identity(),this.sliceList=[],this.lowerThresholdValue=-1/0,this.upperThresholdValue=1/0,arguments.length>0){switch(this.xLength=Number(e)||1,this.yLength=Number(t)||1,this.zLength=Number(r)||1,n){case"Uint8":case"uint8":case"uchar":case"unsigned char":case"uint8_t":this.data=new Uint8Array(s);break;case"Int8":case"int8":case"signed char":case"int8_t":this.data=new Int8Array(s);break;case"Int16":case"int16":case"short":case"short int":case"signed short":case"signed short int":case"int16_t":this.data=new Int16Array(s);break;case"Uint16":case"uint16":case"ushort":case"unsigned short":case"unsigned short int":case"uint16_t":this.data=new Uint16Array(s);break;case"Int32":case"int32":case"int":case"signed int":case"int32_t":this.data=new Int32Array(s);break;case"Uint32":case"uint32":case"uint":case"unsigned int":case"uint32_t":this.data=new Uint32Array(s);break;case"longlong":case"long long":case"long long int":case"signed long long":case"signed long long int":case"int64":case"int64_t":case"ulonglong":case"unsigned long long":case"unsigned long long int":case"uint64":case"uint64_t":throw new Error("uint64_t type is not supported in JavaScript");case"Float32":case"float32":case"float":this.data=new Float32Array(s);break;case"Float64":case"float64":case"double":this.data=new Float64Array(s);break;default:this.data=new Uint8Array(s)}if(this.data.length!==this.xLength*this.yLength*this.zLength)throw new Error("lengths are not matching arrayBuffer size")}}get lowerThreshold(){return this.lowerThresholdValue}set lowerThreshold(e){this.lowerThresholdValue=e,this.sliceList.forEach(t=>{t.geometryNeedsUpdate=!0})}get upperThreshold(){return this.upperThresholdValue}set upperThreshold(e){this.upperThresholdValue=e,this.sliceList.forEach(t=>{t.geometryNeedsUpdate=!0})}getData(e,t,r){return this.data[r*this.xLength*this.yLength+t*this.xLength+e]}access(e,t,r){return r*this.xLength*this.yLength+t*this.xLength+e}reverseAccess(e){const t=Math.floor(e/(this.yLength*this.xLength)),r=Math.floor((e-t*this.yLength*this.xLength)/this.xLength);return[e-t*this.yLength*this.xLength-r*this.xLength,r,t]}map(e,t){const{length:r}=this.data,n=t||this;for(let s=0;s<r;s++)this.data[s]=e.call(n,this.data[s],s,this.data);return this}extractPerpendicularPlane(e,t){const r=new J().identity(),n=this;let s,o,a,l;const c=new C,d=new C,u=new C,h=new C(this.xLength,this.yLength,this.zLength);switch(e){case"x":c.set(1,0,0),d.set(0,0,-1),u.set(0,-1,0),s=this.spacing[2],o=this.spacing[1],l=new C(t,0,0),r.multiply(new J().makeRotationY(Math.PI/2)),a=(n.RASDimensions[0]-1)/2,r.setPosition(new C(t-a,0,0));break;case"y":c.set(0,1,0),d.set(1,0,0),u.set(0,0,1),s=this.spacing[0],o=this.spacing[2],l=new C(0,t,0),r.multiply(new J().makeRotationX(-Math.PI/2)),a=(n.RASDimensions[1]-1)/2,r.setPosition(new C(0,t-a,0));break;case"z":default:c.set(0,0,1),d.set(1,0,0),u.set(0,-1,0),s=this.spacing[0],o=this.spacing[1],l=new C(0,0,t),a=(n.RASDimensions[2]-1)/2,r.setPosition(new C(0,0,t-a));break}d.applyMatrix4(n.inverseMatrix).normalize(),d.argVar="i",u.applyMatrix4(n.inverseMatrix).normalize(),u.argVar="j",c.applyMatrix4(n.inverseMatrix).normalize();const f=Math.floor(Math.abs(d.dot(h))),w=Math.floor(Math.abs(u.dot(h))),g=Math.abs(f*s),m=Math.abs(w*o);l=Math.abs(Math.round(l.applyMatrix4(n.inverseMatrix).dot(c)));const p=[new C(1,0,0),new C(0,1,0),new C(0,0,1)],x=[d,u,c].find(b=>Math.abs(b.dot(p[0]))>.9),v=[d,u,c].find(b=>Math.abs(b.dot(p[1]))>.9),y=[d,u,c].find(b=>Math.abs(b.dot(p[2]))>.9);function _(b,A){const S=x===c?l:x.arglet==="i"?b:A,E=v===c?l:v.arglet==="i"?b:A,M=y===c?l:y.arglet==="i"?b:A,R=x.dot(p[0])>0?S:n.xLength-1-S,L=v.dot(p[1])>0?E:n.yLength-1-E,P=y.dot(p[2])>0?M:n.zLength-1-M;return n.access(R,L,P)}return{iLength:f,jLength:w,sliceAccess:_,matrix:r,planeWidth:g,planeHeight:m}}computeMinMax(){let e=1/0,t=-1/0;const r=this.data.length;let n=0;for(n=0;n<r;n++)if(!Number.isNaN(this.data[n])){const s=this.data[n];e=Math.min(e,s),t=Math.max(t,s)}return this.min=e,this.max=t,[e,t]}}const Da={uniforms:{u_size:{value:new C(1,1,1)},u_renderstyle:{value:0},u_renderthreshold:{value:.5},u_opacity:{value:.5},u_clim:{value:new k(.2,.8)},u_clim2:{value:new k(.2,.8)},u_clim3:{value:new k(.2,.8)},u_clim4:{value:new k(.2,.8)},u_clim5:{value:new k(.2,.8)},u_clim6:{value:new k(.2,.8)},u_xClip:{value:new k(-1,1e6)},u_yClip:{value:new k(-1,1e6)},u_zClip:{value:new k(-1,1e6)},u_data:{value:null},u_stop_geom:{value:null},u_geo_color:{value:null},u_window_size:{value:new k(1,1)},u_vol_scale:{value:new k(1,1,1)},u_physical_Pixel:{value:.5},volumeTex:{value:null},volumeTex2:{value:null},volumeTex3:{value:null},volumeTex4:{value:null},volumeTex5:{value:null},volumeTex6:{value:null},u_color:{value:new C(0,0,0)},u_color2:{value:new C(0,0,0)},u_color3:{value:new C(0,0,0)},u_color4:{value:new C(0,0,0)},u_color5:{value:new C(0,0,0)},u_color6:{value:new C(0,0,0)},u_cmdata:{value:null},near:{value:.1},far:{value:1e4},alphaScale:{value:0},dtScale:{value:1},volumeCount:{value:0},finalGamma:{value:0},boxSize:{value:new C(1,1,1)}},vertexShader:["out vec3 rayDirUnnorm;","out vec3 cameraCorrected;","uniform vec3 u_vol_scale;","uniform vec3 u_size;","varying vec3 worldSpaceCoords;","varying vec2 vUv;","varying vec4 glPosition;","uniform highp vec3 boxSize;","void main()","{","   worldSpaceCoords = position / boxSize + vec3(0.5, 0.5, 0.5); //move it from [-0.5;0.5] to [0,1]","   cameraCorrected = (inverse(modelMatrix) * vec4(cameraPosition, 1.)).xyz;","   rayDirUnnorm = position - cameraCorrected;","   gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","   glPosition = gl_Position;","   vUv = uv;","}"].join(`
`),fragmentShader:["#include <packing>","precision highp float;"," precision mediump sampler3D;","in vec3 rayDirUnnorm;","in vec3 cameraCorrected;","uniform sampler3D volumeTex;","uniform sampler3D volumeTex2;","uniform sampler3D volumeTex3;","uniform sampler3D volumeTex4;","uniform sampler3D volumeTex5;","uniform sampler3D volumeTex6;","uniform vec2 u_clim;","uniform vec2 u_clim2;","uniform vec2 u_clim3;","uniform vec2 u_clim4;","uniform vec2 u_clim5;","uniform vec2 u_clim6;","uniform vec2 u_window_size;","uniform vec2 u_xClip;","uniform vec2 u_yClip;","uniform vec2 u_zClip;","uniform sampler2D u_cmdata;","uniform sampler2D u_stop_geom;","uniform sampler2D u_geo_color;","uniform vec3 u_color;","uniform vec3 u_color2;","uniform vec3 u_color3;","uniform vec3 u_color4;","uniform vec3 u_color5;","uniform vec3 u_color6;","uniform float alphaScale;","uniform float dtScale;","uniform float finalGamma;","uniform float volumeCount;","uniform highp vec3 boxSize;","uniform vec3 u_size;","uniform int u_renderstyle;","uniform float u_opacity;","uniform vec3 u_vol_scale;","uniform float near;","uniform float u_physical_Pixel;","varying vec2 vUv;","varying vec4 glPosition;","uniform float far;","varying vec3 worldSpaceCoords;","float linearize_z(float z) {","        return near * far / (far + z * (near - far));","}","vec2 intersect_hit(vec3 orig, vec3 dir) {","  vec3 boxMin = vec3(-0.5) * boxSize;","  vec3 boxMax = vec3( 0.5) * boxSize;","  if(u_xClip.x > -1.0){   boxMin.x = u_xClip.x-(boxSize.x/2.0);","   if(u_xClip.y < boxSize.x)","       boxMax.x = u_xClip.y-(boxSize.x/2.0);","  }","  if(u_yClip.x > -1.0){   boxMin.y = u_yClip.x-(boxSize.y/2.0);","   if(u_yClip.y < boxSize.y)","      boxMax.y = u_yClip.y-(boxSize.y/2.0);","  }","  if(u_zClip.x > -1.0){   boxMin.z = u_zClip.x-(boxSize.z/2.0);","   if(u_zClip.y < boxSize.z)       boxMax.z = u_zClip.y-(boxSize.z/2.0);","  }","  vec3 invDir = 1.0 / dir;","  vec3 tmin0 = (boxMin - orig) * invDir;","  vec3 tmax0 = (boxMax - orig) * invDir;","  vec3 tmin = min(tmin0, tmax0);","  vec3 tmax = max(tmin0, tmax0);","  float t0 = max(tmin.x, max(tmin.y, tmin.z));","  float t1 = min(tmax.x, min(tmax.y, tmax.z));","  return vec2(t0, t1);","}","   // Pseudo-random number gen from","   // http://www.reedbeta.com/blog/quick-and-easy-gpu-random-numbers-in-d3d11/","   // with some tweaks for the range of values","       float wang_hash(int seed) {","     seed = (seed ^ 61) ^ (seed >> 16);","     seed *= 9;","     seed = seed ^ (seed >> 4);","     seed *= 0x27d4eb2d;","     seed = seed ^ (seed >> 15);","     return float(seed % 2147483647) / float(2147483647);","     }","float linear_to_srgb(float x) {","   if (x <= 0.0031308f) {","     return 12.92f * x;","   }","   return 1.055f * pow(x, 1.f / 2.4f) - 0.055f;","}","void main(void) {","  //STEP 1: Normalize the view Ray","  vec3 rayDir = normalize(rayDirUnnorm);","  //STEP 2: Intersect the ray with the volume bounds to find the interval along the ray overlapped by the volume","  vec2 t_hit = intersect_hit(cameraCorrected, rayDir);","  if (t_hit.x >= t_hit.y) {","    discard;","  }","  //No sample behind the eye","  t_hit.x = max(t_hit.x, 0.0);","  //STEP 3: Compute the step size to march through the volume grid","  ivec3 volumeTexSize = textureSize(volumeTex, 0);","  vec3 dt_vec = 1.0 / (vec3(volumeTexSize) * abs(rayDir));","  float dt = min(dt_vec.x, min(dt_vec.y, dt_vec.z));","  dt = max(1.0, dt);","  // Ray starting point, in the real space where the box may not be a cube.","  // Prevents a lost WebGL context."," float offset = wang_hash(int(gl_FragCoord.x + 640.0 * gl_FragCoord.y));"," vec3 p = cameraCorrected + (t_hit.x + offset + dt) * rayDir;","  // Most browsers do not need this initialization, but add it to be safe.","  gl_FragColor = vec4(0.0);","  p = p / boxSize + vec3(0.5);","  vec3 step = (rayDir * dt) / boxSize;","  // ","  // Initialization of some variables.","  float max_val = 0.0;","  float max_val2 = 0.0;","  float max_val3 = 0.0;","  float max_val4 = 0.0;","  float max_val5 = 0.0;","  float max_val6 = 0.0;","  vec3 rgbCombo = vec3(0.0);","  float total = 0.0;","  int max_i = 30000;","  int i = 0;","  float x = gl_FragCoord.x/u_window_size.x;","  float y = gl_FragCoord.y/u_window_size.y;","  vec3 meshPos = texture2D(u_stop_geom, vec2(x,y)).xyz;","  float dist = 1000.0;","  for (float t = t_hit.x; t < t_hit.y; t += dt) {","       if(meshPos != vec3(0.0))           dist = distance(p,meshPos);","      float val = texture(volumeTex, p.xyz).r;","      val = max(0.0, (val - u_clim[0]) / (u_clim[1] - u_clim[0]));","      rgbCombo += max(0.0, min(1.0, val)) * u_color;","      total += val;","      if(volumeCount > 1.0){           float val2 = texture(volumeTex2, p.xyz).r;","           val2 = max(0.0,(val2 - u_clim2[0]) / (u_clim2[1] - u_clim2[0]));","           rgbCombo += max(0.0, min(1.0, val2)) * u_color2;","           total += val2;","       }","       if(volumeCount > 2.0){           float val3 = texture(volumeTex3, p.xyz).r;","           val3 = max(0.0,(val3 - u_clim3[0]) / (u_clim3[1] - u_clim3[0]));","           rgbCombo += max(0.0, min(1.0, val3)) * u_color3;","           total += val3;","       }","       if(volumeCount > 3.0){           float val4 = texture(volumeTex4, p.xyz).r;","           val4 = max(0.0,(val4 - u_clim4[0]) / (u_clim4[1] - u_clim4[0]));","           rgbCombo += max(0.0, min(1.0, val4)) * u_color4;","           total += val4;","       }","       if(volumeCount > 4.0){           float val5 = texture(volumeTex5, p.xyz).r;","           val5 = max(0.0,(val5 - u_clim5[0]) / (u_clim5[1] - u_clim5[0]));","           rgbCombo += max(0.0, min(1.0, val5)) * u_color5;","           total += val5;","        }","        if(volumeCount > 5.0){           float val6 = texture(volumeTex6, p.xyz).r;","           val6 = max(0.0,(val6 - u_clim6[0]) / (u_clim6[1] - u_clim6[0]));","           rgbCombo += max(0.0, min(1.0, val6)) * u_color6;","           total += val6;","       }","       if(total > 0.0 && dist < 0.1){","           break;","       }else if(dist < 0.1){           gl_FragColor = vec4(0.0,0.0,0.0,0.0);","           break;","       }","       if(u_renderstyle == 0 && (max_val > u_clim[1] && max_val2 >= u_clim2[1] && max_val3 >= u_clim3[1] && max_val4 >= u_clim4[1] && max_val5 >= u_clim5[1] &&  max_val6 >= u_clim6[1])) break;","       if(u_renderstyle == 2){           total = min(total, 1.0);","           vec4 val_color = vec4(rgbCombo, total);","           val_color.a = 1.0 - pow(1.0 - val_color.a, 1.0);","           gl_FragColor.rgb += (1.0 - gl_FragColor.a) * val_color.a * val_color.rgb;","           gl_FragColor.a += (1.0 - gl_FragColor.a) * val_color.a * dtScale;","           if (gl_FragColor.a >= 0.95) {","               break;","           }","       }","       p += step;","  }","   gl_FragDepth = distance(worldSpaceCoords,p)*u_physical_Pixel;","   if(u_renderstyle == 0 && (max_val <  u_clim[0] && max_val2 < u_clim2[0] && max_val3 < u_clim3[0] &&   max_val4 <  u_clim4[0] && max_val5 <  u_clim5[0] && max_val6 <  u_clim6[0])){","        gl_FragColor = vec4(0,0,0,0);","   }else if(u_renderstyle == 0){","       max_val = (max_val - u_clim[0]) / (u_clim[1] - u_clim[0]);","       max_val2 = (max_val2 - u_clim2[0]) / (u_clim2[1] - u_clim2[0]);","       max_val3 = (max_val3 - u_clim3[0]) / (u_clim3[1] - u_clim3[0]);","       max_val4 = (max_val4 - u_clim4[0]) / (u_clim4[1] - u_clim4[0]);","       max_val5 = (max_val5 - u_clim5[0]) / (u_clim5[1] - u_clim5[0]);","       max_val6 = (max_val6 - u_clim6[0]) / (u_clim6[1] - u_clim6[0]);","       vec3 color = u_color * max_val;","       if(volumeCount > 1.0) color = color +  u_color2 * max_val2;","       if(volumeCount > 3.0) color = color +  u_color4 * max_val4;","       if(volumeCount > 2.0) color = color +  u_color3 * max_val3;","       if(volumeCount > 4.0) color = color +  u_color5 * max_val5;","       if(volumeCount > 5.0) color = color +  u_color6 * max_val6;","       vec3 colorCorrected = vec3(min(color[0], 1.0), min(color[1],1.0), min(color[2],1.0));","        gl_FragColor = vec4(color,1.0);","    }","    gl_FragColor.r = linear_to_srgb(gl_FragColor.r);","    gl_FragColor.g = linear_to_srgb(gl_FragColor.g);","    gl_FragColor.b = linear_to_srgb(gl_FragColor.b);","}"].join(`
`)},Fa={maximumIntensityProjection:0,minimumIntensityProjection:1,additive:2};function ja(i,e,t,r,n,s){const{spatialRenderingMode:o}=s,a=n?.image?.instance?.getData();if(!a)return{channelsVisible:null,resolution:null,data:null,colors:null,contrastLimits:null,allChannels:null,channelTargetC:null};const l=n.image.instance,c=o==="3D",d=e[ce.PHOTOMETRIC_INTERPRETATION]==="RGB",u=e[ce.VOLUMETRIC_RENDERING_ALGORITHM],h=Fa[u],f=e[ce.SPATIAL_LAYER_VISIBLE],w=e[ce.SPATIAL_LAYER_OPACITY];l.isInterleaved();const g=d?[[255,0,0],[0,255,0],[0,0,255]]:t.map(M=>r[M][ce.SPATIAL_CHANNEL_COLOR]),m=d?[[0,255],[0,255],[0,255]]:t.map(M=>r[M][ce.SPATIAL_CHANNEL_WINDOW]||[0,255]),p=d?[f&&!0,f&&!0,f&&!0]:t.map(M=>f&&r[M][ce.SPATIAL_CHANNEL_VISIBLE]),x=d?[f&&!0,f&&!0,f&&!0]:t.map(M=>f&&l.getChannelIndex(r[M][ce.SPATIAL_TARGET_C])),v=l.getAutoTargetResolution(),y=e[ce.SPATIAL_TARGET_RESOLUTION],_=y===null||Number.isNaN(y)?v:y,b=n.image.loaders[0].channels;let A=e[ce.SPATIAL_SLICE_X],S=e[ce.SPATIAL_SLICE_Y],E=e[ce.SPATIAL_SLICE_Z];return A=A!==null?A:new k(-1,1e5),S=S!==null?S:new k(-1,1e5),E=E!==null?E:new k(-1,1e5),{channelsVisible:p,allChannels:b,channelTargetC:x,resolution:_,data:a,colors:g,contrastLimits:m,is3dMode:c,renderingMode:h,layerTransparency:w,xSlice:A,ySlice:S,zSlice:E}}function Ha(i,e,t,r,n){const{images:s={},imageLayerScopes:o,imageLayerCoordination:a,imageChannelScopesByLayer:l,imageChannelCoordination:c}=i,d=o[0],u=l[d],h=a[0][d],f=c[0][d],{channelsVisible:w,allChannels:g,channelTargetC:m,resolution:p,data:x,colors:v,contrastLimits:y,is3dMode:_,renderingMode:b,layerTransparency:A,xSlice:S,ySlice:E,zSlice:M}=ja(d,h,u,f,s[d],i);return m!==null&&(e.channelTargetC.length!==0&&(e.channelTargetC.toString()!==m.toString()||e.resolution.toString()!==p.toString())?r||n(!0):(e.channelsVisible.toString()!==w.toString()||e.colors.toString()!==v.toString()||e.is3dMode!==_||e.contrastLimits.toString()!==y.toString()||e.renderingMode.toString()!==b.toString()||e.layerTransparency.toString()!==A.toString()||e.xSlice.toString()!==S.toString()||e.ySlice.toString()!==E.toString()||e.zSlice.toString()!==M.toString())&&(t({channelsVisible:w,allChannels:g,channelTargetC:m,resolution:p,data:x,colors:v,contrastLimits:y,is3dMode:_,renderingMode:b,layerTransparency:A,xSlice:S,ySlice:E,zSlice:M}),n(!1))),{images:s,layerScope:d,imageLayerScopes:o,imageLayerCoordination:a,imageChannelScopesByLayer:l,imageChannelCoordination:c,channelsVisible:w,allChannels:g,channelTargetC:m,resolution:p,data:x,colors:v,contrastLimits:y,is3dMode:_,renderingMode:b,layerTransparency:A,xSlice:S,ySlice:E,zSlice:M}}function Gt(i,e){const[t,r]=e;return(i-t)/Math.sqrt(r**2-t**2)}function ka(i,e,t,r,n,s,o,a,l,c,d,u,h){i.boxSize.value.set(t.xLength,t.yLength,t.zLength),i.volumeTex.value=e.length>0?e[0]:null,i.volumeTex2.value=e.length>1?e[1]:null,i.volumeTex3.value=e.length>2?e[2]:null,i.volumeTex4.value=e.length>3?e[3]:null,i.volumeTex5.value=e.length>4?e[4]:null,i.volumeTex6.value=e.length>5?e[5]:null,i.near.value=.1,i.far.value=3e3,i.alphaScale.value=1,i.dtScale.value=a,i.finalGamma.value=4.5,i.volumeCount.value=e.length,i.u_size.value.set(t.xLength,t.yLength,t.zLength),i.u_stop_geom.value=null,i.u_window_size.value.set(0,0),i.u_vol_scale.value.set(1/t.xLength,1/t.yLength,1/t.zLength*2),i.u_renderstyle.value=n,i.u_clim.value.set(s.length>0?s[0][0]:null,s.length>0?s[0][1]:null),i.u_clim2.value.set(s.length>1?s[1][0]:null,s.length>1?s[1][1]:null),i.u_clim3.value.set(s.length>2?s[2][0]:null,s.length>2?s[2][1]:null),i.u_clim4.value.set(s.length>3?s[3][0]:null,s.length>3?s[3][1]:null),i.u_clim5.value.set(s.length>4?s[4][0]:null,s.length>4?s[4][1]:null),i.u_clim6.value.set(s.length>5?s[5][0]:null,s.length>5?s[5][1]:null),i.u_xClip.value.set(l[0]*(1/u[0])/h[0]*t.xLength,l[1]*(1/u[0])/h[0]*t.xLength),i.u_yClip.value.set(c[0]*(1/u[1])/h[1]*t.yLength,c[1]*(1/u[1])/h[1]*t.yLength),i.u_zClip.value.set(d[0]*(1/u[2])/h[2]*t.zLength,d[1]*(1/u[1])/h[2]*t.zLength),i.u_color.value.set(o.length>0?o[0][0]:null,o.length>0?o[0][1]:null,o.length>0?o[0][2]:null),i.u_color2.value.set(o.length>1?o[1][0]:null,o.length>1?o[1][1]:null,o.length>1?o[1][2]:null),i.u_color3.value.set(o.length>2?o[2][0]:null,o.length>2?o[2][1]:null,o.length>2?o[2][2]:null),i.u_color4.value.set(o.length>3?o[3][0]:null,o.length>3?o[3][1]:null,o.length>3?o[3][2]:null),i.u_color5.value.set(o.length>4?o[4][0]:null,o.length>4?o[4][1]:null,o.length>4?o[4][2]:null),i.u_color6.value.set(o.length>5?o[5][0]:null,o.length>5?o[5][1]:null,o.length>5?o[5][2]:null)}function Rr(i,e,t,r,n,s,o,a,l,c,d,u,h,f){const w=[],g=[],m=[];let p=null,x=a;if(x==null||!Array.isArray(x)||x.length<3)x=[{size:x?.[0]?.size??1},{size:x?.[1]?.size??1},{size:x?.[2]?.size??1}];else for(let b=0;b<x.length;b++)(!x[b]||x[b].size===void 0||x[b].size===null)&&(x[b]={size:1});if(e.forEach((b,A)=>{t[A]&&(p=i.get(b),w.push(n.get(b)),g.push([r[A][0]/255,r[A][1]/255,r[A][2]/255]),s[A][0]===0&&s[A][1]===255?m.push([Gt(o.get(b)[0],o.get(b)),Gt(o.get(b)[1],o.get(b))]):m.push([Gt(s[A][0],o.get(b)),Gt(s[A][1],o.get(b))]))}),p===null)return null;const v={},y=Da,_=xn.clone(y.uniforms);return ka(_,w,p,v,l,m,g,c,d,u,h,[x[0].size,x[1].size,x[2]?x[2].size:1],f),[_,y,[1,x[1].size/x[0].size,x[2]?x[2].size/x[0].size:1],[p.xLength,p.yLength,p.zLength],[1,p.yLength/p.xLength,p.zLength/p.xLength]]}const Ga={Uint8:Uint8Array,Uint16:Uint16Array,Uint32:Uint32Array,Int8:Int8Array,Int16:Int16Array,Int32:Int32Array,Float32:Float32Array,Float64:Float64Array};async function Va({source:i,selection:e,onUpdate:t=()=>{},downsampleDepth:r=1,signal:n}){const{shape:s,labels:o,dtype:a}=i,{height:l,width:c}=ms(i),d=s[o.indexOf("z")],u=Math.max(1,Math.floor(d/r)),h=l*c,f=Ga[a],w=new f(h*u);return await Promise.all(new Array(u).fill(0).map(async(g,m)=>{const p={...e,z:m*r},{data:x}=await i.getRaster({selection:p,signal:n});let v=0;for(t({z:m,total:u,progress:.5});v<h;){const y=m*h+(h-v-1),_=(c-v-1)%c+c*Math.floor(v/c);w[y]=x[_],v+=1}t({z:m,total:u,progress:1})})),{data:w,height:l,width:c,depth:u}}function Xa(i,e,t){return Va({source:t[e],selection:{t:0,c:i},downsampleDepth:2**e})}function qa(i){const e=new Ua;return e.xLength=i.width,e.yLength=i.height,e.zLength=i.depth,e.data=i.data,e}function Ka(i){const e=new ds(i.data,i.xLength,i.yLength,i.zLength);return e.format=hs,e.type=fs,e.generateMipmaps=!1,e.minFilter=Xt,e.magFilter=Xt,e.needsUpdate=!0,e}function Wa(i){const{x:e,y:t,z:r}=i?.meta?.physicalSizes??{};return[e,t,r]}function $a(i){const[e,t]=i.computeMinMax(),r=new Float32Array(i.data.length);for(let n=0;n<i.data.length;n++)r[n]=(i.data[n]-e)/Math.sqrt(t**2-e**2);return r}async function Ya(i,e,t,r,n,s,o){let a=null,l=null;const{shape:c,labels:d}=t[0],u=i.filter(f=>!r.has(f)||e!==o),h=await Promise.all(u.map(f=>Xa(f,e,t)));return u.forEach((f,w)=>{const g=h[w];a=qa(g);const m=a.computeMinMax();a.data=$a(a),r.set(f,a),n.set(f,Ka(a)),s.set(f,m),l=Wa(t[e])}),[r,n,s,l,[c[d.indexOf("x")],c[d.indexOf("y")],c[d.indexOf("z")]]]}function Za(i){const e=T.useRef(null),t=T.useRef(null),[r,n]=T.useState(!1),[s,o]=T.useState(!1),[a,l]=T.useState(null),[c,d]=T.useState([1,1,1]),[u,h]=T.useState({uniforms:null,shader:null,meshScale:null,geometrySize:null,boxSize:null}),[f,w]=T.useState({volumes:new Map,textures:new Map,volumeMinMax:new Map,scale:null,resolution:null,originalScale:null}),[g,m]=T.useState({channelsVisible:[],allChannels:[],channelTargetC:[],resolution:null,data:null,colors:[],contrastLimits:[],is3dMode:!1,renderingMode:null,layerTransparency:1}),[p,x]=T.useState({visible:!0,color:[1,1,1],opacity:1,multiVisible:"",multiOpacity:"",multiColor:"",data:null,obsSets:[]}),{images:v,layerScope:y,channelsVisible:_,allChannels:b,channelTargetC:A,resolution:S,data:E,colors:M,contrastLimits:R,is3dMode:L,renderingMode:P,layerTransparency:B,xSlice:D,ySlice:j,zSlice:Z}=Ha(i,g,m,s,o),{obsSegmentations:Q,onEntitySelected:bt,segmentationLayerCoordination:$t,segmentationChannelCoordination:ye,segmentationChannelScopesByLayer:St}=i;let kn=()=>{};const lt=[];if(ye[0][y]!==void 0){const O=ye[0][y][y],{setObsHighlight:z}=ye[1][y][y];kn=z;const N=ye[0][y][y].additionalObsSets;N!==null&&O.obsSetSelection.forEach(Y=>{const se=Y[1];N.tree[0].children.forEach(ae=>{ae.name===se&&ae.set.forEach(([F])=>{const K={name:"",id:"",color:[255,255,255]};K.name=se,K.id=F,O.obsSetColor.forEach(le=>{le.path[1]===se&&(K.color=le.color)}),lt.push(K)})})}),O.obsHighlight!==null&&lt.push({name:"",id:O.obsHighlight,color:[255,34,0]})}if(Q?.[y]?.obsSegmentations&&a==null){const{scene:O,sceneOptions:z}=Q[y].obsSegmentations;if(O?.children){const N=new us,Y=new He;Y.userData.name="finalPass",O.children.forEach(ae=>{let F=ae;F.material===void 0&&(F=ae.children[0]),(F.material instanceof Le||F.material instanceof Fe)&&(F.material=new Nn);let K=F.name.replace("mesh_","").replace("mesh","").replace("glb","").replace("_dec","").replace("_Decobj","").replace("obj","").replace("_DEc","").replace(".","").replace("_Dec","");K.includes("_")&&(K=K.split("_")[0]),F.name=K,F.userData.name=K,F.userData.layerScope=y,F.material.transparent=!0,F.material.writeDepthTexture=!0,F.material.depthTest=!0,F.material.depthWrite=!0,F.material.needsUpdate=!0,F.material.side=z?.materialSide==="back"?Pr:st;const le=F.clone();le.geometry=F.geometry.clone(),le.geometry.translate(z?.targetX??0,z?.targetY??0,z?.targetZ??0),le.geometry.scale(z?.scaleX??1,z?.scaleY??1,z?.scaleZ??1),le.geometry.rotateX(z?.rotationX??0),le.geometry.rotateY(z?.rotationY??0),le.geometry.rotateZ(z?.rotationZ??0);const Te=F.clone();Te.material=F.material.clone(),Te.geometry=le.geometry.clone(),Y.add(Te)}),N.add(Y),N.scale.set(z?.sceneScaleX??1,z?.sceneScaleY??1,z?.sceneScaleZ??1);const se=[z?.sceneScaleX??1,z?.sceneScaleY??1,z?.sceneScaleZ??1];d(se),N.rotateX(z?.sceneRotationX??0),N.rotateY(z?.sceneRotationY??0),N.rotateZ(z?.sceneRotationZ??0),l(N)}}if(ye[0]!==void 0&&ye[0][y]!==void 0){const O=ye[0][y][y];let z="";lt.forEach(Y=>{z+=`${Y.id};${Y.color.toString()};${Y.name}`});let N="";if(p.obsSets.forEach(Y=>{N+=`${Y.id};${Y.color.toString()};${Y.name}`}),St[y].length>1){let Y="",se="",ae="",F=!1,K=0;St[y].forEach(le=>{const Te=ye[0][y][le];Y+=`${Te.spatialChannelColor.toString()};`,se+=`${Te.spatialChannelOpacity};`,ae+=`${Te.spatialChannelVisible};`,F|=Te.spatialChannelVisible,K+=Te.spatialChannelOpacity}),(Y!==p.multiColor||se!==p.multiOpacity||ae!==p.multiVisible)&&x({color:O.spatialChannelColor,opacity:K,visible:F,multiColor:Y,multiVisible:ae,multiOpacity:se,data:Q,obsSets:lt})}else(O.spatialChannelColor.toString()!==p.color.toString()||O.spatialChannelVisible!==p.visible||O.spatialChannelOpacity!==p.opacity||z!==N)&&x({color:O.spatialChannelColor,opacity:O.spatialChannelOpacity,visible:O.spatialChannelVisible,multiColor:"",multiVisible:"",multiOpacity:"",data:Q,obsSets:lt})}if(T.useEffect(()=>{if(a!==null){let O=0,z=0;for(let N=0;N<a.children.length;N++)a.children[N].userData.name==="finalPass"?z=N:O=N;a.children[z].children.forEach((N,Y)=>{let{color:se}=p;const ae=N.userData.name;if(p.obsSets.forEach(F=>{F.id===ae&&(se=F.color)}),St[y].length>1)St[y].forEach(F=>{const K=ye[0][y][F];K.spatialTargetC===ae&&(N.material.color.r=K.spatialChannelColor[0]/255,N.material.color.g=K.spatialChannelColor[1]/255,N.material.color.b=K.spatialChannelColor[2]/255,N.material.opacity=K.spatialChannelOpacity,N.visible=K.spatialChannelVisible,N.material.needsUpdate=!0,N.userData.layerScope=y,N.userData.channelScope=F,a.children[O].children[Y].material.needsUpdate=!0)});else{N.material.color.r=se[0]/255,N.material.color.g=se[1]/255,N.material.color.b=se[2]/255,N.material.opacity=p.opacity,N.material.visible=p.visible,N.material.needsUpdate=!0,N.userData.layerScope=y;const F=Object.keys(ye[0][y])?.[0];N.userData.channelScope=F}})}},[p,a]),v[y]?.image?.instance?.getData()!==void 0&&!s&&!r&&R!==null&&R[0][1]!==255&&L&&(o(!0),n(!0)),T.useEffect(()=>{const O=async()=>{const z=await Ya(A,S,E,f.volumes,f.textures,f.volumeMinMax,f.resolution);if(z[0]!==null)if(w({resolution:S,volumes:z[0],textures:z[1],volumeMinMax:z[2],scale:z[3]!==null?z[3]:f.scale,originalScale:z[4]}),!u.uniforms||!u.shader){const N=Rr(z[0],A,_,M,z[1],R,z[2],z[3],P,B,D,j,Z,z[4]);N!==null&&h({uniforms:N[0],shader:N[1],meshScale:N[2],geometrySize:N[3],boxSize:N[4]})}else m({channelsVisible:_,allChannels:b,channelTargetC:A,resolution:S,data:E,colors:M,contrastLimits:R,is3dMode:L,renderingMode:P,layerTransparency:B,xSlice:D,ySlice:j,zSlice:Z})};s&&(S!==g.resolution&&e.current&&(e.current.material.uniforms.volumeCount.value=0,e.current.material.uniforms.volumeTex.value=null),O(),o(!1))},[s]),T.useEffect(()=>{if(u.uniforms&&u.shader){const O=Rr(f.volumes,g.channelTargetC,g.channelsVisible,g.colors,f.textures,g.contrastLimits,f.volumeMinMax,f.scale,g.renderingMode,g.layerTransparency,g.xSlice,g.ySlice,g.zSlice,f.originalScale);if(O!==null){let z=0;g.channelsVisible.forEach(N=>{N&&z++}),o(!1),e?.current?.material?.uniforms&&(e.current.material.uniforms.u_clim.value=O[0].u_clim.value,e.current.material.uniforms.u_clim2.value=O[0].u_clim2.value,e.current.material.uniforms.u_clim3.value=O[0].u_clim3.value,e.current.material.uniforms.u_clim4.value=O[0].u_clim4.value,e.current.material.uniforms.u_clim5.value=O[0].u_clim5.value,e.current.material.uniforms.u_clim6.value=O[0].u_clim6.value,e.current.material.uniforms.u_xClip.value=O[0].u_xClip.value,e.current.material.uniforms.u_yClip.value=O[0].u_yClip.value,e.current.material.uniforms.u_zClip.value=O[0].u_zClip.value,e.current.material.uniforms.u_color.value=O[0].u_color.value,e.current.material.uniforms.u_color2.value=O[0].u_color2.value,e.current.material.uniforms.u_color3.value=O[0].u_color3.value,e.current.material.uniforms.u_color4.value=O[0].u_color4.value,e.current.material.uniforms.u_color5.value=O[0].u_color5.value,e.current.material.uniforms.u_color6.value=O[0].u_color6.value,e.current.material.uniforms.volumeTex.value=O[0].volumeTex.value,e.current.material.uniforms.volumeTex2.value=O[0].volumeTex2.value,e.current.material.uniforms.volumeTex3.value=O[0].volumeTex3.value,e.current.material.uniforms.volumeTex4.value=O[0].volumeTex4.value,e.current.material.uniforms.volumeTex5.value=O[0].volumeTex5.value,e.current.material.uniforms.volumeTex6.value=O[0].volumeTex6.value,e.current.material.uniforms.volumeCount.value=z,e.current.material.uniforms.u_renderstyle.value=g.renderingMode,e.current.material.uniforms.dtScale.value=g.layerTransparency)}else e?.current?.material?.uniforms&&(e.current.material.uniforms.volumeCount.value=0,e.current.material.uniforms.volumeTex.value=null)}},[g]),!g.is3dMode)return null;if(g.is3dMode&&(!u.uniforms||!u.shader))return I.jsxs("group",{children:[I.jsx("ambientLight",{}),I.jsx("pointLight",{position:[10,10,10]}),I.jsx(ts,{color:"white",scale:20,fontWeight:1e3,children:"Loading ..."})]});const cs={segmentationGroup:a,segmentationSettings:p,segmentationSceneScale:c,renderingSettings:u,materialRef:e,highlightEntity:bt,setObsHighlight:kn};return I.jsxs("group",{children:[I.jsx(yi,{}),I.jsx(Ti,{}),I.jsx(Na,{}),I.jsx(za,{}),I.jsx(Oa,{...cs}),I.jsx(no,{ref:t,enableDamping:!1,dampingFactor:0,zoomDampingFactor:0,smoothZoom:!1})]})}const el=T.forwardRef((i,e)=>I.jsxs("div",{style:{width:"100%",height:"100%"},children:[I.jsx(zn,{mode:"AR",sessionInit:{optionalFeatures:["hand-tracking"]},style:{border:"none",background:"rgba(0, 0, 0, 0.0)",zIndex:1,position:"absolute"},children:t=>t!=="unsupported"?I.jsx("div",{style:{border:"1px solid white",padding:"12px 24px",borderRadius:"4px",background:"rgba(0, 0, 0, 0.1)",color:"white",font:"normal 0.8125rem sans-serif",outline:"none",cursor:"pointer"},children:t==="entered"?"Exit AR":"Enter AR"}):null}),I.jsx(to,{style:{position:"absolute",top:0,left:0},camera:{fov:50,up:[0,1,0],position:[0,0,800],near:.1,far:3e3},gl:{antialias:!0,logarithmicDepthBuffer:!1},ref:e,children:I.jsx(fo,{children:I.jsx(Za,{...i})})})]}));export{el as SpatialWrapper};
